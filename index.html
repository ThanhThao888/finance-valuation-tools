<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finance Calculators</title>
    <style>    
      :root {
        /* Color Palette - Enhanced with more gradients */
        --indigo-50: #eef2ff;
        --indigo-100: #e0e7ff;
        --indigo-200: #c7d2fe;
        --indigo-300: #a5b4fc;
        --indigo-400: #818cf8;
        --indigo-500: #6366f1;
        --indigo-600: #4f46e5;
        --indigo-700: #4338ca;
        --indigo-800: #3730a3;
        
        --blue-50: #eff6ff;
        --blue-100: #dbeafe;
        --blue-200: #bfdbfe;
        --blue-300: #93c5fd;
        --blue-400: #60a5fa;
        --blue-500: #3b82f6;
        --blue-600: #2563eb;
        --blue-700: #1d4ed8;
        --blue-800: #1e40af;
        
        --cyan-50: #ecfeff;
        --cyan-100: #cffafe;
        --cyan-200: #a5f3fc;
        --cyan-300: #67e8f9;
        --cyan-400: #22d3ee;
        --cyan-500: #06b6d4;
        --cyan-600: #0891b2;
        --cyan-700: #0e7490;
        
        --green-50: #f0fdf4;
        --green-100: #dcfce7;
        --green-200: #bbf7d0;
        --green-300: #86efac;
        --green-400: #4ade80;
        --green-500: #10b981;
        --green-600: #059669;
        --green-700: #047857;
        --green-800: #065f46;
        
        --emerald-50: #ecfdf5;
        --emerald-100: #d1fae5;
        --emerald-200: #a7f3d0;
        --emerald-300: #6ee7b7;
        --emerald-400: #34d399;
        --emerald-500: #059669;
        --emerald-600: #047857;
        --emerald-700: #065f46;
        
        --rose-50: #fff1f2;
        --rose-100: #ffe4e6;
        --rose-200: #fecdd3;
        --rose-300: #fda4af;
        --rose-400: #fb7185;
        --rose-500: #f43f5e;
        --rose-600: #e11d48;
        --rose-700: #be123c;
        
        --pink-50: #fdf2f8;
        --pink-100: #fce7f3;
        --pink-200: #fbcfe8;
        --pink-300: #f9a8d4;
        --pink-400: #f472b6;
        --pink-500: #ec4899;
        --pink-600: #db2777;
        --pink-700: #be185d;
        
        --orange-50: #fff7ed;
        --orange-100: #ffedd5;
        --orange-200: #fed7aa;
        --orange-300: #fdba74;
        --orange-400: #fb923c;
        --orange-500: #f97316;
        --orange-600: #ea580c;
        --orange-700: #c2410c;
        
        --red-50: #fef2f2;
        --red-100: #fee2e2;
        --red-200: #fecaca;
        --red-300: #fca5a5;
        --red-400: #f87171;
        --red-500: #ef4444;
        --red-600: #dc2626;
        --red-700: #b91c1c;
        
        --purple-50: #faf5ff;
        --purple-100: #f3e8ff;
        --purple-200: #e9d5ff;
        --purple-300: #d8b4fe;
        --purple-400: #c084fc;
        --purple-500: #a855f7;
        --purple-600: #9333ea;
        --purple-700: #7e22ce;
        
        --yellow-50: #fefce8;
        --yellow-100: #fef9c3;
        --yellow-200: #fef08a;
        --yellow-300: #fde047;
        --yellow-400: #facc15;
        --yellow-500: #eab308;
        --yellow-600: #ca8a04;
        
        --slate-50: #f8fafc;
        --slate-100: #f1f5f9;
        --slate-200: #e2e8f0;
        --slate-300: #cbd5e1;
        --slate-400: #94a3b8;
        --slate-500: #64748b;
        --slate-600: #475569;
        --slate-700: #334155;
        --slate-800: #1e293b;
        --slate-900: #0f172a;
        
        --white: #ffffff;
        --black: #000000;
        
        /* Border Radius - More variety */
        --radius-xs: 0.25rem;
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --radius-2xl: 1.5rem;
        --radius-full: 9999px;
        
        /* Shadows - Enhanced depth */
        --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 20px -5px rgba(0, 0, 0, 0.12), 0 4px 8px -4px rgba(0, 0, 0, 0.08);
        --shadow-xl: 0 20px 30px -8px rgba(0, 0, 0, 0.15), 0 10px 15px -8px rgba(0, 0, 0, 0.1);
        --shadow-2xl: 0 30px 60px -12px rgba(0, 0, 0, 0.25);
        --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.4);
        
        /* Transitions - Smoother animations */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 400ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-bounce: 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
        
        /* Spacing */
        --space-xs: 0.25rem;
        --space-sm: 0.5rem;
        --space-md: 1rem;
        --space-lg: 1.5rem;
        --space-xl: 2rem;
        --space-2xl: 3rem;
      }

      /* Reset & Base */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      }

      html {
        scroll-behavior: smooth;
        font-size: 16px;
      }

      body {
        background: #f8fafc; 
        background-attachment: fixed;
        min-height: 100vh;
        padding: 20px;
        color: #1e293b;
        line-height: 1.6;
        position: relative;
        overflow-x: hidden;
      }

      /* Animated background particles */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
          radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
          radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
        pointer-events: none;
        z-index: 0;
        animation: backgroundPulse 20s ease-in-out infinite;
      }



      @keyframes backgroundPulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.05); }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }

      /* ==================== HEADER ==================== */
      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        box-shadow: var(--shadow-lg), 0 0 0 1px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-bottom: 1px solid var(--slate-200);
        padding: 1rem 0;
        margin-bottom: 2rem;
        border-radius: var(--radius-xl);
        position: sticky;
        top: 20px;
        z-index: 100;
        transition: all var(--transition-normal);
      }

      .header:hover {
        box-shadow: var(--shadow-xl), 0 0 0 1px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem;
        gap: 1.5rem;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--indigo-600) 0%, var(--blue-600) 50%, var(--purple-600) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.03em;
        position: relative;
        animation: logoShimmer 3s ease-in-out infinite;
      }

      @keyframes logoShimmer {
        0%, 100% { filter: brightness(1); }
        50% { filter: brightness(1.2); }
      }

      .logo::after {
        content: '‚ú®';
        position: absolute;
        right: -1.5rem;
        top: -0.25rem;
        font-size: 1rem;
        animation: sparkle 2s ease-in-out infinite;
      }

      @keyframes sparkle {
        0%, 100% { opacity: 0; transform: scale(0.8) rotate(0deg); }
        50% { opacity: 1; transform: scale(1) rotate(180deg); }
      }

      .tier-selector {
        display: flex;
        background: var(--slate-100);
        border-radius: var(--radius-lg);
        padding: 0.25rem;
        border: 1px solid var(--slate-200);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
      }

      .tier-btn {
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all var(--transition-normal);
        background: transparent;
        border: none;
        color: var(--slate-600);
        white-space: nowrap;
        position: relative;
        overflow: hidden;
      }

      .tier-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(99, 102, 241, 0.1);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .tier-btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .tier-btn:hover {
        background: var(--slate-200);
        color: var(--slate-800);
        transform: translateY(-1px);
      }

      .tier-btn.active {
        background: linear-gradient(135deg, var(--indigo-500), var(--blue-600));
        color: var(--white);
        box-shadow: var(--shadow-md), 0 0 20px rgba(99, 102, 241, 0.3);
        font-weight: 700;
      }

      .tier-btn.active:hover {
        background: linear-gradient(135deg, var(--indigo-600), var(--blue-700));
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg), 0 0 25px rgba(99, 102, 241, 0.4);
      }

      /* ==================== TABS ==================== */
      .tabs {
        display: flex;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: var(--radius-xl);
        padding: 0.5rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        overflow-x: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--indigo-300) transparent;
        border: 1px solid rgba(255, 255, 255, 0.8);
        gap: 0.5rem;
      }

      .tabs::-webkit-scrollbar {
        height: 6px;
      }

      .tabs::-webkit-scrollbar-track {
        background: transparent;
      }

      .tabs::-webkit-scrollbar-thumb {
        background: var(--indigo-300);
        border-radius: var(--radius-full);
      }

      .tabs::-webkit-scrollbar-thumb:hover {
        background: var(--indigo-400);
      }

      .tab-btn {
        padding: 0.875rem 1.75rem;
        border-radius: var(--radius-lg);
        font-weight: 600;
        font-size: 0.9375rem;
        cursor: pointer;
        white-space: nowrap;
        transition: all var(--transition-normal);
        background: transparent;
        border: none;
        color: var(--slate-600);
        position: relative;
        overflow: hidden;
      }

      .tab-btn::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--indigo-500), var(--blue-500));
        transform: translateX(-50%);
        transition: width var(--transition-normal);
        border-radius: var(--radius-full);
      }

      .tab-btn:hover {
        background: var(--slate-100);
        color: var(--slate-800);
        transform: translateY(-2px);
      }

      .tab-btn:hover::before {
        width: 60%;
      }

      .tab-btn.active {
        background: linear-gradient(135deg, var(--indigo-50), var(--blue-50));
        color: var(--indigo-700);
        font-weight: 700;
        box-shadow: inset 0 2px 8px rgba(99, 102, 241, 0.15);
      }

      .tab-btn.active::before {
        width: 100%;
        height: 4px;
      }

      /* ==================== CALCULATOR CONTAINER ==================== */
      .calculator-container {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: var(--radius-2xl);
        padding: 2.5rem;
        box-shadow: var(--shadow-2xl), 0 0 0 1px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.9);
        position: relative;
        overflow: hidden;
        transition: all var(--transition-normal);
      }

      .calculator-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, 
          var(--indigo-500) 0%, 
          var(--blue-500) 25%, 
          var(--purple-500) 50%, 
          var(--pink-500) 75%, 
          var(--rose-500) 100%);
        opacity: 0.8;
      }

      .calculator-container:hover {
        box-shadow: var(--shadow-2xl), 0 0 40px rgba(99, 102, 241, 0.15);
        transform: translateY(-2px);
      }

      .calculator-title {
        font-size: 1.75rem;
        font-weight: 800;
        margin-bottom: 1.5rem;
        color: var(--slate-800);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        letter-spacing: -0.02em;
      }

      .calculator-title::before {
        content: 'üßÆ';
        font-size: 1.5rem;
        animation: bounce 2s ease-in-out infinite;
      }

      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
      }

      /* ==================== EXPLANATION BOX ==================== */
      .explanation-box {
        background: linear-gradient(135deg, var(--slate-50), var(--blue-50));
        border-left: 4px solid var(--indigo-500);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--slate-200);
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
      }

      .explanation-box::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
        animation: rotate 30s linear infinite;
      }

      @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .explanation-title {
        font-weight: 700;
        color: var(--slate-800);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.125rem;
        position: relative;
        z-index: 1;
      }

      .explanation-title svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--indigo-500);
        flex-shrink: 0;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
      }

      .explanation-text {
        color: var(--slate-600);
        line-height: 1.7;
        margin-bottom: 0.75rem;
        position: relative;
        z-index: 1;
        font-size: 0.9375rem;
      }

      .explanation-note {
        background: linear-gradient(135deg, var(--blue-50), var(--indigo-50));
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-top: 1rem;
        font-size: 0.875rem;
        border-left: 3px solid var(--blue-500);
        color: var(--blue-900);
        position: relative;
        z-index: 1;
        box-shadow: var(--shadow-xs);
      }

      /* ==================== FORMS ==================== */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--slate-700);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        letter-spacing: 0.01em;
      }

      .form-label::after {
        content: ':';
      }

      .form-input, .form-select {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--slate-200);
        border-radius: var(--radius-lg);
        font-size: 1rem;
        transition: all var(--transition-normal);
        background: var(--white);
        color: var(--slate-800);
        font-weight: 500;
        box-shadow: var(--shadow-xs);
      }

      .form-input:hover, .form-select:hover {
        border-color: var(--slate-300);
        box-shadow: var(--shadow-sm);
      }

      .form-input:focus, .form-select:focus {
        outline: none;
        border-color: var(--indigo-500);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), var(--shadow-sm);
        transform: translateY(-1px);
      }

      .form-input::placeholder {
        color: var(--slate-400);
        font-weight: 400;
      }

      .form-select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%234f46e5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.25rem;
        padding-right: 2.5rem;
      }

      /* ==================== BUTTONS ==================== */
      .btn {
        padding: 1rem 2rem;
        border-radius: var(--radius-lg);
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all var(--transition-normal);
        border: none;
        color: var(--white);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-md);
        letter-spacing: 0.01em;
        text-transform: none;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--indigo-600), var(--blue-700));
        box-shadow: var(--shadow-md), 0 0 20px rgba(99, 102, 241, 0.3);
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, var(--indigo-700), var(--blue-800));
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl), 0 0 30px rgba(99, 102, 241, 0.4);
      }

      .btn-secondary {
        background: linear-gradient(135deg, var(--blue-500), var(--cyan-600));
        box-shadow: var(--shadow-md), 0 0 20px rgba(59, 130, 246, 0.3);
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, var(--blue-600), var(--cyan-700));
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl), 0 0 30px rgba(59, 130, 246, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, var(--green-500), var(--emerald-600));
        box-shadow: var(--shadow-md), 0 0 20px rgba(16, 185, 129, 0.3);
      }

      .btn-success:hover {
        background: linear-gradient(135deg, var(--green-600), var(--emerald-700));
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl), 0 0 30px rgba(16, 185, 129, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, var(--rose-500), var(--pink-600));
        box-shadow: var(--shadow-md), 0 0 20px rgba(244, 63, 94, 0.3);
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, var(--rose-600), var(--pink-700));
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl), 0 0 30px rgba(244, 63, 94, 0.4);
      }

      .btn-warning {
        background: linear-gradient(135deg, var(--orange-500), var(--red-600));
        box-shadow: var(--shadow-md), 0 0 20px rgba(249, 115, 22, 0.3);
      }

      .btn-warning:hover {
        background: linear-gradient(135deg, var(--orange-600), var(--red-700));
        transform: translateY(-3px);
        box-shadow: var(--shadow-xl), 0 0 30px rgba(249, 115, 22, 0.4);
      }

      /* ==================== RESULTS ==================== */
      .results-container {
        margin-top: 2rem;
        padding: 2rem;
        border-radius: var(--radius-xl);
        border: 1px solid var(--slate-200);
        background: var(--slate-50);
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
      }

      .results-container::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(99, 102, 241, 0.03) 0%, transparent 70%);
        animation: rotate 30s linear infinite;
        pointer-events: none;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        position: relative;
        z-index: 1;
      }

      .result-card {
        text-align: center;
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        background: var(--white);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--slate-200);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
      }

      .result-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--indigo-500), var(--blue-500));
        transform: scaleX(0);
        transition: transform var(--transition-normal);
      }

      .result-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--indigo-200);
      }

      .result-card:hover::before {
        transform: scaleX(1);
      }

      .result-label {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--slate-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .result-value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--slate-800);
        letter-spacing: -0.02em;
      }

      .result-subtext {
        font-size: 0.75rem;
        color: var(--slate-500);
        margin-top: 0.25rem;
        line-height: 1.4;
      }

      .result-highlight {
        background: linear-gradient(135deg, var(--indigo-50), var(--blue-50));
        border: 1px solid var(--indigo-200);
        box-shadow: var(--shadow-sm), 0 0 20px rgba(99, 102, 241, 0.1);
      }

      .result-highlight .result-value {
        color: var(--indigo-700);
        font-weight: 900;
      }

      .result-positive {
        border-left: 4px solid var(--green-500);
      }

      .result-positive .result-value {
        color: var(--green-700);
      }

      .result-negative {
        border-left: 4px solid var(--red-500);
      }

      .result-negative .result-value {
        color: var(--red-700);
      }

      /* ==================== OPTIONS TOGGLE ==================== */
      .options-toggle {
        display: flex;
        background: var(--slate-100);
        border-radius: var(--radius-lg);
        padding: 0.375rem;
        margin-bottom: 1.5rem;
        width: fit-content;
        border: 1px solid var(--slate-200);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        gap: 0.25rem;
      }

      .option-btn {
        padding: 0.875rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all var(--transition-normal);
        background: transparent;
        border: none;
        color: var(--slate-600);
        white-space: nowrap;
        position: relative;
        overflow: hidden;
      }

      .option-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(99, 102, 241, 0.1);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      .option-btn:hover::before {
        width: 200px;
        height: 200px;
      }

      .option-btn:hover {
        background: var(--slate-200);
        color: var(--slate-800);
        transform: translateY(-1px);
      }

      .option-btn.active {
        background: var(--white);
        color: var(--indigo-600);
        box-shadow: var(--shadow-sm);
        font-weight: 700;
        border: 1px solid var(--indigo-200);
      }

      /* ==================== SCENARIO BUTTONS ==================== */
      .scenario-btn {
        padding: 1.25rem;
        border-radius: var(--radius-lg);
        border: 2px solid var(--slate-200);
        background: var(--white);
        cursor: pointer;
        transition: all var(--transition-normal);
        font-weight: 600;
        text-align: center;
        font-size: 0.875rem;
        color: var(--slate-700);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        overflow: hidden;
      }

      .scenario-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 0;
        background: linear-gradient(135deg, var(--indigo-50), var(--blue-50));
        transition: height var(--transition-normal);
        z-index: -1;
      }

      .scenario-btn:hover {
        border-color: var(--indigo-400);
        background: var(--indigo-50);
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
      }

      .scenario-btn:hover::before {
        height: 100%;
      }


      .scenario-btn.active {
        border-color: var(--indigo-600);
        background: linear-gradient(135deg, var(--indigo-50), var(--blue-100));
        color: var(--indigo-900);
        box-shadow: 0 4px 12px -2px rgba(99, 102, 241, 0.3);
        position: relative;
        z-index: 1; 
      }

      /* ==================== TOAST NOTIFICATION ==================== */
      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: linear-gradient(135deg, var(--green-500), var(--emerald-600));
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        font-weight: 600;
        font-size: 0.875rem;
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%) scale(0.9);
        transition: var(--transition-normal);
        pointer-events: none;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        max-width: 350px;
        border-left: 4px solid rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .toast.show {
        opacity: 1;
        transform: translateX(0) scale(1);
      }

      .toast.error {
        background: linear-gradient(135deg, var(--red-500), var(--rose-600));
        box-shadow: var(--shadow-xl), 0 0 30px rgba(239, 68, 68, 0.3);
      }

      /* ==================== CLEAR DATA BUTTON ==================== */
      .clear-data-btn {
        background: linear-gradient(135deg, var(--slate-600), var(--slate-700));
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-lg);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-normal);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-md);
      }

      .clear-data-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: 0.5s;
      }

      .clear-data-btn:hover::before {
        left: 100%;
      }

      .clear-data-btn:hover {
        background: linear-gradient(135deg, var(--slate-700), var(--slate-800));
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .clear-data-btn:active {
        transform: translateY(0);
      }

      /* ==================== LAST SAVED INDICATOR ==================== */
      .last-saved {
        font-size: 0.75rem;
        color: var(--slate-500);
        margin-left: 1.5rem;
        font-weight: 500;
        background: var(--slate-100);
        padding: 0.5rem 0.875rem;
        border-radius: 2rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all var(--transition-normal);
        border: 1px solid var(--slate-200);
        position: relative;
        overflow: hidden;
      }

      .last-saved::before {
        content: '‚è±Ô∏è';
        font-size: 0.7rem;
      }

      .last-saved:hover {
        background: var(--slate-200);
        color: var(--slate-700);
        border-color: var(--slate-300);
        transform: translateY(-1px);
      }

      /* ==================== RESPONSIVE DESIGN ==================== */
      @media (max-width: 768px) {
        body {
          padding: 12px;
        }

        .header {
          position: static;
          margin-bottom: 1.5rem;
        }

        .header-content {
          flex-direction: column;
          align-items: stretch;
          gap: 1rem;
          padding: 0 1rem;
        }

        .calculator-container {
          padding: 1.5rem;
        }

        .calculator-title {
          font-size: 1.25rem;
        }

        .form-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .results-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .tabs {
          margin-bottom: 1.5rem;
          padding: 0.25rem;
        }

        .tab-btn {
          padding: 0.625rem 1.25rem;
          font-size: 0.8125rem;
        }

        .btn {
          padding: 0.875rem 1.5rem;
          font-size: 0.9375rem;
        }

        .toast {
          bottom: 1rem;
          right: 1rem;
          left: 1rem;
          max-width: calc(100% - 2rem);
        }

        .clear-data-btn {
          width: 100%;
          justify-content: center;
          margin-top: 0.5rem;
        }

        .last-saved {
          margin-left: 0;
          margin-top: 0.5rem;
          justify-content: center;
        }
      }

      @media (max-width: 480px) {
        .results-grid {
          grid-template-columns: 1fr;
        }

        .scenario-btn {
          padding: 1rem;
          font-size: 0.75rem;
        }

        .calculator-container {
          padding: 1rem;
        }

        .explanation-box {
          padding: 1rem;
        }

        .form-input, .form-select {
          padding: 0.75rem;
        }
      }

      /* ==================== LOADING STATES ==================== */
      .loading {
        opacity: 0.7;
        pointer-events: none;
        position: relative;
      }

      .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 2rem;
        height: 2rem;
        border: 3px solid var(--slate-300);
        border-top-color: var(--indigo-500);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        transform: translate(-50%, -50%);
        z-index: 10;
      }

      @keyframes spin {
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }

      /* ==================== SCROLLBAR STYLING ==================== */
      ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      ::-webkit-scrollbar-track {
        background: var(--slate-100);
        border-radius: var(--radius-full);
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--indigo-300), var(--blue-400));
        border-radius: var(--radius-full);
        border: 2px solid var(--slate-100);
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, var(--indigo-400), var(--blue-500));
      }

      /* ==================== ANIMATED GRADIENTS ==================== */
      .animated-gradient {
        background-size: 400% 400%;
        animation: gradientShift 8s ease infinite;
      }

      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      /* ==================== PROGRESSIVE ENHANCEMENT ==================== */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }

        .loading::after {
          animation-duration: 2s; /* Keep loading spinner */
        }
      }

      /* ==================== ACCESSIBILITY ==================== */
      button:focus,
      input:focus,
      select:focus,
      a:focus {
        outline: 2px solid var(--indigo-500);
        outline-offset: 2px;
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        :root {
          --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
          --shadow-md: 0 4px 8px -2px rgba(0, 0, 0, 0.4);
          --shadow-lg: 0 10px 20px -5px rgba(0, 0, 0, 0.5);
        }

        .form-input, .form-select {
          border-width: 2px;
        }

        .btn {
          border: 2px solid transparent;
        }
      }

      .calculator-title,
      .explanation-title,
      .form-label,
      .result-label {
        color: #1e293b !important; 
      }
      
      .result-value {
        color: #0f172a !important; 
      }      

      .calculator-container,
      .results-container,
      .explanation-box,
      .result-card {
        background: white !important;
        border: 1px solid #e2e8f0; 
        box-shadow: var(--shadow-md); 
      }





      .sensitivity-container {
        margin-top: 3rem;
      }

      .sensitivity-header {
        margin: 0 0 1.5rem 0;
        font-size: 1.4rem;
        font-weight: 700;
        color: #1f2937;
      }

      .sensitivity-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow-x: auto;
      }

      .sensitivity-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
      }

      .table-header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .table-header-cell {
        padding: 1rem;
        text-align: center;
        font-weight: 600;
      }

      .table-cell {
        padding: 0.875rem;
        text-align: center;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }

      .table-cell:hover {
        transform: scale(1.05);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        z-index: 10;
        position: relative;
      }

      /* Color Bands for IRR */
      .irr-premium { background: #fef3c7; color: #92400e; font-weight: 700; }
      .irr-strong { background: #dbeafe; color: #1e3a8a; font-weight: 700; }
      .irr-target { background: #e0e7ff; color: #3730a3; font-weight: 600; }
      .irr-acceptable { background: #fef2f2; color: #991b1b; }
      .irr-below { background: #fee2e2; color: #7f1d1d; font-weight: 600; }

      .base-case-marker {
        border: 3px solid #3b82f6 !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }

      .legend-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        margin-top: 1.5rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .legend-box {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 1px solid currentColor;
      }




    </style>
  </head>

  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <div style="display: flex; align-items: center;">
            <div class="logo">Finance Calculators</div>
            <span class="last-saved" id="lastSaved"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="tier-selector">
              <button class="tier-btn active" data-tier="basic">Basic</button>
              <button class="tier-btn" data-tier="intermediate">Intermediate</button>
              <button class="tier-btn" data-tier="advanced">Advanced</button>
            </div>
            <button class="clear-data-btn" id="clearDataBtn">
              üóëÔ∏è Clear All Data
            </button>
          </div>
        </div>
      </div>


      <!-- Tabs -->
      <div class="tabs" id="tabsContainer">
        <!-- Tabs will be populated by JavaScript -->
      </div>

      <!-- Calculator Container -->
      <div class="calculator-container">
        <div id="calculatorContent">
          <!-- Calculator content will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // --- Data Structure ---
      const calculators = {
        basic: [
          {
            id: "pv-fv",
            name: "PV/FV Calculator",
            component: "PVFVCalculator",
          },
          {
            id: "compound-interest",
            name: "Compound Interest",
            component: "CompoundInterestCalculator",
          },
          {
            id: "loan-payment",
            name: "Loan Payment",
            component: "LoanPaymentCalculator",
          },
        ],
        intermediate: [
          {
            id: "capm",
            name: "CAPM",
            component: "CAPMCalculator",
          },
          {
            id: "xnpv-xirr",  
            name: "XNPV & XIRR",
            component: "XNPVXIRRCalculator",
          },
          {
            id: "npv-irr",
            name: "NPV & IRR (Academic)",  
            component: "NPVIRRCalculator",
          },
          {
            id: "ccpo",
            name: "Credit Card Optimizer",
            component: "CCPOCalculator",
          },
          {
            id: "bond-pricing",
            name: "Bond Pricing",
            component: "BondPricingCalculator",
          },
          {
            id: "time-money",
            name: "Time vs Money Trade-Off",
            component: "TimeMoneyCalculator",
          },
        ],
        advanced: [
          {
            id: "black-scholes",
            name: "Black-Scholes",
            component: "BlackScholesCalculator",
          },
          {
            id: "wacc",
            name: "WACC",
            component: "WACCCalculator",
          },
          {
            id: "dcf",
            name: "DCF Valuation",
            component: "DCFCalculator",
          },
          {
            id: "lbo",
            name: "LBO Model",
            component: "LBOCalculator",
          },
          {
            id: "real-estate",
            name: "Real Estate (REPE)",
            component: "RealEstateCalculator", 
          },          
        ],
      };


      // --- Storage Manager ---
      const StorageManager = {
        STORAGE_KEY: 'financeCalculatorState',
        AUTO_SAVE_DELAY: 2000, // 2 seconds
        saveTimeouts: {},

        // Save state to localStorage
        saveState(state) {
          try {
            const timestamp = new Date().toISOString();
            const savedState = {
              ...state,
              timestamp,
              version: '1.0'
            };
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(savedState));
            this.updateLastSavedDisplay(timestamp);
            this.showToast('üíæ Saved!');
            return true;
          } catch (error) {
            console.error('Failed to save state:', error);
            this.showToast('‚ö†Ô∏è Save failed', 'error');
            return false;
          }
        },

        // Load state from localStorage
        loadState() {
          try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (!saved) return null;
            
            const state = JSON.parse(saved);
            if (state.timestamp) {
              this.updateLastSavedDisplay(state.timestamp);
            }
            return state;
          } catch (error) {
            console.error('Failed to load state:', error);
            return null;
          }
        },

        // Clear all saved data
        clearState() {
          try {
            localStorage.removeItem(this.STORAGE_KEY);
            this.showToast('üóëÔ∏è All data cleared', 'success');
            return true;
          } catch (error) {
            console.error('Failed to clear state:', error);
            return false;
          }
        },

        // Auto-save with debounce
        autoSave(key, data) {
          clearTimeout(this.saveTimeouts[key]);
          this.saveTimeouts[key] = setTimeout(() => {
            const currentState = this.loadState() || {};
            currentState[key] = data;
            this.saveState(currentState);
          }, this.AUTO_SAVE_DELAY);
        },




        // Show toast notification
        showToast(message, type = 'success') {
          const toast = document.getElementById('saveToast');
          const toastMessage = document.getElementById('toastMessage');
          
          if (!toast || !toastMessage) return;
          
          toastMessage.textContent = message;
          
          // Update colors based on type
          if (type === 'error') {
            toast.style.background = 'linear-gradient(135deg, var(--red-500), var(--rose-600))';
          } else {
            toast.style.background = 'linear-gradient(135deg, var(--green-500), var(--emerald-600))';
          }
          
          toast.classList.add('show');
          
          setTimeout(() => {
            toast.classList.remove('show');
          }, 1500);
        },

        // Update last saved display
        updateLastSavedDisplay(timestamp) {
          const lastSavedEl = document.getElementById('lastSaved');
          if (!lastSavedEl) return;
          
          const date = new Date(timestamp);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          
          let timeText;
          if (diffMins < 1) {
            timeText = 'just now';
          } else if (diffMins < 60) {
            timeText = `${diffMins} min ago`;
          } else {
            const diffHours = Math.floor(diffMins / 60);
            timeText = `${diffHours}h ago`;
          }
          
          lastSavedEl.textContent = `Last saved: ${timeText}`;
        },

        // Get all form inputs from a container
        getFormInputs(container) {
          const inputs = {};
          
          // Get all input fields
          container.querySelectorAll('input[type="number"], input[type="text"], input[type="range"]').forEach(input => {
            if (input.id) {
              inputs[input.id] = input.value;
            }
          });
          
          // Get all select fields
          container.querySelectorAll('select').forEach(select => {
            if (select.id) {
              inputs[select.id] = select.value;
            }
          });
          
          // Get all checkboxes
          container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.id) {
              inputs[checkbox.id] = checkbox.checked;
            }
          });
          
          return inputs;
        },

        // Set form inputs from saved data
        setFormInputs(container, inputs) {
          if (!inputs) return;
          
          Object.entries(inputs).forEach(([id, value]) => {
            const element = container.querySelector(`#${id}`);
            if (!element) return;
            
            if (element.type === 'checkbox') {
              element.checked = value;
            } else {
              element.value = value;
            }
            
            // Trigger change event for any dependent logic
            element.dispatchEvent(new Event('change', { bubbles: true }));
          });
        },

        // Save current calculator state
        saveCalculatorState(calculatorId) {
          const container = document.getElementById('calculatorContent');
          if (!container) return;
          
          const inputs = this.getFormInputs(container);
          const resultsDiv = container.querySelector('[id$="Results"]');
          const hasResults = resultsDiv && !resultsDiv.classList.contains('hidden');
          
          const state = this.loadState() || {};
          state.activeTier = activeTier;
          state.activeTab = activeTab;
          state.calculators = state.calculators || {};
          state.calculators[calculatorId] = {
            inputs,
            hasResults,
            resultsHTML: hasResults ? resultsDiv.innerHTML : null
          };
          
          this.saveState(state);
        },

        // Restore calculator state
        restoreCalculatorState(calculatorId) {
          const state = this.loadState();
          if (!state || !state.calculators || !state.calculators[calculatorId]) {
            return false;
          }
          
          const calculatorState = state.calculators[calculatorId];
          const container = document.getElementById('calculatorContent');
          if (!container) return false;
          
          // Wait for DOM to be ready
          setTimeout(() => {
            // Restore inputs
            this.setFormInputs(container, calculatorState.inputs);
            
            // Restore results if they existed
            if (calculatorState.hasResults && calculatorState.resultsHTML) {
              const resultsDiv = container.querySelector('[id$="Results"]');
              if (resultsDiv) {
                resultsDiv.innerHTML = calculatorState.resultsHTML;
                resultsDiv.classList.remove('hidden');
              }
            }
          }, 100);
          
          return true;
        }
      };



      // ==================== FINANCIAL PRECISION UTILITIES ====================
      // Global formatters for performance (created once, reused)
      const CURRENCY_FORMATTERS = new Map();
      const PERCENT_FORMATTERS = new Map();
      const NUMBER_FORMATTERS = new Map();

      /**
       * Get or create currency formatter with specified decimals
       */
      function getCurrencyFormatter(decimals = 2) {
        const key = `currency-${decimals}`;
        if (!CURRENCY_FORMATTERS.has(key)) {
          CURRENCY_FORMATTERS.set(key, new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
            useGrouping: true // Adds commas: 1,000.00
          }));
        }
        return CURRENCY_FORMATTERS.get(key);
      }

      /**
       * Get or create percentage formatter with specified decimals
       */
      function getPercentFormatter(decimals = 2) {
        const key = `percent-${decimals}`;
        if (!PERCENT_FORMATTERS.has(key)) {
          PERCENT_FORMATTERS.set(key, new Intl.NumberFormat('en-US', {
            style: 'percent',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
            signDisplay: 'auto' // Shows + for positive, - for negative
          }));
        }
        return PERCENT_FORMATTERS.get(key);
      }

      /**
       * Get or create number formatter with specified decimals
       */
      function getNumberFormatter(decimals = 2) {
        const key = `number-${decimals}`;
        if (!NUMBER_FORMATTERS.has(key)) {
          NUMBER_FORMATTERS.set(key, new Intl.NumberFormat('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
            useGrouping: true // Adds commas
          }));
        }
        return NUMBER_FORMATTERS.get(key);
      }

      /**
       * Round to financial precision (banker's rounding - round half to even)
       */
      function roundFinancial(value, decimals = 2) {
        if (typeof value !== 'number' || isNaN(value)) return value;
        
        // Handle extremely small numbers
        if (Math.abs(value) < 1e-15) return 0;
        
        const factor = Math.pow(10, decimals);
        // Banker's rounding implementation
        const rounded = Math.round((value + Number.EPSILON) * factor) / factor;
        
        // Handle -0.00 case
        return Math.abs(rounded) < Math.pow(10, -decimals - 1) ? 0 : rounded;
      }

      /**
       * Compare two financial numbers with tolerance
       * Returns true if difference is within epsilon
       */
      function financialEquals(a, b, tolerance = 1e-8) {
        if (typeof a !== 'number' || typeof b !== 'number' || isNaN(a) || isNaN(b)) {
          return false;
        }
        return Math.abs(a - b) < tolerance;
      }

      /**
       * Format currency with proper rounding and Intl.NumberFormat
       * Returns formatted string with commas: $1,234,567.89
       */
      function formatCurrency(amount, decimals = 2) {
        if (typeof amount !== 'number' || isNaN(amount)) {
          return `$${0.00.toFixed(decimals)}`;
        }
        
        const rounded = roundFinancial(amount, decimals);
        const formatter = getCurrencyFormatter(decimals);
        return formatter.format(rounded);
      }

      /**
       * Format large financial values with automatic unit scaling
       * Professional finance display: $1.23B, $456.7M, $89.0K, $1,234.56
       */
      function formatLargeFinancial(value, decimals = 2) {
        if (typeof value !== 'number' || isNaN(value)) {
          return formatCurrency(0, decimals);
        }
        
        const absValue = Math.abs(value);
        let scaledValue, suffix;
        
        if (absValue >= 1e12) { // Trillion
          scaledValue = value / 1e12;
          suffix = 'T';
          decimals = Math.max(decimals, 3); // More decimals for larger numbers
        } else if (absValue >= 1e9) { // Billion
          scaledValue = value / 1e9;
          suffix = 'B';
          decimals = Math.max(decimals, 3);
        } else if (absValue >= 1e6) { // Million
          scaledValue = value / 1e6;
          suffix = 'M';
          decimals = Math.max(decimals, 2);
        } else if (absValue >= 1e3) { // Thousand
          scaledValue = value / 1e3;
          suffix = 'K';
          decimals = Math.max(decimals, 1);
        } else {
          // For values < 1000, use regular currency format with commas
          return formatCurrency(value, decimals);
        }
        
        const rounded = roundFinancial(scaledValue, decimals);
        const formatter = getNumberFormatter(decimals);
        const sign = value < 0 ? '-' : '';
        
        return `${sign}$${formatter.format(Math.abs(rounded))}${suffix}`;
      }

      /**
       * Format percentage with proper rounding and Intl.NumberFormat
       * Returns formatted string: 12.34% or -5.67%
       */
      function formatPercent(value, decimals = 2) {
        if (typeof value !== 'number' || isNaN(value)) {
          return '0.00%';
        }
        
        const percentValue = roundFinancial(value * 100, decimals);
        const formatter = getPercentFormatter(decimals);
        return formatter.format(percentValue / 100); // Intl expects decimal for percent
      }

      /**
       * Format number with commas and specified decimals
       * Returns formatted string: 1,234,567.89
       */
      function formatNumber(value, decimals = 2) {
        if (typeof value !== 'number' || isNaN(value)) {
          return '0.00';
        }
        
        const rounded = roundFinancial(value, decimals);
        const formatter = getNumberFormatter(decimals);
        return formatter.format(rounded);
      }

      /**
       * Format number as integer with commas
       * Returns formatted string: 1,234,567
       */
      function formatInteger(value) {
        if (typeof value !== 'number' || isNaN(value)) {
          return '0';
        }
        
        const rounded = Math.round(value);
        const formatter = getNumberFormatter(0);
        return formatter.format(rounded);
      }

      /**
       * Safe financial addition (prevents floating point accumulation)
       * Maintains mathematical precision
       */
      function safeAdd(a, b) {
        if (typeof a !== 'number' || typeof b !== 'number' || isNaN(a) || isNaN(b)) {
          return 0;
        }
        return roundFinancial(a + b, 10);
      }

      /**
       * Safe financial multiplication
       */
      function safeMultiply(a, b) {
        if (typeof a !== 'number' || typeof b !== 'number' || isNaN(a) || isNaN(b)) {
          return 0;
        }
        return roundFinancial(a * b, 10);
      }

      /**
       * Safe financial division (prevents division by zero)
       */
      function safeDivide(a, b, decimals = 10) {
        if (typeof a !== 'number' || typeof b !== 'number' || isNaN(a) || isNaN(b)) {
          return 0;
        }
        
        if (Math.abs(b) < 1e-12) return 0;
        return roundFinancial(a / b, decimals);
      }

      /**
       * Calculate remaining debt with precision (for amortization schedules)
       */
      function calculateRemainingDebt(principal, payment, interestRate, periodsPaid, totalPeriods) {
        // Input validation
        if ([principal, payment, interestRate, periodsPaid, totalPeriods].some(
          v => typeof v !== 'number' || isNaN(v) || v < 0
        )) {
          return 0;
        }
        
        const periodicRate = interestRate / 12; // Monthly rate
        
        if (periodicRate === 0 || Math.abs(periodicRate) < 1e-12) {
          // Simple case: no interest
          return Math.max(0, roundFinancial(principal - (payment * periodsPaid), 2));
        }
        
        // Exact remaining balance formula
        const numerator = Math.pow(1 + periodicRate, totalPeriods) - Math.pow(1 + periodicRate, periodsPaid);
        const denominator = Math.pow(1 + periodicRate, totalPeriods) - 1;
        
        const remaining = principal * (numerator / denominator);
        return Math.max(0, roundFinancial(remaining, 2));
      }

      /**
       * Parse formatted currency/number string back to number
       * Handles commas, dollar signs, etc.
       */
      function parseFinancialString(str) {
        if (typeof str !== 'string') return 0;
        
        // Remove currency symbols, commas, and trim
        const cleaned = str.replace(/[$,%\s]/g, '').trim();
        
        // Handle K/M/B/T suffixes
        const suffixMatch = cleaned.match(/([+-]?\d*\.?\d+)([KMBT]?)$/i);
        if (!suffixMatch) return parseFloat(cleaned) || 0;
        
        const [, numStr, suffix] = suffixMatch;
        let num = parseFloat(numStr);
        
        if (isNaN(num)) return 0;
        
        // Apply suffix multiplier
        switch (suffix.toUpperCase()) {
          case 'K': num *= 1e3; break;
          case 'M': num *= 1e6; break;
          case 'B': num *= 1e9; break;
          case 'T': num *= 1e12; break;
        }
        
        return num;
      }

      /**
       * Format with custom prefix/suffix (for flexible display)
       */
      function formatCustom(value, options = {}) {
        const {
          decimals = 2,
          prefix = '',
          suffix = '',
          signDisplay = 'auto', // 'auto', 'always', 'never', 'exceptZero'
          useGrouping = true,
          unit = ''
        } = options;
        if (typeof value !== 'number' || isNaN(value)) {
          value = 0;
        }
        const rounded = roundFinancial(value, decimals);
        const formatter = new Intl.NumberFormat('en-US', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
          useGrouping: useGrouping,
          signDisplay: signDisplay
        });
        const formatted = formatter.format(rounded);
        return `${prefix}${formatted}${unit ? ` ${unit}` : ''}${suffix}`;
      }
      // ==================== END ENHANCED FINANCIAL PRECISION UTILITIES ====================




      // --- State Management ---
      let activeTier = "basic";
      let activeTab = "pv-fv";

      // --- DOM Elements ---
      const tabsContainer = document.getElementById("tabsContainer");
      const calculatorContent = document.getElementById("calculatorContent");
      const tierButtons = document.querySelectorAll(".tier-btn");


      // Utility: Setup auto-save for a calculator
      function setupCalculatorAutoSave(calculatorId, calculateBtnId, resultsDivId) {
        const calculateBtn = document.getElementById(calculateBtnId);
        if (!calculateBtn) return;
        
        const originalHandler = calculateBtn.onclick;
        
        calculateBtn.onclick = function() {
          // Call original handler
          if (originalHandler) originalHandler.call(this);
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState(calculatorId);
          }, 100);
        };
      }

      // --- Initialize App ---
      function initApp() {
        // Try to restore previous state
        const savedState = StorageManager.loadState();
        
        if (savedState) {
          // Restore tier and tab
          if (savedState.activeTier) {
            activeTier = savedState.activeTier;
            // Update tier button states
            tierButtons.forEach(btn => {
              btn.classList.toggle('active', btn.dataset.tier === activeTier);
            });
          }
          
          if (savedState.activeTab) {
            activeTab = savedState.activeTab;
          }
        }
        
        renderTabs();
        renderCalculator();
        setupEventListeners();
        
        // Restore calculator state after a short delay
        if (savedState && savedState.activeTab) {
          setTimeout(() => {
            StorageManager.restoreCalculatorState(activeTab);
          }, 200);
        }

        // Update "last saved" display every minute
        setInterval(() => {
          const state = StorageManager.loadState();
          if (state && state.timestamp) {
            StorageManager.updateLastSavedDisplay(state.timestamp);
          }
        }, 60000); // Every 1 minute
        
        // Update immediately on load
        setTimeout(() => {
          const state = StorageManager.loadState();
          if (state && state.timestamp) {
            StorageManager.updateLastSavedDisplay(state.timestamp);
          }
        }, 500);
      }
      // --- Initialize the app when the page loads ---
      document.addEventListener("DOMContentLoaded", initApp);     

      // --- Event Listeners ---
      function setupEventListeners() {
        // Tier selection
        tierButtons.forEach((button) => {
          button.addEventListener("click", () => {
            // Save current calculator state before switching
            const currentState = StorageManager.loadState();
            if (currentState && currentState.activeTab) {
              StorageManager.saveCalculatorState(currentState.activeTab);
            }
            
            // Switch to new tier
            tierButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");
            activeTier = button.dataset.tier;

            // Switch to first calculator of new tier
            const firstCalculator = calculators[activeTier][0];
            if (firstCalculator) {
              activeTab = firstCalculator.id;
            }

            renderTabs();
            renderCalculator();
            
            // Save new state
            const state = StorageManager.loadState() || {};
            state.activeTier = activeTier;
            state.activeTab = activeTab;
            StorageManager.saveState(state);
          });
        });

        // Clear data button
        const clearDataBtn = document.getElementById('clearDataBtn');
        if (clearDataBtn) {
          clearDataBtn.addEventListener('click', () => {
            const confirmed = confirm(
              '‚ö†Ô∏è Are you sure you want to clear all saved data?\n\n' +
              'This will delete:\n' +
              '‚Ä¢ All saved calculator inputs\n' +
              '‚Ä¢ All saved results\n' +
              '‚Ä¢ Your last session state\n\n' +
              'This action cannot be undone!'
            );
            
            if (confirmed) {
              StorageManager.clearState();
              // Refresh page to reset everything
              setTimeout(() => {
                location.reload();
              }, 500);
            }
          });
        }
        
        // Auto-save when switching tabs (delegated)
        tabsContainer.addEventListener('click', (e) => {
          if (e.target.classList.contains('tab-btn')) {
            // Save current calculator state before switching
            const currentState = StorageManager.loadState();
            if (currentState && currentState.activeTab) {
              StorageManager.saveCalculatorState(currentState.activeTab);
            }
            
            // Get the new tab ID
            const tabId = Array.from(tabsContainer.children).indexOf(e.target);
            if (tabId >= 0) {
              const tierCalculators = calculators[activeTier];
              if (tierCalculators[tabId]) {
                activeTab = tierCalculators[tabId].id;
                
                // Save new state
                const state = StorageManager.loadState() || {};
                state.activeTab = activeTab;
                StorageManager.saveState(state);
              }
            }
          }
        });
      }
      
      // --- Render Tabs ---
      function renderTabs() {
        tabsContainer.innerHTML = "";
        const tierCalculators = calculators[activeTier];

        tierCalculators.forEach((calc) => {
          const tabButton = document.createElement("button");
          tabButton.className = `tab-btn ${
            calc.id === activeTab ? "active" : ""
          }`;
          tabButton.textContent = calc.name;
          tabButton.onclick = () => {
            activeTab = calc.id;
            renderTabs();
            renderCalculator();
          };
          tabsContainer.appendChild(tabButton);
        });
      }

      // --- Render Calculator ---
      function renderCalculator() {
        const calculator = calculators[activeTier].find(
          (c) => c.id === activeTab
        );
        if (!calculator) return;

        switch (calculator.component) {
          case "PVFVCalculator":
            calculatorContent.innerHTML = renderPVFVCalculator();
            setupPVFVCalculator();
            break;
          case "CompoundInterestCalculator":
            calculatorContent.innerHTML = renderCompoundInterestCalculator();
            setupCompoundInterestCalculator();
            break;
          case "LoanPaymentCalculator":
            calculatorContent.innerHTML = renderLoanPaymentCalculator();
            setupLoanPaymentCalculator();
            break;
          case "CAPMCalculator":
            calculatorContent.innerHTML = renderCAPMCalculator();
            setupCAPMCalculator();
            break;
          case "CCPOCalculator":
            calculatorContent.innerHTML = renderCCPOCalculator();
            setupCCPOCalculator();
            break;
          case "TimeMoneyCalculator":
            calculatorContent.innerHTML = renderTimeMoneyCalculator();
            setupTimeMoneyCalculator();
            break;
          case "BondPricingCalculator":
            calculatorContent.innerHTML = renderBondPricingCalculator();
            setupBondPricingCalculator();
            break;
          case "NPVIRRCalculator":
            calculatorContent.innerHTML = renderNPVIRRCalculator();
            setupNPVIRRCalculator();
            break;
          case "XNPVXIRRCalculator":
            calculatorContent.innerHTML = renderXNPVXIRRCalculator();
            setupXNPVXIRRCalculator();
            break;
          case "BlackScholesCalculator":
            calculatorContent.innerHTML = renderBlackScholesCalculator();
            setupBlackScholesCalculator();
            break;
          case "WACCCalculator":
            calculatorContent.innerHTML = renderWACCCalculator();
            setupWACCCalculator();
            break;
          case "DCFCalculator":
            calculatorContent.innerHTML = renderDCFCalculator();
            setupDCFCalculator();
            break;
          case "LBOCalculator":
            calculatorContent.innerHTML = renderLBOCalculator();
            setupLBOCalculator();
            break;
          case "RealEstateCalculator":
            calculatorContent.innerHTML = renderRealEstateCalculator();
            setupRealEstateCalculator();
            break;            
          default:
            calculatorContent.innerHTML = "<p>Calculator not found</p>";
        }
        
        // Setup auto-save for all inputs
        setTimeout(() => {
          const container = document.getElementById('calculatorContent');
          if (!container) return;
          
          // Auto-save on input change
          container.addEventListener('input', (e) => {
            if (e.target.matches('input, select')) {
              StorageManager.saveCalculatorState(activeTab);
            }
          });
          
          // Auto-save on button click (for calculate buttons)
          container.addEventListener('click', (e) => {
            if (e.target.matches('.btn, button')) {
              // Save after calculation (delay to allow results to render)
              setTimeout(() => {
                StorageManager.saveCalculatorState(activeTab);
              }, 300);
            }
          });
        }, 100);
      }      


      // ==================== BASIC CALCULATORS ====================

      // --- PV/FV Calculator ---
      function renderPVFVCalculator() {
        return `
          <h2 class="calculator-title">Present Value / Future Value Calculator</h2>
          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Understanding Time Value of Money
            </div>
            <p class="explanation-text">
              <strong>Present Value (PV)</strong>: How much a future sum is worth today.<br>
              <strong>Future Value (FV)</strong>: How much money today will grow to in the future.
            </p>
            <div class="explanation-note">
              <strong>Financial Insight:</strong> $100 today is worth more than $100 tomorrow because you can invest it today.
            </div>
          </div>

          <div class="options-toggle">
            <button class="option-btn active" id="pvOption">Calculate PV</button>
            <button class="option-btn" id="fvOption">Calculate FV</button>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" id="amountLabel">Future Value ($)</label>
              <input type="number" id="futureValue" class="form-input" placeholder="10000">
            </div>
            <div class="form-group">
              <label class="form-label">Annual Interest Rate (%)</label>
              <input type="number" id="interestRate" class="form-input" placeholder="5" step="0.01">
            </div>
            <div class="form-group">
              <label class="form-label">Number of Periods (Years)</label>
              <input type="number" id="periods" class="form-input" placeholder="10">
            </div>
          </div>

          <button class="btn btn-primary" id="calculatePVFV">Calculate</button>

          <div id="pvfvResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
            <!-- Results will be populated here -->
          </div>
        `;
      }

      function setupPVFVCalculator() {
        const pvOption = document.getElementById("pvOption");
        const fvOption = document.getElementById("fvOption");
        const amountInput = document.getElementById("futureValue");
        const amountLabel = document.getElementById("amountLabel");
        const interestRateInput = document.getElementById("interestRate");
        const periodsInput = document.getElementById("periods");
        const calculateBtn = document.getElementById("calculatePVFV");
        const resultsDiv = document.getElementById("pvfvResults");

        let isPVCalculation = true;

        // ========== UX IMPROVEMENT: Clear input when switching mode ==========
        pvOption.addEventListener("click", () => {
          pvOption.classList.add("active");
          fvOption.classList.remove("active");
          isPVCalculation = true;
          
          amountLabel.textContent = "Future Value ($)";
          amountInput.placeholder = "10000";
          amountInput.value = "";
          resultsDiv.classList.add("hidden");
        });

        fvOption.addEventListener("click", () => {
          fvOption.classList.add("active");
          pvOption.classList.remove("active");
          isPVCalculation = false;
          
          amountLabel.textContent = "Present Value ($)";
          amountInput.placeholder = "5000";
          amountInput.value = "";
          resultsDiv.classList.add("hidden");
        });

        calculateBtn.addEventListener("click", () => {
          const r = parseFloat(interestRateInput.value) / 100;
          const n = parseFloat(periodsInput.value);
          const amount = parseFloat(amountInput.value);

          // ========== ROBUST VALIDATION ==========
          if (isNaN(r) || r < 0 || r > 100) {
            alert("Please enter a valid interest rate (0% - 100%).");
            return;
          }
          if (isNaN(n) || n < 0 || n > 1000) {
            alert("Please enter a valid number of periods (0 - 1000).");
            return;
          }
          if (isNaN(amount) || amount <= 0) {
            alert("Please enter a valid amount (greater than 0).");
            return;
          }

          let pv, fv;
          const growthMultiplier = Math.pow(1 + r, n);

          if (isPVCalculation) {
            fv = amount;
            pv = fv / growthMultiplier;
          } else {
            pv = amount;
            fv = pv * growthMultiplier;
          }

          // ========== CONSISTENT ROUNDING (like Loan Calculator) ==========
          pv = roundFinancial(pv, 2);
          fv = roundFinancial(fv, 2);
          const multiplierDisplay = roundFinancial(growthMultiplier, 4);

          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: ${isPVCalculation ? 'var(--indigo-100)' : 'var(--slate-100)'};">
                <div class="result-label">Present Value (PV)</div>
                <div class="result-value">${formatCurrency(pv)}</div>
                <div class="result-subtext">Value in today's dollars</div>
              </div>
              <div class="result-card" style="background-color: ${!isPVCalculation ? 'var(--indigo-100)' : 'var(--slate-100)'};">
                <div class="result-label">Future Value (FV)</div>
                <div class="result-value">${formatCurrency(fv)}</div>
                <div class="result-subtext">Value after ${n} periods</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Interest Rate</div>
                <div class="result-value">${formatPercent(r)}</div>
                <div class="result-subtext">Annual rate</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Growth Factor</div>
                <div class="result-value">${multiplierDisplay}x</div>
                <div class="result-subtext">${n} periods compounded</div>
              </div>
            </div>
            
            <!-- Financial Insight Section -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--indigo-50); border-radius: 0.375rem; border-left: 4px solid var(--indigo-400);">
              <div style="font-size: 0.875rem; color: var(--indigo-800);">
                <strong>üí∞ Time Value of Money Insight:</strong><br>
                ${isPVCalculation ? 
                  `To have ${formatCurrency(fv)} in ${n} years, you need to invest ${formatCurrency(pv)} today at ${formatPercent(r)} annual interest.` : 
                  `Investing ${formatCurrency(pv)} today at ${formatPercent(r)} interest will grow to ${formatCurrency(fv)} in ${n} years.`
                }
              </div>
            </div>
          `;

          resultsDiv.classList.remove("hidden");
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('pv-fv');
          }, 100);
        });
      }



      // --- Compound Interest Calculator ---
      function renderCompoundInterestCalculator() {
        return `
          <h2 class="calculator-title">Compound Interest Calculator</h2>
          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              The Power of Compounding
            </div>
            <p class="explanation-text">
              <strong>Compound interest</strong> is interest calculated on the initial principal and also on the accumulated interest of previous periods.
              It's often referred to as "interest on interest" and can cause wealth to grow exponentially over time.
            </p>
            <p class="explanation-text">
              The more frequently interest is compounded, the greater the return. This calculator helps you understand how different compounding frequencies affect your investment growth.
            </p>
            <div class="explanation-note">
              <strong>Financial Insight:</strong> Starting early and allowing your investments to compound over long periods is one of the most powerful wealth-building strategies.
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Principal Amount ($)</label>
              <input type="number" id="principal" class="form-input" placeholder="10000">
            </div>
            <div class="form-group">
              <label class="form-label">Annual Interest Rate (%)</label>
              <input type="number" id="annualRate" class="form-input" placeholder="5" step="0.01">
            </div>
            <div class="form-group">
              <label class="form-label">Time Period (Years)</label>
              <input type="number" id="years" class="form-input" placeholder="10">
            </div>
            <div class="form-group">
              <label class="form-label">Compounding Frequency</label>
              <select id="compounding" class="form-select">
                <option value="1">Annually (1x/year)</option>
                <option value="2">Semi-annually (2x/year)</option>
                <option value="4">Quarterly (4x/year)</option>
                <option value="12" selected>Monthly (12x/year)</option>
                <option value="365">Daily (365x/year)</option>
              </select>
            </div>
          </div>

          <button class="btn btn-success" id="calculateCI">Calculate Compound Interest</button>

          <div id="ciResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50);">
            <!-- Results will be populated here -->
          </div>
        `;
      }

      function setupCompoundInterestCalculator() {
        const calculateBtn = document.getElementById("calculateCI");
        const resultsDiv = document.getElementById("ciResults");

        calculateBtn.addEventListener("click", () => {
          const principal = parseFloat(document.getElementById("principal").value);
          const annualRatePercent = parseFloat(document.getElementById("annualRate").value);
          const years = parseFloat(document.getElementById("years").value);
          const compounding = parseFloat(document.getElementById("compounding").value);

          // ========== ROBUST VALIDATION ==========
          if (isNaN(principal) || principal <= 0) {
            alert("Please enter a valid principal amount (greater than 0).");
            return;
          }
          if (isNaN(annualRatePercent) || annualRatePercent < 0) {
            alert("Please enter a valid interest rate (0% or greater).");
            return;
          }
          if (isNaN(years) || years <= 0 || years > 100) {
            alert("Please enter a valid time period (1-100 years).");
            return;
          }
          if (isNaN(compounding) || compounding <= 0) {
            alert("Please select a valid compounding frequency.");
            return;
          }

          const annualRate = annualRatePercent / 100;
          const totalN = compounding * years;
          const ratePerPeriod = annualRate / compounding;
          
          // Core calculation: A = P * (1 + r/n)^(nt)
          let finalAmount = principal * Math.pow(1 + ratePerPeriod, totalN);
          
          // ========== CONSISTENT ROUNDING (like Loan Calculator) ==========
          finalAmount = roundFinancial(finalAmount, 2);
          const interestEarned = roundFinancial(finalAmount - principal, 2);
          
          // Calculate APY (Effective Annual Yield)
          const apy = Math.pow(1 + ratePerPeriod, compounding) - 1;
          
          // Get compounding frequency display name
          const compFrequency = document.getElementById("compounding");
          const frequencyName = compFrequency.options[compFrequency.selectedIndex].text;

          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: var(--green-100);">
                <div class="result-label">Future Value</div>
                <div class="result-value">${formatCurrency(finalAmount)}</div>
                <div class="result-subtext">After ${years} years</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Principal</div>
                <div class="result-value">${formatCurrency(principal)}</div>
                <div class="result-subtext">Initial investment</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Interest Earned</div>
                <div class="result-value">${formatCurrency(interestEarned)}</div>
                <div class="result-subtext">${formatPercent(interestEarned/principal)} return</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Effective Annual Yield</div>
                <div class="result-value">${formatPercent(apy, 4)}</div>
                <div class="result-subtext">vs ${formatPercent(annualRate)} nominal rate</div>
              </div>
            </div>
            
            <!-- Additional Metrics -->
            <div style="margin-top: 1.5rem;">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
                <div style="padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Compounding</div>
                  <div style="font-weight: 600; color: var(--slate-800);">${frequencyName}</div>
                </div>
                <div style="padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Total Periods</div>
                  <div style="font-weight: 600; color: var(--slate-800);">${formatInteger(totalN)}</div>
                </div>
                <div style="padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Rate per Period</div>
                  <div style="font-weight: 600; color: var(--slate-800);">${formatPercent(ratePerPeriod, 4)}</div>
                </div>
              </div>
            </div>
            
            <!-- Consistency Verification -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50); border-radius: 0.375rem; border-left: 4px solid var(--green-400);">
              <div style="font-size: 0.875rem; color: var(--green-800);">
                <strong>‚úÖ Verified Calculation:</strong><br>
                ${formatCurrency(principal)} + ${formatCurrency(interestEarned)} = ${formatCurrency(finalAmount)}
              </div>
            </div>
            
            <!-- Financial Insight -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem;">
              <div style="font-size: 0.75rem; color: var(--slate-700);">
                <strong>üí° Why APY Matters:</strong> 
                Your ${formatPercent(annualRate)} nominal rate compounds ${compounding} times per year, 
                resulting in an effective annual yield of ${formatPercent(apy, 4)}. 
                ${apy > annualRate ? 'Compounding increases your actual return!' : ''}
              </div>
            </div>
          `;

          resultsDiv.classList.remove("hidden");
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('compound-interest');
          }, 100);
        });
      }



      // --- Loan Payment Calculator ---
      function renderLoanPaymentCalculator() {
        return `
                      <h2 class="calculator-title">Loan Payment Calculator</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Understanding Loan Amortization
                          </div>
                          <p class="explanation-text">
                              This calculator helps you determine your monthly loan payment and understand how much interest you'll pay over the life of the loan.
                              It uses the standard amortization formula for fixed-rate loans.
                          </p>
                          <p class="explanation-text">
                              In the early years of a loan, a larger portion of each payment goes toward interest rather than principal.
                              As the loan matures, this ratio gradually reverses.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> Even a small reduction in interest rate or shortening the loan term can save you thousands of dollars in total interest payments.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Loan Amount ($)</label>
                              <input type="number" id="loanAmount" class="form-input" placeholder="10000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Annual Interest Rate (%)</label>
                              <input type="number" id="loanRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Loan Term (Years)</label>
                              <input type="number" id="loanTerm" class="form-input" placeholder="10">
                          </div>
                      </div>
                      <button class="btn btn-secondary" id="calculateLoan">Calculate Loan Payment</button>
                      <div id="loanResults" class="results-container hidden" style="border-color: var(--blue-100); background-color: var(--blue-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupLoanPaymentCalculator() {
        const calculateBtn = document.getElementById("calculateLoan");
        const resultsDiv = document.getElementById("loanResults");

        calculateBtn.addEventListener("click", () => {
          const principal = parseFloat(document.getElementById("loanAmount").value);
          const annualRate = parseFloat(document.getElementById("loanRate").value) / 100;
          const years = parseFloat(document.getElementById("loanTerm").value);

          if (isNaN(principal) || isNaN(annualRate) || isNaN(years) || 
              principal < 0 || annualRate < 0 || years < 0) {
            alert("Please enter valid positive numbers.");
            return;
          }

          const numberOfPayments = years * 12;
          let monthlyPayment = 0;
          let totalPayment = 0;
          let totalInterest = 0;

          // ========== CALCULATION WITH HIGH PRECISION ==========
          const monthlyRate = safeDivide(annualRate, 12, 12); // 12 decimals for accuracy
          
          if (Math.abs(monthlyRate) < 1e-12) {
            // 0% interest case
            monthlyPayment = safeDivide(principal, numberOfPayments, 2);
            totalInterest = 0;
            totalPayment = principal;
          } else {
            // Regular case with interest
            const denominator = 1 - Math.pow(1 + monthlyRate, -numberOfPayments);
            monthlyPayment = safeDivide(
              safeMultiply(principal, monthlyRate),
              denominator,
              6 // Keep 6 decimals for calculation accuracy
            );
            
            // ========== FIX: CALCULATE EXACT TOTALS ==========
            // Step 1: Calculate standard rounded monthly payment (what bank actually charges)
            const standardMonthly = roundFinancial(monthlyPayment, 2);
            
            // Step 2: Simulate full loan to get exact totals
            let simulatedBalance = principal;
            let calculatedTotalPayment = 0;
            let calculatedTotalInterest = 0;
            
            for (let month = 1; month <= numberOfPayments; month++) {
              const interest = roundFinancial(simulatedBalance * monthlyRate, 2);
              calculatedTotalInterest += interest;
              
              let payment = standardMonthly;
              if (month === numberOfPayments) {
                // Last period: adjust to clear balance
                payment = roundFinancial(simulatedBalance + interest, 2);
              }
              
              const principalPaid = roundFinancial(payment - interest, 2);
              simulatedBalance = roundFinancial(simulatedBalance - principalPaid, 2);
              calculatedTotalPayment += payment;
              
              // Prevent negative balance
              if (simulatedBalance < 0) {
                payment -= Math.abs(simulatedBalance);
                simulatedBalance = 0;
              }
            }
            
            // Step 3: Use calculated totals (not formula-based)
            monthlyPayment = standardMonthly;
            totalPayment = roundFinancial(calculatedTotalPayment, 2);
            totalInterest = roundFinancial(calculatedTotalInterest, 2);
          }

          // ========== DISPLAY RESULTS ==========
          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: var(--blue-100);">
                <div class="result-label">Monthly Payment*</div>
                <div class="result-value">${formatCurrency(monthlyPayment)}</div>
                <div class="result-subtext">Standard payment amount</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Total Payment</div>
                <div class="result-value">${formatCurrency(totalPayment)}</div>
                <div class="result-subtext">Actual amount paid</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Total Interest</div>
                <div class="result-value">${formatCurrency(totalInterest)}</div>
                <div class="result-subtext">Interest over ${years} years</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Loan Term</div>
                <div class="result-value">${years} years (${numberOfPayments} months)</div>
                <div class="result-subtext">${annualRate === 0 ? '0% interest loan' : ''}</div>
              </div>
            </div>
            
            <!-- Amortization Schedule Preview -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--blue-50); border-radius: 0.5rem;">
              <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--blue-800); margin-bottom: 0.75rem;">
                üìÖ Amortization Schedule (Full ${numberOfPayments} months)
              </h4>
              ${generateAmortizationPreview(principal, annualRate, years, monthlyPayment)}
            </div>
            
            <!-- Legend -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem; font-size: 0.75rem;">
              <div style="color: var(--slate-600);">
                <strong>Note:</strong> *Final payment may be slightly adjusted (¬±$0.10) to account for rounding differences.
                This reflects actual banking practice.
              </div>
            </div>
          `;

          resultsDiv.classList.remove("hidden");
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('loan-payment');
          }, 100);
        });
      }

      function generateAmortizationPreview(principal, annualRate, years, monthlyPayment) {
        let balance = principal;
        const monthlyRate = annualRate / 12;
        const totalMonths = years * 12;
        const isZeroInterest = Math.abs(monthlyRate) < 1e-12;
        const standardMonthly = roundFinancial(monthlyPayment, 2);
        
        // Calculate exact totals and final payment
        let simulatedBalance = principal;
        let calculatedTotal = 0;
        let calculatedInterest = 0;
        let finalPayment = standardMonthly;
        
        for (let month = 1; month <= totalMonths; month++) {
          const interest = roundFinancial(simulatedBalance * monthlyRate, 2);
          calculatedInterest += interest;
          
          let payment = standardMonthly;
          if (month === totalMonths) {
            payment = roundFinancial(simulatedBalance + interest, 2);
            finalPayment = payment;
          }
          
          const principalPaid = roundFinancial(payment - interest, 2);
          simulatedBalance = roundFinancial(simulatedBalance - principalPaid, 2);
          calculatedTotal += payment;
          
          if (simulatedBalance < 0) {
            simulatedBalance = 0;
          }
        }
        
        const hasAdjustment = Math.abs(finalPayment - standardMonthly) > 0.001;
        const adjustmentAmount = roundFinancial(finalPayment - standardMonthly, 2);
        
        // Generate table
        let html = '<div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">';
        html += '<thead style="position: sticky; top: 0; background: var(--slate-100); z-index: 10;">';
        html += '<tr>';
        html += '<th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--slate-300);">Month</th>';
        html += '<th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid var(--slate-300);">Payment</th>';
        html += '<th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid var(--slate-300);">Interest</th>';
        html += '<th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid var(--slate-300);">Principal</th>';
        html += '<th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid var(--slate-300);">Balance</th>';
        html += '</tr></thead><tbody>';
        
        balance = principal; // Reset for display
        
        for (let month = 1; month <= totalMonths; month++) {
          const interest = roundFinancial(balance * monthlyRate, 2);
          let payment = standardMonthly;
          let isFinalAdjusted = false;
          
          // Last period adjustment
          if (month === totalMonths) {
            payment = roundFinancial(balance + interest, 2);
            isFinalAdjusted = hasAdjustment;
          }
          
          const principalPaid = roundFinancial(payment - interest, 2);
          balance = roundFinancial(balance - principalPaid, 2);
          
          // Highlight rows
          const isHighlighted = month === totalMonths;
          const rowStyle = isHighlighted ? 'background: var(--blue-50) !important;' : 
                        (month % 2 === 0 ? 'background: var(--slate-50);' : '');
          
          html += `<tr style="${rowStyle}">`;
          html += `<td style="padding: 0.5rem; border-bottom: 1px solid var(--slate-200);">
                    ${month}
                    ${isFinalAdjusted ? ' <span style="color: var(--blue-600); font-weight: 600;">(final)</span>' : ''}
                  </td>`;
          
          html += `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--slate-200);
                    ${isFinalAdjusted ? 'font-weight: bold; color: var(--blue-600);' : ''}">
                    ${formatCurrency(payment)}
                    ${isFinalAdjusted ? '*' : ''}
                  </td>`;
          
          html += `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--slate-200);
                    color: var(--red-600);">${formatCurrency(interest)}</td>`;
          
          html += `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--slate-200);
                    color: var(--green-600);">${formatCurrency(principalPaid)}</td>`;
          
          html += `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--slate-200);
                    font-weight: ${balance === 0 ? '700' : '500'};">
                    ${balance === 0 ? 'üéâ PAID OFF' : formatCurrency(balance)}
                  </td>`;
          
          html += '</tr>';
          
          if (balance <= 0) break;
        }
        
        html += '</tbody></table></div>';
        
        // Summary section
        html += `<div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50); border-radius: 0.375rem;">
                  <div style="font-size: 0.75rem; color: var(--green-800);">
                    <strong>üìä Loan Summary:</strong>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                      <div>‚Ä¢ Standard Monthly Payment:</div>
                      <div style="text-align: right;">${formatCurrency(standardMonthly)}</div>
                      ${hasAdjustment ? `
                      <div>‚Ä¢ Final Payment Adjustment:</div>
                      <div style="text-align: right; color: ${adjustmentAmount > 0 ? 'var(--blue-600)' : 'var(--red-600)'}">
                        ${adjustmentAmount > 0 ? '+' : ''}${formatCurrency(adjustmentAmount)}
                      </div>
                      ` : ''}
                      <div>‚Ä¢ Total Principal Paid:</div>
                      <div style="text-align: right;">${formatCurrency(principal)}</div>
                      <div>‚Ä¢ Total Interest Paid:</div>
                      <div style="text-align: right;">${formatCurrency(calculatedInterest)}</div>
                      <div style="font-weight: 600; border-top: 1px solid var(--slate-300); padding-top: 0.25rem;">Total Amount Paid:</div>
                      <div style="text-align: right; font-weight: 600; border-top: 1px solid var(--slate-300); padding-top: 0.25rem;">
                        ${formatCurrency(calculatedTotal)}
                      </div>
                    </div>
                  </div>
                </div>`;
        
        return html;
      }

      

      // ==================== INTERMEDIATE CALCULATORS ====================
      // --- CAPM Calculator ---
      function renderCAPMCalculator() {
        return `
                      <h2 class="calculator-title">Capital Asset Pricing Model (CAPM)</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Risk and Return Relationship
                          </div>
                          <p class="explanation-text">
                              The <strong>Capital Asset Pricing Model (CAPM)</strong> describes the relationship between systematic risk and expected return for assets, particularly stocks.
                              It is widely used throughout finance for pricing risky securities and generating expected returns for assets given the risk of those assets.
                          </p>
                          <p class="explanation-text">
                              <strong>Beta (Œ≤)</strong> measures a stock's volatility compared to the overall market. A beta of 1 indicates the stock moves with the market,
                              while a beta greater than 1 indicates higher volatility.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> CAPM suggests that investors need to be compensated in two ways: time value of money (risk-free rate) and risk (market risk premium). The model helps determine if a stock is fairly valued given its risk profile.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Risk-free Rate (%)</label>
                              <input type="number" id="riskFreeRate" class="form-input" placeholder="3" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Beta (Œ≤)</label>
                              <input type="number" id="beta" class="form-input" placeholder="1.2" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Market Return (%)</label>
                              <input type="number" id="marketReturn" class="form-input" placeholder="8" step="0.01">
                          </div>
                      </div>
                      <button class="btn btn-primary" id="calculateCAPM">Calculate Expected Return (CAPM)</button>
                      <div id="capmResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupCAPMCalculator() {
        const calculateBtn = document.getElementById("calculateCAPM");
        const resultsDiv = document.getElementById("capmResults");

        calculateBtn.addEventListener("click", () => {
          const rf =
            parseFloat(document.getElementById("riskFreeRate").value) / 100;
          const beta = parseFloat(document.getElementById("beta").value);
          const rm =
            parseFloat(document.getElementById("marketReturn").value) / 100;

          if (isNaN(rf) || isNaN(beta) || isNaN(rm)) {
            alert("Please enter valid numbers.");
            return;
          }

          const marketRiskPremium = rm - rf;
          const riskPremium = beta * marketRiskPremium;
          const expectedReturn = rf + riskPremium;

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--indigo-100);">
                                  <div class="result-label">Expected Return</div>
                                  <div class="result-value">${(
                                    expectedReturn * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Risk-free Rate</div>
                                  <div class="result-value">${(
                                    rf * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Market Risk Premium</div>
                                  <div class="result-value">${(
                                    marketRiskPremium * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Risk Premium</div>
                                  <div class="result-value">${(
                                    riskPremium * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('capm');
          }, 100);
        });
      }

      // --- Bond Pricing Calculator ---
      function renderBondPricingCalculator() {
        return `
                      <h2 class="calculator-title">Bond Pricing Calculator</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Fixed Income Valuation
                          </div>
                          <p class="explanation-text">
                              This calculator determines the fair value of a bond based on its coupon rate, yield to maturity, and time to maturity.
                              Bond prices move inversely to interest rates - when rates rise, bond prices fall, and vice versa.
                          </p>
                          <p class="explanation-text">
                              <strong>Yield to Maturity (YTM)</strong> is the total return anticipated on a bond if it is held until it matures.
                              When YTM equals the coupon rate, the bond trades at par (face value). When YTM is higher than the coupon rate, the bond trades at a discount.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> Bond duration measures sensitivity to interest rate changes. Longer-term bonds are more sensitive to rate changes than shorter-term bonds.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Face Value ($)</label>
                              <input type="number" id="faceValue" class="form-input" placeholder="1000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Coupon Rate (%)</label>
                              <input type="number" id="couponRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Yield to Maturity (%)</label>
                              <input type="number" id="ytm" class="form-input" placeholder="6" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Years to Maturity</label>
                              <input type="number" id="yearsToMaturity" class="form-input" placeholder="10">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Payment Frequency</label>
                              <select id="frequency" class="form-select">
                                  <option value="1">Annual</option>
                                  <option value="2" selected>Semi-annual</option>
                              </select>
                          </div>
                      </div>
                      <button class="btn btn-warning" id="calculateBond">Calculate Bond Price</button>
                      <div id="bondResults" class="results-container hidden" style="border-color: var(--orange-100); background-color: var(--orange-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupBondPricingCalculator() {
        const calculateBtn = document.getElementById("calculateBond");
        const resultsDiv = document.getElementById("bondResults");

        calculateBtn.addEventListener("click", () => {
          const faceValue = parseFloat(
            document.getElementById("faceValue").value
          );
          const couponRate =
            parseFloat(document.getElementById("couponRate").value) / 100;
          const ytm = parseFloat(document.getElementById("ytm").value) / 100;
          const yearsToMaturity = parseFloat(
            document.getElementById("yearsToMaturity").value
          );
          const frequency = parseFloat(
            document.getElementById("frequency").value
          );

          if (
            isNaN(faceValue) ||
            isNaN(couponRate) ||
            isNaN(ytm) ||
            isNaN(yearsToMaturity) ||
            isNaN(frequency) ||
            faceValue < 0 ||
            couponRate < 0 ||
            ytm < 0 ||
            yearsToMaturity < 0 ||
            (frequency !== 1 && frequency !== 2)
          ) {
            alert("Please enter valid positive numbers.");
            return;
          }

          // ========== S·ª¨ D·ª§NG FINANCIAL PRECISION UTILITIES ==========
          const couponPayment = safeDivide(safeMultiply(faceValue, couponRate), frequency, 4);
          const periods = roundFinancial(yearsToMaturity * frequency, 4);
          const periodicYield = safeDivide(ytm, frequency, 8);

          let bondPrice;
          
          if (financialEquals(periodicYield, 0, 1e-12)) {
            // Special case: zero yield
            bondPrice = safeAdd(safeMultiply(couponPayment, periods), faceValue);
          } else {
            // Closed-form formula v·ªõi precision
            const discountFactor = Math.pow(1 + periodicYield, -periods);
            const annuityFactor = safeDivide(1 - discountFactor, periodicYield, 10);
            
            bondPrice = safeAdd(
              safeMultiply(couponPayment, annuityFactor, 6),
              safeMultiply(faceValue, discountFactor, 6)
            );
          }
          
          // Round for display
          bondPrice = roundFinancial(bondPrice, 2);

          // Calculate additional metrics v·ªõi precision
          const totalCoupons = roundFinancial(couponPayment * periods, 2);
          const totalReturn = roundFinancial(bondPrice - faceValue, 2);
          const currentYield = roundFinancial(safeDivide(couponPayment * frequency, bondPrice, 6) * 100, 4);
          const capitalGainYield = roundFinancial(safeDivide(faceValue - bondPrice, bondPrice, 6) * 100, 4);
          
          // Determine bond status
          const isPremium = bondPrice > faceValue && !financialEquals(bondPrice, faceValue, 0.01);
          const isDiscount = bondPrice < faceValue && !financialEquals(bondPrice, faceValue, 0.01);
          const isPar = financialEquals(bondPrice, faceValue, 0.01);

          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: var(--orange-100);">
                <div class="result-label">Bond Price</div>
                <div class="result-value">${formatCurrency(bondPrice)}</div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${isPremium ? 'Premium' : isDiscount ? 'Discount' : 'Par'} bond
                </div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Face Value</div>
                <div class="result-value">${formatCurrency(faceValue)}</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Coupon Payment</div>
                <div class="result-value">${formatCurrency(couponPayment)}/period</div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${formatPercent(couponRate)} annually
                </div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Yield to Maturity</div>
                <div class="result-value">${formatPercent(ytm)}</div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${periodicYield.toFixed(6)} periodic
                </div>
              </div>
            </div>
            
            <!-- Additional Metrics -->
            <div style="margin-top: 1.5rem; background: var(--blue-50); padding: 1rem; border-radius: 0.5rem;">
              <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--blue-800); margin-bottom: 0.75rem;">
                üìä Additional Bond Metrics
              </h4>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;">
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Current Yield</div>
                  <div style="font-weight: 700; color: ${currentYield >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                    ${formatPercent(currentYield/100, 4)}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Periods</div>
                  <div style="font-weight: 700; color: var(--slate-700);">
                    ${periods.toFixed(1)}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Premium/Discount</div>
                  <div style="font-weight: 700; color: ${totalReturn >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                    ${totalReturn >= 0 ? '+' : ''}${formatCurrency(Math.abs(totalReturn))}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Total Coupons</div>
                  <div style="font-weight: 700; color: var(--slate-700);">
                    ${formatCurrency(totalCoupons)}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Bond Status -->
            <div style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.375rem; 
                        background: ${isPremium ? 'var(--orange-50)' : isDiscount ? 'var(--green-50)' : 'var(--blue-50)'}; 
                        border-left: 4px solid ${isPremium ? 'var(--orange-500)' : isDiscount ? 'var(--green-500)' : 'var(--blue-500)'};">
              <div style="font-weight: 600; color: ${isPremium ? 'var(--orange-800)' : isDiscount ? 'var(--green-800)' : 'var(--blue-800)'};">
                ${
                  isPremium 
                    ? `üí∞ Premium Bond: Trading at ${formatCurrency(bondPrice - faceValue)} above face value` 
                    : isDiscount 
                    ? `üìâ Discount Bond: Trading at ${formatCurrency(faceValue - bondPrice)} below face value`
                    : `üìä Par Bond: Trading exactly at face value`
                }
              </div>
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                YTM ${formatPercent(ytm)} ${isPremium ? ' < ' : isDiscount ? ' > ' : ' = '} 
                Coupon Rate ${formatPercent(couponRate)}
              </div>
            </div>
            
            <!-- Floating Point Protection Notice -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--purple-50); border-radius: 0.375rem; border-left: 3px solid var(--purple-500);">
              <div style="font-size: 0.7rem; color: var(--purple-800); display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-weight: 700;">üõ°Ô∏è Financial Precision Active:</span>
                <span>All calculations use banker's rounding and floating-point error correction</span>
              </div>
            </div>
          `;

          resultsDiv.classList.remove("hidden");

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('bond-pricing');
          }, 100);
        });
      }

      // --- NPV & IRR Calculator ---
      function renderNPVIRRCalculator() {
        return `
                      <h2 class="calculator-title">NPV & IRR Calculator</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Capital Budgeting Decisions
                          </div>
                          <p class="explanation-text">
                              <strong>Net Present Value (NPV)</strong> measures the profitability of a project by calculating the difference between the present value of cash inflows and outflows.
                              A positive NPV indicates the project should be profitable.
                          </p>
                          <p class="explanation-text">
                              <strong>Internal Rate of Return (IRR)</strong> is the discount rate that makes the NPV of all cash flows equal to zero.
                              It represents the expected compound annual rate of return that will be earned on a project.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> When evaluating mutually exclusive projects, NPV is generally preferred over IRR as it directly measures the value added to the firm. The IRR can be misleading when comparing projects of different sizes or durations.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Initial Investment ($)</label>
                              <input type="number" id="initialInvestment" class="form-input" placeholder="100000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Discount Rate (%)</label>
                              <input type="number" id="discountRate" class="form-input" placeholder="10" step="0.1">
                          </div>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Cash Flows by Year ($)</label>
                          <div class="cash-flows-grid" id="cashFlowsContainer">
                              <!-- Cash flows will be populated by JavaScript -->
                          </div>
                      </div>
                      <button class="btn btn-danger" id="calculateNPV">Calculate NPV & IRR</button>
                      <div id="npvResults" class="results-container hidden" style="border-color: var(--rose-100); background-color: var(--rose-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      // IRR calculation function 
      /**
       * Calculate IRR with fund-grade precision (Hybrid: Newton-Raphson + Bisection Fallback)
       * Production-ready for financial applications
       * @param {Array<number>} cashFlows - Array of cash flows
       * @param {number} initialGuess - Starting guess (default 0.1 = 10%)
       * @returns {Object} { success: boolean, irr?: number, iterations?: number, method?: string, message?: string }
       */

      function calculateAcademicIRR(cashFlows, initialGuess = 0.1) {       
        // ========== 1. VALIDATION ==========
        if (!cashFlows || !Array.isArray(cashFlows)) {
          return { 
            success: false, 
            message: "Invalid cash flows: must be an array" 
          };
        }
        
        if (cashFlows.length < 2) {
          return { 
            success: false, 
            message: "Need at least 2 cash flows for IRR calculation" 
          };
        }
        
        // Fund-grade validation: need both + and - cash flows
        const positiveFlows = cashFlows.filter(cf => cf > 0);
        const negativeFlows = cashFlows.filter(cf => cf < 0);
        const zeroFlows = cashFlows.filter(cf => cf === 0);
        
        if (positiveFlows.length === 0 || negativeFlows.length === 0) {
          return {
            success: false,
            message: `Cash flows must contain both positive and negative values. Found: ${positiveFlows.length}+, ${negativeFlows.length}-, ${zeroFlows.length}0`
          };
        }
        
        // ========== 2. CONFIGURATION ==========
        const maxIterations = 100;
        const tolerance = 1e-9;
        const maxIRR = 10.0;      // 1000% maximum realistic bound
        const minIRR = -0.9999;   // -99.99% minimum
        
        let irr = roundFinancial(initialGuess, 8);
        
        // ========== 3. NEWTON-RAPHSON (Fast & Accurate) ==========
        for (let iter = 0; iter < maxIterations; iter++) {
          let npv = 0;
          let derivative = 0;
          
          for (let t = 0; t < cashFlows.length; t++) {
            const cf = cashFlows[t];
            if (cf === 0) continue; // Skip zero cash flows for efficiency
            
            // Period = t (Year 0, Year 1, etc.)
            const discountFactor = Math.pow(1 + irr, t);
            const pv = safeDivide(cf, discountFactor, 12);
            npv = safeAdd(npv, pv);
            
            // Derivative for Newton-Raphson (only for t > 0)
            if (t > 0 && cf !== 0) {
              // Derivative of CF/(1+r)^t = -t * CF / (1+r)^(t+1)
              const derivativeFactor = safeMultiply(
                -t,
                Math.pow(1 + irr, -(t + 1)),
                12
              );
              const derivativeTerm = safeMultiply(cf, derivativeFactor, 12);
              derivative = safeAdd(derivative, derivativeTerm);
            }
          }
          
          // Convergence check (main criteria)
          if (financialEquals(npv, 0, tolerance)) {
            return {
              success: true,
              irr: roundFinancial(irr, 8),
              iterations: iter + 1,
              method: 'newton-raphson',
              convergence: 'npv ‚âà 0'
            };
          }
          
          // Stability check: prevent division by zero
          if (Math.abs(derivative) < 1e-15) {
            // Derivative too small, switch to bisection
            break;
          }
          
          // Newton-Raphson update: r = r - NPV/NPV'
          const delta = safeDivide(npv, derivative, 12);
          irr = safeAdd(irr, -delta);
          
          // Apply realistic bounds
          if (irr <= minIRR) {
            irr = minIRR;
          } else if (irr >= maxIRR) {
            irr = maxIRR;
          }
          
          // Secondary convergence check: small delta
          if (Math.abs(delta) < tolerance) {
            // Re-calculate NPV with new rate to confirm
            const finalNPV = calculateNPVAtRate(cashFlows, irr);
            if (financialEquals(finalNPV, 0, tolerance * 10)) {
              return {
                success: true,
                irr: roundFinancial(irr, 8),
                iterations: iter + 1,
                method: 'newton-raphson',
                convergence: 'delta < tolerance'
              };
            }
          }
        }
        
        // ========== 4. FALLBACK: BISECTION METHOD (More Stable) ==========
        // If Newton-Raphson fails, use bisection as robust fallback
        const bisectionResult = calculateIRRBisection(cashFlows, tolerance, minIRR, maxIRR);
        
        if (bisectionResult.success) {
          return {
            ...bisectionResult,
            method: 'bisection-fallback',
            note: 'Newton-Raphson failed, used bisection'
          };
        }
        
        // ========== 5. FINAL FALLBACK: MULTIPLE GUESSES ==========
        // Try multiple initial guesses (Excel's approach)
        const initialGuesses = [0.1, -0.1, 0.5, -0.5, 0.0, 0.25, 1.0, -0.99, 2.0];
        
        for (const guess of initialGuesses) {
          if (guess === initialGuess) continue; // Skip already tried
          
          const retryResult = calculateIRRNewtonOnly(cashFlows, guess, maxIterations, tolerance);
          if (retryResult.success) {
            return {
              ...retryResult,
              method: 'newton-retry',
              initialGuessUsed: guess
            };
          }
        }
        
        // ========== 6. ALL METHODS FAILED ==========
        return {
          success: false,
          message: `IRR calculation failed after ${maxIterations} iterations with multiple methods. Check cash flow pattern.`,
          iterations: maxIterations,
          cashFlowSummary: `${positiveFlows.length}+, ${negativeFlows.length}-, ${zeroFlows.length}0`
        };
      }
      // ========== HELPER FUNCTIONS ==========
      /**
       * Newton-Raphson only (no fallback) for retry attempts
       */
      function calculateIRRNewtonOnly(cashFlows, initialGuess, maxIterations, tolerance) {
        let irr = initialGuess;
        
        for (let iter = 0; iter < maxIterations; iter++) {
          let npv = 0;
          let derivative = 0;
          
          for (let t = 0; t < cashFlows.length; t++) {
            const cf = cashFlows[t];
            if (cf === 0) continue;
            
            const discountFactor = Math.pow(1 + irr, t);
            const pv = safeDivide(cf, discountFactor, 12);
            npv = safeAdd(npv, pv);
            
            if (t > 0 && cf !== 0) {
              const derivativeFactor = safeMultiply(
                -t,
                Math.pow(1 + irr, -(t + 1)),
                12
              );
              const derivativeTerm = safeMultiply(cf, derivativeFactor, 12);
              derivative = safeAdd(derivative, derivativeTerm);
            }
          }
          
          if (financialEquals(npv, 0, tolerance)) {
            return {
              success: true,
              irr: roundFinancial(irr, 8),
              iterations: iter + 1
            };
          }
          
          if (Math.abs(derivative) < 1e-15) break;
          
          const delta = safeDivide(npv, derivative, 12);
          irr = safeAdd(irr, -delta);
          
          // Bounds
          if (irr <= -0.9999) irr = -0.9999;
          else if (irr >= 10.0) irr = 10.0;
        }
        
        return { success: false };
      }
      /**
       * Bisection method with configurable bounds
       */
      function calculateIRRBisection(cashFlows, tolerance, minIRR = -0.9999, maxIRR = 10.0) {
        let lower = minIRR;
        let upper = maxIRR;
        const maxIterations = 100;
        
        // Check initial bounds
        const npvLower = calculateNPVAtRate(cashFlows, lower);
        const npvUpper = calculateNPVAtRate(cashFlows, upper);
        
        // If bounds have same sign, try to find crossing
        if (npvLower * npvUpper > 0) {
          // Search for valid bounds (Excel's approach)
          for (let i = 0; i < 50; i++) {
            const testRate = lower + (upper - lower) * i / 49;
            const npv = calculateNPVAtRate(cashFlows, testRate);
            
            if (npvLower * npv <= 0) {
              upper = testRate;
              break;
            }
          }
        }
        
        // Bisection loop
        for (let iter = 0; iter < maxIterations; iter++) {
          const mid = safeDivide(safeAdd(lower, upper), 2, 12);
          const npvMid = calculateNPVAtRate(cashFlows, mid);
          
          if (financialEquals(npvMid, 0, tolerance)) {
            return {
              success: true,
              irr: roundFinancial(mid, 8),
              iterations: iter + 1
            };
          }
          
          // Update bounds based on sign
          if (calculateNPVAtRate(cashFlows, lower) * npvMid < 0) {
            upper = mid;
          } else {
            lower = mid;
          }
          
          // Check if interval is sufficiently small
          if (financialEquals(upper, lower, 1e-12)) {
            return {
              success: financialEquals(npvMid, 0, tolerance * 100),
              irr: roundFinancial(mid, 8),
              iterations: iter + 1
            };
          }
        }
        
        return { success: false };
      }
      /**
       * Calculate NPV at given discount rate (reusable)
       */
      function calculateNPVAtRate(cashFlows, rate) {
        let npv = 0;
        for (let t = 0; t < cashFlows.length; t++) {
          const cf = cashFlows[t];
          if (cf === 0) continue;
          
          const discountFactor = Math.pow(1 + rate, t);
          const pv = safeDivide(cf, discountFactor, 12);
          npv = safeAdd(npv, pv);
        }
        return npv;
      }





      // ==================== XIRR/XNPV FUNCTIONS ====================
      /**
       * Parse date robustly (timezone-safe, Excel-compatible)
       * Returns Date object at noon UTC to avoid timezone issues
       */
      function parseInputDate(dateStr) {
        if (!dateStr) return null;
        
        // Remove any whitespace
        dateStr = dateStr.trim();
        
        // Try ISO format (YYYY-MM-DD)
        const isoMatch = dateStr.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (isoMatch) {
          const [_, year, month, day] = isoMatch;
          // Use UTC noon to avoid timezone issues
          const date = new Date(Date.UTC(
            parseInt(year), 
            parseInt(month) - 1, 
            parseInt(day),
            12, 0, 0, 0 // Noon UTC
          ));
          if (!isNaN(date.getTime())) return date;
        }
        
        // Try US format (MM/DD/YYYY)
        const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (usMatch) {
          const [_, month, day, year] = usMatch;
          const date = new Date(Date.UTC(
            parseInt(year), 
            parseInt(month) - 1, 
            parseInt(day),
            12, 0, 0, 0
          ));
          if (!isNaN(date.getTime())) return date;
        }
        
        // Try European format (DD.MM.YYYY or DD-MM-YYYY)
        const euMatch1 = dateStr.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
        if (euMatch1) {
          const [_, day, month, year] = euMatch1;
          const date = new Date(Date.UTC(
            parseInt(year), 
            parseInt(month) - 1, 
            parseInt(day),
            12, 0, 0, 0
          ));
          if (!isNaN(date.getTime())) return date;
        }
        
        const euMatch2 = dateStr.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
        if (euMatch2) {
          const [_, day, month, year] = euMatch2;
          const date = new Date(Date.UTC(
            parseInt(year), 
            parseInt(month) - 1, 
            parseInt(day),
            12, 0, 0, 0
          ));
          if (!isNaN(date.getTime())) return date;
        }
        
        // Fallback: try Date parsing with UTC
        try {
          const date = new Date(dateStr + 'T12:00:00Z');
          if (!isNaN(date.getTime())) return date;
        } catch (e) {
          // Continue to return null
        }
        
        return null;
      }

      /**
       * Calculate XNPV with financial precision (Excel-compatible)
       */
      function calculateXNPV(rate, cashFlows) {
        if (!cashFlows || cashFlows.length === 0) return 0;
        
        const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
        const baseDate = sorted[0].date;
        
        let xnpv = 0;
        
        for (const cf of sorted) {
          const daysDiff = Math.round((cf.date - baseDate) / (1000 * 60 * 60 * 24));
          const yearsDiff = daysDiff / 365.0;
          
          // ‚úÖ S·ª¨ D·ª§NG PRECISION FUNCTIONS
          const discountFactor = safeMultiply(
            1,  // Base multiplier
            Math.pow(1 + rate, yearsDiff),
            12  // Precision: 12 decimal places
          );
          
          const pv = safeDivide(cf.amount, discountFactor, 12);
          xnpv = safeAdd(xnpv, pv);
        }
        
        return roundFinancial(xnpv, 2);
      }

      /**
       * Newton-Raphson solver for XIRR with financial precision
       */
      function newtonRaphsonXIRR(sortedCFs, baseDate, initialGuess, tolerance) {
        const maxIterations = 100;
        let rate = initialGuess;
        
        for (let iter = 0; iter < maxIterations; iter++) {
          let npv = 0;
          let derivative = 0;
          
          for (const cf of sortedCFs) {
            const days = (cf.date - baseDate) / (1000 * 60 * 60 * 24);
            const years = days / 365.0;
            
            // ‚úÖ S·ª¨ D·ª§NG SAFE FUNCTIONS
            const discountFactor = safeMultiply(
              Math.pow(1 + rate, years), 
              1, 
              12
            );
            
            const discountedCF = safeDivide(cf.amount, discountFactor, 12);
            npv = safeAdd(npv, discountedCF);
            
            // Derivative calculation v·ªõi precision
            if (Math.abs(years) > 1e-12) {
              const derivativeTerm = safeDivide(
                safeMultiply(
                  safeMultiply(years, cf.amount, 12),
                  Math.pow(1 + rate, -(years + 1)),
                  12
                ),
                1,
                12
              );
              derivative = safeAdd(derivative, -derivativeTerm);
            }
          }
          
          // Convergence check v·ªõi financialEquals
          if (financialEquals(npv, 0, tolerance)) {
            return {
              success: true,
              xirr: roundFinancial(rate, 8), // 8 decimals for rates
              iterations: iter + 1
            };
          }
          
          // Prevent division by zero
          if (Math.abs(derivative) < 1e-15 || financialEquals(derivative, 0, 1e-15)) {
            break;
          }
          
          // Newton-Raphson update v·ªõi precision
          const delta = safeDivide(npv, derivative, 12);
          rate = safeAdd(rate, -delta);
          
          // Apply bounds v·ªõi rounding
          if (rate <= -0.9999) rate = -0.9999;
          if (rate >= 10.0) rate = 10.0;
          
          // Check for small updates
          if (Math.abs(delta) < tolerance || iter === maxIterations - 1) {
            const finalXNPV = calculateXNPV(rate, sortedCFs);
            if (financialEquals(finalXNPV, 0, tolerance)) {
              return {
                success: true,
                xirr: roundFinancial(rate, 8),
                iterations: iter + 1
              };
            }
          }
        }
        
        return { success: false };
      }

      /**
       * Bisection method with financial precision
       */
      function bisectionXIRR(sortedCFs, baseDate, tolerance) {
        let lower = -0.9999;
        let upper = 10.0;
        
        // Check bounds v·ªõi XNPV precision
        const npvLower = calculateXNPV(lower, sortedCFs);
        const npvUpper = calculateXNPV(upper, sortedCFs);
        
        if (npvLower * npvUpper > 0) {
          // Try to find better bounds
          for (let i = 0; i < 20; i++) {
            const testRate = lower + (upper - lower) * i / 19;
            const npv = calculateXNPV(testRate, sortedCFs);
            
            if (npvLower * npv <= 0) {
              upper = roundFinancial(testRate, 8);
              break;
            }
          }
        }
        
        // Bisection loop v·ªõi precision
        for (let iter = 0; iter < 100; iter++) {
          const mid = safeDivide(safeAdd(lower, upper), 2, 12);
          const npvMid = calculateXNPV(mid, sortedCFs);
          
          if (financialEquals(npvMid, 0, tolerance)) {
            return {
              success: true,
              xirr: roundFinancial(mid, 8),
              iterations: iter + 1
            };
          }
          
          if (calculateXNPV(lower, sortedCFs) * npvMid < 0) {
            upper = roundFinancial(mid, 12);
          } else {
            lower = roundFinancial(mid, 12);
          }
          
          // Check convergence
          if (financialEquals(upper, lower, 1e-12)) {
            return {
              success: financialEquals(npvMid, 0, tolerance * 10),
              xirr: roundFinancial(mid, 8),
              iterations: iter + 1
            };
          }
        }
        
        return { success: false };
      }

      /**
       * Calculate regular NPV v·ªõi precision
       */

      function calculateRegularNPV(cashFlows, discountRate) {
        if (!cashFlows || cashFlows.length === 0) return 0;
        
        const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
        let npv = 0;
        
        for (let i = 0; i < sorted.length; i++) {
          const discountFactor = safeMultiply(
            Math.pow(1 + discountRate, i),
            1,
            12
          );
          const pv = safeDivide(sorted[i].amount, discountFactor, 12);
          npv = safeAdd(npv, pv);
        }
        
        return roundFinancial(npv, 2);
      }

      /**
       * PRODUCTION-GRADE XIRR v·ªõi financial precision
       */
      function calculateXIRR(cashFlows, initialGuess = 0.1) {
        // Validate input
        if (!cashFlows || cashFlows.length < 2) {
          return {
            success: false,
            message: "Need at least 2 cash flows"
          };
        }

        // Validate cash flow signs
        const amounts = cashFlows.map(cf => cf.amount);
        const hasPositive = amounts.some(a => a > 0);
        const hasNegative = amounts.some(a => a < 0);
        
        if (!hasPositive || !hasNegative) {
          return {
            success: false,
            message: "Need both positive and negative cash flows"
          };
        }

        // Sort by date
        const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
        const baseDate = sorted[0].date;
        
        // T√≠nh tolerance d·ª±a tr√™n magnitude
        const totalMagnitude = sorted.reduce((sum, cf) => sum + Math.abs(cf.amount), 0);
        const tolerance = Math.max(1e-9, totalMagnitude * 1e-12);
        
        // Multiple initial guesses (Excel's approach)
        const initialGuesses = [
          roundFinancial(initialGuess, 8),
          roundFinancial(0.1, 8),
          roundFinancial(-0.1, 8),
          roundFinancial(0.5, 8),
          roundFinancial(-0.5, 8),
          roundFinancial(0.0, 8),
          roundFinancial(0.25, 8),
          roundFinancial(1.0, 8),
          roundFinancial(-0.99, 8),
          roundFinancial(2.0, 8)
        ];
        
        for (const guess of initialGuesses) {
          const result = newtonRaphsonXIRR(sorted, baseDate, guess, tolerance);
          if (result.success) {
            const xnpv = calculateXNPV(result.xirr, sorted);
            return {
              ...result,
              xnpv: roundFinancial(xnpv, 2),
              method: 'newton-raphson'
            };
          }
        }
        
        // Fallback to bisection
        const bisectionResult = bisectionXIRR(sorted, baseDate, tolerance);
        if (bisectionResult.success) {
          const xnpv = calculateXNPV(bisectionResult.xirr, sorted);
          return {
            ...bisectionResult,
            xnpv: roundFinancial(xnpv, 2),
            method: 'bisection'
          };
        }
        
        return {
          success: false,
          message: "XIRR did not converge. Check cash flow pattern or try different initial guess.",
          iterations: 100
        };
      }


      /**
       * Calculate regular IRR for comparison (annual periods)
       */
      function calculateRegularIRR(cashFlows) {
        if (!cashFlows || cashFlows.length < 2) {
          return { success: false, message: "Need at least 2 cash flows" };
        }
        
        const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
        const amounts = sorted.map(cf => cf.amount);
        return calculateIRR(amounts, 0.1);
      }

      /**
       * Format date for display (locale-aware)
       */
      function formatDate(date) {
        if (!date) return '';
        
        // Use UTC to avoid timezone shifts in display
        const utcDate = new Date(Date.UTC(
          date.getUTCFullYear(),
          date.getUTCMonth(),
          date.getUTCDate()
        ));
        
        return utcDate.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          timeZone: 'UTC'
        });
      }

      function renderXNPVXIRRCalculator() {
        return `
          <h2 class="calculator-title">‚ö° XNPV & XIRR Calculator (Professional)</h2>
          
          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Why XIRR/XNPV? The Real Deal Standard
            </div>
            <p class="explanation-text">
              <strong>Regular IRR/NPV = Academic.</strong> <strong>XIRR/XNPV = What PE funds actually use.</strong>
              Real cash flows don't arrive on "Year 1, Year 2" ‚Äî they happen on specific dates (Day 47, Q3 end, etc.).
              Every day changes discounting ‚áí Regular IRR can be off by <strong>50-150bps</strong> on large deals.
            </p>
            <p class="explanation-text">
              <strong>Use cases:</strong> Dividend recaps, bridge loans, irregular distributions, construction capex,
              preferred return waterfalls, carried interest calculations, refinancing analysis.
            </p>
            <div class="explanation-note">
              <strong>PE/IB Insight:</strong> If your model doesn't use XIRR/XNPV with exact dates, 
              it looks like an internship-level model. Funds calculate performance fees, promotes, 
              and waterfalls using XIRR down to the day.
            </div>
          </div>

          <!-- Scenario Selector -->
          <div style="background: var(--slate-50); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
            <h3 style="font-size: 1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
              üìã Choose Your Scenario
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem;">
              <button class="scenario-btn active" data-scenario="custom">
                ‚úçÔ∏è Custom<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Enter your cash flows</span>
              </button>
              <button class="scenario-btn" data-scenario="pe-investment">
                üíº PE Investment<br>
                <span style="font-size: 0.75rem; font-weight: normal;">LBO with dividend recap</span>
              </button>
              <button class="scenario-btn" data-scenario="real-estate">
                üè¢ Real Estate<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Construction + rent + sale</span>
              </button>
              <button class="scenario-btn" data-scenario="bridge-loan">
                üåâ Bridge Loan<br>
                <span style="font-size: 0.75rem; font-weight: normal;">45-day refinancing</span>
              </button>
            </div>
          </div>

          <!-- Cash Flow Input -->
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200); margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="font-size: 1rem; font-weight: 600; color: var(--slate-700);">
                üí∏ Cash Flows (Date-Specific)
              </h3>
              <button class="btn btn-primary" id="addCashFlowBtn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.875rem;">
                ‚ûï Add Cash Flow
              </button>
            </div>

            <div style="background: var(--blue-50); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem; border-left: 3px solid var(--blue-500);">
              <strong>üí° Pro Tip:</strong> Negative = Outflow (investment), Positive = Inflow (returns).
              Date format: <strong>YYYY-MM-DD</strong> or <strong>MM/DD/YYYY</strong>
            </div>

            <div id="cashFlowsContainer">
              <!-- Cash flows will be added here -->
            </div>

            <div style="margin-top: 1rem; padding: 1rem; background: var(--slate-50); border-radius: 0.5rem; font-size: 0.875rem;">
              <strong>Quick actions:</strong>
              <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="sortByDateBtn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.75rem;">
                  üìÖ Sort by Date
                </button>
                <button class="btn btn-danger" id="clearAllBtn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.75rem;">
                  üóëÔ∏è Clear All
                </button>
              </div>
            </div>
          </div>

          <!-- Discount Rate (for XNPV) -->
          <div class="form-grid" style="margin-bottom: 1.5rem;">
            <div class="form-group">
              <label class="form-label">üìä Discount Rate for XNPV (%)</label>
              <input type="number" id="xnpvDiscountRate" class="form-input" placeholder="10" step="0.1" value="10">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                Target return or WACC (e.g., 10% = 0.10)
              </div>
            </div>
          </div>

          <!-- Calculate Button -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <button class="btn btn-primary" id="calculateXNPV">
              üìä Calculate XNPV
            </button>
            <button class="btn btn-success" id="calculateXIRR">
              ‚ö° Calculate XIRR
            </button>
          </div>

          <!-- Results -->
          <div id="xnpvxirrResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50); margin-top: 2rem;">
            <!-- Results will be populated here -->
          </div>

          <!-- Comparison with Regular IRR/NPV -->
          <div id="comparisonSection" class="hidden" style="margin-top: 2rem;">
            <!-- Comparison will be populated here -->
          </div>
        `;
      }    
              
      function setupXNPVXIRRCalculator() {
        let cashFlows = [];
        let cashFlowIdCounter = 1;

        // Add initial cash flow
        addCashFlow();

        // Scenario buttons
        document.querySelectorAll('.scenario-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadScenario(btn.dataset.scenario);
          });
        });

        // Add cash flow button
        document.getElementById('addCashFlowBtn').addEventListener('click', () => {
          if (cashFlows.length < 50) {
            addCashFlow();
          } else {
            alert('Maximum 50 cash flows allowed');
          }
        });

        // Sort by date
        document.getElementById('sortByDateBtn').addEventListener('click', () => {
          cashFlows.sort((a, b) => {
            const dateA = parseInputDate(a.date);
            const dateB = parseInputDate(b.date);
            if (!dateA || !dateB) return 0;
            return dateA - dateB;
          });
          renderCashFlows();
        });

        // Clear all
        document.getElementById('clearAllBtn').addEventListener('click', () => {
          if (confirm('Clear all cash flows?')) {
            cashFlows = [];
            addCashFlow();
          }
        });

        // Calculate XNPV
        document.getElementById('calculateXNPV').addEventListener('click', () => {
          calculateAndDisplayXNPV();
        });

        // Calculate XIRR
        document.getElementById('calculateXIRR').addEventListener('click', () => {
          calculateAndDisplayXIRR();
        });

        function addCashFlow(date = '', amount = '') {
          cashFlows.push({
            id: cashFlowIdCounter++,
            date: date,
            amount: amount
          });
          renderCashFlows();
        }

        function removeCashFlow(id) {
          cashFlows = cashFlows.filter(cf => cf.id !== id);
          if (cashFlows.length === 0) {
            addCashFlow(); // Keep at least one
          }
          renderCashFlows();
        }

        function renderCashFlows() {
          const container = document.getElementById('cashFlowsContainer');
          
          if (cashFlows.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--slate-500);">No cash flows</p>';
            return;
          }

          container.innerHTML = cashFlows.map((cf, index) => `
            <div class="cash-flow-row" data-cf-id="${cf.id}" style="
              background: ${index % 2 === 0 ? 'var(--slate-50)' : 'var(--white)'};
              padding: 1rem;
              border-radius: 0.5rem;
              margin-bottom: 0.75rem;
              border: 1px solid var(--slate-200);
            ">
              <div style="display: grid; grid-template-columns: 50px 2fr 2fr auto; gap: 1rem; align-items: center;">
                <div style="font-weight: 700; font-size: 1.1rem; color: var(--slate-600); text-align: center;">
                  #${index + 1}
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-input cf-date" value="${cf.date}" 
                        placeholder="YYYY-MM-DD" style="font-size: 0.875rem;">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Amount ($)</label>
                  <input type="number" class="form-input cf-amount" value="${cf.amount}" 
                        placeholder="e.g., -100000 or 50000" step="1000">
                </div>

                <button class="remove-cf-btn" data-cf-id="${cf.id}" style="
                  background: var(--red-500);
                  color: white;
                  border: none;
                  border-radius: 0.375rem;
                  padding: 0.75rem;
                  cursor: pointer;
                  font-weight: 600;
                  font-size: 1.2rem;
                  line-height: 1;
                  transition: all 0.2s;
                " title="Remove">
                  ‚úï
                </button>
              </div>
            </div>
          `).join('');

          // Attach event listeners
          document.querySelectorAll('.remove-cf-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const cfId = parseInt(e.target.dataset.cfId);
              removeCashFlow(cfId);
            });
          });

          document.querySelectorAll('.cash-flow-row').forEach(row => {
            const cfId = parseInt(row.dataset.cfId);
            const cf = cashFlows.find(c => c.id === cfId);

            row.querySelector('.cf-date').addEventListener('change', (e) => {
              cf.date = e.target.value;
            });

            row.querySelector('.cf-amount').addEventListener('change', (e) => {
              cf.amount = e.target.value;
            });
          });
        }

        function loadScenario(scenario) {
          cashFlows = [];
          cashFlowIdCounter = 1;

          const today = new Date();
          const formatDate = (date) => date.toISOString().split('T')[0];

          switch (scenario) {
            case 'pe-investment':
              // Realistic PE deal: Investment ‚Üí Dividend Recap ‚Üí Exit
              addCashFlow(formatDate(today), '-50000000'); // $50M investment today
              
              const recap = new Date(today);
              recap.setMonth(recap.getMonth() + 18);
              addCashFlow(formatDate(recap), '15000000'); // $15M dividend recap after 18mo
              
              const exit = new Date(today);
              exit.setFullYear(exit.getFullYear() + 4);
              exit.setMonth(exit.getMonth() + 3);
              addCashFlow(formatDate(exit), '95000000'); // $95M exit after 4.25 years
              break;

            case 'real-estate':
              // Real estate development
              const landPurchase = new Date(today);
              addCashFlow(formatDate(landPurchase), '-10000000'); // Land
              
              // Construction capex over 18 months
              for (let i = 1; i <= 6; i++) {
                const capexDate = new Date(today);
                capexDate.setMonth(capexDate.getMonth() + i * 3);
                addCashFlow(formatDate(capexDate), '-3000000'); // Quarterly capex
              }
              
              // Rental income for 3 years
              for (let i = 24; i <= 60; i += 3) {
                const rentDate = new Date(today);
                rentDate.setMonth(rentDate.getMonth() + i);
                addCashFlow(formatDate(rentDate), '500000'); // Quarterly rent
              }
              
              // Sale after 5 years
              const saleDate = new Date(today);
              saleDate.setFullYear(saleDate.getFullYear() + 5);
              addCashFlow(formatDate(saleDate), '35000000'); // Property sale
              break;

            case 'bridge-loan':
              // 45-day bridge financing
              addCashFlow(formatDate(today), '-5000000'); // Lend $5M today
              
              const repay = new Date(today);
              repay.setDate(repay.getDate() + 45);
              addCashFlow(formatDate(repay), '5075000'); // Repay with interest after 45 days
              break;

            default: // custom
              addCashFlow();
          }
        }

        function calculateAndDisplayXNPV() {
          // Validate and parse cash flows
          const parsedCFs = [];
          for (const cf of cashFlows) {
            const date = parseInputDate(cf.date);
            const amount = parseFloat(cf.amount);
            
            if (!date) {
              alert(`Invalid date: ${cf.date}`);
              return;
            }
            if (isNaN(amount)) {
              alert(`Invalid amount: ${cf.amount}`);
              return;
            }
            
            parsedCFs.push({ date, amount });
          }

          if (parsedCFs.length < 2) {
            alert('Need at least 2 cash flows');
            return;
          }

          const discountRate = parseFloat(document.getElementById('xnpvDiscountRate').value) / 100;
          if (isNaN(discountRate)) {
            alert('Invalid discount rate');
            return;
          }

          // Calculate XNPV
          const xnpv = calculateXNPV(discountRate, parsedCFs);
          
          // Calculate regular NPV for comparison (assuming annual periods)
          const regularNPV = calculateRegularNPV(parsedCFs, discountRate);
          
          displayXNPVResults(xnpv, regularNPV, discountRate, parsedCFs);
        }

        function calculateAndDisplayXIRR() {
          // Validate and parse
          const parsedCFs = [];
          for (const cf of cashFlows) {
            const date = parseInputDate(cf.date);
            const amount = parseFloat(cf.amount);
            
            if (!date) {
              alert(`Invalid date: ${cf.date}`);
              return;
            }
            if (isNaN(amount)) {
              alert(`Invalid amount: ${cf.amount}`);
              return;
            }
            
            parsedCFs.push({ date, amount });
          }

          if (parsedCFs.length < 2) {
            alert('Need at least 2 cash flows');
            return;
          }

          // Calculate XIRR
          const xirrResult = calculateXIRR(parsedCFs, 0.1);
          
          // Calculate regular IRR for comparison
          const regularIRR = calculateRegularIRR(parsedCFs);
          
          displayXIRRResults(xirrResult, regularIRR, parsedCFs);
        }



        function calculateRegularNPV(parsedCFs, rate) {
          // S·ª¨ D·ª§NG safe functions:
          const sorted = [...parsedCFs].sort((a, b) => a.date - b.date);
          let npv = 0;
          
          for (let i = 0; i < sorted.length; i++) {
            const discountFactor = safeMultiply(
              1,
              Math.pow(1 + rate, i), 
              12
            );
            const pv = safeDivide(sorted[i].amount, discountFactor, 12);
            npv = safeAdd(npv, pv);
          }
          
          return roundFinancial(npv, 2);
        }        

        function calculateRegularIRR(parsedCFs) {
          // Use simplified IRR assuming evenly spaced periods
          const sorted = [...parsedCFs].sort((a, b) => a.date - b.date);
          const amounts = sorted.map(cf => cf.amount);
          
          const result = calculateIRR(amounts, sorted[0].amount, 0.1);
          return result;
        }


        function displayXNPVResults(xnpv, regularNPV, rate, cashFlows) {
          const resultsDiv = document.getElementById('xnpvxirrResults');
          const comparisonDiv = document.getElementById('comparisonSection');
          
          // ========== FUND-GRADE PRECISION CALCULATIONS ==========
          // S·ª≠ d·ª•ng roundFinancial ƒë·ªÉ lo·∫°i b·ªè floating point errors
          const precisionDifference = roundFinancial(xnpv - regularNPV, 2);
          
          // X·ª≠ l√Ω edge case: regularNPV g·∫ßn b·∫±ng 0
          const absRegularNPV = Math.abs(regularNPV);
          let percentDiff = 0;
          let percentDiffDisplay = '0%';
          let showPercentDiff = true;
          
          if (absRegularNPV > 1e-6) { // Threshold: $0.000001
            const rawPercent = (precisionDifference / absRegularNPV) * 100;
            percentDiff = roundFinancial(rawPercent, 2);
            percentDiffDisplay = `${percentDiff >= 0 ? '+' : ''}${Math.abs(percentDiff).toFixed(1)}%`;
          } else {
            // NPV qu√° nh·ªè, kh√¥ng t√≠nh % diff
            showPercentDiff = false;
            percentDiffDisplay = 'N/A (NPV ‚âà 0)';
          }
          
          // ========== PROFESSIONAL FORMATTING ==========
          // Format t·ª± ƒë·ªông ch·ªçn ƒë∆°n v·ªã (K/M/B)
          const formatFinancialValue = (value) => {
            const absValue = Math.abs(value);
            
            if (absValue >= 1e12) { // Trillion
              return `${value >= 0 ? '+' : '-'}$${(absValue / 1e12).toFixed(3)}T`;
            } else if (absValue >= 1e9) { // Billion
              return `${value >= 0 ? '+' : '-'}$${(absValue / 1e9).toFixed(3)}B`;
            } else if (absValue >= 1e6) { // Million
              return `${value >= 0 ? '+' : '-'}$${(absValue / 1e6).toFixed(3)}M`;
            } else if (absValue >= 1e3) { // Thousand
              return `${value >= 0 ? '+' : '-'}$${(absValue / 1e3).toFixed(1)}K`;
            } else {
              return `${value >= 0 ? '+' : '-'}$${absValue.toFixed(2)}`;
            }
          };
          
          const xnpvFormatted = formatFinancialValue(xnpv);
          const regularNPVFormatted = formatFinancialValue(regularNPV);
          const differenceFormatted = formatFinancialValue(precisionDifference);
          
          // ========== CASH FLOW SIGN VALIDATION ==========
          // Ki·ªÉm tra pattern cash flow (fund-grade requirement)
          let cashFlowPattern = 'Valid';
          let cashFlowPatternColor = 'var(--green-600)';
          let cashFlowPatternIcon = '‚úÖ';
          
          const amounts = cashFlows.map(cf => cf.amount);
          const positiveFlows = amounts.filter(a => a > 0);
          const negativeFlows = amounts.filter(a => a < 0);
          
          if (positiveFlows.length === 0 || negativeFlows.length === 0) {
            cashFlowPattern = 'Invalid: Need both + and - cash flows';
            cashFlowPatternColor = 'var(--red-600)';
            cashFlowPatternIcon = '‚ö†Ô∏è';
          } else if (amounts[0] >= 0) {
            // Warning: First cash flow should ideally be negative (investment)
            cashFlowPattern = 'Warning: First CF should be negative (investment)';
            cashFlowPatternColor = 'var(--orange-600)';
            cashFlowPatternIcon = '‚ö†Ô∏è';
          }
          
          // ========== RENDER RESULTS ==========
          resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--indigo-800);">
              üìä XNPV Results (Finance-Grade)
            </h3>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: linear-gradient(135deg, var(--indigo-100), var(--indigo-200));
                          padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid var(--indigo-400);">
                <div style="font-size: 0.875rem; color: var(--indigo-700); margin-bottom: 0.5rem; font-weight: 600;">
                  XNPV (Exact Dates)
                </div>
                <div style="font-size: 2rem; font-weight: 800; color: ${xnpv >= 0 ? 'var(--green-700)' : 'var(--red-700)'};">
                  ${xnpvFormatted}
                </div>
              </div>

              <div style="background: var(--slate-100); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">
                  Discount Rate
                </div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--slate-700);">
                  ${formatPercent(rate, 2)}
                </div>
              </div>

              <div style="background: var(--slate-100); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">
                  Cash Flow Pattern
                </div>
                <div style="font-size: 1.25rem; font-weight: 600; color: ${cashFlowPatternColor}; margin-top: 0.5rem;">
                  ${cashFlowPatternIcon} ${cashFlowPattern}
                </div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${positiveFlows.length}+ / ${negativeFlows.length}- flows
                </div>
              </div>
            </div>

            <!-- Data Quality Check -->
            <div style="background: var(--blue-50); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--blue-500);">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M8 13A5 5 0 1 1 8 3a5 5 0 0 1 0 10zm0-1A4 4 0 1 0 8 4a4 4 0 0 0 0 8z"/>
                  <path d="M9.5 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                </svg>
                <strong style="color: var(--blue-800);">Data Quality & Precision</strong>
              </div>
              <div style="font-size: 0.875rem; color: var(--blue-700);">
                ‚Ä¢ XNPV precision: ${formatCurrency(xnpv)}<br>
                ‚Ä¢ Regular NPV precision: ${formatCurrency(regularNPV)}<br>
                ‚Ä¢ Difference: ${formatCurrency(precisionDifference)}<br>
                ‚Ä¢ Tolerance threshold: $${(1e-6).toFixed(6)}
              </div>
            </div>

            ${renderCashFlowTimeline(cashFlows)}
          `;

          // ========== COMPARISON SECTION ==========
          const impactAnalysis = getImpactAnalysis(precisionDifference, percentDiff, showPercentDiff);
          
          comparisonDiv.innerHTML = `
            <div style="background: linear-gradient(135deg, var(--orange-50), var(--red-50));
                        padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--orange-500);">
              <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--orange-900); margin-bottom: 1rem;">
                ‚ö†Ô∏è XNPV vs Regular NPV Comparison (Finance-Grade Analysis)
              </h4>

              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center; border: 1px solid var(--indigo-200);">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">XNPV (Exact Dates)</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                    ${xnpvFormatted}
                  </div>
                  <div style="font-size: 0.7rem; color: var(--slate-500); margin-top: 0.25rem;">Professional standard</div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center; border: 1px solid var(--slate-200);">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">NPV (Annual)</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--slate-600);">
                    ${regularNPVFormatted}
                  </div>
                  <div style="font-size: 0.7rem; color: var(--slate-500); margin-top: 0.25rem;">Academic/simple</div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center; border: 1px solid ${precisionDifference >= 0 ? 'var(--green-200)' : 'var(--red-200)'}">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">Difference</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: ${precisionDifference >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                    ${differenceFormatted}
                  </div>
                  <div style="font-size: 0.75rem; color: ${precisionDifference >= 0 ? 'var(--green-600)' : 'var(--red-600)'}">
                    ${showPercentDiff ? `(${percentDiffDisplay})` : percentDiffDisplay}
                  </div>
                </div>
              </div>

              <div style="background: var(--orange-50); padding: 1.25rem; border-radius: 0.5rem; margin-top: 1rem; font-size: 0.875rem; line-height: 1.6;">
                <strong>üî• ${impactAnalysis.title}</strong><br>
                ${impactAnalysis.description}
                <br><br>
                <strong>üìà Deal Impact Assessment:</strong><br>
                ${impactAnalysis.dealImpact}
              </div>

              <!-- Decision Framework -->
              <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: 0.5rem; border: 1px solid var(--slate-200);">
                <div style="font-weight: 600; color: var(--slate-700); margin-bottom: 0.5rem;">üí° Finance Decision Framework:</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div style="background: var(--indigo-50); padding: 0.75rem; border-radius: 0.375rem;">
                    <strong style="color: var(--indigo-700);">Use XNPV when (Professional):</strong><br>
                    ‚Ä¢ Real deals with specific dates<br>
                    ‚Ä¢ PE/VC fund performance & carry calculations<br>
                    ‚Ä¢ Real estate development & construction draws<br>
                    ‚Ä¢ Bridge/short-term financing<br>
                    ‚Ä¢ Dividend recaps & waterfalls<br>
                    ‚Ä¢ Project finance with drawdown schedules
                  </div>
                  <div style="background: var(--slate-100); padding: 0.75rem; border-radius: 0.375rem;">
                    <strong style="color: var(--slate-700);">Use NPV when (Simplified):</strong><br>
                    ‚Ä¢ Academic exercises & classroom models<br>
                    ‚Ä¢ Quarterly/annual planning (not day-specific)<br>
                    ‚Ä¢ Back-of-envelope estimates<br>
                    ‚Ä¢ Standard bond pricing (regular coupons)<br>
                    ‚Ä¢ Simple DCF models for screening<br>
                    ‚Ä¢ Early-stage opportunity analysis
                  </div>
                </div>
                
                <!-- Decision Rule -->
                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50); border-radius: 0.375rem; border-left: 3px solid var(--green-500);">
                  <strong style="color: var(--green-800);">üìã Fund Decision Rule:</strong><br>
                  <span style="font-size: 0.8rem; color: var(--green-700);">
                    If |XNPV - NPV| > ${formatCurrency(100000)} <strong>OR</strong> |% diff| > 5% ‚Üí 
                    <strong>Use XNPV for final decision</strong> (material difference)
                  </span>
                </div>
              </div>
            </div>
          `;

          resultsDiv.classList.remove('hidden');
          comparisonDiv.classList.remove('hidden');
          
          // Save state
          setTimeout(() => {
            StorageManager.saveCalculatorState('xnpv-xirr');
          }, 100);
        }

        // ========== HELPER FUNCTIONS ==========
        /**
         * Analyze impact for professional reporting
         */
        function getImpactAnalysis(difference, percentDiff, showPercentDiff) {
          const absDifference = Math.abs(difference);
          const absPercentDiff = Math.abs(percentDiff);
          
          if (!showPercentDiff) {
            return {
              title: "Critical: NPV ‚âà 0, XNPV Provides Real Value",
              description: `Regular NPV is effectively zero (below materiality threshold), but XNPV shows ${difference >= 0 ? 'positive' : 'negative'} value of ${formatCurrency(difference)}.`,
              dealImpact: `This could completely change deal evaluation. Regular NPV suggests "break-even" while XNPV indicates ${difference >= 0 ? 'a GO decision' : 'a NO GO decision'}.`
            };
          }
          
          if (absPercentDiff > 10) {
            return {
              title: "Material Difference (>10%) - Regular NPV is Misleading",
              description: `Regular NPV is off by <strong>${absPercentDiff.toFixed(1)}%</strong> ‚Äî this level of difference would require disclosure in investment committee memos and could change hurdle rate analysis.`,
              dealImpact: `Using regular NPV could lead to ${difference >= 0 ? 'under-valuation and missed opportunities' : 'over-valuation and poor investment decisions'}. At deal sizes >$10M, this represents ${formatCurrency(absDifference)} in potential ${difference >= 0 ? 'missed value' : 'value destruction'}.`
            };
          } else if (absPercentDiff > 5) {
            return {
              title: "Significant Difference (5-10%) - Professional Models Required",
              description: `Difference of <strong>${absPercentDiff.toFixed(1)}%</strong> is material for institutional investing. Most funds require XNPV for any difference >5%.`,
              dealImpact: `At typical fund sizes, this ${absPercentDiff.toFixed(1)}% difference could impact carried interest calculations by ~${(absPercentDiff * 0.2).toFixed(1)}% of total gains.`
            };
          } else if (absPercentDiff > 2) {
            return {
              title: "Noticeable Difference (2-5%) - Precision Matters",
              description: `Difference of <strong>${absPercentDiff.toFixed(1)}%</strong>, while not deal-breaking, demonstrates why professional models use exact dates.`,
              dealImpact: `In competitive processes, this level of precision could be the difference between winning and losing a deal.`
            };
          } else {
            return {
              title: "Minimal Difference (<2%) - Both Methods Comparable",
              description: `Difference of <strong>${absPercentDiff.toFixed(1)}%</strong> is within acceptable tolerance for most screening purposes.`,
              dealImpact: `For this specific cash flow pattern, simplified NPV provides reasonable approximation. However, still use XNPV for final documentation.`
            };
          }
        }

        /**
         * Format large financial values with automatic unit selection
         * Fund-grade: K/M/B/T with appropriate decimals
         */
        function formatLargeFinancial(value) {
          const absValue = Math.abs(value);
          
          if (absValue >= 1e12) { // Trillion
            return `${value >= 0 ? '+' : '-'}$${(absValue / 1e12).toFixed(3)}T`;
          } else if (absValue >= 1e9) { // Billion
            return `${value >= 0 ? '+' : '-'}$${(absValue / 1e9).toFixed(3)}B`;
          } else if (absValue >= 1e6) { // Million
            return `${value >= 0 ? '+' : '-'}$${(absValue / 1e6).toFixed(3)}M`;
          } else if (absValue >= 1e3) { // Thousand
            return `${value >= 0 ? '+' : '-'}$${(absValue / 1e3).toFixed(1)}K`;
          } else {
            return `${value >= 0 ? '+' : '-'}$${absValue.toFixed(2)}`;
          }
        }



        function displayXIRRResults(xirrResult, regularIRR, cashFlows) {
          const resultsDiv = document.getElementById('xnpvxirrResults');
          const comparisonDiv = document.getElementById('comparisonSection');
          
          if (!xirrResult.success) {
            resultsDiv.innerHTML = `
              <div style="background: var(--red-50); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--red-800); margin-bottom: 0.75rem;">
                  XIRR Calculation Failed
                </h4>
                <p style="color: var(--red-700); margin-bottom: 1rem;">
                  ${xirrResult.message}
                </p>
                <div style="font-size: 0.875rem; color: var(--slate-600);">
                  Common issues:<br>
                  ‚Ä¢ All cash flows have same sign<br>
                  ‚Ä¢ Extreme/unrealistic cash flow patterns<br>
                  ‚Ä¢ Date parsing errors
                </div>
              </div>
            `;
            resultsDiv.classList.remove('hidden');
            return;
          }

          const xirr = xirrResult.xirr;
          const annualizedReturn = roundFinancial((Math.pow(1 + xirr, 1) - 1) * 100, 2);
          
          // Calculate difference vs regular IRR v·ªõi precision
          let regularIRRValue = 0;
          let regularIRRAnnual = 0;
          let difference = 0;
          let percentDiff = 0;
          
          if (regularIRR.success) {
            regularIRRValue = roundFinancial(regularIRR.irr, 8);
            regularIRRAnnual = roundFinancial(regularIRR.irr * 100, 2);
            difference = roundFinancial(annualizedReturn - regularIRRAnnual, 2);
            percentDiff = regularIRRAnnual !== 0 ? roundFinancial((difference / Math.abs(regularIRRAnnual)) * 100, 2) : 0;
          }

          // T√≠nh time-weighted return v·ªõi precision
          const timeWeightedReturn = roundFinancial((Math.pow(1 + xirr, 365) - 1) * 100, 0);
          
          resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--emerald-800);">
              ‚ö° XIRR Results (Precision-Enhanced)
            </h3>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: linear-gradient(135deg, var(--emerald-100), var(--green-200));
                          padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid var(--emerald-400);">
                <div style="font-size: 0.875rem; color: var(--emerald-700); margin-bottom: 0.5rem; font-weight: 600;">
                  XIRR (Exact Dates)
                </div>
                <div style="font-size: 2.5rem; font-weight: 800; color: ${annualizedReturn >= 0 ? 'var(--emerald-700)' : 'var(--red-700)'};">
                  ${annualizedReturn >= 0 ? '+' : ''}${formatPercent(annualizedReturn/100, 2)}
                </div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${xirrResult.iterations} iterations ‚Ä¢ ${xirrResult.method || 'newton-raphson'}
                </div>
              </div>

              <div style="background: var(--slate-100); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">
                  XNPV @ XIRR
                </div>
                <div style="font-size: 2rem; font-weight: 800; color: ${financialEquals(xirrResult.xnpv, 0, 1e-6) ? 'var(--green-700)' : 'var(--slate-700)'}">
                  ${financialEquals(xirrResult.xnpv, 0, 1e-6) ? '‚úì $0.00' : formatCurrency(xirrResult.xnpv)}
                </div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Convergence check
                </div>
              </div>

              <div style="background: var(--slate-100); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">
                  Cash Flow Period
                </div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--slate-700);">
                  ${calculateHoldingPeriod(cashFlows)}
                </div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Days invested
                </div>
              </div>
            </div>

            <!-- Precision Info Box -->
            <div style="background: var(--blue-50); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--blue-500);">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M8 13A5 5 0 1 1 8 3a5 5 0 0 1 0 10zm0-1A4 4 0 1 0 8 4a4 4 0 0 0 0 8z"/>
                  <path d="M9.5 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                </svg>
                <strong style="color: var(--blue-800);">Precision Information</strong>
              </div>
              <div style="font-size: 0.875rem; color: var(--blue-700);">
                ‚Ä¢ IRR precision: ${(xirr * 100).toFixed(8)}% (8 decimal places)<br>
                ‚Ä¢ XNPV at IRR: ${formatCurrency(xirrResult.xnpv)}<br>
                ‚Ä¢ Tolerance used: ${(1e-9).toExponential()}<br>
                ‚Ä¢ Method: ${xirrResult.method || 'newton-raphson'}
              </div>
            </div>

            ${renderCashFlowTimeline(cashFlows, xirr)}
          `;

          comparisonDiv.innerHTML = `
            <div style="background: linear-gradient(135deg, var(--purple-50), var(--indigo-50));
                        padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--purple-500);">
              <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--purple-900); margin-bottom: 1rem;">
                ‚ö° XIRR vs Regular IRR Comparison
              </h4>

              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">XIRR (Exact)</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--emerald-700);">
                    ${formatPercent(annualizedReturn/100, 2)}
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">IRR (Annual)</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--slate-600);">
                    ${regularIRR.success ? formatPercent(regularIRRAnnual/100, 2) : 'N/A'}
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Difference</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: ${difference >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                    ${regularIRR.success ? `${difference >= 0 ? '+' : ''}${formatPercent(Math.abs(difference)/100, 2)}` : 'N/A'}
                    <div style="font-size: 0.75rem; color: ${difference >= 0 ? 'var(--green-600)' : 'var(--red-600)'}">
                      ${regularIRR.success ? `${Math.abs(percentDiff).toFixed(1)}% vs regular` : ''}
                    </div>
                  </div>
                </div>
              </div>

              <div style="background: var(--purple-50); padding: 1.25rem; border-radius: 0.5rem; margin-top: 1rem; font-size: 0.875rem; line-height: 1.6;">
                <strong>üéØ Why XIRR is the professional standard:</strong><br>
                ${
                  Math.abs(difference) > 50 
                    ? `Regular IRR is off by <strong>${Math.abs(difference).toFixed(1)} bps</strong> ‚Äî in PE/VC, this determines whether you hit your hurdle rate and earn carry.`
                    : Math.abs(difference) > 20
                    ? `Difference of <strong>${Math.abs(difference).toFixed(1)} bps</strong> could mean millions in performance fees on a large fund.`
                    : `Even a ${Math.abs(difference).toFixed(1)} bps difference matters for performance benchmarking in institutional investing.`
                }
                <br><br>
                <strong>üìä Fund performance implications:</strong>
                ${
                  annualizedReturn >= 8 && annualizedReturn < 20
                    ? `This <strong>${formatPercent(annualizedReturn/100, 1)} XIRR</strong> clears the typical 8% preferred return hurdle. LPs get their pref, then GP gets ${formatPercent(Math.max(0, (annualizedReturn - 8) * 0.2)/100, 1)} in carried interest.`
                    : annualizedReturn >= 20
                    ? `Exceptional <strong>${formatPercent(annualizedReturn/100, 1)} XIRR</strong>! GP carry would be 20% of ${formatPercent((annualizedReturn - 8)/100, 1)} = ${formatPercent(((annualizedReturn - 8) * 0.2)/100, 1)} of total gains.`
                    : `At <strong>${formatPercent(annualizedReturn/100, 1)} XIRR</strong>, GP doesn't earn carry (below 8% hurdle).`
                }
              </div>

              <!-- XIRR Sensitivity Analysis -->
              <div style="margin-top: 1.5rem; padding: 1.5rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                <h5 style="font-size: 1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
                  üî¨ XIRR Sensitivity Analysis
                </h5>
                ${renderXIRRSensitivity(cashFlows, xirr)}
              </div>

              <!-- Professional Insights -->
              <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, var(--blue-50), var(--cyan-50));
                          border-radius: 0.75rem; border-left: 4px solid var(--blue-600);">
                <h5 style="font-size: 1rem; font-weight: 700; color: var(--blue-900); margin-bottom: 0.75rem;">
                  üíº Professional Insights
                </h5>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                  <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;">
                    <strong style="color: var(--blue-700); display: block; margin-bottom: 0.5rem;">PE/VC Funds</strong>
                    <div style="font-size: 0.75rem; line-height: 1.4;">
                      ‚Ä¢ XIRR determines carry (typically 20% above 8% pref)<br>
                      ‚Ä¢ Quarterly performance reporting to LPs<br>
                      ‚Ä¢ Waterfall calculations<br>
                      ‚Ä¢ TVPI calculation component
                    </div>
                  </div>
                  
                  <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;">
                    <strong style="color: var(--green-700); display: block; margin-bottom: 0.5rem;">Real Estate</strong>
                    <div style="font-size: 0.75rem; line-height: 1.4;">
                      ‚Ä¢ Equity multiple vs IRR analysis<br>
                      ‚Ä¢ Construction draw schedule impact<br>
                      ‚Ä¢ Refinancing timing optimization<br>
                      ‚Ä¢ Lease commencement dates
                    </div>
                  </div>
                  
                  <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;">
                    <strong style="color: var(--purple-700); display: block; margin-bottom: 0.5rem;">Project Finance</strong>
                    <div style="font-size: 0.75rem; line-height: 1.4;">
                      ‚Ä¢ Loan drawdown/repayment timing<br>
                      ‚Ä¢ Revenue commencement dates<br>
                      ‚Ä¢ Debt service coverage ratios<br>
                      ‚Ä¢ Refinancing options analysis
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          resultsDiv.classList.remove('hidden');
          comparisonDiv.classList.remove('hidden');
          
          // Save state
          setTimeout(() => {
            StorageManager.saveCalculatorState('xnpv-xirr');
          }, 100);
        }

        function renderCashFlowTimeline(cashFlows, xirr = null) {
          const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
          const startDate = sorted[0].date;
          const endDate = sorted[sorted.length - 1].date;
          const totalDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
          
          return `
            <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--slate-200); margin-bottom: 1.5rem;">
              <h4 style="font-size: 1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
                üìÖ Cash Flow Timeline
              </h4>             
              <div style="position: relative; height: 40px; background: var(--slate-100); border-radius: 0.5rem; margin-bottom: 1rem; overflow: hidden;">
                ${sorted.map((cf, index) => {
                  const daysFromStart = (cf.date - startDate) / (1000 * 60 * 60 * 24);
                  const position = (daysFromStart / totalDays) * 100;
                  const isNegative = cf.amount < 0;
                  
                  return `
                    <div style="position: absolute; left: ${position}%; top: 50%; transform: translate(-50%, -50%);">
                      <div style="width: 12px; height: 12px; border-radius: 50%; 
                                  background: ${isNegative ? 'var(--red-500)' : 'var(--green-500)'};
                                  border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"
                            title="${formatDate(cf.date)}: $${(cf.amount / 1000).toFixed(0)}K">
                      </div>
                      <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); 
                                  font-size: 0.7rem; white-space: nowrap; color: var(--slate-600);">
                        ${formatDate(cf.date).split(' ')[0]}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              
              <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">
                <div>${formatDate(startDate)}</div>
                <div>${formatDate(endDate)}</div>
              </div>
              
              <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--red-500); border: 2px solid white;"></div>
                  <span style="font-size: 0.75rem; color: var(--slate-600);">Outflow (Investment)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--green-500); border: 2px solid white;"></div>
                  <span style="font-size: 0.75rem; color: var(--slate-600);">Inflow (Return)</span>
                </div>
              </div>
            </div>
          `;
        }

        function renderXIRRSensitivity(cashFlows, baseXIRR) {
          // Test how XIRR changes with timing shifts
          const scenarios = [
            { label: 'Exit 30 days later', daysShift: 30 },
            { label: 'Investment 15 days earlier', daysShift: -15 },
            { label: 'Dividend 45 days delay', daysShift: 45 },
          ];
          
          const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
          const results = [];
          
          for (const scenario of scenarios) {
            const modifiedCFs = sorted.map((cf, index) => {
              const cfCopy = { ...cf };
              
              // LOGIC FIXED: Ph√¢n bi·ªát d√≤ng ti·ªÅn c·∫ßn thay ƒë·ªïi
              const isInvestmentScenario = scenario.label.includes("Investment");
              const isExitScenario = scenario.label.includes("Exit");
              const isDividendScenario = scenario.label.includes("Dividend");
              
              let shouldShift = false;
              
              if (isInvestmentScenario) {
                // D·ªãch chuy·ªÉn ng√†y cho D√íNG TI·ªÄN √ÇM (ƒë·∫ßu t∆∞)
                shouldShift = cf.amount < 0;
              } else if (isExitScenario) {
                // D·ªãch chuy·ªÉn ng√†y cho D√íNG TI·ªÄN D∆Ø∆†NG L·ªöN NH·∫§T (tho√°t v·ªën)
                shouldShift = cf.amount > 0;
              } else if (isDividendScenario) {
                // D·ªãch chuy·ªÉn ng√†y cho T·∫§T C·∫¢ d√≤ng ti·ªÅn d∆∞∆°ng TR·ª™ d√≤ng tho√°t v·ªën
                // (c·ªï t·ª©c th∆∞·ªùng l√† c√°c kho·∫£n nh·ªè ƒë·ªãnh k·ª≥)
                shouldShift = cf.amount > 0 && index !== sorted.length - 1; // Gi·∫£ s·ª≠ d√≤ng tho√°t l√† cu·ªëi c√πng
              }
              
              if (shouldShift) {
                cfCopy.date = new Date(cf.date);
                cfCopy.date.setDate(cfCopy.date.getDate() + scenario.daysShift);
              }
              return cfCopy;
            });
            
            const result = calculateXIRR(modifiedCFs, baseXIRR);
            if (result.success) {
              results.push({
                scenario: scenario.label,
                xirr: result.xirr,
                annualized: (Math.pow(1 + result.xirr, 1) - 1) * 100,
                change: ((result.xirr - baseXIRR) / baseXIRR) * 100,
                daysShift: scenario.daysShift,
              });
            }
          }
          
          if (results.length === 0) return '<p style="color: var(--slate-600); text-align: center;">Sensitivity analysis not available</p>';
          
          return `
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                <thead>
                  <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Scenario</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">New XIRR</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Annualized</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Change</th>
                  </tr>
                </thead>
                <tbody>
                  ${results.map(r => `
                    <tr style="border-bottom: 1px solid var(--slate-200);">
                      <td style="padding: 0.75rem;">
                        ${r.scenario}
                        <br>
                        <small style="color: var(--slate-500); font-size: 0.75rem;">
                          ${r.daysShift > 0 ? `+${r.daysShift} days` : `${r.daysShift} days`}
                        </small>
                      </td>
                      <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: ${r.xirr >= baseXIRR ? 'var(--green-700)' : 'var(--red-700)'}">
                        ${(r.xirr * 100).toFixed(2)}%
                      </td>
                      <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                        ${r.annualized.toFixed(2)}%
                      </td>
                      <td style="padding: 0.75rem; text-align: right; font-weight: 700; color: ${r.change >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                        ${r.change >= 0 ? '+' : ''}${r.change.toFixed(2)}%
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 1rem; padding: 1rem; background: var(--purple-50); border-radius: 0.5rem; font-size: 0.75rem;">
              <strong>‚úì ƒê√∫ng v·ªÅ m·∫∑t T√†i ch√≠nh:</strong> 
              <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li><strong>ƒê·∫ßu t∆∞ s·ªõm h∆°n</strong> (ti·ªÅn ra s·ªõm) ‚Üí Ti·ªÅn b·ªã ch√¥n l√¢u h∆°n ‚Üí IRR <strong style="color: var(--red-700);">gi·∫£m</strong> ‚úì</li>
                <li><strong>Tho√°t v·ªën tr·ªÖ h∆°n</strong> (ti·ªÅn v√†o tr·ªÖ) ‚Üí Ti·ªÅn v·ªÅ mu·ªôn h∆°n ‚Üí IRR <strong style="color: var(--red-700);">gi·∫£m</strong> ‚úì</li>
                <li><strong>C·ªï t·ª©c tr·ªÖ h∆°n</strong> (ti·ªÅn v√†o tr·ªÖ) ‚Üí Ti·ªÅn v·ªÅ mu·ªôn h∆°n ‚Üí IRR <strong style="color: var(--red-700);">gi·∫£m</strong> ‚úì</li>
              </ul>
              <em>Nguy√™n t·∫Øc c·ªët l√µi: <strong>Ti·ªÅn ra c√†ng mu·ªôn c√†ng t·ªët, ti·ªÅn v√†o c√†ng s·ªõm c√†ng t·ªët</strong>.
              M·ªçi thay ƒë·ªïi l√†m tr·ªÖ d√≤ng ti·ªÅn v√†o ho·∫∑c ƒë·∫©y nhanh d√≤ng ti·ªÅn ra ƒë·ªÅu l√†m gi·∫£m IRR.</em>
            </div>
          `;
        }


        /**
         * Calculate holding period with precision
         */
        function calculateHoldingPeriod(cashFlows) {
          if (cashFlows.length < 2) return '0 days';
          
          const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
          const startDate = sorted[0].date;
          const endDate = sorted[sorted.length - 1].date;
          
          const milliseconds = endDate - startDate;
          const days = milliseconds / (1000 * 60 * 60 * 24);
          
          // Excel-style calculation
          if (days >= 365.25) {
            const years = (days / 365.25).toFixed(2);
            return `${years} years (${Math.round(days)} days)`;
          } else if (days >= 30.44) {
            const months = (days / 30.44).toFixed(1);
            return `${months} months (${Math.round(days)} days)`;
          } else {
            return `${Math.round(days)} days`;
          }
        }

        // Initialize with custom scenario
        loadScenario('custom');
      }             

      function setupNPVIRRCalculator() {
        const cashFlowsContainer =
          document.getElementById("cashFlowsContainer");
        const calculateBtn = document.getElementById("calculateNPV");
        const resultsDiv = document.getElementById("npvResults");

        // Create 5 cash flow inputs
        for (let i = 1; i <= 5; i++) {
          const div = document.createElement("div");
          div.innerHTML = `
                          <label class="form-label">Year ${i}</label>
                          <input type="number" class="form-input cash-flow-input" id="cf${i}" placeholder="25000">
                      `;
          cashFlowsContainer.appendChild(div);
        }

        calculateBtn.addEventListener("click", () => {
          const initialInvestment = parseFloat(
            document.getElementById("initialInvestment").value
          );
          const discountRate =
            parseFloat(document.getElementById("discountRate").value) / 100;

          if (isNaN(initialInvestment) || isNaN(discountRate)) {
            alert(
              "Please enter valid numbers for initial investment and discount rate."
            );
            return;
          }

          // Get cash flows
          const cashFlows = [];
          for (let i = 1; i <= 5; i++) {
            const cf = parseFloat(document.getElementById(`cf${i}`).value);
            if (isNaN(cf)) {
              alert(`Please enter a valid number for Year ${i} cash flow.`);
              return;
            }
            cashFlows.push(cf);
          }

          // Calculate NPV
          let npv = -initialInvestment;
          for (let i = 0; i < cashFlows.length; i++) {
            npv += cashFlows[i] / Math.pow(1 + discountRate, i + 1);
          }

          // Calculate IRR using the fixed function
          const allCashFlows = [-Math.abs(initialInvestment), ...cashFlows];
          const irrResult = calculateAcademicIRR(allCashFlows, 0.1);

          if (!irrResult.success) {
            resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--rose-100);">
                                  <div class="result-label">NPV</div>
                                  <div class="result-value">$${npv.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--orange-100);">
                                  <div class="result-label">IRR</div>
                                  <div class="result-error">${
                                    irrResult.message
                                  }</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Initial Investment</div>
                                  <div class="result-value">$${initialInvestment.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Discount Rate</div>
                                  <div class="result-value">${(
                                    discountRate * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;
          } else {
            const irr = irrResult.irr;
            resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--rose-100);">
                                  <div class="result-label">NPV</div>
                                  <div class="result-value">$${npv.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--pink-100);">
                                  <div class="result-label">IRR</div>
                                  <div class="result-value">${(
                                    irr * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Initial Investment</div>
                                  <div class="result-value">$${initialInvestment.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Discount Rate</div>
                                  <div class="result-value">${(
                                    discountRate * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;
          }
          resultsDiv.classList.remove("hidden");

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('npv-irr');
          }, 100);
        });
      }




      // ==================== ADVANCED CALCULATORS ====================
      // --- Black-Scholes Calculator ---
      function renderBlackScholesCalculator() {
        return `
                      <h2 class="calculator-title">Black-Scholes Option Pricing Model</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Options Valuation
                          </div>
                          <p class="explanation-text">
                              The <strong>Black-Scholes model</strong> is a mathematical model for pricing options contracts. It calculates the theoretical price of European-style options
                              (which can only be exercised at expiration) using current stock prices, expected dividends, the option's strike price, expected interest rates, time to expiration, and expected volatility.
                          </p>
                          <p class="explanation-text">
                              The model assumes that the price of heavily traded assets follows a geometric Brownian motion with constant drift and volatility.
                              It revolutionized options trading by providing a standardized way to price options.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> The "Greeks" (Delta, Gamma, Theta, Vega, Rho) measure different dimensions of risk in option positions and are derived from the Black-Scholes model.
                          </div>
                      </div>
                      <div class="options-toggle">
                          <button class="option-btn active" id="callOption">Call Option</button>
                          <button class="option-btn" id="putOption">Put Option</button>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Current Stock Price ($)</label>
                              <input type="number" id="stockPrice" class="form-input" placeholder="100">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Strike Price ($)</label>
                              <input type="number" id="strikePrice" class="form-input" placeholder="100">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Time to Expiration (Years)</label>
                              <input type="number" id="timeToExp" class="form-input" placeholder="1" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Risk-free Rate (%)</label>
                              <input type="number" id="bsRiskFreeRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Volatility (%)</label>
                              <input type="number" id="volatility" class="form-input" placeholder="20" step="0.1">
                          </div>
                      </div>
                      <button class="btn btn-primary" id="calculateBS">Calculate Option Price</button>
                      <div id="bsResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      // Improved Normal CDF with higher accuracy
      function normalCDF(x) {
        // Approximation by Abramowitz and Stegun (1964)
        // Accuracy: 7.5e-8 (much better than current 0.5%)

        const sign = x >= 0 ? 1 : -1;
        x = Math.abs(x) / Math.sqrt(2);

        // Constants
        const a1 = 0.254829592;
        const a2 = -0.284496736;
        const a3 = 1.421413741;
        const a4 = -1.453152027;
        const a5 = 1.061405429;
        const p = 0.3275911;

        const t = 1 / (1 + p * x);
        const erfApprox =
          1 -
          ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

        return 0.5 * (1 + sign * erfApprox);
      }

      // Normal PDF for Greeks calculation
      function normalPDF(x) {
        return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
      }

      // Greeks calculation
      function calculateGreeks(S, K, T, r, sigma, isCall) {
        const d1 =
          (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) /
          (sigma * Math.sqrt(T));
        const d2 = d1 - sigma * Math.sqrt(T);

        const Nd1 = normalCDF(d1);
        const Nd2 = normalCDF(d2);
        const nd1 = normalPDF(d1);

        // Delta: Rate of change of option price with respect to stock price
        const delta = isCall ? Nd1 : Nd1 - 1;

        // Gamma: Rate of change of delta with respect to stock price
        const gamma = nd1 / (S * sigma * Math.sqrt(T));

        // Theta: Rate of change of option price with respect to time (per day)
        const theta1 = -(S * nd1 * sigma) / (2 * Math.sqrt(T));
        const theta2 = isCall
          ? -r * K * Math.exp(-r * T) * Nd2
          : r * K * Math.exp(-r * T) * normalCDF(-d2);
        const theta = (theta1 + theta2) / 365; // Per day

        // Vega: Rate of change of option price with respect to volatility
        const vega = (S * nd1 * Math.sqrt(T)) / 100; // Per 1% change in volatility

        // Rho: Rate of change of option price with respect to interest rate
        const rho = isCall
          ? (K * T * Math.exp(-r * T) * Nd2) / 100
          : -(K * T * Math.exp(-r * T) * normalCDF(-d2)) / 100;

        return { delta, gamma, theta, vega, rho };
      }

      function setupBlackScholesCalculator() {
        const callOption = document.getElementById("callOption");
        const putOption = document.getElementById("putOption");
        const calculateBtn = document.getElementById("calculateBS");
        const resultsDiv = document.getElementById("bsResults");

        let isCall = true;

        callOption.addEventListener("click", () => {
          callOption.classList.add("active");
          putOption.classList.remove("active");
          isCall = true;
        });

        putOption.addEventListener("click", () => {
          putOption.classList.add("active");
          callOption.classList.remove("active");
          isCall = false;
        });

        calculateBtn.addEventListener("click", () => {
          const S = parseFloat(document.getElementById("stockPrice").value);
          const K = parseFloat(document.getElementById("strikePrice").value);
          const T = parseFloat(document.getElementById("timeToExp").value);
          const r =
            parseFloat(document.getElementById("bsRiskFreeRate").value) / 100;
          const sigma =
            parseFloat(document.getElementById("volatility").value) / 100;

          if (
            isNaN(S) ||
            isNaN(K) ||
            isNaN(T) ||
            isNaN(r) ||
            isNaN(sigma) ||
            S <= 0 ||
            K <= 0 ||
            T <= 0 ||
            sigma <= 0
          ) {
            alert("Please enter valid positive numbers.");
            return;
          }

          const d1 =
            (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) /
            (sigma * Math.sqrt(T));
          const d2 = d1 - sigma * Math.sqrt(T);

          const Nd1 = normalCDF(d1);
          const Nd2 = normalCDF(d2);
          const Nminusd1 = normalCDF(-d1);
          const Nminusd2 = normalCDF(-d2);

          let optionPrice;
          if (isCall) {
            optionPrice = S * Nd1 - K * Math.exp(-r * T) * Nd2;
          } else {
            optionPrice = K * Math.exp(-r * T) * Nminusd2 - S * Nminusd1;
          }

          // Calculate Greeks
          const greeks = calculateGreeks(S, K, T, r, sigma, isCall);

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--indigo-100);">
                                  <div class="result-label">${
                                    isCall ? "Call" : "Put"
                                  } Price</div>
                                  <div class="result-value">$${optionPrice.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--blue-100);">
                                  <div class="result-label">Delta (Œî)</div>
                                  <div class="result-value">${greeks.delta.toFixed(
                                    4
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--cyan-100);">
                                  <div class="result-label">Gamma (Œì)</div>
                                  <div class="result-value">${greeks.gamma.toFixed(
                                    4
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--green-100);">
                                  <div class="result-label">Theta (Œò)</div>
                                  <div class="result-value">$${greeks.theta.toFixed(
                                    2
                                  )}/day</div>
                              </div>
                              <div class="result-card" style="background-color: var(--purple-100);">
                                  <div class="result-label">Vega (ŒΩ)</div>
                                  <div class="result-value">$${greeks.vega.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--pink-100);">
                                  <div class="result-label">Rho (œÅ)</div>
                                  <div class="result-value">$${greeks.rho.toFixed(
                                    2
                                  )}</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('black-scholes');
          }, 100);
        });
      }



      // --- WACC Calculator ---
      function renderWACCCalculator() {
        return `
                      <h2 class="calculator-title">Weighted Average Cost of Capital (WACC)</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Company's Cost of Capital
                          </div>
                          <p class="explanation-text">
                              <strong>Weighted Average Cost of Capital (WACC)</strong> represents a firm's average after-tax cost of capital from all sources, including common stock, preferred stock, bonds, and other forms of debt.
                              It is the minimum return a company must earn on its existing asset base to satisfy its creditors, owners, and other providers of capital.
                          </p>
                          <p class="explanation-text">
                              Companies use WACC as a hurdle rate for evaluating investment opportunities. Projects with returns below WACC would destroy value, while those with returns above WACC would create value.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> WACC is widely used in discounted cash flow (DCF) analysis as the discount rate. A lower WACC makes future cash flows more valuable, increasing the perceived value of a company.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Market Value of Equity ($)</label>
                              <input type="number" id="marketValueEquity" class="form-input" placeholder="500000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Market Value of Debt ($)</label>
                              <input type="number" id="marketValueDebt" class="form-input" placeholder="300000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Cost of Equity (%)</label>
                              <input type="number" id="costOfEquity" class="form-input" placeholder="12" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Cost of Debt (%)</label>
                              <input type="number" id="costOfDebt" class="form-input" placeholder="6" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Tax Rate (%)</label>
                              <input type="number" id="taxRate" class="form-input" placeholder="30" step="0.1">
                          </div>
                      </div>
                      <button class="btn btn-success" id="calculateWACC">Calculate WACC</button>
                      <div id="waccResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupWACCCalculator() {
        const calculateBtn = document.getElementById("calculateWACC");
        const resultsDiv = document.getElementById("waccResults");

        calculateBtn.addEventListener("click", () => {
          const E = parseFloat(
            document.getElementById("marketValueEquity").value
          );
          const D = parseFloat(
            document.getElementById("marketValueDebt").value
          );
          const Re =
            parseFloat(document.getElementById("costOfEquity").value) / 100;
          const Rd =
            parseFloat(document.getElementById("costOfDebt").value) / 100;
          const T = parseFloat(document.getElementById("taxRate").value) / 100;

          if (
            isNaN(E) ||
            isNaN(D) ||
            isNaN(Re) ||
            isNaN(Rd) ||
            isNaN(T) ||
            E < 0 ||
            D < 0 ||
            Re < 0 ||
            Rd < 0 ||
            T < 0 ||
            T > 100
          ) {
            alert("Please enter valid numbers.");
            return;
          }

          const V = E + D;

          // WACC = (E/V √ó Re) + ((D/V √ó Rd) √ó (1-T))
          const wacc = (E / V) * Re + (D / V) * Rd * (1 - T);
          const equityWeight = E / V;
          const debtWeight = D / V;
          const afterTaxCostOfDebt = Rd * (1 - T);

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--green-100);">
                                  <div class="result-label">WACC</div>
                                  <div class="result-value">${(
                                    wacc * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Equity Weight</div>
                                  <div class="result-value">${(
                                    equityWeight * 100
                                  ).toFixed(1)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Debt Weight</div>
                                  <div class="result-value">${(
                                    debtWeight * 100
                                  ).toFixed(1)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">After-tax Cost of Debt</div>
                                  <div class="result-value">${(
                                    afterTaxCostOfDebt * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('wacc');
          }, 100);
        });
      }      


      // --- DCF Valuation Calculator ---
      function renderDCFCalculator() {
        return `
                <h2 class="calculator-title">Discounted Cash Flow (DCF) Valuation</h2>
                <div class="explanation-box">
                  <div class="explanation-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Enterprise Valuation Model
                  </div>
                  <p class="explanation-text">
                    <strong>DCF Valuation</strong> determines a company's intrinsic value by calculating the present value of its expected future cash flows.
                    This is the most widely used valuation method in investment banking, private equity, and equity research.
                  </p>
                  <p class="explanation-text">
                    The model projects Free Cash Flows (FCF) for a forecast period (typically 5-10 years), then estimates a Terminal Value
                    to capture all cash flows beyond the forecast period. Both are discounted back to present value using WACC.
                  </p>
                  <div class="explanation-note">
                    <strong>PE/IB Insight:</strong> DCF is highly sensitive to assumptions (growth rate, WACC, terminal value).
                    Always perform sensitivity analysis on key variables. A 1% change in WACC can swing valuation by 10-15%.
                  </div>
                </div>

                <div class="options-toggle">
                  <button class="option-btn active" id="terminalGrowth">Perpetuity Growth</button>
                  <button class="option-btn" id="terminalMultiple">Exit Multiple</button>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Initial FCF ($M)</label>
                    <input type="number" id="initialFCF" class="form-input" placeholder="100" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">FCF Growth Rate (%)</label>
                    <input type="number" id="fcfGrowthRate" class="form-input" placeholder="8" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Forecast Period (Years)</label>
                    <input type="number" id="forecastPeriod" class="form-input" placeholder="5" min="1" max="20">
                  </div>
                  <div class="form-group">
                    <label class="form-label">WACC / Discount Rate (%)</label>
                    <input type="number" id="dcfWACC" class="form-input" placeholder="10" step="0.1">
                  </div>
                  <div class="form-group" id="terminalGrowthInput">
                    <label class="form-label">Terminal Growth Rate (%)</label>
                    <input type="number" id="terminalGrowthRate" class="form-input" placeholder="3" step="0.1">
                  </div>
                  <div class="form-group hidden" id="terminalMultipleInput">
                    <label class="form-label">Exit EV/EBITDA Multiple</label>
                    <input type="number" id="exitMultiple" class="form-input" placeholder="10" step="0.1">
                  </div>
                  <div class="form-group hidden" id="terminalEBITDAInput">
                    <label class="form-label">Terminal Year EBITDA ($M)</label>
                    <input type="number" id="terminalEBITDA" class="form-input" placeholder="150" step="0.1">
                  </div>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Cash & Equivalents ($M)</label>
                    <input type="number" id="cashEquiv" class="form-input" placeholder="50" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Total Debt ($M)</label>
                    <input type="number" id="totalDebt" class="form-input" placeholder="200" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Shares Outstanding (M)</label>
                    <input type="number" id="sharesOut" class="form-input" placeholder="100" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Minority Interest ($M)</label>
                    <input type="number" id="minorityInterest" class="form-input" placeholder="0" step="0.1">
                  </div>
                </div>

                <button class="btn btn-primary" id="calculateDCF">Calculate Enterprise & Equity Value</button>

                <div id="dcfResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                  <!-- Results will be populated here -->
                </div>

                <div id="dcfBreakdown" class="hidden" style="margin-top: 2rem; padding: 1.5rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                  <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--slate-700);">Cash Flow Projection</h3>
                  <div style="overflow-x: auto;">
                    <table id="fcfTable" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <!-- Table will be populated here -->
                    </table>
                  </div>
                </div>
              `;
      }

      function setupDCFCalculator() {
        const terminalGrowthBtn = document.getElementById("terminalGrowth");
        const terminalMultipleBtn = document.getElementById("terminalMultiple");
        const terminalGrowthInput = document.getElementById(
          "terminalGrowthInput"
        );
        const terminalMultipleInput = document.getElementById(
          "terminalMultipleInput"
        );
        const terminalEBITDAInput = document.getElementById(
          "terminalEBITDAInput"
        );
        const calculateBtn = document.getElementById("calculateDCF");
        const resultsDiv = document.getElementById("dcfResults");
        const breakdownDiv = document.getElementById("dcfBreakdown");

        let usePerpetuityGrowth = true;

        // Toggle between terminal value methods
        terminalGrowthBtn.addEventListener("click", () => {
          terminalGrowthBtn.classList.add("active");
          terminalMultipleBtn.classList.remove("active");
          terminalGrowthInput.classList.remove("hidden");
          terminalMultipleInput.classList.add("hidden");
          terminalEBITDAInput.classList.add("hidden");
          usePerpetuityGrowth = true;
        });

        terminalMultipleBtn.addEventListener("click", () => {
          terminalMultipleBtn.classList.add("active");
          terminalGrowthBtn.classList.remove("active");
          terminalGrowthInput.classList.add("hidden");
          terminalMultipleInput.classList.remove("hidden");
          terminalEBITDAInput.classList.remove("hidden");
          usePerpetuityGrowth = false;
        });

        calculateBtn.addEventListener("click", () => {
          // Get inputs
          const initialFCF = parseFloat(
            document.getElementById("initialFCF").value
          );
          const fcfGrowthRate =
            parseFloat(document.getElementById("fcfGrowthRate").value) / 100;
          const forecastPeriod = parseInt(
            document.getElementById("forecastPeriod").value
          );
          const wacc =
            parseFloat(document.getElementById("dcfWACC").value) / 100;
          const cash = parseFloat(document.getElementById("cashEquiv").value);
          const debt = parseFloat(document.getElementById("totalDebt").value);
          const shares = parseFloat(document.getElementById("sharesOut").value);
          const minorityInt =
            parseFloat(document.getElementById("minorityInterest").value) || 0;

          // Validate inputs
          if (
            isNaN(initialFCF) ||
            isNaN(fcfGrowthRate) ||
            isNaN(forecastPeriod) ||
            isNaN(wacc) ||
            isNaN(cash) ||
            isNaN(debt) ||
            isNaN(shares)
          ) {
            alert("Please enter valid numbers for all required fields.");
            return;
          }

          if (forecastPeriod < 1 || forecastPeriod > 20) {
            alert("Forecast period must be between 1 and 20 years.");
            return;
          }

          if (wacc <= 0) {
            alert("WACC must be positive.");
            return;
          }

          // Project FCFs
          const fcfs = [];
          const pvFCFs = [];
          let cumulativePVFCF = 0;

          for (let year = 1; year <= forecastPeriod; year++) {
            const fcf = initialFCF * Math.pow(1 + fcfGrowthRate, year);
            const pvFCF = fcf / Math.pow(1 + wacc, year);
            fcfs.push(fcf);
            pvFCFs.push(pvFCF);
            cumulativePVFCF += pvFCF;
          }

          // Calculate Terminal Value
          let terminalValue, terminalValuePV;

          if (usePerpetuityGrowth) {
            const terminalGrowthRate =
              parseFloat(document.getElementById("terminalGrowthRate").value) /
              100;

            if (isNaN(terminalGrowthRate)) {
              alert("Please enter a valid terminal growth rate.");
              return;
            }

            if (terminalGrowthRate >= wacc) {
              alert(
                "Terminal growth rate must be less than WACC. Typically 2-3% (GDP growth rate)."
              );
              return;
            }

            const finalYearFCF = fcfs[fcfs.length - 1];
            const terminalYearFCF = finalYearFCF * (1 + terminalGrowthRate);

            // Gordon Growth Model: TV = FCF(t+1) / (WACC - g)
            terminalValue = terminalYearFCF / (wacc - terminalGrowthRate);
            terminalValuePV =
              terminalValue / Math.pow(1 + wacc, forecastPeriod);
          } else {
            const exitMultiple = parseFloat(
              document.getElementById("exitMultiple").value
            );
            const terminalEBITDA = parseFloat(
              document.getElementById("terminalEBITDA").value
            );

            if (isNaN(exitMultiple) || isNaN(terminalEBITDA)) {
              alert("Please enter valid exit multiple and terminal EBITDA.");
              return;
            }

            if (exitMultiple <= 0) {
              alert("Exit multiple must be positive.");
              return;
            }

            // TV = Exit Multiple √ó Terminal Year EBITDA
            terminalValue = exitMultiple * terminalEBITDA;
            terminalValuePV =
              terminalValue / Math.pow(1 + wacc, forecastPeriod);
          }

          // Calculate Enterprise Value
          const enterpriseValue = cumulativePVFCF + terminalValuePV;

          // Calculate Equity Value
          const equityValue = enterpriseValue + cash - debt - minorityInt;

          // Calculate per share value
          const valuePerShare = equityValue / shares;

          // Display results
          const tvPercentage = (terminalValuePV / enterpriseValue) * 100;

          resultsDiv.innerHTML = `
                  <div class="results-grid">
                    <div class="result-card" style="background-color: var(--indigo-100);">
                      <div class="result-label">Enterprise Value</div>
                      <div class="result-value">$${enterpriseValue.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--blue-100);">
                      <div class="result-label">Equity Value</div>
                      <div class="result-value">$${equityValue.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--cyan-100);">
                      <div class="result-label">Value per Share</div>
                      <div class="result-value">$${valuePerShare.toFixed(
                        2
                      )}</div>
                    </div>
                    <div class="result-card" style="background-color: var(--green-100);">
                      <div class="result-label">PV of Forecast FCFs</div>
                      <div class="result-value">$${cumulativePVFCF.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--emerald-100);">
                      <div class="result-label">Terminal Value (PV)</div>
                      <div class="result-value">$${terminalValuePV.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--slate-100);">
                      <div class="result-label">TV % of Total</div>
                      <div class="result-value">${tvPercentage.toFixed(
                        1
                      )}%</div>
                    </div>
                  </div>
                  <div style="margin-top: 1rem; padding: 1rem; background: var(--blue-50); border-radius: 0.5rem; border-left: 3px solid var(--blue-500);">
                    <div style="font-size: 0.875rem; color: var(--slate-700);">
                      <strong>Bridge to Equity Value:</strong><br>
                      Enterprise Value: $${enterpriseValue.toFixed(1)}M<br>
                      + Cash: $${cash.toFixed(1)}M<br>
                      ‚àí Debt: $${debt.toFixed(1)}M<br>
                      ${
                        minorityInt > 0
                          ? `‚àí Minority Interest: $${minorityInt.toFixed(
                              1
                            )}M<br>`
                          : ""
                      }
                      = Equity Value: $${equityValue.toFixed(1)}M
                    </div>
                  </div>
                `;

          resultsDiv.classList.remove("hidden");

          // Build FCF projection table
          let tableHTML = `
                  <thead>
                    <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Year</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">FCF ($M)</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Growth Rate</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Discount Factor</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">PV of FCF ($M)</th>
                    </tr>
                  </thead>
                  <tbody>
                `;

          for (let year = 1; year <= forecastPeriod; year++) {
            const discountFactor = 1 / Math.pow(1 + wacc, year);
            const growthRate = year === 1 ? fcfGrowthRate : fcfGrowthRate;

            tableHTML += `
                    <tr style="border-bottom: 1px solid var(--slate-200);">
                      <td style="padding: 0.75rem; font-weight: 500;">Year ${year}</td>
                      <td style="padding: 0.75rem; text-align: right;">$${fcfs[
                        year - 1
                      ].toFixed(1)}</td>
                      <td style="padding: 0.75rem; text-align: right;">${(
                        growthRate * 100
                      ).toFixed(1)}%</td>
                      <td style="padding: 0.75rem; text-align: right;">${discountFactor.toFixed(
                        4
                      )}</td>
                      <td style="padding: 0.75rem; text-align: right;">$${pvFCFs[
                        year - 1
                      ].toFixed(1)}</td>
                    </tr>
                  `;
          }

          tableHTML += `
                  <tr style="border-top: 2px solid var(--slate-300); background: var(--slate-50); font-weight: 600;">
                    <td style="padding: 0.75rem;" colspan="4">PV of Forecast Period FCFs</td>
                    <td style="padding: 0.75rem; text-align: right;">$${cumulativePVFCF.toFixed(
                      1
                    )}</td>
                  </tr>
                  <tr style="background: var(--indigo-50); font-weight: 600;">
                    <td style="padding: 0.75rem;">Terminal Value</td>
                    <td style="padding: 0.75rem; text-align: right;">$${terminalValue.toFixed(
                      1
                    )}</td>
                    <td style="padding: 0.75rem; text-align: right;" colspan="2">
                      ${
                        usePerpetuityGrowth
                          ? `Perpetuity @ ${parseFloat(
                              document.getElementById("terminalGrowthRate")
                                .value
                            ).toFixed(1)}%`
                          : `${parseFloat(
                              document.getElementById("exitMultiple").value
                            ).toFixed(1)}x EBITDA`
                      }
                    </td>
                    <td style="padding: 0.75rem; text-align: right;">$${terminalValuePV.toFixed(
                      1
                    )}</td>
                  </tr>
                  <tr style="border-top: 2px solid var(--indigo-500); background: var(--indigo-100); font-weight: 700; font-size: 1rem;">
                    <td style="padding: 1rem;" colspan="4">Enterprise Value</td>
                    <td style="padding: 1rem; text-align: right;">$${enterpriseValue.toFixed(
                      1
                    )}</td>
                  </tr>
                </tbody>
                `;

          document.getElementById("fcfTable").innerHTML = tableHTML;
          breakdownDiv.classList.remove("hidden");

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('dcf');
          }, 100);
        });
      }


      // ==================== LBO MODEL ====================
      function renderLBOCalculator() {
              return `
                      <h2 class="calculator-title">Advanced Leveraged Buyout (LBO) Model</h2>
                      <div class="explanation-box">
                        <div class="explanation-title">
                          Institutional-Grade LBO Model
                        </div>
                        <p class="explanation-text">
                          Advanced LBO model with multi-tranche debt structure, management incentives, dividend recaps,
                          and 3-scenario analysis. This model reflects real PE deal dynamics including covenants,
                          cash sweeps, and realistic exit strategies.
                        </p>
                      </div>

                      <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                        üìä Transaction Structure
                      </h3>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">LTM EBITDA ($M)</label>
                          <input type="number" id="lboEBITDA" class="form-input" value="100" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Entry EV/EBITDA Multiple</label>
                          <input type="number" id="entryMultiple" class="form-input" value="12.0" step="0.1">
                        </div>
                        
                        <div class="form-group">
                          <label class="form-label">Financing Fees (% of Debt)</label>
                          <input type="number" id="financingFee" class="form-input" value="2.0" step="0.1">
                          <small style="color: #666; font-size: 0.8em;">Capitalized on B/S</small>
                        </div>

                        <div class="form-group">
                          <label class="form-label">Advisory Fees (% of EV)</label>
                          <input type="number" id="transFees" class="form-input" value="2.0" step="0.1">
                          <small style="color: #666; font-size: 0.8em;">Expensed immediately</small>
                        </div>

                        <div class="form-group">
                          <label class="form-label">Existing Cash ($M)</label>
                          <input type="number" id="existingCash" class="form-input" value="0" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Existing Debt ($M)</label>
                          <input type="number" id="existingDebt" class="form-input" value="0" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Minimum Cash ($M)</label>
                          <input type="number" id="minCash" class="form-input" value="25" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Hold Period (Years)</label>
                          <input type="number" id="holdPeriod" class="form-input" value="5" min="3" max="10">
                        </div>
                      </div>

                      <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                        üí∞ Multi-Tranche Debt Structure
                      </h3>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Revolver (x EBITDA)</label>
                          <input type="number" id="revolverMultiple" class="form-input" value="0" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Revolver Rate (bps spread)</label>
                          <input type="number" id="revolverRate" class="form-input" value="450" step="25">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Commitment Fee (%)</label>
                          <input type="number" id="commitmentFee" class="form-input" value="0.5" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Term Loan B (x EBITDA)</label>
                          <input type="number" id="tlbMultiple" class="form-input" value="3.0" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">TLB Rate (bps spread)</label>
                          <input type="number" id="tlbRate" class="form-input" value="300" step="25">
                        </div>
                        <div class="form-group">
                          <label class="form-label">TLB Amortization (%/year)</label>
                          <input type="number" id="tlbAmort" class="form-input" value="5.0" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Mezzanine (x EBITDA)</label>
                          <input type="number" id="mezzMultiple" class="form-input" value="2.0" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Mezz Rate (%)</label>
                          <input type="number" id="mezzRate" class="form-input" value="10.0" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">PIK Toggle (%)</label>
                          <input type="number" id="pikToggle" class="form-input" value="10" step="5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Base SOFR (%)</label>
                          <input type="number" id="baseSofr" class="form-input" value="1.5" step="0.25">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Max Net Leverage (Year 1)</label>
                          <input type="number" id="maxLevY1" class="form-input" value="6.0" step="0.25">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Max Net Leverage (Year 5)</label>
                          <input type="number" id="maxLevY5" class="form-input" value="4.0" step="0.25">
                        </div>
                      </div>

                      <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                        üëî Management Equity Structure
                      </h3>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Management Rollover (%)</label>
                          <input type="number" id="mgmtRollover" class="form-input" value="0" step="1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Sweet Equity Pool (%)</label>
                          <input type="number" id="sweetEquity" class="form-input" value="0" step="1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Sweet Equity Discount (%)</label>
                          <input type="number" id="sweetDiscount" class="form-input" value="0" step="5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Options Pool (%)</label>
                          <input type="number" id="optionsPool" class="form-input" value="5" step="1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Option Strike (% of FMV)</label>
                          <input type="number" id="optionStrike" class="form-input" value="100" step="5">
                        </div>
                      </div>

                      <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                        üìà Operating Assumptions (Base Case)
                      </h3>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Revenue Growth Y1 (%)</label>
                          <input type="number" id="revenueGrowthY1" class="form-input" value="15.5" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Revenue Growth Y2-Y5 (%)</label>
                          <input type="number" id="revenueGrowthSteady" class="form-input" value="12" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">EBITDA Margin Y1 (%)</label>
                          <input type="number" id="ebitdaMarginY1" class="form-input" value="20" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">EBITDA Margin Y5 (%)</label>
                          <input type="number" id="ebitdaMarginY5" class="form-input" value="25" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">D&A (% of Revenue)</label>
                          <input type="number" id="daPercent" class="form-input" value="4.0" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">CapEx (% of Revenue)</label>
                          <input type="number" id="capexPercent" class="form-input" value="6.2" step="0.1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">NWC (% of Revenue)</label>
                          <input type="number" id="nwcPercent" class="form-input" value="15" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Tax Rate (%)</label>
                          <input type="number" id="taxRate" class="form-input" value="25" step="1">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Exit Multiple (Base)</label>
                          <input type="number" id="exitMultipleBase" class="form-input" value="10.0" step="0.5">
                        </div>
                      </div>

                      <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                        üéØ Scenario Adjustments
                      </h3>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Upside: Growth Delta (%)</label>
                          <input type="number" id="upsideGrowth" class="form-input" value="2" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Upside: Multiple Delta (x)</label>
                          <input type="number" id="upsideMultiple" class="form-input" value="1.0" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Downside: Growth Delta (%)</label>
                          <input type="number" id="downsideGrowth" class="form-input" value="-2" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Downside: Multiple Delta (x)</label>
                          <input type="number" id="downsideMultiple" class="form-input" value="-1.0" step="0.5">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Downside: Rate Increase (bps)</label>
                          <input type="number" id="downsideRate" class="form-input" value="100" step="50">
                        </div>
                      </div>

                      <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                        üíµ Dividend Recapitalization (Optional)
                      </h3>
                      <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                          <input type="checkbox" id="enableRecap" style="width: 20px; height: 20px;">
                          <span style="font-weight: 500;">Enable Dividend Recap</span>
                        </label>
                      </div>
                      <div class="form-grid" id="recapInputs" style="display: none;">
                        <div class="form-group">
                          <label class="form-label">Recap Year</label>
                          <input type="number" id="recapYear" class="form-input" value="3" min="2" max="4">
                        </div>
                        <div class="form-group">
                          <label class="form-label">Additional Debt (x EBITDA)</label>
                          <input type="number" id="recapDebtMultiple" class="form-input" value="1.0" step="0.25">
                        </div>
                      </div>

                      <button class="btn btn-success" id="calculateLBO" style="margin-top: 1.5rem;">
                        üöÄ Run LBO Model (3 Scenarios)
                      </button>

                      <div id="lboScenarioResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50); margin-top: 2rem;">
                        </div>

                      <div id="lboDetailedResults" class="hidden" style="margin-top: 2rem;">
                        </div>
                    `;
            }

      function setupLBOCalculator() {
        const recapCheckbox = document.getElementById("enableRecap");
        const recapInputs = document.getElementById("recapInputs");
        if (recapCheckbox && recapInputs) {
          recapInputs.style.display = recapCheckbox.checked ? "grid" : "none";
          recapCheckbox.addEventListener("change", (e) => {
            recapInputs.style.display = e.target.checked ? "grid" : "none";
          });
        }

        const btn = document.getElementById("calculateLBO");
        if (btn) {
          btn.addEventListener("click", () => {
            runLBOModel();
            if (typeof StorageManager !== 'undefined') {
              setTimeout(() => {
                StorageManager.saveCalculatorState('lbo');
              }, 100);
            }
          });
        }
      }

      function runLBOModel() {
          try {
              const inputs = getModelInputs();
              if (!validateInputs(inputs)) return;
              
              const scenarios = {
                base: calculateScenario(inputs, "base"),
                upside: calculateScenario(inputs, "upside"),
                downside: calculateScenario(inputs, "downside")
              };

              if (typeof displayScenarioComparison === 'function') {
                  displayScenarioComparison(scenarios);
              } else {
                  console.warn("Function 'displayScenarioComparison' is missing.");
              }
              
              if (typeof displaySensitivityAnalysis === 'function') {
                  displaySensitivityAnalysis(scenarios, inputs);
              }
              
              console.log("Calculation Success:", scenarios.base);
          } catch (error) {
              console.error("LBO Calculation Error:", error);
              alert(`An error occurred during calculation.\nPlease check the console (F12) for details.\n\nTechnical Error: ${error.message}`);
          }
      }

      function calculateTransaction(inputs) {
        const ltmEBITDA = inputs.ltmEBITDA;
        const entryMultiple = inputs.entryMultiple;
        const existingCash = inputs.existingCash;
        const existingDebt = inputs.existingDebt;
        const minCash = inputs.minCash;
        const financingFeePct = !isNaN(inputs.financingFee) ? inputs.financingFee : 0.02;
        const advisoryFeePct = !isNaN(inputs.transFees) ? inputs.transFees : 0.02;
        
        // Debt tranches
        const revolver = ltmEBITDA * inputs.revolverMultiple;
        const tlb = ltmEBITDA * inputs.tlbMultiple;
        const mezz = ltmEBITDA * inputs.mezzMultiple;
        const totalNewDebt = revolver + tlb + mezz;
        const grossDebtProceeds = totalNewDebt; 
        const financingFees = grossDebtProceeds * financingFeePct;
        const netDebtProceeds = grossDebtProceeds - financingFees;
        
        // Valuation
        const purchaseEV = ltmEBITDA * entryMultiple;
        const equityPurchasePrice = purchaseEV - existingDebt + existingCash;
        const advisoryFees = purchaseEV * advisoryFeePct;
        const debtRefinancing = existingDebt;
        const cashToBalanceSheet = minCash;

        const totalUses = 
          equityPurchasePrice + 
          debtRefinancing + 
          financingFees + 
          advisoryFees + 
          cashToBalanceSheet;

        const excessCashUsed = Math.max(0, existingCash - minCash);
        let totalEquityRequired = totalUses - grossDebtProceeds - excessCashUsed;
        if (totalEquityRequired < 0) totalEquityRequired = 0;
        
        // Management equity
        const mgmtRolloverPct = inputs.mgmtRollover || 0;
        const mgmtRolloverDollar = totalEquityRequired * mgmtRolloverPct;
        const sponsorEquityCheck = totalEquityRequired - mgmtRolloverDollar;
        const totalSources = grossDebtProceeds + excessCashUsed + totalEquityRequired;
        
        // Calculate leverage metrics
        const grossLeverage = totalNewDebt / ltmEBITDA;
        const netDebt = totalNewDebt - existingCash;
        const netLeverage = netDebt / ltmEBITDA;
        
        // Calculate ownership (simplified pre-dilution)
        const totalEquityValue = purchaseEV - netDebt;
        const sponsorOwnershipPct = sponsorEquityCheck / totalEquityRequired;

        return {
          valuation: { ltmEBITDA, purchaseEV, equityPurchasePrice },
          sources: {
            newDebt: { 
              revolver: revolver,
              tlb: tlb, 
              mezz: mezz,
              total: grossDebtProceeds, 
              netProceeds: netDebtProceeds 
            },
            equity: { 
              totalRequired: totalEquityRequired, 
              sponsorCheck: sponsorEquityCheck,
              mgmtRollover: mgmtRolloverDollar
            },
            cash: {
              excessUsed: excessCashUsed
            },
            totalSources: totalSources
          },
          uses: {
            buyEquity: equityPurchasePrice,
            refiDebt: debtRefinancing,
            minCash: cashToBalanceSheet,
            fees: { 
              financing: financingFees, 
              advisory: advisoryFees, 
              total: financingFees + advisoryFees 
            },
            totalUses: totalUses
          },
          metrics: {
            isBalanced: Math.abs(totalSources - totalUses) < 0.01,
            sponsorCheckSize: sponsorEquityCheck,
            grossLeverage: grossLeverage,
            netLeverage: netLeverage,
            ownership: {
              sponsorFD: sponsorOwnershipPct
            }
          }
        };
      }      

      function getModelInputs() {
        const getVal = (id) => {
          const element = document.getElementById(id);
          if (!element) return 0;
          const value = parseFloat(element.value);
          return isNaN(value) ? 0 : value;
        };
        return {
          ltmEBITDA: getVal("lboEBITDA"),
          entryMultiple: getVal("entryMultiple"),
          financingFee: getVal("financingFee") / 100,     
          transFees: getVal("transFees") / 100,           
          existingCash: getVal("existingCash"),
          existingDebt: getVal("existingDebt"),
          minCash: getVal("minCash"),
          holdPeriod: getVal("holdPeriod"),
          revolverMultiple: getVal("revolverMultiple"),
          tlbMultiple: getVal("tlbMultiple"),
          mezzMultiple: getVal("mezzMultiple"),
          revolverRate: getVal("revolverRate") / 10000,   
          tlbRate: getVal("tlbRate") / 10000,             
          mezzRate: getVal("mezzRate") / 100,             
          mgmtRollover: getVal("mgmtRollover") / 100,     
          optionsPool: getVal("optionsPool") / 100,      
          sweetEquity: getVal("sweetEquity") / 100,
          sweetDiscount: getVal("sweetDiscount") / 100,
          optionStrike: getVal("optionStrike") / 100,
          revenueGrowthY1: getVal("revenueGrowthY1") / 100,
          revenueGrowthSteady: getVal("revenueGrowthSteady") / 100,
          ebitdaMarginY1: getVal("ebitdaMarginY1") / 100,
          ebitdaMarginY5: getVal("ebitdaMarginY5") / 100,
          daPercent: getVal("daPercent") / 100,
          capexPercent: getVal("capexPercent") / 100,
          nwcPercent: getVal("nwcPercent") / 100,
          taxRate: getVal("taxRate") / 100,
          tlbAmort: getVal("tlbAmort") / 100,
          commitmentFee: getVal("commitmentFee") / 100,
          pikToggle: getVal("pikToggle") / 100,
          baseSofr: getVal("baseSofr") / 100,
          maxLevY1: getVal("maxLevY1"),
          maxLevY5: getVal("maxLevY5"),
          exitMultipleBase: getVal("exitMultipleBase"),
          upsideGrowth: getVal("upsideGrowth") / 100,
          upsideMultiple: getVal("upsideMultiple"),
          downsideGrowth: getVal("downsideGrowth") / 100,
          downsideMultiple: getVal("downsideMultiple"),
          downsideRate: getVal("downsideRate") / 10000,
          enableRecap: document.getElementById("enableRecap")?.checked || false,
          recapYear: getVal("recapYear"),
          recapDebtMultiple: getVal("recapDebtMultiple"),
        };
      }

      function validateInputs(inputs) {
        if (isNaN(inputs.ltmEBITDA) || inputs.ltmEBITDA <= 0) {
          alert("Please enter a valid LTM EBITDA");
          return false;
        }

        if (inputs.holdPeriod < 3 || inputs.holdPeriod > 10) {
          alert("Hold period must be between 3 and 10 years");
          return false;
        }

        const totalLeverage =
          inputs.revolverMultiple + inputs.tlbMultiple + inputs.mezzMultiple;
        if (totalLeverage < 2 || totalLeverage > 10) {
          alert("Total leverage should be between 2x and 10x EBITDA");
          return false;
        }

        const totalMgmtEquity =
          inputs.mgmtRollover + inputs.sweetEquity + inputs.optionsPool;
        if (totalMgmtEquity > 0.4) {
          alert("Total management equity cannot exceed 40%");
          return false;
        }

        return true;
      }

      function calculateScenario(inputs, scenarioType) {
        const adjustedInputs = adjustForScenario(inputs, scenarioType);
        const transaction = calculateTransaction(adjustedInputs);
        const projections = projectFinancials(adjustedInputs, transaction);
        const returns = calculateReturns(adjustedInputs, transaction, projections);
        const mgmtReturns = calculateManagementReturns(adjustedInputs, transaction, returns, projections); 

        return { 
          transaction, 
          projections, 
          returns, 
          mgmtReturns, 
          inputs: adjustedInputs 
        };
      }

      function adjustForScenario(inputs, scenarioType) {
        const adjusted = { ...inputs };

        if (scenarioType === "upside") {
          adjusted.revenueGrowthY1 += inputs.upsideGrowth;
          adjusted.revenueGrowthSteady += inputs.upsideGrowth;
          adjusted.exitMultipleBase += inputs.upsideMultiple;
        } else if (scenarioType === "downside") {
          adjusted.revenueGrowthY1 += inputs.downsideGrowth;
          adjusted.revenueGrowthSteady += inputs.downsideGrowth;
          adjusted.exitMultipleBase += inputs.downsideMultiple;
          adjusted.revolverRate += inputs.downsideRate;
          adjusted.tlbRate += inputs.downsideRate;
        }

        return adjusted;
      }

      function projectFinancials(inputs, transaction) {
        const years = inputs.holdPeriod;
        const projs = [];
        let revenue = inputs.ltmEBITDA / inputs.ebitdaMarginY1; 
        // Balance Sheet Initialization
        let ppeNet = revenue * 1.5; // Gi·∫£ ƒë·ªãnh asset intensity
        let nwc = revenue * inputs.nwcPercent;
        let retainedEarnings = transaction.sources.sponsorEquity + transaction.sources.mgmtRollover; 
        let cash = inputs.minCash;
        let debt = {
          revolver: transaction.sources.newDebt.revolver,
          tlb:      transaction.sources.newDebt.tlb,
          mezz:     transaction.sources.newDebt.mezz 
        };

        for (let y = 1; y <= years; y++) {
          // ====== 1. OPERATING MODEL ======
          const growth = y === 1 ? inputs.revenueGrowthY1 : inputs.revenueGrowthSteady;
          const newRevenue = revenue * (1 + growth);

          // Interpolate Margin (Linear progression)
          const marginProgress = (years > 1) ? (y - 1) / (years - 1) : 0;
          const margin = inputs.ebitdaMarginY1 + 
            (inputs.ebitdaMarginY5 - inputs.ebitdaMarginY1) * marginProgress;
            
          const ebitda = newRevenue * margin;
          const da = newRevenue * inputs.daPercent;
          const ebit = ebitda - da;

          // ====== 2. WORKING CAPITAL & CAPEX ======
          const newNWC = newRevenue * inputs.nwcPercent;
          const deltaNWC = newNWC - nwc; // D∆∞∆°ng = TƒÉng NWC = Use of Cash
          const capex = newRevenue * inputs.capexPercent;

          // ====== 3. UNLEVERED PRE-TAX CASH FLOW (Operational Proxy) ======
          // D√πng ƒë·ªÉ ∆∞·ªõc t√≠nh ti·ªÅn m·∫∑t kh·∫£ d·ª•ng tr·∫£ n·ª£
          // L∆∞u √Ω: Tax th·ª±c t·∫ø s·∫Ω t√≠nh ·ªü d∆∞·ªõi sau khi tr·ª´ l√£i vay
          const fcfProxy = ebitda - capex - deltaNWC; 

          // ====== 4. DIVIDEND RECAP HANDLING (CRITICAL FIX) ======
          // N·∫øu c√≥ Recap, ph·∫£i tƒÉng n·ª£ TR∆Ø·ªöC khi t√≠nh to√°n Schedule ƒë·ªÉ Ending Balance ƒë√∫ng
          let recapProceeds = 0;
          let newRecapDebt = 0;

          if (inputs.enableRecap && y === inputs.recapYear) {
            newRecapDebt = ebitda * inputs.recapDebtMultiple;
            // Gi·∫£ s·ª≠ 2% ph√≠ ph√°t h√†nh cho n·ª£ m·ªõi, ti·ªÅn v·ªÅ t√∫i c·ªï ƒë√¥ng l√† 98%
            recapProceeds = newRecapDebt * 0.98; 
            
            // Inject n·ª£ m·ªõi v√†o c·∫•u tr√∫c n·ª£ hi·ªán t·∫°i ƒë·ªÉ t√≠nh to√°n Ending Balance ch√≠nh x√°c
            debt.tlb += newRecapDebt; 
          }

          // ====== 5. CASH AVAILABLE FOR DEBT SERVICE ======
          // Beginning Cash + Operational Cash Flow (ch∆∞a tr·ª´ l√£i/thu·∫ø ch√≠nh x√°c, nh∆∞ng ƒë·ªß ƒë·ªÉ estimate sweep)
          // Recap Proceeds KH√îNG d√πng ƒë·ªÉ tr·∫£ n·ª£ c≈©, n√™n kh√¥ng c·ªông v√†o ƒë√¢y ƒë·ªÉ sweep.
          const cashBeforeFinancing = cash + fcfProxy;

          // ====== 6. DEBT SCHEDULE (Logic 2-Iteration) ======
          const debtResult = calculateDebtSchedule({
            beginningDebt: debt,
            inputs,
            operatingMetrics: {
              ebit: ebit,                    
              da: da,                       
              capex: capex,                  
              deltaNWC: deltaNWC             
            }
          });

          // ====== 7. FINAL P&L ======
          const interestExpense = debtResult.cashInterest + debtResult.pikInterest + debtResult.feeAmort;
          const ebt = ebit - interestExpense;
          // Tax shield t·ª´ l√£i vay
          const tax = Math.max(0, ebt * inputs.taxRate); 
          const netIncome = ebt - tax;

          // ====== 8. CASH FLOW STATEMENT (US GAAP STANDARD) ======
          // CFO: Net Income + Non-cash items - Change in Working Capital
          // deltaNWC ph·∫£i l√† d·∫•u TR·ª™ (Increase in Asset is Use of Cash)
          const cfo = netIncome 
            + da 
            + debtResult.feeAmort 
            + debtResult.pikInterest 
            - deltaNWC; 

          const cfi = -capex;

          // CFF: Tr·∫£ n·ª£ (-) + Ti·ªÅn Recap (+) - C·ªï t·ª©c Recap (-)
          // ·ªû ƒë√¢y ta ƒë∆°n gi·∫£n h√≥a: Recap Proceeds v√†o r·ªìi ra ngay d∆∞·ªõi d·∫°ng Dividend
          // Dividend = Recap Proceeds (Gi·∫£ ƒë·ªãnh to√†n b·ªô ti·ªÅn vay th√™m ƒë∆∞·ª£c chia c·ªï t·ª©c)
          const principalRepayment = debtResult.mandatory + debtResult.sweep;
          
          // Net flow t·ª´ Recap l√† 0 (Vay 100 -> Chia 100), nh∆∞ng n·ª£ g·ªëc tƒÉng tr√™n BS
          // D√≤ng ti·ªÅn th·ª±c t·∫ø ch·ªâ thay ƒë·ªïi do tr·∫£ n·ª£ c≈©
          const cff = -principalRepayment; 
          
          // L∆∞u √Ω: N·∫øu mu·ªën track d√≤ng ti·ªÅn dividend ra ri√™ng bi·ªát:
          // CFF = -principalRepayment + newRecapDebt (Inflow) - dividendPaid (Outflow)

          // ====== 9. ENDING CASH & EXCESS SWEEP ======
          const endingCashRaw = cash + cfo + cfi + cff;
          const finalCash = Math.max(inputs.minCash, endingCashRaw);

          // ====== 10. BALANCE SHEET UPDATES ======
          const endingPPENet = ppeNet + capex - da;
          const endingRetained = retainedEarnings + netIncome - recapProceeds; 
          const totalDebtEnd = debtResult.ending.revolver + debtResult.ending.tlb + debtResult.ending.mezz;
          const netDebt = totalDebtEnd - finalCash;

          // ====== 11. STORAGE ======
          projs.push({
            year: y,
            revenue: newRevenue,
            ebitda,
            ebit,
            interestExpense,
            netIncome,
            fcfPreDebtService: fcfProxy - (ebit * inputs.taxRate), 
            cashBeforeFinancing,
            cashInterest: debtResult.cashInterest,
            mandatoryRepayment: debtResult.mandatory,
            sweepRepayment: debtResult.sweep,
            recapDividend: recapProceeds, 
            endingCash: finalCash,
            totalDebt: totalDebtEnd,
            netDebt,
            netLeverage: ebitda > 0 ? netDebt / ebitda : 0,
            covenantHeadroom: inputs.maxLevY1 - (netDebt / ebitda)
          });

          // ====== 12. CARRY FORWARD ======
          revenue = newRevenue;
          ppeNet = endingPPENet;
          nwc = newNWC;
          retainedEarnings = endingRetained;
          cash = finalCash;

          debt = { ...debtResult.ending };
        }

        return projs;
      }

      function calculateDebtSchedule({ beginningDebt, inputs, operatingMetrics }) {
          // --- 1. PREPARE INPUTS & RATES ---
          // H√†m an to√†n: Chuy·ªÉn ƒë·ªïi input th√†nh s·ªë, n·∫øu l·ªói th√¨ v·ªÅ 0
          const safeInput = (val) => (typeof val === 'number' && isFinite(val) ? val : 0);

          // Chuy·ªÉn ƒë·ªïi l√£i su·∫•t t·ª´ bps/percent sang decimal
          const baseSofr = safeInput(inputs.baseSofr); 
          const revMargin = safeInput(inputs.revolverRate);
          const tlbMargin = safeInput(inputs.tlbRate);
          const mezzRateTotal = safeInput(inputs.mezzRate);
          
          // T√°ch l√£i Mezzanine th√†nh ph·∫ßn Cash v√† PIK
          // V√≠ d·ª•: L√£i 10%, PIK Toggle 40% -> Cash 6%, PIK 4%
          const pikTogglePct = safeInput(inputs.pikToggle); 
          const mezzCashRate = mezzRateTotal * (1 - pikTogglePct);
          const mezzPikRate  = mezzRateTotal * pikTogglePct;

          const commFeeRate = safeInput(inputs.commitmentFee);
          const taxRate = safeInput(inputs.taxRate);
          const tlbAmortPct = safeInput(inputs.tlbAmort); 

          // T√≠nh Facility Sizes & Balances ƒë·∫ßu k·ª≥
          const revBeg  = safeInput(beginningDebt.revolver);
          const tlbBeg  = safeInput(beginningDebt.tlb);
          const mezzBeg = safeInput(beginningDebt.mezz);
          const revFacility = safeInput(inputs.ltmEBITDA) * safeInput(inputs.revolverMultiple);

          // T√≠nh Kh·∫•u hao Ph√≠ Vay (Fee Amortization) - Non-cash expense
          // Gi·∫£ ƒë·ªãnh ph√≠ Financing Fee l√† 2% tr√™n t·ªïng n·ª£ ban ƒë·∫ßu
          const financingFeePct = inputs.financingFee || 0.02; 
          const totalNewDebtAtClose = inputs.ltmEBITDA * ((inputs.revolverMultiple || 0) + (inputs.tlbMultiple || 0) + (inputs.mezzMultiple || 0));
          const holdPeriod = inputs.holdPeriod || 5;
          const feeAmort = (totalNewDebtAtClose * financingFeePct) / holdPeriod;

          // --- 2. CIRCULAR SOLVER LOOP (15 Iterations) ---
          // Kh·ªüi t·∫°o gi√° tr·ªã cu·ªëi k·ª≥ (Ending Balance) b·∫±ng ƒë·∫ßu k·ª≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu v√≤ng l·∫∑p
          let ending = { revolver: revBeg, tlb: tlbBeg, mezz: mezzBeg };
          let finalResult = {};

          for (let iter = 0; iter < 15; iter++) {
              // A. T√≠nh s·ªë d∆∞ trung b√¨nh (Average Balance)
              const avgRev  = (revBeg + ending.revolver) / 2;
              const avgTLB  = (tlbBeg + ending.tlb) / 2;
              const avgMezz = (mezzBeg + ending.mezz) / 2;

              // B. T√≠nh L√£i vay (Interest Expense)
              const undrawnAmount = Math.max(0, revFacility - avgRev);
              const commitmentFee = undrawnAmount * commFeeRate;

              const revInterest = avgRev * (baseSofr + revMargin);
              const tlbInterest = avgTLB * (baseSofr + tlbMargin);
              const mezzCashInt = avgMezz * mezzCashRate;
              
              const cashInterest = revInterest + tlbInterest + mezzCashInt + commitmentFee;
              const pikInterest  = avgMezz * mezzPikRate;

              // C. T√≠nh Thu·∫ø (Tax Shield)
              // L·ª£i nhu·∫≠n tr∆∞·ªõc thu·∫ø (EBT) = EBIT - T·ªïng l√£i vay (Cash + PIK + Fee Amort)
              const totalInterestExp = cashInterest + pikInterest + feeAmort;
              const ebt = operatingMetrics.ebit - totalInterestExp;
              const tax = Math.max(0, ebt * taxRate);

              // D. D√≤ng ti·ªÅn kh·∫£ d·ª•ng tr·∫£ n·ª£ (CFADS - Cash Flow Available for Debt Service)
              // CFADS = EBITDA - Thu·∫ø - L√£i vay ti·ªÅn m·∫∑t - Capex - Thay ƒë·ªïi V·ªën l∆∞u ƒë·ªông
              const ebitda = operatingMetrics.ebit + operatingMetrics.da;
              const cfads = ebitda 
                            - tax 
                            - cashInterest 
                            - operatingMetrics.capex 
                            - operatingMetrics.deltaNWC;

              // E. L·ªãch tr√¨nh tr·∫£ n·ª£ (Repayment Waterfall)
              
              // 1. Tr·∫£ n·ª£ g·ªëc b·∫Øt bu·ªôc (Mandatory Amortization - TLB)
              const mandatoryTLB = tlbBeg * tlbAmortPct;
              let cashRemaining = cfads - mandatoryTLB;

              // 2. R√∫t Revolver (N·∫øu thi·∫øu ti·ªÅn)
              let revolverDraw = 0;
              if (cashRemaining < 0) {
                  // R√∫t t·ªëi ƒëa s·ªë ti·ªÅn thi·∫øu, nh∆∞ng kh√¥ng v∆∞·ª£t qu√° h·∫°n m·ª©c c√≤n l·∫°i
                  revolverDraw = Math.min(-cashRemaining, revFacility - revBeg);
                  cashRemaining += revolverDraw; 
                  // N·∫øu v·∫´n < 0 sau khi r√∫t h·∫øt Revolver -> Cash Balance s·∫Ω b·ªã gi·∫£m (x·ª≠ l√Ω ·ªü t·∫ßng tr√™n)
              }

              // 3. Qu√©t ti·ªÅn tr·∫£ n·ª£ (Cash Sweep - N·∫øu d∆∞ ti·ªÅn)
              let cashForSweep = Math.max(0, cashRemaining);
              
              // a. Sweep Revolver: ∆Øu ti√™n s·ªë 1 (Tr·∫£ h·∫øt n·ª£ ng·∫Øn h·∫°n tr∆∞·ªõc)
              // C√≥ th·ªÉ tr·∫£ c·∫£ s·ªë d∆∞ ƒë·∫ßu k·ª≥ V√Ä s·ªë v·ª´a r√∫t trong k·ª≥ (n·∫øu d√≤ng ti·ªÅn bi·∫øn ƒë·ªông m·∫°nh)
              const totalRevExposure = revBeg + revolverDraw;
              const sweepRev = Math.min(cashForSweep, totalRevExposure);
              cashForSweep -= sweepRev;

              // b. Sweep TLB: ∆Øu ti√™n s·ªë 2
              // QUAN TR·ªåNG: Cash Sweep Percent (Th∆∞·ªùng l√† 50%, 75% ho·∫∑c 100%)
              // ·ªû ƒë√¢y ta ƒë·ªÉ 100% (1.0) cho m√¥ h√¨nh chu·∫©n. N·∫øu mu·ªën gi·ªëng Case Study 50%, ƒë·ªïi th√†nh 0.5
              const sweepPercent = 1.0; 
              const sweepAmountTLB = cashForSweep * sweepPercent;
              
              const optionalTLBAvail = Math.max(0, tlbBeg - mandatoryTLB); // Kh√¥ng tr·∫£ qu√° s·ªë n·ª£ g·ªëc
              const sweepTLB = Math.min(sweepAmountTLB, optionalTLBAvail);

              // F. C·∫≠p nh·∫≠t S·ªë d∆∞ Cu·ªëi k·ª≥ (Ending Balances)
              ending.revolver = Math.max(0, revBeg + revolverDraw - sweepRev);
              ending.tlb      = Math.max(0, tlbBeg - mandatoryTLB - sweepTLB);
              ending.mezz     = mezzBeg + pikInterest; // Mezz c·ªông th√™m l√£i PIK

              // L∆∞u k·∫øt qu·∫£ ·ªü v√≤ng l·∫∑p cu·ªëi c√πng (khi s·ªë li·ªáu ƒë√£ h·ªôi t·ª•)
              if (iter === 14) {
                  finalResult = {
                      cashInterest,
                      pikInterest,
                      feeAmort,         // C·∫ßn tr·∫£ v·ªÅ ƒë·ªÉ c·ªông v√†o Net Income
                      totalInterestExp,
                      tax,
                      
                      mandatory: mandatoryTLB,
                      revolverDraw,
                      sweep: sweepRev + sweepTLB, // T·ªïng ti·ªÅn tr·∫£ n·ª£ tr∆∞·ªõc h·∫°n
                      
                      ending: { ...ending }
                  };
              }
          }

          return finalResult;
      }

      function calculateReturns(adjustedInputs, transaction, projections) {
        // =================================================================
        // 1. SAFETY CHECKS (PH·∫¶N CHECK PROJECTIONS ƒê·∫¶Y ƒê·ª¶)
        // =================================================================
        // Ki·ªÉm tra xem m·∫£ng d·ª± ph√≥ng c√≥ t·ªìn t·∫°i v√† c√≥ d·ªØ li·ªáu kh√¥ng
        if (!projections || !Array.isArray(projections) || projections.length === 0) {
            console.warn("calculateReturns: D·ªØ li·ªáu d·ª± ph√≥ng (Projections) b·ªã thi·∫øu ho·∫∑c r·ªóng.");
            return {}; // Tr·∫£ v·ªÅ object r·ªóng ƒë·ªÉ UI kh√¥ng b·ªã s·∫≠p
        }
        const holdPeriod = adjustedInputs.holdPeriod;
        // L·∫•y nƒÉm Exit 
        const exitProj = projections[projections.length - 1];
        // Ki·ªÉm tra xem nƒÉm Exit c√≥ d·ªØ li·ªáu h·ª£p l·ªá kh√¥ng
        if (!exitProj) {
            console.warn("calculateReturns: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu nƒÉm Exit.");
            return {};
        }

        // =================================================================
        // 2. EXIT VALUATION (ƒê·ªäNH GI√Å KHI THO√ÅT V·ªêN)
        // =================================================================
        const exitEBITDA = exitProj.ebitda || 0;
        const exitMultiple = adjustedInputs.exitMultipleBase || 0;

        // Exit Enterprise Value 
        const exitEV = exitEBITDA * exitMultiple;

        // Net Debt t·∫°i th·ªùi ƒëi·ªÉm Exit (N·ª£ - Ti·ªÅn m·∫∑t)
        // L∆∞u √Ω: D√πng Math.max(0, ...) ƒë·ªÉ tr√°nh s·ªë √¢m n·∫øu ti·ªÅn m·∫∑t > n·ª£
        const totalDebtExit = exitProj.totalDebt || 0;
        const endingCashExit = exitProj.endingCash || 0;
        const netDebtAtExit = Math.max(0, totalDebtExit - endingCashExit);

        // Total Exit Equity Value (T·ªïng gi√° tr·ªã V·ªën ch·ªß s·ªü h·ªØu - cho T·∫§T C·∫¢ c·ªï ƒë√¥ng)
        const totalExitEquityValue = Math.max(0, exitEV - netDebtAtExit);

        // =================================================================
        // 3. SPONSOR RETURNS 
        // =================================================================
        // L·∫•y % s·ªü h·ªØu c·ªßa Sponsor (Fully Diluted) t·ª´ c·∫•u tr√∫c ban ƒë·∫ßu
        // Safety check: N·∫øu kh√¥ng c√≥ ownership data, t√≠nh t·ª´ equity check
        const sponsorOwnershipPct = transaction.metrics?.ownership?.sponsorFD || 
        (transaction.sources.equity.sponsorCheck / transaction.sources.equity.totalRequired) || 0;
        // Ti·ªÅn th·ª±c nh·∫≠n c·ªßa Sponsor = T·ªïng Equity * % S·ªü h·ªØu
        const sponsorExitProceeds = totalExitEquityValue * sponsorOwnershipPct;

        // S·ªë ti·ªÅn Sponsor b·ªè ra ban ƒë·∫ßu (Initial Investment)
        const sponsorInitialEquity = transaction.sources.equity.sponsorCheck || 0;

        // T√≠nh MOIC (Ch·ªâ t√≠nh tr√™n ph·∫ßn c·ªßa Sponsor)
        const moic = sponsorInitialEquity > 0 ? sponsorExitProceeds / sponsorInitialEquity : 0;

        // =================================================================
        // 4. IRR CALCULATION 
        // =================================================================
        const cashFlows = [];
        
        // NƒÉm 0: D√≤ng ti·ªÅn ra (ƒê·∫ßu t∆∞) - D·∫•u √¢m
        cashFlows[0] = -sponsorInitialEquity;
        
        // C√°c nƒÉm gi·ªØa (1 ƒë·∫øn N-1): D√≤ng ti·ªÅn = 0 (tr·ª´ khi c√≥ c·ªï t·ª©c)
        for (let y = 1; y < holdPeriod; y++) {
            cashFlows[y] = 0;
        }
        
        // NƒÉm cu·ªëi (Exit): D√≤ng ti·ªÅn v√†o (Thu v·ªÅ) - D√πng Sponsor Proceeds
        cashFlows[holdPeriod] = sponsorExitProceeds;

        // X·ª≠ l√Ω Dividend Recap (N·∫øu c√≥)
        if (adjustedInputs.enableRecap) {
            const recapYear = adjustedInputs.recapYear;
            // T√¨m d·ªØ li·ªáu c·ªßa nƒÉm Recap
            const recapProj = projections.find(p => p.year === recapYear);
            const recapDividend = recapProj ? (recapProj.recapDividend || 0) : 0;
            
            // N·∫øu nƒÉm Recap n·∫±m trong k·ª≥ n·∫Øm gi·ªØ h·ª£p l·ªá
            if (recapYear > 0 && recapYear <= holdPeriod) {
                // Sponsor ch·ªâ nh·∫≠n ph·∫ßn c·ªï t·ª©c t∆∞∆°ng ·ª©ng v·ªõi % s·ªü h·ªØu
                const sponsorDividend = recapDividend * sponsorOwnershipPct;
                cashFlows[recapYear] += sponsorDividend;
            }
        }

        // G·ªçi h√†m t√≠nh IRR
        const irr = calculateIRR(cashFlows);

        // =================================================================
        // 5. METRICS & FORMATTING 
        // =================================================================
        // Helper functions ƒë·ªÉ format s·ªë an to√†n (tr√°nh l·ªói toFixed tr√™n undefined)
        const fmt = (val, dec = 1) => (typeof val === 'number' && isFinite(val) ? val.toFixed(dec) : "0.0");
        const fmtPct = (val) => (typeof val === 'number' && isFinite(val) ? (val * 100).toFixed(1) + "%" : "0.0%");

        // C√°c ch·ªâ s·ªë ph·ª• ƒë·ªÉ ph√¢n t√≠ch (Drivers)
        const grossLeverageEntry = transaction.metrics.grossLeverage || 0;
        const netLeverageExit    = exitEBITDA > 0 ? netDebtAtExit / exitEBITDA : 0;
        const multipleExpansion  = exitMultiple - adjustedInputs.entryMultiple;
        
        // T√≠nh CAGR EBITDA
        let ebitdaCagr = 0;
        if (adjustedInputs.ltmEBITDA > 0 && holdPeriod > 0) {
            ebitdaCagr = Math.pow(exitEBITDA / adjustedInputs.ltmEBITDA, 1 / holdPeriod) - 1;
        }

        // Tr·∫£ v·ªÅ Object k·∫øt qu·∫£
        return {
            // --- Core Returns ---
            irr: irr,
            irrFormatted: fmtPct(irr),
            moic: fmt(moic, 2) + "x",

            // --- Valuation Details ---
            exitYear: holdPeriod,
            exitMultiple: fmt(exitMultiple, 1) + "x",
            exitEBITDA: fmt(exitEBITDA, 1),
            exitEV: fmt(exitEV, 1),
            netDebtAtExit: fmt(netDebtAtExit, 1),
            
            // Ph√¢n bi·ªát r√µ Total vs Sponsor Share
            totalExitEquityValue: fmt(totalExitEquityValue, 1),
            sponsorExitProceeds: fmt(sponsorExitProceeds, 1),

            // --- Return Drivers (Value Creation) ---
            entryMultiple: fmt(adjustedInputs.entryMultiple, 1) + "x",
            multipleExpansion: fmt(multipleExpansion, 1) + "x",
            ebitdaCagr: fmtPct(ebitdaCagr),
            // Deleveraging: Ch√™nh l·ªách ƒë√≤n b·∫©y v√†o vs ra
            deleveragingPaydown: fmt(grossLeverageEntry - netLeverageExit, 1) + "x",

            // --- Credit Stats ---
            grossLeverageEntry: fmt(grossLeverageEntry, 1) + "x",
            netLeverageEntry: fmt(transaction.metrics.netLeverage, 1) + "x",
            netLeverageExit: fmt(netLeverageExit, 1) + "x",

            // --- Raw Data cho bi·ªÉu ƒë·ªì ---
            cashFlowsForIRR: cashFlows
        };
      }

      function calculateIRR(cashFlows, guess = 0.12) {
        if (!Array.isArray(cashFlows) || cashFlows.length === 0) return 0;
        let cfs = [...cashFlows];
        while (cfs.length > 1 && Math.abs(cfs[cfs.length - 1]) < 1e-9) {
          cfs.pop();
        }

        // Ki·ªÉm tra ƒë·ªïi d·∫•u (B·∫Øt bu·ªôc ph·∫£i c√≥ ti·ªÅn ra v√† ti·ªÅn v√†o)
        const hasPositive = cfs.some(cf => cf > 0);
        const hasNegative = cfs.some(cf => cf < 0);
        if (!hasPositive || !hasNegative) return 0; 
        const tolerance = 1e-8;
        const maxIter = 1000;
        let rate = guess;

        for (let i = 0; i < maxIter; i++) {
          let npv = 0;
          let derivative = 0;
          let discount = 1.0; // Bi·∫øn t√≠ch l≈©y: (1+r)^t

          for (let t = 0; t < cfs.length; t++) {
            const cf = cfs[t];
            
            // T·∫°i t=0, discount=1. T·ª´ t=1 tr·ªü ƒëi, nh√¢n d·ªìn
            if (t > 0) discount *= (1 + rate);
            
            npv += cf / discount;

            // ƒê·∫°o h√†m: -t * CF / (1+r)^(t+1)
            // discount ƒëang l√† (1+r)^t, n√™n nh√¢n th√™m (1+rate) l√† ƒë·ªß
            if (t > 0) {
              derivative -= (t * cf) / (discount * (1 + rate));
            }
          }
          if (Math.abs(npv) < tolerance) return rate;
          if (derivative === 0 || !isFinite(derivative)) break;
          const nextRate = rate - npv / derivative;
          if (!isFinite(nextRate) || nextRate <= -1.0 || nextRate > 100.0) {
            return bisectionIRR(cfs);
          }

          rate = nextRate;
        }
        return bisectionIRR(cfs);
      }

      function bisectionIRR(cashFlows, low = -0.9999, high = 100.0) {
        const tolerance = 1e-8;
        const maxIter = 1500; 

        for (let i = 0; i < maxIter; i++) {
          const mid = (low + high) / 2;
          
          // D√πng reduce t√≠nh NPV 
          const npv = cashFlows.reduce((sum, cf, t) => sum + cf / Math.pow(1 + mid, t), 0);

          if (Math.abs(npv) < tolerance) return mid;

          // Logic k·∫πp kho·∫£ng: NPV ngh·ªãch bi·∫øn v·ªõi Rate
          if (npv > 0) {
            low = mid;
          } else {
            high = mid;
          }
        }
        return (low + high) / 2;
      }




      
      function calculateManagementReturns(adjustedInputs, transaction, returns, projections) {
        const { holdPeriod } = adjustedInputs;
        const { exitEquityValue } = returns;
        const rolloverValue       = transaction.sources.equity.mgmtRollover || 0;
        const totalNewEquity      = transaction.sources.equity.totalRequired;
        const rolloverPct         = totalNewEquity > 0 ? rolloverValue / totalNewEquity : 0;
        const sweetEquityPct      = adjustedInputs.sweetEquity || 0;
        const sweetDiscount       = adjustedInputs.sweetDiscount || 0.5;
        const optionsPoolPct      = adjustedInputs.optionsPool || 0;
        const optionStrikeMult    = adjustedInputs.optionStrike || 1.0;
        const BASE_FD_SHARES      = 100;                                      
        const exitSharePrice      = exitEquityValue / BASE_FD_SHARES;
        const sweetShares         = BASE_FD_SHARES * sweetEquityPct;
        const sweetStrike         = exitSharePrice * (1 - sweetDiscount);
        const sweetCashPaid       = sweetShares * sweetStrike;
        const sweetProceeds       = sweetShares * (exitSharePrice - sweetStrike);
        const optionSharesGranted = BASE_FD_SHARES * optionsPoolPct;
        const optionStrikePrice   = exitSharePrice * optionStrikeMult;

        let optionNetProceeds = 0;
        let optionNetNewShares = 0;    

        if (exitSharePrice > optionStrikePrice) {
          const cashFromExercise   = optionSharesGranted * optionStrikePrice;
          const sharesRepurchased  = cashFromExercise / exitSharePrice;   
          optionNetNewShares       = optionSharesGranted - sharesRepurchased;
          optionNetProceeds        = optionNetNewShares * exitSharePrice;
        }

        const rolloverProceeds    = exitEquityValue * rolloverPct;
        const totalMgmtProceeds   = rolloverProceeds + sweetProceeds + optionNetProceeds;
        const mgmtInitialOutlay   = rolloverValue + sweetCashPaid;
        const mgmtMOIC            = mgmtInitialOutlay > 0 ? totalMgmtProceeds / mgmtInitialOutlay : 0;

        const mgmtCashFlows = Array(holdPeriod + 1).fill(0);
        mgmtCashFlows[0] = -mgmtInitialOutlay;
        mgmtCashFlows[holdPeriod] = totalMgmtProceeds;

        if (adjustedInputs.enableRecap) {
          const recapYear = adjustedInputs.recapYear;
          const proj = projections?.find(p => p.year === recapYear);
          if (proj?.recapDividend) {
            const mgmtOwnershipAtRecap = rolloverPct + sweetEquityPct + optionsPoolPct;
            mgmtCashFlows[recapYear] += proj.recapDividend * mgmtOwnershipAtRecap;
          }
        }

        const mgmtIRR = calculateIRR(mgmtCashFlows);
        
        // ... [Rest of calculation: Final FD Shares, Ownership Pct] ...
        const finalFDShares = BASE_FD_SHARES + optionNetNewShares;
        const mgmtFinalShares = (rolloverPct * BASE_FD_SHARES) + sweetShares + optionNetNewShares;                  
        const mgmtFinalOwnershipPct = mgmtFinalShares / finalFDShares;
        const sponsorFinalOwnershipPct = 1 - mgmtFinalOwnershipPct;

        return {
          totalManagementProceeds: totalMgmtProceeds.toFixed(1),
          managementInitialInvestment: mgmtInitialOutlay.toFixed(1),
          mgmtMOIC: mgmtMOIC.toFixed(2) + "x",
          mgmtIRR: (mgmtIRR * 100).toFixed(1) + "%",

          rollover: { proceeds: rolloverProceeds.toFixed(1), pct: (rolloverPct * 100).toFixed(1) + "%" },
          sweetEquity: { shares: sweetShares.toFixed(2), proceeds: sweetProceeds.toFixed(1) },
          options: {
            granted: optionSharesGranted.toFixed(2),
            netNewShares: optionNetNewShares.toFixed(3),
            proceeds: optionNetProceeds.toFixed(1),
            itm: exitSharePrice > optionStrikePrice
          },

          finalOwnership: {
            management: (mgmtFinalOwnershipPct * 100).toFixed(2) + "%",
            sponsor: (sponsorFinalOwnershipPct * 100).toFixed(2) + "%"
          },

          exitSharePrice: exitSharePrice.toFixed(2),
          finalFDShares: finalFDShares.toFixed(3),
          mgmtCashFlows
        };
      }

      function renderScenarioCard(name, scenario, color, isBase = false) {
        const { returns } = scenario;
        const borderStyle = isBase 
          ? `border: 3px solid ${color}; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);` 
          : `border: 2px solid ${color};`;

        return `
          <div style="background: white; border-radius: 8px; padding: 1.25rem; ${borderStyle}">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
              <span style="font-weight: 600; font-size: 0.95rem; color: #374151;">${name}</span>
              ${isBase ? '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">BASE</span>' : ''}
            </div>
            
            <div style="margin-bottom: 0.75rem;">
              <div style="font-size: 2rem; font-weight: 700; color: ${color};">${returns.irrFormatted}</div>
              <div style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">IRR</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
              <div>
                <div style="font-size: 1.25rem; font-weight: 600; color: #1f2937;">${returns.moic}</div>
                <div style="font-size: 0.75rem; color: #6b7280;">MOIC</div>
              </div>
              <div>
                <div style="font-size: 1.25rem; font-weight: 600; color: #1f2937;">${returns.exitMultiple}x</div>
                <div style="font-size: 0.75rem; color: #6b7280;">Exit Multiple</div>
              </div>
            </div>
            
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.25rem;">
                <span style="color: #6b7280;">Entry Leverage:</span>
                <span style="font-weight: 600; color: #1f2937;">${returns.netLeverageEntry}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                <span style="color: #6b7280;">Exit Leverage:</span>
                <span style="font-weight: 600; color: #1f2937;">${returns.netLeverageExit}</span>
              </div>
            </div>
          </div>
        `;
      }

      function renderReturnWaterfall(name, scenario, color) {
        const { returns } = scenario;
        const multipleExp = parseFloat(returns.multipleExpansion);
        const ebitdaGrowth = parseFloat(returns.ebitdaCagr);
        const deleveraging = parseFloat(returns.deleveragingPaydown);

        const total = Math.abs(multipleExp) + Math.abs(ebitdaGrowth * 10) + Math.abs(deleveraging);
        const multPct = total > 0 ? (Math.abs(multipleExp) / total) * 100 : 33;
        const ebitdaPct = total > 0 ? (Math.abs(ebitdaGrowth * 10) / total) * 100 : 33;
        const deleverPct = total > 0 ? (Math.abs(deleveraging) / total) * 100 : 33;

        return `
          <div style="text-align: center;">
            <div style="font-weight: 600; font-size: 0.9rem; color: #374151; margin-bottom: 1rem;">${name}</div>
            
            <div style="height: 200px; display: flex; flex-direction: column; justify-content: flex-end; gap: 0.5rem;">
              <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); height: ${multPct}%; border-radius: 6px 6px 0 0; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease;">
                ${returns.multipleExpansion}x
              </div>
              <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); height: ${ebitdaPct}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease;">
                ${returns.ebitdaCagr}
              </div>
              <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); height: ${deleverPct}%; border-radius: 0 0 6px 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease;">
                ${returns.deleveragingPaydown}
              </div>
            </div>
            
            <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem;">
                <div style="width: 12px; height: 12px; background: #6366f1; border-radius: 2px;"></div>
                <span style="color: #6b7280;">Multiple Expansion</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem;">
                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                <span style="color: #6b7280;">EBITDA Growth</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem;">
                <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px;"></div>
                <span style="color: #6b7280;">Deleveraging</span>
              </div>
            </div>
          </div>
        `;
      }

      function renderManagementReturnsComparison(scenarios) {
        return `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem;">
            <h3 style="font-size: 1.2rem; font-weight: 700; margin: 0 0 1.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              Management Returns Summary
            </h3>
            
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                  <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Metric</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #ef4444;">Downside</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #10b981;">Base Case</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #3b82f6;">Upside</th>
                  </tr>
                </thead>
                <tbody>
                  ${renderMgmtRow("Management IRR", scenarios, "mgmtIRR")}
                  ${renderMgmtRow("Management MOIC", scenarios, "mgmtMOIC")}
                  ${renderMgmtRow("Total Proceeds ($M)", scenarios, "totalManagementProceeds")}
                  ${renderMgmtRow("Initial Investment ($M)", scenarios, "managementInitialInvestment")}
                  ${renderMgmtRow("Final Ownership %", scenarios, "finalOwnership.management")}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function renderMgmtRow(label, scenarios, path) {
        const getValue = (obj, path) => {
          return path.split('.').reduce((o, p) => o?.[p], obj?.mgmtReturns);
        };

        return `
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 0.75rem; color: #6b7280;">${label}</td>
            <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #1f2937;">${getValue(scenarios.downside, path)}</td>
            <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #1f2937; background: #f0fdf4;">${getValue(scenarios.base, path)}</td>
            <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #1f2937;">${getValue(scenarios.upside, path)}</td>
          </tr>
        `;
      }

      function displaySensitivityAnalysis(scenarios, inputs) {
        const container = document.getElementById("lboDetailedResults");
        container.classList.remove("hidden");

        const html = `
          ${renderSensitivityTabs()}
          <div id="sensitivityTabContent">
            ${renderIRRSensitivityMatrix(scenarios.base, inputs)}
          </div>
        `;

        container.innerHTML = html;
        setupSensitivityTabs(scenarios, inputs);
      }

      function renderSensitivityTabs() {
        return `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; margin-top: 2rem;">
            <div style="display: flex; border-bottom: 2px solid #e5e7eb; background: #f9fafb;">
              <button class="sensitivity-tab active" data-tab="irr" style="flex: 1; padding: 1rem; border: none; background: white; border-bottom: 3px solid #6366f1; font-weight: 600; color: #6366f1; cursor: pointer; transition: all 0.2s;">
                IRR Sensitivity
              </button>
              <button class="sensitivity-tab" data-tab="moic" style="flex: 1; padding: 1rem; border: none; background: transparent; font-weight: 500; color: #6b7280; cursor: pointer; transition: all 0.2s;">
                MOIC Sensitivity
              </button>
              <button class="sensitivity-tab" data-tab="ev" style="flex: 1; padding: 1rem; border: none; background: transparent; font-weight: 500; color: #6b7280; cursor: pointer; transition: all 0.2s;">
                Exit EV Sensitivity
              </button>
              <button class="sensitivity-tab" data-tab="credit" style="flex: 1; padding: 1rem; border: none; background: transparent; font-weight: 500; color: #6b7280; cursor: pointer; transition: all 0.2s;">
                Credit Timeline
              </button>
            </div>
            <div style="padding: 2rem;">
              <!-- Content will be injected here -->
            </div>
          </div>
        `;
      }

      function setupSensitivityTabs(scenarios, inputs) {
        const tabs = document.querySelectorAll('.sensitivity-tab');
        const contentContainer = document.getElementById('sensitivityTabContent');

        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            // Remove active state from all tabs
            tabs.forEach(t => {
              t.classList.remove('active');
              t.style.background = 'transparent';
              t.style.color = '#6b7280';
              t.style.borderBottom = 'none';
            });

            // Set active state to clicked tab
            tab.classList.add('active');
            tab.style.background = 'white';
            tab.style.color = '#6366f1';
            tab.style.borderBottom = '3px solid #6366f1';

            // Render appropriate content
            const tabType = tab.dataset.tab;
            let content = '';

            switch(tabType) {
              case 'irr':
                content = renderIRRSensitivityMatrix(scenarios.base, inputs);
                break;
              case 'moic':
                content = renderMOICSensitivityMatrix(scenarios.base, inputs);
                break;
              case 'ev':
                content = renderEVSensitivityMatrix(scenarios.base, inputs);
                break;
              case 'credit':
                content = renderCreditTimeline(scenarios.base);
                break;
            }

            contentContainer.innerHTML = content;
          });
        });
      }

      function renderIRRSensitivityMatrix(baseScenario, inputs) {
        const entryRange = generateRange(inputs.entryMultiple, 0.5, 5);
        const exitRange = generateRange(inputs.exitMultipleBase, 0.5, 5);

        return `
          <div>
            <h4 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: #1f2937;">
              IRR Sensitivity: Entry Multiple vs Exit Multiple
            </h4>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <div style="font-size: 0.85rem; color: #1e40af; line-height: 1.6;">
                <strong>Base Case:</strong> Entry ${inputs.entryMultiple.toFixed(1)}x | Exit ${inputs.exitMultipleBase.toFixed(1)}x | 
                IRR ${baseScenario.returns.irrFormatted}
              </div>
            </div>
            
            <div style="overflow-x: auto;">
              ${buildSensitivityTable(entryRange, exitRange, inputs, 'irr')}
            </div>
            
            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
              <span style="font-size: 0.85rem; font-weight: 600; color: #374151;">Color Scale:</span>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                ${renderColorLegend()}
              </div>
            </div>
          </div>
        `;
      }

      function renderMOICSensitivityMatrix(baseScenario, inputs) {
        const entryRange = generateRange(inputs.entryMultiple, 0.5, 5);
        const exitRange = generateRange(inputs.exitMultipleBase, 0.5, 5);

        return `
          <div>
            <h4 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: #1f2937;">
              MOIC Sensitivity: Entry Multiple vs Exit Multiple
            </h4>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <div style="font-size: 0.85rem; color: #1e40af; line-height: 1.6;">
                <strong>Base Case:</strong> Entry ${inputs.entryMultiple.toFixed(1)}x | Exit ${inputs.exitMultipleBase.toFixed(1)}x | 
                MOIC ${baseScenario.returns.moic}
              </div>
            </div>
            
            <div style="overflow-x: auto;">
              ${buildSensitivityTable(entryRange, exitRange, inputs, 'moic')}
            </div>
          </div>
        `;
      }

      function renderEVSensitivityMatrix(baseScenario, inputs) {
        const ebitdaGrowthRange = generateRange(inputs.revenueGrowthSteady * 100, 1, 5);
        const exitMultipleRange = generateRange(inputs.exitMultipleBase, 0.5, 5);

        return `
          <div>
            <h4 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: #1f2937;">
              Exit Enterprise Value Sensitivity: EBITDA Growth vs Exit Multiple
            </h4>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <div style="font-size: 0.85rem; color: #1e40af; line-height: 1.6;">
                <strong>Base Case:</strong> Exit EV $${baseScenario.returns.exitEV}M
              </div>
            </div>
            
            <div style="overflow-x: auto;">
              ${buildEVSensitivityTable(ebitdaGrowthRange, exitMultipleRange, inputs)}
            </div>
          </div>
        `;
      }

      function renderCreditTimeline(baseScenario) {
        const projections = baseScenario.projections;

        return `
          <div>
            <h4 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: #1f2937;">
              Credit Metrics Timeline (Base Case)
            </h4>
            
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                <thead>
                  <tr style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white;">
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Year</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">EBITDA ($M)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Total Debt ($M)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Net Debt ($M)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Net Leverage (x)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Interest Coverage (x)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Debt Paydown ($M)</th>
                  </tr>
                </thead>
                <tbody>
                  ${projections.map((p, i) => {
                    const interestCoverage = p.cashInterest > 0 ? (p.ebitda / p.cashInterest).toFixed(2) : 'N/A';
                    const debtPaydown = i > 0 ? (projections[i-1].totalDebt - p.totalDebt).toFixed(1) : '-';
                    const leverageColor = getLeverageColor(p.netLeverage);
                    
                    return `
                      <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <td style="padding: 0.75rem; font-weight: 600; color: #1f2937;">Year ${p.year}</td>
                        <td style="padding: 0.75rem; text-align: right; color: #374151;">$${p.ebitda.toFixed(1)}</td>
                        <td style="padding: 0.75rem; text-align: right; color: #374151;">$${p.totalDebt.toFixed(1)}</td>
                        <td style="padding: 0.75rem; text-align: right; color: #374151;">$${p.netDebt.toFixed(1)}</td>
                        <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: ${leverageColor};">${p.netLeverage.toFixed(2)}x</td>
                        <td style="padding: 0.75rem; text-align: right; color: #374151;">${interestCoverage}x</td>
                        <td style="padding: 0.75rem; text-align: right; color: #10b981; font-weight: 600;">${debtPaydown}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              ${renderCreditMetricCard("Avg Net Leverage", calculateAverage(projections, 'netLeverage').toFixed(2) + 'x', '#6366f1')}
              ${renderCreditMetricCard("Total Debt Paydown", `$${(projections[0].totalDebt - projections[projections.length - 1].totalDebt).toFixed(1)}M`, '#10b981')}
              ${renderCreditMetricCard("Deleveraging Rate", `${((projections[0].netLeverage - projections[projections.length - 1].netLeverage) / projections.length).toFixed(2)}x/yr`, '#f59e0b')}
            </div>
          </div>
        `;
      }

      function buildSensitivityTable(rowRange, colRange, inputs, metric) {
        let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">';
        
        // Table header
        html += '<thead><tr style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white;">';
        html += '<th style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: #1e293b;">Entry \\ Exit</th>';
        colRange.forEach(val => {
          html += `<th style="padding: 0.75rem; text-align: center; font-weight: 600;">${val.toFixed(1)}x</th>`;
        });
        html += '</tr></thead>';
        
        // Table body
        html += '<tbody>';
        rowRange.forEach(entryMult => {
          html += '<tr style="border-bottom: 1px solid #e5e7eb;">';
          html += `<td style="padding: 0.75rem; font-weight: 600; background: #f9fafb; position: sticky; left: 0; color: #1f2937;">${entryMult.toFixed(1)}x</td>`;
          
          colRange.forEach(exitMult => {
            const value = calculateSensitivityValue(entryMult, exitMult, inputs, metric);
            const { color, textColor } = getSensitivityCellColor(value, metric);
            const isBase = Math.abs(entryMult - inputs.entryMultiple) < 0.1 && Math.abs(exitMult - inputs.exitMultipleBase) < 0.1;
            const border = isBase ? 'border: 3px solid #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);' : '';
            
            html += `
              <td style="padding: 0.75rem; text-align: center; background: ${color}; color: ${textColor}; font-weight: 600; transition: all 0.2s; cursor: pointer; ${border}" 
                  onmouseover="this.style.transform='scale(1.05)'; this.style.zIndex='10';" 
                  onmouseout="this.style.transform='scale(1)'; this.style.zIndex='1';"
                  title="Entry ${entryMult.toFixed(1)}x | Exit ${exitMult.toFixed(1)}x | ${metric.toUpperCase()}: ${value}">
                ${value}
              </td>
            `;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
        
        return html;
      }

      function buildEVSensitivityTable(growthRange, multipleRange, inputs) {
        let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">';
        
        // Table header
        html += '<thead><tr style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white;">';
        html += '<th style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: #1e293b;">Growth \\ Multiple</th>';
        multipleRange.forEach(val => {
          html += `<th style="padding: 0.75rem; text-align: center; font-weight: 600;">${val.toFixed(1)}x</th>`;
        });
        html += '</tr></thead>';
        
        // Table body
        html += '<tbody>';
        growthRange.forEach(growth => {
          html += '<tr style="border-bottom: 1px solid #e5e7eb;">';
          html += `<td style="padding: 0.75rem; font-weight: 600; background: #f9fafb; position: sticky; left: 0; color: #1f2937;">${growth.toFixed(1)}%</td>`;
          
          multipleRange.forEach(multiple => {
            const exitEBITDA = inputs.ltmEBITDA * Math.pow(1 + growth/100, inputs.holdPeriod);
            const exitEV = exitEBITDA * multiple;
            const color = getEVCellColor(exitEV);
            
            html += `
              <td style="padding: 0.75rem; text-align: center; background: ${color}; font-weight: 600; transition: all 0.2s; cursor: pointer;" 
                  onmouseover="this.style.transform='scale(1.05)';" 
                  onmouseout="this.style.transform='scale(1)';"
                  title="Growth ${growth.toFixed(1)}% | Multiple ${multiple.toFixed(1)}x">
                $${exitEV.toFixed(0)}M
              </td>
            `;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
        
        return html;
      }

      function calculateSensitivityValue(entryMult, exitMult, inputs, metric) {
        const adjustedInputs = { ...inputs, entryMultiple: entryMult, exitMultipleBase: exitMult };
        const transaction = calculateTransaction(adjustedInputs);
        const projections = projectFinancials(adjustedInputs, transaction);
        const returns = calculateReturns(adjustedInputs, transaction, projections);

        if (metric === 'irr') {
          return (returns.irr * 100).toFixed(1) + '%';
        } else if (metric === 'moic') {
          const moic = parseFloat(returns.moic);
          return moic.toFixed(2) + 'x';
        }
      }

      function generateRange(base, step, count) {
        const range = [];
        const start = base - (step * Math.floor(count / 2));
        for (let i = 0; i < count; i++) {
          range.push(start + (step * i));
        }
        return range;
      }

      function calculateAverage(arr, key) {
        return arr.reduce((sum, item) => sum + item[key], 0) / arr.length;
      }

      function getSensitivityCellColor(value, metric) {
        const numValue = parseFloat(value);
        
        if (metric === 'irr') {
          if (numValue >= 25) return { color: '#10b981', textColor: 'white' };
          if (numValue >= 20) return { color: '#34d399', textColor: 'white' };
          if (numValue >= 15) return { color: '#6ee7b7', textColor: '#065f46' };
          if (numValue >= 10) return { color: '#fbbf24', textColor: '#78350f' };
          return { color: '#ef4444', textColor: 'white' };
        } else if (metric === 'moic') {
          if (numValue >= 3.0) return { color: '#10b981', textColor: 'white' };
          if (numValue >= 2.5) return { color: '#34d399', textColor: 'white' };
          if (numValue >= 2.0) return { color: '#6ee7b7', textColor: '#065f46' };
          if (numValue >= 1.5) return { color: '#fbbf24', textColor: '#78350f' };
          return { color: '#ef4444', textColor: 'white' };
        }
      }

      function getEVCellColor(ev) {
        if (ev >= 1500) return 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        if (ev >= 1200) return 'linear-gradient(135deg, #34d399 0%, #10b981 100%)';
        if (ev >= 1000) return 'linear-gradient(135deg, #6ee7b7 0%, #34d399 100%)';
        if (ev >= 800) return 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
        return 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      }

      function getLeverageColor(leverage) {
        if (leverage > 6) return '#ef4444';
        if (leverage > 4) return '#f59e0b';
        return '#10b981';
      }

      function renderColorLegend() {
        return `
          <div style="display: flex; align-items: center; gap: 0.25rem;">
            <div style="width: 30px; height: 20px; background: #ef4444; border-radius: 4px;"></div>
            <span style="font-size: 0.75rem; color: #6b7280; margin-right: 0.75rem;">&lt;10%</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.25rem;">
            <div style="width: 30px; height: 20px; background: #fbbf24; border-radius: 4px;"></div>
            <span style="font-size: 0.75rem; color: #6b7280; margin-right: 0.75rem;">10-15%</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.25rem;">
            <div style="width: 30px; height: 20px; background: #6ee7b7; border-radius: 4px;"></div>
            <span style="font-size: 0.75rem; color: #6b7280; margin-right: 0.75rem;">15-20%</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.25rem;">
            <div style="width: 30px; height: 20px; background: #34d399; border-radius: 4px;"></div>
            <span style="font-size: 0.75rem; color: #6b7280; margin-right: 0.75rem;">20-25%</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.25rem;">
            <div style="width: 30px; height: 20px; background: #10b981; border-radius: 4px;"></div>
            <span style="font-size: 0.75rem; color: #6b7280;">&gt;25%</span>
          </div>
        `;
      }

      function renderCreditMetricCard(title, value, color) {
        return `
          <div style="background: white; border: 2px solid ${color}; border-radius: 8px; padding: 1rem; text-align: center;">
            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem;">${title}</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: ${color};">${value}</div>
          </div>
        `;
      }

      function displayScenarioComparison(scenarios) {
        const container = document.getElementById("lboScenarioResults");
        container.classList.remove("hidden");

        const html = `
          ${renderSourcesUsesWaterfall(scenarios.base)}  
          ${renderExecutiveSummaryScorecard(scenarios)}
          ${renderSourcesOfReturnComparison(scenarios)}
          ${renderDeleveragingPathChart(scenarios)}
          ${renderManagementReturnsComparison(scenarios)}
        `;

        container.innerHTML = html;
      }

      function renderExecutiveSummaryScorecard(scenarios) {
        const { base, upside, downside } = scenarios;

        return `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);">
            <h3 style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
              Investment Returns Dashboard
            </h3>
            <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0 0 2rem 0;">3-Scenario Analysis ‚Ä¢ Base/Upside/Downside</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
              ${renderEnhancedScenarioCard("üîª Downside", downside, "#ef4444", "#fca5a5")}
              ${renderEnhancedScenarioCard("üéØ Base Case", base, "#10b981", "#6ee7b7", true)}
              ${renderEnhancedScenarioCard("üöÄ Upside", upside, "#3b82f6", "#93c5fd")}
            </div>
            
            <div style="margin-top: 2rem; padding: 1.25rem; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; color: white;">
                <div>
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.25rem;">Target IRR Threshold</div>
                  <div style="font-size: 1.5rem; font-weight: 700;">20-25%</div>
                </div>
                <div>
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.25rem;">Target MOIC Range</div>
                  <div style="font-size: 1.5rem; font-weight: 700;">2.5-3.0x</div>
                </div>
                <div>
                  <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.25rem;">Hold Period</div>
                  <div style="font-size: 1.5rem; font-weight: 700;">${base.inputs.holdPeriod} Years</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderEnhancedScenarioCard(name, scenario, primaryColor, lightColor, isBase = false) {
        const { returns } = scenario;
        const borderStyle = isBase 
          ? `border: 3px solid ${primaryColor}; box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4), 0 0 0 4px rgba(16, 185, 129, 0.1);` 
          : `border: 2px solid ${lightColor}; box-shadow: 0 4px 20px rgba(0,0,0,0.1);`;

        // Parse IRR for conditional styling
        const irrValue = parseFloat(returns.irrFormatted);
        const irrStatus = irrValue >= 20 ? '‚úì Target Met' : '‚ö† Below Target';
        const irrStatusColor = irrValue >= 20 ? '#10b981' : '#f59e0b';

        return `
          <div style="background: white; border-radius: 12px; padding: 1.5rem; ${borderStyle} position: relative; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 40px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.1)';">
            
            <!-- Decorative corner badge -->
            ${isBase ? `<div style="position: absolute; top: 12px; right: 12px; background: ${primaryColor}; color: white; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px;">BASE</div>` : ''}
            
            <div style="margin-bottom: 1.25rem;">
              <span style="font-size: 1.1rem; font-weight: 700; color: #1f2937;">${name}</span>
            </div>
            
            <!-- Hero Metrics: IRR & MOIC -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid #f3f4f6;">
              <div>
                <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Internal Rate of Return</div>
                <div style="font-size: 2.5rem; font-weight: 800; color: ${primaryColor}; line-height: 1;">${returns.irrFormatted}</div>
                <div style="font-size: 0.7rem; color: ${irrStatusColor}; font-weight: 600; margin-top: 0.25rem;">${irrStatus}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Cash-on-Cash Return</div>
                <div style="font-size: 2.5rem; font-weight: 800; color: ${primaryColor}; line-height: 1;">${returns.moic}</div>
                <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem;">Multiple on Investment</div>
              </div>
            </div>
            
            <!-- Valuation Metrics -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div style="background: #f9fafb; padding: 0.75rem; border-radius: 8px;">
                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Entry Multiple</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #1f2937;">${returns.entryMultiple}</div>
              </div>
              <div style="background: #f9fafb; padding: 0.75rem; border-radius: 8px;">
                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Exit Multiple</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #1f2937;">${returns.exitMultiple}</div>
              </div>
            </div>
            
            <!-- Leverage Profile -->
            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1rem; border-radius: 8px; border-left: 4px solid ${primaryColor};">
              <div style="font-size: 0.8rem; font-weight: 600; color: #0369a1; margin-bottom: 0.75rem;">Leverage Profile</div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 0.7rem; color: #0369a1; margin-bottom: 0.25rem;">Entry</div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: #0c4a6e;">${returns.netLeverageEntry}</div>
                </div>
                <div style="flex: 1; height: 2px; background: linear-gradient(to right, ${primaryColor}, ${lightColor}); margin: 0 1rem; position: relative;">
                  <div style="position: absolute; right: 0; top: -3px; width: 0; height: 0; border-left: 6px solid ${lightColor}; border-top: 4px solid transparent; border-bottom: 4px solid transparent;"></div>
                </div>
                <div>
                  <div style="font-size: 0.7rem; color: #0369a1; margin-bottom: 0.25rem;">Exit</div>
                  <div style="font-size: 1.1rem; font-weight: 700; color: #0c4a6e;">${returns.netLeverageExit}</div>
                </div>
              </div>
              <div style="margin-top: 0.5rem; font-size: 0.7rem; color: #0369a1; text-align: center;">
                Deleveraging: <strong>${returns.deleveragingPaydown}</strong>
              </div>
            </div>
          </div>
        `;
      }

      function renderSourcesOfReturnComparison(scenarios) {
        const { base, upside, downside } = scenarios;

        return `
          <div style="background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
            <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
              Value Creation Waterfall
            </h3>
            <p style="color: #6b7280; font-size: 0.9rem; margin: 0 0 2rem 0;">Sources of Return Breakdown ‚Ä¢ Three Levers of LBO Returns</p>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem;">
              ${renderEnhancedReturnWaterfall("Downside", downside, "#ef4444")}
              ${renderEnhancedReturnWaterfall("Base Case", base, "#10b981")}
              ${renderEnhancedReturnWaterfall("Upside", upside, "#3b82f6")}
            </div>
            
            <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border-left: 5px solid #3b82f6;">
              <div style="display: flex; align-items: start; gap: 1rem;">
                <div style="flex-shrink: 0; width: 40px; height: 40px; background: #3b82f6; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: #0c4a6e; margin-bottom: 0.5rem; font-size: 1rem;">PE Value Creation Framework</div>
                  <div style="font-size: 0.9rem; color: #0369a1; line-height: 1.7;">
                    LBO returns are driven by <strong style="color: #6366f1;">Multiple Expansion</strong> (market timing & positioning), 
                    <strong style="color: #10b981;">EBITDA Growth</strong> (operational improvements & revenue expansion), and 
                    <strong style="color: #f59e0b;">Deleveraging</strong> (debt paydown from free cash flow generation). 
                    Top-quartile PE firms target 40-50% from operations, 30-40% from deleveraging, and 10-20% from multiple arbitrage.
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderEnhancedReturnWaterfall(name, scenario, color) {
        const { returns } = scenario;
        const multipleExp = parseFloat(returns.multipleExpansion);
        const ebitdaGrowthPct = parseFloat(returns.ebitdaCagr);
        const deleveraging = parseFloat(returns.deleveragingPaydown);

        // Calculate contribution percentages
        const total = Math.abs(multipleExp) * 10 + Math.abs(ebitdaGrowthPct) + Math.abs(deleveraging) * 10;
        const multContribution = total > 0 ? ((Math.abs(multipleExp) * 10 / total) * 100).toFixed(0) : 33;
        const ebitdaContribution = total > 0 ? ((Math.abs(ebitdaGrowthPct) / total) * 100).toFixed(0) : 33;
        const deleverContribution = total > 0 ? ((Math.abs(deleveraging) * 10 / total) * 100).toFixed(0) : 33;

        // Heights for visualization
        const chartHeight = 280;
        const multHeight = (multContribution / 100) * chartHeight;
        const ebitdaHeight = (ebitdaContribution / 100) * chartHeight;
        const deleverHeight = (deleverContribution / 100) * chartHeight;

        return `
          <div style="text-align: center;">
            <div style="font-weight: 700; font-size: 1rem; color: #1f2937; margin-bottom: 0.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e5e7eb;">${name}</div>
            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 1.5rem;">Total IRR: <strong style="color: ${color};">${returns.irrFormatted}</strong></div>
            
            <!-- Waterfall Chart -->
            <div style="height: ${chartHeight}px; display: flex; flex-direction: column-reverse; gap: 0.5rem; margin-bottom: 1.5rem;">
              
              <!-- Multiple Expansion Bar -->
              <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); height: ${multHeight}px; border-radius: 8px 8px 4px 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 700; transition: all 0.3s ease; position: relative; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);" onmouseover="this.style.transform='scaleY(1.05)'; this.style.zIndex='10';" onmouseout="this.style.transform='scaleY(1)'; this.style.zIndex='1';">
                <div>${returns.multipleExpansion}x</div>
                <div style="font-size: 0.7rem; font-weight: 500; opacity: 0.9; margin-top: 0.25rem;">${multContribution}%</div>
              </div>
              
              <!-- EBITDA Growth Bar -->
              <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); height: ${ebitdaHeight}px; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 700; transition: all 0.3s ease; position: relative; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='scaleY(1.05)'; this.style.zIndex='10';" onmouseout="this.style.transform='scaleY(1)'; this.style.zIndex='1';">
                <div>${returns.ebitdaCagr}</div>
                <div style="font-size: 0.7rem; font-weight: 500; opacity: 0.9; margin-top: 0.25rem;">${ebitdaContribution}%</div>
              </div>
              
              <!-- Deleveraging Bar -->
              <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); height: ${deleverHeight}px; border-radius: 4px 4px 8px 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 700; transition: all 0.3s ease; position: relative; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);" onmouseover="this.style.transform='scaleY(1.05)'; this.style.zIndex='10';" onmouseout="this.style.transform='scaleY(1)'; this.style.zIndex='1';">
                <div>${returns.deleveragingPaydown}</div>
                <div style="font-size: 0.7rem; font-weight: 500; opacity: 0.9; margin-top: 0.25rem;">${deleverContribution}%</div>
              </div>
            </div>
            
            <!-- Legend -->
            <div style="display: flex; flex-direction: column; gap: 0.75rem; text-align: left; background: #f9fafb; padding: 1rem; border-radius: 8px;">
              <div style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem;">
                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 4px; flex-shrink: 0;"></div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #374151;">Multiple Expansion</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Market timing & valuation arbitrage</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem;">
                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 4px; flex-shrink: 0;"></div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #374151;">EBITDA Growth</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Operational improvements</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem;">
                <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 4px; flex-shrink: 0;"></div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #374151;">Deleveraging</div>
                  <div style="font-size: 0.75rem; color: #6b7280;">Debt paydown from FCF</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderDeleveragingPathChart(scenarios) {
        const { base, upside, downside } = scenarios;
        const projections = base.projections;
        
        // Calculate chart dimensions and scales
        const chartWidth = 100; // percentage
        const chartHeight = 300;
        const padding = { top: 20, right: 20, bottom: 40, left: 60 };
        const plotWidth = chartWidth;
        const plotHeight = chartHeight - padding.top - padding.bottom;
        
        // Find max leverage across all scenarios for Y-axis scaling
        const allLeverages = [
          ...downside.projections.map(p => p.netLeverage),
          ...base.projections.map(p => p.netLeverage),
          ...upside.projections.map(p => p.netLeverage)
        ];
        const maxLeverage = Math.max(...allLeverages);
        const minLeverage = Math.min(...allLeverages);
        const yAxisMax = Math.ceil(maxLeverage) + 0.5;
        const yAxisMin = Math.max(0, Math.floor(minLeverage) - 0.5);
        const yRange = yAxisMax - yAxisMin;
        
        // Generate Y-axis grid lines
        const gridLines = [];
        const numGridLines = 6;
        for (let i = 0; i <= numGridLines; i++) {
          const value = yAxisMin + (yRange * i / numGridLines);
          const yPos = plotHeight - ((value - yAxisMin) / yRange * plotHeight);
          gridLines.push({ value: value.toFixed(1), yPos });
        }
        
        // Generate path data for each scenario
        const scenarioData = {
          downside: { color: '#ef4444', name: 'Downside', projections: downside.projections },
          base: { color: '#10b981', name: 'Base Case', projections: base.projections },
          upside: { color: '#3b82f6', name: 'Upside', projections: upside.projections }
        };
        
        function generatePath(projections, scenarioKey) {
          const isBase = scenarioKey === 'base';
          const points = projections.map((p, i) => {
            const x = (i / (projections.length - 1)) * plotWidth;
            const y = plotHeight - ((p.netLeverage - yAxisMin) / yRange * plotHeight);
            return { x, y, year: p.year, leverage: p.netLeverage, ebitda: p.ebitda };
          });
          
          // Create smooth SVG path using points
          let pathD = `M ${points[0].x} ${points[0].y}`;
          for (let i = 1; i < points.length; i++) {
            pathD += ` L ${points[i].x} ${points[i].y}`;
          }
          
          return { pathD, points, isBase };
        }
        
        const paths = {
          downside: generatePath(scenarioData.downside.projections, 'downside'),
          base: generatePath(scenarioData.base.projections, 'base'),
          upside: generatePath(scenarioData.upside.projections, 'upside')
        };

        return `
          <div style="background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
              <div>
                <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                  Net Leverage Deleveraging Path
                </h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Credit Profile Evolution ‚Ä¢ ${projections.length}-Year Timeline</p>
              </div>
              
              <!-- Summary Metrics -->
              <div style="display: flex; gap: 1.5rem;">
                <div style="text-align: right;">
                  <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Entry Leverage</div>
                  <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">${base.transaction.metrics.netLeverage.toFixed(1)}x</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Exit Leverage</div>
                  <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${projections[projections.length - 1].netLeverage.toFixed(1)}x</div>
                </div>
              </div>
            </div>
            
            <!-- Chart Container -->
            <div style="position: relative; padding: ${padding.top}px ${padding.right}px ${padding.bottom}px ${padding.left}px; background: linear-gradient(to bottom, #f9fafb 0%, #ffffff 100%); border-radius: 12px; border: 1px solid #e5e7eb;">
              
              <!-- Y-Axis Labels -->
              <div style="position: absolute; left: 0; top: ${padding.top}px; width: ${padding.left - 10}px; height: ${plotHeight}px;">
                ${gridLines.map(line => `
                  <div style="position: absolute; right: 10px; top: ${line.yPos}px; transform: translateY(-50%); font-size: 0.75rem; color: #6b7280; font-weight: 500;">
                    ${line.value}x
                  </div>
                `).join('')}
              </div>
              
              <!-- Chart Area with SVG -->
              <div style="position: relative; width: 100%; height: ${plotHeight}px;">
                
                <!-- Grid Lines -->
                ${gridLines.map(line => `
                  <div style="position: absolute; left: 0; right: 0; top: ${line.yPos}px; height: 1px; background: ${line.value === '0.0' ? '#d1d5db' : '#f3f4f6'};"></div>
                `).join('')}
                
                <!-- SVG Paths -->
                <svg viewBox="0 0 ${plotWidth} ${plotHeight}" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;">
                  <defs>
                    <!-- Gradient fills for area under curves -->
                    <linearGradient id="gradientDownside" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" style="stop-color:#ef4444;stop-opacity:0.1" />
                      <stop offset="100%" style="stop-color:#ef4444;stop-opacity:0" />
                    </linearGradient>
                    <linearGradient id="gradientBase" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.15" />
                      <stop offset="100%" style="stop-color:#10b981;stop-opacity:0" />
                    </linearGradient>
                    <linearGradient id="gradientUpside" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.1" />
                      <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0" />
                    </linearGradient>
                    
                    <!-- Drop shadows for lines -->
                    <filter id="dropShadow" x="-50%" y="-50%" width="200%" height="200%">
                      <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                      <feOffset dx="0" dy="2" result="offsetblur"/>
                      <feComponentTransfer>
                        <feFuncA type="linear" slope="0.3"/>
                      </feComponentTransfer>
                      <feMerge>
                        <feMergeNode/>
                        <feMergeNode in="SourceGraphic"/>
                      </feMerge>
                    </filter>
                  </defs>
                  
                  <!-- Area fills under lines -->
                  ${Object.entries(paths).map(([key, data]) => {
                    const areaPath = `${data.pathD} L ${plotWidth} ${plotHeight} L 0 ${plotHeight} Z`;
                    return `<path d="${areaPath}" fill="url(#gradient${key.charAt(0).toUpperCase() + key.slice(1)})" opacity="0.5"/>`;
                  }).join('')}
                  
                  <!-- Scenario Lines -->
                  ${Object.entries(scenarioData).map(([key, scenario]) => {
                    const pathData = paths[key];
                    return `
                      <path
                        d="${pathData.pathD}"
                        fill="none"
                        stroke="${scenario.color}"
                        stroke-width="${pathData.isBase ? '4' : '2.5'}"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        filter="${pathData.isBase ? 'url(#dropShadow)' : 'none'}"
                        opacity="${pathData.isBase ? '1' : '0.7'}"
                        style="transition: all 0.3s ease;"
                        class="leverage-path leverage-path-${key}"
                      />
                    `;
                  }).join('')}
                  
                  <!-- Data Points with Hover Effects -->
                  ${Object.entries(scenarioData).map(([key, scenario]) => {
                    const pathData = paths[key];
                    return pathData.points.map((point, i) => `
                      <g class="data-point-group" style="cursor: pointer;">
                        <!-- Hover target (invisible but larger) -->
                        <circle
                          cx="${point.x}"
                          cy="${point.y}"
                          r="12"
                          fill="transparent"
                          style="cursor: pointer;"
                          onmouseover="
                            this.nextElementSibling.setAttribute('r', '7');
                            this.nextElementSibling.style.filter = 'drop-shadow(0 4px 8px rgba(0,0,0,0.2))';
                            document.getElementById('tooltip-${key}-${i}').style.display = 'block';
                          "
                          onmouseout="
                            this.nextElementSibling.setAttribute('r', '${pathData.isBase ? '5' : '4'}');
                            this.nextElementSibling.style.filter = 'none';
                            document.getElementById('tooltip-${key}-${i}').style.display = 'none';
                          "
                        />
                        <!-- Visible point -->
                        <circle
                          cx="${point.x}"
                          cy="${point.y}"
                          r="${pathData.isBase ? '5' : '4'}"
                          fill="${scenario.color}"
                          stroke="white"
                          stroke-width="2"
                          style="transition: all 0.2s ease; pointer-events: none;"
                        />
                      </g>
                    `).join('');
                  }).join('')}
                </svg>
                
                <!-- Tooltips (positioned absolutely) -->
                ${Object.entries(scenarioData).map(([key, scenario]) => {
                  const pathData = paths[key];
                  return pathData.points.map((point, i) => {
                    const xPercent = (point.x / plotWidth) * 100;
                    const yPercent = (point.y / plotHeight) * 100;
                    const alignRight = xPercent > 70;
                    
                    return `
                      <div 
                        id="tooltip-${key}-${i}"
                        style="
                          display: none;
                          position: absolute;
                          left: ${xPercent}%;
                          top: ${yPercent}%;
                          transform: translate(${alignRight ? '-100%' : '10px'}, -50%);
                          background: white;
                          border: 2px solid ${scenario.color};
                          border-radius: 8px;
                          padding: 0.75rem;
                          box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                          z-index: 100;
                          min-width: 180px;
                          pointer-events: none;
                        "
                      >
                        <div style="font-weight: 700; color: ${scenario.color}; margin-bottom: 0.5rem; font-size: 0.85rem;">
                          ${scenario.name} ‚Ä¢ Year ${point.year}
                        </div>
                        <div style="display: grid; gap: 0.4rem; font-size: 0.8rem;">
                          <div style="display: flex; justify-content: space-between; gap: 1rem;">
                            <span style="color: #6b7280;">Net Leverage:</span>
                            <strong style="color: #1f2937;">${point.leverage.toFixed(2)}x</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; gap: 1rem;">
                            <span style="color: #6b7280;">EBITDA:</span>
                            <strong style="color: #1f2937;">$${point.ebitda.toFixed(1)}M</strong>
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('');
                }).join('')}
              </div>
              
              <!-- X-Axis Labels -->
              <div style="display: flex; justify-content: space-between; margin-top: 1rem; padding: 0 0.5rem; font-size: 0.85rem; color: #6b7280; font-weight: 600;">
                ${projections.map(p => `
                  <div style="text-align: center;">
                    <div style="color: #1f2937;">Year ${p.year}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- Legend with Toggle Functionality -->
            <div style="display: flex; gap: 2rem; justify-content: center; margin-top: 2rem; padding: 1.25rem; background: #f9fafb; border-radius: 10px;">
              ${Object.entries(scenarioData).map(([key, scenario]) => {
                const pathData = paths[key];
                return `
                  <div 
                    style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s ease; background: white; border: 2px solid #e5e7eb;"
                    onmouseover="
                      this.style.background = '${scenario.color}10';
                      this.style.borderColor = '${scenario.color}';
                      this.style.transform = 'translateY(-2px)';
                      document.querySelectorAll('.leverage-path-${key}').forEach(el => {
                        el.style.strokeWidth = '${pathData.isBase ? '5' : '4'}';
                        el.style.opacity = '1';
                      });
                    "
                    onmouseout="
                      this.style.background = 'white';
                      this.style.borderColor = '#e5e7eb';
                      this.style.transform = 'translateY(0)';
                      document.querySelectorAll('.leverage-path-${key}').forEach(el => {
                        el.style.strokeWidth = '${pathData.isBase ? '4' : '2.5'}';
                        el.style.opacity = '${pathData.isBase ? '1' : '0.7'}';
                      });
                    "
                  >
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <div style="width: 32px; height: 4px; background: ${scenario.color}; border-radius: 2px;"></div>
                      <span style="font-weight: 600; color: #1f2937; font-size: 0.9rem;">${scenario.name}</span>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-left: 1rem; padding-left: 1rem; border-left: 1px solid #e5e7eb; font-size: 0.85rem;">
                      <div>
                        <span style="color: #6b7280;">Entry:</span>
                        <strong style="color: ${scenario.color}; margin-left: 0.25rem;">${pathData.points[0].leverage.toFixed(1)}x</strong>
                      </div>
                      <div>
                        <span style="color: #6b7280;">Exit:</span>
                        <strong style="color: ${scenario.color}; margin-left: 0.25rem;">${pathData.points[pathData.points.length - 1].leverage.toFixed(1)}x</strong>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            
            <!-- Key Insights Panel -->
            <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
              ${renderDeleveragingInsightCard(
                "Average Deleveraging Rate",
                ((base.transaction.metrics.netLeverage - projections[projections.length - 1].netLeverage) / projections.length).toFixed(2) + "x/year",
                "#6366f1",
                "Debt paydown velocity from operational cash flow"
              )}
              ${renderDeleveragingInsightCard(
                "Total Debt Reduction",
                "$" + (projections[0].totalDebt - projections[projections.length - 1].totalDebt).toFixed(0) + "M",
                "#10b981",
                "Cumulative principal repayment over hold period"
              )}
              ${renderDeleveragingInsightCard(
                "Covenant Headroom (Y1)",
                projections[0].covenantHeadroom.toFixed(2) + "x",
                projections[0].covenantHeadroom > 1 ? "#10b981" : "#f59e0b",
                "Buffer above maximum net leverage covenant"
              )}
            </div>
          </div>
        `;
      }

      function renderDeleveragingInsightCard(title, value, color, description) {
        return `
          <div style="background: white; border: 2px solid ${color}; border-radius: 12px; padding: 1.25rem; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            <div style="display: flex; align-items: start; gap: 1rem;">
              <div style="flex-shrink: 0; width: 48px; height: 48px; background: ${color}; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">${title}</div>
                <div style="font-size: 1.75rem; font-weight: 800; color: ${color}; line-height: 1; margin-bottom: 0.5rem;">${value}</div>
                <div style="font-size: 0.75rem; color: #9ca3af; line-height: 1.4;">${description}</div>
              </div>
            </div>
          </div>
        `;
      }

      function renderIRRSensitivityMatrix(baseScenario, inputs) {
        const entryRange = generateRange(inputs.entryMultiple, 0.5, 7);
        const exitRange = generateRange(inputs.exitMultipleBase, 0.5, 7);
        
        // Pre-calculate all IRR values for the matrix
        const irrMatrix = [];
        let minIRR = Infinity;
        let maxIRR = -Infinity;
        
        entryRange.forEach(entry => {
          const row = [];
          exitRange.forEach(exit => {
            const adjustedInputs = { ...inputs, entryMultiple: entry, exitMultipleBase: exit };
            const transaction = calculateTransaction(adjustedInputs);
            const projections = projectFinancials(adjustedInputs, transaction);
            const returns = calculateReturns(adjustedInputs, transaction, projections);
            const irrValue = returns.irr * 100;
            row.push(irrValue);
            minIRR = Math.min(minIRR, irrValue);
            maxIRR = Math.max(maxIRR, irrValue);
          });
          irrMatrix.push(row);
        });

        return `
          <div>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
              <div>
                <h4 style="font-size: 1.2rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1f2937;">
                  IRR Sensitivity Analysis: Entry Multiple vs Exit Multiple
                </h4>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                  Heat map showing IRR outcomes across valuation scenarios
                </p>
              </div>
              
              <!-- Performance Tier Legend -->
              <div style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); padding: 1rem 1.5rem; border-radius: 10px; border: 2px solid #e5e7eb;">
                <div style="font-size: 0.8rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Performance Tiers</div>
                <div style="display: flex; gap: 0.75rem; align-items: center;">
                  ${renderTierBadge("Top Quartile", "‚â•25%", "#047857", "#d1fae5")}
                  ${renderTierBadge("Target", "20-25%", "#0369a1", "#dbeafe")}
                  ${renderTierBadge("Acceptable", "15-20%", "#7c3aed", "#ede9fe")}
                  ${renderTierBadge("Below Target", "10-15%", "#ea580c", "#fed7aa")}
                  ${renderTierBadge("Poor", "<10%", "#dc2626", "#fecaca")}
                </div>
              </div>
            </div>
            
            <!-- Base Case Reference Banner -->
            <div style="margin-bottom: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; border-left: 5px solid #3b82f6;">
              <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                  <span style="font-weight: 700; color: #1e40af; font-size: 0.95rem;">Base Case Scenario</span>
                </div>
                <div style="display: flex; gap: 2rem; flex: 1;">
                  <div>
                    <span style="color: #3b82f6; font-size: 0.85rem;">Entry Multiple:</span>
                    <strong style="color: #1e3a8a; margin-left: 0.5rem; font-size: 1rem;">${inputs.entryMultiple.toFixed(1)}x</strong>
                  </div>
                  <div>
                    <span style="color: #3b82f6; font-size: 0.85rem;">Exit Multiple:</span>
                    <strong style="color: #1e3a8a; margin-left: 0.5rem; font-size: 1rem;">${inputs.exitMultipleBase.toFixed(1)}x</strong>
                  </div>
                  <div>
                    <span style="color: #3b82f6; font-size: 0.85rem;">IRR:</span>
                    <strong style="color: #1e3a8a; margin-left: 0.5rem; font-size: 1rem;">${baseScenario.returns.irrFormatted}</strong>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Sensitivity Matrix Table -->
            <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
              ${buildEnhancedSensitivityTable(entryRange, exitRange, irrMatrix, inputs)}
            </div>
            
            <!-- Statistical Summary Cards -->
            <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
              ${renderStatCard("Highest IRR", maxIRR.toFixed(1) + "%", "#047857", "Best case scenario")}
              ${renderStatCard("Lowest IRR", minIRR.toFixed(1) + "%", "#dc2626", "Worst case scenario")}
              ${renderStatCard("IRR Range", (maxIRR - minIRR).toFixed(1) + "%", "#6366f1", "Spread of outcomes")}
              ${renderStatCard("Median IRR", calculateMedianIRR(irrMatrix).toFixed(1) + "%", "#0369a1", "50th percentile")}
            </div>
            
            <!-- Key Insights -->
            <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border-left: 5px solid #f59e0b;">
              <div style="display: flex; gap: 1rem; align-items: start;">
                <div style="flex-shrink: 0; width: 40px; height: 40px; background: #f59e0b; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: #92400e; margin-bottom: 0.5rem; font-size: 1rem;">Key Sensitivity Insights</div>
                  <div style="font-size: 0.9rem; color: #78350f; line-height: 1.7;">
                    ${generateSensitivityInsights(irrMatrix, entryRange, exitRange, inputs)}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function buildEnhancedSensitivityTable(rowRange, colRange, irrMatrix, inputs) {
        let html = '<table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; background: white;">';
        
        // Table header with gradient background
        html += '<thead><tr>';
        html += `
          <th style="
            padding: 1rem; 
            font-weight: 700; 
            position: sticky; 
            left: 0; 
            z-index: 20;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
            color: white;
            border-top-left-radius: 12px;
            border-bottom: 2px solid #475569;
          ">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 0.25rem;">Entry EV/EBITDA</div>
              <div style="font-size: 0.9rem;">‚Üì Exit Multiple ‚Üí</div>
            </div>
          </th>
        `;
        
        colRange.forEach((val, idx) => {
          const isLast = idx === colRange.length - 1;
          html += `
            <th style="
              padding: 1rem; 
              text-align: center; 
              font-weight: 700;
              background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
              color: white;
              border-bottom: 2px solid #475569;
              ${isLast ? 'border-top-right-radius: 12px;' : ''}
            ">
              <div style="font-size: 1rem;">${val.toFixed(1)}x</div>
            </th>
          `;
        });
        html += '</tr></thead>';
        
        // Table body
        html += '<tbody>';
        rowRange.forEach((entryMult, rowIdx) => {
          const isLast = rowIdx === rowRange.length - 1;
          html += '<tr style="transition: all 0.2s ease;" onmouseover="this.style.background=\'#f9fafb\';" onmouseout="this.style.background=\'white\';">';
          
          // Row header
          html += `
            <td style="
              padding: 1rem; 
              font-weight: 700; 
              background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
              position: sticky; 
              left: 0; 
              z-index: 10;
              color: #1e293b;
              border-right: 2px solid #e2e8f0;
              ${isLast ? 'border-bottom-left-radius: 12px;' : ''}
            ">
              <div style="text-align: center; font-size: 1rem;">${entryMult.toFixed(1)}x</div>
            </td>
          `;
          
          // Data cells
          colRange.forEach((exitMult, colIdx) => {
            const irrValue = irrMatrix[rowIdx][colIdx];
            const { bgColor, textColor, borderColor } = getIRRCellStyle(irrValue);
            const isBase = Math.abs(entryMult - inputs.entryMultiple) < 0.1 && 
                          Math.abs(exitMult - inputs.exitMultipleBase) < 0.1;
            
            const baseStyle = isBase 
              ? `
                border: 3px solid #3b82f6 !important; 
                box-shadow: inset 0 0 0 2px white, 0 0 0 2px #3b82f6, 0 4px 12px rgba(59, 130, 246, 0.3);
                position: relative;
                z-index: 5;
              ` 
              : `border: 1px solid ${borderColor};`;
            
            html += `
              <td 
                style="
                  padding: 1rem; 
                  text-align: center; 
                  background: ${bgColor}; 
                  color: ${textColor}; 
                  font-weight: 700;
                  font-size: 0.95rem;
                  transition: all 0.2s ease; 
                  cursor: pointer;
                  ${baseStyle}
                  ${isLast && colIdx === colRange.length - 1 ? 'border-bottom-right-radius: 12px;' : ''}
                " 
                onmouseover="
                  this.style.transform='scale(1.08)'; 
                  this.style.zIndex='15';
                  this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)';
                " 
                onmouseout="
                  this.style.transform='scale(1)'; 
                  this.style.zIndex='${isBase ? '5' : '1'}';
                  this.style.boxShadow='${isBase ? 'inset 0 0 0 2px white, 0 0 0 2px #3b82f6, 0 4px 12px rgba(59, 130, 246, 0.3)' : 'none'}';
                "
                title="Entry: ${entryMult.toFixed(1)}x | Exit: ${exitMult.toFixed(1)}x | IRR: ${irrValue.toFixed(1)}%"
              >
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                  <div style="font-size: 1.1rem; font-weight: 800;">${irrValue.toFixed(1)}%</div>
                  ${isBase ? `<div style="font-size: 0.65rem; opacity: 0.9; font-weight: 600; background: rgba(255,255,255,0.3); padding: 0.15rem 0.5rem; border-radius: 10px;">BASE</div>` : ''}
                </div>
              </td>
            `;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
        
        return html;
      }

      function getIRRCellStyle(irrValue) {
        // Performance tier colors
        if (irrValue >= 25) {
          return {
            bgColor: 'linear-gradient(135deg, #047857 0%, #059669 100%)',
            textColor: 'white',
            borderColor: '#065f46'
          };
        } else if (irrValue >= 20) {
          return {
            bgColor: 'linear-gradient(135deg, #0369a1 0%, #0284c7 100%)',
            textColor: 'white',
            borderColor: '#075985'
          };
        } else if (irrValue >= 15) {
          return {
            bgColor: 'linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%)',
            textColor: 'white',
            borderColor: '#6d28d9'
          };
        } else if (irrValue >= 10) {
          return {
            bgColor: 'linear-gradient(135deg, #ea580c 0%, #f97316 100%)',
            textColor: 'white',
            borderColor: '#c2410c'
          };
        } else {
          return {
            bgColor: 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)',
            textColor: 'white',
            borderColor: '#b91c1c'
          };
        }
      }

      function renderTierBadge(label, range, color, bgColor) {
        return `
          <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
            <div style="
              padding: 0.35rem 0.75rem; 
              background: ${bgColor}; 
              border: 2px solid ${color};
              border-radius: 6px; 
              font-size: 0.75rem; 
              font-weight: 700;
              color: ${color};
              white-space: nowrap;
            ">
              ${range}
            </div>
            <div style="font-size: 0.7rem; color: #6b7280; text-align: center;">${label}</div>
          </div>
        `;
      }

      function renderStatCard(title, value, color, subtitle) {
        return `
          <div style="
            background: white; 
            border: 2px solid ${color}; 
            border-radius: 12px; 
            padding: 1.25rem;
            transition: all 0.3s ease;
          " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">
              ${title}
            </div>
            <div style="font-size: 2rem; font-weight: 800; color: ${color}; line-height: 1; margin-bottom: 0.5rem;">
              ${value}
            </div>
            <div style="font-size: 0.75rem; color: #9ca3af;">
              ${subtitle}
            </div>
          </div>
        `;
      }

      function calculateMedianIRR(matrix) {
        const allValues = matrix.flat().sort((a, b) => a - b);
        const mid = Math.floor(allValues.length / 2);
        return allValues.length % 2 === 0 
          ? (allValues[mid - 1] + allValues[mid]) / 2 
          : allValues[mid];
      }

      function generateSensitivityInsights(irrMatrix, entryRange, exitRange, inputs) {
        const allIRRs = irrMatrix.flat();
        const targetMetIRRs = allIRRs.filter(irr => irr >= 20);
        const targetMetPercentage = ((targetMetIRRs.length / allIRRs.length) * 100).toFixed(0);
        
        // Find the break-even exit multiple at base entry
        const baseEntryIdx = entryRange.findIndex(e => Math.abs(e - inputs.entryMultiple) < 0.1);
        let breakEvenExitMultiple = null;
        if (baseEntryIdx >= 0) {
          for (let i = 0; i < exitRange.length; i++) {
            if (irrMatrix[baseEntryIdx][i] >= 20) {
              breakEvenExitMultiple = exitRange[i];
              break;
            }
          }
        }
        
        const insights = [];
        
        insights.push(`<strong>${targetMetPercentage}%</strong> of valuation scenarios meet the 20% IRR hurdle rate.`);
        
        if (breakEvenExitMultiple) {
          insights.push(`At the base entry multiple of <strong>${inputs.entryMultiple.toFixed(1)}x</strong>, the deal requires a minimum exit multiple of <strong>${breakEvenExitMultiple.toFixed(1)}x</strong> to achieve target returns.`);
        }
        
        const baseIRR = parseFloat(inputs.exitMultipleBase) >= parseFloat(inputs.entryMultiple)
          ? "Entry multiple compression is offset by operational improvements and deleveraging."
          : "Multiple expansion is a critical driver of returns in this transaction.";
        insights.push(baseIRR);
        
        return insights.join(' ');
      }

      function renderMOICSensitivityMatrix(baseScenario, inputs) {
        const entryRange = generateRange(inputs.entryMultiple, 0.5, 7);
        const exitRange = generateRange(inputs.exitMultipleBase, 0.5, 7);
        
        // Pre-calculate all MOIC values
        const moicMatrix = [];
        let minMOIC = Infinity;
        let maxMOIC = -Infinity;
        
        entryRange.forEach(entry => {
          const row = [];
          exitRange.forEach(exit => {
            const adjustedInputs = { ...inputs, entryMultiple: entry, exitMultipleBase: exit };
            const transaction = calculateTransaction(adjustedInputs);
            const projections = projectFinancials(adjustedInputs, transaction);
            const returns = calculateReturns(adjustedInputs, transaction, projections);
            const moicValue = parseFloat(returns.moic);
            row.push(moicValue);
            minMOIC = Math.min(minMOIC, moicValue);
            maxMOIC = Math.max(maxMOIC, moicValue);
          });
          moicMatrix.push(row);
        });

        return `
          <div>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
              <div>
                <h4 style="font-size: 1.2rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1f2937;">
                  MOIC Sensitivity Analysis: Entry Multiple vs Exit Multiple
                </h4>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                  Cash-on-Cash return multiple across valuation scenarios
                </p>
              </div>
              
              <!-- Performance Tier Legend for MOIC -->
              <div style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); padding: 1rem 1.5rem; border-radius: 10px; border: 2px solid #e5e7eb;">
                <div style="font-size: 0.8rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">MOIC Tiers</div>
                <div style="display: flex; gap: 0.75rem; align-items: center;">
                  ${renderTierBadge("Excellent", "‚â•3.0x", "#047857", "#d1fae5")}
                  ${renderTierBadge("Strong", "2.5-3.0x", "#0369a1", "#dbeafe")}
                  ${renderTierBadge("Target", "2.0-2.5x", "#7c3aed", "#ede9fe")}
                  ${renderTierBadge("Below Target", "1.5-2.0x", "#ea580c", "#fed7aa")}
                  ${renderTierBadge("Poor", "<1.5x", "#dc2626", "#fecaca")}
                </div>
              </div>
            </div>
            
            <!-- Base Case Reference -->
            <div style="margin-bottom: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; border-left: 5px solid #3b82f6;">
              <div style="display: flex; align-items: center; gap: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                  <span style="font-weight: 700; color: #1e40af; font-size: 0.95rem;">Base Case Scenario</span>
                </div>
                <div style="display: flex; gap: 2rem;">
                  <div>
                    <span style="color: #3b82f6; font-size: 0.85rem;">MOIC:</span>
                    <strong style="color: #1e3a8a; margin-left: 0.5rem; font-size: 1rem;">${baseScenario.returns.moic}</strong>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- MOIC Matrix Table -->
            <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
              ${buildMOICSensitivityTable(entryRange, exitRange, moicMatrix, inputs)}
            </div>
            
            <!-- Statistical Summary -->
            <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
              ${renderStatCard("Highest MOIC", maxMOIC.toFixed(2) + "x", "#047857", "Best case scenario")}
              ${renderStatCard("Lowest MOIC", minMOIC.toFixed(2) + "x", "#dc2626", "Worst case scenario")}
              ${renderStatCard("MOIC Range", (maxMOIC - minMOIC).toFixed(2) + "x", "#6366f1", "Spread of outcomes")}
              ${renderStatCard("Target Met", calculateTargetMetPercentage(moicMatrix, 2.5).toFixed(0) + "%", "#0369a1", "Scenarios ‚â•2.5x")}
            </div>
          </div>
        `;
      }

      function buildMOICSensitivityTable(rowRange, colRange, moicMatrix, inputs) {
        let html = '<table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; background: white;">';
        
        // Header
        html += '<thead><tr>';
        html += `
          <th style="padding: 1rem; font-weight: 700; position: sticky; left: 0; z-index: 20; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; border-top-left-radius: 12px; border-bottom: 2px solid #475569;">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 0.25rem;">Entry EV/EBITDA</div>
              <div style="font-size: 0.9rem;">‚Üì Exit Multiple ‚Üí</div>
            </div>
          </th>
        `;
        
        colRange.forEach((val, idx) => {
          const isLast = idx === colRange.length - 1;
          html += `<th style="padding: 1rem; text-align: center; font-weight: 700; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; border-bottom: 2px solid #475569; ${isLast ? 'border-top-right-radius: 12px;' : ''}"><div style="font-size: 1rem;">${val.toFixed(1)}x</div></th>`;
        });
        html += '</tr></thead>';
        
        // Body
        html += '<tbody>';
        rowRange.forEach((entryMult, rowIdx) => {
          const isLast = rowIdx === rowRange.length - 1;
          html += '<tr style="transition: all 0.2s ease;" onmouseover="this.style.background=\'#f9fafb\';" onmouseout="this.style.background=\'white\';">';
          html += `<td style="padding: 1rem; font-weight: 700; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); position: sticky; left: 0; z-index: 10; color: #1e293b; border-right: 2px solid #e2e8f0; ${isLast ? 'border-bottom-left-radius: 12px;' : ''}"><div style="text-align: center; font-size: 1rem;">${entryMult.toFixed(1)}x</div></td>`;
          
          colRange.forEach((exitMult, colIdx) => {
            const moicValue = moicMatrix[rowIdx][colIdx];
            const { bgColor, textColor, borderColor } = getMOICCellStyle(moicValue);
            const isBase = Math.abs(entryMult - inputs.entryMultiple) < 0.1 && Math.abs(exitMult - inputs.exitMultipleBase) < 0.1;
            const baseStyle = isBase ? `border: 3px solid #3b82f6 !important; box-shadow: inset 0 0 0 2px white, 0 0 0 2px #3b82f6, 0 4px 12px rgba(59, 130, 246, 0.3); position: relative; z-index: 5;` : `border: 1px solid ${borderColor};`;
            
            html += `
              <td style="padding: 1rem; text-align: center; background: ${bgColor}; color: ${textColor}; font-weight: 700; font-size: 0.95rem; transition: all 0.2s ease; cursor: pointer; ${baseStyle} ${isLast && colIdx === colRange.length - 1 ? 'border-bottom-right-radius: 12px;' : ''}" 
              onmouseover="this.style.transform='scale(1.08)'; this.style.zIndex='15'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)';" 
              onmouseout="this.style.transform='scale(1)'; this.style.zIndex='${isBase ? '5' : '1'}'; this.style.boxShadow='${isBase ? 'inset 0 0 0 2px white, 0 0 0 2px #3b82f6, 0 4px 12px rgba(59, 130, 246, 0.3)' : 'none'}';"
              title="Entry: ${entryMult.toFixed(1)}x | Exit: ${exitMult.toFixed(1)}x | MOIC: ${moicValue.toFixed(2)}x">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                  <div style="font-size: 1.1rem; font-weight: 800;">${moicValue.toFixed(2)}x</div>
                  ${isBase ? `<div style="font-size: 0.65rem; opacity: 0.9; font-weight: 600; background: rgba(255,255,255,0.3); padding: 0.15rem 0.5rem; border-radius: 10px;">BASE</div>` : ''}
                </div>
              </td>
            `;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
        
        return html;
      }

      function getMOICCellStyle(moicValue) {
        if (moicValue >= 3.0) {
          return {
            bgColor: 'linear-gradient(135deg, #047857 0%, #059669 100%)',
            textColor: 'white',
            borderColor: '#065f46'
          };
        } else if (moicValue >= 2.5) {
          return {
            bgColor: 'linear-gradient(135deg, #0369a1 0%, #0284c7 100%)',
            textColor: 'white',
            borderColor: '#075985'
          };
        } else if (moicValue >= 2.0) {
          return {
            bgColor: 'linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%)',
            textColor: 'white',
            borderColor: '#6d28d9'
          };
        } else if (moicValue >= 1.5) {
          return {
            bgColor: 'linear-gradient(135deg, #ea580c 0%, #f97316 100%)',
            textColor: 'white',
            borderColor: '#c2410c'
          };
        } else {
          return {
            bgColor: 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)',
            textColor: 'white',
            borderColor: '#b91c1c'
          };
        }
      }

      function calculateTargetMetPercentage(matrix, threshold) {
        const allValues = matrix.flat();
        const targetMet = allValues.filter(v => v >= threshold);
        return (targetMet.length / allValues.length) * 100;
      }

      function renderEVSensitivityMatrix(baseScenario, inputs) {
        const ebitdaGrowthRange = generateRange(inputs.revenueGrowthSteady * 100, 1, 7);
        const exitMultipleRange = generateRange(inputs.exitMultipleBase, 0.5, 7);
        
        // Pre-calculate all Exit EV values
        const evMatrix = [];
        let minEV = Infinity;
        let maxEV = -Infinity;
        
        ebitdaGrowthRange.forEach(growth => {
          const row = [];
          exitMultipleRange.forEach(multiple => {
            const exitEBITDA = inputs.ltmEBITDA * Math.pow(1 + growth/100, inputs.holdPeriod);
            const exitEV = exitEBITDA * multiple;
            row.push(exitEV);
            minEV = Math.min(minEV, exitEV);
            maxEV = Math.max(maxEV, exitEV);
          });
          evMatrix.push(row);
        });

        return `
          <div>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
              <div>
                <h4 style="font-size: 1.2rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1f2937;">
                  Exit Enterprise Value Sensitivity: EBITDA Growth vs Exit Multiple
                </h4>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                  Terminal value scenarios based on operational performance and market conditions
                </p>
              </div>
              
              <!-- EV Range Summary -->
              <div style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); padding: 1rem 1.5rem; border-radius: 10px; border: 2px solid #e5e7eb;">
                <div style="font-size: 0.8rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Exit EV Range</div>
                <div style="display: flex; gap: 1.5rem; align-items: center;">
                  <div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Minimum</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #dc2626;">$${minEV.toFixed(0)}M</div>
                  </div>
                  <div style="width: 2px; height: 40px; background: #e5e7eb;"></div>
                  <div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Maximum</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #047857;">$${maxEV.toFixed(0)}M</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Base Case Reference -->
            <div style="margin-bottom: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; border-left: 5px solid #3b82f6;">
              <div style="display: flex; align-items: center; gap: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                  <span style="font-weight: 700; color: #1e40af; font-size: 0.95rem;">Base Case Exit</span>
                </div>
                <div style="display: flex; gap: 2rem;">
                  <div>
                    <span style="color: #3b82f6; font-size: 0.85rem;">Exit EV:</span>
                    <strong style="color: #1e3a8a; margin-left: 0.5rem; font-size: 1rem;">$${baseScenario.returns.exitEV}M</strong>
                  </div>
                  <div>
                    <span style="color: #3b82f6; font-size: 0.85rem;">Exit EBITDA:</span>
                    <strong style="color: #1e3a8a; margin-left: 0.5rem; font-size: 1rem;">$${baseScenario.returns.exitEBITDA}M</strong>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- EV Sensitivity Matrix -->
            <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
              ${buildEVSensitivityTableEnhanced(ebitdaGrowthRange, exitMultipleRange, evMatrix, inputs, baseScenario)}
            </div>
            
            <!-- Key Valuation Insights -->
            <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border-left: 5px solid #f59e0b;">
              <div style="display: flex; gap: 1rem; align-items: start;">
                <div style="flex-shrink: 0; width: 40px; height: 40px; background: #f59e0b; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: #92400e; margin-bottom: 0.5rem; font-size: 1rem;">Valuation Sensitivity Insights</div>
                  <div style="font-size: 0.9rem; color: #78350f; line-height: 1.7;">
                    Exit value ranges from <strong>$${minEV.toFixed(0)}M</strong> (worst case) to <strong>$${maxEV.toFixed(0)}M</strong> (best case), 
                    representing a <strong>${((maxEV - minEV) / minEV * 100).toFixed(0)}%</strong> variance. 
                    The base case exit EV of <strong>$${baseScenario.returns.exitEV}M</strong> assumes ${(inputs.revenueGrowthSteady * 100).toFixed(1)}% 
                    annual EBITDA growth and a ${inputs.exitMultipleBase.toFixed(1)}x exit multiple.
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function buildEVSensitivityTableEnhanced(growthRange, multipleRange, evMatrix, inputs, baseScenario) {
        const baseGrowth = inputs.revenueGrowthSteady * 100;
        const baseMultiple = inputs.exitMultipleBase;
        
        let html = '<table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; background: white;">';
        
        // Header
        html += '<thead><tr>';
        html += `
          <th style="padding: 1rem; font-weight: 700; position: sticky; left: 0; z-index: 20; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; border-top-left-radius: 12px; border-bottom: 2px solid #475569;">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 0.25rem;">EBITDA Growth (CAGR)</div>
              <div style="font-size: 0.9rem;">‚Üì Exit Multiple ‚Üí</div>
            </div>
          </th>
        `;
        
        multipleRange.forEach((val, idx) => {
          const isLast = idx === multipleRange.length - 1;
          html += `<th style="padding: 1rem; text-align: center; font-weight: 700; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; border-bottom: 2px solid #475569; ${isLast ? 'border-top-right-radius: 12px;' : ''}"><div style="font-size: 1rem;">${val.toFixed(1)}x</div></th>`;
        });
        html += '</tr></thead>';
        
        // Body
        html += '<tbody>';
        growthRange.forEach((growth, rowIdx) => {
          const isLast = rowIdx === growthRange.length - 1;
          html += '<tr style="transition: all 0.2s ease;" onmouseover="this.style.background=\'#f9fafb\';" onmouseout="this.style.background=\'white\';">';
          html += `<td style="padding: 1rem; font-weight: 700; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); position: sticky; left: 0; z-index: 10; color: #1e293b; border-right: 2px solid #e2e8f0; ${isLast ? 'border-bottom-left-radius: 12px;' : ''}"><div style="text-align: center; font-size: 1rem;">${growth.toFixed(1)}%</div></td>`;
          
          multipleRange.forEach((multiple, colIdx) => {
            const evValue = evMatrix[rowIdx][colIdx];
            const { bgColor, textColor, borderColor } = getEVCellStyleEnhanced(evValue);
            const isBase = Math.abs(growth - baseGrowth) < 0.5 && Math.abs(multiple - baseMultiple) < 0.3;
            const baseStyle = isBase ? `border: 3px solid #3b82f6 !important; box-shadow: inset 0 0 0 2px white, 0 0 0 2px #3b82f6, 0 4px 12px rgba(59, 130, 246, 0.3); position: relative; z-index: 5;` : `border: 1px solid ${borderColor};`;
            
            html += `
              <td style="padding: 1rem; text-align: center; background: ${bgColor}; color: ${textColor}; font-weight: 700; font-size: 0.95rem; transition: all 0.2s ease; cursor: pointer; ${baseStyle} ${isLast && colIdx === multipleRange.length - 1 ? 'border-bottom-right-radius: 12px;' : ''}" 
              onmouseover="this.style.transform='scale(1.08)'; this.style.zIndex='15'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)';" 
              onmouseout="this.style.transform='scale(1)'; this.style.zIndex='${isBase ? '5' : '1'}'; this.style.boxShadow='${isBase ? 'inset 0 0 0 2px white, 0 0 0 2px #3b82f6, 0 4px 12px rgba(59, 130, 246, 0.3)' : 'none'}';"
              title="Growth: ${growth.toFixed(1)}% | Multiple: ${multiple.toFixed(1)}x | Exit EV: $${evValue.toFixed(0)}M">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                  <div style="font-size: 1.1rem; font-weight: 800;">$${evValue.toFixed(0)}M</div>
                  ${isBase ? `<div style="font-size: 0.65rem; opacity: 0.9; font-weight: 600; background: rgba(255,255,255,0.3); padding: 0.15rem 0.5rem; border-radius: 10px;">BASE</div>` : ''}
                </div>
              </td>
            `;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';
        
        return html;
      }

      function getEVCellStyleEnhanced(evValue) {
        // Color scale based on exit value magnitude
        if (evValue >= 1500) {
          return {
            bgColor: 'linear-gradient(135deg, #047857 0%, #059669 100%)',
            textColor: 'white',
            borderColor: '#065f46'
          };
        } else if (evValue >= 1200) {
          return {
            bgColor: 'linear-gradient(135deg, #0369a1 0%, #0284c7 100%)',
            textColor: 'white',
            borderColor: '#075985'
          };
        } else if (evValue >= 1000) {
          return {
            bgColor: 'linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%)',
            textColor: 'white',
            borderColor: '#6d28d9'
          };
        } else if (evValue >= 800) {
          return {
            bgColor: 'linear-gradient(135deg, #ea580c 0%, #f97316 100%)',
            textColor: 'white',
            borderColor: '#c2410c'
          };
        } else {
          return {
            bgColor: 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)',
            textColor: 'white',
            borderColor: '#b91c1c'
          };
        }
      }

      function renderCreditTimeline(baseScenario) {
        const projections = baseScenario.projections;

        return `
          <div>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
              <div>
                <h4 style="font-size: 1.2rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1f2937;">
                  Credit Metrics Timeline (Base Case)
                </h4>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                  Evolution of leverage ratios and debt service coverage over hold period
                </p>
              </div>
              
              <!-- Key Credit Metrics Summary -->
              <div style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); padding: 1rem 1.5rem; border-radius: 10px; border: 2px solid #e5e7eb;">
                <div style="font-size: 0.8rem; font-weight: 600; color: #374151; margin-bottom: 0.75rem;">Deleveraging Profile</div>
                <div style="display: flex; gap: 1.5rem;">
                  <div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Starting Leverage</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #ef4444;">${projections[0].netLeverage.toFixed(2)}x</div>
                  </div>
                  <div style="width: 2px; height: 40px; background: linear-gradient(to bottom, #ef4444, #10b981);"></div>
                  <div>
                    <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Ending Leverage</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #10b981;">${projections[projections.length - 1].netLeverage.toFixed(2)}x</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Credit Metrics Table -->
            <div style="overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
              <table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; background: white;">
                <thead>
                  <tr style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white;">
                    <th style="padding: 0.75rem; text-align: left; font-weight: 700; border-top-left-radius: 12px;">Year</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 700;">EBITDA ($M)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 700;">Total Debt ($M)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 700;">Net Debt ($M)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 700;">Net Leverage (x)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 700;">Interest Coverage (x)</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 700; border-top-right-radius: 12px;">Debt Paydown ($M)</th>
                  </tr>
                </thead>
                <tbody>
                  ${projections.map((p, i) => {
                    const interestCoverage = p.cashInterest > 0 ? (p.ebitda / p.cashInterest).toFixed(2) : 'N/A';
                    const debtPaydown = i > 0 ? (projections[i-1].totalDebt - p.totalDebt).toFixed(1) : '-';
                    const leverageColor = getCreditRatingColor(p.netLeverage);
                    const isLast = i === projections.length - 1;
                    
                    return `
                      <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                        <td style="padding: 0.75rem; font-weight: 700; color: #1f2937; ${isLast ? 'border-bottom-left-radius: 12px;' : ''}">Year ${p.year}</td>
                        <td style="padding: 0.75rem; text-align: right; color: #374151;">$${p.ebitda.toFixed(1)}</td>
                        <td style="padding: 0.75rem; text-align: right; color: #374151;">$${p.totalDebt.toFixed(1)}</td>
                        <td style="padding: 0.75rem; text-align: right; color: #374151;">$${p.netDebt.toFixed(1)}</td>
                        <td style="padding: 0.75rem; text-align: right; font-weight: 700;">
                          <span style="display: inline-block; padding: 0.25rem 0.75rem; background: ${leverageColor}20; color: ${leverageColor}; border-radius: 6px; font-weight: 800;">
                            ${p.netLeverage.toFixed(2)}x
                          </span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right; color: #374151; font-weight: 600;">${interestCoverage}x</td>
                        <td style="padding: 0.75rem; text-align: right; font-weight: 700; ${isLast ? 'border-bottom-right-radius: 12px;' : ''}">
                          <span style="color: ${debtPaydown !== '-' ? '#10b981' : '#6b7280'};">${debtPaydown !== '-' ? '$' + debtPaydown : debtPaydown}</span>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- Credit Performance KPI Cards -->
            <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
              ${renderCreditKPICard(
                "Average Net Leverage",
                calculateAverage(projections, 'netLeverage').toFixed(2) + 'x',
                "#6366f1",
                "Mean leverage across hold period"
              )}
              ${renderCreditKPICard(
                "Total Debt Reduction",
                "$" + (projections[0].totalDebt - projections[projections.length - 1].totalDebt).toFixed(0) + "M",
                "#10b981",
                "Cumulative principal repayment"
              )}
              ${renderCreditKPICard(
                "Deleveraging Rate",
                ((projections[0].netLeverage - projections[projections.length - 1].netLeverage) / projections.length).toFixed(2) + "x/yr",
                "#f59e0b",
                "Annual leverage reduction pace"
              )}
              ${renderCreditKPICard(
                "Covenant Headroom (Y1)",
                projections[0].covenantHeadroom > 0 ? projections[0].covenantHeadroom.toFixed(2) + "x" : "BREACH",
                projections[0].covenantHeadroom > 1 ? "#10b981" : "#ef4444",
                "Buffer above max leverage covenant"
              )}
            </div>
          </div>
        `;
      }

      function getCreditRatingColor(leverage) {
        if (leverage > 6) return '#dc2626'; // High risk - Red
        if (leverage > 4.5) return '#ea580c'; // Moderate-high risk - Orange
        if (leverage > 3) return '#f59e0b'; // Moderate risk - Amber
        return '#10b981'; // Low risk - Green
      }

      function renderCreditKPICard(title, value, color, description) {
        return `
          <div style="
            background: white; 
            border: 2px solid ${color}; 
            border-radius: 12px; 
            padding: 1.25rem;
            transition: all 0.3s ease;
            cursor: default;
          " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            <div style="display: flex; align-items: start; gap: 1rem;">
              <div style="flex-shrink: 0; width: 48px; height: 48px; background: ${color}; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">${title}</div>
                <div style="font-size: 1.75rem; font-weight: 800; color: ${color}; line-height: 1; margin-bottom: 0.5rem; word-break: break-word;">${value}</div>
                <div style="font-size: 0.75rem; color: #9ca3af; line-height: 1.4;">${description}</div>
              </div>
            </div>
          </div>
        `;
      }

      function renderSourcesUsesWaterfall(scenario) {
        const { transaction } = scenario;
        const { sources, uses } = transaction;
        
        // Calculate percentages for visualization
        const totalSources = sources.totalSources;
        
        // Sources breakdown
        const sourcesData = [
          { 
            label: 'Revolver', 
            value: sources.newDebt.revolver, 
            pct: (sources.newDebt.revolver / totalSources * 100).toFixed(1),
            color: '#3b82f6'
          },
          { 
            label: 'Term Loan B', 
            value: sources.newDebt.tlb, 
            pct: (sources.newDebt.tlb / totalSources * 100).toFixed(1),
            color: '#6366f1'
          },
          { 
            label: 'Mezzanine', 
            value: sources.newDebt.mezz, 
            pct: (sources.newDebt.mezz / totalSources * 100).toFixed(1),
            color: '#8b5cf6'
          },
          { 
            label: 'Sponsor Equity', 
            value: sources.equity.sponsorCheck, 
            pct: (sources.equity.sponsorCheck / totalSources * 100).toFixed(1),
            color: '#10b981'
          },
          { 
            label: 'Mgmt Rollover', 
            value: sources.equity.mgmtRollover, 
            pct: (sources.equity.mgmtRollover / totalSources * 100).toFixed(1),
            color: '#059669'
          },
          { 
            label: 'Excess Cash', 
            value: sources.cash.excessUsed, 
            pct: (sources.cash.excessUsed / totalSources * 100).toFixed(1),
            color: '#fbbf24'
          }
        ].filter(item => item.value > 0.01); // Only show items > $10k

        // Uses breakdown
        const totalUses = uses.totalUses;
        const usesData = [
          { 
            label: 'Equity Purchase', 
            value: uses.buyEquity, 
            pct: (uses.buyEquity / totalUses * 100).toFixed(1),
            color: '#ef4444'
          },
          { 
            label: 'Debt Refinancing', 
            value: uses.refiDebt, 
            pct: (uses.refiDebt / totalUses * 100).toFixed(1),
            color: '#f97316'
          },
          { 
            label: 'Financing Fees', 
            value: uses.fees.financing, 
            pct: (uses.fees.financing / totalUses * 100).toFixed(1),
            color: '#fb923c'
          },
          { 
            label: 'Advisory Fees', 
            value: uses.fees.advisory, 
            pct: (uses.fees.advisory / totalUses * 100).toFixed(1),
            color: '#fdba74'
          },
          { 
            label: 'Min Cash to B/S', 
            value: uses.minCash, 
            pct: (uses.minCash / totalUses * 100).toFixed(1),
            color: '#fcd34d'
          }
        ].filter(item => item.value > 0.01);

        return `
          <div style="background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
            
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
              <div>
                <h3 style="font-size: 1.3rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/>
                    <line x1="12" y1="17" x2="12" y2="21"/>
                  </svg>
                  Transaction Structure: Sources & Uses
                </h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Capital stack composition and deployment waterfall</p>
              </div>
              
              <!-- Transaction Summary Box -->
              <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 1rem 1.5rem; border-radius: 10px; border: 2px solid #3b82f6;">
                <div style="font-size: 0.8rem; color: #1e40af; margin-bottom: 0.5rem; font-weight: 600;">Total Transaction Size</div>
                <div style="font-size: 1.75rem; font-weight: 800; color: #1e3a8a;">$${totalSources.toFixed(1)}M</div>
                <div style="font-size: 0.75rem; color: #3b82f6; margin-top: 0.25rem;">
                  EV/EBITDA: ${transaction.valuation.purchaseEV.toFixed(0)}M / ${transaction.valuation.ltmEBITDA.toFixed(0)}M = 
                  <strong>${(transaction.valuation.purchaseEV / transaction.valuation.ltmEBITDA).toFixed(1)}x</strong>
                </div>
              </div>
            </div>

            <!-- Dual Waterfall Layout -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
              
              <!-- SOURCES Waterfall -->
              <div>
                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1rem; border-radius: 10px 10px 0 0; border: 2px solid #3b82f6; border-bottom: none;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="margin: 0; color: #1e3a8a; font-size: 1rem; font-weight: 700;">SOURCES OF FUNDS</h4>
                    <div style="background: white; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 700; color: #1e3a8a;">
                      $${totalSources.toFixed(1)}M
                    </div>
                  </div>
                </div>
                
                <!-- Sources Waterfall Bars -->
                <div style="background: linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%); border: 2px solid #3b82f6; border-top: none; border-radius: 0 0 10px 10px; padding: 1.5rem;">
                  <div style="display: flex; flex-direction: column; gap: 0.5rem; height: 400px; justify-content: flex-end;">
                    ${sourcesData.map((item, idx) => {
                      const heightPct = parseFloat(item.pct);
                      return `
                        <div 
                          style="
                            background: linear-gradient(135deg, ${item.color} 0%, ${adjustColorBrightness(item.color, -20)} 100%);
                            height: ${heightPct}%;
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: 700;
                            font-size: 0.85rem;
                            transition: all 0.3s ease;
                            cursor: pointer;
                            position: relative;
                            box-shadow: 0 2px 8px ${item.color}40;
                          "
                          onmouseover="
                            this.style.transform='scaleY(1.05) translateY(-2px)';
                            this.style.zIndex='10';
                            this.style.boxShadow='0 8px 24px ${item.color}60';
                            this.querySelector('.tooltip-sources-${idx}').style.display='block';
                          "
                          onmouseout="
                            this.style.transform='scaleY(1) translateY(0)';
                            this.style.zIndex='1';
                            this.style.boxShadow='0 2px 8px ${item.color}40';
                            this.querySelector('.tooltip-sources-${idx}').style.display='none';
                          "
                        >
                          <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                            <div style="font-size: 0.95rem; font-weight: 800;">$${item.value.toFixed(1)}M</div>
                            <div style="font-size: 0.7rem; opacity: 0.95;">${item.label}</div>
                            <div style="font-size: 0.65rem; background: rgba(255,255,255,0.25); padding: 0.15rem 0.5rem; border-radius: 10px;">
                              ${item.pct}%
                            </div>
                          </div>
                          
                          <!-- Tooltip -->
                          <div class="tooltip-sources-${idx}" style="
                            display: none;
                            position: absolute;
                            left: 105%;
                            top: 50%;
                            transform: translateY(-50%);
                            background: white;
                            border: 2px solid ${item.color};
                            border-radius: 8px;
                            padding: 0.75rem;
                            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                            z-index: 100;
                            min-width: 180px;
                            pointer-events: none;
                          ">
                            <div style="font-weight: 700; color: ${item.color}; margin-bottom: 0.5rem; font-size: 0.85rem;">
                              ${item.label}
                            </div>
                            <div style="display: grid; gap: 0.4rem; font-size: 0.8rem; color: #1f2937;">
                              <div style="display: flex; justify-content: space-between; gap: 1rem;">
                                <span style="color: #6b7280;">Amount:</span>
                                <strong>$${item.value.toFixed(2)}M</strong>
                              </div>
                              <div style="display: flex; justify-content: space-between; gap: 1rem;">
                                <span style="color: #6b7280;">% of Total:</span>
                                <strong>${item.pct}%</strong>
                              </div>
                              ${item.label.includes('Loan') || item.label.includes('Mezz') || item.label.includes('Revolver') ? `
                                <div style="display: flex; justify-content: space-between; gap: 1rem; padding-top: 0.4rem; border-top: 1px solid #e5e7eb;">
                                  <span style="color: #6b7280;">Type:</span>
                                  <strong style="color: ${item.color};">Debt</strong>
                                </div>
                              ` : ''}
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                  
                  <!-- Sources Legend -->
                  <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.8rem;">
                      <div style="background: #eff6ff; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #3b82f6;">
                        <div style="color: #6b7280; margin-bottom: 0.25rem;">Total Debt</div>
                        <div style="font-weight: 800; color: #1e3a8a; font-size: 1.1rem;">$${sources.newDebt.total.toFixed(1)}M</div>
                        <div style="font-size: 0.7rem; color: #3b82f6; margin-top: 0.25rem;">
                          ${(sources.newDebt.total / totalSources * 100).toFixed(1)}% of sources
                        </div>
                      </div>
                      <div style="background: #f0fdf4; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #10b981;">
                        <div style="color: #6b7280; margin-bottom: 0.25rem;">Total Equity</div>
                        <div style="font-weight: 800; color: #065f46; font-size: 1.1rem;">$${sources.equity.totalRequired.toFixed(1)}M</div>
                        <div style="font-size: 0.7rem; color: #10b981; margin-top: 0.25rem;">
                          ${(sources.equity.totalRequired / totalSources * 100).toFixed(1)}% of sources
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- USES Waterfall -->
              <div>
                <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 1rem; border-radius: 10px 10px 0 0; border: 2px solid #ef4444; border-bottom: none;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 style="margin: 0; color: #7f1d1d; font-size: 1rem; font-weight: 700;">USES OF FUNDS</h4>
                    <div style="background: white; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 700; color: #7f1d1d;">
                      $${totalUses.toFixed(1)}M
                    </div>
                  </div>
                </div>
                
                <!-- Uses Waterfall Bars -->
                <div style="background: linear-gradient(to bottom, #fef2f2 0%, #ffffff 100%); border: 2px solid #ef4444; border-top: none; border-radius: 0 0 10px 10px; padding: 1.5rem;">
                  <div style="display: flex; flex-direction: column; gap: 0.5rem; height: 400px; justify-content: flex-end;">
                    ${usesData.map((item, idx) => {
                      const heightPct = parseFloat(item.pct);
                      return `
                        <div 
                          style="
                            background: linear-gradient(135deg, ${item.color} 0%, ${adjustColorBrightness(item.color, -20)} 100%);
                            height: ${heightPct}%;
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: 700;
                            font-size: 0.85rem;
                            transition: all 0.3s ease;
                            cursor: pointer;
                            position: relative;
                            box-shadow: 0 2px 8px ${item.color}40;
                          "
                          onmouseover="
                            this.style.transform='scaleY(1.05) translateY(-2px)';
                            this.style.zIndex='10';
                            this.style.boxShadow='0 8px 24px ${item.color}60';
                            this.querySelector('.tooltip-uses-${idx}').style.display='block';
                          "
                          onmouseout="
                            this.style.transform='scaleY(1) translateY(0)';
                            this.style.zIndex='1';
                            this.style.boxShadow='0 2px 8px ${item.color}40';
                            this.querySelector('.tooltip-uses-${idx}').style.display='none';
                          "
                        >
                          <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                            <div style="font-size: 0.95rem; font-weight: 800;">$${item.value.toFixed(1)}M</div>
                            <div style="font-size: 0.7rem; opacity: 0.95;">${item.label}</div>
                            <div style="font-size: 0.65rem; background: rgba(255,255,255,0.25); padding: 0.15rem 0.5rem; border-radius: 10px;">
                              ${item.pct}%
                            </div>
                          </div>
                          
                          <!-- Tooltip -->
                          <div class="tooltip-uses-${idx}" style="
                            display: none;
                            position: absolute;
                            right: 105%;
                            top: 50%;
                            transform: translateY(-50%);
                            background: white;
                            border: 2px solid ${item.color};
                            border-radius: 8px;
                            padding: 0.75rem;
                            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                            z-index: 100;
                            min-width: 180px;
                            pointer-events: none;
                          ">
                            <div style="font-weight: 700; color: ${item.color}; margin-bottom: 0.5rem; font-size: 0.85rem;">
                              ${item.label}
                            </div>
                            <div style="display: grid; gap: 0.4rem; font-size: 0.8rem; color: #1f2937;">
                              <div style="display: flex; justify-content: space-between; gap: 1rem;">
                                <span style="color: #6b7280;">Amount:</span>
                                <strong>$${item.value.toFixed(2)}M</strong>
                              </div>
                              <div style="display: flex; justify-content: space-between; gap: 1rem;">
                                <span style="color: #6b7280;">% of Total:</span>
                                <strong>${item.pct}%</strong>
                              </div>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                  
                  <!-- Uses Legend -->
                  <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.8rem;">
                      <div style="background: #fef2f2; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #ef4444;">
                        <div style="color: #6b7280; margin-bottom: 0.25rem;">Purchase Price</div>
                        <div style="font-weight: 800; color: #7f1d1d; font-size: 1.1rem;">$${uses.buyEquity.toFixed(1)}M</div>
                        <div style="font-size: 0.7rem; color: #ef4444; margin-top: 0.25rem;">
                          ${(uses.buyEquity / totalUses * 100).toFixed(1)}% of uses
                        </div>
                      </div>
                      <div style="background: #fff7ed; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #f97316;">
                        <div style="color: #6b7280; margin-bottom: 0.25rem;">Total Fees</div>
                        <div style="font-weight: 800; color: #7c2d12; font-size: 1.1rem;">$${uses.fees.total.toFixed(1)}M</div>
                        <div style="font-size: 0.7rem; color: #f97316; margin-top: 0.25rem;">
                          ${(uses.fees.total / totalUses * 100).toFixed(1)}% of uses
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Balance Check & Key Metrics -->
            <div style="margin-top: 2rem; padding: 1.5rem; background: ${transaction.metrics.isBalanced ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'}; border-radius: 12px; border-left: 5px solid ${transaction.metrics.isBalanced ? '#10b981' : '#ef4444'};">
              <div style="display: flex; align-items: center; gap: 1.5rem;">
                <div style="flex-shrink: 0; width: 48px; height: 48px; background: ${transaction.metrics.isBalanced ? '#10b981' : '#ef4444'}; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    ${transaction.metrics.isBalanced ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' : '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'}
                  </svg>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: ${transaction.metrics.isBalanced ? '#065f46' : '#7f1d1d'}; margin-bottom: 0.5rem; font-size: 1.1rem;">
                    ${transaction.metrics.isBalanced ? '‚úì Sources & Uses Balance Verified' : '‚ö† Balance Mismatch Detected'}
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem; color: ${transaction.metrics.isBalanced ? '#047857' : '#991b1b'};">
                    <div>
                      <span style="opacity: 0.8;">Total Sources:</span>
                      <strong style="margin-left: 0.5rem;">$${totalSources.toFixed(2)}M</strong>
                    </div>
                    <div>
                      <span style="opacity: 0.8;">Total Uses:</span>
                      <strong style="margin-left: 0.5rem;">$${totalUses.toFixed(2)}M</strong>
                    </div>
                    <div>
                      <span style="opacity: 0.8;">Difference:</span>
                      <strong style="margin-left: 0.5rem;">$${Math.abs(totalSources - totalUses).toFixed(2)}M</strong>
                    </div>
                    <div>
                      <span style="opacity: 0.8;">Debt/Equity:</span>
                      <strong style="margin-left: 0.5rem;">${(sources.newDebt.total / sources.equity.totalRequired).toFixed(2)}x</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function adjustColorBrightness(hex, percent) {
        const num = parseInt(hex.replace('#', ''), 16);
        const r = Math.max(0, Math.min(255, (num >> 16) + percent));
        const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + percent));
        const b = Math.max(0, Math.min(255, (num & 0x0000FF) + percent));
        return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
      }







      // ==================== CREDIT CARD PAYMENT OPTIMIZER ====================
      function renderCCPOCalculator() {
        return `
          <h2 class="calculator-title">Credit Card Payment Optimizer (CCPO)</h2>

          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Smart Debt Elimination Strategy
            </div>
            <p class="explanation-text">
              <strong>Don't just pay minimums.</strong> This optimizer helps you eliminate credit card debt strategically.
              Compare proven methods: <strong>Avalanche</strong> (highest interest first - saves most money) vs
              <strong>Snowball</strong> (smallest balance first - quick psychological wins).
            </p>
            <div class="explanation-note">
              <strong>Financial Insight:</strong> The difference between random payments and optimized strategy can save you
              thousands in interest and shave years off your debt-free date. Even $50 extra/month compounds dramatically.
            </div>
          </div>

          <!-- Card Input Section -->
          <div style="background: var(--slate-50); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--slate-700);">
                üí≥ Your Credit Cards
              </h3>
              <button class="btn btn-primary" id="addCardBtn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.875rem;">
                + Add Card
              </button>
            </div>

            <div id="cardsContainer">
              <!-- Cards will be added here -->
            </div>
          </div>

          <!-- Payment Strategy Section -->
          <div class="form-grid" style="margin-bottom: 1.5rem;">
            <div class="form-group">
              <label class="form-label">üí∞ Total Monthly Payment Available</label>
              <input type="number" id="totalMonthlyPayment" class="form-input" placeholder="500" step="10">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                Must be ‚â• sum of all minimum payments
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">üìÖ Extra Payment (Optional)</label>
              <input type="number" id="extraPayment" class="form-input" placeholder="0" step="50">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                One-time injection (bonus, tax refund)
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">üéØ When to Apply Extra Payment?</label>
              <select id="extraPaymentMonth" class="form-select">
                <option value="0">Not applicable</option>
                <option value="1">Month 1</option>
                <option value="3">Month 3</option>
                <option value="6">Month 6</option>
                <option value="12">Month 12</option>
              </select>
            </div>
          </div>

          <button class="btn btn-success" id="optimizeBtn">
            üöÄ Optimize My Payment Strategy
          </button>

          <!-- Results Section -->
          <div id="ccpoResults" class="hidden" style="margin-top: 2rem;">
            <!-- Strategy comparison -->
            <div id="strategyComparison"></div>

            <!-- Detailed breakdown tabs -->
            <div id="detailedBreakdown" class="hidden" style="margin-top: 2rem;"></div>
          </div>
        `;
      }

      function setupCCPOCalculator() {
        let cards = [];
        let cardIdCounter = 1;

        // Add initial card
        addCard();

        // Event listeners
        document.getElementById("addCardBtn").addEventListener("click", () => {
          if (cards.length < 10) {
            addCard();
          } else {
            alert("Maximum 10 cards allowed");
          }
        });

        document
          .getElementById("optimizeBtn")
          .addEventListener("click", optimizePayments);

        function addCard() {
          const cardId = cardIdCounter++;
          const card = {
            id: cardId,
            balance: 0,
            apr: 0,
            minPaymentPercent: 2,
            name: `Card ${cardId}`,
          };
          cards.push(card);
          renderCards();
        }

        function removeCard(cardId) {
          cards = cards.filter((c) => c.id !== cardId);
          renderCards();
        }

        function renderCards() {
          const container = document.getElementById("cardsContainer");

          if (cards.length === 0) {
            container.innerHTML =
              '<p style="text-align: center; color: var(--slate-500);">No cards added yet</p>';
            return;
          }

          container.innerHTML = cards
            .map(
              (card) => `
            <div class="card-row" data-card-id="${card.id}" style="
              background: var(--white);
              padding: 1rem;
              border-radius: 0.5rem;
              margin-bottom: 0.75rem;
              border: 2px solid var(--slate-200);
            ">
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Card Name</label>
                  <input type="text" class="form-input card-name" value="${card.name}"
                         style="font-weight: 500; color: var(--indigo-700);">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Balance ($)</label>
                  <input type="number" class="form-input card-balance" value="${card.balance}"
                         placeholder="5000" step="100">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">APR (%)</label>
                  <input type="number" class="form-input card-apr" value="${card.apr}"
                         placeholder="18.99" step="0.01">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Min Payment (%)</label>
                  <input type="number" class="form-input card-minpayment" value="${card.minPaymentPercent}"
                         placeholder="2" step="0.1" min="1" max="10">
                </div>

                <button class="remove-card-btn" data-card-id="${card.id}" style="
                  background: var(--red-500);
                  color: white;
                  border: none;
                  border-radius: 0.375rem;
                  padding: 0.5rem 0.75rem;
                  cursor: pointer;
                  font-weight: 600;
                  transition: all 0.2s;
                ">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          `
            )
            .join("");

          // Attach event listeners
          document.querySelectorAll(".remove-card-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const cardId = parseInt(e.target.dataset.cardId);
              removeCard(cardId);
            });
          });

          // Update card data on input change
          document.querySelectorAll(".card-row").forEach((row) => {
            const cardId = parseInt(row.dataset.cardId);
            const card = cards.find((c) => c.id === cardId);

            row.querySelector(".card-name").addEventListener("input", (e) => {
              card.name = e.target.value;
            });

            row
              .querySelector(".card-balance")
              .addEventListener("input", (e) => {
                card.balance = parseFloat(e.target.value) || 0;
              });

            row.querySelector(".card-apr").addEventListener("input", (e) => {
              card.apr = parseFloat(e.target.value) || 0;
            });

            row
              .querySelector(".card-minpayment")
              .addEventListener("input", (e) => {
                card.minPaymentPercent = parseFloat(e.target.value) || 2;
              });
          });
        }

        function optimizePayments() {
          // Validate inputs
          const totalPayment = parseFloat(
            document.getElementById("totalMonthlyPayment").value
          );
          const extraPayment =
            parseFloat(document.getElementById("extraPayment").value) || 0;
          const extraPaymentMonth =
            parseInt(document.getElementById("extraPaymentMonth").value) || 0;

          if (cards.length === 0) {
            alert("Please add at least one credit card");
            return;
          }

          if (isNaN(totalPayment) || totalPayment <= 0) {
            alert("Please enter a valid total monthly payment");
            return;
          }

          // Validate all cards have data
          for (let card of cards) {
            if (card.balance <= 0 || card.apr <= 0) {
              alert(`Please fill in all fields for ${card.name}`);
              return;
            }
          }

          // Calculate minimum payments
          const totalMinPayment = cards.reduce((sum, card) => {
            const minPayment = Math.max(
              25,
              card.balance * (card.minPaymentPercent / 100)
            );
            return sum + minPayment;
          }, 0);

          if (totalPayment < totalMinPayment) {
            alert(
              `Total monthly payment ($${totalPayment.toFixed(
                2
              )}) must be at least the sum of minimum payments ($${totalMinPayment.toFixed(
                2
              )})`
            );
            return;
          }

          // Run optimizations
          const minPaymentOnly = simulateStrategy(
            "minimum",
            cards,
            totalMinPayment,
            extraPayment,
            extraPaymentMonth
          );
          const avalanche = simulateStrategy(
            "avalanche",
            cards,
            totalPayment,
            extraPayment,
            extraPaymentMonth
          );
          const snowball = simulateStrategy(
            "snowball",
            cards,
            totalPayment,
            extraPayment,
            extraPaymentMonth
          );

          // Display results
          displayResults({
            minPaymentOnly,
            avalanche,
            snowball,
            totalPayment,
            extraPayment,
            extraPaymentMonth,
          });
        }

        function simulateStrategy(
          strategyType,
          cards,
          monthlyPayment,
          extraPayment,
          extraPaymentMonth
        ) {
          // Clone cards to avoid mutation
          let remainingCards = cards.map((c) => ({
            ...c,
            remainingBalance: c.balance,
            totalInterestPaid: 0,
            monthsPaid: 0,
          }));

          const monthlyBreakdown = [];
          let month = 0;
          let totalInterestPaid = 0;

          while (
            remainingCards.some((c) => c.remainingBalance > 0) &&
            month < 600
          ) {
            // Max 50 years safety
            month++;

            // Apply interest to all cards
            remainingCards.forEach((card) => {
              if (card.remainingBalance > 0) {
                const monthlyInterest =
                  (card.remainingBalance * (card.apr / 100)) / 12;
                card.remainingBalance += monthlyInterest;
                card.totalInterestPaid += monthlyInterest;
                totalInterestPaid += monthlyInterest;
              }
            });

            // Determine payment allocation
            let availablePayment = monthlyPayment;

            // Add extra payment if applicable
            if (month === extraPaymentMonth && extraPayment > 0) {
              availablePayment += extraPayment;
            }

            // Sort cards based on strategy
            let sortedCards;
            if (strategyType === "avalanche") {
              sortedCards = [...remainingCards].sort((a, b) => b.apr - a.apr);
            } else if (strategyType === "snowball") {
              sortedCards = [...remainingCards].sort(
                (a, b) => a.remainingBalance - b.remainingBalance
              );
            } else {
              // minimum payment only
              sortedCards = [...remainingCards];
            }

            // Pay minimum on all cards first
            const cardPayments = [];
            sortedCards.forEach((card) => {
              if (card.remainingBalance > 0) {
                const minPayment = Math.max(
                  25,
                  card.remainingBalance * (card.minPaymentPercent / 100)
                );
                const payment = Math.min(
                  minPayment,
                  card.remainingBalance,
                  availablePayment
                );

                card.remainingBalance -= payment;
                availablePayment -= payment;

                cardPayments.push({
                  cardId: card.id,
                  cardName: card.name,
                  payment: payment,
                  remainingBalance: Math.max(0, card.remainingBalance),
                });

                if (card.remainingBalance <= 0) {
                  card.monthsPaid = month;
                }
              }
            });

            // Allocate remaining payment based on strategy
            if (strategyType !== "minimum" && availablePayment > 0.01) {
              for (let card of sortedCards) {
                if (card.remainingBalance > 0) {
                  const extraPaymentToCard = Math.min(
                    availablePayment,
                    card.remainingBalance
                  );
                  card.remainingBalance -= extraPaymentToCard;
                  availablePayment -= extraPaymentToCard;

                  // Update payment in breakdown
                  const cardPayment = cardPayments.find(
                    (p) => p.cardId === card.id
                  );
                  if (cardPayment) {
                    cardPayment.payment += extraPaymentToCard;
                    cardPayment.remainingBalance = Math.max(
                      0,
                      card.remainingBalance
                    );
                  }

                  if (card.remainingBalance <= 0) {
                    card.monthsPaid = month;
                  }

                  if (availablePayment < 0.01) break;
                }
              }
            }

            monthlyBreakdown.push({
              month,
              payments: cardPayments,
              totalPaid:
                monthlyPayment +
                (month === extraPaymentMonth ? extraPayment : 0),
              totalRemaining: remainingCards.reduce(
                (sum, c) => sum + Math.max(0, c.remainingBalance),
                0
              ),
            });

            // Check if all paid off
            if (remainingCards.every((c) => c.remainingBalance <= 0)) {
              break;
            }
          }

          return {
            strategyType,
            monthsToPayoff: month,
            totalInterestPaid,
            cardDetails: remainingCards.map((c) => ({
              id: c.id,
              name: c.name,
              originalBalance: c.balance,
              totalInterestPaid: c.totalInterestPaid,
              monthsPaid: c.monthsPaid,
            })),
            monthlyBreakdown,
          };
        }

        function displayResults(results) {
          const {
            minPaymentOnly,
            avalanche,
            snowball,
            totalPayment,
            extraPayment,
            extraPaymentMonth,
          } = results;

          const resultsDiv = document.getElementById("ccpoResults");
          const comparisonDiv = document.getElementById("strategyComparison");

          // Calculate savings
          const avalancheSavings =
            minPaymentOnly.totalInterestPaid - avalanche.totalInterestPaid;
          const snowballSavings =
            minPaymentOnly.totalInterestPaid - snowball.totalInterestPaid;
          const avalancheVsSnowball =
            snowball.totalInterestPaid - avalanche.totalInterestPaid;

          const bestStrategy =
            avalanche.totalInterestPaid <= snowball.totalInterestPaid
              ? "avalanche"
              : "snowball";

          comparisonDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
              üìä Payment Strategy Comparison
            </h3>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <!-- Minimum Payment Only -->
              <div style="background: linear-gradient(135deg, var(--red-50), var(--red-100));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--red-300);">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--red-900); margin-bottom: 1rem; text-align: center;">
                  ‚ö†Ô∏è MINIMUM ONLY
                </h4>

                <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Time to Payoff</div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--red-600);">
                      ${minPaymentOnly.monthsToPayoff} mo
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--red-600);">
                      ${(minPaymentOnly.monthsToPayoff / 12).toFixed(1)} years
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem; font-size: 0.875rem;">
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">Total Interest</div>
                    <div style="font-weight: 700; color: var(--red-700);">$${minPaymentOnly.totalInterestPaid.toFixed(
                      0
                    )}</div>
                  </div>
                </div>

                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--red-50);
                            border-radius: 0.375rem; font-size: 0.75rem; text-align: center; color: var(--red-800);">
                  ‚ö†Ô∏è Baseline - Not recommended!
                </div>
              </div>

              <!-- Avalanche Method -->
              <div style="background: linear-gradient(135deg, var(--green-50), var(--green-100));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                            bestStrategy === "avalanche"
                              ? "var(--green-600)"
                              : "var(--green-300)"
                          };
                          box-shadow: ${
                            bestStrategy === "avalanche"
                              ? "0 4px 12px rgba(16, 185, 129, 0.3)"
                              : "none"
                          };">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem; text-align: center;">
                  üéØ AVALANCHE
                  ${
                    bestStrategy === "avalanche"
                      ? '<div style="font-size: 0.75rem; color: var(--green-700); margin-top: 0.25rem;">‚≠ê RECOMMENDED</div>'
                      : ""
                  }
                </h4>

                <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Time to Payoff</div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--green-600);">
                      ${avalanche.monthsToPayoff} mo
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--green-600);">
                      ${(avalanche.monthsToPayoff / 12).toFixed(1)} years
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">Total Interest</div>
                    <div style="font-weight: 700; color: var(--green-700);">$${avalanche.totalInterestPaid.toFixed(
                      0
                    )}</div>
                  </div>
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">vs Minimum</div>
                    <div style="font-weight: 700; color: var(--green-700);">-$${avalancheSavings.toFixed(
                      0
                    )}</div>
                  </div>
                </div>

                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50);
                            border-radius: 0.375rem; font-size: 0.75rem;">
                  <strong>Strategy:</strong> Pay highest APR first<br>
                  <strong>Saves:</strong> ${
                    minPaymentOnly.monthsToPayoff - avalanche.monthsToPayoff
                  } months
                </div>
              </div>

              <!-- Snowball Method -->
              <div style="background: linear-gradient(135deg, var(--blue-50), var(--blue-100));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                            bestStrategy === "snowball"
                              ? "var(--blue-600)"
                              : "var(--blue-300)"
                          };
                          box-shadow: ${
                            bestStrategy === "snowball"
                              ? "0 4px 12px rgba(59, 130, 246, 0.3)"
                              : "none"
                          };">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--blue-900); margin-bottom: 1rem; text-align: center;">
                  ‚õÑ SNOWBALL
                  ${
                    bestStrategy === "snowball"
                      ? '<div style="font-size: 0.75rem; color: var(--blue-700); margin-top: 0.25rem;">‚≠ê RECOMMENDED</div>'
                      : ""
                  }
                </h4>

                <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Time to Payoff</div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--blue-600);">
                      ${snowball.monthsToPayoff} mo
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--blue-600);">
                      ${(snowball.monthsToPayoff / 12).toFixed(1)} years
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">Total Interest</div>
                    <div style="font-weight: 700; color: var(--blue-700);">$${snowball.totalInterestPaid.toFixed(
                      0
                    )}</div>
                  </div>
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">vs Minimum</div>
                    <div style="font-weight: 700; color: var(--blue-700);">-$${snowballSavings.toFixed(
                      0
                    )}</div>
                  </div>
                </div>

                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--blue-50);
                            border-radius: 0.375rem; font-size: 0.75rem;">
                  <strong>Strategy:</strong> Pay smallest balance first<br>
                  <strong>Saves:</strong> ${
                    minPaymentOnly.monthsToPayoff - snowball.monthsToPayoff
                  } months
                </div>
              </div>
            </div>

            <!-- Key Insights -->
            <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                        padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--indigo-200);">
              <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem; text-align: center;">
                üí° Key Insights & Recommendations
              </h4>

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Your Monthly Payment</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                    $${totalPayment.toFixed(0)}/mo
                  </div>
                  ${
                    extraPayment > 0
                      ? `
                    <div style="font-size: 0.7rem; color: var(--purple-600); margin-top: 0.25rem;">
                      + $${extraPayment} in month ${extraPaymentMonth}
                    </div>
                  `
                      : ""
                  }
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Best Strategy</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: ${
                    bestStrategy === "avalanche"
                      ? "var(--green-700)"
                      : "var(--blue-700)"
                  };">
                    ${
                      bestStrategy === "avalanche"
                        ? "üéØ Avalanche"
                        : "‚õÑ Snowball"
                    }
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Interest Savings</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--green-700);">
                    $${Math.max(avalancheSavings, snowballSavings).toFixed(0)}
                  </div>
                </div>
              </div>

              <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: 0.5rem;
                          border-left: 4px solid var(--indigo-500); font-size: 0.875rem;">
                <strong>Why ${
                  bestStrategy === "avalanche" ? "Avalanche" : "Snowball"
                }?</strong>
                ${
                  bestStrategy === "avalanche"
                    ? `
                  Avalanche method saves you <strong>$${avalancheVsSnowball.toFixed(
                    0
                  )} more</strong> than Snowball by targeting high-interest debt first.
                  This is the mathematically optimal strategy for minimizing total interest paid.
                `
                    : `
                  While Snowball pays slightly more interest ($${avalancheVsSnowball.toFixed(
                    0
                  )} difference), it provides
                  <strong>psychological wins</strong> by eliminating cards faster, which helps maintain motivation.
                  ${
                    Math.abs(avalancheVsSnowball / avalancheSavings) < 0.05
                      ? "The difference is minimal (<5%), so choose what keeps you motivated!"
                      : ""
                  }
                `
                }
              </div>

              <button class="btn btn-primary" id="showDetailedBtn" style="margin-top: 1rem;">
                üìà Show Detailed Payment Schedule
              </button>
            </div>
          `;

          resultsDiv.classList.remove("hidden");
          
          // Add event listener for detailed view
          document
            .getElementById("showDetailedBtn")
            .addEventListener("click", () => {
              displayDetailedBreakdown(avalanche, snowball);
            });

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('ccpo');
          }, 100);
        } 


        function displayDetailedBreakdown(avalanche, snowball) {
          const detailedDiv = document.getElementById("detailedBreakdown");

          detailedDiv.innerHTML = `
            <div style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem;
                        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
              <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-800);">
                üìÖ Month-by-Month Payment Schedule
              </h3>

              <div class="options-toggle" style="margin-bottom: 1.5rem;">
                <button class="option-btn active" id="avalancheDetailBtn">Avalanche Strategy</button>
                <button class="option-btn" id="snowballDetailBtn">Snowball Strategy</button>
              </div>

              <div id="avalancheDetail">
                ${renderPaymentSchedule(avalanche)}
              </div>

              <div id="snowballDetail" class="hidden">
                ${renderPaymentSchedule(snowball)}
              </div>
            </div>
          `;

          detailedDiv.classList.remove("hidden");

          // Toggle between strategies
          document
            .getElementById("avalancheDetailBtn")
            .addEventListener("click", (e) => {
              document
                .getElementById("avalancheDetailBtn")
                .classList.add("active");
              document
                .getElementById("snowballDetailBtn")
                .classList.remove("active");
              document
                .getElementById("avalancheDetail")
                .classList.remove("hidden");
              document.getElementById("snowballDetail").classList.add("hidden");
            });

          document
            .getElementById("snowballDetailBtn")
            .addEventListener("click", (e) => {
              document
                .getElementById("snowballDetailBtn")
                .classList.add("active");
              document
                .getElementById("avalancheDetailBtn")
                .classList.remove("active");
              document
                .getElementById("snowballDetail")
                .classList.remove("hidden");
              document
                .getElementById("avalancheDetail")
                .classList.add("hidden");
            });
        }

        function renderPaymentSchedule(strategy) {
          const { monthlyBreakdown, cardDetails } = strategy;

          // Group cards by payoff milestone
          const payoffMilestones = cardDetails
            .sort((a, b) => a.monthsPaid - b.monthsPaid)
            .map((card) => ({
              ...card,
              payoffMonth: card.monthsPaid,
            }));

          // Show first 12 months + every 6 months after
          const monthsToShow = [];
          for (let i = 1; i <= Math.min(12, monthlyBreakdown.length); i++) {
            monthsToShow.push(i);
          }
          for (let i = 18; i <= monthlyBreakdown.length; i += 6) {
            monthsToShow.push(i);
          }
          // Always include final month
          if (!monthsToShow.includes(monthlyBreakdown.length)) {
            monthsToShow.push(monthlyBreakdown.length);
          }

          return `
                  <!-- Payoff Timeline -->
                  <div style="background: var(--slate-50); padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <h4 style="font-size: 1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
                      üéØ Debt Payoff Timeline
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                      ${payoffMilestones
                        .map(
                          (card, idx) => `
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;
                                    border-left: 4px solid ${getCardColor(
                                      idx
                                    )};">
                          <div style="font-weight: 600; color: var(--slate-800); margin-bottom: 0.5rem;">
                            ${card.name}
                          </div>
                          <div style="font-size: 0.875rem; color: var(--slate-600);">
                            Paid off: <strong>Month ${card.payoffMonth}</strong>
                            <br>
                            Interest: <strong>$${card.totalInterestPaid.toFixed(
                              0
                            )}</strong>
                          </div>
                        </div>
                      `
                        )
                        .join("")}
                    </div>
                  </div>

                  <!-- Monthly Breakdown Table -->
                  <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <thead>
                        <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                          <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Month</th>
                          ${cardDetails
                            .map(
                              (card) => `
                            <th style="padding: 0.75rem; text-align: right; font-weight: 600;">${card.name}</th>
                          `
                            )
                            .join("")}
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Total Payment</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Remaining Debt</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${monthsToShow
                          .map((monthNum) => {
                            const month = monthlyBreakdown[monthNum - 1];

                            return `
                            <tr style="border-bottom: 1px solid var(--slate-200); ${
                              monthNum === monthlyBreakdown.length
                                ? "background: var(--green-50); font-weight: 600;"
                                : ""
                            }">
                              <td style="padding: 0.75rem; font-weight: 500;">
                                ${monthNum}
                                ${
                                  payoffMilestones.find(
                                    (c) => c.payoffMonth === monthNum
                                  )
                                    ? "üéâ"
                                    : ""
                                }
                              </td>
                              ${cardDetails
                                .map((card) => {
                                  const payment = month.payments.find(
                                    (p) => p.cardId === card.id
                                  );
                                  const isPaidOff =
                                    payment && payment.remainingBalance === 0;

                                  return `
                                  <td style="padding: 0.75rem; text-align: right; ${
                                    isPaidOff
                                      ? "color: var(--green-700); font-weight: 600;"
                                      : ""
                                  }">
                                    ${
                                      payment
                                        ? `$${payment.payment.toFixed(0)}`
                                        : "-"
                                    }
                                    ${isPaidOff ? " ‚úì" : ""}
                                  </td>
                                `;
                                })
                                .join("")}
                              <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                $${month.totalPaid.toFixed(0)}
                              </td>
                              <td style="padding: 0.75rem; text-align: right; font-weight: 600; ${
                                month.totalRemaining === 0
                                  ? "color: var(--green-700);"
                                  : ""
                              }">
                                $${month.totalRemaining.toFixed(0)}
                              </td>
                            </tr>
                          `;
                          })
                          .join("")}
                      </tbody>
                    </table>
                  </div>

                  <!-- Summary Stats -->
                  <div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                    <div style="background: var(--blue-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Debt Paid</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--blue-700);">
                        $${cardDetails
                          .reduce((sum, c) => sum + c.originalBalance, 0)
                          .toFixed(0)}
                      </div>
                    </div>

                    <div style="background: var(--red-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Interest</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--red-700);">
                        $${strategy.totalInterestPaid.toFixed(0)}
                      </div>
                    </div>

                    <div style="background: var(--green-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Time to Freedom</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--green-700);">
                        ${strategy.monthsToPayoff} months
                      </div>
                    </div>

                    <div style="background: var(--purple-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">First Card Paid</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--purple-700);">
                        Month ${Math.min(
                          ...cardDetails.map((c) => c.monthsPaid)
                        )}
                      </div>
                    </div>
                  </div>

                  <!-- Action Items -->
                  <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, var(--indigo-50), var(--blue-50));
                              border-radius: 0.75rem; border-left: 4px solid var(--indigo-500);">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                      ‚úÖ Action Plan for Success
                    </h4>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.875rem; line-height: 1.8;">
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        üìå <strong>Set up automatic payments</strong> on all cards to avoid late fees
                      </li>
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        üéØ <strong>Focus extra payments</strong> on ${
                          strategy.strategyType === "avalanche"
                            ? "highest APR card"
                            : "smallest balance card"
                        } each month
                      </li>
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        üí∞ <strong>Allocate windfalls</strong> (tax refunds, bonuses) to accelerate payoff
                      </li>
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        üîí <strong>Freeze new purchases</strong> on cards being paid down
                      </li>
                      <li style="padding: 0.5rem 0;">
                        üìä <strong>Review progress monthly</strong> and celebrate milestones (${
                          payoffMilestones.length
                        } cards to knock out!)
                      </li>
                    </ul>
                  </div>

                  <!-- Progress Visualization -->
                  <div style="margin-top: 1.5rem; padding: 1.25rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                      üìâ Debt Reduction Progress
                    </h4>
                    ${renderProgressChart(monthlyBreakdown, cardDetails)}
                  </div>
                `;
        }

        function renderProgressChart(monthlyBreakdown, cardDetails) {
          const maxDebt = monthlyBreakdown[0].totalRemaining;
          const milestones = [0, 25, 50, 75, 100];

          return `
                  <div style="position: relative; height: 300px; background: var(--slate-50); border-radius: 0.5rem; padding: 1rem;">
                    <!-- Y-axis labels -->
                    <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 60px; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0;">
                      ${milestones
                        .reverse()
                        .map(
                          (pct) => `
                        <div style="font-size: 0.75rem; color: var(--slate-600); text-align: right; padding-right: 0.5rem;">
                          $${((maxDebt * pct) / 100).toFixed(0)}
                        </div>
                      `
                        )
                        .join("")}
                    </div>

                    <!-- Chart area -->
                    <div style="position: absolute; left: 70px; right: 20px; top: 20px; bottom: 40px;">
                      ${renderDebtLine(monthlyBreakdown, maxDebt)}
                    </div>

                    <!-- X-axis -->
                    <div style="position: absolute; left: 70px; right: 20px; bottom: 10px; display: flex; justify-content: space-between;">
                      ${[0, 25, 50, 75, 100]
                        .map((pct) => {
                          const month = Math.floor(
                            (monthlyBreakdown.length * pct) / 100
                          );
                          return `<div style="font-size: 0.75rem; color: var(--slate-600);">Mo ${month}</div>`;
                        })
                        .join("")}
                    </div>
                  </div>

                  <div style="margin-top: 1rem; text-align: center; font-size: 0.875rem; color: var(--slate-600);">
                    üéØ Debt-free date: <strong>${new Date(
                      Date.now() +
                        monthlyBreakdown.length * 30 * 24 * 60 * 60 * 1000
                    ).toLocaleDateString("en-US", {
                      month: "short",
                      year: "numeric",
                    })}</strong>
                  </div>
                `;
        }

        function renderDebtLine(monthlyBreakdown, maxDebt) {
          const points = monthlyBreakdown
            .filter(
              (_, idx) =>
                idx % Math.ceil(monthlyBreakdown.length / 50) === 0 ||
                idx === monthlyBreakdown.length - 1
            )
            .map((month, idx, arr) => {
              const x = (idx / (arr.length - 1)) * 100;
              const y = 100 - (month.totalRemaining / maxDebt) * 100;
              return `${x},${y}`;
            })
            .join(" ");

          return `
                  <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" style="overflow: visible;">
                    <!-- Grid lines -->
                    ${[0, 25, 50, 75, 100]
                      .map(
                        (pct) => `
                      <line x1="0" y1="${pct}" x2="100" y2="${pct}" stroke="var(--slate-200)" stroke-width="0.2"/>
                    `
                      )
                      .join("")}

                    <!-- Debt line -->
                    <polyline
                      points="${points}"
                      fill="none"
                      stroke="var(--red-500)"
                      stroke-width="1"
                      vector-effect="non-scaling-stroke"
                    />

                    <!-- Fill area under line -->
                    <polygon
                      points="0,100 ${points} 100,100"
                      fill="var(--red-100)"
                      opacity="0.3"
                    />

                    <!-- End point marker -->
                    <circle
                      cx="${points.split(" ").pop().split(",")[0]}"
                      cy="${points.split(" ").pop().split(",")[1]}"
                      r="1.5"
                      fill="var(--green-600)"
                      vector-effect="non-scaling-stroke"
                    />
                  </svg>
                `;
        }

        function getCardColor(index) {
          const colors = [
            "var(--blue-500)",
            "var(--green-500)",
            "var(--purple-500)",
            "var(--orange-500)",
            "var(--cyan-500)",
            "var(--pink-500)",
            "var(--indigo-500)",
            "var(--red-500)",
            "var(--yellow-500)",
            "var(--teal-500)",
          ];
          return colors[index % colors.length];
        }
      }


      // --- TIME VS MONEY TRADE-OFF CALCULATOR ---
      function renderTimeMoneyCalculator() {
        return `
          <h2 class="calculator-title">‚è∞üí∞ Time vs Money Trade-Off Calculator</h2>

          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Stop Wasting Your Most Valuable Asset: TIME
            </div>
            <p class="explanation-text">
              <strong>Your time has different values in different contexts.</strong> This calculator helps you make rational decisions
              by comparing activities based on WHEN and HOW you can use your time.
            </p>
            <div class="explanation-note">
              <strong>Key Insight:</strong> Your "work hour" value is NOT always applicable. Weekend time, evening time, 
              and leisure time have different opportunity costs. We'll calculate the TRUE trade-off for each scenario.
            </div>
          </div>

          <!-- Your Time Profile -->
          <div style="background: linear-gradient(135deg, var(--indigo-50), var(--blue-50));
                      padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem; border: 2px solid var(--indigo-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
              üíº Your Time Profile
            </h3>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">üí∞ Work Hourly Rate ($/hr)</label>
                <input type="number" id="workHourlyRate" class="form-input" placeholder="30" step="1">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  What you actually earn per hour at work
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">‚è∞ Can You Work Extra Hours?</label>
                <select id="canWorkExtra" class="form-select">
                  <option value="yes">Yes - I can freelance/overtime</option>
                  <option value="limited">Limited - Sometimes possible</option>
                  <option value="no">No - Fixed salary/hours</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">üíµ Freelance/Side Hustle Rate ($/hr)</label>
                <input type="number" id="freelanceRate" class="form-input" placeholder="50" step="5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Leave blank if not applicable
                </div>
              </div>
            </div>

            <div id="profileSummary" class="hidden" style="margin-top: 1rem; padding: 1rem; background: var(--white);
                                                            border-radius: 0.5rem; border-left: 4px solid var(--indigo-500);">
              <!-- Will be populated by JS -->
            </div>
          </div>

          <!-- Scenario Selector -->
          <div style="background: var(--slate-50); padding: 1rem; border-radius: 0.75rem; margin-bottom: 2rem;">
            <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
              üéØ Choose Your Scenario
            </h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
              <button class="scenario-btn active" data-scenario="opportunity">
                üí∏ Opportunity Cost<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Is this deal worth my time?</span>
              </button>
              <button class="scenario-btn" data-scenario="sunk">
                üé¨ Sunk Cost Helper<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Should I quit or continue?</span>
              </button>
              <button class="scenario-btn" data-scenario="diy">
                üîß DIY vs Hire<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Do it myself or pay?</span>
              </button>
              <button class="scenario-btn" data-scenario="activity">
                üìä Activity Comparison<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Compare multiple options</span>
              </button>
            </div>
          </div>

          <!-- Scenario Content -->
          <div id="scenarioContent"></div>

          <!-- Results -->
          <div id="timeMoneyResults" class="results-container hidden"
              style="border-color: var(--indigo-100); background-color: var(--indigo-50); margin-top: 2rem;">
          </div>
        `;
      }

      function setupTimeMoneyCalculator() {
        let activeScenario = "opportunity";
        let workRate = 0;
        let freelanceRate = 0;
        let canWorkExtra = "no";

        const workRateInput = document.getElementById("workHourlyRate");
        const freelanceRateInput = document.getElementById("freelanceRate");
        const canWorkExtraSelect = document.getElementById("canWorkExtra");
        const profileSummary = document.getElementById("profileSummary");

        function updateProfile() {
          workRate = parseFloat(workRateInput.value) || 0;
          freelanceRate = parseFloat(freelanceRateInput.value) || 0;
          canWorkExtra = canWorkExtraSelect.value;

          if (workRate > 0) {
            let opportunityCostText = "";

            if (canWorkExtra === "yes" && freelanceRate > 0) {
              opportunityCostText = `<strong>Your opportunity cost:</strong> $${freelanceRate.toFixed(
                2
              )}/hr (freelance rate)`;
            } else if (canWorkExtra === "yes") {
              opportunityCostText = `<strong>Your opportunity cost:</strong> $${workRate.toFixed(
                2
              )}/hr (work rate - you can work extra)`;
            } else if (canWorkExtra === "limited") {
              opportunityCostText = `<strong>Your opportunity cost:</strong> ~$${(
                workRate * 0.5
              ).toFixed(2)}/hr (limited extra work possible)`;
            } else {
              opportunityCostText = `<strong>Your opportunity cost:</strong> $0/hr for free time (fixed hours - can't work more)`;
            }

            profileSummary.innerHTML = `
              <div style="font-size: 0.875rem; line-height: 1.6;">
                <strong>Work Rate:</strong> $${workRate.toFixed(2)}/hr<br>
                ${
                  freelanceRate > 0
                    ? `<strong>Freelance Rate:</strong> $${freelanceRate.toFixed(
                        2
                      )}/hr<br>`
                    : ""
                }
                ${opportunityCostText}<br><br>
                <div style="background: var(--blue-50); padding: 0.75rem; border-radius: 0.375rem; margin-top: 0.5rem;">
                  <strong>üí° Important Context:</strong><br>
                  ${
                    canWorkExtra === "no"
                      ? '‚Ä¢ Your free time has NO monetary opportunity cost (you can\'t work more anyway)<br>‚Ä¢ Focus on ENJOYMENT and LONG-TERM VALUE instead<br>‚Ä¢ "Saving money" on free time is usually worth it'
                      : canWorkExtra === "limited"
                      ? "‚Ä¢ You can sometimes work extra, so time has PARTIAL monetary value<br>‚Ä¢ Weekend/evening activities: compare against 50% of work rate<br>‚Ä¢ High-value activities might be worth your limited extra work time"
                      : '‚Ä¢ You can freely trade time for money (freelance/overtime)<br>‚Ä¢ Any activity should beat your freelance rate to be "worth it"<br>‚Ä¢ Time spent on low-ROI activities = money left on the table'
                  }
                </div>
              </div>
            `;
            profileSummary.classList.remove("hidden");
          }
        }

        workRateInput.addEventListener("change", updateProfile);
        freelanceRateInput.addEventListener("change", updateProfile);
        canWorkExtraSelect.addEventListener("change", updateProfile);

        const scenarioBtns = document.querySelectorAll(".scenario-btn");
        scenarioBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            scenarioBtns.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            activeScenario = btn.dataset.scenario;
            loadScenario(activeScenario, {
              workRate,
              freelanceRate,
              canWorkExtra,
            });
          });
        });

        loadScenario("opportunity", { workRate, freelanceRate, canWorkExtra });

        function loadScenario(scenario, rates) {
          const content = document.getElementById("scenarioContent");

          switch (scenario) {
            case "opportunity":
              content.innerHTML = renderOpportunityCostNew();
              setupOpportunityCostNew(rates);
              break;
            case "sunk":
              content.innerHTML = renderSunkCost();
              setupSunkCost(rates.workRate);
              break;
            case "diy":
              content.innerHTML = renderDIYvsPay();
              setupDIYvsPay(rates.workRate);
              break;
            case "activity":
              content.innerHTML = renderActivityROI();
              setupActivityROI(rates.workRate);
              break;
          }

          // Save state after loading scenario
          setTimeout(() => {
            StorageManager.saveCalculatorState('time-money');
          }, 100);
        }
      }

      function renderOpportunityCostNew() {
        return `
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
              üí∏ Smart Opportunity Cost Calculator
            </h3>
            <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
              "Is this deal actually saving me money, or am I fooling myself?"
            </p>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">‚è∞ Time You'll Spend (hours)</label>
                <input type="number" id="oppTimeSpent" class="form-input" placeholder="1" step="0.25">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Total time including travel, waiting, etc.
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üí∞ Money You'll Save ($)</label>
                <input type="number" id="oppMoneySaved" class="form-input" placeholder="20" step="1">
              </div>

              <div class="form-group">
                <label class="form-label">üìÖ When Will You Do This?</label>
                <select id="oppTiming" class="form-select">
                  <option value="work">During Work Hours</option>
                  <option value="evening">Evening (after work)</option>
                  <option value="weekend">Weekend</option>
                  <option value="flexible">Flexible - anytime</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">üéØ Could You Work Instead?</label>
                <select id="oppCanWork" class="form-select">
                  <option value="yes">Yes - I could earn money in this time</option>
                  <option value="no">No - This is free/leisure time</option>
                </select>
              </div>
            </div>

            <button class="btn btn-primary" id="calculateOppNew">
              üßÆ Calculate TRUE Cost
            </button>
          </div>
        `;
      }

      function setupOpportunityCostNew(rates) {
        document
          .getElementById("calculateOppNew")
          .addEventListener("click", () => {
            if (rates.workRate === 0 || isNaN(rates.workRate)) {
              alert("Please set your work hourly rate first!");
              return;
            }

            const timeSpent = parseFloat(
              document.getElementById("oppTimeSpent").value
            );
            const moneySaved = parseFloat(
              document.getElementById("oppMoneySaved").value
            );
            const timing = document.getElementById("oppTiming").value;
            const canWork = document.getElementById("oppCanWork").value;

            if (isNaN(timeSpent) || isNaN(moneySaved) || timeSpent <= 0) {
              alert("Please enter valid time and money values");
              return;
            }

            let opportunityCost = 0;
            let reasoning = "";
            let context = "";

            if (canWork === "yes") {
              if (rates.canWorkExtra === "yes" && rates.freelanceRate > 0) {
                opportunityCost = rates.freelanceRate * timeSpent;
                reasoning = `You could earn $${rates.freelanceRate.toFixed(
                  2
                )}/hr freelancing`;
                context = "high";
              } else if (rates.canWorkExtra === "yes") {
                opportunityCost = rates.workRate * timeSpent;
                reasoning = `You could work overtime at $${rates.workRate.toFixed(
                  2
                )}/hr`;
                context = "high";
              } else if (timing === "work") {
                opportunityCost = rates.workRate * timeSpent;
                reasoning = `This takes away from paid work time`;
                context = "high";
              } else {
                opportunityCost = rates.workRate * 0.3 * timeSpent;
                reasoning = `Limited opportunity to work extra (30% of work rate)`;
                context = "medium";
              }
            } else {
              if (timing === "work") {
                opportunityCost = rates.workRate * timeSpent;
                reasoning = `This happens during work hours`;
                context = "high";
              } else {
                opportunityCost = 0;
                reasoning = `This is free time you can't monetize anyway`;
                context = "low";
              }
            }

            const netGain = moneySaved - opportunityCost;
            const effectiveRate = timeSpent > 0 ? moneySaved / timeSpent : 0;
            const isWorthIt = netGain > 0;

            displayOpportunityResults({
              timeSpent,
              moneySaved,
              opportunityCost,
              netGain,
              effectiveRate,
              isWorthIt,
              reasoning,
              context,
              timing,
              canWork,
              rates,
            });
          });
      }

      function displayOpportunityResults(data) {
        const resultsDiv = document.getElementById("timeMoneyResults");

        const contextColors = {
          high: {
            bg: "var(--red-50)",
            border: "var(--red-500)",
            text: "var(--red-800)",
          },
          medium: {
            bg: "var(--orange-50)",
            border: "var(--orange-500)",
            text: "var(--orange-800)",
          },
          low: {
            bg: "var(--blue-50)",
            border: "var(--blue-500)",
            text: "var(--blue-800)",
          },
        };

        const color = contextColors[data.context];

        resultsDiv.innerHTML = `
          <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
            ${
              data.isWorthIt
                ? "‚úÖ GOOD DEAL - Worth Your Time!"
                : "‚ùå BAD DEAL - Not Worth It!"
            }
          </h3>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
            <div style="background: var(--blue-100); padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Time Spent</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--blue-700);">
                ${data.timeSpent}h
              </div>
            </div>

            <div style="background: var(--green-100); padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Money Saved</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--green-700);">
                $${data.moneySaved.toFixed(2)}
              </div>
            </div>

            <div style="background: ${
              color.bg
            }; padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Opportunity Cost</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: ${
                color.text
              };">
                $${data.opportunityCost.toFixed(2)}
              </div>
              <div style="font-size: 0.7rem; margin-top: 0.25rem; color: ${
                color.text
              };">
                ${data.reasoning}
              </div>
            </div>

            <div style="background: ${
              data.isWorthIt ? "var(--green-100)" : "var(--red-100)"
            }; padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Net Gain/Loss</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: ${
                data.isWorthIt ? "var(--green-700)" : "var(--red-700)"
              };">
                ${data.netGain >= 0 ? "+" : ""}$${data.netGain.toFixed(2)}
              </div>
            </div>
          </div>

          <div style="background: linear-gradient(135deg, ${
            color.bg
          }, var(--indigo-50));
                      padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid ${
                        color.border
                      };">
            <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: ${
              color.text
            };">
              üí° Analysis:
            </h4>
            <div style="font-size: 0.875rem; line-height: 1.7; color: var(--slate-700);">
              <p style="margin-bottom: 1rem;">
                <strong>Your effective rate for this activity:</strong> $${data.effectiveRate.toFixed(
                  2
                )}/hr
              </p>
              
              <p style="margin-bottom: 1rem;">
                <strong>Context matters:</strong> ${data.reasoning}
                ${
                  data.context === "low"
                    ? " Since you can't work during this time anyway, the opportunity cost is effectively $0. Any money saved is pure gain!"
                    : data.context === "medium"
                    ? " You have limited ability to work extra, so we use a conservative 30% of your work rate as opportunity cost."
                    : " You could directly earn money during this time, so opportunity cost equals your earning potential."
                }
              </p>

              ${
                data.isWorthIt
                  ? `
                  <p style="background: var(--green-50); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--green-600);">
                    <strong style="color: var(--green-800);">‚úÖ This is worth it!</strong><br>
                    You're gaining $${data.netGain.toFixed(2)} net. ${
                      data.context === "low"
                        ? "Perfect use of free time that can't be monetized anyway."
                        : `You're earning $${data.effectiveRate.toFixed(
                            2
                          )}/hr, which beats your opportunity cost.`
                    }
                  </p>
                `
                  : `
                  <p style="background: var(--red-50); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--red-600);">
                    <strong style="color: var(--red-800);">‚ùå Not worth your time!</strong><br>
                    You're losing $${Math.abs(data.netGain).toFixed(2)} net. ${
                      data.canWork === "yes"
                        ? `You could earn $${data.opportunityCost.toFixed(
                            2
                          )} working instead.`
                        : "Your time during work hours is too valuable for this deal."
                    }
                  </p>
                `
              }

              <div style="margin-top: 1rem; padding: 1rem; background: var(--slate-50); border-radius: 0.5rem;">
                <strong>üéØ Rule of Thumb:</strong><br>
                ${
                  data.context === "low"
                    ? "‚Ä¢ Free time: Almost any money saved is good<br>‚Ä¢ Focus on enjoyment and learning value too"
                    : data.context === "medium"
                    ? "‚Ä¢ Limited work ability: Save at least $" +
                      (data.rates.workRate * 0.3 * data.timeSpent).toFixed(2) +
                      " for " +
                      data.timeSpent +
                      "h<br>‚Ä¢ Consider if it's worth giving up leisure time"
                    : "‚Ä¢ Can work freely: Must save more than $" +
                      data.opportunityCost.toFixed(2) +
                      "<br>‚Ä¢ Otherwise, work and pay full price instead"
                }
              </div>
            </div>
          </div>
        `;

        resultsDiv.classList.remove("hidden");
      }

      function renderSunkCost() {
        return `
                <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
                  <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                    üé¨ Sunk Cost Decision Helper
                  </h3>
                  <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
                    "Should I finish this movie/meeting/book, or cut my losses?"
                  </p>

                  <div class="form-grid">
                    <div class="form-group">
                      <label class="form-label">üíµ Money Already Spent ($)</label>
                      <input type="number" id="sunkMoney" class="form-input" placeholder="15" step="1">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                        Movie ticket, event fee, book price
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">‚è∞ Time Already Invested (min)</label>
                      <input type="number" id="sunkTime" class="form-input" placeholder="30" step="5">
                    </div>

                    <div class="form-group">
                      <label class="form-label">‚è±Ô∏è Remaining Time (min)</label>
                      <input type="number" id="remainingTime" class="form-input" placeholder="90" step="5">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                        How much longer if you stay
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">üòê Current Satisfaction (1-10)</label>
                      <input type="range" id="satisfaction" class="form-input" min="1" max="10" value="5"
                            style="padding: 0.5rem 0;">
                      <div style="text-align: center; font-size: 1.5rem; margin-top: 0.5rem;" id="satisfactionEmoji">üòê</div>
                      <div style="text-align: center; font-size: 0.875rem; font-weight: 600; color: var(--slate-700);" id="satisfactionValue">5/10</div>
                    </div>
                  </div>

                  <button class="btn btn-danger" id="calculateSunk">
                    üö® Should I Quit or Continue?
                  </button>
                </div>
              `;
      }

      function setupSunkCost(hourlyRate) {
        // Satisfaction slider interactivity
        const satisfactionSlider = document.getElementById("satisfaction");
        const satisfactionEmoji = document.getElementById("satisfactionEmoji");
        const satisfactionValue = document.getElementById("satisfactionValue");

        const emojis = [
          "üò´",
          "üòû",
          "üòï",
          "üòê",
          "üôÇ",
          "üòä",
          "üòÉ",
          "üòÑ",
          "ü§©",
          "ü•≥",
        ];

        satisfactionSlider.addEventListener("input", (e) => {
          const value = parseInt(e.target.value);
          satisfactionValue.textContent = `${value}/10`;
          satisfactionEmoji.textContent = emojis[value - 1];
        });

        document
          .getElementById("calculateSunk")
          .addEventListener("click", () => {
            if (hourlyRate === 0) {
              alert("Please set your hourly rate first!");
              return;
            }

            const sunkMoney = parseFloat(
              document.getElementById("sunkMoney").value
            );
            const sunkTime = parseFloat(
              document.getElementById("sunkTime").value
            );
            const remainingTime = parseFloat(
              document.getElementById("remainingTime").value
            );
            const satisfaction = parseInt(
              document.getElementById("satisfaction").value
            );

            if (
              isNaN(sunkMoney) ||
              isNaN(sunkTime) ||
              isNaN(remainingTime) ||
              isNaN(satisfaction)
            ) {
              alert("Please fill in all fields");
              return;
            }

            // Calculations
            const sunkTimeValue = hourlyRate * (sunkTime / 60);
            const totalSunkCost = sunkMoney + sunkTimeValue;
            const futureCost = hourlyRate * (remainingTime / 60);

            // Suffering penalty: low satisfaction = higher cost
            const sufferingMultiplier = 1 + (10 - satisfaction) * 0.2; // 1.0 to 2.8x
            const adjustedFutureCost = futureCost * sufferingMultiplier;

            const totalLossIfContinue = totalSunkCost + adjustedFutureCost;
            const totalLossIfQuit = totalSunkCost;

            // N√™n quit n·∫øu future cost > 50% c·ªßa sunk cost (v√≠ d·ª•)
            const shouldQuit = adjustedFutureCost > totalSunkCost * 0.5;            
            const savingsFromQuitting = adjustedFutureCost;

            const resultsDiv = document.getElementById("timeMoneyResults");

            resultsDiv.innerHTML = `
                  <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center;
                              color: ${
                                shouldQuit
                                  ? "var(--red-700)"
                                  : "var(--green-700)"
                              };">
                    ${
                      shouldQuit
                        ? "üö® RECOMMENDATION: QUIT NOW"
                        : "‚úÖ FINISH IT - You're Almost Done"
                    }
                  </h3>

                  <!-- Sunk Cost Visualization -->
                  <div style="background: var(--slate-50); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
                    <h4 style="font-size: 1rem; font-weight: 600; color: var(--slate-800); margin-bottom: 1rem;">
                      üí∏ Cost Breakdown
                    </h4>

                    <div style="margin-bottom: 1.5rem;">
                      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; font-weight: 600;">Already Lost (SUNK COST)</span>
                        <span style="font-size: 0.875rem; font-weight: 700; color: var(--red-600);">
                          $${totalSunkCost.toFixed(2)}
                        </span>
                      </div>
                      <div style="background: var(--slate-200); height: 30px; border-radius: 0.5rem; overflow: hidden;">
                        <div style="background: linear-gradient(to right, var(--red-500), var(--red-600));
                                    height: 100%; width: 100%; display: flex; align-items: center; justify-content: center;
                                    color: white; font-weight: 700; font-size: 0.875rem;">
                          GONE FOREVER
                        </div>
                      </div>
                      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--slate-600);">
                        $${sunkMoney} (money) + $${sunkTimeValue.toFixed(
              2
            )} (${sunkTime} min)
                      </div>
                    </div>

                    <div>
                      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; font-weight: 600;">Additional Loss if You Stay</span>
                        <span style="font-size: 0.875rem; font-weight: 700; color: var(--orange-600);">
                          $${adjustedFutureCost.toFixed(2)}
                        </span>
                      </div>
                      <div style="background: var(--slate-200); height: 30px; border-radius: 0.5rem; overflow: hidden;">
                        <div style="background: linear-gradient(to right, var(--orange-400), var(--orange-600));
                                    height: 100%; width: ${
                                      (adjustedFutureCost /
                                        totalLossIfContinue) *
                                      100
                                    }%;
                                    display: flex; align-items: center; padding-left: 1rem;
                                    color: white; font-weight: 700; font-size: 0.875rem;">
                          ${
                            adjustedFutureCost > 10
                              ? "$" + adjustedFutureCost.toFixed(0)
                              : ""
                          }
                        </div>
                      </div>
                      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--slate-600);">
                        $${futureCost.toFixed(2)} base + ${(
              (sufferingMultiplier - 1) *
              100
            ).toFixed(0)}% suffering penalty
                      </div>
                    </div>
                  </div>

                  <!-- Comparison Cards -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Quit Option -->
                    <div style="background: linear-gradient(135deg, var(--green-50), var(--emerald-50));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                                  shouldQuit
                                    ? "var(--green-600)"
                                    : "var(--green-300)"
                                };
                                ${
                                  shouldQuit
                                    ? "box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
                                    : ""
                                }">
                      <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem; text-align: center;">
                        ‚úÖ OPTION A: QUIT NOW
                      </h4>

                      <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Loss</div>
                          <div style="font-size: 2rem; font-weight: 800; color: var(--green-600);">
                            $${totalLossIfQuit.toFixed(2)}
                          </div>
                        </div>
                      </div>

                      <div style="font-size: 0.875rem; line-height: 1.6;">
                        <strong style="color: var(--green-800);">‚úÖ You'll save:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                          <li>$${savingsFromQuitting.toFixed(
                            2
                          )} in opportunity cost</li>
                          <li>${remainingTime} minutes (${(
              remainingTime / 60
            ).toFixed(1)} hours)</li>
                          <li>Mental sanity (satisfaction: ${satisfaction}/10)</li>
                        </ul>
                      </div>

                      <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50); border-radius: 0.375rem;
                                  font-size: 0.75rem; border-left: 3px solid var(--green-600);">
                        <strong>Better alternatives:</strong>
                        <br>‚Ä¢ Work ${remainingTime} min ‚Üí Earn $${futureCost.toFixed(
              2
            )}
                        <br>‚Ä¢ Learn a new skill
                        <br>‚Ä¢ Do something enjoyable
                      </div>
                    </div>

                    <!-- Continue Option -->
                    <div style="background: linear-gradient(135deg, var(--red-50), var(--orange-50));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                                  !shouldQuit
                                    ? "var(--blue-600)"
                                    : "var(--red-300)"
                                };">
                      <h4 style="font-size: 1rem; font-weight: 700; color: var(--red-900); margin-bottom: 1rem; text-align: center;">
                        ${shouldQuit ? "‚ùå" : "‚úÖ"} OPTION B: FINISH IT
                      </h4>

                      <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Loss</div>
                          <div style="font-size: 2rem; font-weight: 800; color: ${
                            shouldQuit ? "var(--red-600)" : "var(--blue-600)"
                          };">
                            $${totalLossIfContinue.toFixed(2)}
                          </div>
                        </div>
                      </div>

                      <div style="font-size: 0.875rem; line-height: 1.6;">
                        <strong style="color: ${
                          shouldQuit ? "var(--red-800)" : "var(--blue-800)"
                        };">
                          ${
                            shouldQuit
                              ? "‚ùå Additional cost:"
                              : "‚úÖ Small additional cost:"
                          }
                        </strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                          <li>$${adjustedFutureCost.toFixed(
                            2
                          )} opportunity cost</li>
                          <li>${remainingTime} more minutes</li>
                          <li>${
                            satisfaction <= 3
                              ? "High suffering (low satisfaction)"
                              : satisfaction >= 7
                              ? "Minimal suffering (high satisfaction)"
                              : "Moderate suffering"
                          }</li>
                        </ul>
                      </div>

                      ${
                        shouldQuit
                          ? `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--red-50); border-radius: 0.375rem;
                                    font-size: 0.75rem; border-left: 3px solid var(--red-600);">
                          <strong>‚ö†Ô∏è Sunk Cost Fallacy Alert:</strong>
                          <br>Your brain says: "I paid $${sunkMoney}, I must finish!"
                          <br>Reality: That money is GONE. Staying = throwing $${adjustedFutureCost.toFixed(
                            2
                          )} after bad.
                        </div>
                      `
                          : `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--blue-50); border-radius: 0.375rem;
                                    font-size: 0.75rem; border-left: 3px solid var(--blue-600);">
                          <strong>üí° You're close to the end!</strong>
                          <br>Only ${remainingTime} min left, might as well finish.
                          <br>The additional cost is small relative to sunk cost.
                        </div>
                      `
                      }
                    </div>
                  </div>

                  <!-- Psychology Explanation -->
                  <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                              padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--indigo-600);">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                      üß† Understanding the Sunk Cost Fallacy
                    </h4>

                    <div style="font-size: 0.875rem; line-height: 1.7; color: var(--slate-700);">
                      <p style="margin-bottom: 1rem;">
                        <strong>What is it?</strong> The sunk cost fallacy is the tendency to continue an endeavor
                        once an investment (money, time, effort) has been made, even when abandoning it would be more beneficial.
                      </p>

                      <p style="margin-bottom: 1rem;">
                        <strong>Why does your brain do this?</strong> Humans have loss aversion - we hate "wasting"
                        what we've already spent. But that cost is GONE regardless of your next decision.
                      </p>

                      <p style="margin-bottom: 1rem;">
                        <strong>The rational approach:</strong> Ignore sunk costs completely.
                        Only compare: <em>"What will I gain/lose from this point forward?"</em>
                      </p>

                      <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                        <strong style="color: var(--indigo-700);">Real-world examples:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                          <li>Finishing a terrible book you bought</li>
                          <li>Sitting through a boring movie</li>
                          <li>Continuing a failing business venture</li>
                          <li>Staying in a bad relationship</li>
                          <li>Eating food you don't like (already paid for buffet)</li>
                        </ul>
                      </div>

                      <div style="margin-top: 1rem; padding: 1rem; background: var(--indigo-100); border-radius: 0.5rem;">
                        <strong style="color: var(--indigo-900);">üéØ Your Decision:</strong>
                        <br><br>
                        Sunk cost (GONE): <strong>$${totalSunkCost.toFixed(
                          2
                        )}</strong>
                        <br>Future cost if stay: <strong>$${adjustedFutureCost.toFixed(
                          2
                        )}</strong>
                        <br>Savings if quit: <strong>$${savingsFromQuitting.toFixed(
                          2
                        )}</strong>
                        <br><br>
                        ${
                          shouldQuit
                            ? `<span style="color: var(--red-700); font-weight: 700;">
                            ‚ö†Ô∏è The sunk $${totalSunkCost.toFixed(
                              2
                            )} is already lost. Don't lose another $${adjustedFutureCost.toFixed(
                                2
                              )}!</span>`
                            : `<span style="color: var(--green-700); font-weight: 700;">
                            ‚úÖ You're almost done - the additional $${adjustedFutureCost.toFixed(
                              2
                            )} is worth completing.</span>`
                        }
                      </div>
                    </div>
                  </div>

                  <!-- Action Plan -->
                  ${
                    shouldQuit
                      ? `
                    <div style="margin-top: 1.5rem; padding: 1.5rem; background: var(--green-50); border-radius: 0.75rem;
                                border: 2px solid var(--green-400);">
                      <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem;">
                        üéØ Action Plan: What to Do Right Now
                      </h4>
                      <ol style="margin: 0; padding-left: 1.5rem; font-size: 0.875rem; line-height: 1.8;">
                        <li><strong>Stand up and leave</strong> (or close the tab/book)</li>
                        <li><strong>Don't feel guilty</strong> - you made the rational choice</li>
                        <li><strong>Use the saved ${remainingTime} min wisely:</strong>
                          <ul style="margin-top: 0.5rem;">
                            <li>Work on a side project (+$${futureCost.toFixed(
                              2
                            )})</li>
                            <li>Learn something valuable (future income boost)</li>
                            <li>Exercise (health = wealth)</li>
                            <li>Quality time with loved ones (priceless)</li>
                          </ul>
                        </li>
                        <li><strong>Learn for next time:</strong> Avoid similar situations (read reviews, leave earlier)</li>
                      </ol>
                    </div>
                  `
                      : ""
                  }
                `;

            resultsDiv.classList.remove("hidden");
          });
      }

      function renderDIYvsPay() {
        return `
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
              üîß DIY vs Pay Professional Calculator
            </h3>
            <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
              "Should I fix it myself or hire someone?"
            </p>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">‚è∞ DIY Work Time (hours)</label>
                <input type="number" id="diyWorkTime" class="form-input" placeholder="4" step="0.5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Actual hands-on work
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üìö Learning Time (hours)</label>
                <input type="number" id="diyLearningTime" class="form-input" placeholder="2" step="0.5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  YouTube tutorials, reading manuals
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üé≤ Failure Risk (%)</label>
                <input type="number" id="failureRisk" class="form-input" placeholder="30" step="5" min="0" max="100">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Chance you mess it up (0-100%)
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üîÅ Redo Time if Fail (hours)</label>
                <input type="number" id="redoTime" class="form-input" placeholder="2" step="0.5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Time to fix your mistakes
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üí∞ Professional Cost ($)</label>
                <input type="number" id="professionalCost" class="form-input" placeholder="200" step="10">
              </div>

              <div class="form-group">
                <label class="form-label">üõ†Ô∏è Materials Cost ($)</label>
                <input type="number" id="materialsCost" class="form-input" placeholder="50" step="10">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Same for both DIY and pro
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üò∞ Stress Level (1-10)</label>
                <input type="range" id="stressLevel" class="form-input" min="1" max="10" value="7"
                       style="padding: 0.5rem 0;">
                <div style="text-align: center; font-size: 1.5rem; margin-top: 0.5rem;" id="stressEmoji">üò∞</div>
                <div style="text-align: center; font-size: 0.875rem; font-weight: 600; color: var(--slate-700);" id="stressValue">7/10</div>
              </div>

              <div class="form-group">
                <label class="form-label">üòä Do You Enjoy This?</label>
                <select id="enjoymentLevel" class="form-select">
                  <option value="0">üò´ Hate it (-$50 value)</option>
                  <option value="1">üòê Neutral ($0)</option>
                  <option value="2">üôÇ Mild enjoyment (+$25)</option>
                  <option value="3">üòÉ Love it (+$50)</option>
                </select>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Leisure value of DIY
                </div>
              </div>
            </div>

            <button class="btn btn-warning" id="calculateDIY">
              üî® Calculate: DIY or Hire?
            </button>
          </div>
        `;
      }

      function setupDIYvsPay(hourlyRate) {
        // Stress slider interactivity
        const stressSlider = document.getElementById("stressLevel");
        const stressEmoji = document.getElementById("stressEmoji");
        const stressValue = document.getElementById("stressValue");

        const stressEmojis = [
          "üòä",
          "üôÇ",
          "üòê",
          "üòï",
          "üòü",
          "üò∞",
          "üò´",
          "üò±",
          "ü§Ø",
          "üíÄ",
        ];

        stressSlider.addEventListener("input", (e) => {
          const value = parseInt(e.target.value);
          stressValue.textContent = `${value}/10`;
          stressEmoji.textContent = stressEmojis[value - 1];
        });

        document
          .getElementById("calculateDIY")
          .addEventListener("click", () => {
            if (hourlyRate === 0) {
              alert("Please set your hourly rate first!");
              return;
            }

            const diyWorkTime = parseFloat(
              document.getElementById("diyWorkTime").value
            );
            const diyLearningTime = parseFloat(
              document.getElementById("diyLearningTime").value
            );
            const failureRisk =
              parseFloat(document.getElementById("failureRisk").value) / 100;
            const redoTime = parseFloat(
              document.getElementById("redoTime").value
            );
            const professionalCost = parseFloat(
              document.getElementById("professionalCost").value
            );
            const materialsCost = parseFloat(
              document.getElementById("materialsCost").value
            );
            const stressLevel = parseInt(
              document.getElementById("stressLevel").value
            );
            const enjoymentLevel = parseInt(
              document.getElementById("enjoymentLevel").value
            );

            if (
              isNaN(diyWorkTime) ||
              isNaN(diyLearningTime) ||
              isNaN(failureRisk) ||
              isNaN(redoTime) ||
              isNaN(professionalCost) ||
              isNaN(materialsCost)
            ) {
              alert("Please fill in all fields");
              return;
            }

            // DIY Calculations
            const totalDIYTime = diyWorkTime + diyLearningTime;
            const diyTimeCost = totalDIYTime * hourlyRate;
            const failureCost =
              failureRisk * (redoTime * hourlyRate + materialsCost); // Risk of wasting time + materials
            const stressCost = (stressLevel / 10) * 50; // High stress = up to $50 penalty

            const enjoymentValues = [-50, 0, 25, 50];
            const enjoymentValue = enjoymentValues[enjoymentLevel];

            const totalDIYCost =
              diyTimeCost +
              failureCost +
              stressCost +
              materialsCost -
              enjoymentValue;

            // Professional Calculations
            const professionalTimeSaved = totalDIYTime;
            const professionalOpportunityCost =
              professionalTimeSaved * hourlyRate - professionalCost; // Negative if pro is more expensive than your time saved
            const totalProfessionalCost =
              professionalCost + materialsCost - professionalOpportunityCost;

            const shouldHirePro = totalProfessionalCost < totalDIYCost;
            const savings = Math.abs(totalDIYCost - totalProfessionalCost);

            const resultsDiv = document.getElementById("timeMoneyResults");

            resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center;
                        color: ${
                          shouldHirePro ? "var(--blue-700)" : "var(--green-700)"
                        };">
              ${
                shouldHirePro
                  ? "üíº HIRE THE PROFESSIONAL"
                  : "üî® DO IT YOURSELF (DIY)"
              }
            </h3>

            <!-- Comparison Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
              <!-- DIY Option -->
              <div style="background: linear-gradient(135deg, var(--orange-50), var(--red-50));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                            !shouldHirePro
                              ? "var(--green-600)"
                              : "var(--orange-300)"
                          };
                          ${
                            !shouldHirePro
                              ? "box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
                              : ""
                          }">
                <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--orange-900); margin-bottom: 1rem; text-align: center;">
                  ${!shouldHirePro ? "‚úÖ" : "‚ùå"} DIY OPTION
                </h4>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Cost</div>
                    <div style="font-size: 2rem; font-weight: 800; color: ${
                      !shouldHirePro ? "var(--green-600)" : "var(--orange-600)"
                    };">
                      $${totalDIYCost.toFixed(2)}
                    </div>
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                  <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-700); margin-bottom: 0.75rem;">
                    Cost Breakdown:
                                </h5>
                                <div style="font-size: 0.8rem; line-height: 1.8; color: var(--slate-600);">
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>‚è∞ Time cost (${totalDIYTime}h)</span>
                                    <span style="font-weight: 600;">$${diyTimeCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üé≤ Failure risk (${(
                                      failureRisk * 100
                                    ).toFixed(0)}%)</span>
                                    <span style="font-weight: 600;">$${failureCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üò∞ Stress penalty</span>
                                    <span style="font-weight: 600;">$${stressCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üõ†Ô∏è Materials</span>
                                    <span style="font-weight: 600;">$${materialsCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; ${
                                    enjoymentValue >= 0
                                      ? "color: var(--green-600);"
                                      : "color: var(--red-600);"
                                  }">
                                    <span>üòä Enjoyment value</span>
                                    <span style="font-weight: 600;">${
                                      enjoymentValue >= 0 ? "+" : ""
                                    }$${enjoymentValue.toFixed(2)}</span>
                                  </div>
                                </div>
                              </div>

                              <div style="font-size: 0.875rem; line-height: 1.6;">
                                <strong style="color: ${
                                  !shouldHirePro
                                    ? "var(--green-800)"
                                    : "var(--orange-800)"
                                };">
                                  ${!shouldHirePro ? "‚úÖ Pros:" : "‚ö†Ô∏è Risks:"}
                                </strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                  ${
                                    !shouldHirePro
                                      ? `
                                    <li>Save $${savings.toFixed(
                                      2
                                    )} vs hiring pro</li>
                                    <li>Learn a new skill (${diyLearningTime}h investment)</li>
                                    ${
                                      enjoymentValue > 0
                                        ? "<li>Enjoyable activity (+$" +
                                          enjoymentValue +
                                          ")</li>"
                                        : ""
                                    }
                                  `
                                      : `
                                    <li>Lose $${savings.toFixed(
                                      2
                                    )} vs hiring pro</li>
                                    <li>${(failureRisk * 100).toFixed(
                                      0
                                    )}% chance of failure</li>
                                    <li>High stress (${stressLevel}/10)</li>
                                    <li>${totalDIYTime}h of your valuable time</li>
                                  `
                                  }
                                </ul>
                              </div>

                              <div style="margin-top: 1rem; padding: 0.75rem; background: ${
                                !shouldHirePro
                                  ? "var(--green-50)"
                                  : "var(--orange-100)"
                              }; 
                                          border-radius: 0.375rem; font-size: 0.75rem; border-left: 3px solid ${
                                            !shouldHirePro
                                              ? "var(--green-600)"
                                              : "var(--orange-600)"
                                          };">
                                ${
                                  !shouldHirePro
                                    ? `
                                  <strong>üéØ When DIY makes sense:</strong>
                                  <br>‚úÖ You enjoy it (leisure value)
                                  <br>‚úÖ Skill has future value (recurring task)
                                  <br>‚úÖ Pro cost > 2√ó your time value
                                `
                                    : `
                                  <strong>‚ö†Ô∏è DIY Warning:</strong>
                                  <br>You're paying $${totalDIYCost.toFixed(
                                    2
                                  )} to do something
                                  <br>a pro would do for $${professionalCost.toFixed(
                                    2
                                  )}.
                                `
                                }
                              </div>
                            </div>

                            <!-- Professional Option -->
                            <div style="background: linear-gradient(135deg, var(--blue-50), var(--cyan-50)); 
                                        padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                                          shouldHirePro
                                            ? "var(--blue-600)"
                                            : "var(--blue-300)"
                                        };
                                        ${
                                          shouldHirePro
                                            ? "box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);"
                                            : ""
                                        }">
                              <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--blue-900); margin-bottom: 1rem; text-align: center;">
                                ${shouldHirePro ? "‚úÖ" : "‚ùå"} HIRE PROFESSIONAL
                              </h4>

                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <div style="text-align: center;">
                                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Cost</div>
                                  <div style="font-size: 2rem; font-weight: 800; color: ${
                                    shouldHirePro
                                      ? "var(--blue-600)"
                                      : "var(--red-600)"
                                  };">
                                    $${totalProfessionalCost.toFixed(2)}
                                  </div>
                                </div>
                              </div>

                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-700); margin-bottom: 0.75rem;">
                                  Cost Breakdown:
                                </h5>
                                <div style="font-size: 0.8rem; line-height: 1.8; color: var(--slate-600);">
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üíº Service fee</span>
                                    <span style="font-weight: 600;">$${professionalCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üõ†Ô∏è Materials</span>
                                    <span style="font-weight: 600;">$${materialsCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; color: var(--green-600);">
                                    <span>‚è∞ Time saved (${professionalTimeSaved}h)</span>
                                    <span style="font-weight: 600;">-$${Math.abs(
                                      professionalOpportunityCost
                                    ).toFixed(2)}</span>
                                  </div>
                                </div>
                              </div>

                              <div style="font-size: 0.875rem; line-height: 1.6;">
                                <strong style="color: ${
                                  shouldHirePro
                                    ? "var(--blue-800)"
                                    : "var(--red-800)"
                                };">
                                  ${
                                    shouldHirePro
                                      ? "‚úÖ Benefits:"
                                      : "‚ö†Ô∏è Downside:"
                                  }
                                </strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                  ${
                                    shouldHirePro
                                      ? `
                                    <li>Save $${savings.toFixed(2)} net</li>
                                    <li>Zero stress üòä</li>
                                    <li>Guaranteed quality</li>
                                    <li>Save ${professionalTimeSaved}h ($${(
                                          professionalTimeSaved * hourlyRate
                                        ).toFixed(2)} value)</li>
                                    <li>Use time for higher-value work</li>
                                  `
                                      : `
                                    <li>Pay $${savings.toFixed(
                                      2
                                    )} more than DIY</li>
                                    <li>No skill gained</li>
                                    <li>Less satisfying if you enjoy DIY</li>
                                  `
                                  }
                                </ul>
                              </div>

                              <div style="margin-top: 1rem; padding: 0.75rem; background: ${
                                shouldHirePro
                                  ? "var(--blue-50)"
                                  : "var(--slate-100)"
                              }; 
                                          border-radius: 0.375rem; font-size: 0.75rem; border-left: 3px solid ${
                                            shouldHirePro
                                              ? "var(--blue-600)"
                                              : "var(--slate-400)"
                                          };">
                                ${
                                  shouldHirePro
                                    ? `
                                  <strong>üí° Best use of saved ${professionalTimeSaved}h:</strong>
                                  <br>‚Ä¢ Work/freelance ‚Üí Earn $${(
                                    professionalTimeSaved * hourlyRate
                                  ).toFixed(2)}
                                  <br>‚Ä¢ Learn high-value skill
                                  <br>‚Ä¢ Quality time with family
                                  <br>‚Ä¢ Rest & recharge
                                `
                                    : `
                                  <strong>When to hire a pro:</strong>
                                  <br>‚Ä¢ Pro cost < Your time value
                                  <br>‚Ä¢ High failure risk
                                  <br>‚Ä¢ You hate the task
                                  <br>‚Ä¢ One-time job (no skill reuse)
                                `
                                }
                              </div>
                            </div>
                          </div>

                          <!-- Decision Matrix -->
                          <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50)); 
                                      padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--indigo-600); margin-bottom: 2rem;">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                              üéØ The Math Behind Your Decision
                            </h4>

                            <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; font-size: 0.875rem; margin-bottom: 1rem;">
                              <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: center;">
                                <span><strong>Your hourly rate:</strong></span>
                                <span style="font-weight: 700; color: var(--indigo-700);">$${hourlyRate.toFixed(
                                  2
                                )}/hr</span>
                                
                                <span>DIY time investment:</span>
                                <span>${totalDIYTime}h = $${diyTimeCost.toFixed(
              2
            )}</span>
                                
                                <span>Professional fee:</span>
                                <span>$${professionalCost.toFixed(2)}</span>
                                
                                <span style="padding-top: 0.5rem; border-top: 2px solid var(--slate-200);"><strong>Break-even analysis:</strong></span>
                                <span style="padding-top: 0.5rem; border-top: 2px solid var(--slate-200);"></span>
                                
                                <span>DIY makes sense if pro cost ></span>
                                <span style="font-weight: 700; color: var(--green-600);">$${(
                                  diyTimeCost * 2
                                ).toFixed(2)}</span>
                              </div>
                            </div>

                            <div style="font-size: 0.875rem; line-height: 1.7; color: var(--slate-700);">
                              <p style="margin-bottom: 0.5rem;">
                                <strong>Rule of thumb:</strong> Hire a pro if the cost is less than 2√ó your time value.
                              </p>
                              <p style="margin-bottom: 0.5rem;">
                                In your case: Pro costs $${professionalCost.toFixed(
                                  2
                                )}, your time is worth $${diyTimeCost.toFixed(
              2
            )}.
                              </p>
                              <p>
                                <strong>Verdict:</strong> 
                                ${
                                  shouldHirePro
                                    ? `Pro is ${(
                                        (1 -
                                          totalProfessionalCost /
                                            totalDIYCost) *
                                        100
                                      ).toFixed(0)}% cheaper than DIY. ‚úÖ`
                                    : `DIY is ${(
                                        (1 -
                                          totalDIYCost /
                                            totalProfessionalCost) *
                                        100
                                      ).toFixed(0)}% cheaper than pro. ${
                                        enjoymentValue > 0
                                          ? "(Plus you enjoy it!) üéâ"
                                          : ""
                                      }`
                                }
                              </p>
                            </div>
                          </div>

                          <!-- Special Cases -->
                          <div style="background: var(--slate-50); padding: 1.5rem; border-radius: 0.75rem;">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              ü§î When Should You Override This Recommendation?
                            </h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--green-600);">
                                <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--green-800); margin-bottom: 0.75rem;">
                                  ‚úÖ DIY Even If More Expensive:
                                </h5>
                                <ul style="font-size: 0.8rem; line-height: 1.6; margin: 0; padding-left: 1.5rem;">
                                  <li>You genuinely enjoy the work</li>
                                  <li>Skill has future value (recurring task)</li>
                                  <li>Learning experience worth the cost</li>
                                  <li>Emergency & can't wait for pro</li>
                                  <li>Simple task, low failure risk</li>
                                </ul>
                              </div>

                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--blue-600);">
                                <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--blue-800); margin-bottom: 0.75rem;">
                                  üíº Hire Pro Even If DIY Cheaper:
                                </h5>
                                <ul style="font-size: 0.8rem; line-height: 1.6; margin: 0; padding-left: 1.5rem;">
                                  <li>Dangerous work (electrical, structural)</li>
                                  <li>Warranty/insurance required</li>
                                  <li>High stakes (can't afford failure)</li>
                                  <li>One-time job (no skill reuse)</li>
                                  <li>You're already overwhelmed</li>
                                </ul>
                              </div>
                            </div>
                          </div>

                          <!-- Real Examples -->
                          <div style="margin-top: 1.5rem; background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              üìä Real-World Examples (Based on $${hourlyRate.toFixed(
                                2
                              )}/hr rate)
                            </h4>
                            
                            <div style="overflow-x: auto;">
                              <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                <thead>
                                  <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Task</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">DIY Time</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Pro Cost</th>
                                    <th style="padding: 0.75rem; text-align: center; font-weight: 600;">Verdict</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  ${[
                                    {
                                      task: "Oil change",
                                      diyTime: 0.5,
                                      proCost: 40,
                                      verdict:
                                        hourlyRate * 0.5 < 40 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Lawn mowing",
                                      diyTime: 1,
                                      proCost: 50,
                                      verdict:
                                        hourlyRate * 1 < 50 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "House cleaning",
                                      diyTime: 3,
                                      proCost: 120,
                                      verdict:
                                        hourlyRate * 3 < 120 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Assemble IKEA furniture",
                                      diyTime: 2,
                                      proCost: 80,
                                      verdict:
                                        hourlyRate * 2 < 80 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Paint room",
                                      diyTime: 8,
                                      proCost: 400,
                                      verdict:
                                        hourlyRate * 8 < 400 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Fix leaky faucet",
                                      diyTime: 1.5,
                                      proCost: 150,
                                      verdict:
                                        hourlyRate * 1.5 < 150 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Tax filing",
                                      diyTime: 4,
                                      proCost: 200,
                                      verdict:
                                        hourlyRate * 4 < 200 ? "DIY" : "Pro",
                                    },
                                  ]
                                    .map((item) => {
                                      const diyValue =
                                        hourlyRate * item.diyTime;
                                      const shouldDIY = diyValue < item.proCost;
                                      return `
                                      <tr style="border-bottom: 1px solid var(--slate-200);">
                                        <td style="padding: 0.75rem;">${
                                          item.task
                                        }</td>
                                        <td style="padding: 0.75rem; text-align: right;">${
                                          item.diyTime
                                        }h ($${diyValue.toFixed(0)})</td>
                                        <td style="padding: 0.75rem; text-align: right;">$${
                                          item.proCost
                                        }</td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                          <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: 600;
                                                      background: ${
                                                        shouldDIY
                                                          ? "var(--green-100)"
                                                          : "var(--blue-100)"
                                                      };
                                                      color: ${
                                                        shouldDIY
                                                          ? "var(--green-800)"
                                                          : "var(--blue-800)"
                                                      };">
                                            ${shouldDIY ? "üî® DIY" : "üíº Hire"}
                                          </span>
                                        </td>
                                      </tr>
                                    `;
                                    })
                                    .join("")}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        `;

            resultsDiv.classList.remove("hidden");
          });
      }

      function renderActivityROI() {
        return `
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
              üìä Activity ROI Comparator
            </h3>
            <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
              "Compare multiple activities to find the best use of your time"
            </p>

            <div id="activitiesContainer">
              <!-- Activities will be added here -->
            </div>

            <button class="btn btn-secondary" id="addActivityBtn" style="margin-bottom: 1rem;">
              ‚ûï Add Activity to Compare
            </button>

            <button class="btn btn-success" id="compareActivitiesBtn">
              üìä Compare & Rank Activities
            </button>
          </div>
        `;
      }

      function setupActivityROI(hourlyRate) {
        let activities = [];
        let activityCounter = 1;

        // Add initial activities
        addActivity();
        addActivity();

        function addActivity() {
          const id = activityCounter++;
          activities.push({
            id,
            name: `Activity ${id}`,
            timeHours: 0,
            moneyImpact: 0,
            type: "cost", // cost or income
            futureValue: 0,
            enjoyment: 5,
          });
          renderActivities();
        }

        function removeActivity(id) {
          activities = activities.filter((a) => a.id !== id);
          renderActivities();
        }

        function renderActivities() {
          const container = document.getElementById("activitiesContainer");

          container.innerHTML = activities
            .map(
              (activity) => `
            <div class="activity-row" data-activity-id="${activity.id}" style="
              background: var(--slate-50); 
              padding: 1rem; 
              border-radius: 0.5rem; 
              margin-bottom: 1rem;
              border: 2px solid var(--slate-200);
            ">
              <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Activity Name</label>
                  <input type="text" class="form-input activity-name" value="${
                    activity.name
                  }" 
                        placeholder="e.g. Freelance work, Cook at home">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Time (hours)</label>
                  <input type="number" class="form-input activity-time" value="${
                    activity.timeHours
                  }" 
                        placeholder="2" step="0.25">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Type</label>
                  <select class="form-select activity-type">
                    <option value="income" ${
                      activity.type === "income" ? "selected" : ""
                    }>üí∞ Earn Money</option>
                    <option value="cost" ${
                      activity.type === "cost" ? "selected" : ""
                    }>üí∏ Save Money</option>
                    <option value="expense" ${
                      activity.type === "expense" ? "selected" : ""
                    }>‚ùå Costs Money</option>
                    <option value="learning" ${
                      activity.type === "learning" ? "selected" : ""
                    }>üìö Learning</option>
                    <option value="leisure" ${
                      activity.type === "leisure" ? "selected" : ""
                    }>üòä Leisure</option>
                  </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">$ Amount</label>
                  <input type="number" class="form-input activity-money" value="${
                    activity.moneyImpact
                  }" 
                        placeholder="50" step="10">
                </div>
                
                <button class="remove-activity-btn" data-activity-id="${
                  activity.id
                }" style="
                  background: var(--red-500);
                  color: white;
                  border: none;
                  border-radius: 0.375rem;
                  padding: 0.5rem 0.75rem;
                  cursor: pointer;
                  font-weight: 600;
                ">
                  üóëÔ∏è
                </button>
              </div>

              <!-- Additional fields for learning/leisure -->
              ${
                activity.type === "learning"
                  ? `
                <div style="margin-top: 1rem;">
                  <label class="form-label">Future Monthly Income Boost ($)</label>
                  <input type="number" class="form-input activity-future" value="${activity.futureValue}" 
                        placeholder="500" step="50">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                    Expected income increase from this skill
                  </div>
                </div>
              `
                  : activity.type === "leisure"
                  ? `
                <div style="margin-top: 1rem;">
                  <label class="form-label">Enjoyment Value (1-10)</label>
                  <input type="range" class="form-input activity-enjoyment" min="1" max="10" value="${
                    activity.enjoyment
                  }" 
                        style="padding: 0.5rem 0;">
                  <div style="text-align: center; font-size: 0.875rem; margin-top: 0.25rem;">
                    <strong>${activity.enjoyment}/10</strong> - Worth $${(
                      activity.enjoyment * 10
                    ).toFixed(0)} in mental health value
                  </div>
                </div>
              `
                  : ""
              }
            </div>
          `
            )
            .join("");

          // Attach event listeners
          document.querySelectorAll(".remove-activity-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const activityId = parseInt(e.target.dataset.activityId);
              if (activities.length > 1) {
                removeActivity(activityId);
              } else {
                alert("You must have at least one activity");
              }
            });
          });

          // Update activity data on input change
          document.querySelectorAll(".activity-row").forEach((row) => {
            const activityId = parseInt(row.dataset.activityId);
            const activity = activities.find((a) => a.id === activityId);

            row
              .querySelector(".activity-name")
              .addEventListener("input", (e) => {
                activity.name = e.target.value;
              });

            row
              .querySelector(".activity-time")
              .addEventListener("input", (e) => {
                activity.timeHours = parseFloat(e.target.value) || 0;
              });

            row
              .querySelector(".activity-type")
              .addEventListener("change", (e) => {
                activity.type = e.target.value;
                renderActivities(); // Re-render to show/hide additional fields
              });

            row
              .querySelector(".activity-money")
              .addEventListener("input", (e) => {
                activity.moneyImpact = parseFloat(e.target.value) || 0;
              });

            const futureInput = row.querySelector(".activity-future");
            if (futureInput) {
              futureInput.addEventListener("input", (e) => {
                activity.futureValue = parseFloat(e.target.value) || 0;
              });
            }

            const enjoymentInput = row.querySelector(".activity-enjoyment");
            if (enjoymentInput) {
              enjoymentInput.addEventListener("input", (e) => {
                activity.enjoyment = parseInt(e.target.value);
                renderActivities(); // Update enjoyment display
              });
            }
          });
        }

        document
          .getElementById("addActivityBtn")
          .addEventListener("click", () => {
            if (activities.length < 10) {
              addActivity();
            } else {
              alert("Maximum 10 activities allowed");
            }
          });

        document
          .getElementById("compareActivitiesBtn")
          .addEventListener("click", () => {
            if (hourlyRate === 0) {
              alert("Please set your hourly rate first!");
              return;
            }

            if (
              activities.some((a) => a.timeHours === 0 || a.name.trim() === "")
            ) {
              alert("Please fill in all activity names and time values");
              return;
            }

            // Calculate ROI for each activity
            const results = activities.map((activity) => {
              const timeCost = activity.timeHours * hourlyRate;
              let netValue = 0;
              let roi = 0;
              let description = "";

              switch (activity.type) {
                case "income":
                  netValue = activity.moneyImpact - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Earn $${activity.moneyImpact} in ${activity.timeHours}h`;
                  break;

                case "cost":
                  netValue = activity.moneyImpact - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Save $${activity.moneyImpact} in ${activity.timeHours}h`;
                  break;

                case "expense":
                  netValue = -(activity.moneyImpact + timeCost);
                  roi = (netValue / timeCost) * 100;
                  description = `Costs $${activity.moneyImpact} + ${activity.timeHours}h time`;
                  break;

                case "learning":
                  // Assume skill pays off over 12 months
                  const futureGainPV = activity.futureValue * 6; // 6 months of benefit (conservative)
                  netValue = futureGainPV - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Learn ‚Üí +$${activity.futureValue}/mo future income`;
                  break;

                case "leisure":
                  const leisureValue = activity.enjoyment * 10; // $10 per enjoyment point
                  netValue = leisureValue - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Leisure (${activity.enjoyment}/10 enjoyment)`;
                  break;
              }

              return {
                ...activity,
                timeCost,
                netValue,
                roi,
                description,
                hourlyRate: netValue / activity.timeHours,
              };
            });

            // Sort by ROI (highest first)
            results.sort((a, b) => b.roi - a.roi);

            displayActivityResults(results, hourlyRate);
          });

        function displayActivityResults(results, hourlyRate) {
          const resultsDiv = document.getElementById("timeMoneyResults");

          const medals = [
            "ü•á",
            "ü•à",
            "ü•â",
            "4Ô∏è‚É£",
            "5Ô∏è‚É£",
            "6Ô∏è‚É£",
            "7Ô∏è‚É£",
            "8Ô∏è‚É£",
            "9Ô∏è‚É£",
            "üîü",
          ];

          resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
              üèÜ Activity Rankings (Best to Worst ROI)
            </h3>

            <!-- Top 3 Podium -->
            ${
              results.length >= 3
                ? `
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                ${[1, 0, 2]
                  .map((idx) => {
                    const activity = results[idx];
                    const colors = [
                      {
                        bg: "linear-gradient(135deg, var(--yellow-50), var(--yellow-100))",
                        border: "var(--yellow-500)",
                        text: "var(--yellow-800)",
                      },
                      {
                        bg: "linear-gradient(135deg, var(--slate-50), var(--slate-100))",
                        border: "var(--slate-400)",
                        text: "var(--slate-700)",
                      },
                      {
                        bg: "linear-gradient(135deg, var(--orange-50), var(--orange-100))",
                        border: "var(--orange-500)",
                        text: "var(--orange-800)",
                      },
                    ];
                    const rank = idx === 0 ? 1 : idx === 1 ? 0 : 2; // Gold=0, Silver=1, Bronze=2
                    const color = colors[rank];

                    return `
                                  <div style="background: ${
                                    color.bg
                                  }; padding: 1.5rem; border-radius: 0.75rem; 
                                              border: 3px solid ${
                                                color.border
                                              }; text-align: center;
                                              ${
                                                rank === 0
                                                  ? "transform: scale(1.05); box-shadow: 0 8px 16px rgba(234, 179, 8, 0.3);"
                                                  : ""
                                              }">
                                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">
                                      ${medals[idx]}
                                    </div>
                                    <h4 style="font-size: 1rem; font-weight: 700; color: ${
                                      color.text
                                    }; margin-bottom: 0.75rem;">
                                      ${activity.name}
                                    </h4>
                                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">ROI</div>
                                      <div style="font-size: 1.75rem; font-weight: 800; color: ${
                                        activity.roi >= 0
                                          ? "var(--green-600)"
                                          : "var(--red-600)"
                                      };">
                                        ${
                                          activity.roi >= 0 ? "+" : ""
                                        }${activity.roi.toFixed(0)}%
                                      </div>
                                    </div>
                                    <div style="font-size: 0.8rem; line-height: 1.5; color: ${
                                      color.text
                                    };">
                                      <strong>Net Value:</strong> ${
                                        activity.netValue >= 0 ? "+" : ""
                                      }$${activity.netValue.toFixed(0)}<br>
                                      <strong>Effective Rate:</strong> $${activity.hourlyRate.toFixed(
                                        0
                                      )}/hr<br>
                                      <strong>Time:</strong> ${
                                        activity.timeHours
                                      }h
                                    </div>
                                  </div>
                                `;
                  })
                  .join("")}
                            </div>
                          `
                : ""
            }
                          
                          <!-- Detailed Table -->
                          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              üìä Complete Analysis
                            </h4>
                            
                            <div style="overflow-x: auto;">
                              <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                  <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Rank</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Activity</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Time</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Time Cost</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">$ Impact</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Net Value</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Effective Rate</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">ROI</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  ${results
                                    .map((activity, idx) => {
                                      const isGood = activity.roi >= 0;
                                      const rowColor = isGood
                                        ? "background: var(--green-50);"
                                        : idx < 3
                                        ? "background: var(--yellow-50);"
                                        : "background: var(--red-50);";

                                      return `
                                      <tr style="border-bottom: 1px solid var(--slate-200); ${rowColor}">
                                        <td style="padding: 0.75rem; font-weight: 700; font-size: 1.2rem;">
                                          ${medals[idx]} #${idx + 1}
                                        </td>
                                        <td style="padding: 0.75rem;">
                                          <div style="font-weight: 600; color: var(--slate-800);">${
                                            activity.name
                                          }</div>
                                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                                            ${activity.description}
                                          </div>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right;">${
                                          activity.timeHours
                                        }h</td>
                                        <td style="padding: 0.75rem; text-align: right; color: var(--red-600);">
                                          -$${activity.timeCost.toFixed(0)}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                          ${getMoneyImpactDisplay(activity)}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 700; color: ${
                                          isGood
                                            ? "var(--green-600)"
                                            : "var(--red-600)"
                                        };">
                                          ${
                                            activity.netValue >= 0 ? "+" : ""
                                          }$${activity.netValue.toFixed(0)}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                          $${activity.hourlyRate.toFixed(0)}/hr
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 700; font-size: 1rem; color: ${
                                          isGood
                                            ? "var(--green-700)"
                                            : "var(--red-700)"
                                        };">
                                          ${
                                            activity.roi >= 0 ? "+" : ""
                                          }${activity.roi.toFixed(0)}%
                                        </td>
                                      </tr>
                                    `;
                                    })
                                    .join("")}
                                </tbody>
                              </table>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--slate-50); border-radius: 0.5rem; font-size: 0.875rem;">
                              <strong>üìå How to read this table:</strong><br>
                              ‚Ä¢ <strong>Time Cost:</strong> Opportunity cost of your time (${
                                activity.timeHours
                              }h √ó $${hourlyRate}/hr)<br>
                              ‚Ä¢ <strong>Net Value:</strong> Total gain/loss after accounting for your time<br>
                              ‚Ä¢ <strong>Effective Rate:</strong> What you're "paying yourself" for this activity<br>
                              ‚Ä¢ <strong>ROI:</strong> Return on investment of your time<br><br>
                              <span style="color: var(--green-700); font-weight: 600;">‚úÖ Positive ROI = Good use of time</span><br>
                              <span style="color: var(--red-700); font-weight: 600;">‚ùå Negative ROI = Losing money vs other options</span>
                            </div>
                          </div>
                          
                          <!-- Key Insights -->
                          <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50)); 
                                      padding: 1.5rem; border-radius: 0.75rem; margin-top: 2rem; border-left: 4px solid var(--indigo-600);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                              üí° Key Insights & Recommendations
                            </h4>
                            
                            ${generateInsights(results, hourlyRate)}
                          </div>
                          
                          <!-- Visualization -->
                          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; margin-top: 2rem; border: 1px solid var(--slate-200);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              üìà ROI Comparison Chart
                            </h4>
                            ${renderROIChart(results)}
                          </div>
                        `;

          resultsDiv.classList.remove("hidden");
        }

        function getMoneyImpactDisplay(activity) {
          switch (activity.type) {
            case "income":
              return `<span style="color: var(--green-600);">+$${activity.moneyImpact.toFixed(
                0
              )}</span>`;
            case "cost":
              return `<span style="color: var(--green-600);">Save $${activity.moneyImpact.toFixed(
                0
              )}</span>`;
            case "expense":
              return `<span style="color: var(--red-600);">-$${activity.moneyImpact.toFixed(
                0
              )}</span>`;
            case "learning":
              return `<span style="color: var(--purple-600);">+$${activity.futureValue.toFixed(
                0
              )}/mo</span>`;
            case "leisure":
              return `<span style="color: var(--blue-600);">${activity.enjoyment}/10 üòä</span>`;
          }
        }

        function generateInsights(results, hourlyRate) {
          const bestActivity = results[0];
          const worstActivity = results[results.length - 1];
          const goodActivities = results.filter((a) => a.roi >= 0);
          const badActivities = results.filter((a) => a.roi < 0);

          let insights = "";

          // Best activity
          insights += `
                          <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid var(--green-600);">
                            <strong style="color: var(--green-800);">ü•á Best Activity: ${
                              bestActivity.name
                            }</strong><br>
                            <span style="font-size: 0.875rem;">
                              This is your highest ROI activity at ${bestActivity.roi.toFixed(
                                0
                              )}%. 
                              You're effectively earning $${bestActivity.hourlyRate.toFixed(
                                0
                              )}/hr, which is 
                              ${(
                                (bestActivity.hourlyRate / hourlyRate - 1) *
                                100
                              ).toFixed(0)}% better than your base rate.
                            </span>
                          </div>
                        `;

          // Worst activity warning
          if (worstActivity.roi < -50) {
            insights += `
                            <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid var(--red-600);">
                              <strong style="color: var(--red-800);">‚ö†Ô∏è Avoid: ${
                                worstActivity.name
                              }</strong><br>
                              <span style="font-size: 0.875rem;">
                                This activity has a ${worstActivity.roi.toFixed(
                                  0
                                )}% ROI, meaning you're losing 
                                $${Math.abs(worstActivity.netValue).toFixed(
                                  0
                                )}. Consider eliminating or outsourcing this.
                              </span>
                            </div>
                          `;
          }

          // Summary stats
          insights += `
                          <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: var(--indigo-800);">üìä Summary Statistics:</strong><br>
                            <div style="font-size: 0.875rem; line-height: 1.8; margin-top: 0.5rem;">
                              ‚Ä¢ <span style="color: var(--green-700); font-weight: 600;">${
                                goodActivities.length
                              } positive ROI activities</span> 
                                (total value: +$${goodActivities
                                  .reduce((sum, a) => sum + a.netValue, 0)
                                  .toFixed(0)})<br>
                              ‚Ä¢ <span style="color: var(--red-700); font-weight: 600;">${
                                badActivities.length
                              } negative ROI activities</span> 
                                (total loss: -$${Math.abs(
                                  badActivities.reduce(
                                    (sum, a) => sum + a.netValue,
                                    0
                                  )
                                ).toFixed(0)})<br>
                              ‚Ä¢ Your time is worth <strong>$${hourlyRate.toFixed(
                                2
                              )}/hr</strong> - any activity below this rate is a net loss<br>
                              ‚Ä¢ Best use of time: <strong>${
                                bestActivity.name
                              }</strong> at $${bestActivity.hourlyRate.toFixed(
            0
          )}/hr
                            </div>
                          </div>
                        `;

          return insights;
        }

        function renderROIChart(results) {
          const maxROI = Math.max(...results.map((a) => Math.abs(a.roi)));

          return `
                          <div style="position: relative;">
                            ${results
                              .map((activity, idx) => {
                                const isPositive = activity.roi >= 0;
                                const barWidth =
                                  (Math.abs(activity.roi) / maxROI) * 100;

                                return `
                                <div style="margin-bottom: 1rem;">
                                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="font-size: 0.875rem; font-weight: 600; color: var(--slate-700);">
                                      ${medals[idx]} ${activity.name}
                                    </div>
                                    <div style="font-size: 0.875rem; font-weight: 700; color: ${
                                      isPositive
                                        ? "var(--green-600)"
                                        : "var(--red-600)"
                                    };">
                                      ${
                                        activity.roi >= 0 ? "+" : ""
                                      }${activity.roi.toFixed(0)}%
                                    </div>
                                  </div>
                                  <div style="background: var(--slate-200); height: 30px; border-radius: 0.375rem; overflow: hidden; position: relative;">
                                    <div style="background: ${
                                      isPositive
                                        ? "linear-gradient(to right, var(--green-400), var(--green-600))"
                                        : "linear-gradient(to right, var(--red-400), var(--red-600))"
                                    }; 
                                                height: 100%; width: ${barWidth}%; 
                                                display: flex; align-items: center; padding-left: ${
                                                  barWidth > 20 ? "1rem" : "0"
                                                }; 
                                                color: white; font-weight: 700; font-size: 0.875rem; transition: width 0.5s;">
                                      ${
                                        barWidth > 20
                                          ? `$${activity.hourlyRate.toFixed(
                                              0
                                            )}/hr`
                                          : ""
                                      }
                                    </div>
                                    ${
                                      barWidth <= 20
                                        ? `
                                      <div style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); 
                                                  font-weight: 700; font-size: 0.875rem; color: var(--slate-600);">
                                        $${activity.hourlyRate.toFixed(0)}/hr
                                      </div>
                                    `
                                        : ""
                                    }
                                  </div>
                                </div>
                              `;
                              })
                              .join("")}
                          </div>
                          
                          <div style="margin-top: 1.5rem; text-align: center; font-size: 0.875rem; color: var(--slate-600);">
                            üìè Baseline: Your time is worth <strong>$${hourlyRate.toFixed(
                              2
                            )}/hour</strong>
                          </div>
                        `;
        }
      }


 

      // ==================== REAL ESTATE CALCULATION FUNCTIONS ====================
      function renderRealEstateCalculator() {
        return `
          <h2 class="calculator-title">Real Estate Investment Analyzer (REPE)</h2>
          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              Institutional-Grade Real Estate Underwriting
            </div>
            <p class="explanation-text">
              Analyze acquisition cashflow, NOI, DSCR, stress scenarios, and exit sensitivity for income-producing real estate.
              Modeled after commercial real estate private equity (REPE) underwriting standards.
            </p>
            <div class="explanation-note">
              <strong>üí° Pro Tip:</strong> Lenders typically require DSCR ‚â• 1.25x and Debt Yield ‚â• 8%.
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Purchase Price ($)</label>
              <input type="number" id="rePurchasePrice" class="form-input" placeholder="1000000" value="1000000">
            </div>
            <div class="form-group">
              <label class="form-label">Closing Costs (%)</label>
              <input type="number" id="reClosingCostsRate" class="form-input" placeholder="3" step="0.01" value="3">
            </div>
            <div class="form-group">
              <label class="form-label">Upfront Renovation ($)</label>
              <input type="number" id="reUpfrontRenovation" class="form-input" placeholder="50000" value="50000">
            </div>
            <div class="form-group">
              <label class="form-label">Monthly Rent ($)</label>
              <input type="number" id="reMonthlyRent" class="form-input" placeholder="5000" value="5000">
            </div>
            <div class="form-group">
              <label class="form-label">Vacancy Rate (%)</label>
              <input type="number" id="reVacancyRate" class="form-input" placeholder="5" step="0.01" value="5">
            </div>
            <div class="form-group">
              <label class="form-label">Annual Rent Growth (%)</label>
              <input type="number" id="reRentGrowthRate" class="form-input" placeholder="3" step="0.01" value="3">
            </div>
            <div class="form-group">
              <label class="form-label">Management Fee (%)</label>
              <input type="number" id="reManagementFeeRate" class="form-input" placeholder="8" step="0.01" value="8">
            </div>
            <div class="form-group">
              <label class="form-label">Maintenance (%)</label>
              <input type="number" id="reMaintenanceRate" class="form-input" placeholder="1" step="0.01" value="1">
            </div>
            <div class="form-group">
              <label class="form-label">Property Tax (%)</label>
              <input type="number" id="rePropertyTaxRate" class="form-input" placeholder="1" step="0.01" value="1">
            </div>
            <div class="form-group">
              <label class="form-label">Insurance (%)</label>
              <input type="number" id="reInsuranceRate" class="form-input" placeholder="0.5" step="0.01" value="0.5">
            </div>
            <div class="form-group">
              <label class="form-label">HOA / Month ($)</label>
              <input type="number" id="reHoaMonthly" class="form-input" placeholder="100" value="100">
            </div>
            <div class="form-group">
              <label class="form-label">Other Expenses / Year ($)</label>
              <input type="number" id="reOtherExpensesAnnual" class="form-input" placeholder="1000" value="1000">
            </div>

            <div class="form-group">
              <label class="form-label">Loan Amount ($)</label>
              <input type="number" id="reLoanAmount" class="form-input" placeholder="700000" value="700000">
            </div>
            <div class="form-group">
              <label class="form-label">Interest Rate (%)</label>
              <input type="number" id="reInterestRate" class="form-input" placeholder="7" step="0.01" value="7">
            </div>
            <div class="form-group">
              <label class="form-label">Loan Term (Years)</label>
              <input type="number" id="reLoanTermYears" class="form-input" placeholder="20" value="20">
            </div>
            <div class="form-group">
              <label class="form-label">Interest-Only Period (Years)</label>
              <input type="number" id="reInterestOnlyYears" class="form-input" placeholder="3" value="3">
            </div>
            <div class="form-group">
              <label class="form-label">Hold Period (Years)</label>
              <input type="number" id="reHoldYears" class="form-input" placeholder="10" value="10">
            </div>
            <div class="form-group">
              <label class="form-label">Annual Appreciation (%)</label>
              <input type="number" id="reAnnualAppreciation" class="form-input" placeholder="3" step="0.01" value="3">
            </div>
            <div class="form-group">
              <label class="form-label">Exit Cap Rate (%)</label>
              <input type="number" id="reExitCapRate" class="form-input" placeholder="6" step="0.01" value="6">
            </div>
          </div>

          <button class="btn btn-primary" id="calculateRealEstate">Analyze Investment</button>
          <div id="realEstateResults" class="results-container hidden"></div>
        `;
      }

      function setupRealEstateCalculator() {
        const calculateBtn = document.getElementById('calculateRealEstate');
        const resultsDiv = document.getElementById('realEstateResults');

        calculateBtn.addEventListener('click', () => {
          // Collect inputs
          const inputs = {
            purchasePrice: parseFloat(document.getElementById('rePurchasePrice').value) || 0,
            closingCostsRate: parseFloat(document.getElementById('reClosingCostsRate').value) / 100 || 0,
            upfrontRenovation: parseFloat(document.getElementById('reUpfrontRenovation').value) || 0,
            monthlyRent: parseFloat(document.getElementById('reMonthlyRent').value) || 0,
            vacancyRate: parseFloat(document.getElementById('reVacancyRate').value) / 100 || 0,
            rentGrowthRate: parseFloat(document.getElementById('reRentGrowthRate').value) / 100 || 0,
            managementFeeRate: parseFloat(document.getElementById('reManagementFeeRate').value) / 100 || 0,
            maintenanceRate: parseFloat(document.getElementById('reMaintenanceRate').value) / 100 || 0,
            propertyTaxRate: parseFloat(document.getElementById('rePropertyTaxRate').value) / 100 || 0,
            insuranceRate: parseFloat(document.getElementById('reInsuranceRate').value) / 100 || 0,
            hoaMonthly: parseFloat(document.getElementById('reHoaMonthly').value) || 0,
            otherExpensesAnnual: parseFloat(document.getElementById('reOtherExpensesAnnual').value) || 0,
            loanAmount: parseFloat(document.getElementById('reLoanAmount').value) || 0,
            interestRate: parseFloat(document.getElementById('reInterestRate').value) / 100 || 0,
            loanTermYears: parseInt(document.getElementById('reLoanTermYears').value) || 0,
            interestOnlyYears: parseInt(document.getElementById('reInterestOnlyYears').value) || 0,
            holdYears: parseInt(document.getElementById('reHoldYears').value) || 10,
            annualAppreciation: parseFloat(document.getElementById('reAnnualAppreciation').value) / 100 || 0,
            exitCapRate: parseFloat(document.getElementById('reExitCapRate').value) / 100 || 0.06,
            replacementReservesRate: 0.005,
            replacementReservesInflationRate: 0.02,
            expenseGrowthRate: 0.03,
            stressTestVacancyIncrease: 0.05,
            stressTestRentDecrease: 0.02,
            stressTestExpenseIncrease: 0.02,
            managementFeeBase: 'egi' // fixed for simplicity
          };

          // Basic validation
          if (inputs.purchasePrice <= 0 || inputs.monthlyRent <= 0) {
            alert('Please enter valid purchase price and rent.');
            return;
          }

          // Run analysis (Module A logic)
          const analysis = calculateRentalCashflowInstitutional(inputs);

          // Render results
          const riskColor = analysis.analysis.insights.riskLevel?.color || '#10B981';
          const riskLevel = analysis.analysis.insights.riskLevel?.level || 'LOW RISK';

          let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--slate-800);">Key Metrics</h3>
              <div style="background: ${riskColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 600; font-size: 0.875rem;">
                ${riskLevel}
              </div>
            </div>
            <div class="results-grid">
              <div class="result-card result-highlight">
                <div class="result-label">Year 1 NOI</div>
                <div class="result-value">${formatCurrency(analysis.year1.marketNOI)}</div>
              </div>
              <div class="result-card ${analysis.debt.dscr >= 1.25 ? 'result-positive' : 'result-negative'}">
                <div class="result-label">DSCR</div>
                <div class="result-value">${analysis.debt.dscr}x</div>
                <div class="result-subtext">${analysis.debt.dscr >= 1.25 ? '‚úì Meets Lender Std' : '‚ö†Ô∏è Below 1.25x'}</div>
              </div>
              <div class="result-card">
                <div class="result-label">Cap Rate</div>
                <div class="result-value">${formatPercent(analysis.metrics.capRate / 100)}</div>
              </div>
              <div class="result-card">
                <div class="result-label">OER</div>
                <div class="result-value">${analysis.metrics.oer}%</div>
                <div class="result-subtext">${analysis.metrics.oer < 40 ? 'Efficient' : 'High'}</div>
              </div>
              <div class="result-card">
                <div class="result-label">Break-Even Occupancy</div>
                <div class="result-value">${analysis.debt.breakEvenOccupancy}%</div>
              </div>
              <div class="result-card">
                <div class="result-label">Debt Yield</div>
                <div class="result-value">${analysis.debt.debtYield}%</div>
                <div class="result-subtext">${analysis.debt.debtYield >= 8 ? '‚úì OK' : '‚ö†Ô∏è <8%'}</div>
              </div>
            </div>
          `;

          // Add insights
          html += `<div style="margin-top: 2rem;">
            <h4 style="font-weight: 700; margin-bottom: 0.75rem; color: var(--slate-800);">Professional Insights</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
              <div style="background: var(--rose-50); border-left: 4px solid var(--rose-500); padding: 1rem; border-radius: var(--radius-md);">
                <strong>Warnings</strong>
                <ul style="margin-top: 0.5rem; padding-left: 1.25rem; color: var(--rose-800);">
                  ${analysis.analysis.insights.warnings.map(w => `<li>${w}</li>`).join('')}
                </ul>
              </div>
              <div style="background: var(--green-50); border-left: 4px solid var(--green-600); padding: 1rem; border-radius: var(--radius-md);">
                <strong>Strengths</strong>
                <ul style="margin-top: 0.5rem; padding-left: 1.25rem; color: var(--green-800);">
                  ${analysis.analysis.insights.strengths.map(s => `<li>${s}</li>`).join('')}
                </ul>
              </div>
            </div>
          </div>`;

          // Add stress test summary
          const failedTests = analysis.analysis.stressTests.filter(t => t.severity === 'HIGH').length;
          html += `
            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--slate-50); border-radius: var(--radius-md);">
              <strong>Stress Test Result:</strong> ${failedTests > 0 ? '‚ö†Ô∏è ' + failedTests + ' critical failure(s)' : '‚úÖ All scenarios pass'}
              <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--slate-600);">
                Tested: +5% vacancy, -2% rent, +2% expenses
              </div>
            </div>
          `;

          resultsDiv.innerHTML = html;
          resultsDiv.classList.remove('hidden');

          // Auto-save
          setTimeout(() => {
            StorageManager.saveCalculatorState('real-estate');
          }, 100);
        });
      }
    
      // ==================== REAL ESTATE - MODULE A ====================
      function roundFinancial(value, decimals = 2) {
        if (typeof value !== 'number' || isNaN(value)) return 0;
        const factor = Math.pow(10, decimals);
        const rounded = Math.round((value + Number.EPSILON) * factor) / factor;
        return Math.abs(rounded) < Math.pow(10, -decimals - 1) ? 0 : rounded;
      }

      function calculateRentalCashflowInstitutional(inputs) {
        const {
          purchasePrice,
          closingCostsRate = 0.03,
          upfrontRenovation = 0,
          monthlyRent,
          vacancyRate = 0.05,
          rentGrowthRate = 0.03,
          managementFeeRate = 0.08,
          managementFeeBase = 'egi',
          maintenanceRate = 0.01,
          propertyTaxRate = 0.01,
          propertyTaxReassessmentRate = 0,
          insuranceRate = 0.005,
          hoaMonthly = 0,
          utilitiesMonthly = 0,
          otherExpensesAnnual = 0,
          loanAmount = 0,
          interestRate = 0.07,
          loanTermYears = 20,
          interestOnlyYears = 0,
          holdYears = 10,
          annualAppreciation = 0.03,
          replacementReservesRate = 0.005,
          replacementReservesInflationRate = 0.02,
          otherIncomeAnnual = 0,
          expenseGrowthRate = 0.03,
          exitCapRate = 0.06,
          stressTestVacancyIncrease = 0.05,
          stressTestRentDecrease = 0.02,
          stressTestExpenseIncrease = 0.02
        } = inputs;

        // ==================== ACQUISITION COSTS ====================
        const totalAcquisitionCost = purchasePrice + (purchasePrice * closingCostsRate) + upfrontRenovation;

        // ==================== YEAR 1 CALCULATIONS ====================
        // 1. POTENTIAL GROSS INCOME (PGI)
        const pgiAnnual = (monthlyRent * 12) + otherIncomeAnnual;
        
        // 2. VACANCY & CREDIT LOSS
        const vacancyLossAnnual = pgiAnnual * vacancyRate;
        
        // 3. EFFECTIVE GROSS INCOME (EGI)
        const egiAnnual = pgiAnnual - vacancyLossAnnual;

        // 4. OPERATING EXPENSES (OpEx)
        const managementFeeAnnual = managementFeeBase === 'pgi' 
          ? pgiAnnual * managementFeeRate 
          : egiAnnual * managementFeeRate;
        const maintenanceAnnual = purchasePrice * maintenanceRate;
        const propertyTaxAnnual = purchasePrice * propertyTaxRate;
        const insuranceAnnual = purchasePrice * insuranceRate;
        const hoaAnnual = hoaMonthly * 12;
        const utilitiesAnnual = utilitiesMonthly * 12;
        const otherExpenses = otherExpensesAnnual;
        
        // 5. REPLACEMENT RESERVES (CapEx)
        const replacementReservesAnnual = purchasePrice * replacementReservesRate;

        // 6. TWO SEPARATE NOI CALCULATIONS
        // a) MARKET NOI (for Cap Rate)
        const totalOperatingExpensesAnnual = managementFeeAnnual + 
                                            maintenanceAnnual + 
                                            propertyTaxAnnual + 
                                            insuranceAnnual + 
                                            hoaAnnual + 
                                            utilitiesAnnual + 
                                            otherExpenses;
        
        const marketNoiAnnual = egiAnnual - totalOperatingExpensesAnnual;
        
        // b) UNDERWRITING NOI (for DSCR)
        const totalExpensesInclReservesAnnual = totalOperatingExpensesAnnual + replacementReservesAnnual;
        const underwritingNoiAnnual = egiAnnual - totalExpensesInclReservesAnnual;

        // ==================== DEBT SERVICE ====================
        let debtServiceSchedule;
        let annualDebtService = 0;
        
        if (loanAmount > 0 && loanTermYears > 0) {
          debtServiceSchedule = calculateDebtServiceSchedule(
            loanAmount, 
            interestRate, 
            loanTermYears, 
            interestOnlyYears, 
            holdYears
          );
          
          annualDebtService = debtServiceSchedule.annualDebtService;
        }

        // ==================== KEY RATIOS ====================
        const dscr = loanAmount > 0 ? (underwritingNoiAnnual / annualDebtService) : Infinity;
        const debtYield = loanAmount > 0 ? (underwritingNoiAnnual / loanAmount) * 100 : 0;
        const oer = (totalOperatingExpensesAnnual / egiAnnual) * 100;
        const effectiveVacancyRate = vacancyRate * 100;
        const breakEvenOccupancy = ((totalExpensesInclReservesAnnual + annualDebtService) / pgiAnnual) * 100;

        // ==================== PROJECTIONS (Multi-year) ====================
        const yearlyProjections = [];
        let currentMonthlyRent = monthlyRent;
        let currentPropertyValue = purchasePrice;
        let currentAssessedValue = purchasePrice; 
        let cumulativeBTCF = 0;
        
        for (let year = 1; year <= holdYears; year++) {
          if (year > 1) {
            currentMonthlyRent *= (1 + rentGrowthRate);
            currentPropertyValue *= (1 + annualAppreciation);
            if (year === 2 && propertyTaxReassessmentRate > 0) {
              currentAssessedValue = purchasePrice * (1 + propertyTaxReassessmentRate);
            } else if (year > 2) {
              currentAssessedValue *= (1 + annualAppreciation);
            }
          }
          
          const yearPGI = (currentMonthlyRent * 12) + otherIncomeAnnual;
          const yearVacancy = yearPGI * vacancyRate;
          const yearEGI = yearPGI - yearVacancy;
          const expenseInflationFactor = Math.pow(1 + expenseGrowthRate, year - 1);
          const reservesInflationFactor = Math.pow(1 + replacementReservesInflationRate, year - 1);
          const yearManagementFee = managementFeeBase === 'pgi'
            ? yearPGI * managementFeeRate
            : yearEGI * managementFeeRate;
          
          const yearMaintenance = currentPropertyValue * maintenanceRate * expenseInflationFactor;
          const yearPropertyTax = currentAssessedValue * propertyTaxRate * expenseInflationFactor;
          const yearInsurance = currentPropertyValue * insuranceRate * expenseInflationFactor;
          const yearReplacementReserves = currentPropertyValue * replacementReservesRate * reservesInflationFactor;
          const yearHOA = hoaAnnual * expenseInflationFactor;
          const yearUtilities = utilitiesAnnual * expenseInflationFactor;
          const yearOtherExpenses = otherExpensesAnnual * expenseInflationFactor;
          const yearOperatingExpenses = yearManagementFee + 
                                      yearMaintenance + 
                                      yearPropertyTax + 
                                      yearInsurance + 
                                      yearHOA + 
                                      yearUtilities + 
                                      yearOtherExpenses;
          const yearTotalExpensesInclReserves = yearOperatingExpenses + yearReplacementReserves;
          const yearMarketNOI = yearEGI - yearOperatingExpenses;
          const yearUnderwritingNOI = yearEGI - yearTotalExpensesInclReserves;
          
          let yearDebtService = 0;
          if (loanAmount > 0) {
            if (year <= interestOnlyYears) {
              yearDebtService = loanAmount * interestRate;
            } else {
              const monthlyRate = interestRate / 12;
              const remainingMonths = (loanTermYears - interestOnlyYears) * 12;
              if (remainingMonths > 0) {
                if (monthlyRate === 0) {
                  yearDebtService = (loanAmount / remainingMonths) * 12;
                } else {
                  const amortizingPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) / 
                    (Math.pow(1 + monthlyRate, remainingMonths) - 1);
                  yearDebtService = amortizingPayment * 12;
                }
              }
            }
          }

          const yearBTCF = yearUnderwritingNOI - yearDebtService;
          cumulativeBTCF += yearBTCF;
          
          yearlyProjections.push({
            year,
            monthlyRent: roundFinancial(currentMonthlyRent, 2),
            pgi: roundFinancial(yearPGI, 2),
            vacancyLoss: roundFinancial(yearVacancy, 2),
            egi: roundFinancial(yearEGI, 2),
            operatingExpenses: roundFinancial(yearOperatingExpenses, 2),
            replacementReserves: roundFinancial(yearReplacementReserves, 2),
            totalExpenses: roundFinancial(yearTotalExpensesInclReserves, 2),
            marketNOI: roundFinancial(yearMarketNOI, 2),
            underwritingNOI: roundFinancial(yearUnderwritingNOI, 2),
            btcf: roundFinancial(yearBTCF, 2),
            cumulativeBTCF: roundFinancial(cumulativeBTCF, 2),
            propertyValue: roundFinancial(currentPropertyValue, 2),
            assessedValue: roundFinancial(currentAssessedValue, 2),
            oer: roundFinancial((yearOperatingExpenses / yearEGI) * 100, 1),
            dscr: yearDebtService > 0 ? roundFinancial(yearUnderwritingNOI / yearDebtService, 2) : Infinity
          });
        }

        // ==================== STRESS TEST ANALYSIS ====================
        const stressTestResults = calculateStressTests(
          inputs,
          yearlyProjections[0], 
          annualDebtService
        );

        // ==================== EXIT CAP RATE SENSITIVITY ====================
        const exitSensitivity = calculateExitSensitivity(
          yearlyProjections[yearlyProjections.length - 1], 
          totalAcquisitionCost,
          holdYears,
          inputs
        );

        // ==================== PROFESSIONAL INSIGHTS ====================
        const professionalInsights = generateProfessionalInsights(
          yearlyProjections[0], 
          dscr,
          oer,
          breakEvenOccupancy,
          stressTestResults,
          exitSensitivity,
          debtYield
        );

        // ==================== RETURN STRUCTURED ANALYSIS ====================
        return {
          year1: {
            pgi: roundFinancial(pgiAnnual, 2),
            vacancyLoss: roundFinancial(vacancyLossAnnual, 2),
            egi: roundFinancial(egiAnnual, 2),
            marketNOI: roundFinancial(marketNoiAnnual, 2),
            underwritingNOI: roundFinancial(underwritingNoiAnnual, 2),
            operatingExpenses: roundFinancial(totalOperatingExpensesAnnual, 2),
            replacementReserves: roundFinancial(replacementReservesAnnual, 2),
            btcf: roundFinancial(underwritingNoiAnnual - annualDebtService, 2)
          },

          debt: {
            monthlyPayment: roundFinancial(debtServiceSchedule?.schedule[0]?.annualPayment / 12 || 0, 2),
            interestOnlyPayment: roundFinancial(interestRate * loanAmount / 12, 2),
            interestOnlyYears,
            annualDebtService: roundFinancial(annualDebtService, 2),
            dscr: roundFinancial(dscr, 2),
            debtYield: roundFinancial(debtYield, 2), 
            breakEvenOccupancy: roundFinancial(breakEvenOccupancy, 1),
            maxAllowableLoan: calculateMaxLoanAmount(underwritingNoiAnnual, interestRate, loanTermYears)
          },

          metrics: {
            oer: roundFinancial(oer, 1),
            vacancyRate: roundFinancial(effectiveVacancyRate, 1),
            noiMargin: roundFinancial((marketNoiAnnual / egiAnnual) * 100, 1),
            capRate: roundFinancial((marketNoiAnnual / purchasePrice) * 100, 2),
            yieldOnCost: roundFinancial((marketNoiAnnual / totalAcquisitionCost) * 100, 2)
          },

          yearlyProjections,

          analysis: {
            stressTests: stressTestResults,
            exitSensitivity,
            insights: professionalInsights,
            lenderPerspective: getLenderPerspective(yearlyProjections[0], inputs),
            investmentRecommendation: getInvestmentRecommendation(dscr, oer, breakEvenOccupancy)
          }
        };
      }

      function calculateDebtServiceSchedule(loanAmount, interestRate, loanTermYears, interestOnlyYears, holdYears) {
        if (loanAmount <= 0) {
          return {
            annualDebtService: 0,
            schedule: []
          };
        }
        
        const monthlyRate = interestRate / 12;
        const totalMonths = loanTermYears * 12;
        const ioMonths = interestOnlyYears * 12;
        const schedule = [];
        let balance = loanAmount;
        let totalPrincipalPaid = 0;
        let totalInterestPaid = 0;
        
        for (let year = 1; year <= Math.min(holdYears, loanTermYears); year++) {
          let yearPrincipal = 0;
          let yearInterest = 0;
          
          for (let month = 1; month <= 12; month++) {
            const currentMonth = (year - 1) * 12 + month;
            if (currentMonth > totalMonths || balance <= 0) {
              break;
            }
            
            const interest = balance * monthlyRate;
            yearInterest += interest;
            let principalPayment = 0;
            
            if (currentMonth <= ioMonths) {
              principalPayment = 0;
            } else {
              const monthsFromIOEnd = currentMonth - ioMonths;
              const remainingMonths = totalMonths - ioMonths;
              if (monthsFromIOEnd > remainingMonths) {
                break;
              }
              
              const remainingMonthsAtThisPoint = remainingMonths - (monthsFromIOEnd - 1);
              let monthlyPayment;
              
              if (monthlyRate === 0) {
                monthlyPayment = balance / remainingMonthsAtThisPoint;
              } else {
                monthlyPayment = balance * 
                  (monthlyRate * Math.pow(1 + monthlyRate, remainingMonthsAtThisPoint)) / 
                  (Math.pow(1 + monthlyRate, remainingMonthsAtThisPoint) - 1);
              }
              principalPayment = monthlyPayment - interest;
              principalPayment = Math.min(principalPayment, balance);
            }
            balance -= principalPayment;
            yearPrincipal += principalPayment;
          }
          
          const yearTotalPayment = yearPrincipal + yearInterest;
          totalPrincipalPaid += yearPrincipal;
          totalInterestPaid += yearInterest;
          
          schedule.push({
            year,
            beginningBalance: year === 1 ? loanAmount : schedule[year-2].endingBalance,
            annualPayment: roundFinancial(yearTotalPayment, 2),
            principal: roundFinancial(yearPrincipal, 2),
            interest: roundFinancial(yearInterest, 2),
            endingBalance: roundFinancial(balance, 2),
            cumulativePrincipal: roundFinancial(totalPrincipalPaid, 2),
            cumulativeInterest: roundFinancial(totalInterestPaid, 2),
            isIOPeriod: year <= interestOnlyYears
          });
        }
        
        const year1DebtService = schedule.length > 0 ? schedule[0].annualPayment : 0;
        return {
          annualDebtService: roundFinancial(year1DebtService, 2),
          schedule,
          totalPrincipalPaid: roundFinancial(totalPrincipalPaid, 2),
          totalInterestPaid: roundFinancial(totalInterestPaid, 2),
          finalBalance: roundFinancial(balance, 2)
        };
      }

      function calculateStressTests(inputs, year1Data, annualDebtService) {
        const {
          stressTestVacancyIncrease = 0.05,
          stressTestRentDecrease = 0.02,
          stressTestExpenseIncrease = 0.02
        } = inputs;
        
        const results = [];
        const stressedVacancy = year1Data.vacancyLoss * (1 + stressTestVacancyIncrease);
        const stressedNOI1 = year1Data.marketNOI - stressedVacancy;
        const stressedDSCR1 = stressedNOI1 / annualDebtService;
        results.push({
          scenario: `Vacancy +${(stressTestVacancyIncrease * 100)}%`,
          noiImpact: roundFinancial(year1Data.marketNOI - stressedNOI1, 2),
          dscr: roundFinancial(stressedDSCR1, 2),
          dscrChange: roundFinancial(stressedDSCR1 - (year1Data.marketNOI / annualDebtService), 2),
          severity: stressedDSCR1 < 1.25 ? 'HIGH' : stressedDSCR1 < 1.35 ? 'MEDIUM' : 'LOW'
        });
        const stressedRent = year1Data.monthlyRent * (1 - stressTestRentDecrease);
        const stressedPGI = (stressedRent * 12);
        const stressedNOI2 = stressedPGI - year1Data.operatingExpenses;
        const stressedDSCR2 = stressedNOI2 / annualDebtService;
        results.push({
          scenario: `Rent -${(stressTestRentDecrease * 100)}%`,
          noiImpact: roundFinancial(year1Data.marketNOI - stressedNOI2, 2),
          dscr: roundFinancial(stressedDSCR2, 2),
          dscrChange: roundFinancial(stressedDSCR2 - (year1Data.marketNOI / annualDebtService), 2),
          severity: stressedDSCR2 < 1.25 ? 'HIGH' : stressedDSCR2 < 1.35 ? 'MEDIUM' : 'LOW'
        });
        const stressedExpenses = year1Data.operatingExpenses * (1 + stressTestExpenseIncrease);
        const stressedNOI3 = year1Data.marketNOI - (stressedExpenses - year1Data.operatingExpenses);
        const stressedDSCR3 = stressedNOI3 / annualDebtService;
        results.push({
          scenario: `Expenses +${(stressTestExpenseIncrease * 100)}%`,
          noiImpact: roundFinancial(year1Data.operatingExpenses - stressedExpenses, 2),
          dscr: roundFinancial(stressedDSCR3, 2),
          dscrChange: roundFinancial(stressedDSCR3 - (year1Data.marketNOI / annualDebtService), 2),
          severity: stressedDSCR3 < 1.25 ? 'HIGH' : stressedDSCR3 < 1.35 ? 'MEDIUM' : 'LOW'
        });
        
        return results;
      }

      function calculateExitSensitivity(finalYearData, totalAcquisitionCost, holdYears, inputs) {
        const { rentGrowthRate = 0.03 } = inputs; 
        const exitCapRates = [0.055, 0.06, 0.065, 0.07, 0.075]; 
        const appreciationRates = [0, 0.02, 0.03, 0.04, 0.05]; 
        const sensitivityMatrix = [];
        
        for (const exitCap of exitCapRates) {
          const row = [];
          for (const appreciation of appreciationRates) {
            const finalValue = totalAcquisitionCost * Math.pow(1 + appreciation, holdYears);
            const exitNOI = finalYearData.marketNOI * (1 + rentGrowthRate); 
            const exitValueAtCap = exitNOI / exitCap;
            const conservativeExitValue = Math.min(finalValue, exitValueAtCap);
            const sellingCosts = conservativeExitValue * 0.06;
            const netProceeds = conservativeExitValue - sellingCosts;
            row.push({
              exitValue: roundFinancial(conservativeExitValue, 0),
              netProceeds: roundFinancial(netProceeds, 0),
              multiple: roundFinancial(netProceeds / totalAcquisitionCost, 2)
            });
          }
          sensitivityMatrix.push({
            exitCap: (exitCap * 100).toFixed(1) + '%',
            values: row
          });
        }
        
        return {
          matrix: sensitivityMatrix,
          appreciationRates: appreciationRates.map(r => (r * 100).toFixed(0) + '%'),
          currentAssumption: {
            exitCap: ((inputs.exitCapRate || 0.06) * 100).toFixed(1) + '%',
            appreciation: ((inputs.annualAppreciation || 0.03) * 100).toFixed(1) + '%'
          }
        };
      }

      function generateProfessionalInsights(year1Data, dscr, oer, breakEvenOccupancy, stressTests, exitSensitivity, debtYield) {
        const insights = [];
        const warnings = [];
        const strengths = [];
        if (dscr < 1.0) {
          warnings.push('üö® CRITICAL: DSCR < 1.0 - Deal has negative cash flow');
        } else if (dscr < 1.25) {
          warnings.push('‚ö†Ô∏è WARNING: DSCR < 1.25x - May not meet institutional lending standards');
        } else if (dscr >= 1.35) {
          strengths.push('‚úÖ STRENGTH: Strong DSCR (>1.35x) - Meets all lender requirements');
        }
        if (debtYield < 8) {
          warnings.push(`‚ö†Ô∏è WARNING: Debt Yield < 8% (${debtYield.toFixed(2)}%) - May not meet bridge/CMBS requirements`);
        } else if (debtYield >= 10) {
          strengths.push(`‚úÖ STRENGTH: Strong Debt Yield (${debtYield.toFixed(2)}%) - Attracts institutional lenders`);
        }
        if (oer > 45) {
          warnings.push('‚ö†Ô∏è WARNING: Operating Expense Ratio > 45% - Margin compression risk');
        } else if (oer < 35) {
          strengths.push('‚úÖ STRENGTH: Low OER (<35%) - High operating efficiency');
        }
        if (breakEvenOccupancy > 85) {
          warnings.push(`‚ö†Ô∏è WARNING: High break-even occupancy (${breakEvenOccupancy.toFixed(1)}%) - Vulnerable to market downturns`);
        } else if (breakEvenOccupancy < 70) {
          strengths.push(`‚úÖ STRENGTH: Low break-even occupancy (${breakEvenOccupancy.toFixed(1)}%) - Strong buffer against vacancy`);
        }
        const failedStressTests = stressTests.filter(test => test.severity === 'HIGH');
        if (failedStressTests.length > 0) {
          warnings.push(`‚ö†Ô∏è ${failedStressTests.length} stress test(s) failed - Deal may not survive market stress`);
        }
        const baseExit = exitSensitivity.matrix[2]?.values[2] || { multiple: 1 }; 
        if (baseExit.multiple < 1.5) {
          warnings.push('‚ö†Ô∏è Modest exit multiple (<1.5x) - Consider higher yield deals');
        } else if (baseExit.multiple > 2.5) {
          strengths.push(`‚úÖ Strong exit potential (>2.5x multiple)`);
        }
        return {
          insights,
          warnings: warnings.length > 0 ? warnings : ['All core metrics within acceptable ranges'],
          strengths: strengths.length > 0 ? strengths : ['Solid fundamentals'],
          riskLevel: calculateRiskLevel(warnings.length, dscr, oer, debtYield),
          recommendations: generateRecommendations(warnings, dscr, oer, debtYield)
        };
      }

      function getLenderPerspective(year1Data, inputs) {
        const {
          managementFeeBase = 'egi',
          vacancyRate = 0.05,
          managementFeeRate = 0.08,
          annualDebtService = 0
        } = inputs;
        
        const lenderView = {
          managementFee: managementFeeBase === 'pgi' ? 'Correct (PGI base)' : 'Note: We use PGI base',
          vacancyAssumption: Math.max(vacancyRate, 0.07), 
          minDSCR: 1.25,
          noiHaircuts: [
            'Management fee calculated on PGI (not EGI)',
            'Vacancy at 7% minimum',
            '+2% expense growth buffer'
          ],
          maxLTV: 0.75, 
          minDebtYield: 0.08
        };
        
        const lenderPGI = year1Data.pgi;
        const lenderVacancy = lenderPGI * lenderView.vacancyAssumption;
        const lenderEGI = lenderPGI - lenderVacancy;
        const lenderManagementFee = lenderPGI * managementFeeRate;
        const lenderOperatingExpenses = year1Data.operatingExpenses - 
                                      (year1Data.operatingExpenses * 0.02) + 
                                      lenderManagementFee;
        const lenderNOI = lenderEGI - lenderOperatingExpenses;
        
        lenderView.adjustedNOI = roundFinancial(lenderNOI, 2);
        lenderView.adjustedDSCR = roundFinancial(lenderNOI / annualDebtService, 2);
        lenderView.adjustedDebtYield = roundFinancial(lenderNOI / inputs.loanAmount * 100, 2);
        
        return lenderView;
      }

      function calculateMaxLoanAmount(noi, interestRate, termYears) {
        if (noi <= 0) return 0;
        
        const maxAnnualDebtService = noi / 1.25;
        if (interestRate === 0) return maxAnnualDebtService * termYears;
        
        const monthlyRate = interestRate / 12;
        const numberOfPayments = termYears * 12;
        const maxLoan = maxAnnualDebtService / 12 * 
                      ((Math.pow(1 + monthlyRate, numberOfPayments) - 1) / 
                        (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)));
        return roundFinancial(maxLoan, 0);
      }

      function calculateRiskLevel(warningCount, dscr, oer, debtYield) {
        let score = 0;
        
        if (dscr < 1.0) score += 3;
        else if (dscr < 1.25) score += 2;
        else if (dscr < 1.35) score += 1;
        
        if (oer > 45) score += 2;
        else if (oer > 40) score += 1;
        
        if (debtYield < 8) score += 1; 
        
        score += warningCount;
        
        if (score >= 5) return { level: 'HIGH RISK', color: '#DC2626', score };
        if (score >= 3) return { level: 'MEDIUM-HIGH RISK', color: '#F97316', score };
        if (score >= 2) return { level: 'MEDIUM RISK', color: '#F59E0B', score };
        if (score >= 1) return { level: 'LOW-MEDIUM RISK', color: '#3B82F6', score };
        return { level: 'LOW RISK', color: '#10B981', score };
      }

      function generateRecommendations(warnings, dscr, oer, debtYield) {
        const recommendations = [];
        
        if (dscr < 1.25) {
          recommendations.push({
            priority: 'HIGH',
            action: 'Increase equity or negotiate lower purchase price',
            reason: 'DSCR below institutional minimum'
          });
        }
        
        if (debtYield < 8) {
          recommendations.push({
            priority: 'HIGH',
            action: 'Reduce loan amount or improve NOI to achieve 8%+ debt yield',
            reason: 'Debt Yield below institutional minimum'
          });
        }
        
        if (oer > 45) {
          recommendations.push({
            priority: 'HIGH',
            action: 'Review operating expenses for efficiency improvements',
            reason: 'High operating expense ratio'
          });
        }
        
        if (warnings.length > 2) {
          recommendations.push({
            priority: 'MEDIUM',
            action: 'Conduct deeper due diligence on market fundamentals',
            reason: 'Multiple risk factors identified'
          });
        }
        
        if (recommendations.length === 0) {
          recommendations.push({
            priority: 'LOW',
            action: 'Proceed with standard due diligence',
            reason: 'Deal meets institutional criteria'
          });
        }
        
        return recommendations;
      }

      function getInvestmentRecommendation(dscr, oer, breakEvenOccupancy) {
        if (dscr < 1.0) {
          return {
            rating: 'REJECT',
            reason: 'Negative cash flow',
            color: '#DC2626'
          };
        } else if (dscr < 1.25 || oer > 45 || breakEvenOccupancy > 85) {
          return {
            rating: 'CAUTION',
            reason: 'Marginal metrics require improvement',
            color: '#F59E0B'
          };
        } else if (dscr >= 1.35 && oer < 35 && breakEvenOccupancy < 70) {
          return {
            rating: 'STRONG BUY',
            reason: 'Excellent metrics across all criteria',
            color: '#10B981'
          };
        } else {
          return {
            rating: 'BUY',
            reason: 'Solid investment with acceptable risk',
            color: '#3B82F6'
          };
        }
      }
      // ==================== END MODULE A ====================


    </script>

    <!-- Toast Notification -->
    <div class="toast" id="saveToast">
      <span id="toastMessage">üíæ Saved!</span>
    </div>

  </body>
</html>
