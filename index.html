<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finance Calculators</title>
    <style>
      :root {
        --indigo-50: #eef2ff;
        --indigo-100: #e0e7ff;
        --indigo-500: #6366f1;
        --indigo-600: #4f46e5;
        --indigo-700: #4338ca;
        --blue-50: #eff6ff;
        --blue-100: #dbeafe;
        --blue-500: #3b82f6;
        --blue-600: #2563eb;
        --blue-700: #1d4ed8;
        --cyan-50: #ecfeff;
        --cyan-100: #cffafe;
        --cyan-500: #06b6d4;
        --cyan-600: #0891b2;
        --green-50: #f0fdf4;
        --green-100: #dcfce7;
        --green-500: #10b981;
        --green-600: #059669;
        --emerald-50: #ecfdf5;
        --emerald-100: #d1fae5;
        --emerald-500: #059669;
        --emerald-600: #047857;
        --rose-50: #fff1f2;
        --rose-100: #ffe4e6;
        --rose-500: #f43f5e;
        --rose-600: #e11d48;
        --pink-50: #fdf2f8;
        --pink-100: #fce7f3;
        --pink-500: #ec4899;
        --pink-600: #db2777;
        --orange-50: #fff7ed;
        --orange-100: #ffedd5;
        --orange-500: #f97316;
        --orange-600: #ea580c;
        --red-50: #fef2f2;
        --red-100: #fee2e2;
        --red-500: #ef4444;
        --red-600: #dc2626;
        --purple-50: #faf5ff;
        --purple-100: #f3e8ff;
        --purple-500: #a855f7;
        --purple-600: #9333ea;
        --slate-50: #f8fafc;
        --slate-100: #f1f5f9;
        --slate-200: #e2e8f0;
        --slate-300: #cbd5e1;
        --slate-400: #94a3b8;
        --slate-500: #64748b;
        --slate-600: #475569;
        --slate-700: #334155;
        --slate-800: #1e293b;
        --white: #ffffff;
        --black: #000000;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, var(--slate-50), var(--indigo-100));
        min-height: 100vh;
        padding: 20px;
        color: var(--slate-700);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Header */
      .header {
        background: var(--white);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-bottom: 1px solid var(--slate-200);
        padding: 1rem 0;
        margin-bottom: 2rem;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(
          to right,
          var(--indigo-600),
          var(--blue-600)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .tier-selector {
        display: flex;
        background: var(--slate-100);
        border-radius: 0.5rem;
        padding: 0.25rem;
      }

      .tier-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .tier-btn.active {
        background: var(--white);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      /* Tabs */
      .tabs {
        display: flex;
        background: var(--white);
        border-radius: 0.75rem;
        padding: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-bottom: 2rem;
        overflow-x: auto;
      }

      .tab-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
      }

      .tab-btn:hover {
        background: var(--slate-100);
      }

      .tab-btn.active {
        background: var(--indigo-50);
        color: var(--indigo-600);
        font-weight: 600;
      }

      /* Calculator Container */
      .calculator-container {
        background: var(--white);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      .calculator-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: var(--slate-700);
      }

      /* Explanation Box */
      .explanation-box {
        background: var(--slate-50);
        border-left: 4px solid var(--indigo-500);
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .explanation-title {
        font-weight: 600;
        color: var(--slate-800);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .explanation-title svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--indigo-500);
      }

      .explanation-text {
        color: var(--slate-600);
        line-height: 1.5;
        margin-bottom: 0.75rem;
      }

      .explanation-note {
        background: var(--blue-50);
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 0.75rem;
        font-size: 0.875rem;
        border-left: 3px solid var(--blue-500);
      }

      .explanation-note strong {
        color: var(--blue-700);
      }

      /* Form Grid */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--slate-700);
        margin-bottom: 0.5rem;
      }

      .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--slate-200);
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--indigo-500);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .form-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--slate-200);
        border-radius: 0.5rem;
        font-size: 1rem;
        background-color: var(--white);
        transition: all 0.2s;
      }

      .form-select:focus {
        outline: none;
        border-color: var(--indigo-500);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      /* Buttons */
      .btn {
        width: 100%;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        color: var(--white);
      }

      .btn-primary {
        background: linear-gradient(
          to right,
          var(--indigo-600),
          var(--blue-700)
        );
      }

      .btn-primary:hover {
        background: linear-gradient(
          to right,
          var(--indigo-700),
          var(--blue-700)
        );
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .btn-secondary {
        background: linear-gradient(to right, var(--blue-500), var(--cyan-600));
      }

      .btn-secondary:hover {
        background: linear-gradient(to right, var(--blue-600), var(--cyan-600));
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .btn-success {
        background: linear-gradient(
          to right,
          var(--green-500),
          var(--emerald-600)
        );
      }

      .btn-success:hover {
        background: linear-gradient(
          to right,
          var(--green-600),
          var(--emerald-600)
        );
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .btn-danger {
        background: linear-gradient(to right, var(--rose-500), var(--pink-600));
      }

      .btn-danger:hover {
        background: linear-gradient(to right, var(--rose-600), var(--pink-600));
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .btn-warning {
        background: linear-gradient(
          to right,
          var(--orange-500),
          var(--red-600)
        );
      }

      .btn-warning:hover {
        background: linear-gradient(
          to right,
          var(--orange-600),
          var(--red-600)
        );
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      /* Results */
      .results-container {
        margin-top: 2rem;
        padding: 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid;
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .result-card {
        text-align: center;
        padding: 1rem;
        border-radius: 0.5rem;
      }

      .result-label {
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .result-value {
        font-size: 1.25rem;
        font-weight: 700;
      }

      .result-error {
        font-size: 0.9rem;
        color: var(--red-600);
        font-weight: 500;
      }

      /* Cash Flows */
      .cash-flows-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .cash-flow-input {
        padding: 0.5rem;
        border: 1px solid var(--slate-200);
        border-radius: 0.375rem;
        font-size: 0.875rem;
      }

      /* Options */
      .options-toggle {
        display: flex;
        background: var(--slate-100);
        border-radius: 0.5rem;
        padding: 0.25rem;
        margin-bottom: 1.5rem;
        width: fit-content;
      }

      .option-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .option-btn.active {
        background: var(--white);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      /* Hidden Class */
      .hidden {
        display: none;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 1rem;
        }

        .calculator-container {
          padding: 1.5rem;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <div class="logo">Finance Calculators</div>
          <div class="tier-selector">
            <button class="tier-btn active" data-tier="basic">Basic</button>
            <button class="tier-btn" data-tier="intermediate">
              Intermediate
            </button>
            <button class="tier-btn" data-tier="advanced">Advanced</button>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs" id="tabsContainer">
        <!-- Tabs will be populated by JavaScript -->
      </div>

      <!-- Calculator Container -->
      <div class="calculator-container">
        <div id="calculatorContent">
          <!-- Calculator content will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // --- Data Structure ---
      const calculators = {
        basic: [
          {
            id: "pv-fv",
            name: "PV/FV Calculator",
            component: "PVFVCalculator",
          },
          {
            id: "compound-interest",
            name: "Compound Interest",
            component: "CompoundInterestCalculator",
          },
          {
            id: "loan-payment",
            name: "Loan Payment",
            component: "LoanPaymentCalculator",
          },
        ],
        intermediate: [
          {
            id: "capm",
            name: "CAPM",
            component: "CAPMCalculator",
          },
          {
            id: "bond-pricing",
            name: "Bond Pricing",
            component: "BondPricingCalculator",
          },
          {
            id: "npv-irr",
            name: "NPV & IRR",
            component: "NPVIRRCalculator",
          },
        ],
        advanced: [
          {
            id: "black-scholes",
            name: "Black-Scholes",
            component: "BlackScholesCalculator",
          },
          {
            id: "wacc",
            name: "WACC",
            component: "WACCCalculator",
          },
          {
            id: "dcf",
            name: "DCF Valuation",
            component: "DCFCalculator",
          },
          {
            id: "lbo",
            name: "LBO Model",
            component: "LBOCalculator",
          },
        ],
      };

      // --- State Management ---
      let activeTier = "basic";
      let activeTab = "pv-fv";

      // --- DOM Elements ---
      const tabsContainer = document.getElementById("tabsContainer");
      const calculatorContent = document.getElementById("calculatorContent");
      const tierButtons = document.querySelectorAll(".tier-btn");

      // --- Initialize App ---
      function initApp() {
        renderTabs();
        renderCalculator();
        setupEventListeners();
      }

      // --- Event Listeners ---
      function setupEventListeners() {
        // Tier selection
        tierButtons.forEach((button) => {
          button.addEventListener("click", () => {
            tierButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");
            activeTier = button.dataset.tier;

            // Switch to first calculator of new tier
            const firstCalculator = calculators[activeTier][0];
            if (firstCalculator) {
              activeTab = firstCalculator.id;
            }

            renderTabs();
            renderCalculator();
          });
        });
      }

      // --- Render Tabs ---
      function renderTabs() {
        tabsContainer.innerHTML = "";
        const tierCalculators = calculators[activeTier];

        tierCalculators.forEach((calc) => {
          const tabButton = document.createElement("button");
          tabButton.className = `tab-btn ${
            calc.id === activeTab ? "active" : ""
          }`;
          tabButton.textContent = calc.name;
          tabButton.onclick = () => {
            activeTab = calc.id;
            renderTabs();
            renderCalculator();
          };
          tabsContainer.appendChild(tabButton);
        });
      }

      // --- Render Calculator ---
      function renderCalculator() {
        const calculator = calculators[activeTier].find(
          (c) => c.id === activeTab
        );
        if (!calculator) return;

        switch (calculator.component) {
          case "PVFVCalculator":
            calculatorContent.innerHTML = renderPVFVCalculator();
            setupPVFVCalculator();
            break;
          case "CompoundInterestCalculator":
            calculatorContent.innerHTML = renderCompoundInterestCalculator();
            setupCompoundInterestCalculator();
            break;
          case "LoanPaymentCalculator":
            calculatorContent.innerHTML = renderLoanPaymentCalculator();
            setupLoanPaymentCalculator();
            break;
          case "CAPMCalculator":
            calculatorContent.innerHTML = renderCAPMCalculator();
            setupCAPMCalculator();
            break;
          case "BondPricingCalculator":
            calculatorContent.innerHTML = renderBondPricingCalculator();
            setupBondPricingCalculator();
            break;
          case "NPVIRRCalculator":
            calculatorContent.innerHTML = renderNPVIRRCalculator();
            setupNPVIRRCalculator();
            break;
          case "BlackScholesCalculator":
            calculatorContent.innerHTML = renderBlackScholesCalculator();
            setupBlackScholesCalculator();
            break;
          case "WACCCalculator":
            calculatorContent.innerHTML = renderWACCCalculator();
            setupWACCCalculator();
            break;
          case "DCFCalculator":
            calculatorContent.innerHTML = renderDCFCalculator();
            setupDCFCalculator();
            break;
          case "LBOCalculator":
            calculatorContent.innerHTML = renderLBOCalculator();
            setupLBOCalculator();
            break;
          default:
            calculatorContent.innerHTML = "<p>Calculator not found</p>";
        }
      }

      // --- PV/FV Calculator ---
      function renderPVFVCalculator() {
        return `
                <h2 class="calculator-title">Present Value / Future Value Calculator</h2>
                <div class="explanation-box">
                    <div class="explanation-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Understanding PV and FV
                    </div>
                    <p class="explanation-text">
                        <strong>Present Value (PV)</strong> is the current worth of a future sum of money given a specified rate of return.
                        <strong>Future Value (FV)</strong> is the value of a current asset at a future date based on an assumed growth rate.
                    </p>
                    <p class="explanation-text">
                        These concepts are fundamental in finance for evaluating investments, comparing cash flows at different times,
                        and making informed financial decisions.
                    </p>
                    <div class="explanation-note">
                        <strong>Financial Insight:</strong> Money available today is worth more than the same amount in the future due to its potential earning capacity (time value of money).
                    </div>
                </div>
                <div class="options-toggle">
                    <button class="option-btn active" id="pvOption">Calculate PV</button>
                    <button class="option-btn" id="fvOption">Calculate FV</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Future Value ($)</label>
                        <input type="number" id="futureValue" class="form-input" placeholder="10000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Interest Rate (%)</label>
                        <input type="number" id="interestRate" class="form-input" placeholder="5" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Number of Periods</label>
                        <input type="number" id="periods" class="form-input" placeholder="10">
                    </div>
                </div>
                <button class="btn btn-primary" id="calculatePVFV">Calculate</button>
                <div id="pvfvResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                    <!-- Results will be populated here -->
                </div>
            `;
      }

      function setupPVFVCalculator() {
        const pvOption = document.getElementById("pvOption");
        const fvOption = document.getElementById("fvOption");
        const futureValueInput = document.getElementById("futureValue");
        const interestRateInput = document.getElementById("interestRate");
        const periodsInput = document.getElementById("periods");
        const calculateBtn = document.getElementById("calculatePVFV");
        const resultsDiv = document.getElementById("pvfvResults");

        let isPVCalculation = true;

        pvOption.addEventListener("click", () => {
          pvOption.classList.add("active");
          fvOption.classList.remove("active");
          isPVCalculation = true;
          // Swap labels
          document.querySelectorAll(".form-label")[0].textContent =
            "Future Value ($)";
          futureValueInput.placeholder = "10000";
        });

        fvOption.addEventListener("click", () => {
          fvOption.classList.add("active");
          pvOption.classList.remove("active");
          isPVCalculation = false;
          // Swap labels
          document.querySelectorAll(".form-label")[0].textContent =
            "Present Value ($)";
          futureValueInput.placeholder = "5000";
        });

        calculateBtn.addEventListener("click", () => {
          const r = parseFloat(interestRateInput.value) / 100;
          const n = parseFloat(periodsInput.value);

          if (isNaN(r) || isNaN(n) || r < 0 || n < 0) {
            alert(
              "Please enter valid positive numbers for interest rate and periods."
            );
            return;
          }

          if (isPVCalculation) {
            const fv = parseFloat(futureValueInput.value);
            if (isNaN(fv)) {
              alert("Please enter a valid future value.");
              return;
            }
            const pv = fv / Math.pow(1 + r, n);
            resultsDiv.innerHTML = `
                        <div class="results-grid">
                            <div class="result-card" style="background-color: var(--indigo-100);">
                                <div class="result-label">Present Value</div>
                                <div class="result-value">$${pv.toFixed(
                                  2
                                )}</div>
                            </div>
                            <div class="result-card" style="background-color: var(--slate-100);">
                                <div class="result-label">Future Value</div>
                                <div class="result-value">$${fv.toFixed(
                                  2
                                )}</div>
                            </div>
                            <div class="result-card" style="background-color: var(--slate-100);">
                                <div class="result-label">Interest Rate</div>
                                <div class="result-value">${(r * 100).toFixed(
                                  2
                                )}%</div>
                            </div>
                            <div class="result-card" style="background-color: var(--slate-100);">
                                <div class="result-label">Periods</div>
                                <div class="result-value">${n}</div>
                            </div>
                        </div>
                    `;
          } else {
            const pv = parseFloat(futureValueInput.value);
            if (isNaN(pv)) {
              alert("Please enter a valid present value.");
              return;
            }
            const fv = pv * Math.pow(1 + r, n);
            resultsDiv.innerHTML = `
                        <div class="results-grid">
                            <div class="result-card" style="background-color: var(--slate-100);">
                                <div class="result-label">Present Value</div>
                                <div class="result-value">$${pv.toFixed(
                                  2
                                )}</div>
                            </div>
                            <div class="result-card" style="background-color: var(--indigo-100);">
                                <div class="result-label">Future Value</div>
                                <div class="result-value">$${fv.toFixed(
                                  2
                                )}</div>
                            </div>
                            <div class="result-card" style="background-color: var(--slate-100);">
                                <div class="result-label">Interest Rate</div>
                                <div class="result-value">${(r * 100).toFixed(
                                  2
                                )}%</div>
                            </div>
                            <div class="result-card" style="background-color: var(--slate-100);">
                                <div class="result-label">Periods</div>
                                <div class="result-value">${n}</div>
                            </div>
                        </div>
                    `;
          }

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- Compound Interest Calculator ---
      function renderCompoundInterestCalculator() {
        return `
                <h2 class="calculator-title">Compound Interest Calculator</h2>
                <div class="explanation-box">
                    <div class="explanation-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        The Power of Compounding
                    </div>
                    <p class="explanation-text">
                        <strong>Compound interest</strong> is interest calculated on the initial principal and also on the accumulated interest of previous periods.
                        It's often referred to as "interest on interest" and can cause wealth to grow exponentially over time.
                    </p>
                    <p class="explanation-text">
                        The more frequently interest is compounded, the greater the return. This calculator helps you understand how different compounding frequencies affect your investment growth.
                    </p>
                    <div class="explanation-note">
                        <strong>Financial Insight:</strong> Starting early and allowing your investments to compound over long periods is one of the most powerful wealth-building strategies.
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Principal Amount ($)</label>
                        <input type="number" id="principal" class="form-input" placeholder="10000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Annual Interest Rate (%)</label>
                        <input type="number" id="annualRate" class="form-input" placeholder="5" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Number of Years</label>
                        <input type="number" id="years" class="form-input" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Compounding Frequency</label>
                        <select id="compounding" class="form-select">
                            <option value="1">Annually</option>
                            <option value="2">Semi-annually</option>
                            <option value="4">Quarterly</option>
                            <option value="12">Monthly</option>
                            <option value="365">Daily</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success" id="calculateCI">Calculate Compound Interest</button>
                <div id="ciResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50);">
                    <!-- Results will be populated here -->
                </div>
            `;
      }

      function setupCompoundInterestCalculator() {
        const calculateBtn = document.getElementById("calculateCI");
        const resultsDiv = document.getElementById("ciResults");

        calculateBtn.addEventListener("click", () => {
          const principal = parseFloat(
            document.getElementById("principal").value
          );
          const annualRate =
            parseFloat(document.getElementById("annualRate").value) / 100;
          const years = parseFloat(document.getElementById("years").value);
          const compounding = parseFloat(
            document.getElementById("compounding").value
          );

          if (
            isNaN(principal) ||
            isNaN(annualRate) ||
            isNaN(years) ||
            isNaN(compounding) ||
            principal < 0 ||
            annualRate < 0 ||
            years < 0 ||
            compounding <= 0
          ) {
            alert("Please enter valid positive numbers.");
            return;
          }

          const finalAmount =
            principal *
            Math.pow(1 + annualRate / compounding, compounding * years);
          const interestEarned = finalAmount - principal;

          resultsDiv.innerHTML = `
                    <div class="results-grid">
                        <div class="result-card" style="background-color: var(--green-100);">
                            <div class="result-label">Final Amount</div>
                            <div class="result-value">$${finalAmount.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Principal</div>
                            <div class="result-value">$${principal.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Interest Earned</div>
                            <div class="result-value">$${interestEarned.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Annual Rate</div>
                            <div class="result-value">${(
                              annualRate * 100
                            ).toFixed(2)}%</div>
                        </div>
                    </div>
                `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- Loan Payment Calculator ---
      function renderLoanPaymentCalculator() {
        return `
                <h2 class="calculator-title">Loan Payment Calculator</h2>
                <div class="explanation-box">
                    <div class="explanation-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Understanding Loan Amortization
                    </div>
                    <p class="explanation-text">
                        This calculator helps you determine your monthly loan payment and understand how much interest you'll pay over the life of the loan.
                        It uses the standard amortization formula for fixed-rate loans.
                    </p>
                    <p class="explanation-text">
                        In the early years of a loan, a larger portion of each payment goes toward interest rather than principal.
                        As the loan matures, this ratio gradually reverses.
                    </p>
                    <div class="explanation-note">
                        <strong>Financial Insight:</strong> Even a small reduction in interest rate or shortening the loan term can save you thousands of dollars in total interest payments.
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Loan Amount ($)</label>
                        <input type="number" id="loanAmount" class="form-input" placeholder="10000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Annual Interest Rate (%)</label>
                        <input type="number" id="loanRate" class="form-input" placeholder="5" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Loan Term (Years)</label>
                        <input type="number" id="loanTerm" class="form-input" placeholder="10">
                    </div>
                </div>
                <button class="btn btn-secondary" id="calculateLoan">Calculate Loan Payment</button>
                <div id="loanResults" class="results-container hidden" style="border-color: var(--blue-100); background-color: var(--blue-50);">
                    <!-- Results will be populated here -->
                </div>
            `;
      }

      function setupLoanPaymentCalculator() {
        const calculateBtn = document.getElementById("calculateLoan");
        const resultsDiv = document.getElementById("loanResults");

        calculateBtn.addEventListener("click", () => {
          const principal = parseFloat(
            document.getElementById("loanAmount").value
          );
          const annualRate =
            parseFloat(document.getElementById("loanRate").value) / 100;
          const years = parseFloat(document.getElementById("loanTerm").value);

          if (
            isNaN(principal) ||
            isNaN(annualRate) ||
            isNaN(years) ||
            principal < 0 ||
            annualRate < 0 ||
            years < 0
          ) {
            alert("Please enter valid positive numbers.");
            return;
          }

          const monthlyRate = annualRate / 12;
          const numberOfPayments = years * 12;
          const monthlyPayment =
            (principal * monthlyRate) /
            (1 - Math.pow(1 + monthlyRate, -numberOfPayments));
          const totalPayment = monthlyPayment * numberOfPayments;
          const totalInterest = totalPayment - principal;

          resultsDiv.innerHTML = `
                    <div class="results-grid">
                        <div class="result-card" style="background-color: var(--blue-100);">
                            <div class="result-label">Monthly Payment</div>
                            <div class="result-value">$${monthlyPayment.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Total Payment</div>
                            <div class="result-value">$${totalPayment.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Total Interest</div>
                            <div class="result-value">$${totalInterest.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Loan Term</div>
                            <div class="result-value">${years} years</div>
                        </div>
                    </div>
                `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- CAPM Calculator ---
      function renderCAPMCalculator() {
        return `
                <h2 class="calculator-title">Capital Asset Pricing Model (CAPM)</h2>
                <div class="explanation-box">
                    <div class="explanation-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Risk and Return Relationship
                    </div>
                    <p class="explanation-text">
                        The <strong>Capital Asset Pricing Model (CAPM)</strong> describes the relationship between systematic risk and expected return for assets, particularly stocks.
                        It is widely used throughout finance for pricing risky securities and generating expected returns for assets given the risk of those assets.
                    </p>
                    <p class="explanation-text">
                        <strong>Beta (β)</strong> measures a stock's volatility compared to the overall market. A beta of 1 indicates the stock moves with the market,
                        while a beta greater than 1 indicates higher volatility.
                    </p>
                    <div class="explanation-note">
                        <strong>Financial Insight:</strong> CAPM suggests that investors need to be compensated in two ways: time value of money (risk-free rate) and risk (market risk premium). The model helps determine if a stock is fairly valued given its risk profile.
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Risk-free Rate (%)</label>
                        <input type="number" id="riskFreeRate" class="form-input" placeholder="3" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Beta (β)</label>
                        <input type="number" id="beta" class="form-input" placeholder="1.2" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Market Return (%)</label>
                        <input type="number" id="marketReturn" class="form-input" placeholder="8" step="0.01">
                    </div>
                </div>
                <button class="btn btn-primary" id="calculateCAPM">Calculate Expected Return (CAPM)</button>
                <div id="capmResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                    <!-- Results will be populated here -->
                </div>
            `;
      }

      function setupCAPMCalculator() {
        const calculateBtn = document.getElementById("calculateCAPM");
        const resultsDiv = document.getElementById("capmResults");

        calculateBtn.addEventListener("click", () => {
          const rf =
            parseFloat(document.getElementById("riskFreeRate").value) / 100;
          const beta = parseFloat(document.getElementById("beta").value);
          const rm =
            parseFloat(document.getElementById("marketReturn").value) / 100;

          if (isNaN(rf) || isNaN(beta) || isNaN(rm)) {
            alert("Please enter valid numbers.");
            return;
          }

          const marketRiskPremium = rm - rf;
          const riskPremium = beta * marketRiskPremium;
          const expectedReturn = rf + riskPremium;

          resultsDiv.innerHTML = `
                    <div class="results-grid">
                        <div class="result-card" style="background-color: var(--indigo-100);">
                            <div class="result-label">Expected Return</div>
                            <div class="result-value">${(
                              expectedReturn * 100
                            ).toFixed(2)}%</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Risk-free Rate</div>
                            <div class="result-value">${(rf * 100).toFixed(
                              2
                            )}%</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Market Risk Premium</div>
                            <div class="result-value">${(
                              marketRiskPremium * 100
                            ).toFixed(2)}%</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Risk Premium</div>
                            <div class="result-value">${(
                              riskPremium * 100
                            ).toFixed(2)}%</div>
                        </div>
                    </div>
                `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- Bond Pricing Calculator ---
      function renderBondPricingCalculator() {
        return `
                <h2 class="calculator-title">Bond Pricing Calculator</h2>
                <div class="explanation-box">
                    <div class="explanation-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Fixed Income Valuation
                    </div>
                    <p class="explanation-text">
                        This calculator determines the fair value of a bond based on its coupon rate, yield to maturity, and time to maturity.
                        Bond prices move inversely to interest rates - when rates rise, bond prices fall, and vice versa.
                    </p>
                    <p class="explanation-text">
                        <strong>Yield to Maturity (YTM)</strong> is the total return anticipated on a bond if it is held until it matures.
                        When YTM equals the coupon rate, the bond trades at par (face value). When YTM is higher than the coupon rate, the bond trades at a discount.
                    </p>
                    <div class="explanation-note">
                        <strong>Financial Insight:</strong> Bond duration measures sensitivity to interest rate changes. Longer-term bonds are more sensitive to rate changes than shorter-term bonds.
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Face Value ($)</label>
                        <input type="number" id="faceValue" class="form-input" placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Coupon Rate (%)</label>
                        <input type="number" id="couponRate" class="form-input" placeholder="5" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Yield to Maturity (%)</label>
                        <input type="number" id="ytm" class="form-input" placeholder="6" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Years to Maturity</label>
                        <input type="number" id="yearsToMaturity" class="form-input" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Frequency</label>
                        <select id="frequency" class="form-select">
                            <option value="1">Annual</option>
                            <option value="2" selected>Semi-annual</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-warning" id="calculateBond">Calculate Bond Price</button>
                <div id="bondResults" class="results-container hidden" style="border-color: var(--orange-100); background-color: var(--orange-50);">
                    <!-- Results will be populated here -->
                </div>
            `;
      }

      function setupBondPricingCalculator() {
        const calculateBtn = document.getElementById("calculateBond");
        const resultsDiv = document.getElementById("bondResults");

        calculateBtn.addEventListener("click", () => {
          const faceValue = parseFloat(
            document.getElementById("faceValue").value
          );
          const couponRate =
            parseFloat(document.getElementById("couponRate").value) / 100;
          const ytm = parseFloat(document.getElementById("ytm").value) / 100;
          const yearsToMaturity = parseFloat(
            document.getElementById("yearsToMaturity").value
          );
          const frequency = parseFloat(
            document.getElementById("frequency").value
          );

          if (
            isNaN(faceValue) ||
            isNaN(couponRate) ||
            isNaN(ytm) ||
            isNaN(yearsToMaturity) ||
            isNaN(frequency) ||
            faceValue < 0 ||
            couponRate < 0 ||
            ytm < 0 ||
            yearsToMaturity < 0 ||
            (frequency !== 1 && frequency !== 2)
          ) {
            alert("Please enter valid positive numbers.");
            return;
          }

          const couponPayment = (faceValue * couponRate) / frequency;
          const periods = yearsToMaturity * frequency;
          const periodicYield = ytm / frequency;

          let bondPrice = 0;
          for (let t = 1; t <= periods; t++) {
            bondPrice += couponPayment / Math.pow(1 + periodicYield, t);
          }
          bondPrice += faceValue / Math.pow(1 + periodicYield, periods);

          resultsDiv.innerHTML = `
                    <div class="results-grid">
                        <div class="result-card" style="background-color: var(--orange-100);">
                            <div class="result-label">Bond Price</div>
                            <div class="result-value">$${bondPrice.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Face Value</div>
                            <div class="result-value">$${faceValue.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Coupon Payment</div>
                            <div class="result-value">$${couponPayment.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Yield to Maturity</div>
                            <div class="result-value">${(ytm * 100).toFixed(
                              2
                            )}%</div>
                        </div>
                    </div>
                `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- NPV & IRR Calculator ---
      function renderNPVIRRCalculator() {
        return `
                <h2 class="calculator-title">NPV & IRR Calculator</h2>
                <div class="explanation-box">
                    <div class="explanation-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Capital Budgeting Decisions
                    </div>
                    <p class="explanation-text">
                        <strong>Net Present Value (NPV)</strong> measures the profitability of a project by calculating the difference between the present value of cash inflows and outflows.
                        A positive NPV indicates the project should be profitable.
                    </p>
                    <p class="explanation-text">
                        <strong>Internal Rate of Return (IRR)</strong> is the discount rate that makes the NPV of all cash flows equal to zero.
                        It represents the expected compound annual rate of return that will be earned on a project.
                    </p>
                    <div class="explanation-note">
                        <strong>Financial Insight:</strong> When evaluating mutually exclusive projects, NPV is generally preferred over IRR as it directly measures the value added to the firm. The IRR can be misleading when comparing projects of different sizes or durations.
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Initial Investment ($)</label>
                        <input type="number" id="initialInvestment" class="form-input" placeholder="100000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Discount Rate (%)</label>
                        <input type="number" id="discountRate" class="form-input" placeholder="10" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Cash Flows by Year ($)</label>
                    <div class="cash-flows-grid" id="cashFlowsContainer">
                        <!-- Cash flows will be populated by JavaScript -->
                    </div>
                </div>
                <button class="btn btn-danger" id="calculateNPV">Calculate NPV & IRR</button>
                <div id="npvResults" class="results-container hidden" style="border-color: var(--rose-100); background-color: var(--rose-50);">
                    <!-- Results will be populated here -->
                </div>
            `;
      }

      // Fixed IRR calculation function
      function calculateIRR(cashFlows, initialInvestment, initialGuess = 0.1) {
        const maxIterations = 1000;
        const tolerance = 1e-7;
        let irr = initialGuess;

        // Validate cash flows first
        const hasPositive = cashFlows.some((cf) => cf > 0);
        const hasNegative = cashFlows.some((cf) => cf < 0);

        if (!hasPositive || !hasNegative) {
          return {
            success: false,
            message: "Need both positive and negative cash flows",
          };
        }

        for (let i = 0; i < maxIterations; i++) {
          let npv = -Math.abs(initialInvestment);
          let derivative = 0;

          for (let t = 0; t < cashFlows.length; t++) {
            const period = t + 1;
            const denominator = Math.pow(1 + irr, period);
            npv += cashFlows[t] / denominator;
            derivative -= (period * cashFlows[t]) / (denominator * (1 + irr));
          }

          // Check if derivative is too small (avoid division by zero)
          if (Math.abs(derivative) < 1e-10) {
            return {
              success: false,
              message: "IRR calculation failed - derivative too small",
            };
          }

          const delta = npv / derivative;
          irr -= delta;

          // Prevent IRR from going to unrealistic values
          if (irr < -0.99) irr = -0.99; // Minimum -99%
          if (irr > 10) irr = 10; // Maximum 1000%

          if (Math.abs(delta) < tolerance) {
            return { success: true, irr: irr };
          }
        }

        return {
          success: false,
          message: "IRR did not converge - may have multiple solutions",
        };
      }

      function setupNPVIRRCalculator() {
        const cashFlowsContainer =
          document.getElementById("cashFlowsContainer");
        const calculateBtn = document.getElementById("calculateNPV");
        const resultsDiv = document.getElementById("npvResults");

        // Create 5 cash flow inputs
        for (let i = 1; i <= 5; i++) {
          const div = document.createElement("div");
          div.innerHTML = `
                    <label class="form-label">Year ${i}</label>
                    <input type="number" class="form-input cash-flow-input" id="cf${i}" placeholder="25000">
                `;
          cashFlowsContainer.appendChild(div);
        }

        calculateBtn.addEventListener("click", () => {
          const initialInvestment = parseFloat(
            document.getElementById("initialInvestment").value
          );
          const discountRate =
            parseFloat(document.getElementById("discountRate").value) / 100;

          if (isNaN(initialInvestment) || isNaN(discountRate)) {
            alert(
              "Please enter valid numbers for initial investment and discount rate."
            );
            return;
          }

          // Get cash flows
          const cashFlows = [];
          for (let i = 1; i <= 5; i++) {
            const cf = parseFloat(document.getElementById(`cf${i}`).value);
            if (isNaN(cf)) {
              alert(`Please enter a valid number for Year ${i} cash flow.`);
              return;
            }
            cashFlows.push(cf);
          }

          // Calculate NPV
          let npv = -initialInvestment;
          for (let i = 0; i < cashFlows.length; i++) {
            npv += cashFlows[i] / Math.pow(1 + discountRate, i + 1);
          }

          // Calculate IRR using the fixed function
          const irrResult = calculateIRR(cashFlows, initialInvestment);

          if (!irrResult.success) {
            resultsDiv.innerHTML = `
                    <div class="results-grid">
                        <div class="result-card" style="background-color: var(--rose-100);">
                            <div class="result-label">NPV</div>
                            <div class="result-value">$${npv.toFixed(2)}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--orange-100);">
                            <div class="result-label">IRR</div>
                            <div class="result-error">${irrResult.message}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Initial Investment</div>
                            <div class="result-value">$${initialInvestment.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Discount Rate</div>
                            <div class="result-value">${(
                              discountRate * 100
                            ).toFixed(2)}%</div>
                        </div>
                    </div>
                `;
          } else {
            const irr = irrResult.irr;
            resultsDiv.innerHTML = `
                    <div class="results-grid">
                        <div class="result-card" style="background-color: var(--rose-100);">
                            <div class="result-label">NPV</div>
                            <div class="result-value">$${npv.toFixed(2)}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--pink-100);">
                            <div class="result-label">IRR</div>
                            <div class="result-value">${(irr * 100).toFixed(
                              2
                            )}%</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Initial Investment</div>
                            <div class="result-value">$${initialInvestment.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Discount Rate</div>
                            <div class="result-value">${(
                              discountRate * 100
                            ).toFixed(2)}%</div>
                        </div>
                    </div>
                `;
          }

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- Black-Scholes Calculator ---
      function renderBlackScholesCalculator() {
        return `
                <h2 class="calculator-title">Black-Scholes Option Pricing Model</h2>
                <div class="explanation-box">
                    <div class="explanation-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Options Valuation
                    </div>
                    <p class="explanation-text">
                        The <strong>Black-Scholes model</strong> is a mathematical model for pricing options contracts. It calculates the theoretical price of European-style options
                        (which can only be exercised at expiration) using current stock prices, expected dividends, the option's strike price, expected interest rates, time to expiration, and expected volatility.
                    </p>
                    <p class="explanation-text">
                        The model assumes that the price of heavily traded assets follows a geometric Brownian motion with constant drift and volatility.
                        It revolutionized options trading by providing a standardized way to price options.
                    </p>
                    <div class="explanation-note">
                        <strong>Financial Insight:</strong> The "Greeks" (Delta, Gamma, Theta, Vega, Rho) measure different dimensions of risk in option positions and are derived from the Black-Scholes model.
                    </div>
                </div>
                <div class="options-toggle">
                    <button class="option-btn active" id="callOption">Call Option</button>
                    <button class="option-btn" id="putOption">Put Option</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Current Stock Price ($)</label>
                        <input type="number" id="stockPrice" class="form-input" placeholder="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Strike Price ($)</label>
                        <input type="number" id="strikePrice" class="form-input" placeholder="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time to Expiration (Years)</label>
                        <input type="number" id="timeToExp" class="form-input" placeholder="1" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Risk-free Rate (%)</label>
                        <input type="number" id="bsRiskFreeRate" class="form-input" placeholder="5" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Volatility (%)</label>
                        <input type="number" id="volatility" class="form-input" placeholder="20" step="0.1">
                    </div>
                </div>
                <button class="btn btn-primary" id="calculateBS">Calculate Option Price</button>
                <div id="bsResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                    <!-- Results will be populated here -->
                </div>
            `;
      }

      // Improved Normal CDF with higher accuracy
      function normalCDF(x) {
        // Approximation by Abramowitz and Stegun (1964)
        // Accuracy: 7.5e-8 (much better than current 0.5%)

        const sign = x >= 0 ? 1 : -1;
        x = Math.abs(x) / Math.sqrt(2);

        // Constants
        const a1 = 0.254829592;
        const a2 = -0.284496736;
        const a3 = 1.421413741;
        const a4 = -1.453152027;
        const a5 = 1.061405429;
        const p = 0.3275911;

        const t = 1 / (1 + p * x);
        const erfApprox =
          1 -
          ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

        return 0.5 * (1 + sign * erfApprox);
      }

      // Normal PDF for Greeks calculation
      function normalPDF(x) {
        return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
      }

      // Greeks calculation
      function calculateGreeks(S, K, T, r, sigma, isCall) {
        const d1 =
          (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) /
          (sigma * Math.sqrt(T));
        const d2 = d1 - sigma * Math.sqrt(T);

        const Nd1 = normalCDF(d1);
        const Nd2 = normalCDF(d2);
        const nd1 = normalPDF(d1);

        // Delta: Rate of change of option price with respect to stock price
        const delta = isCall ? Nd1 : Nd1 - 1;

        // Gamma: Rate of change of delta with respect to stock price
        const gamma = nd1 / (S * sigma * Math.sqrt(T));

        // Theta: Rate of change of option price with respect to time (per day)
        const theta1 = -(S * nd1 * sigma) / (2 * Math.sqrt(T));
        const theta2 = isCall
          ? -r * K * Math.exp(-r * T) * Nd2
          : r * K * Math.exp(-r * T) * normalCDF(-d2);
        const theta = (theta1 + theta2) / 365; // Per day

        // Vega: Rate of change of option price with respect to volatility
        const vega = (S * nd1 * Math.sqrt(T)) / 100; // Per 1% change in volatility

        // Rho: Rate of change of option price with respect to interest rate
        const rho = isCall
          ? (K * T * Math.exp(-r * T) * Nd2) / 100
          : -(K * T * Math.exp(-r * T) * normalCDF(-d2)) / 100;

        return { delta, gamma, theta, vega, rho };
      }

      function setupBlackScholesCalculator() {
        const callOption = document.getElementById("callOption");
        const putOption = document.getElementById("putOption");
        const calculateBtn = document.getElementById("calculateBS");
        const resultsDiv = document.getElementById("bsResults");

        let isCall = true;

        callOption.addEventListener("click", () => {
          callOption.classList.add("active");
          putOption.classList.remove("active");
          isCall = true;
        });

        putOption.addEventListener("click", () => {
          putOption.classList.add("active");
          callOption.classList.remove("active");
          isCall = false;
        });

        calculateBtn.addEventListener("click", () => {
          const S = parseFloat(document.getElementById("stockPrice").value);
          const K = parseFloat(document.getElementById("strikePrice").value);
          const T = parseFloat(document.getElementById("timeToExp").value);
          const r =
            parseFloat(document.getElementById("bsRiskFreeRate").value) / 100;
          const sigma =
            parseFloat(document.getElementById("volatility").value) / 100;

          if (
            isNaN(S) ||
            isNaN(K) ||
            isNaN(T) ||
            isNaN(r) ||
            isNaN(sigma) ||
            S <= 0 ||
            K <= 0 ||
            T <= 0 ||
            sigma <= 0
          ) {
            alert("Please enter valid positive numbers.");
            return;
          }

          const d1 =
            (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) /
            (sigma * Math.sqrt(T));
          const d2 = d1 - sigma * Math.sqrt(T);

          const Nd1 = normalCDF(d1);
          const Nd2 = normalCDF(d2);
          const Nminusd1 = normalCDF(-d1);
          const Nminusd2 = normalCDF(-d2);

          let optionPrice;
          if (isCall) {
            optionPrice = S * Nd1 - K * Math.exp(-r * T) * Nd2;
          } else {
            optionPrice = K * Math.exp(-r * T) * Nminusd2 - S * Nminusd1;
          }

          // Calculate Greeks
          const greeks = calculateGreeks(S, K, T, r, sigma, isCall);

          resultsDiv.innerHTML = `
                    <div class="results-grid">
                        <div class="result-card" style="background-color: var(--indigo-100);">
                            <div class="result-label">${
                              isCall ? "Call" : "Put"
                            } Price</div>
                            <div class="result-value">$${optionPrice.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--blue-100);">
                            <div class="result-label">Delta (Δ)</div>
                            <div class="result-value">${greeks.delta.toFixed(
                              4
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--cyan-100);">
                            <div class="result-label">Gamma (Γ)</div>
                            <div class="result-value">${greeks.gamma.toFixed(
                              4
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--green-100);">
                            <div class="result-label">Theta (Θ)</div>
                            <div class="result-value">$${greeks.theta.toFixed(
                              2
                            )}/day</div>
                        </div>
                        <div class="result-card" style="background-color: var(--purple-100);">
                            <div class="result-label">Vega (ν)</div>
                            <div class="result-value">$${greeks.vega.toFixed(
                              2
                            )}</div>
                        </div>
                        <div class="result-card" style="background-color: var(--pink-100);">
                            <div class="result-label">Rho (ρ)</div>
                            <div class="result-value">$${greeks.rho.toFixed(
                              2
                            )}</div>
                        </div>
                    </div>
                `;

          resultsDiv.classList.remove("hidden");
        });
      }

      // --- WACC Calculator ---
      function renderWACCCalculator() {
        return `
                <h2 class="calculator-title">Weighted Average Cost of Capital (WACC)</h2>
                <div class="explanation-box">
                    <div class="explanation-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Company's Cost of Capital
                    </div>
                    <p class="explanation-text">
                        <strong>Weighted Average Cost of Capital (WACC)</strong> represents a firm's average after-tax cost of capital from all sources, including common stock, preferred stock, bonds, and other forms of debt.
                        It is the minimum return a company must earn on its existing asset base to satisfy its creditors, owners, and other providers of capital.
                    </p>
                    <p class="explanation-text">
                        Companies use WACC as a hurdle rate for evaluating investment opportunities. Projects with returns below WACC would destroy value, while those with returns above WACC would create value.
                    </p>
                    <div class="explanation-note">
                        <strong>Financial Insight:</strong> WACC is widely used in discounted cash flow (DCF) analysis as the discount rate. A lower WACC makes future cash flows more valuable, increasing the perceived value of a company.
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Market Value of Equity ($)</label>
                        <input type="number" id="marketValueEquity" class="form-input" placeholder="500000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Market Value of Debt ($)</label>
                        <input type="number" id="marketValueDebt" class="form-input" placeholder="300000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cost of Equity (%)</label>
                        <input type="number" id="costOfEquity" class="form-input" placeholder="12" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cost of Debt (%)</label>
                        <input type="number" id="costOfDebt" class="form-input" placeholder="6" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tax Rate (%)</label>
                        <input type="number" id="taxRate" class="form-input" placeholder="30" step="0.1">
                    </div>
                </div>
                <button class="btn btn-success" id="calculateWACC">Calculate WACC</button>
                <div id="waccResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50);">
                    <!-- Results will be populated here -->
                </div>
            `;
      }

      function setupWACCCalculator() {
        const calculateBtn = document.getElementById("calculateWACC");
        const resultsDiv = document.getElementById("waccResults");

        calculateBtn.addEventListener("click", () => {
          const E = parseFloat(
            document.getElementById("marketValueEquity").value
          );
          const D = parseFloat(
            document.getElementById("marketValueDebt").value
          );
          const Re =
            parseFloat(document.getElementById("costOfEquity").value) / 100;
          const Rd =
            parseFloat(document.getElementById("costOfDebt").value) / 100;
          const T = parseFloat(document.getElementById("taxRate").value) / 100;

          if (
            isNaN(E) ||
            isNaN(D) ||
            isNaN(Re) ||
            isNaN(Rd) ||
            isNaN(T) ||
            E < 0 ||
            D < 0 ||
            Re < 0 ||
            Rd < 0 ||
            T < 0 ||
            T > 100
          ) {
            alert("Please enter valid numbers.");
            return;
          }

          const V = E + D;

          // WACC = (E/V × Re) + ((D/V × Rd) × (1-T))
          const wacc = (E / V) * Re + (D / V) * Rd * (1 - T);
          const equityWeight = E / V;
          const debtWeight = D / V;
          const afterTaxCostOfDebt = Rd * (1 - T);

          resultsDiv.innerHTML = `
                    <div class="results-grid">
                        <div class="result-card" style="background-color: var(--green-100);">
                            <div class="result-label">WACC</div>
                            <div class="result-value">${(wacc * 100).toFixed(
                              2
                            )}%</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Equity Weight</div>
                            <div class="result-value">${(
                              equityWeight * 100
                            ).toFixed(1)}%</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">Debt Weight</div>
                            <div class="result-value">${(
                              debtWeight * 100
                            ).toFixed(1)}%</div>
                        </div>
                        <div class="result-card" style="background-color: var(--slate-100);">
                            <div class="result-label">After-tax Cost of Debt</div>
                            <div class="result-value">${(
                              afterTaxCostOfDebt * 100
                            ).toFixed(2)}%</div>
                        </div>
                    </div>
                `;

          resultsDiv.classList.remove("hidden");
        });
      }
      // --- DCF Valuation Calculator ---
      function renderDCFCalculator() {
        return `
          <h2 class="calculator-title">Discounted Cash Flow (DCF) Valuation</h2>
          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Enterprise Valuation Model
            </div>
            <p class="explanation-text">
              <strong>DCF Valuation</strong> determines a company's intrinsic value by calculating the present value of its expected future cash flows.
              This is the most widely used valuation method in investment banking, private equity, and equity research.
            </p>
            <p class="explanation-text">
              The model projects Free Cash Flows (FCF) for a forecast period (typically 5-10 years), then estimates a Terminal Value
              to capture all cash flows beyond the forecast period. Both are discounted back to present value using WACC.
            </p>
            <div class="explanation-note">
              <strong>PE/IB Insight:</strong> DCF is highly sensitive to assumptions (growth rate, WACC, terminal value).
              Always perform sensitivity analysis on key variables. A 1% change in WACC can swing valuation by 10-15%.
            </div>
          </div>

          <div class="options-toggle">
            <button class="option-btn active" id="terminalGrowth">Perpetuity Growth</button>
            <button class="option-btn" id="terminalMultiple">Exit Multiple</button>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Initial FCF ($M)</label>
              <input type="number" id="initialFCF" class="form-input" placeholder="100" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">FCF Growth Rate (%)</label>
              <input type="number" id="fcfGrowthRate" class="form-input" placeholder="8" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Forecast Period (Years)</label>
              <input type="number" id="forecastPeriod" class="form-input" placeholder="5" min="1" max="20">
            </div>
            <div class="form-group">
              <label class="form-label">WACC / Discount Rate (%)</label>
              <input type="number" id="dcfWACC" class="form-input" placeholder="10" step="0.1">
            </div>
            <div class="form-group" id="terminalGrowthInput">
              <label class="form-label">Terminal Growth Rate (%)</label>
              <input type="number" id="terminalGrowthRate" class="form-input" placeholder="3" step="0.1">
            </div>
            <div class="form-group hidden" id="terminalMultipleInput">
              <label class="form-label">Exit EV/EBITDA Multiple</label>
              <input type="number" id="exitMultiple" class="form-input" placeholder="10" step="0.1">
            </div>
            <div class="form-group hidden" id="terminalEBITDAInput">
              <label class="form-label">Terminal Year EBITDA ($M)</label>
              <input type="number" id="terminalEBITDA" class="form-input" placeholder="150" step="0.1">
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Cash & Equivalents ($M)</label>
              <input type="number" id="cashEquiv" class="form-input" placeholder="50" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Total Debt ($M)</label>
              <input type="number" id="totalDebt" class="form-input" placeholder="200" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Shares Outstanding (M)</label>
              <input type="number" id="sharesOut" class="form-input" placeholder="100" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Minority Interest ($M)</label>
              <input type="number" id="minorityInterest" class="form-input" placeholder="0" step="0.1">
            </div>
          </div>

          <button class="btn btn-primary" id="calculateDCF">Calculate Enterprise & Equity Value</button>

          <div id="dcfResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
            <!-- Results will be populated here -->
          </div>

          <div id="dcfBreakdown" class="hidden" style="margin-top: 2rem; padding: 1.5rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--slate-700);">Cash Flow Projection</h3>
            <div style="overflow-x: auto;">
              <table id="fcfTable" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                <!-- Table will be populated here -->
              </table>
            </div>
          </div>
        `;
      }

      function setupDCFCalculator() {
        const terminalGrowthBtn = document.getElementById("terminalGrowth");
        const terminalMultipleBtn = document.getElementById("terminalMultiple");
        const terminalGrowthInput = document.getElementById(
          "terminalGrowthInput"
        );
        const terminalMultipleInput = document.getElementById(
          "terminalMultipleInput"
        );
        const terminalEBITDAInput = document.getElementById(
          "terminalEBITDAInput"
        );
        const calculateBtn = document.getElementById("calculateDCF");
        const resultsDiv = document.getElementById("dcfResults");
        const breakdownDiv = document.getElementById("dcfBreakdown");

        let usePerpetuityGrowth = true;

        // Toggle between terminal value methods
        terminalGrowthBtn.addEventListener("click", () => {
          terminalGrowthBtn.classList.add("active");
          terminalMultipleBtn.classList.remove("active");
          terminalGrowthInput.classList.remove("hidden");
          terminalMultipleInput.classList.add("hidden");
          terminalEBITDAInput.classList.add("hidden");
          usePerpetuityGrowth = true;
        });

        terminalMultipleBtn.addEventListener("click", () => {
          terminalMultipleBtn.classList.add("active");
          terminalGrowthBtn.classList.remove("active");
          terminalGrowthInput.classList.add("hidden");
          terminalMultipleInput.classList.remove("hidden");
          terminalEBITDAInput.classList.remove("hidden");
          usePerpetuityGrowth = false;
        });

        calculateBtn.addEventListener("click", () => {
          // Get inputs
          const initialFCF = parseFloat(
            document.getElementById("initialFCF").value
          );
          const fcfGrowthRate =
            parseFloat(document.getElementById("fcfGrowthRate").value) / 100;
          const forecastPeriod = parseInt(
            document.getElementById("forecastPeriod").value
          );
          const wacc =
            parseFloat(document.getElementById("dcfWACC").value) / 100;
          const cash = parseFloat(document.getElementById("cashEquiv").value);
          const debt = parseFloat(document.getElementById("totalDebt").value);
          const shares = parseFloat(document.getElementById("sharesOut").value);
          const minorityInt =
            parseFloat(document.getElementById("minorityInterest").value) || 0;

          // Validate inputs
          if (
            isNaN(initialFCF) ||
            isNaN(fcfGrowthRate) ||
            isNaN(forecastPeriod) ||
            isNaN(wacc) ||
            isNaN(cash) ||
            isNaN(debt) ||
            isNaN(shares)
          ) {
            alert("Please enter valid numbers for all required fields.");
            return;
          }

          if (forecastPeriod < 1 || forecastPeriod > 20) {
            alert("Forecast period must be between 1 and 20 years.");
            return;
          }

          if (wacc <= 0) {
            alert("WACC must be positive.");
            return;
          }

          // Project FCFs
          const fcfs = [];
          const pvFCFs = [];
          let cumulativePVFCF = 0;

          for (let year = 1; year <= forecastPeriod; year++) {
            const fcf = initialFCF * Math.pow(1 + fcfGrowthRate, year);
            const pvFCF = fcf / Math.pow(1 + wacc, year);
            fcfs.push(fcf);
            pvFCFs.push(pvFCF);
            cumulativePVFCF += pvFCF;
          }

          // Calculate Terminal Value
          let terminalValue, terminalValuePV;

          if (usePerpetuityGrowth) {
            const terminalGrowthRate =
              parseFloat(document.getElementById("terminalGrowthRate").value) /
              100;

            if (isNaN(terminalGrowthRate)) {
              alert("Please enter a valid terminal growth rate.");
              return;
            }

            if (terminalGrowthRate >= wacc) {
              alert(
                "Terminal growth rate must be less than WACC. Typically 2-3% (GDP growth rate)."
              );
              return;
            }

            const finalYearFCF = fcfs[fcfs.length - 1];
            const terminalYearFCF = finalYearFCF * (1 + terminalGrowthRate);

            // Gordon Growth Model: TV = FCF(t+1) / (WACC - g)
            terminalValue = terminalYearFCF / (wacc - terminalGrowthRate);
            terminalValuePV =
              terminalValue / Math.pow(1 + wacc, forecastPeriod);
          } else {
            const exitMultiple = parseFloat(
              document.getElementById("exitMultiple").value
            );
            const terminalEBITDA = parseFloat(
              document.getElementById("terminalEBITDA").value
            );

            if (isNaN(exitMultiple) || isNaN(terminalEBITDA)) {
              alert("Please enter valid exit multiple and terminal EBITDA.");
              return;
            }

            if (exitMultiple <= 0) {
              alert("Exit multiple must be positive.");
              return;
            }

            // TV = Exit Multiple × Terminal Year EBITDA
            terminalValue = exitMultiple * terminalEBITDA;
            terminalValuePV =
              terminalValue / Math.pow(1 + wacc, forecastPeriod);
          }

          // Calculate Enterprise Value
          const enterpriseValue = cumulativePVFCF + terminalValuePV;

          // Calculate Equity Value
          const equityValue = enterpriseValue + cash - debt - minorityInt;

          // Calculate per share value
          const valuePerShare = equityValue / shares;

          // Display results
          const tvPercentage = (terminalValuePV / enterpriseValue) * 100;

          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: var(--indigo-100);">
                <div class="result-label">Enterprise Value</div>
                <div class="result-value">$${enterpriseValue.toFixed(1)}M</div>
              </div>
              <div class="result-card" style="background-color: var(--blue-100);">
                <div class="result-label">Equity Value</div>
                <div class="result-value">$${equityValue.toFixed(1)}M</div>
              </div>
              <div class="result-card" style="background-color: var(--cyan-100);">
                <div class="result-label">Value per Share</div>
                <div class="result-value">$${valuePerShare.toFixed(2)}</div>
              </div>
              <div class="result-card" style="background-color: var(--green-100);">
                <div class="result-label">PV of Forecast FCFs</div>
                <div class="result-value">$${cumulativePVFCF.toFixed(1)}M</div>
              </div>
              <div class="result-card" style="background-color: var(--emerald-100);">
                <div class="result-label">Terminal Value (PV)</div>
                <div class="result-value">$${terminalValuePV.toFixed(1)}M</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">TV % of Total</div>
                <div class="result-value">${tvPercentage.toFixed(1)}%</div>
              </div>
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: var(--blue-50); border-radius: 0.5rem; border-left: 3px solid var(--blue-500);">
              <div style="font-size: 0.875rem; color: var(--slate-700);">
                <strong>Bridge to Equity Value:</strong><br>
                Enterprise Value: $${enterpriseValue.toFixed(1)}M<br>
                + Cash: $${cash.toFixed(1)}M<br>
                − Debt: $${debt.toFixed(1)}M<br>
                ${
                  minorityInt > 0
                    ? `− Minority Interest: $${minorityInt.toFixed(1)}M<br>`
                    : ""
                }
                = Equity Value: $${equityValue.toFixed(1)}M
              </div>
            </div>
          `;

          resultsDiv.classList.remove("hidden");

          // Build FCF projection table
          let tableHTML = `
            <thead>
              <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Year</th>
                <th style="padding: 0.75rem; text-align: right; font-weight: 600;">FCF ($M)</th>
                <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Growth Rate</th>
                <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Discount Factor</th>
                <th style="padding: 0.75rem; text-align: right; font-weight: 600;">PV of FCF ($M)</th>
              </tr>
            </thead>
            <tbody>
          `;

          for (let year = 1; year <= forecastPeriod; year++) {
            const discountFactor = 1 / Math.pow(1 + wacc, year);
            const growthRate = year === 1 ? fcfGrowthRate : fcfGrowthRate;

            tableHTML += `
              <tr style="border-bottom: 1px solid var(--slate-200);">
                <td style="padding: 0.75rem; font-weight: 500;">Year ${year}</td>
                <td style="padding: 0.75rem; text-align: right;">$${fcfs[
                  year - 1
                ].toFixed(1)}</td>
                <td style="padding: 0.75rem; text-align: right;">${(
                  growthRate * 100
                ).toFixed(1)}%</td>
                <td style="padding: 0.75rem; text-align: right;">${discountFactor.toFixed(
                  4
                )}</td>
                <td style="padding: 0.75rem; text-align: right;">$${pvFCFs[
                  year - 1
                ].toFixed(1)}</td>
              </tr>
            `;
          }

          tableHTML += `
            <tr style="border-top: 2px solid var(--slate-300); background: var(--slate-50); font-weight: 600;">
              <td style="padding: 0.75rem;" colspan="4">PV of Forecast Period FCFs</td>
              <td style="padding: 0.75rem; text-align: right;">$${cumulativePVFCF.toFixed(
                1
              )}</td>
            </tr>
            <tr style="background: var(--indigo-50); font-weight: 600;">
              <td style="padding: 0.75rem;">Terminal Value</td>
              <td style="padding: 0.75rem; text-align: right;">$${terminalValue.toFixed(
                1
              )}</td>
              <td style="padding: 0.75rem; text-align: right;" colspan="2">
                ${
                  usePerpetuityGrowth
                    ? `Perpetuity @ ${parseFloat(
                        document.getElementById("terminalGrowthRate").value
                      ).toFixed(1)}%`
                    : `${parseFloat(
                        document.getElementById("exitMultiple").value
                      ).toFixed(1)}x EBITDA`
                }
              </td>
              <td style="padding: 0.75rem; text-align: right;">$${terminalValuePV.toFixed(
                1
              )}</td>
            </tr>
            <tr style="border-top: 2px solid var(--indigo-500); background: var(--indigo-100); font-weight: 700; font-size: 1rem;">
              <td style="padding: 1rem;" colspan="4">Enterprise Value</td>
              <td style="padding: 1rem; text-align: right;">$${enterpriseValue.toFixed(
                1
              )}</td>
            </tr>
          </tbody>
          `;

          document.getElementById("fcfTable").innerHTML = tableHTML;
          breakdownDiv.classList.remove("hidden");
        });
      }

      function renderLBOCalculator() {
        return `
          <h2 class="calculator-title">Leveraged Buyout (LBO) Model</h2>
          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Private Equity Transaction Model
            </div>
            <p class="explanation-text">
              An <strong>LBO Model</strong> analyzes a leveraged buyout transaction where a PE firm acquires a company using a combination of equity and debt.
              The model projects the company's financial performance, debt paydown schedule, and calculates returns (IRR and MoM) at exit.
            </p>
            <p class="explanation-text">
              Key drivers: <strong>Entry Multiple</strong> (purchase price), <strong>Exit Multiple</strong> (sale price),
              <strong>Debt/Equity Mix</strong>, <strong>EBITDA Growth</strong>, and <strong>Debt Paydown</strong> from free cash flow.
            </p>
            <div class="explanation-note">
              <strong>PE Insight:</strong> LBO returns come from 3 sources: (1) <strong>Multiple expansion</strong> (buying low, selling high),
              (2) <strong>Deleveraging</strong> (paying down debt with cash flow), and (3) <strong>EBITDA growth</strong> (operational improvements).
              Target IRR: 20-25%+ for PE funds.
            </div>
          </div>

          <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
            📊 Transaction Assumptions
          </h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">LTM EBITDA ($M)</label>
              <input type="number" id="lboEBITDA" class="form-input" placeholder="100" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Entry EV/EBITDA Multiple</label>
              <input type="number" id="entryMultiple" class="form-input" placeholder="10.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Exit EV/EBITDA Multiple</label>
              <input type="number" id="exitMultipleLBO" class="form-input" placeholder="10.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Transaction Fees (% of EV)</label>
              <input type="number" id="transFees" class="form-input" placeholder="2.0" step="0.1">
            </div>
          </div>

          <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
            💰 Sources & Uses
          </h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Debt / EBITDA Multiple</label>
              <input type="number" id="debtMultiple" class="form-input" placeholder="5.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Revolver ($M or % of Debt)</label>
              <input type="number" id="revolver" class="form-input" placeholder="0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Cash on Balance Sheet ($M)</label>
              <input type="number" id="existingCash" class="form-input" placeholder="10" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Minimum Cash ($M)</label>
              <input type="number" id="minCash" class="form-input" placeholder="10" step="0.1">
            </div>
          </div>

          <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
            📈 Operating Assumptions
          </h3>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Revenue Growth (Year 1, %)</label>
              <input type="number" id="revenueGrowth1" class="form-input" placeholder="5.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Revenue Growth (Years 2-5, %)</label>
              <input type="number" id="revenueGrowthSteady" class="form-input" placeholder="4.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">EBITDA Margin (%)</label>
              <input type="number" id="ebitdaMargin" class="form-input" placeholder="20.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Tax Rate (%)</label>
              <input type="number" id="lboTaxRate" class="form-input" placeholder="25.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">D&A (% of Revenue)</label>
              <input type="number" id="daPercent" class="form-input" placeholder="3.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">CapEx (% of Revenue)</label>
              <input type="number" id="capexPercent" class="form-input" placeholder="2.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">NWC (% of Revenue)</label>
              <input type="number" id="nwcPercent" class="form-input" placeholder="10.0" step="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Interest Rate on Debt (%)</label>
              <input type="number" id="interestRateDebt" class="form-input" placeholder="6.0" step="0.1">
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Hold Period (Years)</label>
              <input type="number" id="holdPeriod" class="form-input" placeholder="5" min="1" max="10">
            </div>
          </div>

          <button class="btn btn-success" id="calculateLBO">Run LBO Model</button>

          <div id="lboResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50);">
            <!-- Results will be populated here -->
          </div>

          <div id="lboSourcesUses" class="hidden" style="margin-top: 2rem; padding: 1.5rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--slate-700);">Sources & Uses of Funds</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
              <div id="usesTable"></div>
              <div id="sourcesTable"></div>
            </div>
          </div>

          <div id="lboProjections" class="hidden" style="margin-top: 2rem; padding: 1.5rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--slate-700);">5-Year Financial Projections</h3>
            <div style="overflow-x: auto;">
              <table id="projectionsTable" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                <!-- Table will be populated here -->
              </table>
            </div>
          </div>

          <div id="lboReturns" class="hidden" style="margin-top: 2rem; padding: 1.5rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--slate-700);">Returns Analysis & Exit Waterfall</h3>
            <div id="returnsBreakdown"></div>
          </div>
        `;
      }

      function setupLBOCalculator() {
        const calculateBtn = document.getElementById("calculateLBO");
        const resultsDiv = document.getElementById("lboResults");
        const sourcesUsesDiv = document.getElementById("lboSourcesUses");
        const projectionsDiv = document.getElementById("lboProjections");
        const returnsDiv = document.getElementById("lboReturns");

        calculateBtn.addEventListener("click", () => {
          // ==================== GET ALL INPUTS ====================
          const ltmEBITDA = parseFloat(
            document.getElementById("lboEBITDA").value
          );
          const entryMultiple = parseFloat(
            document.getElementById("entryMultiple").value
          );
          const exitMultiple = parseFloat(
            document.getElementById("exitMultipleLBO").value
          );
          const transFees =
            parseFloat(document.getElementById("transFees").value) / 100;
          const debtMultiple = parseFloat(
            document.getElementById("debtMultiple").value
          );
          const revolver = parseFloat(
            document.getElementById("revolver").value
          );
          const existingCash = parseFloat(
            document.getElementById("existingCash").value
          );
          const minCash = parseFloat(document.getElementById("minCash").value);
          const revenueGrowth1 =
            parseFloat(document.getElementById("revenueGrowth1").value) / 100;
          const revenueGrowthSteady =
            parseFloat(document.getElementById("revenueGrowthSteady").value) /
            100;
          const ebitdaMargin =
            parseFloat(document.getElementById("ebitdaMargin").value) / 100;
          const taxRate =
            parseFloat(document.getElementById("lboTaxRate").value) / 100;
          const daPercent =
            parseFloat(document.getElementById("daPercent").value) / 100;
          const capexPercent =
            parseFloat(document.getElementById("capexPercent").value) / 100;
          const nwcPercent =
            parseFloat(document.getElementById("nwcPercent").value) / 100;
          const interestRate =
            parseFloat(document.getElementById("interestRateDebt").value) / 100;
          const holdPeriod = parseInt(
            document.getElementById("holdPeriod").value
          );

          // ==================== VALIDATION ====================
          if (
            isNaN(ltmEBITDA) ||
            isNaN(entryMultiple) ||
            isNaN(exitMultiple) ||
            isNaN(debtMultiple) ||
            isNaN(holdPeriod)
          ) {
            alert("Please fill in all required fields with valid numbers.");
            return;
          }

          if (holdPeriod < 1 || holdPeriod > 10) {
            alert("Hold period must be between 1 and 10 years.");
            return;
          }

          if (entryMultiple <= 0 || exitMultiple <= 0) {
            alert("Entry and exit multiples must be positive.");
            return;
          }

          // ==================== STEP 1: PURCHASE PRICE & SOURCES/USES ====================
          const purchaseEV = ltmEBITDA * entryMultiple;
          const transactionFees = purchaseEV * transFees;
          const totalUses = purchaseEV + transactionFees;

          // Debt sizing
          const totalDebt = ltmEBITDA * debtMultiple;
          const revolverAmount = revolver; // Simplified: direct amount
          const termLoan = totalDebt - revolverAmount;

          // Equity required
          const sponsorEquity = totalUses - totalDebt - existingCash;

          // Cash adjustment
          const excessCash = Math.max(0, existingCash - minCash);
          const netCashRequired = Math.max(0, minCash - existingCash);

          // ==================== STEP 2: PROJECT 5-YEAR FINANCIALS ====================
          const years = [];
          let currentRevenue = ltmEBITDA / ebitdaMargin; // Back into revenue from LTM EBITDA
          let prevNWC = currentRevenue * nwcPercent;

          for (let year = 1; year <= holdPeriod; year++) {
            const growthRate =
              year === 1 ? revenueGrowth1 : revenueGrowthSteady;
            const revenue = currentRevenue * (1 + growthRate);
            const ebitda = revenue * ebitdaMargin;
            const depreciation = revenue * daPercent;
            const ebit = ebitda - depreciation;

            // Interest expense (on beginning debt balance)
            const beginningDebt =
              year === 1 ? totalDebt : years[year - 2].endingDebt;
            const interestExpense = beginningDebt * interestRate;

            const ebt = ebit - interestExpense;
            const taxes = Math.max(0, ebt * taxRate); // No tax benefit if negative
            const netIncome = ebt - taxes;

            // Cash flow
            const capex = revenue * capexPercent;
            const nwc = revenue * nwcPercent;
            const changeInNWC = nwc - prevNWC;

            // Unlevered FCF (before debt paydown)
            const unleveredFCF = ebitda - taxes - capex - changeInNWC;

            // Debt paydown (use all excess cash to pay down debt)
            const mandatoryAmortization = 0; // Simplified: bullet payment at exit
            const optionalPaydown = Math.max(0, unleveredFCF - interestExpense);
            const totalDebtPaydown = mandatoryAmortization + optionalPaydown;

            const endingDebt = Math.max(0, beginningDebt - totalDebtPaydown);

            // Levered FCF (to equity)
            const leveredFCF =
              unleveredFCF - interestExpense - totalDebtPaydown;

            years.push({
              year,
              revenue,
              ebitda,
              depreciation,
              ebit,
              interestExpense,
              ebt,
              taxes,
              netIncome,
              capex,
              nwc,
              changeInNWC,
              unleveredFCF,
              totalDebtPaydown,
              beginningDebt,
              endingDebt,
              leveredFCF,
            });

            currentRevenue = revenue;
            prevNWC = nwc;
          }

          // ==================== STEP 3: EXIT VALUE & RETURNS ====================
          const finalYear = years[years.length - 1];
          const exitEBITDA = finalYear.ebitda;
          const exitEV = exitEBITDA * exitMultiple;
          const exitDebt = finalYear.endingDebt;
          const exitEquityValue = exitEV - exitDebt;

          // Returns
          const initialEquity = sponsorEquity;
          const totalEquityReturned = exitEquityValue;
          const moM = totalEquityReturned / initialEquity; // Money-on-Money Multiple

          // IRR calculation
          const cashFlows = [-initialEquity]; // Year 0: equity investment
          for (let i = 0; i < years.length - 1; i++) {
            cashFlows.push(0); // No interim distributions in this simplified model
          }
          cashFlows.push(exitEquityValue); // Final year: exit proceeds

          // Calculate IRR using Newton-Raphson
          let irr = 0.2; // Initial guess: 20%
          const maxIterations = 1000;
          const tolerance = 1e-7;

          for (let iter = 0; iter < maxIterations; iter++) {
            let npv = 0;
            let derivative = 0;

            for (let t = 0; t < cashFlows.length; t++) {
              npv += cashFlows[t] / Math.pow(1 + irr, t);
              derivative -= (t * cashFlows[t]) / Math.pow(1 + irr, t + 1);
            }

            if (Math.abs(derivative) < 1e-10) break;

            const delta = npv / derivative;
            irr -= delta;

            if (Math.abs(delta) < tolerance) break;
          }

          // ==================== DISPLAY RESULTS ====================

          // Main Results Card
          const irrColor =
            irr >= 0.2
              ? "var(--green-500)"
              : irr >= 0.15
              ? "var(--blue-500)"
              : "var(--orange-500)";
          const irrLabel =
            irr >= 0.25
              ? "🚀 Excellent"
              : irr >= 0.2
              ? "✅ Strong"
              : irr >= 0.15
              ? "⚠️ Acceptable"
              : "❌ Below Target";

          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: var(--green-100);">
                <div class="result-label">IRR</div>
                <div class="result-value" style="color: ${irrColor};">${(
            irr * 100
          ).toFixed(1)}%</div>
                <div style="font-size: 0.75rem; margin-top: 0.25rem;">${irrLabel}</div>
              </div>
              <div class="result-card" style="background-color: var(--blue-100);">
                <div class="result-label">Money Multiple (MoM)</div>
                <div class="result-value">${moM.toFixed(2)}x</div>
              </div>
              <div class="result-card" style="background-color: var(--cyan-100);">
                <div class="result-label">Equity Investment</div>
                <div class="result-value">$${initialEquity.toFixed(1)}M</div>
              </div>
              <div class="result-card" style="background-color: var(--indigo-100);">
                <div class="result-label">Exit Proceeds</div>
                <div class="result-value">$${exitEquityValue.toFixed(1)}M</div>
              </div>
              <div class="result-card" style="background-color: var(--purple-100);">
                <div class="result-label">Entry EV</div>
                <div class="result-value">$${purchaseEV.toFixed(1)}M</div>
              </div>
              <div class="result-card" style="background-color: var(--pink-100);">
                <div class="result-label">Exit EV</div>
                <div class="result-value">$${exitEV.toFixed(1)}M</div>
              </div>
            </div>
          `;
          resultsDiv.classList.remove("hidden");

          // ==================== SOURCES & USES TABLE ====================
          const usesHTML = `
            <div style="background: var(--slate-50); padding: 1rem; border-radius: 0.5rem;">
              <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--slate-700);">Uses of Funds</h4>
              <table style="width: 100%; font-size: 0.875rem;">
                <tr style="border-bottom: 1px solid var(--slate-200);">
                  <td style="padding: 0.5rem 0;">Purchase Enterprise Value</td>
                  <td style="text-align: right; font-weight: 500;">$${purchaseEV.toFixed(
                    1
                  )}M</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--slate-200);">
                  <td style="padding: 0.5rem 0;">Transaction Fees</td>
                  <td style="text-align: right; font-weight: 500;">$${transactionFees.toFixed(
                    1
                  )}M</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--slate-200);">
                  <td style="padding: 0.5rem 0;">Cash to Balance Sheet</td>
                  <td style="text-align: right; font-weight: 500;">$${minCash.toFixed(
                    1
                  )}M</td>
                </tr>
                <tr style="border-top: 2px solid var(--slate-400); font-weight: 700;">
                  <td style="padding: 0.75rem 0;">Total Uses</td>
                  <td style="text-align: right;">$${(
                    totalUses + minCash
                  ).toFixed(1)}M</td>
                </tr>
              </table>
            </div>
          `;

          const sourcesHTML = `
            <div style="background: var(--blue-50); padding: 1rem; border-radius: 0.5rem;">
              <h4 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--slate-700);">Sources of Funds</h4>
              <table style="width: 100%; font-size: 0.875rem;">
                <tr style="border-bottom: 1px solid var(--slate-200);">
                  <td style="padding: 0.5rem 0;">Revolver</td>
                  <td style="text-align: right; font-weight: 500;">$${revolverAmount.toFixed(
                    1
                  )}M</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--slate-200);">
                  <td style="padding: 0.5rem 0;">Term Loan</td>
                  <td style="text-align: right; font-weight: 500;">$${termLoan.toFixed(
                    1
                  )}M</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--slate-200);">
                  <td style="padding: 0.5rem 0;">Existing Cash</td>
                  <td style="text-align: right; font-weight: 500;">$${existingCash.toFixed(
                    1
                  )}M</td>
                </tr>
                <tr style="border-bottom: 2px solid var(--slate-300); font-weight: 600; background: var(--slate-100);">
                  <td style="padding: 0.5rem 0;">Total Debt</td>
                  <td style="text-align: right;">$${totalDebt.toFixed(1)}M</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--slate-200); background: var(--green-50);">
                  <td style="padding: 0.5rem 0; font-weight: 600;">Sponsor Equity</td>
                  <td style="text-align: right; font-weight: 700; color: var(--green-700);">$${sponsorEquity.toFixed(
                    1
                  )}M</td>
                </tr>
                <tr style="border-top: 2px solid var(--slate-400); font-weight: 700;">
                  <td style="padding: 0.75rem 0;">Total Sources</td>
                  <td style="text-align: right;">$${(
                    totalDebt +
                    existingCash +
                    sponsorEquity
                  ).toFixed(1)}M</td>
                </tr>
              </table>
              <div style="margin-top: 0.75rem; padding: 0.5rem; background: var(--white); border-radius: 0.375rem; font-size: 0.75rem;">
                <strong>Leverage:</strong> ${(totalDebt / ltmEBITDA).toFixed(
                  2
                )}x Debt/EBITDA<br>
                <strong>Equity %:</strong> ${(
                  (sponsorEquity / (totalUses + minCash)) *
                  100
                ).toFixed(1)}%
              </div>
            </div>
          `;

          document.getElementById("usesTable").innerHTML = usesHTML;
          document.getElementById("sourcesTable").innerHTML = sourcesHTML;
          sourcesUsesDiv.classList.remove("hidden");

          // ==================== FINANCIAL PROJECTIONS TABLE ====================
          let projectionsHTML = `
            <thead>
              <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                <th style="padding: 0.75rem; text-align: left; font-weight: 600; position: sticky; left: 0; background: var(--slate-100);">Metric</th>
                <th style="padding: 0.75rem; text-align: right; font-weight: 600;">LTM</th>
          `;

          for (let i = 1; i <= holdPeriod; i++) {
            projectionsHTML += `<th style="padding: 0.75rem; text-align: right; font-weight: 600;">Year ${i}</th>`;
          }
          projectionsHTML += `</tr></thead><tbody>`;

          // Revenue row
          projectionsHTML += `<tr style="background: var(--blue-50); border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--blue-50);">Revenue</td>
            <td style="padding: 0.75rem; text-align: right;">$${(
              ltmEBITDA / ebitdaMargin
            ).toFixed(1)}M</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">$${y.revenue.toFixed(
              1
            )}M</td>`;
          });
          projectionsHTML += `</tr>`;

          // EBITDA row
          projectionsHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--white);">EBITDA</td>
            <td style="padding: 0.75rem; text-align: right;">$${ltmEBITDA.toFixed(
              1
            )}M</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">$${y.ebitda.toFixed(
              1
            )}M</td>`;
          });
          projectionsHTML += `</tr>`;

          // EBITDA Margin
          projectionsHTML += `<tr style="background: var(--slate-50); border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--slate-50);">EBITDA Margin</td>
            <td style="padding: 0.75rem; text-align: right;">${(
              ebitdaMargin * 100
            ).toFixed(1)}%</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">${(
              (y.ebitda / y.revenue) *
              100
            ).toFixed(1)}%</td>`;
          });
          projectionsHTML += `</tr>`;

          // D&A
          projectionsHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--white);">Less: D&A</td>
            <td style="padding: 0.75rem; text-align: right;">($${(
              (ltmEBITDA / ebitdaMargin) *
              daPercent
            ).toFixed(1)}M)</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">($${y.depreciation.toFixed(
              1
            )}M)</td>`;
          });
          projectionsHTML += `</tr>`;

          // EBIT
          projectionsHTML += `<tr style="background: var(--slate-50); border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--slate-50);">EBIT</td>
            <td style="padding: 0.75rem; text-align: right;">$${(
              ltmEBITDA -
              (ltmEBITDA / ebitdaMargin) * daPercent
            ).toFixed(1)}M</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">$${y.ebit.toFixed(
              1
            )}M</td>`;
          });
          projectionsHTML += `</tr>`;

          // Interest
          projectionsHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--white);">Less: Interest</td>
            <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">($${y.interestExpense.toFixed(
              1
            )}M)</td>`;
          });
          projectionsHTML += `</tr>`;

          // EBT
          projectionsHTML += `<tr style="background: var(--slate-50); border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--slate-50);">EBT</td>
            <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">$${y.ebt.toFixed(
              1
            )}M</td>`;
          });
          projectionsHTML += `</tr>`;

          // Taxes
          projectionsHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--white);">Less: Taxes</td>
            <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">($${y.taxes.toFixed(
              1
            )}M)</td>`;
          });
          projectionsHTML += `</tr>`;

          // Net Income
          projectionsHTML += `<tr style="background: var(--green-50); border-bottom: 2px solid var(--slate-300);">
            <td style="padding: 0.75rem; font-weight: 700; position: sticky; left: 0; background: var(--green-50);">Net Income</td>
            <td style="padding: 0.75rem; text-align: right; font-weight: 600;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right; font-weight: 600;">$${y.netIncome.toFixed(
              1
            )}M</td>`;
          });
          projectionsHTML += `</tr>`;

          // Cash Flow Section Header
          projectionsHTML += `<tr style="background: var(--blue-100);">
            <td colspan="${
              holdPeriod + 2
            }" style="padding: 0.5rem 0.75rem; font-weight: 700; color: var(--blue-900);">CASH FLOW ANALYSIS</td>
          </tr>`;

          // CapEx
          projectionsHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--white);">Less: CapEx</td>
            <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">($${y.capex.toFixed(
              1
            )}M)</td>`;
          });
          projectionsHTML += `</tr>`;

          // Change in NWC
          projectionsHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--white);">Less: Δ NWC</td>
            <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">($${y.changeInNWC.toFixed(
              1
            )}M)</td>`;
          });
          projectionsHTML += `</tr>`;

          // Unlevered FCF
          projectionsHTML += `<tr style="background: var(--cyan-50); border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--cyan-50);">Unlevered FCF</td>
            <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right; font-weight: 600;">$${y.unleveredFCF.toFixed(
              1
            )}M</td>`;
          });
          projectionsHTML += `</tr>`;

          // Debt Paydown
          projectionsHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--white);">Less: Debt Paydown</td>
            <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">($${y.totalDebtPaydown.toFixed(
              1
            )}M)</td>`;
          });
          projectionsHTML += `</tr>`;

          // Levered FCF
          projectionsHTML += `<tr style="background: var(--green-50); border-bottom: 2px solid var(--slate-300);">
            <td style="padding: 0.75rem; font-weight: 700; position: sticky; left: 0; background: var(--green-50);">Levered FCF (to Equity)</td>
            <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right; font-weight: 700;">$${y.leveredFCF.toFixed(
              1
            )}M</td>`;
          });
          projectionsHTML += `</tr>`;

          // Debt Balance Section
          projectionsHTML += `<tr style="background: var(--orange-100);">
            <td colspan="${
              holdPeriod + 2
            }" style="padding: 0.5rem 0.75rem; font-weight: 700; color: var(--orange-900);">DEBT SCHEDULE</td>
          </tr>`;

          // Beginning Debt
          projectionsHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; position: sticky; left: 0; background: var(--white);">Beginning Debt Balance</td>
            <td style="padding: 0.75rem; text-align: right;">$${totalDebt.toFixed(
              1
            )}M</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">$${y.beginningDebt.toFixed(
              1
            )}M</td>`;
          });
          projectionsHTML += `</tr>`;

          // Ending Debt
          projectionsHTML += `<tr style="background: var(--orange-50); border-bottom: 1px solid var(--slate-200);">
            <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--orange-50);">Ending Debt Balance</td>
            <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right; font-weight: 600;">$${y.endingDebt.toFixed(
              1
            )}M</td>`;
          });
          projectionsHTML += `</tr>`;

          // Leverage Ratio
          projectionsHTML += `<tr style="background: var(--slate-50);">
            <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--slate-50);">Net Debt / EBITDA</td>
            <td style="padding: 0.75rem; text-align: right;">${(
              totalDebt / ltmEBITDA
            ).toFixed(2)}x</td>`;
          years.forEach((y) => {
            projectionsHTML += `<td style="padding: 0.75rem; text-align: right;">${(
              y.endingDebt / y.ebitda
            ).toFixed(2)}x</td>`;
          });
          projectionsHTML += `</tr>`;

          projectionsHTML += `</tbody>`;

          document.getElementById("projectionsTable").innerHTML =
            projectionsHTML;
          projectionsDiv.classList.remove("hidden");

          // ==================== RETURNS WATERFALL ====================
          const totalDebtPaid = totalDebt - exitDebt;
          const debtPaydownPercent = (totalDebtPaid / totalDebt) * 100;

          const multipleExpansion = (exitMultiple - entryMultiple) * exitEBITDA;
          const ebitdaGrowthContribution = exitEV - exitMultiple * ltmEBITDA;
          const deleveragingContribution = totalDebtPaid;

          const totalValueCreation = exitEquityValue - initialEquity;

          let returnsHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
              <div style="background: var(--green-50); padding: 1.25rem; border-radius: 0.5rem; border-left: 4px solid var(--green-500);">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem;">📈 Value Creation Bridge</h4>
                <table style="width: 100%; font-size: 0.875rem;">
                  <tr style="border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.5rem 0;">Initial Equity Investment</td>
                    <td style="text-align: right; font-weight: 600;">$${initialEquity.toFixed(
                      1
                    )}M</td>
                  </tr>
                  <tr style="border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.5rem 0; color: var(--blue-700);">+ EBITDA Growth</td>
                    <td style="text-align: right; font-weight: 500;">$${ebitdaGrowthContribution.toFixed(
                      1
                    )}M</td>
                  </tr>
                  <tr style="border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.5rem 0; color: var(--green-700);">+ Deleveraging (Debt Paydown)</td>
                    <td style="text-align: right; font-weight: 500;">$${deleveragingContribution.toFixed(
                      1
                    )}M</td>
                  </tr>
                  <tr style="border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.5rem 0; color: ${
                      multipleExpansion >= 0
                        ? "var(--green-700)"
                        : "var(--red-700)"
                    };">
                      ${multipleExpansion >= 0 ? "+" : "−"} Multiple ${
            multipleExpansion >= 0 ? "Expansion" : "Compression"
          }
                    </td>
                    <td style="text-align: right; font-weight: 500;">$${Math.abs(
                      multipleExpansion
                    ).toFixed(1)}M</td>
                  </tr>
                  <tr style="border-top: 2px solid var(--green-600); background: var(--green-100);">
                    <td style="padding: 0.75rem 0; font-weight: 700;">Exit Equity Value</td>
                    <td style="text-align: right; font-weight: 700;">$${exitEquityValue.toFixed(
                      1
                    )}M</td>
                  </tr>
                </table>
              </div>

              <div style="background: var(--blue-50); padding: 1.25rem; border-radius: 0.5rem; border-left: 4px solid var(--blue-500);">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--blue-900); margin-bottom: 1rem;">💰 Exit Summary</h4>
                <table style="width: 100%; font-size: 0.875rem;">
                  <tr style="border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.5rem 0;">Exit EBITDA</td>
                    <td style="text-align: right; font-weight: 600;">$${exitEBITDA.toFixed(
                      1
                    )}M</td>
                  </tr>
                  <tr style="border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.5rem 0;">Exit Multiple</td>
                    <td style="text-align: right; font-weight: 500;">${exitMultiple.toFixed(
                      1
                    )}x</td>
                  </tr>
                  <tr style="border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.5rem 0; font-weight: 600;">Exit Enterprise Value</td>
                    <td style="text-align: right; font-weight: 600;">$${exitEV.toFixed(
                      1
                    )}M</td>
                  </tr>
                  <tr style="border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.5rem 0;">Less: Remaining Debt</td>
                    <td style="text-align: right; font-weight: 500;">($${exitDebt.toFixed(
                      1
                    )}M)</td>
                  </tr>
                  <tr style="border-top: 2px solid var(--blue-600); background: var(--blue-100);">
                    <td style="padding: 0.75rem 0; font-weight: 700;">Exit Equity Value</td>
                    <td style="text-align: right; font-weight: 700;">$${exitEquityValue.toFixed(
                      1
                    )}M</td>
                  </tr>
                </table>
                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--white); border-radius: 0.375rem; font-size: 0.75rem;">
                  <strong>Debt Paydown:</strong> $${totalDebtPaid.toFixed(
                    1
                  )}M (${debtPaydownPercent.toFixed(0)}% of initial debt)
                </div>
              </div>
            </div>

            <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50)); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--indigo-200);">
              <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem; text-align: center;">
                🎯 Returns Summary
              </h4>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="text-align: center; padding: 1rem; background: var(--white); border-radius: 0.5rem;">
                  <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem;">IRR</div>
                  <div style="font-size: 2rem; font-weight: 800; color: ${irrColor};">${(
            irr * 100
          ).toFixed(1)}%</div>
                  <div style="font-size: 0.75rem; margin-top: 0.25rem;">${irrLabel}</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: var(--white); border-radius: 0.5rem;">
                  <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem;">Money Multiple</div>
                  <div style="font-size: 2rem; font-weight: 800; color: var(--blue-600);">${moM.toFixed(
                    2
                  )}x</div>
                  <div style="font-size: 0.75rem; margin-top: 0.25rem;">
                    ${
                      moM >= 3.0
                        ? "🚀 Exceptional"
                        : moM >= 2.5
                        ? "✅ Strong"
                        : moM >= 2.0
                        ? "⚠️ Moderate"
                        : "❌ Weak"
                    }
                  </div>
                </div>
                <div style="text-align: center; padding: 1rem; background: var(--white); border-radius: 0.5rem;">
                  <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Profit</div>
                  <div style="font-size: 2rem; font-weight: 800; color: var(--green-600);">$${totalValueCreation.toFixed(
                    1
                  )}M</div>
                  <div style="font-size: 0.75rem; margin-top: 0.25rem;">+${(
                    (totalValueCreation / initialEquity) *
                    100
                  ).toFixed(0)}%</div>
                </div>
              </div>
            </div>

            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--slate-50); border-radius: 0.5rem; border-left: 3px solid var(--slate-400);">
              <h5 style="font-weight: 600; color: var(--slate-800); margin-bottom: 0.5rem;">📊 Key Metrics Analysis</h5>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; font-size: 0.875rem;">
                <div>
                  <strong>Entry Valuation:</strong> ${entryMultiple.toFixed(
                    1
                  )}x LTM EBITDA<br>
                  <strong>Exit Valuation:</strong> ${exitMultiple.toFixed(
                    1
                  )}x Exit EBITDA<br>
                  <strong>Multiple Change:</strong> ${
                    exitMultiple - entryMultiple >= 0 ? "+" : ""
                  }${(exitMultiple - entryMultiple).toFixed(1)}x
                </div>
                <div>
                  <strong>EBITDA CAGR:</strong> ${
                    (Math.pow(exitEBITDA / ltmEBITDA, 1 / holdPeriod) - 1) * 100
                  }.toFixed(1)}%<br>
                  <strong>Initial Leverage:</strong> ${(
                    totalDebt / ltmEBITDA
                  ).toFixed(2)}x<br>
                  <strong>Exit Leverage:</strong> ${(
                    exitDebt / exitEBITDA
                  ).toFixed(2)}x
                </div>
              </div>
            </div>
          `;

          document.getElementById("returnsBreakdown").innerHTML = returnsHTML;
          returnsDiv.classList.remove("hidden");
        });
      }

      // --- Initialize the app when the page loads ---
      document.addEventListener("DOMContentLoaded", initApp);
    </script>
  </body>
</html>
