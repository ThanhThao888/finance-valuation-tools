<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finance Calculators</title>
    <style>
      :root {
        /* Color Palette - Enhanced */
        --indigo-50: #eef2ff;
        --indigo-100: #e0e7ff;
        --indigo-200: #c7d2fe;
        --indigo-300: #a5b4fc;
        --indigo-400: #818cf8;
        --indigo-500: #6366f1;
        --indigo-600: #4f46e5;
        --indigo-700: #4338ca;
        --indigo-800: #3730a3;
        
        --blue-50: #eff6ff;
        --blue-100: #dbeafe;
        --blue-200: #bfdbfe;
        --blue-300: #93c5fd;
        --blue-400: #60a5fa;
        --blue-500: #3b82f6;
        --blue-600: #2563eb;
        --blue-700: #1d4ed8;
        --blue-800: #1e40af;
        
        --cyan-50: #ecfeff;
        --cyan-100: #cffafe;
        --cyan-200: #a5f3fc;
        --cyan-300: #67e8f9;
        --cyan-400: #22d3ee;
        --cyan-500: #06b6d4;
        --cyan-600: #0891b2;
        --cyan-700: #0e7490;
        
        --green-50: #f0fdf4;
        --green-100: #dcfce7;
        --green-200: #bbf7d0;
        --green-300: #86efac;
        --green-400: #4ade80;
        --green-500: #10b981;
        --green-600: #059669;
        --green-700: #047857;
        --green-800: #065f46;
        
        --emerald-50: #ecfdf5;
        --emerald-100: #d1fae5;
        --emerald-200: #a7f3d0;
        --emerald-300: #6ee7b7;
        --emerald-400: #34d399;
        --emerald-500: #059669;
        --emerald-600: #047857;
        --emerald-700: #065f46;
        
        --rose-50: #fff1f2;
        --rose-100: #ffe4e6;
        --rose-200: #fecdd3;
        --rose-300: #fda4af;
        --rose-400: #fb7185;
        --rose-500: #f43f5e;
        --rose-600: #e11d48;
        --rose-700: #be123c;
        
        --pink-50: #fdf2f8;
        --pink-100: #fce7f3;
        --pink-200: #fbcfe8;
        --pink-300: #f9a8d4;
        --pink-400: #f472b6;
        --pink-500: #ec4899;
        --pink-600: #db2777;
        --pink-700: #be185d;
        
        --orange-50: #fff7ed;
        --orange-100: #ffedd5;
        --orange-200: #fed7aa;
        --orange-300: #fdba74;
        --orange-400: #fb923c;
        --orange-500: #f97316;
        --orange-600: #ea580c;
        --orange-700: #c2410c;
        
        --red-50: #fef2f2;
        --red-100: #fee2e2;
        --red-200: #fecaca;
        --red-300: #fca5a5;
        --red-400: #f87171;
        --red-500: #ef4444;
        --red-600: #dc2626;
        --red-700: #b91c1c;
        
        --purple-50: #faf5ff;
        --purple-100: #f3e8ff;
        --purple-200: #e9d5ff;
        --purple-300: #d8b4fe;
        --purple-400: #c084fc;
        --purple-500: #a855f7;
        --purple-600: #9333ea;
        --purple-700: #7e22ce;
        
        --yellow-50: #fefce8;
        --yellow-100: #fef9c3;
        --yellow-200: #fef08a;
        --yellow-300: #fde047;
        --yellow-400: #facc15;
        --yellow-500: #eab308;
        --yellow-600: #ca8a04;
        
        --slate-50: #f8fafc;
        --slate-100: #f1f5f9;
        --slate-200: #e2e8f0;
        --slate-300: #cbd5e1;
        --slate-400: #94a3b8;
        --slate-500: #64748b;
        --slate-600: #475569;
        --slate-700: #334155;
        --slate-800: #1e293b;
        --slate-900: #0f172a;
        
        --white: #ffffff;
        --black: #000000;
        
        /* Border Radius */
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        
        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        
        /* Transitions */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      body {
        background: linear-gradient(135deg, var(--slate-50), var(--blue-50));
        min-height: 100vh;
        padding: 20px;
        color: var(--slate-700);
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Header - Enhanced */
      .header {
        background: var(--white);
        box-shadow: var(--shadow-md);
        border-bottom: 1px solid var(--slate-200);
        padding: 1rem 0;
        margin-bottom: 2rem;
        border-radius: var(--radius-lg);
        position: sticky;
        top: 20px;
        z-index: 100;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem;
        gap: 1.5rem;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--indigo-600), var(--blue-600));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.025em;
      }

      .tier-selector {
        display: flex;
        background: var(--slate-100);
        border-radius: var(--radius-md);
        padding: 0.25rem;
        border: 1px solid var(--slate-200);
      }

      .tier-btn {
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-fast);
        background: transparent;
        border: none;
        color: var(--slate-600);
        white-space: nowrap;
      }

      .tier-btn:hover {
        background: var(--slate-200);
        color: var(--slate-800);
      }

      .tier-btn.active {
        background: var(--white);
        color: var(--indigo-600);
        box-shadow: var(--shadow-sm);
        font-weight: 600;
      }

      /* Tabs - Enhanced */
      .tabs {
        display: flex;
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 0.5rem;
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        overflow-x: auto;
        scrollbar-width: none;
        border: 1px solid var(--slate-200);
      }

      .tabs::-webkit-scrollbar {
        display: none;
      }

      .tab-btn {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        transition: var(--transition-fast);
        background: transparent;
        border: none;
        color: var(--slate-600);
      }

      .tab-btn:hover {
        background: var(--slate-100);
        color: var(--slate-800);
      }

      .tab-btn.active {
        background: var(--indigo-50);
        color: var(--indigo-600);
        font-weight: 600;
      }

      /* Calculator Container - Enhanced */
      .calculator-container {
        background: var(--white);
        border-radius: var(--radius-xl);
        padding: 2rem;
        box-shadow: var(--shadow-xl);
        margin-bottom: 2rem;
        border: 1px solid var(--slate-200);
      }

      .calculator-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: var(--slate-800);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .calculator-title::before {
        content: 'üßÆ';
        font-size: 1.25rem;
      }

      /* Explanation Box - Enhanced */
      .explanation-box {
        background: var(--slate-50);
        border-left: 4px solid var(--indigo-500);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--slate-200);
      }

      .explanation-title {
        font-weight: 600;
        color: var(--slate-800);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.1rem;
      }

      .explanation-title svg {
        width: 1.25rem;
        height: 1.25rem;
        color: var(--indigo-500);
        flex-shrink: 0;
      }

      .explanation-text {
        color: var(--slate-600);
        line-height: 1.6;
        margin-bottom: 0.75rem;
      }

      .explanation-note {
        background: var(--blue-50);
        border-radius: var(--radius-sm);
        padding: 1rem;
        margin-top: 1rem;
        font-size: 0.875rem;
        border-left: 3px solid var(--blue-500);
        color: var(--blue-800);
      }

      /* Form Grid - Enhanced */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--slate-700);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .form-label::after {
        content: ':';
      }

      .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--slate-200);
        border-radius: var(--radius-md);
        font-size: 1rem;
        transition: var(--transition-fast);
        background: var(--white);
        color: var(--slate-800);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--indigo-500);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .form-input::placeholder {
        color: var(--slate-400);
      }

      .form-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--slate-200);
        border-radius: var(--radius-md);
        font-size: 1rem;
        background-color: var(--white);
        transition: var(--transition-fast);
        color: var(--slate-800);
        cursor: pointer;
      }

      .form-select:focus {
        outline: none;
        border-color: var(--indigo-500);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      /* Buttons - Enhanced */
      .btn {
        padding: 0.875rem 1.75rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: var(--transition-fast);
        border: none;
        color: var(--white);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--indigo-600), var(--blue-700));
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, var(--indigo-700), var(--blue-800));
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .btn-secondary {
        background: linear-gradient(135deg, var(--blue-500), var(--cyan-600));
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, var(--blue-600), var(--cyan-700));
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .btn-success {
        background: linear-gradient(135deg, var(--green-500), var(--emerald-600));
      }

      .btn-success:hover {
        background: linear-gradient(135deg, var(--green-600), var(--emerald-700));
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .btn-danger {
        background: linear-gradient(135deg, var(--rose-500), var(--pink-600));
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, var(--rose-600), var(--pink-700));
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .btn-warning {
        background: linear-gradient(135deg, var(--orange-500), var(--red-600));
      }

      .btn-warning:hover {
        background: linear-gradient(135deg, var(--orange-600), var(--red-700));
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      /* Results - Enhanced */
      .results-container {
        margin-top: 2rem;
        padding: 1.75rem;
        border-radius: var(--radius-lg);
        border: 1px solid var(--slate-200);
        background: var(--slate-50);
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.25rem;
      }

      .result-card {
        text-align: center;
        padding: 1.25rem;
        border-radius: var(--radius-md);
        background: var(--white);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--slate-200);
        transition: var(--transition-fast);
      }

      .result-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .result-label {
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.75rem;
        color: var(--slate-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .result-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--slate-800);
      }

      .result-error {
        font-size: 0.9rem;
        color: var(--red-600);
        font-weight: 500;
        padding: 0.5rem;
        background: var(--red-50);
        border-radius: var(--radius-sm);
        border-left: 3px solid var(--red-500);
      }

      /* Options - Enhanced */
      .options-toggle {
        display: flex;
        background: var(--slate-100);
        border-radius: var(--radius-md);
        padding: 0.25rem;
        margin-bottom: 1.5rem;
        width: fit-content;
        border: 1px solid var(--slate-200);
      }

      .option-btn {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-fast);
        background: transparent;
        border: none;
        color: var(--slate-600);
        white-space: nowrap;
      }

      .option-btn:hover {
        background: var(--slate-200);
        color: var(--slate-800);
      }

      .option-btn.active {
        background: var(--white);
        color: var(--indigo-600);
        box-shadow: var(--shadow-sm);
        font-weight: 600;
      }

      /* Hidden Class */
      .hidden {
        display: none !important;
      }

      /* Scenario Buttons - Enhanced */
      .scenario-btn {
        padding: 1.25rem;
        border-radius: var(--radius-md);
        border: 2px solid var(--slate-200);
        background: var(--white);
        cursor: pointer;
        transition: var(--transition-fast);
        font-weight: 600;
        text-align: center;
        font-size: 0.875rem;
        color: var(--slate-700);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      .scenario-btn:hover {
        border-color: var(--indigo-400);
        background: var(--indigo-50);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .scenario-btn.active {
        border-color: var(--indigo-600);
        background: linear-gradient(135deg, var(--indigo-50), var(--blue-100));
        color: var(--indigo-900);
        box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
      }

      /* Toast Notification - Enhanced */
      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: linear-gradient(135deg, var(--green-500), var(--emerald-600));
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-xl);
        font-weight: 600;
        font-size: 0.875rem;
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%) scale(0.9);
        transition: var(--transition-normal);
        pointer-events: none;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        max-width: 350px;
        border-left: 4px solid rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
      }

      .toast.show {
        opacity: 1;
        transform: translateX(0) scale(1);
      }

      .toast.error {
        background: linear-gradient(135deg, var(--red-500), var(--rose-600));
      }

      /* Clear Data Button - Enhanced */
      .clear-data-btn {
        background: linear-gradient(135deg, var(--slate-600), var(--slate-700));
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: var(--transition-normal);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        overflow: hidden;
      }

      .clear-data-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: 0.6s;
      }

      .clear-data-btn:hover {
        background: linear-gradient(135deg, var(--red-500), var(--rose-600));
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
      }

      .clear-data-btn:hover::before {
        left: 100%;
      }

      .clear-data-btn:active {
        transform: translateY(0);
      }

      /* Last Saved Indicator - Enhanced */
      .last-saved {
        font-size: 0.75rem;
        color: var(--slate-500);
        margin-left: 1.5rem;
        font-weight: 400;
        background: var(--slate-100);
        padding: 0.5rem 0.875rem;
        border-radius: 2rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition-fast);
        border: 1px solid var(--slate-200);
      }

      .last-saved::before {
        content: '‚è±Ô∏è';
        font-size: 0.7rem;
      }

      .last-saved:hover {
        background: var(--slate-200);
        color: var(--slate-700);
        border-color: var(--slate-300);
      }

      /* Responsive Design - Enhanced */
      @media (max-width: 768px) {
        body {
          padding: 12px;
        }
        
        .header {
          position: static;
          margin-bottom: 1.5rem;
        }
        
        .header-content {
          flex-direction: column;
          align-items: stretch;
          gap: 1rem;
          padding: 0 1rem;
        }
        
        .calculator-container {
          padding: 1.5rem;
        }
        
        .calculator-title {
          font-size: 1.25rem;
        }
        
        .form-grid {
          grid-template-columns: 1fr;
        }
        
        .results-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .tabs {
          margin-bottom: 1.5rem;
        }
        
        .tab-btn {
          padding: 0.5rem 1rem;
          font-size: 0.875rem;
        }
        
        .btn {
          padding: 0.75rem 1.5rem;
          font-size: 0.875rem;
        }
        
        .toast {
          bottom: 1rem;
          right: 1rem;
          left: 1rem;
          max-width: calc(100% - 2rem);
        }
        
        .clear-data-btn {
          width: 100%;
          justify-content: center;
          margin-top: 0.5rem;
        }
        
        .last-saved {
          margin-left: 0;
          margin-top: 0.5rem;
          justify-content: center;
        }
      }

      @media (max-width: 480px) {
        .results-grid {
          grid-template-columns: 1fr;
        }
        
        .scenario-btn {
          padding: 1rem;
          font-size: 0.75rem;
        }
      }

      /* Loading States */
      .loading {
        opacity: 0.7;
        pointer-events: none;
      }

      .loading::after {
        content: '';
        display: inline-block;
        width: 1em;
        height: 1em;
        border: 2px solid var(--slate-300);
        border-top-color: var(--indigo-500);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-left: 0.5rem;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Focus Styles for Accessibility */
      *:focus {
        outline: 2px solid var(--indigo-500);
        outline-offset: 2px;
      }

      /* Smooth Scrolling */
      html {
        scroll-behavior: smooth;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <div style="display: flex; align-items: center;">
            <div class="logo">Finance Calculators</div>
            <span class="last-saved" id="lastSaved"></span>
          </div>
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="tier-selector">
              <button class="tier-btn active" data-tier="basic">Basic</button>
              <button class="tier-btn" data-tier="intermediate">Intermediate</button>
              <button class="tier-btn" data-tier="advanced">Advanced</button>
            </div>
            <button class="clear-data-btn" id="clearDataBtn">
              üóëÔ∏è Clear All Data
            </button>
          </div>
        </div>
      </div>


      <!-- Tabs -->
      <div class="tabs" id="tabsContainer">
        <!-- Tabs will be populated by JavaScript -->
      </div>

      <!-- Calculator Container -->
      <div class="calculator-container">
        <div id="calculatorContent">
          <!-- Calculator content will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // --- Data Structure ---
      const calculators = {
        basic: [
          {
            id: "pv-fv",
            name: "PV/FV Calculator",
            component: "PVFVCalculator",
          },
          {
            id: "compound-interest",
            name: "Compound Interest",
            component: "CompoundInterestCalculator",
          },
          {
            id: "loan-payment",
            name: "Loan Payment",
            component: "LoanPaymentCalculator",
          },
        ],
        intermediate: [
          {
            id: "capm",
            name: "CAPM",
            component: "CAPMCalculator",
          },
          {
            id: "xnpv-xirr",  
            name: "XNPV & XIRR",
            component: "XNPVXIRRCalculator",
          },
          {
            id: "npv-irr",
            name: "NPV & IRR (Academic)",  
            component: "NPVIRRCalculator",
          },
          {
            id: "ccpo",
            name: "Credit Card Optimizer",
            component: "CCPOCalculator",
          },
          {
            id: "bond-pricing",
            name: "Bond Pricing",
            component: "BondPricingCalculator",
          },
          {
            id: "time-money",
            name: "Time vs Money Trade-Off",
            component: "TimeMoneyCalculator",
          },
        ],
        advanced: [
          {
            id: "black-scholes",
            name: "Black-Scholes",
            component: "BlackScholesCalculator",
          },
          {
            id: "wacc",
            name: "WACC",
            component: "WACCCalculator",
          },
          {
            id: "dcf",
            name: "DCF Valuation",
            component: "DCFCalculator",
          },
          {
            id: "lbo",
            name: "LBO Model",
            component: "LBOCalculator",
          },
        ],
      };


      // --- Storage Manager ---
      const StorageManager = {
        STORAGE_KEY: 'financeCalculatorState',
        AUTO_SAVE_DELAY: 2000, // 2 seconds
        saveTimeouts: {},

        // Save state to localStorage
        saveState(state) {
          try {
            const timestamp = new Date().toISOString();
            const savedState = {
              ...state,
              timestamp,
              version: '1.0'
            };
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(savedState));
            this.updateLastSavedDisplay(timestamp);
            this.showToast('üíæ Saved!');
            return true;
          } catch (error) {
            console.error('Failed to save state:', error);
            this.showToast('‚ö†Ô∏è Save failed', 'error');
            return false;
          }
        },

        // Load state from localStorage
        loadState() {
          try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (!saved) return null;
            
            const state = JSON.parse(saved);
            if (state.timestamp) {
              this.updateLastSavedDisplay(state.timestamp);
            }
            return state;
          } catch (error) {
            console.error('Failed to load state:', error);
            return null;
          }
        },

        // Clear all saved data
        clearState() {
          try {
            localStorage.removeItem(this.STORAGE_KEY);
            this.showToast('üóëÔ∏è All data cleared', 'success');
            return true;
          } catch (error) {
            console.error('Failed to clear state:', error);
            return false;
          }
        },

        // Auto-save with debounce
        autoSave(key, data) {
          clearTimeout(this.saveTimeouts[key]);
          this.saveTimeouts[key] = setTimeout(() => {
            const currentState = this.loadState() || {};
            currentState[key] = data;
            this.saveState(currentState);
          }, this.AUTO_SAVE_DELAY);
        },

        // Show toast notification
        showToast(message, type = 'success') {
          const toast = document.getElementById('saveToast');
          const toastMessage = document.getElementById('toastMessage');
          
          if (!toast || !toastMessage) return;
          
          toastMessage.textContent = message;
          
          // Update colors based on type
          if (type === 'error') {
            toast.style.background = 'linear-gradient(135deg, var(--red-500), var(--rose-600))';
          } else {
            toast.style.background = 'linear-gradient(135deg, var(--green-500), var(--emerald-600))';
          }
          
          toast.classList.add('show');
          
          setTimeout(() => {
            toast.classList.remove('show');
          }, 1500);
        },

        // Update last saved display
        updateLastSavedDisplay(timestamp) {
          const lastSavedEl = document.getElementById('lastSaved');
          if (!lastSavedEl) return;
          
          const date = new Date(timestamp);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          
          let timeText;
          if (diffMins < 1) {
            timeText = 'just now';
          } else if (diffMins < 60) {
            timeText = `${diffMins} min ago`;
          } else {
            const diffHours = Math.floor(diffMins / 60);
            timeText = `${diffHours}h ago`;
          }
          
          lastSavedEl.textContent = `Last saved: ${timeText}`;
        },

        // Get all form inputs from a container
        getFormInputs(container) {
          const inputs = {};
          
          // Get all input fields
          container.querySelectorAll('input[type="number"], input[type="text"], input[type="range"]').forEach(input => {
            if (input.id) {
              inputs[input.id] = input.value;
            }
          });
          
          // Get all select fields
          container.querySelectorAll('select').forEach(select => {
            if (select.id) {
              inputs[select.id] = select.value;
            }
          });
          
          // Get all checkboxes
          container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.id) {
              inputs[checkbox.id] = checkbox.checked;
            }
          });
          
          return inputs;
        },

        // Set form inputs from saved data
        setFormInputs(container, inputs) {
          if (!inputs) return;
          
          Object.entries(inputs).forEach(([id, value]) => {
            const element = container.querySelector(`#${id}`);
            if (!element) return;
            
            if (element.type === 'checkbox') {
              element.checked = value;
            } else {
              element.value = value;
            }
            
            // Trigger change event for any dependent logic
            element.dispatchEvent(new Event('change', { bubbles: true }));
          });
        },

        // Save current calculator state
        saveCalculatorState(calculatorId) {
          const container = document.getElementById('calculatorContent');
          if (!container) return;
          
          const inputs = this.getFormInputs(container);
          const resultsDiv = container.querySelector('[id$="Results"]');
          const hasResults = resultsDiv && !resultsDiv.classList.contains('hidden');
          
          const state = this.loadState() || {};
          state.activeTier = activeTier;
          state.activeTab = activeTab;
          state.calculators = state.calculators || {};
          state.calculators[calculatorId] = {
            inputs,
            hasResults,
            resultsHTML: hasResults ? resultsDiv.innerHTML : null
          };
          
          this.saveState(state);
        },

        // Restore calculator state
        restoreCalculatorState(calculatorId) {
          const state = this.loadState();
          if (!state || !state.calculators || !state.calculators[calculatorId]) {
            return false;
          }
          
          const calculatorState = state.calculators[calculatorId];
          const container = document.getElementById('calculatorContent');
          if (!container) return false;
          
          // Wait for DOM to be ready
          setTimeout(() => {
            // Restore inputs
            this.setFormInputs(container, calculatorState.inputs);
            
            // Restore results if they existed
            if (calculatorState.hasResults && calculatorState.resultsHTML) {
              const resultsDiv = container.querySelector('[id$="Results"]');
              if (resultsDiv) {
                resultsDiv.innerHTML = calculatorState.resultsHTML;
                resultsDiv.classList.remove('hidden');
              }
            }
          }, 100);
          
          return true;
        }
      };



      // ==================== FINANCIAL PRECISION UTILITIES ====================
      // Global formatters for performance (created once, reused)
      const CURRENCY_FORMATTERS = new Map();
      const PERCENT_FORMATTERS = new Map();
      const NUMBER_FORMATTERS = new Map();

      /**
       * Get or create currency formatter with specified decimals
       */
      function getCurrencyFormatter(decimals = 2) {
        const key = `currency-${decimals}`;
        if (!CURRENCY_FORMATTERS.has(key)) {
          CURRENCY_FORMATTERS.set(key, new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
            useGrouping: true // Adds commas: 1,000.00
          }));
        }
        return CURRENCY_FORMATTERS.get(key);
      }

      /**
       * Get or create percentage formatter with specified decimals
       */
      function getPercentFormatter(decimals = 2) {
        const key = `percent-${decimals}`;
        if (!PERCENT_FORMATTERS.has(key)) {
          PERCENT_FORMATTERS.set(key, new Intl.NumberFormat('en-US', {
            style: 'percent',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
            signDisplay: 'auto' // Shows + for positive, - for negative
          }));
        }
        return PERCENT_FORMATTERS.get(key);
      }

      /**
       * Get or create number formatter with specified decimals
       */
      function getNumberFormatter(decimals = 2) {
        const key = `number-${decimals}`;
        if (!NUMBER_FORMATTERS.has(key)) {
          NUMBER_FORMATTERS.set(key, new Intl.NumberFormat('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
            useGrouping: true // Adds commas
          }));
        }
        return NUMBER_FORMATTERS.get(key);
      }

      /**
       * Round to financial precision (banker's rounding - round half to even)
       */
      function roundFinancial(value, decimals = 2) {
        if (typeof value !== 'number' || isNaN(value)) return value;
        
        // Handle extremely small numbers
        if (Math.abs(value) < 1e-15) return 0;
        
        const factor = Math.pow(10, decimals);
        // Banker's rounding implementation
        const rounded = Math.round((value + Number.EPSILON) * factor) / factor;
        
        // Handle -0.00 case
        return Math.abs(rounded) < Math.pow(10, -decimals - 1) ? 0 : rounded;
      }

      /**
       * Compare two financial numbers with tolerance
       * Returns true if difference is within epsilon
       */
      function financialEquals(a, b, tolerance = 1e-8) {
        if (typeof a !== 'number' || typeof b !== 'number' || isNaN(a) || isNaN(b)) {
          return false;
        }
        return Math.abs(a - b) < tolerance;
      }

      /**
       * Format currency with proper rounding and Intl.NumberFormat
       * Returns formatted string with commas: $1,234,567.89
       */
      function formatCurrency(amount, decimals = 2) {
        if (typeof amount !== 'number' || isNaN(amount)) {
          return `$${0.00.toFixed(decimals)}`;
        }
        
        const rounded = roundFinancial(amount, decimals);
        const formatter = getCurrencyFormatter(decimals);
        return formatter.format(rounded);
      }

      /**
       * Format large financial values with automatic unit scaling
       * Professional finance display: $1.23B, $456.7M, $89.0K, $1,234.56
       */
      function formatLargeFinancial(value, decimals = 2) {
        if (typeof value !== 'number' || isNaN(value)) {
          return formatCurrency(0, decimals);
        }
        
        const absValue = Math.abs(value);
        let scaledValue, suffix;
        
        if (absValue >= 1e12) { // Trillion
          scaledValue = value / 1e12;
          suffix = 'T';
          decimals = Math.max(decimals, 3); // More decimals for larger numbers
        } else if (absValue >= 1e9) { // Billion
          scaledValue = value / 1e9;
          suffix = 'B';
          decimals = Math.max(decimals, 3);
        } else if (absValue >= 1e6) { // Million
          scaledValue = value / 1e6;
          suffix = 'M';
          decimals = Math.max(decimals, 2);
        } else if (absValue >= 1e3) { // Thousand
          scaledValue = value / 1e3;
          suffix = 'K';
          decimals = Math.max(decimals, 1);
        } else {
          // For values < 1000, use regular currency format with commas
          return formatCurrency(value, decimals);
        }
        
        const rounded = roundFinancial(scaledValue, decimals);
        const formatter = getNumberFormatter(decimals);
        const sign = value < 0 ? '-' : '';
        
        return `${sign}$${formatter.format(Math.abs(rounded))}${suffix}`;
      }

      /**
       * Format percentage with proper rounding and Intl.NumberFormat
       * Returns formatted string: 12.34% or -5.67%
       */
      function formatPercent(value, decimals = 2) {
        if (typeof value !== 'number' || isNaN(value)) {
          return '0.00%';
        }
        
        const percentValue = roundFinancial(value * 100, decimals);
        const formatter = getPercentFormatter(decimals);
        return formatter.format(percentValue / 100); // Intl expects decimal for percent
      }

      /**
       * Format number with commas and specified decimals
       * Returns formatted string: 1,234,567.89
       */
      function formatNumber(value, decimals = 2) {
        if (typeof value !== 'number' || isNaN(value)) {
          return '0.00';
        }
        
        const rounded = roundFinancial(value, decimals);
        const formatter = getNumberFormatter(decimals);
        return formatter.format(rounded);
      }

      /**
       * Format number as integer with commas
       * Returns formatted string: 1,234,567
       */
      function formatInteger(value) {
        if (typeof value !== 'number' || isNaN(value)) {
          return '0';
        }
        
        const rounded = Math.round(value);
        const formatter = getNumberFormatter(0);
        return formatter.format(rounded);
      }

      /**
       * Safe financial addition (prevents floating point accumulation)
       * Maintains mathematical precision
       */
      function safeAdd(a, b) {
        if (typeof a !== 'number' || typeof b !== 'number' || isNaN(a) || isNaN(b)) {
          return 0;
        }
        return roundFinancial(a + b, 10);
      }

      /**
       * Safe financial multiplication
       */
      function safeMultiply(a, b) {
        if (typeof a !== 'number' || typeof b !== 'number' || isNaN(a) || isNaN(b)) {
          return 0;
        }
        return roundFinancial(a * b, 10);
      }

      /**
       * Safe financial division (prevents division by zero)
       */
      function safeDivide(a, b, decimals = 10) {
        if (typeof a !== 'number' || typeof b !== 'number' || isNaN(a) || isNaN(b)) {
          return 0;
        }
        
        if (Math.abs(b) < 1e-12) return 0;
        return roundFinancial(a / b, decimals);
      }

      /**
       * Calculate remaining debt with precision (for amortization schedules)
       */
      function calculateRemainingDebt(principal, payment, interestRate, periodsPaid, totalPeriods) {
        // Input validation
        if ([principal, payment, interestRate, periodsPaid, totalPeriods].some(
          v => typeof v !== 'number' || isNaN(v) || v < 0
        )) {
          return 0;
        }
        
        const periodicRate = interestRate / 12; // Monthly rate
        
        if (periodicRate === 0 || Math.abs(periodicRate) < 1e-12) {
          // Simple case: no interest
          return Math.max(0, roundFinancial(principal - (payment * periodsPaid), 2));
        }
        
        // Exact remaining balance formula
        const numerator = Math.pow(1 + periodicRate, totalPeriods) - Math.pow(1 + periodicRate, periodsPaid);
        const denominator = Math.pow(1 + periodicRate, totalPeriods) - 1;
        
        const remaining = principal * (numerator / denominator);
        return Math.max(0, roundFinancial(remaining, 2));
      }

      /**
       * Parse formatted currency/number string back to number
       * Handles commas, dollar signs, etc.
       */
      function parseFinancialString(str) {
        if (typeof str !== 'string') return 0;
        
        // Remove currency symbols, commas, and trim
        const cleaned = str.replace(/[$,%\s]/g, '').trim();
        
        // Handle K/M/B/T suffixes
        const suffixMatch = cleaned.match(/([+-]?\d*\.?\d+)([KMBT]?)$/i);
        if (!suffixMatch) return parseFloat(cleaned) || 0;
        
        const [, numStr, suffix] = suffixMatch;
        let num = parseFloat(numStr);
        
        if (isNaN(num)) return 0;
        
        // Apply suffix multiplier
        switch (suffix.toUpperCase()) {
          case 'K': num *= 1e3; break;
          case 'M': num *= 1e6; break;
          case 'B': num *= 1e9; break;
          case 'T': num *= 1e12; break;
        }
        
        return num;
      }

      /**
       * Format with custom prefix/suffix (for flexible display)
       */
      function formatCustom(value, options = {}) {
        const {
          decimals = 2,
          prefix = '',
          suffix = '',
          signDisplay = 'auto', // 'auto', 'always', 'never', 'exceptZero'
          useGrouping = true,
          unit = ''
        } = options;
        if (typeof value !== 'number' || isNaN(value)) {
          value = 0;
        }
        const rounded = roundFinancial(value, decimals);
        const formatter = new Intl.NumberFormat('en-US', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
          useGrouping: useGrouping,
          signDisplay: signDisplay
        });
        const formatted = formatter.format(rounded);
        return `${prefix}${formatted}${unit ? ` ${unit}` : ''}${suffix}`;
      }
      // ==================== END ENHANCED FINANCIAL PRECISION UTILITIES ====================




      // --- State Management ---
      let activeTier = "basic";
      let activeTab = "pv-fv";

      // --- DOM Elements ---
      const tabsContainer = document.getElementById("tabsContainer");
      const calculatorContent = document.getElementById("calculatorContent");
      const tierButtons = document.querySelectorAll(".tier-btn");


      // Utility: Setup auto-save for a calculator
      function setupCalculatorAutoSave(calculatorId, calculateBtnId, resultsDivId) {
        const calculateBtn = document.getElementById(calculateBtnId);
        if (!calculateBtn) return;
        
        const originalHandler = calculateBtn.onclick;
        
        calculateBtn.onclick = function() {
          // Call original handler
          if (originalHandler) originalHandler.call(this);
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState(calculatorId);
          }, 100);
        };
      }

      // --- Initialize App ---
      function initApp() {
        // Try to restore previous state
        const savedState = StorageManager.loadState();
        
        if (savedState) {
          // Restore tier and tab
          if (savedState.activeTier) {
            activeTier = savedState.activeTier;
            // Update tier button states
            tierButtons.forEach(btn => {
              btn.classList.toggle('active', btn.dataset.tier === activeTier);
            });
          }
          
          if (savedState.activeTab) {
            activeTab = savedState.activeTab;
          }
        }
        
        renderTabs();
        renderCalculator();
        setupEventListeners();
        
        // Restore calculator state after a short delay
        if (savedState && savedState.activeTab) {
          setTimeout(() => {
            StorageManager.restoreCalculatorState(activeTab);
          }, 200);
        }

        // Update "last saved" display every minute
        setInterval(() => {
          const state = StorageManager.loadState();
          if (state && state.timestamp) {
            StorageManager.updateLastSavedDisplay(state.timestamp);
          }
        }, 60000); // Every 1 minute
        
        // Update immediately on load
        setTimeout(() => {
          const state = StorageManager.loadState();
          if (state && state.timestamp) {
            StorageManager.updateLastSavedDisplay(state.timestamp);
          }
        }, 500);
      }
      // --- Initialize the app when the page loads ---
      document.addEventListener("DOMContentLoaded", initApp);     

      // --- Event Listeners ---
      function setupEventListeners() {
        // Tier selection
        tierButtons.forEach((button) => {
          button.addEventListener("click", () => {
            // Save current calculator state before switching
            const currentState = StorageManager.loadState();
            if (currentState && currentState.activeTab) {
              StorageManager.saveCalculatorState(currentState.activeTab);
            }
            
            // Switch to new tier
            tierButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");
            activeTier = button.dataset.tier;

            // Switch to first calculator of new tier
            const firstCalculator = calculators[activeTier][0];
            if (firstCalculator) {
              activeTab = firstCalculator.id;
            }

            renderTabs();
            renderCalculator();
            
            // Save new state
            const state = StorageManager.loadState() || {};
            state.activeTier = activeTier;
            state.activeTab = activeTab;
            StorageManager.saveState(state);
          });
        });

        // Clear data button
        const clearDataBtn = document.getElementById('clearDataBtn');
        if (clearDataBtn) {
          clearDataBtn.addEventListener('click', () => {
            const confirmed = confirm(
              '‚ö†Ô∏è Are you sure you want to clear all saved data?\n\n' +
              'This will delete:\n' +
              '‚Ä¢ All saved calculator inputs\n' +
              '‚Ä¢ All saved results\n' +
              '‚Ä¢ Your last session state\n\n' +
              'This action cannot be undone!'
            );
            
            if (confirmed) {
              StorageManager.clearState();
              // Refresh page to reset everything
              setTimeout(() => {
                location.reload();
              }, 500);
            }
          });
        }
        
        // Auto-save when switching tabs (delegated)
        tabsContainer.addEventListener('click', (e) => {
          if (e.target.classList.contains('tab-btn')) {
            // Save current calculator state before switching
            const currentState = StorageManager.loadState();
            if (currentState && currentState.activeTab) {
              StorageManager.saveCalculatorState(currentState.activeTab);
            }
            
            // Get the new tab ID
            const tabId = Array.from(tabsContainer.children).indexOf(e.target);
            if (tabId >= 0) {
              const tierCalculators = calculators[activeTier];
              if (tierCalculators[tabId]) {
                activeTab = tierCalculators[tabId].id;
                
                // Save new state
                const state = StorageManager.loadState() || {};
                state.activeTab = activeTab;
                StorageManager.saveState(state);
              }
            }
          }
        });
      }
      
      // --- Render Tabs ---
      function renderTabs() {
        tabsContainer.innerHTML = "";
        const tierCalculators = calculators[activeTier];

        tierCalculators.forEach((calc) => {
          const tabButton = document.createElement("button");
          tabButton.className = `tab-btn ${
            calc.id === activeTab ? "active" : ""
          }`;
          tabButton.textContent = calc.name;
          tabButton.onclick = () => {
            activeTab = calc.id;
            renderTabs();
            renderCalculator();
          };
          tabsContainer.appendChild(tabButton);
        });
      }

      // --- Render Calculator ---
      function renderCalculator() {
        const calculator = calculators[activeTier].find(
          (c) => c.id === activeTab
        );
        if (!calculator) return;

        switch (calculator.component) {
          case "PVFVCalculator":
            calculatorContent.innerHTML = renderPVFVCalculator();
            setupPVFVCalculator();
            break;
          case "CompoundInterestCalculator":
            calculatorContent.innerHTML = renderCompoundInterestCalculator();
            setupCompoundInterestCalculator();
            break;
          case "LoanPaymentCalculator":
            calculatorContent.innerHTML = renderLoanPaymentCalculator();
            setupLoanPaymentCalculator();
            break;
          case "CAPMCalculator":
            calculatorContent.innerHTML = renderCAPMCalculator();
            setupCAPMCalculator();
            break;
          case "CCPOCalculator":
            calculatorContent.innerHTML = renderCCPOCalculator();
            setupCCPOCalculator();
            break;
          case "TimeMoneyCalculator":
            calculatorContent.innerHTML = renderTimeMoneyCalculator();
            setupTimeMoneyCalculator();
            break;
          case "BondPricingCalculator":
            calculatorContent.innerHTML = renderBondPricingCalculator();
            setupBondPricingCalculator();
            break;
          case "NPVIRRCalculator":
            calculatorContent.innerHTML = renderNPVIRRCalculator();
            setupNPVIRRCalculator();
            break;
          case "XNPVXIRRCalculator":
            calculatorContent.innerHTML = renderXNPVXIRRCalculator();
            setupXNPVXIRRCalculator();
            break;
          case "BlackScholesCalculator":
            calculatorContent.innerHTML = renderBlackScholesCalculator();
            setupBlackScholesCalculator();
            break;
          case "WACCCalculator":
            calculatorContent.innerHTML = renderWACCCalculator();
            setupWACCCalculator();
            break;
          case "DCFCalculator":
            calculatorContent.innerHTML = renderDCFCalculator();
            setupDCFCalculator();
            break;
          case "LBOCalculator":
            calculatorContent.innerHTML = renderLBOCalculator();
            setupLBOCalculator();
            break;
          default:
            calculatorContent.innerHTML = "<p>Calculator not found</p>";
        }
        
        // Setup auto-save for all inputs
        setTimeout(() => {
          const container = document.getElementById('calculatorContent');
          if (!container) return;
          
          // Auto-save on input change
          container.addEventListener('input', (e) => {
            if (e.target.matches('input, select')) {
              StorageManager.saveCalculatorState(activeTab);
            }
          });
          
          // Auto-save on button click (for calculate buttons)
          container.addEventListener('click', (e) => {
            if (e.target.matches('.btn, button')) {
              // Save after calculation (delay to allow results to render)
              setTimeout(() => {
                StorageManager.saveCalculatorState(activeTab);
              }, 300);
            }
          });
        }, 100);
      }      


      // ==================== BASIC CALCULATORS ====================

      // --- PV/FV Calculator ---
      function renderPVFVCalculator() {
        return `
          <h2 class="calculator-title">Present Value / Future Value Calculator</h2>
          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Understanding Time Value of Money
            </div>
            <p class="explanation-text">
              <strong>Present Value (PV)</strong>: How much a future sum is worth today.<br>
              <strong>Future Value (FV)</strong>: How much money today will grow to in the future.
            </p>
            <div class="explanation-note">
              <strong>Financial Insight:</strong> $100 today is worth more than $100 tomorrow because you can invest it today.
            </div>
          </div>

          <div class="options-toggle">
            <button class="option-btn active" id="pvOption">Calculate PV</button>
            <button class="option-btn" id="fvOption">Calculate FV</button>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" id="amountLabel">Future Value ($)</label>
              <input type="number" id="futureValue" class="form-input" placeholder="10000">
            </div>
            <div class="form-group">
              <label class="form-label">Annual Interest Rate (%)</label>
              <input type="number" id="interestRate" class="form-input" placeholder="5" step="0.01">
            </div>
            <div class="form-group">
              <label class="form-label">Number of Periods (Years)</label>
              <input type="number" id="periods" class="form-input" placeholder="10">
            </div>
          </div>

          <button class="btn btn-primary" id="calculatePVFV">Calculate</button>

          <div id="pvfvResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
            <!-- Results will be populated here -->
          </div>
        `;
      }

      function setupPVFVCalculator() {
        const pvOption = document.getElementById("pvOption");
        const fvOption = document.getElementById("fvOption");
        const amountInput = document.getElementById("futureValue");
        const amountLabel = document.getElementById("amountLabel");
        const interestRateInput = document.getElementById("interestRate");
        const periodsInput = document.getElementById("periods");
        const calculateBtn = document.getElementById("calculatePVFV");
        const resultsDiv = document.getElementById("pvfvResults");

        let isPVCalculation = true;

        // ========== UX IMPROVEMENT: Clear input when switching mode ==========
        pvOption.addEventListener("click", () => {
          pvOption.classList.add("active");
          fvOption.classList.remove("active");
          isPVCalculation = true;
          
          amountLabel.textContent = "Future Value ($)";
          amountInput.placeholder = "10000";
          amountInput.value = "";
          resultsDiv.classList.add("hidden");
        });

        fvOption.addEventListener("click", () => {
          fvOption.classList.add("active");
          pvOption.classList.remove("active");
          isPVCalculation = false;
          
          amountLabel.textContent = "Present Value ($)";
          amountInput.placeholder = "5000";
          amountInput.value = "";
          resultsDiv.classList.add("hidden");
        });

        calculateBtn.addEventListener("click", () => {
          const r = parseFloat(interestRateInput.value) / 100;
          const n = parseFloat(periodsInput.value);
          const amount = parseFloat(amountInput.value);

          // ========== ROBUST VALIDATION ==========
          if (isNaN(r) || r < 0 || r > 100) {
            alert("Please enter a valid interest rate (0% - 100%).");
            return;
          }
          if (isNaN(n) || n < 0 || n > 1000) {
            alert("Please enter a valid number of periods (0 - 1000).");
            return;
          }
          if (isNaN(amount) || amount <= 0) {
            alert("Please enter a valid amount (greater than 0).");
            return;
          }

          let pv, fv;
          const growthMultiplier = Math.pow(1 + r, n);

          if (isPVCalculation) {
            fv = amount;
            pv = fv / growthMultiplier;
          } else {
            pv = amount;
            fv = pv * growthMultiplier;
          }

          // ========== CONSISTENT ROUNDING (like Loan Calculator) ==========
          pv = roundFinancial(pv, 2);
          fv = roundFinancial(fv, 2);
          const multiplierDisplay = roundFinancial(growthMultiplier, 4);

          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: ${isPVCalculation ? 'var(--indigo-100)' : 'var(--slate-100)'};">
                <div class="result-label">Present Value (PV)</div>
                <div class="result-value">${formatCurrency(pv)}</div>
                <div class="result-subtext">Value in today's dollars</div>
              </div>
              <div class="result-card" style="background-color: ${!isPVCalculation ? 'var(--indigo-100)' : 'var(--slate-100)'};">
                <div class="result-label">Future Value (FV)</div>
                <div class="result-value">${formatCurrency(fv)}</div>
                <div class="result-subtext">Value after ${n} periods</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Interest Rate</div>
                <div class="result-value">${formatPercent(r)}</div>
                <div class="result-subtext">Annual rate</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Growth Factor</div>
                <div class="result-value">${multiplierDisplay}x</div>
                <div class="result-subtext">${n} periods compounded</div>
              </div>
            </div>
            
            <!-- Financial Insight Section -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--indigo-50); border-radius: 0.375rem; border-left: 4px solid var(--indigo-400);">
              <div style="font-size: 0.875rem; color: var(--indigo-800);">
                <strong>üí∞ Time Value of Money Insight:</strong><br>
                ${isPVCalculation ? 
                  `To have ${formatCurrency(fv)} in ${n} years, you need to invest ${formatCurrency(pv)} today at ${formatPercent(r)} annual interest.` : 
                  `Investing ${formatCurrency(pv)} today at ${formatPercent(r)} interest will grow to ${formatCurrency(fv)} in ${n} years.`
                }
              </div>
            </div>
          `;

          resultsDiv.classList.remove("hidden");
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('pv-fv');
          }, 100);
        });
      }



      // --- Compound Interest Calculator ---
      function renderCompoundInterestCalculator() {
        return `
          <h2 class="calculator-title">Compound Interest Calculator</h2>
          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              The Power of Compounding
            </div>
            <p class="explanation-text">
              <strong>Compound interest</strong> is interest calculated on the initial principal and also on the accumulated interest of previous periods.
              It's often referred to as "interest on interest" and can cause wealth to grow exponentially over time.
            </p>
            <p class="explanation-text">
              The more frequently interest is compounded, the greater the return. This calculator helps you understand how different compounding frequencies affect your investment growth.
            </p>
            <div class="explanation-note">
              <strong>Financial Insight:</strong> Starting early and allowing your investments to compound over long periods is one of the most powerful wealth-building strategies.
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Principal Amount ($)</label>
              <input type="number" id="principal" class="form-input" placeholder="10000">
            </div>
            <div class="form-group">
              <label class="form-label">Annual Interest Rate (%)</label>
              <input type="number" id="annualRate" class="form-input" placeholder="5" step="0.01">
            </div>
            <div class="form-group">
              <label class="form-label">Time Period (Years)</label>
              <input type="number" id="years" class="form-input" placeholder="10">
            </div>
            <div class="form-group">
              <label class="form-label">Compounding Frequency</label>
              <select id="compounding" class="form-select">
                <option value="1">Annually (1x/year)</option>
                <option value="2">Semi-annually (2x/year)</option>
                <option value="4">Quarterly (4x/year)</option>
                <option value="12" selected>Monthly (12x/year)</option>
                <option value="365">Daily (365x/year)</option>
              </select>
            </div>
          </div>

          <button class="btn btn-success" id="calculateCI">Calculate Compound Interest</button>

          <div id="ciResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50);">
            <!-- Results will be populated here -->
          </div>
        `;
      }

      function setupCompoundInterestCalculator() {
        const calculateBtn = document.getElementById("calculateCI");
        const resultsDiv = document.getElementById("ciResults");

        calculateBtn.addEventListener("click", () => {
          const principal = parseFloat(document.getElementById("principal").value);
          const annualRatePercent = parseFloat(document.getElementById("annualRate").value);
          const years = parseFloat(document.getElementById("years").value);
          const compounding = parseFloat(document.getElementById("compounding").value);

          // ========== ROBUST VALIDATION ==========
          if (isNaN(principal) || principal <= 0) {
            alert("Please enter a valid principal amount (greater than 0).");
            return;
          }
          if (isNaN(annualRatePercent) || annualRatePercent < 0) {
            alert("Please enter a valid interest rate (0% or greater).");
            return;
          }
          if (isNaN(years) || years <= 0 || years > 100) {
            alert("Please enter a valid time period (1-100 years).");
            return;
          }
          if (isNaN(compounding) || compounding <= 0) {
            alert("Please select a valid compounding frequency.");
            return;
          }

          const annualRate = annualRatePercent / 100;
          const totalN = compounding * years;
          const ratePerPeriod = annualRate / compounding;
          
          // Core calculation: A = P * (1 + r/n)^(nt)
          let finalAmount = principal * Math.pow(1 + ratePerPeriod, totalN);
          
          // ========== CONSISTENT ROUNDING (like Loan Calculator) ==========
          finalAmount = roundFinancial(finalAmount, 2);
          const interestEarned = roundFinancial(finalAmount - principal, 2);
          
          // Calculate APY (Effective Annual Yield)
          const apy = Math.pow(1 + ratePerPeriod, compounding) - 1;
          
          // Get compounding frequency display name
          const compFrequency = document.getElementById("compounding");
          const frequencyName = compFrequency.options[compFrequency.selectedIndex].text;

          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: var(--green-100);">
                <div class="result-label">Future Value</div>
                <div class="result-value">${formatCurrency(finalAmount)}</div>
                <div class="result-subtext">After ${years} years</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Principal</div>
                <div class="result-value">${formatCurrency(principal)}</div>
                <div class="result-subtext">Initial investment</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Interest Earned</div>
                <div class="result-value">${formatCurrency(interestEarned)}</div>
                <div class="result-subtext">${formatPercent(interestEarned/principal)} return</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Effective Annual Yield</div>
                <div class="result-value">${formatPercent(apy, 4)}</div>
                <div class="result-subtext">vs ${formatPercent(annualRate)} nominal rate</div>
              </div>
            </div>
            
            <!-- Additional Metrics -->
            <div style="margin-top: 1.5rem;">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
                <div style="padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Compounding</div>
                  <div style="font-weight: 600; color: var(--slate-800);">${frequencyName}</div>
                </div>
                <div style="padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Total Periods</div>
                  <div style="font-weight: 600; color: var(--slate-800);">${formatInteger(totalN)}</div>
                </div>
                <div style="padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Rate per Period</div>
                  <div style="font-weight: 600; color: var(--slate-800);">${formatPercent(ratePerPeriod, 4)}</div>
                </div>
              </div>
            </div>
            
            <!-- Consistency Verification -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50); border-radius: 0.375rem; border-left: 4px solid var(--green-400);">
              <div style="font-size: 0.875rem; color: var(--green-800);">
                <strong>‚úÖ Verified Calculation:</strong><br>
                ${formatCurrency(principal)} + ${formatCurrency(interestEarned)} = ${formatCurrency(finalAmount)}
              </div>
            </div>
            
            <!-- Financial Insight -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem;">
              <div style="font-size: 0.75rem; color: var(--slate-700);">
                <strong>üí° Why APY Matters:</strong> 
                Your ${formatPercent(annualRate)} nominal rate compounds ${compounding} times per year, 
                resulting in an effective annual yield of ${formatPercent(apy, 4)}. 
                ${apy > annualRate ? 'Compounding increases your actual return!' : ''}
              </div>
            </div>
          `;

          resultsDiv.classList.remove("hidden");
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('compound-interest');
          }, 100);
        });
      }



      // --- Loan Payment Calculator ---
      function renderLoanPaymentCalculator() {
        return `
                      <h2 class="calculator-title">Loan Payment Calculator</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Understanding Loan Amortization
                          </div>
                          <p class="explanation-text">
                              This calculator helps you determine your monthly loan payment and understand how much interest you'll pay over the life of the loan.
                              It uses the standard amortization formula for fixed-rate loans.
                          </p>
                          <p class="explanation-text">
                              In the early years of a loan, a larger portion of each payment goes toward interest rather than principal.
                              As the loan matures, this ratio gradually reverses.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> Even a small reduction in interest rate or shortening the loan term can save you thousands of dollars in total interest payments.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Loan Amount ($)</label>
                              <input type="number" id="loanAmount" class="form-input" placeholder="10000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Annual Interest Rate (%)</label>
                              <input type="number" id="loanRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Loan Term (Years)</label>
                              <input type="number" id="loanTerm" class="form-input" placeholder="10">
                          </div>
                      </div>
                      <button class="btn btn-secondary" id="calculateLoan">Calculate Loan Payment</button>
                      <div id="loanResults" class="results-container hidden" style="border-color: var(--blue-100); background-color: var(--blue-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupLoanPaymentCalculator() {
        const calculateBtn = document.getElementById("calculateLoan");
        const resultsDiv = document.getElementById("loanResults");

        calculateBtn.addEventListener("click", () => {
          const principal = parseFloat(document.getElementById("loanAmount").value);
          const annualRate = parseFloat(document.getElementById("loanRate").value) / 100;
          const years = parseFloat(document.getElementById("loanTerm").value);

          if (isNaN(principal) || isNaN(annualRate) || isNaN(years) || 
              principal < 0 || annualRate < 0 || years < 0) {
            alert("Please enter valid positive numbers.");
            return;
          }

          const numberOfPayments = years * 12;
          let monthlyPayment = 0;
          let totalPayment = 0;
          let totalInterest = 0;

          // ========== CALCULATION WITH HIGH PRECISION ==========
          const monthlyRate = safeDivide(annualRate, 12, 12); // 12 decimals for accuracy
          
          if (Math.abs(monthlyRate) < 1e-12) {
            // 0% interest case
            monthlyPayment = safeDivide(principal, numberOfPayments, 2);
            totalInterest = 0;
            totalPayment = principal;
          } else {
            // Regular case with interest
            const denominator = 1 - Math.pow(1 + monthlyRate, -numberOfPayments);
            monthlyPayment = safeDivide(
              safeMultiply(principal, monthlyRate),
              denominator,
              6 // Keep 6 decimals for calculation accuracy
            );
            
            // ========== FIX: CALCULATE EXACT TOTALS ==========
            // Step 1: Calculate standard rounded monthly payment (what bank actually charges)
            const standardMonthly = roundFinancial(monthlyPayment, 2);
            
            // Step 2: Simulate full loan to get exact totals
            let simulatedBalance = principal;
            let calculatedTotalPayment = 0;
            let calculatedTotalInterest = 0;
            
            for (let month = 1; month <= numberOfPayments; month++) {
              const interest = roundFinancial(simulatedBalance * monthlyRate, 2);
              calculatedTotalInterest += interest;
              
              let payment = standardMonthly;
              if (month === numberOfPayments) {
                // Last period: adjust to clear balance
                payment = roundFinancial(simulatedBalance + interest, 2);
              }
              
              const principalPaid = roundFinancial(payment - interest, 2);
              simulatedBalance = roundFinancial(simulatedBalance - principalPaid, 2);
              calculatedTotalPayment += payment;
              
              // Prevent negative balance
              if (simulatedBalance < 0) {
                payment -= Math.abs(simulatedBalance);
                simulatedBalance = 0;
              }
            }
            
            // Step 3: Use calculated totals (not formula-based)
            monthlyPayment = standardMonthly;
            totalPayment = roundFinancial(calculatedTotalPayment, 2);
            totalInterest = roundFinancial(calculatedTotalInterest, 2);
          }

          // ========== DISPLAY RESULTS ==========
          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: var(--blue-100);">
                <div class="result-label">Monthly Payment*</div>
                <div class="result-value">${formatCurrency(monthlyPayment)}</div>
                <div class="result-subtext">Standard payment amount</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Total Payment</div>
                <div class="result-value">${formatCurrency(totalPayment)}</div>
                <div class="result-subtext">Actual amount paid</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Total Interest</div>
                <div class="result-value">${formatCurrency(totalInterest)}</div>
                <div class="result-subtext">Interest over ${years} years</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Loan Term</div>
                <div class="result-value">${years} years (${numberOfPayments} months)</div>
                <div class="result-subtext">${annualRate === 0 ? '0% interest loan' : ''}</div>
              </div>
            </div>
            
            <!-- Amortization Schedule Preview -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--blue-50); border-radius: 0.5rem;">
              <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--blue-800); margin-bottom: 0.75rem;">
                üìÖ Amortization Schedule (Full ${numberOfPayments} months)
              </h4>
              ${generateAmortizationPreview(principal, annualRate, years, monthlyPayment)}
            </div>
            
            <!-- Legend -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--slate-50); border-radius: 0.375rem; font-size: 0.75rem;">
              <div style="color: var(--slate-600);">
                <strong>Note:</strong> *Final payment may be slightly adjusted (¬±$0.10) to account for rounding differences.
                This reflects actual banking practice.
              </div>
            </div>
          `;

          resultsDiv.classList.remove("hidden");
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('loan-payment');
          }, 100);
        });
      }

      function generateAmortizationPreview(principal, annualRate, years, monthlyPayment) {
        let balance = principal;
        const monthlyRate = annualRate / 12;
        const totalMonths = years * 12;
        const isZeroInterest = Math.abs(monthlyRate) < 1e-12;
        const standardMonthly = roundFinancial(monthlyPayment, 2);
        
        // Calculate exact totals and final payment
        let simulatedBalance = principal;
        let calculatedTotal = 0;
        let calculatedInterest = 0;
        let finalPayment = standardMonthly;
        
        for (let month = 1; month <= totalMonths; month++) {
          const interest = roundFinancial(simulatedBalance * monthlyRate, 2);
          calculatedInterest += interest;
          
          let payment = standardMonthly;
          if (month === totalMonths) {
            payment = roundFinancial(simulatedBalance + interest, 2);
            finalPayment = payment;
          }
          
          const principalPaid = roundFinancial(payment - interest, 2);
          simulatedBalance = roundFinancial(simulatedBalance - principalPaid, 2);
          calculatedTotal += payment;
          
          if (simulatedBalance < 0) {
            simulatedBalance = 0;
          }
        }
        
        const hasAdjustment = Math.abs(finalPayment - standardMonthly) > 0.001;
        const adjustmentAmount = roundFinancial(finalPayment - standardMonthly, 2);
        
        // Generate table
        let html = '<div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">';
        html += '<thead style="position: sticky; top: 0; background: var(--slate-100); z-index: 10;">';
        html += '<tr>';
        html += '<th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--slate-300);">Month</th>';
        html += '<th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid var(--slate-300);">Payment</th>';
        html += '<th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid var(--slate-300);">Interest</th>';
        html += '<th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid var(--slate-300);">Principal</th>';
        html += '<th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid var(--slate-300);">Balance</th>';
        html += '</tr></thead><tbody>';
        
        balance = principal; // Reset for display
        
        for (let month = 1; month <= totalMonths; month++) {
          const interest = roundFinancial(balance * monthlyRate, 2);
          let payment = standardMonthly;
          let isFinalAdjusted = false;
          
          // Last period adjustment
          if (month === totalMonths) {
            payment = roundFinancial(balance + interest, 2);
            isFinalAdjusted = hasAdjustment;
          }
          
          const principalPaid = roundFinancial(payment - interest, 2);
          balance = roundFinancial(balance - principalPaid, 2);
          
          // Highlight rows
          const isHighlighted = month === totalMonths;
          const rowStyle = isHighlighted ? 'background: var(--blue-50) !important;' : 
                        (month % 2 === 0 ? 'background: var(--slate-50);' : '');
          
          html += `<tr style="${rowStyle}">`;
          html += `<td style="padding: 0.5rem; border-bottom: 1px solid var(--slate-200);">
                    ${month}
                    ${isFinalAdjusted ? ' <span style="color: var(--blue-600); font-weight: 600;">(final)</span>' : ''}
                  </td>`;
          
          html += `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--slate-200);
                    ${isFinalAdjusted ? 'font-weight: bold; color: var(--blue-600);' : ''}">
                    ${formatCurrency(payment)}
                    ${isFinalAdjusted ? '*' : ''}
                  </td>`;
          
          html += `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--slate-200);
                    color: var(--red-600);">${formatCurrency(interest)}</td>`;
          
          html += `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--slate-200);
                    color: var(--green-600);">${formatCurrency(principalPaid)}</td>`;
          
          html += `<td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid var(--slate-200);
                    font-weight: ${balance === 0 ? '700' : '500'};">
                    ${balance === 0 ? 'üéâ PAID OFF' : formatCurrency(balance)}
                  </td>`;
          
          html += '</tr>';
          
          if (balance <= 0) break;
        }
        
        html += '</tbody></table></div>';
        
        // Summary section
        html += `<div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50); border-radius: 0.375rem;">
                  <div style="font-size: 0.75rem; color: var(--green-800);">
                    <strong>üìä Loan Summary:</strong>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                      <div>‚Ä¢ Standard Monthly Payment:</div>
                      <div style="text-align: right;">${formatCurrency(standardMonthly)}</div>
                      ${hasAdjustment ? `
                      <div>‚Ä¢ Final Payment Adjustment:</div>
                      <div style="text-align: right; color: ${adjustmentAmount > 0 ? 'var(--blue-600)' : 'var(--red-600)'}">
                        ${adjustmentAmount > 0 ? '+' : ''}${formatCurrency(adjustmentAmount)}
                      </div>
                      ` : ''}
                      <div>‚Ä¢ Total Principal Paid:</div>
                      <div style="text-align: right;">${formatCurrency(principal)}</div>
                      <div>‚Ä¢ Total Interest Paid:</div>
                      <div style="text-align: right;">${formatCurrency(calculatedInterest)}</div>
                      <div style="font-weight: 600; border-top: 1px solid var(--slate-300); padding-top: 0.25rem;">Total Amount Paid:</div>
                      <div style="text-align: right; font-weight: 600; border-top: 1px solid var(--slate-300); padding-top: 0.25rem;">
                        ${formatCurrency(calculatedTotal)}
                      </div>
                    </div>
                  </div>
                </div>`;
        
        return html;
      }

      

      // ==================== INTERMEDIATE CALCULATORS ====================
      // --- CAPM Calculator ---
      function renderCAPMCalculator() {
        return `
                      <h2 class="calculator-title">Capital Asset Pricing Model (CAPM)</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Risk and Return Relationship
                          </div>
                          <p class="explanation-text">
                              The <strong>Capital Asset Pricing Model (CAPM)</strong> describes the relationship between systematic risk and expected return for assets, particularly stocks.
                              It is widely used throughout finance for pricing risky securities and generating expected returns for assets given the risk of those assets.
                          </p>
                          <p class="explanation-text">
                              <strong>Beta (Œ≤)</strong> measures a stock's volatility compared to the overall market. A beta of 1 indicates the stock moves with the market,
                              while a beta greater than 1 indicates higher volatility.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> CAPM suggests that investors need to be compensated in two ways: time value of money (risk-free rate) and risk (market risk premium). The model helps determine if a stock is fairly valued given its risk profile.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Risk-free Rate (%)</label>
                              <input type="number" id="riskFreeRate" class="form-input" placeholder="3" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Beta (Œ≤)</label>
                              <input type="number" id="beta" class="form-input" placeholder="1.2" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Market Return (%)</label>
                              <input type="number" id="marketReturn" class="form-input" placeholder="8" step="0.01">
                          </div>
                      </div>
                      <button class="btn btn-primary" id="calculateCAPM">Calculate Expected Return (CAPM)</button>
                      <div id="capmResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupCAPMCalculator() {
        const calculateBtn = document.getElementById("calculateCAPM");
        const resultsDiv = document.getElementById("capmResults");

        calculateBtn.addEventListener("click", () => {
          const rf =
            parseFloat(document.getElementById("riskFreeRate").value) / 100;
          const beta = parseFloat(document.getElementById("beta").value);
          const rm =
            parseFloat(document.getElementById("marketReturn").value) / 100;

          if (isNaN(rf) || isNaN(beta) || isNaN(rm)) {
            alert("Please enter valid numbers.");
            return;
          }

          const marketRiskPremium = rm - rf;
          const riskPremium = beta * marketRiskPremium;
          const expectedReturn = rf + riskPremium;

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--indigo-100);">
                                  <div class="result-label">Expected Return</div>
                                  <div class="result-value">${(
                                    expectedReturn * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Risk-free Rate</div>
                                  <div class="result-value">${(
                                    rf * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Market Risk Premium</div>
                                  <div class="result-value">${(
                                    marketRiskPremium * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Risk Premium</div>
                                  <div class="result-value">${(
                                    riskPremium * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('capm');
          }, 100);
        });
      }

      // --- Bond Pricing Calculator ---
      function renderBondPricingCalculator() {
        return `
                      <h2 class="calculator-title">Bond Pricing Calculator</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Fixed Income Valuation
                          </div>
                          <p class="explanation-text">
                              This calculator determines the fair value of a bond based on its coupon rate, yield to maturity, and time to maturity.
                              Bond prices move inversely to interest rates - when rates rise, bond prices fall, and vice versa.
                          </p>
                          <p class="explanation-text">
                              <strong>Yield to Maturity (YTM)</strong> is the total return anticipated on a bond if it is held until it matures.
                              When YTM equals the coupon rate, the bond trades at par (face value). When YTM is higher than the coupon rate, the bond trades at a discount.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> Bond duration measures sensitivity to interest rate changes. Longer-term bonds are more sensitive to rate changes than shorter-term bonds.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Face Value ($)</label>
                              <input type="number" id="faceValue" class="form-input" placeholder="1000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Coupon Rate (%)</label>
                              <input type="number" id="couponRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Yield to Maturity (%)</label>
                              <input type="number" id="ytm" class="form-input" placeholder="6" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Years to Maturity</label>
                              <input type="number" id="yearsToMaturity" class="form-input" placeholder="10">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Payment Frequency</label>
                              <select id="frequency" class="form-select">
                                  <option value="1">Annual</option>
                                  <option value="2" selected>Semi-annual</option>
                              </select>
                          </div>
                      </div>
                      <button class="btn btn-warning" id="calculateBond">Calculate Bond Price</button>
                      <div id="bondResults" class="results-container hidden" style="border-color: var(--orange-100); background-color: var(--orange-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupBondPricingCalculator() {
        const calculateBtn = document.getElementById("calculateBond");
        const resultsDiv = document.getElementById("bondResults");

        calculateBtn.addEventListener("click", () => {
          const faceValue = parseFloat(
            document.getElementById("faceValue").value
          );
          const couponRate =
            parseFloat(document.getElementById("couponRate").value) / 100;
          const ytm = parseFloat(document.getElementById("ytm").value) / 100;
          const yearsToMaturity = parseFloat(
            document.getElementById("yearsToMaturity").value
          );
          const frequency = parseFloat(
            document.getElementById("frequency").value
          );

          if (
            isNaN(faceValue) ||
            isNaN(couponRate) ||
            isNaN(ytm) ||
            isNaN(yearsToMaturity) ||
            isNaN(frequency) ||
            faceValue < 0 ||
            couponRate < 0 ||
            ytm < 0 ||
            yearsToMaturity < 0 ||
            (frequency !== 1 && frequency !== 2)
          ) {
            alert("Please enter valid positive numbers.");
            return;
          }

          // ========== S·ª¨ D·ª§NG FINANCIAL PRECISION UTILITIES ==========
          const couponPayment = safeDivide(safeMultiply(faceValue, couponRate), frequency, 4);
          const periods = roundFinancial(yearsToMaturity * frequency, 4);
          const periodicYield = safeDivide(ytm, frequency, 8);

          let bondPrice;
          
          if (financialEquals(periodicYield, 0, 1e-12)) {
            // Special case: zero yield
            bondPrice = safeAdd(safeMultiply(couponPayment, periods), faceValue);
          } else {
            // Closed-form formula v·ªõi precision
            const discountFactor = Math.pow(1 + periodicYield, -periods);
            const annuityFactor = safeDivide(1 - discountFactor, periodicYield, 10);
            
            bondPrice = safeAdd(
              safeMultiply(couponPayment, annuityFactor, 6),
              safeMultiply(faceValue, discountFactor, 6)
            );
          }
          
          // Round for display
          bondPrice = roundFinancial(bondPrice, 2);

          // Calculate additional metrics v·ªõi precision
          const totalCoupons = roundFinancial(couponPayment * periods, 2);
          const totalReturn = roundFinancial(bondPrice - faceValue, 2);
          const currentYield = roundFinancial(safeDivide(couponPayment * frequency, bondPrice, 6) * 100, 4);
          const capitalGainYield = roundFinancial(safeDivide(faceValue - bondPrice, bondPrice, 6) * 100, 4);
          
          // Determine bond status
          const isPremium = bondPrice > faceValue && !financialEquals(bondPrice, faceValue, 0.01);
          const isDiscount = bondPrice < faceValue && !financialEquals(bondPrice, faceValue, 0.01);
          const isPar = financialEquals(bondPrice, faceValue, 0.01);

          resultsDiv.innerHTML = `
            <div class="results-grid">
              <div class="result-card" style="background-color: var(--orange-100);">
                <div class="result-label">Bond Price</div>
                <div class="result-value">${formatCurrency(bondPrice)}</div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${isPremium ? 'Premium' : isDiscount ? 'Discount' : 'Par'} bond
                </div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Face Value</div>
                <div class="result-value">${formatCurrency(faceValue)}</div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Coupon Payment</div>
                <div class="result-value">${formatCurrency(couponPayment)}/period</div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${formatPercent(couponRate)} annually
                </div>
              </div>
              <div class="result-card" style="background-color: var(--slate-100);">
                <div class="result-label">Yield to Maturity</div>
                <div class="result-value">${formatPercent(ytm)}</div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${periodicYield.toFixed(6)} periodic
                </div>
              </div>
            </div>
            
            <!-- Additional Metrics -->
            <div style="margin-top: 1.5rem; background: var(--blue-50); padding: 1rem; border-radius: 0.5rem;">
              <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--blue-800); margin-bottom: 0.75rem;">
                üìä Additional Bond Metrics
              </h4>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;">
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Current Yield</div>
                  <div style="font-weight: 700; color: ${currentYield >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                    ${formatPercent(currentYield/100, 4)}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Periods</div>
                  <div style="font-weight: 700; color: var(--slate-700);">
                    ${periods.toFixed(1)}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Premium/Discount</div>
                  <div style="font-weight: 700; color: ${totalReturn >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                    ${totalReturn >= 0 ? '+' : ''}${formatCurrency(Math.abs(totalReturn))}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600);">Total Coupons</div>
                  <div style="font-weight: 700; color: var(--slate-700);">
                    ${formatCurrency(totalCoupons)}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Bond Status -->
            <div style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.375rem; 
                        background: ${isPremium ? 'var(--orange-50)' : isDiscount ? 'var(--green-50)' : 'var(--blue-50)'}; 
                        border-left: 4px solid ${isPremium ? 'var(--orange-500)' : isDiscount ? 'var(--green-500)' : 'var(--blue-500)'};">
              <div style="font-weight: 600; color: ${isPremium ? 'var(--orange-800)' : isDiscount ? 'var(--green-800)' : 'var(--blue-800)'};">
                ${
                  isPremium 
                    ? `üí∞ Premium Bond: Trading at ${formatCurrency(bondPrice - faceValue)} above face value` 
                    : isDiscount 
                    ? `üìâ Discount Bond: Trading at ${formatCurrency(faceValue - bondPrice)} below face value`
                    : `üìä Par Bond: Trading exactly at face value`
                }
              </div>
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                YTM ${formatPercent(ytm)} ${isPremium ? ' < ' : isDiscount ? ' > ' : ' = '} 
                Coupon Rate ${formatPercent(couponRate)}
              </div>
            </div>
            
            <!-- Floating Point Protection Notice -->
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--purple-50); border-radius: 0.375rem; border-left: 3px solid var(--purple-500);">
              <div style="font-size: 0.7rem; color: var(--purple-800); display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-weight: 700;">üõ°Ô∏è Financial Precision Active:</span>
                <span>All calculations use banker's rounding and floating-point error correction</span>
              </div>
            </div>
          `;

          resultsDiv.classList.remove("hidden");

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('bond-pricing');
          }, 100);
        });
      }

      // --- NPV & IRR Calculator ---
      function renderNPVIRRCalculator() {
        return `
                      <h2 class="calculator-title">NPV & IRR Calculator</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Capital Budgeting Decisions
                          </div>
                          <p class="explanation-text">
                              <strong>Net Present Value (NPV)</strong> measures the profitability of a project by calculating the difference between the present value of cash inflows and outflows.
                              A positive NPV indicates the project should be profitable.
                          </p>
                          <p class="explanation-text">
                              <strong>Internal Rate of Return (IRR)</strong> is the discount rate that makes the NPV of all cash flows equal to zero.
                              It represents the expected compound annual rate of return that will be earned on a project.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> When evaluating mutually exclusive projects, NPV is generally preferred over IRR as it directly measures the value added to the firm. The IRR can be misleading when comparing projects of different sizes or durations.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Initial Investment ($)</label>
                              <input type="number" id="initialInvestment" class="form-input" placeholder="100000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Discount Rate (%)</label>
                              <input type="number" id="discountRate" class="form-input" placeholder="10" step="0.1">
                          </div>
                      </div>
                      <div class="form-group">
                          <label class="form-label">Cash Flows by Year ($)</label>
                          <div class="cash-flows-grid" id="cashFlowsContainer">
                              <!-- Cash flows will be populated by JavaScript -->
                          </div>
                      </div>
                      <button class="btn btn-danger" id="calculateNPV">Calculate NPV & IRR</button>
                      <div id="npvResults" class="results-container hidden" style="border-color: var(--rose-100); background-color: var(--rose-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      // IRR calculation function 
      /**
       * Calculate IRR with fund-grade precision (Hybrid: Newton-Raphson + Bisection Fallback)
       * Production-ready for financial applications
       * @param {Array<number>} cashFlows - Array of cash flows
       * @param {number} initialGuess - Starting guess (default 0.1 = 10%)
       * @returns {Object} { success: boolean, irr?: number, iterations?: number, method?: string, message?: string }
       */
      function calculateIRR(cashFlows, initialGuess = 0.1) {
        // ========== 1. VALIDATION ==========
        if (!cashFlows || !Array.isArray(cashFlows)) {
          return { 
            success: false, 
            message: "Invalid cash flows: must be an array" 
          };
        }
        
        if (cashFlows.length < 2) {
          return { 
            success: false, 
            message: "Need at least 2 cash flows for IRR calculation" 
          };
        }
        
        // Fund-grade validation: need both + and - cash flows
        const positiveFlows = cashFlows.filter(cf => cf > 0);
        const negativeFlows = cashFlows.filter(cf => cf < 0);
        const zeroFlows = cashFlows.filter(cf => cf === 0);
        
        if (positiveFlows.length === 0 || negativeFlows.length === 0) {
          return {
            success: false,
            message: `Cash flows must contain both positive and negative values. Found: ${positiveFlows.length}+, ${negativeFlows.length}-, ${zeroFlows.length}0`
          };
        }
        
        // ========== 2. CONFIGURATION ==========
        const maxIterations = 100;
        const tolerance = 1e-9;
        const maxIRR = 10.0;      // 1000% maximum realistic bound
        const minIRR = -0.9999;   // -99.99% minimum
        
        let irr = roundFinancial(initialGuess, 8);
        
        // ========== 3. NEWTON-RAPHSON (Fast & Accurate) ==========
        for (let iter = 0; iter < maxIterations; iter++) {
          let npv = 0;
          let derivative = 0;
          
          for (let t = 0; t < cashFlows.length; t++) {
            const cf = cashFlows[t];
            if (cf === 0) continue; // Skip zero cash flows for efficiency
            
            // Period = t (Year 0, Year 1, etc.)
            const discountFactor = Math.pow(1 + irr, t);
            const pv = safeDivide(cf, discountFactor, 12);
            npv = safeAdd(npv, pv);
            
            // Derivative for Newton-Raphson (only for t > 0)
            if (t > 0 && cf !== 0) {
              // Derivative of CF/(1+r)^t = -t * CF / (1+r)^(t+1)
              const derivativeFactor = safeMultiply(
                -t,
                Math.pow(1 + irr, -(t + 1)),
                12
              );
              const derivativeTerm = safeMultiply(cf, derivativeFactor, 12);
              derivative = safeAdd(derivative, derivativeTerm);
            }
          }
          
          // Convergence check (main criteria)
          if (financialEquals(npv, 0, tolerance)) {
            return {
              success: true,
              irr: roundFinancial(irr, 8),
              iterations: iter + 1,
              method: 'newton-raphson',
              convergence: 'npv ‚âà 0'
            };
          }
          
          // Stability check: prevent division by zero
          if (Math.abs(derivative) < 1e-15) {
            // Derivative too small, switch to bisection
            break;
          }
          
          // Newton-Raphson update: r = r - NPV/NPV'
          const delta = safeDivide(npv, derivative, 12);
          irr = safeAdd(irr, -delta);
          
          // Apply realistic bounds
          if (irr <= minIRR) {
            irr = minIRR;
          } else if (irr >= maxIRR) {
            irr = maxIRR;
          }
          
          // Secondary convergence check: small delta
          if (Math.abs(delta) < tolerance) {
            // Re-calculate NPV with new rate to confirm
            const finalNPV = calculateNPVAtRate(cashFlows, irr);
            if (financialEquals(finalNPV, 0, tolerance * 10)) {
              return {
                success: true,
                irr: roundFinancial(irr, 8),
                iterations: iter + 1,
                method: 'newton-raphson',
                convergence: 'delta < tolerance'
              };
            }
          }
        }
        
        // ========== 4. FALLBACK: BISECTION METHOD (More Stable) ==========
        // If Newton-Raphson fails, use bisection as robust fallback
        const bisectionResult = calculateIRRBisection(cashFlows, tolerance, minIRR, maxIRR);
        
        if (bisectionResult.success) {
          return {
            ...bisectionResult,
            method: 'bisection-fallback',
            note: 'Newton-Raphson failed, used bisection'
          };
        }
        
        // ========== 5. FINAL FALLBACK: MULTIPLE GUESSES ==========
        // Try multiple initial guesses (Excel's approach)
        const initialGuesses = [0.1, -0.1, 0.5, -0.5, 0.0, 0.25, 1.0, -0.99, 2.0];
        
        for (const guess of initialGuesses) {
          if (guess === initialGuess) continue; // Skip already tried
          
          const retryResult = calculateIRRNewtonOnly(cashFlows, guess, maxIterations, tolerance);
          if (retryResult.success) {
            return {
              ...retryResult,
              method: 'newton-retry',
              initialGuessUsed: guess
            };
          }
        }
        
        // ========== 6. ALL METHODS FAILED ==========
        return {
          success: false,
          message: `IRR calculation failed after ${maxIterations} iterations with multiple methods. Check cash flow pattern.`,
          iterations: maxIterations,
          cashFlowSummary: `${positiveFlows.length}+, ${negativeFlows.length}-, ${zeroFlows.length}0`
        };
      }
      // ========== HELPER FUNCTIONS ==========
      /**
       * Newton-Raphson only (no fallback) for retry attempts
       */
      function calculateIRRNewtonOnly(cashFlows, initialGuess, maxIterations, tolerance) {
        let irr = initialGuess;
        
        for (let iter = 0; iter < maxIterations; iter++) {
          let npv = 0;
          let derivative = 0;
          
          for (let t = 0; t < cashFlows.length; t++) {
            const cf = cashFlows[t];
            if (cf === 0) continue;
            
            const discountFactor = Math.pow(1 + irr, t);
            const pv = safeDivide(cf, discountFactor, 12);
            npv = safeAdd(npv, pv);
            
            if (t > 0 && cf !== 0) {
              const derivativeFactor = safeMultiply(
                -t,
                Math.pow(1 + irr, -(t + 1)),
                12
              );
              const derivativeTerm = safeMultiply(cf, derivativeFactor, 12);
              derivative = safeAdd(derivative, derivativeTerm);
            }
          }
          
          if (financialEquals(npv, 0, tolerance)) {
            return {
              success: true,
              irr: roundFinancial(irr, 8),
              iterations: iter + 1
            };
          }
          
          if (Math.abs(derivative) < 1e-15) break;
          
          const delta = safeDivide(npv, derivative, 12);
          irr = safeAdd(irr, -delta);
          
          // Bounds
          if (irr <= -0.9999) irr = -0.9999;
          else if (irr >= 10.0) irr = 10.0;
        }
        
        return { success: false };
      }
      /**
       * Bisection method with configurable bounds
       */
      function calculateIRRBisection(cashFlows, tolerance, minIRR = -0.9999, maxIRR = 10.0) {
        let lower = minIRR;
        let upper = maxIRR;
        const maxIterations = 100;
        
        // Check initial bounds
        const npvLower = calculateNPVAtRate(cashFlows, lower);
        const npvUpper = calculateNPVAtRate(cashFlows, upper);
        
        // If bounds have same sign, try to find crossing
        if (npvLower * npvUpper > 0) {
          // Search for valid bounds (Excel's approach)
          for (let i = 0; i < 50; i++) {
            const testRate = lower + (upper - lower) * i / 49;
            const npv = calculateNPVAtRate(cashFlows, testRate);
            
            if (npvLower * npv <= 0) {
              upper = testRate;
              break;
            }
          }
        }
        
        // Bisection loop
        for (let iter = 0; iter < maxIterations; iter++) {
          const mid = safeDivide(safeAdd(lower, upper), 2, 12);
          const npvMid = calculateNPVAtRate(cashFlows, mid);
          
          if (financialEquals(npvMid, 0, tolerance)) {
            return {
              success: true,
              irr: roundFinancial(mid, 8),
              iterations: iter + 1
            };
          }
          
          // Update bounds based on sign
          if (calculateNPVAtRate(cashFlows, lower) * npvMid < 0) {
            upper = mid;
          } else {
            lower = mid;
          }
          
          // Check if interval is sufficiently small
          if (financialEquals(upper, lower, 1e-12)) {
            return {
              success: financialEquals(npvMid, 0, tolerance * 100),
              irr: roundFinancial(mid, 8),
              iterations: iter + 1
            };
          }
        }
        
        return { success: false };
      }
      /**
       * Calculate NPV at given discount rate (reusable)
       */
      function calculateNPVAtRate(cashFlows, rate) {
        let npv = 0;
        for (let t = 0; t < cashFlows.length; t++) {
          const cf = cashFlows[t];
          if (cf === 0) continue;
          
          const discountFactor = Math.pow(1 + rate, t);
          const pv = safeDivide(cf, discountFactor, 12);
          npv = safeAdd(npv, pv);
        }
        return npv;
      }





      // ==================== XIRR/XNPV FUNCTIONS ====================
      /**
       * Parse date robustly (timezone-safe, Excel-compatible)
       * Returns Date object at noon UTC to avoid timezone issues
       */
      function parseInputDate(dateStr) {
        if (!dateStr) return null;
        
        // Remove any whitespace
        dateStr = dateStr.trim();
        
        // Try ISO format (YYYY-MM-DD)
        const isoMatch = dateStr.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if (isoMatch) {
          const [_, year, month, day] = isoMatch;
          // Use UTC noon to avoid timezone issues
          const date = new Date(Date.UTC(
            parseInt(year), 
            parseInt(month) - 1, 
            parseInt(day),
            12, 0, 0, 0 // Noon UTC
          ));
          if (!isNaN(date.getTime())) return date;
        }
        
        // Try US format (MM/DD/YYYY)
        const usMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (usMatch) {
          const [_, month, day, year] = usMatch;
          const date = new Date(Date.UTC(
            parseInt(year), 
            parseInt(month) - 1, 
            parseInt(day),
            12, 0, 0, 0
          ));
          if (!isNaN(date.getTime())) return date;
        }
        
        // Try European format (DD.MM.YYYY or DD-MM-YYYY)
        const euMatch1 = dateStr.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
        if (euMatch1) {
          const [_, day, month, year] = euMatch1;
          const date = new Date(Date.UTC(
            parseInt(year), 
            parseInt(month) - 1, 
            parseInt(day),
            12, 0, 0, 0
          ));
          if (!isNaN(date.getTime())) return date;
        }
        
        const euMatch2 = dateStr.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
        if (euMatch2) {
          const [_, day, month, year] = euMatch2;
          const date = new Date(Date.UTC(
            parseInt(year), 
            parseInt(month) - 1, 
            parseInt(day),
            12, 0, 0, 0
          ));
          if (!isNaN(date.getTime())) return date;
        }
        
        // Fallback: try Date parsing with UTC
        try {
          const date = new Date(dateStr + 'T12:00:00Z');
          if (!isNaN(date.getTime())) return date;
        } catch (e) {
          // Continue to return null
        }
        
        return null;
      }

      /**
       * Calculate XNPV with financial precision (Excel-compatible)
       */
      function calculateXNPV(rate, cashFlows) {
        if (!cashFlows || cashFlows.length === 0) return 0;
        
        const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
        const baseDate = sorted[0].date;
        
        let xnpv = 0;
        
        for (const cf of sorted) {
          const daysDiff = Math.round((cf.date - baseDate) / (1000 * 60 * 60 * 24));
          const yearsDiff = daysDiff / 365.0;
          
          // ‚úÖ S·ª¨ D·ª§NG PRECISION FUNCTIONS
          const discountFactor = safeMultiply(
            1,  // Base multiplier
            Math.pow(1 + rate, yearsDiff),
            12  // Precision: 12 decimal places
          );
          
          const pv = safeDivide(cf.amount, discountFactor, 12);
          xnpv = safeAdd(xnpv, pv);
        }
        
        return roundFinancial(xnpv, 2);
      }

      /**
       * Newton-Raphson solver for XIRR with financial precision
       */
      function newtonRaphsonXIRR(sortedCFs, baseDate, initialGuess, tolerance) {
        const maxIterations = 100;
        let rate = initialGuess;
        
        for (let iter = 0; iter < maxIterations; iter++) {
          let npv = 0;
          let derivative = 0;
          
          for (const cf of sortedCFs) {
            const days = (cf.date - baseDate) / (1000 * 60 * 60 * 24);
            const years = days / 365.0;
            
            // ‚úÖ S·ª¨ D·ª§NG SAFE FUNCTIONS
            const discountFactor = safeMultiply(
              Math.pow(1 + rate, years), 
              1, 
              12
            );
            
            const discountedCF = safeDivide(cf.amount, discountFactor, 12);
            npv = safeAdd(npv, discountedCF);
            
            // Derivative calculation v·ªõi precision
            if (Math.abs(years) > 1e-12) {
              const derivativeTerm = safeDivide(
                safeMultiply(
                  safeMultiply(years, cf.amount, 12),
                  Math.pow(1 + rate, -(years + 1)),
                  12
                ),
                1,
                12
              );
              derivative = safeAdd(derivative, -derivativeTerm);
            }
          }
          
          // Convergence check v·ªõi financialEquals
          if (financialEquals(npv, 0, tolerance)) {
            return {
              success: true,
              xirr: roundFinancial(rate, 8), // 8 decimals for rates
              iterations: iter + 1
            };
          }
          
          // Prevent division by zero
          if (Math.abs(derivative) < 1e-15 || financialEquals(derivative, 0, 1e-15)) {
            break;
          }
          
          // Newton-Raphson update v·ªõi precision
          const delta = safeDivide(npv, derivative, 12);
          rate = safeAdd(rate, -delta);
          
          // Apply bounds v·ªõi rounding
          if (rate <= -0.9999) rate = -0.9999;
          if (rate >= 10.0) rate = 10.0;
          
          // Check for small updates
          if (Math.abs(delta) < tolerance || iter === maxIterations - 1) {
            const finalXNPV = calculateXNPV(rate, sortedCFs);
            if (financialEquals(finalXNPV, 0, tolerance)) {
              return {
                success: true,
                xirr: roundFinancial(rate, 8),
                iterations: iter + 1
              };
            }
          }
        }
        
        return { success: false };
      }

      /**
       * Bisection method with financial precision
       */
      function bisectionXIRR(sortedCFs, baseDate, tolerance) {
        let lower = -0.9999;
        let upper = 10.0;
        
        // Check bounds v·ªõi XNPV precision
        const npvLower = calculateXNPV(lower, sortedCFs);
        const npvUpper = calculateXNPV(upper, sortedCFs);
        
        if (npvLower * npvUpper > 0) {
          // Try to find better bounds
          for (let i = 0; i < 20; i++) {
            const testRate = lower + (upper - lower) * i / 19;
            const npv = calculateXNPV(testRate, sortedCFs);
            
            if (npvLower * npv <= 0) {
              upper = roundFinancial(testRate, 8);
              break;
            }
          }
        }
        
        // Bisection loop v·ªõi precision
        for (let iter = 0; iter < 100; iter++) {
          const mid = safeDivide(safeAdd(lower, upper), 2, 12);
          const npvMid = calculateXNPV(mid, sortedCFs);
          
          if (financialEquals(npvMid, 0, tolerance)) {
            return {
              success: true,
              xirr: roundFinancial(mid, 8),
              iterations: iter + 1
            };
          }
          
          if (calculateXNPV(lower, sortedCFs) * npvMid < 0) {
            upper = roundFinancial(mid, 12);
          } else {
            lower = roundFinancial(mid, 12);
          }
          
          // Check convergence
          if (financialEquals(upper, lower, 1e-12)) {
            return {
              success: financialEquals(npvMid, 0, tolerance * 10),
              xirr: roundFinancial(mid, 8),
              iterations: iter + 1
            };
          }
        }
        
        return { success: false };
      }

      /**
       * Calculate regular NPV v·ªõi precision
       */

      function calculateRegularNPV(cashFlows, discountRate) {
        if (!cashFlows || cashFlows.length === 0) return 0;
        
        const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
        let npv = 0;
        
        for (let i = 0; i < sorted.length; i++) {
          const discountFactor = safeMultiply(
            Math.pow(1 + discountRate, i),
            1,
            12
          );
          const pv = safeDivide(sorted[i].amount, discountFactor, 12);
          npv = safeAdd(npv, pv);
        }
        
        return roundFinancial(npv, 2);
      }

      /**
       * PRODUCTION-GRADE XIRR v·ªõi financial precision
       */
      function calculateXIRR(cashFlows, initialGuess = 0.1) {
        // Validate input
        if (!cashFlows || cashFlows.length < 2) {
          return {
            success: false,
            message: "Need at least 2 cash flows"
          };
        }

        // Validate cash flow signs
        const amounts = cashFlows.map(cf => cf.amount);
        const hasPositive = amounts.some(a => a > 0);
        const hasNegative = amounts.some(a => a < 0);
        
        if (!hasPositive || !hasNegative) {
          return {
            success: false,
            message: "Need both positive and negative cash flows"
          };
        }

        // Sort by date
        const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
        const baseDate = sorted[0].date;
        
        // T√≠nh tolerance d·ª±a tr√™n magnitude
        const totalMagnitude = sorted.reduce((sum, cf) => sum + Math.abs(cf.amount), 0);
        const tolerance = Math.max(1e-9, totalMagnitude * 1e-12);
        
        // Multiple initial guesses (Excel's approach)
        const initialGuesses = [
          roundFinancial(initialGuess, 8),
          roundFinancial(0.1, 8),
          roundFinancial(-0.1, 8),
          roundFinancial(0.5, 8),
          roundFinancial(-0.5, 8),
          roundFinancial(0.0, 8),
          roundFinancial(0.25, 8),
          roundFinancial(1.0, 8),
          roundFinancial(-0.99, 8),
          roundFinancial(2.0, 8)
        ];
        
        for (const guess of initialGuesses) {
          const result = newtonRaphsonXIRR(sorted, baseDate, guess, tolerance);
          if (result.success) {
            const xnpv = calculateXNPV(result.xirr, sorted);
            return {
              ...result,
              xnpv: roundFinancial(xnpv, 2),
              method: 'newton-raphson'
            };
          }
        }
        
        // Fallback to bisection
        const bisectionResult = bisectionXIRR(sorted, baseDate, tolerance);
        if (bisectionResult.success) {
          const xnpv = calculateXNPV(bisectionResult.xirr, sorted);
          return {
            ...bisectionResult,
            xnpv: roundFinancial(xnpv, 2),
            method: 'bisection'
          };
        }
        
        return {
          success: false,
          message: "XIRR did not converge. Check cash flow pattern or try different initial guess.",
          iterations: 100
        };
      }


      /**
       * Calculate regular IRR for comparison (annual periods)
       */
      function calculateRegularIRR(cashFlows) {
        if (!cashFlows || cashFlows.length < 2) {
          return { success: false, message: "Need at least 2 cash flows" };
        }
        
        const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
        const amounts = sorted.map(cf => cf.amount);
        return calculateIRR(amounts, 0.1);
      }

      /**
       * Format date for display (locale-aware)
       */
      function formatDate(date) {
        if (!date) return '';
        
        // Use UTC to avoid timezone shifts in display
        const utcDate = new Date(Date.UTC(
          date.getUTCFullYear(),
          date.getUTCMonth(),
          date.getUTCDate()
        ));
        
        return utcDate.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          timeZone: 'UTC'
        });
      }

      function renderXNPVXIRRCalculator() {
        return `
          <h2 class="calculator-title">‚ö° XNPV & XIRR Calculator (Professional)</h2>
          
          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Why XIRR/XNPV? The Real Deal Standard
            </div>
            <p class="explanation-text">
              <strong>Regular IRR/NPV = Academic.</strong> <strong>XIRR/XNPV = What PE funds actually use.</strong>
              Real cash flows don't arrive on "Year 1, Year 2" ‚Äî they happen on specific dates (Day 47, Q3 end, etc.).
              Every day changes discounting ‚áí Regular IRR can be off by <strong>50-150bps</strong> on large deals.
            </p>
            <p class="explanation-text">
              <strong>Use cases:</strong> Dividend recaps, bridge loans, irregular distributions, construction capex,
              preferred return waterfalls, carried interest calculations, refinancing analysis.
            </p>
            <div class="explanation-note">
              <strong>PE/IB Insight:</strong> If your model doesn't use XIRR/XNPV with exact dates, 
              it looks like an internship-level model. Funds calculate performance fees, promotes, 
              and waterfalls using XIRR down to the day.
            </div>
          </div>

          <!-- Scenario Selector -->
          <div style="background: var(--slate-50); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
            <h3 style="font-size: 1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
              üìã Choose Your Scenario
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem;">
              <button class="scenario-btn active" data-scenario="custom">
                ‚úçÔ∏è Custom<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Enter your cash flows</span>
              </button>
              <button class="scenario-btn" data-scenario="pe-investment">
                üíº PE Investment<br>
                <span style="font-size: 0.75rem; font-weight: normal;">LBO with dividend recap</span>
              </button>
              <button class="scenario-btn" data-scenario="real-estate">
                üè¢ Real Estate<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Construction + rent + sale</span>
              </button>
              <button class="scenario-btn" data-scenario="bridge-loan">
                üåâ Bridge Loan<br>
                <span style="font-size: 0.75rem; font-weight: normal;">45-day refinancing</span>
              </button>
            </div>
          </div>

          <!-- Cash Flow Input -->
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200); margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="font-size: 1rem; font-weight: 600; color: var(--slate-700);">
                üí∏ Cash Flows (Date-Specific)
              </h3>
              <button class="btn btn-primary" id="addCashFlowBtn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.875rem;">
                ‚ûï Add Cash Flow
              </button>
            </div>

            <div style="background: var(--blue-50); padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem; border-left: 3px solid var(--blue-500);">
              <strong>üí° Pro Tip:</strong> Negative = Outflow (investment), Positive = Inflow (returns).
              Date format: <strong>YYYY-MM-DD</strong> or <strong>MM/DD/YYYY</strong>
            </div>

            <div id="cashFlowsContainer">
              <!-- Cash flows will be added here -->
            </div>

            <div style="margin-top: 1rem; padding: 1rem; background: var(--slate-50); border-radius: 0.5rem; font-size: 0.875rem;">
              <strong>Quick actions:</strong>
              <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="sortByDateBtn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.75rem;">
                  üìÖ Sort by Date
                </button>
                <button class="btn btn-danger" id="clearAllBtn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.75rem;">
                  üóëÔ∏è Clear All
                </button>
              </div>
            </div>
          </div>

          <!-- Discount Rate (for XNPV) -->
          <div class="form-grid" style="margin-bottom: 1.5rem;">
            <div class="form-group">
              <label class="form-label">üìä Discount Rate for XNPV (%)</label>
              <input type="number" id="xnpvDiscountRate" class="form-input" placeholder="10" step="0.1" value="10">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                Target return or WACC (e.g., 10% = 0.10)
              </div>
            </div>
          </div>

          <!-- Calculate Button -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <button class="btn btn-primary" id="calculateXNPV">
              üìä Calculate XNPV
            </button>
            <button class="btn btn-success" id="calculateXIRR">
              ‚ö° Calculate XIRR
            </button>
          </div>

          <!-- Results -->
          <div id="xnpvxirrResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50); margin-top: 2rem;">
            <!-- Results will be populated here -->
          </div>

          <!-- Comparison with Regular IRR/NPV -->
          <div id="comparisonSection" class="hidden" style="margin-top: 2rem;">
            <!-- Comparison will be populated here -->
          </div>
        `;
      }    
              
      function setupXNPVXIRRCalculator() {
        let cashFlows = [];
        let cashFlowIdCounter = 1;

        // Add initial cash flow
        addCashFlow();

        // Scenario buttons
        document.querySelectorAll('.scenario-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadScenario(btn.dataset.scenario);
          });
        });

        // Add cash flow button
        document.getElementById('addCashFlowBtn').addEventListener('click', () => {
          if (cashFlows.length < 50) {
            addCashFlow();
          } else {
            alert('Maximum 50 cash flows allowed');
          }
        });

        // Sort by date
        document.getElementById('sortByDateBtn').addEventListener('click', () => {
          cashFlows.sort((a, b) => {
            const dateA = parseInputDate(a.date);
            const dateB = parseInputDate(b.date);
            if (!dateA || !dateB) return 0;
            return dateA - dateB;
          });
          renderCashFlows();
        });

        // Clear all
        document.getElementById('clearAllBtn').addEventListener('click', () => {
          if (confirm('Clear all cash flows?')) {
            cashFlows = [];
            addCashFlow();
          }
        });

        // Calculate XNPV
        document.getElementById('calculateXNPV').addEventListener('click', () => {
          calculateAndDisplayXNPV();
        });

        // Calculate XIRR
        document.getElementById('calculateXIRR').addEventListener('click', () => {
          calculateAndDisplayXIRR();
        });

        function addCashFlow(date = '', amount = '') {
          cashFlows.push({
            id: cashFlowIdCounter++,
            date: date,
            amount: amount
          });
          renderCashFlows();
        }

        function removeCashFlow(id) {
          cashFlows = cashFlows.filter(cf => cf.id !== id);
          if (cashFlows.length === 0) {
            addCashFlow(); // Keep at least one
          }
          renderCashFlows();
        }

        function renderCashFlows() {
          const container = document.getElementById('cashFlowsContainer');
          
          if (cashFlows.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--slate-500);">No cash flows</p>';
            return;
          }

          container.innerHTML = cashFlows.map((cf, index) => `
            <div class="cash-flow-row" data-cf-id="${cf.id}" style="
              background: ${index % 2 === 0 ? 'var(--slate-50)' : 'var(--white)'};
              padding: 1rem;
              border-radius: 0.5rem;
              margin-bottom: 0.75rem;
              border: 1px solid var(--slate-200);
            ">
              <div style="display: grid; grid-template-columns: 50px 2fr 2fr auto; gap: 1rem; align-items: center;">
                <div style="font-weight: 700; font-size: 1.1rem; color: var(--slate-600); text-align: center;">
                  #${index + 1}
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-input cf-date" value="${cf.date}" 
                        placeholder="YYYY-MM-DD" style="font-size: 0.875rem;">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Amount ($)</label>
                  <input type="number" class="form-input cf-amount" value="${cf.amount}" 
                        placeholder="e.g., -100000 or 50000" step="1000">
                </div>

                <button class="remove-cf-btn" data-cf-id="${cf.id}" style="
                  background: var(--red-500);
                  color: white;
                  border: none;
                  border-radius: 0.375rem;
                  padding: 0.75rem;
                  cursor: pointer;
                  font-weight: 600;
                  font-size: 1.2rem;
                  line-height: 1;
                  transition: all 0.2s;
                " title="Remove">
                  ‚úï
                </button>
              </div>
            </div>
          `).join('');

          // Attach event listeners
          document.querySelectorAll('.remove-cf-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const cfId = parseInt(e.target.dataset.cfId);
              removeCashFlow(cfId);
            });
          });

          document.querySelectorAll('.cash-flow-row').forEach(row => {
            const cfId = parseInt(row.dataset.cfId);
            const cf = cashFlows.find(c => c.id === cfId);

            row.querySelector('.cf-date').addEventListener('change', (e) => {
              cf.date = e.target.value;
            });

            row.querySelector('.cf-amount').addEventListener('change', (e) => {
              cf.amount = e.target.value;
            });
          });
        }

        function loadScenario(scenario) {
          cashFlows = [];
          cashFlowIdCounter = 1;

          const today = new Date();
          const formatDate = (date) => date.toISOString().split('T')[0];

          switch (scenario) {
            case 'pe-investment':
              // Realistic PE deal: Investment ‚Üí Dividend Recap ‚Üí Exit
              addCashFlow(formatDate(today), '-50000000'); // $50M investment today
              
              const recap = new Date(today);
              recap.setMonth(recap.getMonth() + 18);
              addCashFlow(formatDate(recap), '15000000'); // $15M dividend recap after 18mo
              
              const exit = new Date(today);
              exit.setFullYear(exit.getFullYear() + 4);
              exit.setMonth(exit.getMonth() + 3);
              addCashFlow(formatDate(exit), '95000000'); // $95M exit after 4.25 years
              break;

            case 'real-estate':
              // Real estate development
              const landPurchase = new Date(today);
              addCashFlow(formatDate(landPurchase), '-10000000'); // Land
              
              // Construction capex over 18 months
              for (let i = 1; i <= 6; i++) {
                const capexDate = new Date(today);
                capexDate.setMonth(capexDate.getMonth() + i * 3);
                addCashFlow(formatDate(capexDate), '-3000000'); // Quarterly capex
              }
              
              // Rental income for 3 years
              for (let i = 24; i <= 60; i += 3) {
                const rentDate = new Date(today);
                rentDate.setMonth(rentDate.getMonth() + i);
                addCashFlow(formatDate(rentDate), '500000'); // Quarterly rent
              }
              
              // Sale after 5 years
              const saleDate = new Date(today);
              saleDate.setFullYear(saleDate.getFullYear() + 5);
              addCashFlow(formatDate(saleDate), '35000000'); // Property sale
              break;

            case 'bridge-loan':
              // 45-day bridge financing
              addCashFlow(formatDate(today), '-5000000'); // Lend $5M today
              
              const repay = new Date(today);
              repay.setDate(repay.getDate() + 45);
              addCashFlow(formatDate(repay), '5075000'); // Repay with interest after 45 days
              break;

            default: // custom
              addCashFlow();
          }
        }

        function calculateAndDisplayXNPV() {
          // Validate and parse cash flows
          const parsedCFs = [];
          for (const cf of cashFlows) {
            const date = parseInputDate(cf.date);
            const amount = parseFloat(cf.amount);
            
            if (!date) {
              alert(`Invalid date: ${cf.date}`);
              return;
            }
            if (isNaN(amount)) {
              alert(`Invalid amount: ${cf.amount}`);
              return;
            }
            
            parsedCFs.push({ date, amount });
          }

          if (parsedCFs.length < 2) {
            alert('Need at least 2 cash flows');
            return;
          }

          const discountRate = parseFloat(document.getElementById('xnpvDiscountRate').value) / 100;
          if (isNaN(discountRate)) {
            alert('Invalid discount rate');
            return;
          }

          // Calculate XNPV
          const xnpv = calculateXNPV(discountRate, parsedCFs);
          
          // Calculate regular NPV for comparison (assuming annual periods)
          const regularNPV = calculateRegularNPV(parsedCFs, discountRate);
          
          displayXNPVResults(xnpv, regularNPV, discountRate, parsedCFs);
        }

        function calculateAndDisplayXIRR() {
          // Validate and parse
          const parsedCFs = [];
          for (const cf of cashFlows) {
            const date = parseInputDate(cf.date);
            const amount = parseFloat(cf.amount);
            
            if (!date) {
              alert(`Invalid date: ${cf.date}`);
              return;
            }
            if (isNaN(amount)) {
              alert(`Invalid amount: ${cf.amount}`);
              return;
            }
            
            parsedCFs.push({ date, amount });
          }

          if (parsedCFs.length < 2) {
            alert('Need at least 2 cash flows');
            return;
          }

          // Calculate XIRR
          const xirrResult = calculateXIRR(parsedCFs, 0.1);
          
          // Calculate regular IRR for comparison
          const regularIRR = calculateRegularIRR(parsedCFs);
          
          displayXIRRResults(xirrResult, regularIRR, parsedCFs);
        }



        function calculateRegularNPV(parsedCFs, rate) {
          // S·ª¨ D·ª§NG safe functions:
          const sorted = [...parsedCFs].sort((a, b) => a.date - b.date);
          let npv = 0;
          
          for (let i = 0; i < sorted.length; i++) {
            const discountFactor = safeMultiply(
              1,
              Math.pow(1 + rate, i), 
              12
            );
            const pv = safeDivide(sorted[i].amount, discountFactor, 12);
            npv = safeAdd(npv, pv);
          }
          
          return roundFinancial(npv, 2);
        }        

        function calculateRegularIRR(parsedCFs) {
          // Use simplified IRR assuming evenly spaced periods
          const sorted = [...parsedCFs].sort((a, b) => a.date - b.date);
          const amounts = sorted.map(cf => cf.amount);
          
          const result = calculateIRR(amounts, sorted[0].amount, 0.1);
          return result;
        }


        function displayXNPVResults(xnpv, regularNPV, rate, cashFlows) {
          const resultsDiv = document.getElementById('xnpvxirrResults');
          const comparisonDiv = document.getElementById('comparisonSection');
          
          // ========== FUND-GRADE PRECISION CALCULATIONS ==========
          // S·ª≠ d·ª•ng roundFinancial ƒë·ªÉ lo·∫°i b·ªè floating point errors
          const precisionDifference = roundFinancial(xnpv - regularNPV, 2);
          
          // X·ª≠ l√Ω edge case: regularNPV g·∫ßn b·∫±ng 0
          const absRegularNPV = Math.abs(regularNPV);
          let percentDiff = 0;
          let percentDiffDisplay = '0%';
          let showPercentDiff = true;
          
          if (absRegularNPV > 1e-6) { // Threshold: $0.000001
            const rawPercent = (precisionDifference / absRegularNPV) * 100;
            percentDiff = roundFinancial(rawPercent, 2);
            percentDiffDisplay = `${percentDiff >= 0 ? '+' : ''}${Math.abs(percentDiff).toFixed(1)}%`;
          } else {
            // NPV qu√° nh·ªè, kh√¥ng t√≠nh % diff
            showPercentDiff = false;
            percentDiffDisplay = 'N/A (NPV ‚âà 0)';
          }
          
          // ========== PROFESSIONAL FORMATTING ==========
          // Format t·ª± ƒë·ªông ch·ªçn ƒë∆°n v·ªã (K/M/B)
          const formatFinancialValue = (value) => {
            const absValue = Math.abs(value);
            
            if (absValue >= 1e12) { // Trillion
              return `${value >= 0 ? '+' : '-'}$${(absValue / 1e12).toFixed(3)}T`;
            } else if (absValue >= 1e9) { // Billion
              return `${value >= 0 ? '+' : '-'}$${(absValue / 1e9).toFixed(3)}B`;
            } else if (absValue >= 1e6) { // Million
              return `${value >= 0 ? '+' : '-'}$${(absValue / 1e6).toFixed(3)}M`;
            } else if (absValue >= 1e3) { // Thousand
              return `${value >= 0 ? '+' : '-'}$${(absValue / 1e3).toFixed(1)}K`;
            } else {
              return `${value >= 0 ? '+' : '-'}$${absValue.toFixed(2)}`;
            }
          };
          
          const xnpvFormatted = formatFinancialValue(xnpv);
          const regularNPVFormatted = formatFinancialValue(regularNPV);
          const differenceFormatted = formatFinancialValue(precisionDifference);
          
          // ========== CASH FLOW SIGN VALIDATION ==========
          // Ki·ªÉm tra pattern cash flow (fund-grade requirement)
          let cashFlowPattern = 'Valid';
          let cashFlowPatternColor = 'var(--green-600)';
          let cashFlowPatternIcon = '‚úÖ';
          
          const amounts = cashFlows.map(cf => cf.amount);
          const positiveFlows = amounts.filter(a => a > 0);
          const negativeFlows = amounts.filter(a => a < 0);
          
          if (positiveFlows.length === 0 || negativeFlows.length === 0) {
            cashFlowPattern = 'Invalid: Need both + and - cash flows';
            cashFlowPatternColor = 'var(--red-600)';
            cashFlowPatternIcon = '‚ö†Ô∏è';
          } else if (amounts[0] >= 0) {
            // Warning: First cash flow should ideally be negative (investment)
            cashFlowPattern = 'Warning: First CF should be negative (investment)';
            cashFlowPatternColor = 'var(--orange-600)';
            cashFlowPatternIcon = '‚ö†Ô∏è';
          }
          
          // ========== RENDER RESULTS ==========
          resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--indigo-800);">
              üìä XNPV Results (Finance-Grade)
            </h3>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: linear-gradient(135deg, var(--indigo-100), var(--indigo-200));
                          padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid var(--indigo-400);">
                <div style="font-size: 0.875rem; color: var(--indigo-700); margin-bottom: 0.5rem; font-weight: 600;">
                  XNPV (Exact Dates)
                </div>
                <div style="font-size: 2rem; font-weight: 800; color: ${xnpv >= 0 ? 'var(--green-700)' : 'var(--red-700)'};">
                  ${xnpvFormatted}
                </div>
              </div>

              <div style="background: var(--slate-100); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">
                  Discount Rate
                </div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--slate-700);">
                  ${formatPercent(rate, 2)}
                </div>
              </div>

              <div style="background: var(--slate-100); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">
                  Cash Flow Pattern
                </div>
                <div style="font-size: 1.25rem; font-weight: 600; color: ${cashFlowPatternColor}; margin-top: 0.5rem;">
                  ${cashFlowPatternIcon} ${cashFlowPattern}
                </div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${positiveFlows.length}+ / ${negativeFlows.length}- flows
                </div>
              </div>
            </div>

            <!-- Data Quality Check -->
            <div style="background: var(--blue-50); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--blue-500);">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M8 13A5 5 0 1 1 8 3a5 5 0 0 1 0 10zm0-1A4 4 0 1 0 8 4a4 4 0 0 0 0 8z"/>
                  <path d="M9.5 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                </svg>
                <strong style="color: var(--blue-800);">Data Quality & Precision</strong>
              </div>
              <div style="font-size: 0.875rem; color: var(--blue-700);">
                ‚Ä¢ XNPV precision: ${formatCurrency(xnpv)}<br>
                ‚Ä¢ Regular NPV precision: ${formatCurrency(regularNPV)}<br>
                ‚Ä¢ Difference: ${formatCurrency(precisionDifference)}<br>
                ‚Ä¢ Tolerance threshold: $${(1e-6).toFixed(6)}
              </div>
            </div>

            ${renderCashFlowTimeline(cashFlows)}
          `;

          // ========== COMPARISON SECTION ==========
          const impactAnalysis = getImpactAnalysis(precisionDifference, percentDiff, showPercentDiff);
          
          comparisonDiv.innerHTML = `
            <div style="background: linear-gradient(135deg, var(--orange-50), var(--red-50));
                        padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--orange-500);">
              <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--orange-900); margin-bottom: 1rem;">
                ‚ö†Ô∏è XNPV vs Regular NPV Comparison (Finance-Grade Analysis)
              </h4>

              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center; border: 1px solid var(--indigo-200);">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">XNPV (Exact Dates)</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                    ${xnpvFormatted}
                  </div>
                  <div style="font-size: 0.7rem; color: var(--slate-500); margin-top: 0.25rem;">Professional standard</div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center; border: 1px solid var(--slate-200);">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">NPV (Annual)</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--slate-600);">
                    ${regularNPVFormatted}
                  </div>
                  <div style="font-size: 0.7rem; color: var(--slate-500); margin-top: 0.25rem;">Academic/simple</div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center; border: 1px solid ${precisionDifference >= 0 ? 'var(--green-200)' : 'var(--red-200)'}">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">Difference</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: ${precisionDifference >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                    ${differenceFormatted}
                  </div>
                  <div style="font-size: 0.75rem; color: ${precisionDifference >= 0 ? 'var(--green-600)' : 'var(--red-600)'}">
                    ${showPercentDiff ? `(${percentDiffDisplay})` : percentDiffDisplay}
                  </div>
                </div>
              </div>

              <div style="background: var(--orange-50); padding: 1.25rem; border-radius: 0.5rem; margin-top: 1rem; font-size: 0.875rem; line-height: 1.6;">
                <strong>üî• ${impactAnalysis.title}</strong><br>
                ${impactAnalysis.description}
                <br><br>
                <strong>üìà Deal Impact Assessment:</strong><br>
                ${impactAnalysis.dealImpact}
              </div>

              <!-- Decision Framework -->
              <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: 0.5rem; border: 1px solid var(--slate-200);">
                <div style="font-weight: 600; color: var(--slate-700); margin-bottom: 0.5rem;">üí° Finance Decision Framework:</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div style="background: var(--indigo-50); padding: 0.75rem; border-radius: 0.375rem;">
                    <strong style="color: var(--indigo-700);">Use XNPV when (Professional):</strong><br>
                    ‚Ä¢ Real deals with specific dates<br>
                    ‚Ä¢ PE/VC fund performance & carry calculations<br>
                    ‚Ä¢ Real estate development & construction draws<br>
                    ‚Ä¢ Bridge/short-term financing<br>
                    ‚Ä¢ Dividend recaps & waterfalls<br>
                    ‚Ä¢ Project finance with drawdown schedules
                  </div>
                  <div style="background: var(--slate-100); padding: 0.75rem; border-radius: 0.375rem;">
                    <strong style="color: var(--slate-700);">Use NPV when (Simplified):</strong><br>
                    ‚Ä¢ Academic exercises & classroom models<br>
                    ‚Ä¢ Quarterly/annual planning (not day-specific)<br>
                    ‚Ä¢ Back-of-envelope estimates<br>
                    ‚Ä¢ Standard bond pricing (regular coupons)<br>
                    ‚Ä¢ Simple DCF models for screening<br>
                    ‚Ä¢ Early-stage opportunity analysis
                  </div>
                </div>
                
                <!-- Decision Rule -->
                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50); border-radius: 0.375rem; border-left: 3px solid var(--green-500);">
                  <strong style="color: var(--green-800);">üìã Fund Decision Rule:</strong><br>
                  <span style="font-size: 0.8rem; color: var(--green-700);">
                    If |XNPV - NPV| > ${formatCurrency(100000)} <strong>OR</strong> |% diff| > 5% ‚Üí 
                    <strong>Use XNPV for final decision</strong> (material difference)
                  </span>
                </div>
              </div>
            </div>
          `;

          resultsDiv.classList.remove('hidden');
          comparisonDiv.classList.remove('hidden');
          
          // Save state
          setTimeout(() => {
            StorageManager.saveCalculatorState('xnpv-xirr');
          }, 100);
        }

        // ========== HELPER FUNCTIONS ==========
        /**
         * Analyze impact for professional reporting
         */
        function getImpactAnalysis(difference, percentDiff, showPercentDiff) {
          const absDifference = Math.abs(difference);
          const absPercentDiff = Math.abs(percentDiff);
          
          if (!showPercentDiff) {
            return {
              title: "Critical: NPV ‚âà 0, XNPV Provides Real Value",
              description: `Regular NPV is effectively zero (below materiality threshold), but XNPV shows ${difference >= 0 ? 'positive' : 'negative'} value of ${formatCurrency(difference)}.`,
              dealImpact: `This could completely change deal evaluation. Regular NPV suggests "break-even" while XNPV indicates ${difference >= 0 ? 'a GO decision' : 'a NO GO decision'}.`
            };
          }
          
          if (absPercentDiff > 10) {
            return {
              title: "Material Difference (>10%) - Regular NPV is Misleading",
              description: `Regular NPV is off by <strong>${absPercentDiff.toFixed(1)}%</strong> ‚Äî this level of difference would require disclosure in investment committee memos and could change hurdle rate analysis.`,
              dealImpact: `Using regular NPV could lead to ${difference >= 0 ? 'under-valuation and missed opportunities' : 'over-valuation and poor investment decisions'}. At deal sizes >$10M, this represents ${formatCurrency(absDifference)} in potential ${difference >= 0 ? 'missed value' : 'value destruction'}.`
            };
          } else if (absPercentDiff > 5) {
            return {
              title: "Significant Difference (5-10%) - Professional Models Required",
              description: `Difference of <strong>${absPercentDiff.toFixed(1)}%</strong> is material for institutional investing. Most funds require XNPV for any difference >5%.`,
              dealImpact: `At typical fund sizes, this ${absPercentDiff.toFixed(1)}% difference could impact carried interest calculations by ~${(absPercentDiff * 0.2).toFixed(1)}% of total gains.`
            };
          } else if (absPercentDiff > 2) {
            return {
              title: "Noticeable Difference (2-5%) - Precision Matters",
              description: `Difference of <strong>${absPercentDiff.toFixed(1)}%</strong>, while not deal-breaking, demonstrates why professional models use exact dates.`,
              dealImpact: `In competitive processes, this level of precision could be the difference between winning and losing a deal.`
            };
          } else {
            return {
              title: "Minimal Difference (<2%) - Both Methods Comparable",
              description: `Difference of <strong>${absPercentDiff.toFixed(1)}%</strong> is within acceptable tolerance for most screening purposes.`,
              dealImpact: `For this specific cash flow pattern, simplified NPV provides reasonable approximation. However, still use XNPV for final documentation.`
            };
          }
        }

        /**
         * Format large financial values with automatic unit selection
         * Fund-grade: K/M/B/T with appropriate decimals
         */
        function formatLargeFinancial(value) {
          const absValue = Math.abs(value);
          
          if (absValue >= 1e12) { // Trillion
            return `${value >= 0 ? '+' : '-'}$${(absValue / 1e12).toFixed(3)}T`;
          } else if (absValue >= 1e9) { // Billion
            return `${value >= 0 ? '+' : '-'}$${(absValue / 1e9).toFixed(3)}B`;
          } else if (absValue >= 1e6) { // Million
            return `${value >= 0 ? '+' : '-'}$${(absValue / 1e6).toFixed(3)}M`;
          } else if (absValue >= 1e3) { // Thousand
            return `${value >= 0 ? '+' : '-'}$${(absValue / 1e3).toFixed(1)}K`;
          } else {
            return `${value >= 0 ? '+' : '-'}$${absValue.toFixed(2)}`;
          }
        }



        function displayXIRRResults(xirrResult, regularIRR, cashFlows) {
          const resultsDiv = document.getElementById('xnpvxirrResults');
          const comparisonDiv = document.getElementById('comparisonSection');
          
          if (!xirrResult.success) {
            resultsDiv.innerHTML = `
              <div style="background: var(--red-50); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--red-800); margin-bottom: 0.75rem;">
                  XIRR Calculation Failed
                </h4>
                <p style="color: var(--red-700); margin-bottom: 1rem;">
                  ${xirrResult.message}
                </p>
                <div style="font-size: 0.875rem; color: var(--slate-600);">
                  Common issues:<br>
                  ‚Ä¢ All cash flows have same sign<br>
                  ‚Ä¢ Extreme/unrealistic cash flow patterns<br>
                  ‚Ä¢ Date parsing errors
                </div>
              </div>
            `;
            resultsDiv.classList.remove('hidden');
            return;
          }

          const xirr = xirrResult.xirr;
          const annualizedReturn = roundFinancial((Math.pow(1 + xirr, 1) - 1) * 100, 2);
          
          // Calculate difference vs regular IRR v·ªõi precision
          let regularIRRValue = 0;
          let regularIRRAnnual = 0;
          let difference = 0;
          let percentDiff = 0;
          
          if (regularIRR.success) {
            regularIRRValue = roundFinancial(regularIRR.irr, 8);
            regularIRRAnnual = roundFinancial(regularIRR.irr * 100, 2);
            difference = roundFinancial(annualizedReturn - regularIRRAnnual, 2);
            percentDiff = regularIRRAnnual !== 0 ? roundFinancial((difference / Math.abs(regularIRRAnnual)) * 100, 2) : 0;
          }

          // T√≠nh time-weighted return v·ªõi precision
          const timeWeightedReturn = roundFinancial((Math.pow(1 + xirr, 365) - 1) * 100, 0);
          
          resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--emerald-800);">
              ‚ö° XIRR Results (Precision-Enhanced)
            </h3>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: linear-gradient(135deg, var(--emerald-100), var(--green-200));
                          padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid var(--emerald-400);">
                <div style="font-size: 0.875rem; color: var(--emerald-700); margin-bottom: 0.5rem; font-weight: 600;">
                  XIRR (Exact Dates)
                </div>
                <div style="font-size: 2.5rem; font-weight: 800; color: ${annualizedReturn >= 0 ? 'var(--emerald-700)' : 'var(--red-700)'};">
                  ${annualizedReturn >= 0 ? '+' : ''}${formatPercent(annualizedReturn/100, 2)}
                </div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  ${xirrResult.iterations} iterations ‚Ä¢ ${xirrResult.method || 'newton-raphson'}
                </div>
              </div>

              <div style="background: var(--slate-100); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">
                  XNPV @ XIRR
                </div>
                <div style="font-size: 2rem; font-weight: 800; color: ${financialEquals(xirrResult.xnpv, 0, 1e-6) ? 'var(--green-700)' : 'var(--slate-700)'}">
                  ${financialEquals(xirrResult.xnpv, 0, 1e-6) ? '‚úì $0.00' : formatCurrency(xirrResult.xnpv)}
                </div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Convergence check
                </div>
              </div>

              <div style="background: var(--slate-100); padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 0.5rem; font-weight: 600;">
                  Cash Flow Period
                </div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--slate-700);">
                  ${calculateHoldingPeriod(cashFlows)}
                </div>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Days invested
                </div>
              </div>
            </div>

            <!-- Precision Info Box -->
            <div style="background: var(--blue-50); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid var(--blue-500);">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M8 13A5 5 0 1 1 8 3a5 5 0 0 1 0 10zm0-1A4 4 0 1 0 8 4a4 4 0 0 0 0 8z"/>
                  <path d="M9.5 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                </svg>
                <strong style="color: var(--blue-800);">Precision Information</strong>
              </div>
              <div style="font-size: 0.875rem; color: var(--blue-700);">
                ‚Ä¢ IRR precision: ${(xirr * 100).toFixed(8)}% (8 decimal places)<br>
                ‚Ä¢ XNPV at IRR: ${formatCurrency(xirrResult.xnpv)}<br>
                ‚Ä¢ Tolerance used: ${(1e-9).toExponential()}<br>
                ‚Ä¢ Method: ${xirrResult.method || 'newton-raphson'}
              </div>
            </div>

            ${renderCashFlowTimeline(cashFlows, xirr)}
          `;

          comparisonDiv.innerHTML = `
            <div style="background: linear-gradient(135deg, var(--purple-50), var(--indigo-50));
                        padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--purple-500);">
              <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--purple-900); margin-bottom: 1rem;">
                ‚ö° XIRR vs Regular IRR Comparison
              </h4>

              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">XIRR (Exact)</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--emerald-700);">
                    ${formatPercent(annualizedReturn/100, 2)}
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">IRR (Annual)</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--slate-600);">
                    ${regularIRR.success ? formatPercent(regularIRRAnnual/100, 2) : 'N/A'}
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Difference</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: ${difference >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                    ${regularIRR.success ? `${difference >= 0 ? '+' : ''}${formatPercent(Math.abs(difference)/100, 2)}` : 'N/A'}
                    <div style="font-size: 0.75rem; color: ${difference >= 0 ? 'var(--green-600)' : 'var(--red-600)'}">
                      ${regularIRR.success ? `${Math.abs(percentDiff).toFixed(1)}% vs regular` : ''}
                    </div>
                  </div>
                </div>
              </div>

              <div style="background: var(--purple-50); padding: 1.25rem; border-radius: 0.5rem; margin-top: 1rem; font-size: 0.875rem; line-height: 1.6;">
                <strong>üéØ Why XIRR is the professional standard:</strong><br>
                ${
                  Math.abs(difference) > 50 
                    ? `Regular IRR is off by <strong>${Math.abs(difference).toFixed(1)} bps</strong> ‚Äî in PE/VC, this determines whether you hit your hurdle rate and earn carry.`
                    : Math.abs(difference) > 20
                    ? `Difference of <strong>${Math.abs(difference).toFixed(1)} bps</strong> could mean millions in performance fees on a large fund.`
                    : `Even a ${Math.abs(difference).toFixed(1)} bps difference matters for performance benchmarking in institutional investing.`
                }
                <br><br>
                <strong>üìä Fund performance implications:</strong>
                ${
                  annualizedReturn >= 8 && annualizedReturn < 20
                    ? `This <strong>${formatPercent(annualizedReturn/100, 1)} XIRR</strong> clears the typical 8% preferred return hurdle. LPs get their pref, then GP gets ${formatPercent(Math.max(0, (annualizedReturn - 8) * 0.2)/100, 1)} in carried interest.`
                    : annualizedReturn >= 20
                    ? `Exceptional <strong>${formatPercent(annualizedReturn/100, 1)} XIRR</strong>! GP carry would be 20% of ${formatPercent((annualizedReturn - 8)/100, 1)} = ${formatPercent(((annualizedReturn - 8) * 0.2)/100, 1)} of total gains.`
                    : `At <strong>${formatPercent(annualizedReturn/100, 1)} XIRR</strong>, GP doesn't earn carry (below 8% hurdle).`
                }
              </div>

              <!-- XIRR Sensitivity Analysis -->
              <div style="margin-top: 1.5rem; padding: 1.5rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                <h5 style="font-size: 1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
                  üî¨ XIRR Sensitivity Analysis
                </h5>
                ${renderXIRRSensitivity(cashFlows, xirr)}
              </div>

              <!-- Professional Insights -->
              <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, var(--blue-50), var(--cyan-50));
                          border-radius: 0.75rem; border-left: 4px solid var(--blue-600);">
                <h5 style="font-size: 1rem; font-weight: 700; color: var(--blue-900); margin-bottom: 0.75rem;">
                  üíº Professional Insights
                </h5>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                  <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;">
                    <strong style="color: var(--blue-700); display: block; margin-bottom: 0.5rem;">PE/VC Funds</strong>
                    <div style="font-size: 0.75rem; line-height: 1.4;">
                      ‚Ä¢ XIRR determines carry (typically 20% above 8% pref)<br>
                      ‚Ä¢ Quarterly performance reporting to LPs<br>
                      ‚Ä¢ Waterfall calculations<br>
                      ‚Ä¢ TVPI calculation component
                    </div>
                  </div>
                  
                  <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;">
                    <strong style="color: var(--green-700); display: block; margin-bottom: 0.5rem;">Real Estate</strong>
                    <div style="font-size: 0.75rem; line-height: 1.4;">
                      ‚Ä¢ Equity multiple vs IRR analysis<br>
                      ‚Ä¢ Construction draw schedule impact<br>
                      ‚Ä¢ Refinancing timing optimization<br>
                      ‚Ä¢ Lease commencement dates
                    </div>
                  </div>
                  
                  <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;">
                    <strong style="color: var(--purple-700); display: block; margin-bottom: 0.5rem;">Project Finance</strong>
                    <div style="font-size: 0.75rem; line-height: 1.4;">
                      ‚Ä¢ Loan drawdown/repayment timing<br>
                      ‚Ä¢ Revenue commencement dates<br>
                      ‚Ä¢ Debt service coverage ratios<br>
                      ‚Ä¢ Refinancing options analysis
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          resultsDiv.classList.remove('hidden');
          comparisonDiv.classList.remove('hidden');
          
          // Save state
          setTimeout(() => {
            StorageManager.saveCalculatorState('xnpv-xirr');
          }, 100);
        }

        function renderCashFlowTimeline(cashFlows, xirr = null) {
          const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
          const startDate = sorted[0].date;
          const endDate = sorted[sorted.length - 1].date;
          const totalDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
          
          return `
            <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--slate-200); margin-bottom: 1.5rem;">
              <h4 style="font-size: 1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
                üìÖ Cash Flow Timeline
              </h4>
              
              <div style="position: relative; height: 40px; background: var(--slate-100); border-radius: 0.5rem; margin-bottom: 1rem; overflow: hidden;">
                ${sorted.map((cf, index) => {
                  const daysFromStart = (cf.date - startDate) / (1000 * 60 * 60 * 24);
                  const position = (daysFromStart / totalDays) * 100;
                  const isNegative = cf.amount < 0;
                  
                  return `
                    <div style="position: absolute; left: ${position}%; top: 50%; transform: translate(-50%, -50%);">
                      <div style="width: 12px; height: 12px; border-radius: 50%; 
                                  background: ${isNegative ? 'var(--red-500)' : 'var(--green-500)'};
                                  border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"
                            title="${formatDate(cf.date)}: $${(cf.amount / 1000).toFixed(0)}K">
                      </div>
                      <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); 
                                  font-size: 0.7rem; white-space: nowrap; color: var(--slate-600);">
                        ${formatDate(cf.date).split(' ')[0]}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              
              <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">
                <div>${formatDate(startDate)}</div>
                <div>${formatDate(endDate)}</div>
              </div>
              
              <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--red-500); border: 2px solid white;"></div>
                  <span style="font-size: 0.75rem; color: var(--slate-600);">Outflow (Investment)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--green-500); border: 2px solid white;"></div>
                  <span style="font-size: 0.75rem; color: var(--slate-600);">Inflow (Return)</span>
                </div>
              </div>
            </div>
          `;
        }

        function renderXIRRSensitivity(cashFlows, baseXIRR) {
          // Test how XIRR changes with timing shifts
          const scenarios = [
            { label: 'Exit 30 days later', daysShift: 30 },
            { label: 'Investment 15 days earlier', daysShift: -15 },
            { label: 'Dividend 45 days delay', daysShift: 45 },
          ];
          
          const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
          const results = [];
          
          for (const scenario of scenarios) {
            const modifiedCFs = sorted.map((cf, index) => {
              const cfCopy = { ...cf };
              
              // LOGIC FIXED: Ph√¢n bi·ªát d√≤ng ti·ªÅn c·∫ßn thay ƒë·ªïi
              const isInvestmentScenario = scenario.label.includes("Investment");
              const isExitScenario = scenario.label.includes("Exit");
              const isDividendScenario = scenario.label.includes("Dividend");
              
              let shouldShift = false;
              
              if (isInvestmentScenario) {
                // D·ªãch chuy·ªÉn ng√†y cho D√íNG TI·ªÄN √ÇM (ƒë·∫ßu t∆∞)
                shouldShift = cf.amount < 0;
              } else if (isExitScenario) {
                // D·ªãch chuy·ªÉn ng√†y cho D√íNG TI·ªÄN D∆Ø∆†NG L·ªöN NH·∫§T (tho√°t v·ªën)
                shouldShift = cf.amount > 0;
              } else if (isDividendScenario) {
                // D·ªãch chuy·ªÉn ng√†y cho T·∫§T C·∫¢ d√≤ng ti·ªÅn d∆∞∆°ng TR·ª™ d√≤ng tho√°t v·ªën
                // (c·ªï t·ª©c th∆∞·ªùng l√† c√°c kho·∫£n nh·ªè ƒë·ªãnh k·ª≥)
                shouldShift = cf.amount > 0 && index !== sorted.length - 1; // Gi·∫£ s·ª≠ d√≤ng tho√°t l√† cu·ªëi c√πng
              }
              
              if (shouldShift) {
                cfCopy.date = new Date(cf.date);
                cfCopy.date.setDate(cfCopy.date.getDate() + scenario.daysShift);
              }
              return cfCopy;
            });
            
            const result = calculateXIRR(modifiedCFs, baseXIRR);
            if (result.success) {
              results.push({
                scenario: scenario.label,
                xirr: result.xirr,
                annualized: (Math.pow(1 + result.xirr, 1) - 1) * 100,
                change: ((result.xirr - baseXIRR) / baseXIRR) * 100,
                daysShift: scenario.daysShift,
              });
            }
          }
          
          if (results.length === 0) return '<p style="color: var(--slate-600); text-align: center;">Sensitivity analysis not available</p>';
          
          return `
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                <thead>
                  <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Scenario</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">New XIRR</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Annualized</th>
                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Change</th>
                  </tr>
                </thead>
                <tbody>
                  ${results.map(r => `
                    <tr style="border-bottom: 1px solid var(--slate-200);">
                      <td style="padding: 0.75rem;">
                        ${r.scenario}
                        <br>
                        <small style="color: var(--slate-500); font-size: 0.75rem;">
                          ${r.daysShift > 0 ? `+${r.daysShift} days` : `${r.daysShift} days`}
                        </small>
                      </td>
                      <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: ${r.xirr >= baseXIRR ? 'var(--green-700)' : 'var(--red-700)'}">
                        ${(r.xirr * 100).toFixed(2)}%
                      </td>
                      <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                        ${r.annualized.toFixed(2)}%
                      </td>
                      <td style="padding: 0.75rem; text-align: right; font-weight: 700; color: ${r.change >= 0 ? 'var(--green-700)' : 'var(--red-700)'}">
                        ${r.change >= 0 ? '+' : ''}${r.change.toFixed(2)}%
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 1rem; padding: 1rem; background: var(--purple-50); border-radius: 0.5rem; font-size: 0.75rem;">
              <strong>‚úì ƒê√∫ng v·ªÅ m·∫∑t T√†i ch√≠nh:</strong> 
              <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li><strong>ƒê·∫ßu t∆∞ s·ªõm h∆°n</strong> (ti·ªÅn ra s·ªõm) ‚Üí Ti·ªÅn b·ªã ch√¥n l√¢u h∆°n ‚Üí IRR <strong style="color: var(--red-700);">gi·∫£m</strong> ‚úì</li>
                <li><strong>Tho√°t v·ªën tr·ªÖ h∆°n</strong> (ti·ªÅn v√†o tr·ªÖ) ‚Üí Ti·ªÅn v·ªÅ mu·ªôn h∆°n ‚Üí IRR <strong style="color: var(--red-700);">gi·∫£m</strong> ‚úì</li>
                <li><strong>C·ªï t·ª©c tr·ªÖ h∆°n</strong> (ti·ªÅn v√†o tr·ªÖ) ‚Üí Ti·ªÅn v·ªÅ mu·ªôn h∆°n ‚Üí IRR <strong style="color: var(--red-700);">gi·∫£m</strong> ‚úì</li>
              </ul>
              <em>Nguy√™n t·∫Øc c·ªët l√µi: <strong>Ti·ªÅn ra c√†ng mu·ªôn c√†ng t·ªët, ti·ªÅn v√†o c√†ng s·ªõm c√†ng t·ªët</strong>.
              M·ªçi thay ƒë·ªïi l√†m tr·ªÖ d√≤ng ti·ªÅn v√†o ho·∫∑c ƒë·∫©y nhanh d√≤ng ti·ªÅn ra ƒë·ªÅu l√†m gi·∫£m IRR.</em>
            </div>
          `;
        }


        /**
         * Calculate holding period with precision
         */
        function calculateHoldingPeriod(cashFlows) {
          if (cashFlows.length < 2) return '0 days';
          
          const sorted = [...cashFlows].sort((a, b) => a.date - b.date);
          const startDate = sorted[0].date;
          const endDate = sorted[sorted.length - 1].date;
          
          const milliseconds = endDate - startDate;
          const days = milliseconds / (1000 * 60 * 60 * 24);
          
          // Excel-style calculation
          if (days >= 365.25) {
            const years = (days / 365.25).toFixed(2);
            return `${years} years (${Math.round(days)} days)`;
          } else if (days >= 30.44) {
            const months = (days / 30.44).toFixed(1);
            return `${months} months (${Math.round(days)} days)`;
          } else {
            return `${Math.round(days)} days`;
          }
        }

        // Initialize with custom scenario
        loadScenario('custom');
      }             

      function setupNPVIRRCalculator() {
        const cashFlowsContainer =
          document.getElementById("cashFlowsContainer");
        const calculateBtn = document.getElementById("calculateNPV");
        const resultsDiv = document.getElementById("npvResults");

        // Create 5 cash flow inputs
        for (let i = 1; i <= 5; i++) {
          const div = document.createElement("div");
          div.innerHTML = `
                          <label class="form-label">Year ${i}</label>
                          <input type="number" class="form-input cash-flow-input" id="cf${i}" placeholder="25000">
                      `;
          cashFlowsContainer.appendChild(div);
        }

        calculateBtn.addEventListener("click", () => {
          const initialInvestment = parseFloat(
            document.getElementById("initialInvestment").value
          );
          const discountRate =
            parseFloat(document.getElementById("discountRate").value) / 100;

          if (isNaN(initialInvestment) || isNaN(discountRate)) {
            alert(
              "Please enter valid numbers for initial investment and discount rate."
            );
            return;
          }

          // Get cash flows
          const cashFlows = [];
          for (let i = 1; i <= 5; i++) {
            const cf = parseFloat(document.getElementById(`cf${i}`).value);
            if (isNaN(cf)) {
              alert(`Please enter a valid number for Year ${i} cash flow.`);
              return;
            }
            cashFlows.push(cf);
          }

          // Calculate NPV
          let npv = -initialInvestment;
          for (let i = 0; i < cashFlows.length; i++) {
            npv += cashFlows[i] / Math.pow(1 + discountRate, i + 1);
          }

          // Calculate IRR using the fixed function
          const allCashFlows = [-Math.abs(initialInvestment), ...cashFlows];
          const irrResult = calculateIRR(allCashFlows, 0.1);

          if (!irrResult.success) {
            resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--rose-100);">
                                  <div class="result-label">NPV</div>
                                  <div class="result-value">$${npv.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--orange-100);">
                                  <div class="result-label">IRR</div>
                                  <div class="result-error">${
                                    irrResult.message
                                  }</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Initial Investment</div>
                                  <div class="result-value">$${initialInvestment.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Discount Rate</div>
                                  <div class="result-value">${(
                                    discountRate * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;
          } else {
            const irr = irrResult.irr;
            resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--rose-100);">
                                  <div class="result-label">NPV</div>
                                  <div class="result-value">$${npv.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--pink-100);">
                                  <div class="result-label">IRR</div>
                                  <div class="result-value">${(
                                    irr * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Initial Investment</div>
                                  <div class="result-value">$${initialInvestment.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Discount Rate</div>
                                  <div class="result-value">${(
                                    discountRate * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;
          }
          resultsDiv.classList.remove("hidden");

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('npv-irr');
          }, 100);
        });
      }




      // ==================== ADVANCED CALCULATORS ====================
      // --- Black-Scholes Calculator ---
      function renderBlackScholesCalculator() {
        return `
                      <h2 class="calculator-title">Black-Scholes Option Pricing Model</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Options Valuation
                          </div>
                          <p class="explanation-text">
                              The <strong>Black-Scholes model</strong> is a mathematical model for pricing options contracts. It calculates the theoretical price of European-style options
                              (which can only be exercised at expiration) using current stock prices, expected dividends, the option's strike price, expected interest rates, time to expiration, and expected volatility.
                          </p>
                          <p class="explanation-text">
                              The model assumes that the price of heavily traded assets follows a geometric Brownian motion with constant drift and volatility.
                              It revolutionized options trading by providing a standardized way to price options.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> The "Greeks" (Delta, Gamma, Theta, Vega, Rho) measure different dimensions of risk in option positions and are derived from the Black-Scholes model.
                          </div>
                      </div>
                      <div class="options-toggle">
                          <button class="option-btn active" id="callOption">Call Option</button>
                          <button class="option-btn" id="putOption">Put Option</button>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Current Stock Price ($)</label>
                              <input type="number" id="stockPrice" class="form-input" placeholder="100">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Strike Price ($)</label>
                              <input type="number" id="strikePrice" class="form-input" placeholder="100">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Time to Expiration (Years)</label>
                              <input type="number" id="timeToExp" class="form-input" placeholder="1" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Risk-free Rate (%)</label>
                              <input type="number" id="bsRiskFreeRate" class="form-input" placeholder="5" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Volatility (%)</label>
                              <input type="number" id="volatility" class="form-input" placeholder="20" step="0.1">
                          </div>
                      </div>
                      <button class="btn btn-primary" id="calculateBS">Calculate Option Price</button>
                      <div id="bsResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      // Improved Normal CDF with higher accuracy
      function normalCDF(x) {
        // Approximation by Abramowitz and Stegun (1964)
        // Accuracy: 7.5e-8 (much better than current 0.5%)

        const sign = x >= 0 ? 1 : -1;
        x = Math.abs(x) / Math.sqrt(2);

        // Constants
        const a1 = 0.254829592;
        const a2 = -0.284496736;
        const a3 = 1.421413741;
        const a4 = -1.453152027;
        const a5 = 1.061405429;
        const p = 0.3275911;

        const t = 1 / (1 + p * x);
        const erfApprox =
          1 -
          ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

        return 0.5 * (1 + sign * erfApprox);
      }

      // Normal PDF for Greeks calculation
      function normalPDF(x) {
        return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
      }

      // Greeks calculation
      function calculateGreeks(S, K, T, r, sigma, isCall) {
        const d1 =
          (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) /
          (sigma * Math.sqrt(T));
        const d2 = d1 - sigma * Math.sqrt(T);

        const Nd1 = normalCDF(d1);
        const Nd2 = normalCDF(d2);
        const nd1 = normalPDF(d1);

        // Delta: Rate of change of option price with respect to stock price
        const delta = isCall ? Nd1 : Nd1 - 1;

        // Gamma: Rate of change of delta with respect to stock price
        const gamma = nd1 / (S * sigma * Math.sqrt(T));

        // Theta: Rate of change of option price with respect to time (per day)
        const theta1 = -(S * nd1 * sigma) / (2 * Math.sqrt(T));
        const theta2 = isCall
          ? -r * K * Math.exp(-r * T) * Nd2
          : r * K * Math.exp(-r * T) * normalCDF(-d2);
        const theta = (theta1 + theta2) / 365; // Per day

        // Vega: Rate of change of option price with respect to volatility
        const vega = (S * nd1 * Math.sqrt(T)) / 100; // Per 1% change in volatility

        // Rho: Rate of change of option price with respect to interest rate
        const rho = isCall
          ? (K * T * Math.exp(-r * T) * Nd2) / 100
          : -(K * T * Math.exp(-r * T) * normalCDF(-d2)) / 100;

        return { delta, gamma, theta, vega, rho };
      }

      function setupBlackScholesCalculator() {
        const callOption = document.getElementById("callOption");
        const putOption = document.getElementById("putOption");
        const calculateBtn = document.getElementById("calculateBS");
        const resultsDiv = document.getElementById("bsResults");

        let isCall = true;

        callOption.addEventListener("click", () => {
          callOption.classList.add("active");
          putOption.classList.remove("active");
          isCall = true;
        });

        putOption.addEventListener("click", () => {
          putOption.classList.add("active");
          callOption.classList.remove("active");
          isCall = false;
        });

        calculateBtn.addEventListener("click", () => {
          const S = parseFloat(document.getElementById("stockPrice").value);
          const K = parseFloat(document.getElementById("strikePrice").value);
          const T = parseFloat(document.getElementById("timeToExp").value);
          const r =
            parseFloat(document.getElementById("bsRiskFreeRate").value) / 100;
          const sigma =
            parseFloat(document.getElementById("volatility").value) / 100;

          if (
            isNaN(S) ||
            isNaN(K) ||
            isNaN(T) ||
            isNaN(r) ||
            isNaN(sigma) ||
            S <= 0 ||
            K <= 0 ||
            T <= 0 ||
            sigma <= 0
          ) {
            alert("Please enter valid positive numbers.");
            return;
          }

          const d1 =
            (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) /
            (sigma * Math.sqrt(T));
          const d2 = d1 - sigma * Math.sqrt(T);

          const Nd1 = normalCDF(d1);
          const Nd2 = normalCDF(d2);
          const Nminusd1 = normalCDF(-d1);
          const Nminusd2 = normalCDF(-d2);

          let optionPrice;
          if (isCall) {
            optionPrice = S * Nd1 - K * Math.exp(-r * T) * Nd2;
          } else {
            optionPrice = K * Math.exp(-r * T) * Nminusd2 - S * Nminusd1;
          }

          // Calculate Greeks
          const greeks = calculateGreeks(S, K, T, r, sigma, isCall);

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--indigo-100);">
                                  <div class="result-label">${
                                    isCall ? "Call" : "Put"
                                  } Price</div>
                                  <div class="result-value">$${optionPrice.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--blue-100);">
                                  <div class="result-label">Delta (Œî)</div>
                                  <div class="result-value">${greeks.delta.toFixed(
                                    4
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--cyan-100);">
                                  <div class="result-label">Gamma (Œì)</div>
                                  <div class="result-value">${greeks.gamma.toFixed(
                                    4
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--green-100);">
                                  <div class="result-label">Theta (Œò)</div>
                                  <div class="result-value">$${greeks.theta.toFixed(
                                    2
                                  )}/day</div>
                              </div>
                              <div class="result-card" style="background-color: var(--purple-100);">
                                  <div class="result-label">Vega (ŒΩ)</div>
                                  <div class="result-value">$${greeks.vega.toFixed(
                                    2
                                  )}</div>
                              </div>
                              <div class="result-card" style="background-color: var(--pink-100);">
                                  <div class="result-label">Rho (œÅ)</div>
                                  <div class="result-value">$${greeks.rho.toFixed(
                                    2
                                  )}</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('black-scholes');
          }, 100);
        });
      }



      // --- WACC Calculator ---
      function renderWACCCalculator() {
        return `
                      <h2 class="calculator-title">Weighted Average Cost of Capital (WACC)</h2>
                      <div class="explanation-box">
                          <div class="explanation-title">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Company's Cost of Capital
                          </div>
                          <p class="explanation-text">
                              <strong>Weighted Average Cost of Capital (WACC)</strong> represents a firm's average after-tax cost of capital from all sources, including common stock, preferred stock, bonds, and other forms of debt.
                              It is the minimum return a company must earn on its existing asset base to satisfy its creditors, owners, and other providers of capital.
                          </p>
                          <p class="explanation-text">
                              Companies use WACC as a hurdle rate for evaluating investment opportunities. Projects with returns below WACC would destroy value, while those with returns above WACC would create value.
                          </p>
                          <div class="explanation-note">
                              <strong>Financial Insight:</strong> WACC is widely used in discounted cash flow (DCF) analysis as the discount rate. A lower WACC makes future cash flows more valuable, increasing the perceived value of a company.
                          </div>
                      </div>
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">Market Value of Equity ($)</label>
                              <input type="number" id="marketValueEquity" class="form-input" placeholder="500000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Market Value of Debt ($)</label>
                              <input type="number" id="marketValueDebt" class="form-input" placeholder="300000">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Cost of Equity (%)</label>
                              <input type="number" id="costOfEquity" class="form-input" placeholder="12" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Cost of Debt (%)</label>
                              <input type="number" id="costOfDebt" class="form-input" placeholder="6" step="0.01">
                          </div>
                          <div class="form-group">
                              <label class="form-label">Tax Rate (%)</label>
                              <input type="number" id="taxRate" class="form-input" placeholder="30" step="0.1">
                          </div>
                      </div>
                      <button class="btn btn-success" id="calculateWACC">Calculate WACC</button>
                      <div id="waccResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50);">
                          <!-- Results will be populated here -->
                      </div>
                  `;
      }

      function setupWACCCalculator() {
        const calculateBtn = document.getElementById("calculateWACC");
        const resultsDiv = document.getElementById("waccResults");

        calculateBtn.addEventListener("click", () => {
          const E = parseFloat(
            document.getElementById("marketValueEquity").value
          );
          const D = parseFloat(
            document.getElementById("marketValueDebt").value
          );
          const Re =
            parseFloat(document.getElementById("costOfEquity").value) / 100;
          const Rd =
            parseFloat(document.getElementById("costOfDebt").value) / 100;
          const T = parseFloat(document.getElementById("taxRate").value) / 100;

          if (
            isNaN(E) ||
            isNaN(D) ||
            isNaN(Re) ||
            isNaN(Rd) ||
            isNaN(T) ||
            E < 0 ||
            D < 0 ||
            Re < 0 ||
            Rd < 0 ||
            T < 0 ||
            T > 100
          ) {
            alert("Please enter valid numbers.");
            return;
          }

          const V = E + D;

          // WACC = (E/V √ó Re) + ((D/V √ó Rd) √ó (1-T))
          const wacc = (E / V) * Re + (D / V) * Rd * (1 - T);
          const equityWeight = E / V;
          const debtWeight = D / V;
          const afterTaxCostOfDebt = Rd * (1 - T);

          resultsDiv.innerHTML = `
                          <div class="results-grid">
                              <div class="result-card" style="background-color: var(--green-100);">
                                  <div class="result-label">WACC</div>
                                  <div class="result-value">${(
                                    wacc * 100
                                  ).toFixed(2)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Equity Weight</div>
                                  <div class="result-value">${(
                                    equityWeight * 100
                                  ).toFixed(1)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">Debt Weight</div>
                                  <div class="result-value">${(
                                    debtWeight * 100
                                  ).toFixed(1)}%</div>
                              </div>
                              <div class="result-card" style="background-color: var(--slate-100);">
                                  <div class="result-label">After-tax Cost of Debt</div>
                                  <div class="result-value">${(
                                    afterTaxCostOfDebt * 100
                                  ).toFixed(2)}%</div>
                              </div>
                          </div>
                      `;

          resultsDiv.classList.remove("hidden");
          
          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('wacc');
          }, 100);
        });
      }      


      // --- DCF Valuation Calculator ---
      function renderDCFCalculator() {
        return `
                <h2 class="calculator-title">Discounted Cash Flow (DCF) Valuation</h2>
                <div class="explanation-box">
                  <div class="explanation-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Enterprise Valuation Model
                  </div>
                  <p class="explanation-text">
                    <strong>DCF Valuation</strong> determines a company's intrinsic value by calculating the present value of its expected future cash flows.
                    This is the most widely used valuation method in investment banking, private equity, and equity research.
                  </p>
                  <p class="explanation-text">
                    The model projects Free Cash Flows (FCF) for a forecast period (typically 5-10 years), then estimates a Terminal Value
                    to capture all cash flows beyond the forecast period. Both are discounted back to present value using WACC.
                  </p>
                  <div class="explanation-note">
                    <strong>PE/IB Insight:</strong> DCF is highly sensitive to assumptions (growth rate, WACC, terminal value).
                    Always perform sensitivity analysis on key variables. A 1% change in WACC can swing valuation by 10-15%.
                  </div>
                </div>

                <div class="options-toggle">
                  <button class="option-btn active" id="terminalGrowth">Perpetuity Growth</button>
                  <button class="option-btn" id="terminalMultiple">Exit Multiple</button>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Initial FCF ($M)</label>
                    <input type="number" id="initialFCF" class="form-input" placeholder="100" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">FCF Growth Rate (%)</label>
                    <input type="number" id="fcfGrowthRate" class="form-input" placeholder="8" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Forecast Period (Years)</label>
                    <input type="number" id="forecastPeriod" class="form-input" placeholder="5" min="1" max="20">
                  </div>
                  <div class="form-group">
                    <label class="form-label">WACC / Discount Rate (%)</label>
                    <input type="number" id="dcfWACC" class="form-input" placeholder="10" step="0.1">
                  </div>
                  <div class="form-group" id="terminalGrowthInput">
                    <label class="form-label">Terminal Growth Rate (%)</label>
                    <input type="number" id="terminalGrowthRate" class="form-input" placeholder="3" step="0.1">
                  </div>
                  <div class="form-group hidden" id="terminalMultipleInput">
                    <label class="form-label">Exit EV/EBITDA Multiple</label>
                    <input type="number" id="exitMultiple" class="form-input" placeholder="10" step="0.1">
                  </div>
                  <div class="form-group hidden" id="terminalEBITDAInput">
                    <label class="form-label">Terminal Year EBITDA ($M)</label>
                    <input type="number" id="terminalEBITDA" class="form-input" placeholder="150" step="0.1">
                  </div>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Cash & Equivalents ($M)</label>
                    <input type="number" id="cashEquiv" class="form-input" placeholder="50" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Total Debt ($M)</label>
                    <input type="number" id="totalDebt" class="form-input" placeholder="200" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Shares Outstanding (M)</label>
                    <input type="number" id="sharesOut" class="form-input" placeholder="100" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Minority Interest ($M)</label>
                    <input type="number" id="minorityInterest" class="form-input" placeholder="0" step="0.1">
                  </div>
                </div>

                <button class="btn btn-primary" id="calculateDCF">Calculate Enterprise & Equity Value</button>

                <div id="dcfResults" class="results-container hidden" style="border-color: var(--indigo-100); background-color: var(--indigo-50);">
                  <!-- Results will be populated here -->
                </div>

                <div id="dcfBreakdown" class="hidden" style="margin-top: 2rem; padding: 1.5rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                  <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--slate-700);">Cash Flow Projection</h3>
                  <div style="overflow-x: auto;">
                    <table id="fcfTable" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <!-- Table will be populated here -->
                    </table>
                  </div>
                </div>
              `;
      }

      function setupDCFCalculator() {
        const terminalGrowthBtn = document.getElementById("terminalGrowth");
        const terminalMultipleBtn = document.getElementById("terminalMultiple");
        const terminalGrowthInput = document.getElementById(
          "terminalGrowthInput"
        );
        const terminalMultipleInput = document.getElementById(
          "terminalMultipleInput"
        );
        const terminalEBITDAInput = document.getElementById(
          "terminalEBITDAInput"
        );
        const calculateBtn = document.getElementById("calculateDCF");
        const resultsDiv = document.getElementById("dcfResults");
        const breakdownDiv = document.getElementById("dcfBreakdown");

        let usePerpetuityGrowth = true;

        // Toggle between terminal value methods
        terminalGrowthBtn.addEventListener("click", () => {
          terminalGrowthBtn.classList.add("active");
          terminalMultipleBtn.classList.remove("active");
          terminalGrowthInput.classList.remove("hidden");
          terminalMultipleInput.classList.add("hidden");
          terminalEBITDAInput.classList.add("hidden");
          usePerpetuityGrowth = true;
        });

        terminalMultipleBtn.addEventListener("click", () => {
          terminalMultipleBtn.classList.add("active");
          terminalGrowthBtn.classList.remove("active");
          terminalGrowthInput.classList.add("hidden");
          terminalMultipleInput.classList.remove("hidden");
          terminalEBITDAInput.classList.remove("hidden");
          usePerpetuityGrowth = false;
        });

        calculateBtn.addEventListener("click", () => {
          // Get inputs
          const initialFCF = parseFloat(
            document.getElementById("initialFCF").value
          );
          const fcfGrowthRate =
            parseFloat(document.getElementById("fcfGrowthRate").value) / 100;
          const forecastPeriod = parseInt(
            document.getElementById("forecastPeriod").value
          );
          const wacc =
            parseFloat(document.getElementById("dcfWACC").value) / 100;
          const cash = parseFloat(document.getElementById("cashEquiv").value);
          const debt = parseFloat(document.getElementById("totalDebt").value);
          const shares = parseFloat(document.getElementById("sharesOut").value);
          const minorityInt =
            parseFloat(document.getElementById("minorityInterest").value) || 0;

          // Validate inputs
          if (
            isNaN(initialFCF) ||
            isNaN(fcfGrowthRate) ||
            isNaN(forecastPeriod) ||
            isNaN(wacc) ||
            isNaN(cash) ||
            isNaN(debt) ||
            isNaN(shares)
          ) {
            alert("Please enter valid numbers for all required fields.");
            return;
          }

          if (forecastPeriod < 1 || forecastPeriod > 20) {
            alert("Forecast period must be between 1 and 20 years.");
            return;
          }

          if (wacc <= 0) {
            alert("WACC must be positive.");
            return;
          }

          // Project FCFs
          const fcfs = [];
          const pvFCFs = [];
          let cumulativePVFCF = 0;

          for (let year = 1; year <= forecastPeriod; year++) {
            const fcf = initialFCF * Math.pow(1 + fcfGrowthRate, year);
            const pvFCF = fcf / Math.pow(1 + wacc, year);
            fcfs.push(fcf);
            pvFCFs.push(pvFCF);
            cumulativePVFCF += pvFCF;
          }

          // Calculate Terminal Value
          let terminalValue, terminalValuePV;

          if (usePerpetuityGrowth) {
            const terminalGrowthRate =
              parseFloat(document.getElementById("terminalGrowthRate").value) /
              100;

            if (isNaN(terminalGrowthRate)) {
              alert("Please enter a valid terminal growth rate.");
              return;
            }

            if (terminalGrowthRate >= wacc) {
              alert(
                "Terminal growth rate must be less than WACC. Typically 2-3% (GDP growth rate)."
              );
              return;
            }

            const finalYearFCF = fcfs[fcfs.length - 1];
            const terminalYearFCF = finalYearFCF * (1 + terminalGrowthRate);

            // Gordon Growth Model: TV = FCF(t+1) / (WACC - g)
            terminalValue = terminalYearFCF / (wacc - terminalGrowthRate);
            terminalValuePV =
              terminalValue / Math.pow(1 + wacc, forecastPeriod);
          } else {
            const exitMultiple = parseFloat(
              document.getElementById("exitMultiple").value
            );
            const terminalEBITDA = parseFloat(
              document.getElementById("terminalEBITDA").value
            );

            if (isNaN(exitMultiple) || isNaN(terminalEBITDA)) {
              alert("Please enter valid exit multiple and terminal EBITDA.");
              return;
            }

            if (exitMultiple <= 0) {
              alert("Exit multiple must be positive.");
              return;
            }

            // TV = Exit Multiple √ó Terminal Year EBITDA
            terminalValue = exitMultiple * terminalEBITDA;
            terminalValuePV =
              terminalValue / Math.pow(1 + wacc, forecastPeriod);
          }

          // Calculate Enterprise Value
          const enterpriseValue = cumulativePVFCF + terminalValuePV;

          // Calculate Equity Value
          const equityValue = enterpriseValue + cash - debt - minorityInt;

          // Calculate per share value
          const valuePerShare = equityValue / shares;

          // Display results
          const tvPercentage = (terminalValuePV / enterpriseValue) * 100;

          resultsDiv.innerHTML = `
                  <div class="results-grid">
                    <div class="result-card" style="background-color: var(--indigo-100);">
                      <div class="result-label">Enterprise Value</div>
                      <div class="result-value">$${enterpriseValue.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--blue-100);">
                      <div class="result-label">Equity Value</div>
                      <div class="result-value">$${equityValue.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--cyan-100);">
                      <div class="result-label">Value per Share</div>
                      <div class="result-value">$${valuePerShare.toFixed(
                        2
                      )}</div>
                    </div>
                    <div class="result-card" style="background-color: var(--green-100);">
                      <div class="result-label">PV of Forecast FCFs</div>
                      <div class="result-value">$${cumulativePVFCF.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--emerald-100);">
                      <div class="result-label">Terminal Value (PV)</div>
                      <div class="result-value">$${terminalValuePV.toFixed(
                        1
                      )}M</div>
                    </div>
                    <div class="result-card" style="background-color: var(--slate-100);">
                      <div class="result-label">TV % of Total</div>
                      <div class="result-value">${tvPercentage.toFixed(
                        1
                      )}%</div>
                    </div>
                  </div>
                  <div style="margin-top: 1rem; padding: 1rem; background: var(--blue-50); border-radius: 0.5rem; border-left: 3px solid var(--blue-500);">
                    <div style="font-size: 0.875rem; color: var(--slate-700);">
                      <strong>Bridge to Equity Value:</strong><br>
                      Enterprise Value: $${enterpriseValue.toFixed(1)}M<br>
                      + Cash: $${cash.toFixed(1)}M<br>
                      ‚àí Debt: $${debt.toFixed(1)}M<br>
                      ${
                        minorityInt > 0
                          ? `‚àí Minority Interest: $${minorityInt.toFixed(
                              1
                            )}M<br>`
                          : ""
                      }
                      = Equity Value: $${equityValue.toFixed(1)}M
                    </div>
                  </div>
                `;

          resultsDiv.classList.remove("hidden");

          // Build FCF projection table
          let tableHTML = `
                  <thead>
                    <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Year</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">FCF ($M)</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Growth Rate</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Discount Factor</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">PV of FCF ($M)</th>
                    </tr>
                  </thead>
                  <tbody>
                `;

          for (let year = 1; year <= forecastPeriod; year++) {
            const discountFactor = 1 / Math.pow(1 + wacc, year);
            const growthRate = year === 1 ? fcfGrowthRate : fcfGrowthRate;

            tableHTML += `
                    <tr style="border-bottom: 1px solid var(--slate-200);">
                      <td style="padding: 0.75rem; font-weight: 500;">Year ${year}</td>
                      <td style="padding: 0.75rem; text-align: right;">$${fcfs[
                        year - 1
                      ].toFixed(1)}</td>
                      <td style="padding: 0.75rem; text-align: right;">${(
                        growthRate * 100
                      ).toFixed(1)}%</td>
                      <td style="padding: 0.75rem; text-align: right;">${discountFactor.toFixed(
                        4
                      )}</td>
                      <td style="padding: 0.75rem; text-align: right;">$${pvFCFs[
                        year - 1
                      ].toFixed(1)}</td>
                    </tr>
                  `;
          }

          tableHTML += `
                  <tr style="border-top: 2px solid var(--slate-300); background: var(--slate-50); font-weight: 600;">
                    <td style="padding: 0.75rem;" colspan="4">PV of Forecast Period FCFs</td>
                    <td style="padding: 0.75rem; text-align: right;">$${cumulativePVFCF.toFixed(
                      1
                    )}</td>
                  </tr>
                  <tr style="background: var(--indigo-50); font-weight: 600;">
                    <td style="padding: 0.75rem;">Terminal Value</td>
                    <td style="padding: 0.75rem; text-align: right;">$${terminalValue.toFixed(
                      1
                    )}</td>
                    <td style="padding: 0.75rem; text-align: right;" colspan="2">
                      ${
                        usePerpetuityGrowth
                          ? `Perpetuity @ ${parseFloat(
                              document.getElementById("terminalGrowthRate")
                                .value
                            ).toFixed(1)}%`
                          : `${parseFloat(
                              document.getElementById("exitMultiple").value
                            ).toFixed(1)}x EBITDA`
                      }
                    </td>
                    <td style="padding: 0.75rem; text-align: right;">$${terminalValuePV.toFixed(
                      1
                    )}</td>
                  </tr>
                  <tr style="border-top: 2px solid var(--indigo-500); background: var(--indigo-100); font-weight: 700; font-size: 1rem;">
                    <td style="padding: 1rem;" colspan="4">Enterprise Value</td>
                    <td style="padding: 1rem; text-align: right;">$${enterpriseValue.toFixed(
                      1
                    )}</td>
                  </tr>
                </tbody>
                `;

          document.getElementById("fcfTable").innerHTML = tableHTML;
          breakdownDiv.classList.remove("hidden");

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('dcf');
          }, 100);
        });
      }


      // ==================== LBO MODEL CODE ====================

      function renderLBOCalculator() {
        return `
                <h2 class="calculator-title">Advanced Leveraged Buyout (LBO) Model</h2>
                <div class="explanation-box">
                  <div class="explanation-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Institutional-Grade LBO Model
                  </div>
                  <p class="explanation-text">
                    Advanced LBO model with multi-tranche debt structure, management incentives, dividend recaps,
                    and 3-scenario analysis. This model reflects real PE deal dynamics including covenants,
                    cash sweeps, and realistic exit strategies.
                  </p>
                  <div class="explanation-note">
                    <strong>PE Best Practice:</strong> Always model Base/Upside/Downside scenarios. Target IRR 20-25%+
                    with 2.5-3.0x+ MOIC. Returns come from: (1) Multiple expansion, (2) EBITDA growth, (3) Deleveraging.
                  </div>
                </div>

                <!-- Transaction Structure Section -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  üìä Transaction Structure
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">LTM EBITDA ($M)</label>
                    <input type="number" id="lboEBITDA" class="form-input" value="100" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Entry EV/EBITDA Multiple</label>
                    <input type="number" id="entryMultiple" class="form-input" value="10.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Transaction Fees (% of EV)</label>
                    <input type="number" id="transFees" class="form-input" value="2.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Existing Cash ($M)</label>
                    <input type="number" id="existingCash" class="form-input" value="10" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Minimum Cash ($M)</label>
                    <input type="number" id="minCash" class="form-input" value="10" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Hold Period (Years)</label>
                    <input type="number" id="holdPeriod" class="form-input" value="5" min="3" max="10">
                  </div>
                </div>

                <!-- Debt Structure Section -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  üí∞ Multi-Tranche Debt Structure
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Revolver (x EBITDA)</label>
                    <input type="number" id="revolverMultiple" class="form-input" value="0.5" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Revolver Rate (SOFR + bps)</label>
                    <input type="number" id="revolverRate" class="form-input" value="450" step="25">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Commitment Fee (%)</label>
                    <input type="number" id="commitmentFee" class="form-input" value="0.5" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Term Loan B (x EBITDA)</label>
                    <input type="number" id="tlbMultiple" class="form-input" value="4.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">TLB Rate (SOFR + bps)</label>
                    <input type="number" id="tlbRate" class="form-input" value="500" step="25">
                  </div>
                  <div class="form-group">
                    <label class="form-label">TLB Amortization (%/year)</label>
                    <input type="number" id="tlbAmort" class="form-input" value="1.0" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Mezzanine (x EBITDA)</label>
                    <input type="number" id="mezzMultiple" class="form-input" value="1.5" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Mezz Rate (%)</label>
                    <input type="number" id="mezzRate" class="form-input" value="11.0" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">PIK Toggle (%)</label>
                    <input type="number" id="pikToggle" class="form-input" value="50" step="10">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Base SOFR (%)</label>
                    <input type="number" id="baseSofr" class="form-input" value="4.5" step="0.25">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Max Net Leverage (Year 1)</label>
                    <input type="number" id="maxLevY1" class="form-input" value="6.0" step="0.25">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Max Net Leverage (Year 5)</label>
                    <input type="number" id="maxLevY5" class="form-input" value="4.0" step="0.25">
                  </div>
                </div>

                <!-- Management Equity Section -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  üëî Management Equity Structure
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Management Rollover (%)</label>
                    <input type="number" id="mgmtRollover" class="form-input" value="15" step="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Sweet Equity Pool (%)</label>
                    <input type="number" id="sweetEquity" class="form-input" value="10" step="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Sweet Equity Discount (%)</label>
                    <input type="number" id="sweetDiscount" class="form-input" value="50" step="5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Options Pool (%)</label>
                    <input type="number" id="optionsPool" class="form-input" value="5" step="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Option Strike (% of FMV)</label>
                    <input type="number" id="optionStrike" class="form-input" value="100" step="5">
                  </div>
                </div>

                <!-- Operating Assumptions - Base Case -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  üìà Operating Assumptions (Base Case)
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Revenue Growth Y1 (%)</label>
                    <input type="number" id="revenueGrowthY1" class="form-input" value="8" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Revenue Growth Y2-Y5 (%)</label>
                    <input type="number" id="revenueGrowthSteady" class="form-input" value="5" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">EBITDA Margin Y1 (%)</label>
                    <input type="number" id="ebitdaMarginY1" class="form-input" value="20" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">EBITDA Margin Y5 (%)</label>
                    <input type="number" id="ebitdaMarginY5" class="form-input" value="23" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">D&A (% of Revenue)</label>
                    <input type="number" id="daPercent" class="form-input" value="3.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">CapEx (% of Revenue)</label>
                    <input type="number" id="capexPercent" class="form-input" value="2.0" step="0.1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">NWC (% of Revenue)</label>
                    <input type="number" id="nwcPercent" class="form-input" value="10" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Tax Rate (%)</label>
                    <input type="number" id="taxRate" class="form-input" value="25" step="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Exit Multiple (Base)</label>
                    <input type="number" id="exitMultipleBase" class="form-input" value="10.0" step="0.5">
                  </div>
                </div>

                <!-- Scenario Adjustments -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  üéØ Scenario Adjustments
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Upside: Growth Delta (%)</label>
                    <input type="number" id="upsideGrowth" class="form-input" value="2" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Upside: Multiple Delta (x)</label>
                    <input type="number" id="upsideMultiple" class="form-input" value="1.0" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Downside: Growth Delta (%)</label>
                    <input type="number" id="downsideGrowth" class="form-input" value="-2" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Downside: Multiple Delta (x)</label>
                    <input type="number" id="downsideMultiple" class="form-input" value="-1.0" step="0.5">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Downside: Rate Increase (bps)</label>
                    <input type="number" id="downsideRate" class="form-input" value="200" step="50">
                  </div>
                </div>

                <!-- Dividend Recap Section -->
                <h3 style="font-size: 1.1rem; font-weight: 600; margin: 1.5rem 0 1rem 0; color: var(--slate-700);">
                  üíµ Dividend Recapitalization (Optional)
                </h3>
                <div style="margin-bottom: 1rem;">
                  <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="enableRecap" style="width: 20px; height: 20px;">
                    <span style="font-weight: 500;">Enable Dividend Recap</span>
                  </label>
                </div>
                <div class="form-grid" id="recapInputs" style="display: none;">
                  <div class="form-group">
                    <label class="form-label">Recap Year</label>
                    <input type="number" id="recapYear" class="form-input" value="3" min="2" max="4">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Additional Debt (x EBITDA)</label>
                    <input type="number" id="recapDebtMultiple" class="form-input" value="1.0" step="0.25">
                  </div>
                </div>

                <button class="btn btn-success" id="calculateLBO" style="margin-top: 1.5rem;">
                  üöÄ Run LBO Model (3 Scenarios)
                </button>

                <!-- Results Sections -->
                <div id="lboScenarioResults" class="results-container hidden" style="border-color: var(--green-100); background-color: var(--green-50); margin-top: 2rem;">
                  <!-- Scenario comparison will be populated here -->
                </div>

                <div id="lboDetailedResults" class="hidden" style="margin-top: 2rem;">
                  <!-- Detailed results tabs for each scenario -->
                </div>
              `;
      }

      function setupLBOCalculator() {
        // Toggle recap inputs
        document
          .getElementById("enableRecap")
          .addEventListener("change", (e) => {
            document.getElementById("recapInputs").style.display = e.target
              .checked
              ? "grid"
              : "none";
          });

        document
          .getElementById("calculateLBO")
          .addEventListener("click", () => {
            runLBOModel();

            // Save state after calculation
            setTimeout(() => {
              StorageManager.saveCalculatorState('lbo');
            }, 100);
          });
      }

      function runLBOModel() {
        // Get all inputs
        const inputs = getModelInputs();

        // Validate inputs
        if (!validateInputs(inputs)) {
          return;
        }

        // Run 3 scenarios
        const scenarios = {
          base: calculateScenario(inputs, "base"),
          upside: calculateScenario(inputs, "upside"),
          downside: calculateScenario(inputs, "downside"),
        };

        // Display results
        displayScenarioComparison(scenarios);
        displayDetailedResults(scenarios, inputs);
      }

      function getModelInputs() {
        return {
          // Transaction
          ltmEBITDA: parseFloat(document.getElementById("lboEBITDA").value),
          entryMultiple: parseFloat(
            document.getElementById("entryMultiple").value
          ),
          transFees:
            parseFloat(document.getElementById("transFees").value) / 100,
          existingCash: parseFloat(
            document.getElementById("existingCash").value
          ),
          minCash: parseFloat(document.getElementById("minCash").value),
          holdPeriod: parseInt(document.getElementById("holdPeriod").value),

          // Debt structure
          revolverMultiple: parseFloat(
            document.getElementById("revolverMultiple").value
          ),
          revolverRate:
            parseFloat(document.getElementById("revolverRate").value) / 10000,
          commitmentFee:
            parseFloat(document.getElementById("commitmentFee").value) / 100,
          tlbMultiple: parseFloat(document.getElementById("tlbMultiple").value),
          tlbRate: parseFloat(document.getElementById("tlbRate").value) / 10000,
          tlbAmort: parseFloat(document.getElementById("tlbAmort").value) / 100,
          mezzMultiple: parseFloat(
            document.getElementById("mezzMultiple").value
          ),
          mezzRate: parseFloat(document.getElementById("mezzRate").value) / 100,
          pikToggle:
            parseFloat(document.getElementById("pikToggle").value) / 100,
          baseSofr: parseFloat(document.getElementById("baseSofr").value) / 100,
          maxLevY1: parseFloat(document.getElementById("maxLevY1").value),
          maxLevY5: parseFloat(document.getElementById("maxLevY5").value),

          // Management equity
          mgmtRollover:
            parseFloat(document.getElementById("mgmtRollover").value) / 100,
          sweetEquity:
            parseFloat(document.getElementById("sweetEquity").value) / 100,
          sweetDiscount:
            parseFloat(document.getElementById("sweetDiscount").value) / 100,
          optionsPool:
            parseFloat(document.getElementById("optionsPool").value) / 100,
          optionStrike:
            parseFloat(document.getElementById("optionStrike").value) / 100,

          // Operating assumptions
          revenueGrowthY1:
            parseFloat(document.getElementById("revenueGrowthY1").value) / 100,
          revenueGrowthSteady:
            parseFloat(document.getElementById("revenueGrowthSteady").value) /
            100,
          ebitdaMarginY1:
            parseFloat(document.getElementById("ebitdaMarginY1").value) / 100,
          ebitdaMarginY5:
            parseFloat(document.getElementById("ebitdaMarginY5").value) / 100,
          daPercent:
            parseFloat(document.getElementById("daPercent").value) / 100,
          capexPercent:
            parseFloat(document.getElementById("capexPercent").value) / 100,
          nwcPercent:
            parseFloat(document.getElementById("nwcPercent").value) / 100,
          taxRate: parseFloat(document.getElementById("taxRate").value) / 100,
          exitMultipleBase: parseFloat(
            document.getElementById("exitMultipleBase").value
          ),

          // Scenarios
          upsideGrowth:
            parseFloat(document.getElementById("upsideGrowth").value) / 100,
          upsideMultiple: parseFloat(
            document.getElementById("upsideMultiple").value
          ),
          downsideGrowth:
            parseFloat(document.getElementById("downsideGrowth").value) / 100,
          downsideMultiple: parseFloat(
            document.getElementById("downsideMultiple").value
          ),
          downsideRate:
            parseFloat(document.getElementById("downsideRate").value) / 10000,

          // Recap
          enableRecap: document.getElementById("enableRecap").checked,
          recapYear: parseInt(document.getElementById("recapYear").value),
          recapDebtMultiple: parseFloat(
            document.getElementById("recapDebtMultiple").value
          ),
        };
      }

      function validateInputs(inputs) {
        if (isNaN(inputs.ltmEBITDA) || inputs.ltmEBITDA <= 0) {
          alert("Please enter a valid LTM EBITDA");
          return false;
        }

        if (inputs.holdPeriod < 3 || inputs.holdPeriod > 10) {
          alert("Hold period must be between 3 and 10 years");
          return false;
        }

        const totalLeverage =
          inputs.revolverMultiple + inputs.tlbMultiple + inputs.mezzMultiple;
        if (totalLeverage < 2 || totalLeverage > 10) {
          alert("Total leverage should be between 2x and 10x EBITDA");
          return false;
        }

        const totalMgmtEquity =
          inputs.mgmtRollover + inputs.sweetEquity + inputs.optionsPool;
        if (totalMgmtEquity > 0.4) {
          alert("Total management equity cannot exceed 40%");
          return false;
        }

        return true;
      }

      function calculateScenario(inputs, scenarioType) {
        // Adjust inputs based on scenario
        const adjustedInputs = adjustForScenario(inputs, scenarioType);

        // Step 1: Calculate purchase price and sources/uses
        const transaction = calculateTransaction(adjustedInputs);

        // Step 2: Project financials
        const projections = projectFinancials(adjustedInputs, transaction);

        // Step 3: Calculate exit value and returns
        const returns = calculateReturns(
          adjustedInputs,
          transaction,
          projections
        );

        // Step 4: Calculate management returns
        const mgmtReturns = calculateManagementReturns(
          adjustedInputs,
          transaction,
          returns
        );

        return {
          transaction,
          projections,
          returns,
          mgmtReturns,
          inputs: adjustedInputs,
        };
      }

      function adjustForScenario(inputs, scenarioType) {
        const adjusted = { ...inputs };

        if (scenarioType === "upside") {
          adjusted.revenueGrowthY1 += inputs.upsideGrowth;
          adjusted.revenueGrowthSteady += inputs.upsideGrowth;
          adjusted.exitMultipleBase += inputs.upsideMultiple;
        } else if (scenarioType === "downside") {
          adjusted.revenueGrowthY1 += inputs.downsideGrowth;
          adjusted.revenueGrowthSteady += inputs.downsideGrowth;
          adjusted.exitMultipleBase += inputs.downsideMultiple;
          adjusted.revolverRate += inputs.downsideRate;
          adjusted.tlbRate += inputs.downsideRate;
        }

        return adjusted;
      }

      function calculateTransaction(inputs) {
        const purchaseEV = inputs.ltmEBITDA * inputs.entryMultiple;
        const transFees = purchaseEV * inputs.transFees;
        const totalUses = purchaseEV + transFees;

        // Debt sizing
        const revolver = inputs.ltmEBITDA * inputs.revolverMultiple;
        const tlb = inputs.ltmEBITDA * inputs.tlbMultiple;
        const mezz = inputs.ltmEBITDA * inputs.mezzMultiple;
        const totalDebt = revolver + tlb + mezz;

        // Equity calculation
        const purchaseEquity =
          totalUses - totalDebt - inputs.existingCash + inputs.minCash;
        const rolloverValue = purchaseEquity * inputs.mgmtRollover;
        const sponsorEquity = purchaseEquity - rolloverValue;

        // FMV per share (for sweet equity and options)
        const fmvPerShare = purchaseEquity; // Simplified
        const sweetEquityStrike = fmvPerShare * (1 - inputs.sweetDiscount);
        const optionStrike = fmvPerShare * inputs.optionStrike;

        // Ownership structure
        const sponsorOwnership =
          1 - inputs.mgmtRollover - inputs.sweetEquity - inputs.optionsPool;

        return {
          purchaseEV,
          transFees,
          totalUses,
          revolver,
          tlb,
          mezz,
          totalDebt,
          purchaseEquity,
          rolloverValue,
          sponsorEquity,
          fmvPerShare,
          sweetEquityStrike,
          optionStrike,
          sponsorOwnership,
          totalLeverage: totalDebt / inputs.ltmEBITDA,
        };
      }

      function projectFinancials(inputs, transaction) {
        const years = [];
        let currentRevenue = inputs.ltmEBITDA / inputs.ebitdaMarginY1;
        let prevNWC = currentRevenue * inputs.nwcPercent;

        // Covenant step-down
        const covenantStepDown =
          (inputs.maxLevY1 - inputs.maxLevY5) / (inputs.holdPeriod - 1);

        // Debt balances
        let revolverBalance = transaction.revolver;
        let tlbBalance = transaction.tlb;
        let mezzBalance = transaction.mezz;

        let recapDividend = 0;

        for (let year = 1; year <= inputs.holdPeriod; year++) {
          // Revenue growth
          const growthRate =
            year === 1 ? inputs.revenueGrowthY1 : inputs.revenueGrowthSteady;
          const revenue = currentRevenue * (1 + growthRate);

          // EBITDA margin expansion
          const marginProgress = (year - 1) / (inputs.holdPeriod - 1);
          const ebitdaMargin =
            inputs.ebitdaMarginY1 +
            (inputs.ebitdaMarginY5 - inputs.ebitdaMarginY1) * marginProgress;
          const ebitda = revenue * ebitdaMargin;

          // Operating metrics
          const depreciation = revenue * inputs.daPercent;
          const ebit = ebitda - depreciation;

          // Interest calculation
          const sofrRate = inputs.baseSofr;
          const revolverInterest =
            revolverBalance * (sofrRate + inputs.revolverRate);
          const commitmentFeeAmount =
            (transaction.revolver - revolverBalance) * inputs.commitmentFee;
          const tlbInterest = tlbBalance * (sofrRate + inputs.tlbRate);

          // Mezz interest with PIK toggle
          const mezzCashInterest =
            mezzBalance * inputs.mezzRate * (1 - inputs.pikToggle);
          const mezzPIKInterest =
            mezzBalance * inputs.mezzRate * inputs.pikToggle;

          const totalInterest =
            revolverInterest +
            commitmentFeeAmount +
            tlbInterest +
            mezzCashInterest;

          const ebt = ebit - totalInterest;
          const taxes = Math.max(0, ebt * inputs.taxRate);
          const netIncome = ebt - taxes;

          // Cash flow
          const capex = revenue * inputs.capexPercent;
          const nwc = revenue * inputs.nwcPercent;
          const changeInNWC = nwc - prevNWC;

          // Free cash flow
          const fcf = netIncome + depreciation - capex - changeInNWC;

          // Mandatory amortization
          const tlbAmortization = transaction.tlb * inputs.tlbAmort;

          // Cash sweep (excess FCF to debt paydown)
          let cashAvailable = fcf - tlbAmortization;

          // Dividend recap
          let recapAmount = 0;
          if (inputs.enableRecap && year === inputs.recapYear) {
            const recapDebt = ebitda * inputs.recapDebtMultiple;
            const proformaLeverage =
              (tlbBalance + mezzBalance + recapDebt) / ebitda;
            const maxLeverage = inputs.maxLevY1 - covenantStepDown * (year - 1);

            if (proformaLeverage <= maxLeverage) {
              recapAmount = recapDebt;
              tlbBalance += recapDebt;
              cashAvailable -= recapAmount;
              recapDividend = recapAmount;
            }
          }

          // Debt paydown waterfall
          const revolverPaydown = Math.min(
            revolverBalance,
            Math.max(0, cashAvailable)
          );
          cashAvailable -= revolverPaydown;
          revolverBalance -= revolverPaydown;

          const tlbPaydown =
            tlbAmortization +
            Math.min(tlbBalance - tlbAmortization, Math.max(0, cashAvailable));
          cashAvailable -= tlbPaydown - tlbAmortization;
          tlbBalance -= tlbPaydown;

          // Mezz PIK accretion
          mezzBalance += mezzPIKInterest;

          const totalDebtBalance = revolverBalance + tlbBalance + mezzBalance;
          const netLeverage = totalDebtBalance / ebitda;
          const maxLeverage = inputs.maxLevY1 - covenantStepDown * (year - 1);
          const covenantCompliance = netLeverage <= maxLeverage;

          years.push({
            year,
            revenue,
            ebitda,
            ebitdaMargin,
            depreciation,
            ebit,
            totalInterest,
            ebt,
            taxes,
            netIncome,
            capex,
            changeInNWC,
            fcf,
            tlbAmortization,
            revolverPaydown,
            tlbPaydown,
            mezzPIKInterest,
            recapAmount,
            revolverBalance,
            tlbBalance,
            mezzBalance,
            totalDebtBalance,
            netLeverage,
            maxLeverage,
            covenantCompliance,
          });

          currentRevenue = revenue;
          prevNWC = nwc;
        }

        return { years, recapDividend };
      }

      function calculateReturns(inputs, transaction, projections) {
        const finalYear = projections.years[projections.years.length - 1];

        // Exit value
        const exitEBITDA = finalYear.ebitda;
        const exitEV = exitEBITDA * inputs.exitMultipleBase;
        const exitDebt = finalYear.totalDebtBalance;
        const exitEquityValue = exitEV - exitDebt;

        // Sponsor returns
        const sponsorExitValue = exitEquityValue * transaction.sponsorOwnership;
        const sponsorInvested = transaction.sponsorEquity;
        const sponsorProfit =
          sponsorExitValue - sponsorInvested + projections.recapDividend;
        const sponsorMoM =
          (sponsorExitValue + projections.recapDividend) / sponsorInvested;

        // IRR calculation
        const cashFlows = [-sponsorInvested];
        for (let i = 1; i < inputs.holdPeriod; i++) {
          const yearCF =
            i === inputs.recapYear && inputs.enableRecap
              ? projections.recapDividend
              : 0;
          cashFlows.push(yearCF);
        }
        cashFlows.push(sponsorExitValue);

        const sponsorIRR = calculateIRR(cashFlows);

        // Value creation bridge
        const entryEV = transaction.purchaseEV;
        const ebitdaGrowth = exitEBITDA - inputs.ltmEBITDA;
        const ebitdaGrowthValue = ebitdaGrowth * inputs.exitMultipleBase;
        const multipleExpansion =
          (inputs.exitMultipleBase - inputs.entryMultiple) * exitEBITDA;
        const deleveraging = transaction.totalDebt - exitDebt;

        return {
          exitEBITDA,
          exitEV,
          exitDebt,
          exitEquityValue,
          sponsorExitValue,
          sponsorInvested,
          sponsorProfit,
          sponsorMoM,
          sponsorIRR,
          ebitdaGrowth,
          ebitdaGrowthValue,
          multipleExpansion,
          deleveraging,
        };
      }

      function calculateManagementReturns(inputs, transaction, returns) {
        const exitEquityValue = returns.exitEquityValue;

        // Rollover returns (same economics as sponsor on their portion)
        const rolloverExitValue = exitEquityValue * inputs.mgmtRollover;
        const rolloverInvested = transaction.rolloverValue;
        const rolloverMoM = rolloverExitValue / rolloverInvested;
        const rolloverIRR = Math.pow(rolloverMoM, 1 / inputs.holdPeriod) - 1;

        // Sweet equity returns
        const sweetEquityExitValue = exitEquityValue * inputs.sweetEquity;
        const sweetEquityInvested =
          transaction.sweetEquityStrike * inputs.sweetEquity;
        const sweetEquityMoM = sweetEquityExitValue / sweetEquityInvested;
        const sweetEquityIRR =
          Math.pow(sweetEquityMoM, 1 / inputs.holdPeriod) - 1;

        // Options returns
        const optionsExitValue =
          Math.max(0, exitEquityValue - transaction.optionStrike) *
          inputs.optionsPool;
        const optionsInvested = 0.01; // Nominal investment
        const optionsMoM = optionsExitValue / optionsInvested;

        // Blended management returns
        const totalMgmtExitValue =
          rolloverExitValue + sweetEquityExitValue + optionsExitValue;
        const totalMgmtInvested =
          rolloverInvested + sweetEquityInvested + optionsInvested;
        const blendedMgmtMoM = totalMgmtExitValue / totalMgmtInvested;
        const blendedMgmtIRR =
          Math.pow(blendedMgmtMoM, 1 / inputs.holdPeriod) - 1;

        return {
          rollover: {
            exitValue: rolloverExitValue,
            invested: rolloverInvested,
            moM: rolloverMoM,
            irr: rolloverIRR,
          },
          sweetEquity: {
            exitValue: sweetEquityExitValue,
            invested: sweetEquityInvested,
            moM: sweetEquityMoM,
            irr: sweetEquityIRR,
          },
          options: {
            exitValue: optionsExitValue,
            invested: optionsInvested,
            moM: optionsMoM,
          },
          blended: {
            exitValue: totalMgmtExitValue,
            invested: totalMgmtInvested,
            moM: blendedMgmtMoM,
            irr: blendedMgmtIRR,
          },
        };
      }


      // H√†m ph·ª• tr·ª£ ƒë·ªÉ t√≠nh NPV ki·ªÉm ch·ª©ng (Clean code)
      function calculateNPV(cashFlows, rate) {
          return cashFlows.reduce((acc, val, t) => acc + val / Math.pow(1 + rate, t), 0);
      }

      function displayScenarioComparison(scenarios) {
        const resultsDiv = document.getElementById("lboScenarioResults");

        const getIRRColor = (irr) => {
          if (irr >= 0.25) return "var(--green-600)";
          if (irr >= 0.2) return "var(--blue-600)";
          if (irr >= 0.15) return "var(--orange-500)";
          return "var(--red-600)";
        };

        const getIRRLabel = (irr) => {
          if (irr >= 0.25) return "üöÄ Exceptional";
          if (irr >= 0.2) return "‚úÖ Strong";
          if (irr >= 0.15) return "‚ö†Ô∏è Acceptable";
          return "‚ùå Below Target";
        };

        resultsDiv.innerHTML = `
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
                  üìä Three-Scenario Returns Analysis
                </h3>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                  ${["downside", "base", "upside"]
                    .map((scenario) => {
                      const s = scenarios[scenario];
                      const irrColor = getIRRColor(s.returns.sponsorIRR);
                      const irrLabel = getIRRLabel(s.returns.sponsorIRR);
                      const scenarioColor =
                        scenario === "base"
                          ? "blue"
                          : scenario === "upside"
                          ? "green"
                          : "orange";

                      return `
                      <div style="background: linear-gradient(135deg, var(--${scenarioColor}-50), var(--${scenarioColor}-100));
                                  padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--${scenarioColor}-300);">
                        <h4 style="font-size: 1rem; font-weight: 700; text-transform: uppercase;
                                  color: var(--${scenarioColor}-900); margin-bottom: 1rem; text-align: center;">
                          ${
                            scenario === "base"
                              ? "üìç"
                              : scenario === "upside"
                              ? "üìà"
                              : "üìâ"
                          } ${scenario.toUpperCase()}
                        </h4>

                        <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                          <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Sponsor IRR</div>
                            <div style="font-size: 2rem; font-weight: 800; color: ${irrColor};">
                              ${(s.returns.sponsorIRR * 100).toFixed(1)}%
                            </div>
                            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: ${irrColor};">
                              ${irrLabel}
                            </div>
                          </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                          <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="color: var(--slate-600); font-size: 0.75rem;">MoM</div>
                            <div style="font-weight: 700; color: var(--slate-800);">${s.returns.sponsorMoM.toFixed(
                              2
                            )}x</div>
                          </div>
                          <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="color: var(--slate-600); font-size: 0.75rem;">Profit</div>
                            <div style="font-weight: 700; color: var(--slate-800);">$${s.returns.sponsorProfit.toFixed(
                              0
                            )}M</div>
                          </div>
                          <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="color: var(--slate-600); font-size: 0.75rem;">Exit EV</div>
                            <div style="font-weight: 700; color: var(--slate-800);">$${s.returns.exitEV.toFixed(
                              0
                            )}M</div>
                          </div>
                          <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                            <div style="color: var(--slate-600); font-size: 0.75rem;">Exit Lev</div>
                            <div style="font-weight: 700; color: var(--slate-800);">
                              ${(
                                s.returns.exitDebt / s.returns.exitEBITDA
                              ).toFixed(2)}x
                            </div>
                          </div>
                        </div>

                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--slate-50);
                                    border-radius: 0.375rem; font-size: 0.75rem;">
                          <strong>Exit Multiple:</strong> ${s.inputs.exitMultipleBase.toFixed(
                            1
                          )}x<br>
                          <strong>EBITDA Growth:</strong> ${(
                            (s.returns.exitEBITDA / s.inputs.ltmEBITDA - 1) *
                            100
                          ).toFixed(0)}%<br>
                          <strong>Debt Paydown:</strong> $${s.returns.deleveraging.toFixed(
                            0
                          )}M
                        </div>
                      </div>
                    `;
                    })
                    .join("")}
                </div>

                <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                            padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--indigo-200);">
                  <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem; text-align: center;">
                    üéØ Investment Committee Summary
                  </h4>
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">IRR Range</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                        ${(scenarios.downside.returns.sponsorIRR * 100).toFixed(
                          1
                        )}% ‚Äì ${(
          scenarios.upside.returns.sponsorIRR * 100
        ).toFixed(1)}%
                      </div>
                    </div>
                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">MoM Range</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                        ${scenarios.downside.returns.sponsorMoM.toFixed(
                          2
                        )}x ‚Äì ${scenarios.upside.returns.sponsorMoM.toFixed(2)}x
                      </div>
                    </div>
                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Base IRR</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: ${getIRRColor(
                        scenarios.base.returns.sponsorIRR
                      )};">
                        ${(scenarios.base.returns.sponsorIRR * 100).toFixed(1)}%
                      </div>
                    </div>
                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Entry Leverage</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                        ${scenarios.base.transaction.totalLeverage.toFixed(2)}x
                      </div>
                    </div>
                  </div>

                  <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: 0.5rem;
                              border-left: 4px solid var(--indigo-500); font-size: 0.875rem;">
                    <strong>IC Recommendation:</strong>
                    ${
                      scenarios.base.returns.sponsorIRR >= 0.2
                        ? '‚úÖ <span style="color: var(--green-700);">APPROVE</span> - Strong risk-adjusted returns across scenarios'
                        : scenarios.base.returns.sponsorIRR >= 0.15
                        ? '‚ö†Ô∏è <span style="color: var(--orange-700);">CONDITIONAL</span> - Acceptable base case, but limited downside protection'
                        : '‚ùå <span style="color: var(--red-700);">REJECT</span> - Insufficient returns relative to risk'
                    }
                  </div>
                </div>
              `;

        resultsDiv.classList.remove("hidden");
      }

      function displayDetailedResults(scenarios, inputs) {
        const detailsDiv = document.getElementById("lboDetailedResults");

        // Create tabs for each scenario
        detailsDiv.innerHTML = `
                <div style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem;
                            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                  <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-800);">
                    üìë Detailed Analysis (Base Case)
                  </h3>

                  ${renderSourcesUses(scenarios.base)}
                  ${renderDebtSchedule(scenarios.base)}
                  ${renderFinancialProjections(scenarios.base)}
                  ${renderManagementReturns(scenarios.base)}
                  ${renderValueCreationBridge(scenarios.base)}
                </div>
              `;

        detailsDiv.classList.remove("hidden");
      }

      function renderSourcesUses(scenario) {
        const t = scenario.transaction;

        return `
                <div style="margin-top: 2rem;">
                  <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                    üí∞ Sources & Uses of Funds
                  </h4>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div style="background: var(--slate-50); padding: 1.25rem; border-radius: 0.5rem;">
                      <h5 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--slate-700);">Uses</h5>
                      <table style="width: 100%; font-size: 0.875rem;">
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Purchase Enterprise Value</td>
                          <td style="text-align: right; font-weight: 500;">$${t.purchaseEV.toFixed(
                            1
                          )}M</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Transaction Fees</td>
                          <td style="text-align: right; font-weight: 500;">$${t.transFees.toFixed(
                            1
                          )}M</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Cash to Balance Sheet</td>
                          <td style="text-align: right; font-weight: 500;">$${scenario.inputs.minCash.toFixed(
                            1
                          )}M</td>
                        </tr>
                        <tr style="border-top: 2px solid var(--slate-400); font-weight: 700;">
                          <td style="padding: 0.75rem 0;">Total Uses</td>
                          <td style="text-align: right;">$${t.totalUses.toFixed(
                            1
                          )}M</td>
                        </tr>
                      </table>
                    </div>

                    <div style="background: var(--blue-50); padding: 1.25rem; border-radius: 0.5rem;">
                      <h5 style="font-weight: 600; margin-bottom: 0.75rem; color: var(--slate-700);">Sources</h5>
                      <table style="width: 100%; font-size: 0.875rem;">
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Revolver</td>
                          <td style="text-align: right; font-weight: 500;">$${t.revolver.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(t.revolver / scenario.inputs.ltmEBITDA).toFixed(
                              2
                            )}x
                          </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Term Loan B</td>
                          <td style="text-align: right; font-weight: 500;">$${t.tlb.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(t.tlb / scenario.inputs.ltmEBITDA).toFixed(2)}x
                          </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Mezzanine / Sub Debt</td>
                          <td style="text-align: right; font-weight: 500;">$${t.mezz.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(t.mezz / scenario.inputs.ltmEBITDA).toFixed(2)}x
                          </td>
                        </tr>
                        <tr style="border-bottom: 2px solid var(--slate-300); font-weight: 600; background: var(--slate-100);">
                          <td style="padding: 0.5rem 0;">Total Debt</td>
                          <td style="text-align: right;">$${t.totalDebt.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; font-weight: 700; color: var(--slate-700);">
                            ${t.totalLeverage.toFixed(2)}x
                          </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200);">
                          <td style="padding: 0.5rem 0;">Existing Cash</td>
                          <td style="text-align: right; font-weight: 500;">$${scenario.inputs.existingCash.toFixed(
                            1
                          )}M</td>
                          <td></td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200); background: var(--orange-50);">
                          <td style="padding: 0.5rem 0;">Management Rollover</td>
                          <td style="text-align: right; font-weight: 500;">$${t.rolloverValue.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(scenario.inputs.mgmtRollover * 100).toFixed(0)}%
                          </td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--slate-200); background: var(--green-50);">
                          <td style="padding: 0.5rem 0; font-weight: 600;">Sponsor Equity</td>
                          <td style="text-align: right; font-weight: 700; color: var(--green-700);">$${t.sponsorEquity.toFixed(
                            1
                          )}M</td>
                          <td style="text-align: right; color: var(--slate-600); font-size: 0.75rem;">
                            ${(t.sponsorOwnership * 100).toFixed(1)}%
                          </td>
                        </tr>
                        <tr style="border-top: 2px solid var(--slate-400); font-weight: 700;">
                          <td style="padding: 0.75rem 0;">Total Sources</td>
                          <td style="text-align: right;">$${(
                            t.totalDebt +
                            scenario.inputs.existingCash +
                            t.purchaseEquity
                          ).toFixed(1)}M</td>
                          <td></td>
                        </tr>
                      </table>

                      <div style="margin-top: 1rem; padding: 0.75rem; background: var(--white);
                                  border-radius: 0.375rem; font-size: 0.75rem;">
                        <strong>Equity Breakdown:</strong><br>
                        Sponsor: ${(t.sponsorOwnership * 100).toFixed(1)}% |
                        Mgmt Rollover: ${(
                          scenario.inputs.mgmtRollover * 100
                        ).toFixed(1)}% |
                        Sweet Equity: ${(
                          scenario.inputs.sweetEquity * 100
                        ).toFixed(1)}% |
                        Options: ${(scenario.inputs.optionsPool * 100).toFixed(
                          1
                        )}%
                      </div>
                    </div>
                  </div>
                </div>
              `;
      }

      function renderDebtSchedule(scenario) {
        const years = scenario.projections.years;

        let tableHTML = `
                <div style="margin-top: 2rem;">
                  <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                    üìä Debt Schedule & Covenant Compliance
                  </h4>
                  <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <thead>
                        <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                          <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Year</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">EBITDA</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Revolver</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">TLB</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Mezz</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Total Debt</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Net Lev</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Covenant</th>
                          <th style="padding: 0.75rem; text-align: center; font-weight: 600;">Status</th>
                        </tr>
                      </thead>
                      <tbody>
              `;

        years.forEach((y) => {
          const complianceIcon = y.covenantCompliance ? "‚úÖ" : "‚ùå";
          const rowStyle = y.covenantCompliance
            ? ""
            : "background: var(--red-50);";

          tableHTML += `
                  <tr style="border-bottom: 1px solid var(--slate-200); ${rowStyle}">
                    <td style="padding: 0.75rem; font-weight: 500;">Year ${
                      y.year
                    }</td>
                    <td style="padding: 0.75rem; text-align: right;">$${y.ebitda.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right;">$${y.revolverBalance.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right;">$${y.tlbBalance.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right;">$${y.mezzBalance.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right; font-weight: 600;">$${y.totalDebtBalance.toFixed(
                      1
                    )}M</td>
                    <td style="padding: 0.75rem; text-align: right; font-weight: 600;">${y.netLeverage.toFixed(
                      2
                    )}x</td>
                    <td style="padding: 0.75rem; text-align: right;">‚â§ ${y.maxLeverage.toFixed(
                      2
                    )}x</td>
                    <td style="padding: 0.75rem; text-align: center;">${complianceIcon}</td>
                  </tr>
                `;
        });

        tableHTML += `
                      </tbody>
                    </table>
                  </div>
                </div>
              `;

        return tableHTML;
      }

      function renderFinancialProjections(scenario) {
        const years = scenario.projections.years;
        const inputs = scenario.inputs;

        let tableHTML = `
                <div style="margin-top: 2rem;">
                  <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                    üìà 5-Year Financial Projections
                  </h4>
                  <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <thead>
                        <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                          <th style="padding: 0.75rem; text-align: left; font-weight: 600; position: sticky; left: 0; background: var(--slate-100);">Metric</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">LTM</th>
              `;

        for (let i = 1; i <= inputs.holdPeriod; i++) {
          tableHTML += `<th style="padding: 0.75rem; text-align: right; font-weight: 600;">Year ${i}</th>`;
        }

        tableHTML += `</tr></thead><tbody>`;

        // Revenue
        tableHTML += `<tr style="background: var(--blue-50); border-bottom: 1px solid var(--slate-200);">
                <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--blue-50);">Revenue</td>
                <td style="padding: 0.75rem; text-align: right;">$${(
                  inputs.ltmEBITDA / inputs.ebitdaMarginY1
                ).toFixed(1)}M</td>`;
        years.forEach((y) => {
          tableHTML += `<td style="padding: 0.75rem; text-align: right;">$${y.revenue.toFixed(
            1
          )}M</td>`;
        });
        tableHTML += `</tr>`;

        // EBITDA
        tableHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
                <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--white);">EBITDA</td>
                <td style="padding: 0.75rem; text-align: right;">$${inputs.ltmEBITDA.toFixed(
                  1
                )}M</td>`;
        years.forEach((y) => {
          tableHTML += `<td style="padding: 0.75rem; text-align: right;">$${y.ebitda.toFixed(
            1
          )}M</td>`;
        });
        tableHTML += `</tr>`;

        // EBITDA Margin
        tableHTML += `<tr style="background: var(--slate-50); border-bottom: 1px solid var(--slate-200);">
                <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--slate-50);">EBITDA Margin</td>
                <td style="padding: 0.75rem; text-align: right;">${(
                  inputs.ebitdaMarginY1 * 100
                ).toFixed(1)}%</td>`;
        years.forEach((y) => {
          tableHTML += `<td style="padding: 0.75rem; text-align: right;">${(
            y.ebitdaMargin * 100
          ).toFixed(1)}%</td>`;
        });
        tableHTML += `</tr>`;

        // Free Cash Flow
        tableHTML += `<tr style="background: var(--green-50); border-bottom: 1px solid var(--slate-200);">
                <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--green-50);">Free Cash Flow</td>
                <td style="padding: 0.75rem; text-align: right;">-</td>`;
        years.forEach((y) => {
          tableHTML += `<td style="padding: 0.75rem; text-align: right; font-weight: 600;">$${y.fcf.toFixed(
            1
          )}M</td>`;
        });
        tableHTML += `</tr>`;

        // Debt Paydown
        tableHTML += `<tr style="border-bottom: 1px solid var(--slate-200);">
                  <td style="padding: 0.75rem; padding-left: 1.5rem; position: sticky; left: 0; background: var(--white);">Total Debt Paydown</td>
                  <td style="padding: 0.75rem; text-align: right;">-</td>`;
        years.forEach((y) => {
          const totalPaydown =
            y.tlbAmortization +
            y.revolverPaydown +
            (y.tlbPaydown - y.tlbAmortization);
          tableHTML += `<td style="padding: 0.75rem; text-align: right;">$${totalPaydown.toFixed(
            1
          )}M</td>`;
        });
        tableHTML += `</tr>`;

        // Dividend Recap
        if (inputs.enableRecap) {
          tableHTML += `<tr style="background: var(--purple-50); border-bottom: 1px solid var(--slate-200);">
                    <td style="padding: 0.75rem; font-weight: 600; position: sticky; left: 0; background: var(--purple-50);">Dividend Recap</td>
                    <td style="padding: 0.75rem; text-align: right;">-</td>`;
          years.forEach((y) => {
            tableHTML += `<td style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--purple-700);">
                      ${
                        y.recapAmount > 0
                          ? `$${y.recapAmount.toFixed(1)}M`
                          : "-"
                      }
                    </td>`;
          });
          tableHTML += `</tr>`;
        }

        tableHTML += `</tbody></table></div></div>`;

        return tableHTML;
      }

      function renderManagementReturns(scenario) {
        const mgmt = scenario.mgmtReturns;
        const sponsor = scenario.returns;

        return `
                  <div style="margin-top: 2rem;">
                    <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                      üëî Management vs Sponsor Returns Comparison
                    </h4>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                      <!-- Sponsor Returns -->
                      <div style="background: linear-gradient(135deg, var(--blue-50), var(--blue-100));
                                  padding: 1.25rem; border-radius: 0.5rem; border: 2px solid var(--blue-300);">
                        <h5 style="font-size: 0.875rem; font-weight: 700; color: var(--blue-900);
                                  margin-bottom: 1rem; text-align: center;">
                          üíº SPONSOR
                        </h5>
                        <div style="text-align: center; margin-bottom: 0.75rem;">
                          <div style="font-size: 0.75rem; color: var(--slate-600);">IRR</div>
                          <div style="font-size: 1.5rem; font-weight: 800; color: var(--blue-700);">
                            ${(sponsor.sponsorIRR * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem;">
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Invested:</span>
                            <strong>$${sponsor.sponsorInvested.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Exit Value:</span>
                            <strong>$${sponsor.sponsorExitValue.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; padding-top: 0.25rem;
                                      border-top: 1px solid var(--slate-200);">
                            <span>MoM:</span>
                            <strong style="color: var(--blue-700);">${sponsor.sponsorMoM.toFixed(
                              2
                            )}x</strong>
                          </div>
                        </div>
                      </div>

                      <!-- Management Rollover -->
                      <div style="background: linear-gradient(135deg, var(--cyan-50), var(--cyan-100));
                                  padding: 1.25rem; border-radius: 0.5rem; border: 2px solid var(--cyan-300);">
                        <h5 style="font-size: 0.875rem; font-weight: 700; color: var(--cyan-900);
                                  margin-bottom: 1rem; text-align: center;">
                          üîÑ ROLLOVER
                        </h5>
                        <div style="text-align: center; margin-bottom: 0.75rem;">
                          <div style="font-size: 0.75rem; color: var(--slate-600);">IRR</div>
                          <div style="font-size: 1.5rem; font-weight: 800; color: var(--cyan-700);">
                            ${(mgmt.rollover.irr * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem;">
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Invested:</span>
                            <strong>$${mgmt.rollover.invested.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Exit Value:</span>
                            <strong>$${mgmt.rollover.exitValue.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; padding-top: 0.25rem;
                                      border-top: 1px solid var(--slate-200);">
                            <span>MoM:</span>
                            <strong style="color: var(--cyan-700);">${mgmt.rollover.moM.toFixed(
                              2
                            )}x</strong>
                          </div>
                        </div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--cyan-50);
                                    border-radius: 0.25rem; font-size: 0.7rem; text-align: center;">
                          Same economics as sponsor
                        </div>
                      </div>

                      <!-- Sweet Equity -->
                      <div style="background: linear-gradient(135deg, var(--green-50), var(--green-100));
                                  padding: 1.25rem; border-radius: 0.5rem; border: 2px solid var(--green-300);">
                        <h5 style="font-size: 0.875rem; font-weight: 700; color: var(--green-900);
                                  margin-bottom: 1rem; text-align: center;">
                          üç¨ SWEET EQUITY
                        </h5>
                        <div style="text-align: center; margin-bottom: 0.75rem;">
                          <div style="font-size: 0.75rem; color: var(--slate-600);">IRR</div>
                          <div style="font-size: 1.5rem; font-weight: 800; color: var(--green-700);">
                            ${(mgmt.sweetEquity.irr * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem;">
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Invested:</span>
                            <strong>$${mgmt.sweetEquity.invested.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Exit Value:</span>
                            <strong>$${mgmt.sweetEquity.exitValue.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; padding-top: 0.25rem;
                                      border-top: 1px solid var(--slate-200);">
                            <span>MoM:</span>
                            <strong style="color: var(--green-700);">${mgmt.sweetEquity.moM.toFixed(
                              2
                            )}x</strong>
                          </div>
                        </div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--green-50);
                                    border-radius: 0.25rem; font-size: 0.7rem; text-align: center;">
                          ${(scenario.inputs.sweetDiscount * 100).toFixed(
                            0
                          )}% discount to FMV
                        </div>
                      </div>

                      <!-- Options -->
                      <div style="background: linear-gradient(135deg, var(--purple-50), var(--purple-100));
                                  padding: 1.25rem; border-radius: 0.5rem; border: 2px solid var(--purple-300);">
                        <h5 style="font-size: 0.875rem; font-weight: 700; color: var(--purple-900);
                                  margin-bottom: 1rem; text-align: center;">
                          üéØ OPTIONS
                        </h5>
                        <div style="text-align: center; margin-bottom: 0.75rem;">
                          <div style="font-size: 0.75rem; color: var(--slate-600);">Return</div>
                          <div style="font-size: 1.5rem; font-weight: 800; color: var(--purple-700);">
                            ${
                              mgmt.options.moM > 1000
                                ? "‚àû"
                                : mgmt.options.moM.toFixed(0) + "x"
                            }
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem;">
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Invested:</span>
                            <strong>$${mgmt.options.invested.toFixed(
                              2
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Exit Value:</span>
                            <strong>$${mgmt.options.exitValue.toFixed(
                              1
                            )}M</strong>
                          </div>
                          <div style="display: flex; justify-content: space-between; padding-top: 0.25rem;
                                      border-top: 1px solid var(--slate-200);">
                            <span>Profit:</span>
                            <strong style="color: var(--purple-700);">$${(
                              mgmt.options.exitValue - mgmt.options.invested
                            ).toFixed(1)}M</strong>
                          </div>
                        </div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--purple-50);
                                    border-radius: 0.25rem; font-size: 0.7rem; text-align: center;">
                          Strike: ${(
                            scenario.inputs.optionStrike * 100
                          ).toFixed(0)}% of FMV
                        </div>
                      </div>
                    </div>

                    <!-- Blended Management Returns -->
                    <div style="margin-top: 1.5rem; background: linear-gradient(135deg, var(--orange-50), var(--orange-100));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--orange-300);">
                      <h5 style="font-size: 1rem; font-weight: 700; color: var(--orange-900);
                                margin-bottom: 1rem; text-align: center;">
                        üìä Blended Management Returns (Total Package)
                      </h5>
                      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Invested</div>
                          <div style="font-weight: 700; font-size: 1.1rem; color: var(--orange-700);">
                            $${mgmt.blended.invested.toFixed(1)}M
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Exit Value</div>
                          <div style="font-weight: 700; font-size: 1.1rem; color: var(--orange-700);">
                            $${mgmt.blended.exitValue.toFixed(1)}M
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Blended IRR</div>
                          <div style="font-weight: 700; font-size: 1.1rem; color: var(--orange-700);">
                            ${(mgmt.blended.irr * 100).toFixed(1)}%
                          </div>
                        </div>
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Blended MoM</div>
                          <div style="font-weight: 700; font-size: 1.1rem; color: var(--orange-700);">
                            ${mgmt.blended.moM.toFixed(2)}x
                          </div>
                        </div>
                      </div>

                      <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: 0.5rem;
                                  border-left: 4px solid var(--orange-500); font-size: 0.875rem;">
                        <strong>Key Insight:</strong>
                        ${
                          mgmt.blended.irr > sponsor.sponsorIRR
                            ? `Management's blended IRR of ${(
                                mgmt.blended.irr * 100
                              ).toFixed(1)}% outperforms sponsor's ${(
                                sponsor.sponsorIRR * 100
                              ).toFixed(
                                1
                              )}% due to sweet equity and options leverage. This ${(
                                (mgmt.blended.irr - sponsor.sponsorIRR) *
                                100
                              ).toFixed(
                                1
                              )}% premium properly incentivizes management to drive value creation.`
                            : `Management's blended IRR of ${(
                                mgmt.blended.irr * 100
                              ).toFixed(
                                1
                              )}% is aligned with sponsor returns of ${(
                                sponsor.sponsorIRR * 100
                              ).toFixed(
                                1
                              )}%, indicating strong alignment of interests.`
                        }
                      </div>
                    </div>
                  </div>
                `;
      }

      function renderValueCreationBridge(scenario) {
        const returns = scenario.returns;
        const inputs = scenario.inputs;

        return `
                  <div style="margin-top: 2rem;">
                    <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-700);">
                      üåâ Value Creation Bridge Analysis
                    </h4>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                      <!-- Exit Waterfall -->
                      <div style="background: var(--blue-50); padding: 1.25rem; border-radius: 0.5rem;
                                  border-left: 4px solid var(--blue-500);">
                        <h5 style="font-weight: 600; color: var(--blue-900); margin-bottom: 1rem;">Exit Waterfall</h5>
                        <table style="width: 100%; font-size: 0.875rem;">
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0;">Exit EBITDA</td>
                            <td style="text-align: right; font-weight: 600;">$${returns.exitEBITDA.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0;">Exit Multiple</td>
                            <td style="text-align: right; font-weight: 500;">${inputs.exitMultipleBase.toFixed(
                              1
                            )}x</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0; font-weight: 600;">Exit Enterprise Value</td>
                            <td style="text-align: right; font-weight: 700; color: var(--blue-700);">$${returns.exitEV.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0;">Less: Remaining Debt</td>
                            <td style="text-align: right; font-weight: 500;">($${returns.exitDebt.toFixed(
                              1
                            )}M)</td>
                          </tr>
                          <tr style="border-top: 2px solid var(--blue-600); background: var(--blue-100);">
                            <td style="padding: 0.75rem 0; font-weight: 700;">Exit Equity Value</td>
                            <td style="text-align: right; font-weight: 700; color: var(--blue-800);">$${returns.exitEquityValue.toFixed(
                              1
                            )}M</td>
                          </tr>
                        </table>

                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--white);
                                    border-radius: 0.375rem; font-size: 0.75rem;">
                          <strong>Exit Leverage:</strong> ${(
                            returns.exitDebt / returns.exitEBITDA
                          ).toFixed(2)}x Net Debt/EBITDA<br>
                          <strong>Total Debt Paydown:</strong> $${returns.deleveraging.toFixed(
                            1
                          )}M
                          (${(
                            (returns.deleveraging /
                              scenario.transaction.totalDebt) *
                            100
                          ).toFixed(0)}%)
                        </div>
                      </div>

                      <!-- Value Creation Sources -->
                      <div style="background: var(--green-50); padding: 1.25rem; border-radius: 0.5rem;
                                  border-left: 4px solid var(--green-500);">
                        <h5 style="font-weight: 600; color: var(--green-900); margin-bottom: 1rem;">Sources of Value Creation</h5>
                        <table style="width: 100%; font-size: 0.875rem;">
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0;">Initial Equity</td>
                            <td style="text-align: right; font-weight: 600;">$${returns.sponsorInvested.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0; color: var(--blue-700);">
                              + EBITDA Growth (${inputs.ltmEBITDA.toFixed(
                                0
                              )}M ‚Üí ${returns.exitEBITDA.toFixed(0)}M)
                            </td>
                            <td style="text-align: right; font-weight: 500;">$${returns.ebitdaGrowthValue.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0; color: var(--green-700);">
                              + Deleveraging (Debt Paydown)
                            </td>
                            <td style="text-align: right; font-weight: 500;">$${returns.deleveraging.toFixed(
                              1
                            )}M</td>
                          </tr>
                          <tr style="border-bottom: 1px solid var(--slate-200);">
                            <td style="padding: 0.5rem 0; color: ${
                              returns.multipleExpansion >= 0
                                ? "var(--green-700)"
                                : "var(--red-700)"
                            };">
                              ${
                                returns.multipleExpansion >= 0 ? "+" : "‚àí"
                              } Multiple ${
          returns.multipleExpansion >= 0 ? "Expansion" : "Compression"
        }
                              (${inputs.entryMultiple.toFixed(
                                1
                              )}x ‚Üí ${inputs.exitMultipleBase.toFixed(1)}x)
                            </td>
                            <td style="text-align: right; font-weight: 500;">$${Math.abs(
                              returns.multipleExpansion
                            ).toFixed(1)}M</td>
                          </tr>
                          ${
                            scenario.projections.recapDividend > 0
                              ? `
                            <tr style="border-bottom: 1px solid var(--slate-200);">
                              <td style="padding: 0.5rem 0; color: var(--purple-700);">
                                + Dividend Recap (Year ${inputs.recapYear})
                              </td>
                              <td style="text-align: right; font-weight: 500;">$${scenario.projections.recapDividend.toFixed(
                                1
                              )}M</td>
                            </tr>
                          `
                              : ""
                          }
                          <tr style="border-top: 2px solid var(--green-600); background: var(--green-100);">
                            <td style="padding: 0.75rem 0; font-weight: 700;">Exit Equity Value (Sponsor)</td>
                            <td style="text-align: right; font-weight: 700; color: var(--green-800);">$${returns.sponsorExitValue.toFixed(
                              1
                            )}M</td>
                          </tr>
                        </table>

                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--white);
                                    border-radius: 0.375rem; font-size: 0.75rem;">
                          <strong>Total Profit:</strong> $${returns.sponsorProfit.toFixed(
                            1
                          )}M
                          (+${((returns.sponsorMoM - 1) * 100).toFixed(0)}%)<br>
                          <strong>CAGR:</strong> ${(
                            (Math.pow(
                              returns.sponsorMoM,
                              1 / inputs.holdPeriod
                            ) -
                              1) *
                            100
                          ).toFixed(1)}%
                        </div>
                      </div>
                    </div>

                    <!-- Value Attribution Chart -->
                    <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--indigo-200);">
                      <h5 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem; text-align: center;">
                        üìä Value Creation Attribution (% of Total Value Added)
                      </h5>

                      ${(() => {
                        const totalValueAdded = returns.sponsorProfit;
                        const ebitdaContribution =
                          (returns.ebitdaGrowthValue / totalValueAdded) * 100;
                        const deleverageContribution =
                          (returns.deleveraging / totalValueAdded) * 100;
                        const multipleContribution =
                          (returns.multipleExpansion / totalValueAdded) * 100;
                        const recapContribution =
                          scenario.projections.recapDividend > 0
                            ? (scenario.projections.recapDividend /
                                totalValueAdded) *
                              100
                            : 0;

                        return `
                          <div style="display: grid; grid-template-columns: repeat(${
                            scenario.projections.recapDividend > 0 ? 4 : 3
                          }, 1fr); gap: 1rem;">
                            <div style="background: var(--white); padding: 1.25rem; border-radius: 0.5rem; text-align: center;">
                              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">EBITDA Growth</div>
                              <div style="font-size: 2rem; font-weight: 800; color: var(--blue-600);">
                                ${ebitdaContribution.toFixed(0)}%
                              </div>
                              <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--slate-600);">
                                $${returns.ebitdaGrowthValue.toFixed(1)}M
                              </div>
                              <div style="margin-top: 0.75rem; height: 100px; background: var(--slate-100); border-radius: 0.375rem; overflow: hidden;">
                                <div style="height: ${ebitdaContribution}%; background: linear-gradient(to top, var(--blue-500), var(--blue-300));
                                            width: 100%; transition: height 0.5s;"></div>
                              </div>
                            </div>

                            <div style="background: var(--white); padding: 1.25rem; border-radius: 0.5rem; text-align: center;">
                              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Deleveraging</div>
                              <div style="font-size: 2rem; font-weight: 800; color: var(--green-600);">
                                ${deleverageContribution.toFixed(0)}%
                              </div>
                              <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--slate-600);">
                                $${returns.deleveraging.toFixed(1)}M
                              </div>
                              <div style="margin-top: 0.75rem; height: 100px; background: var(--slate-100); border-radius: 0.375rem; overflow: hidden;">
                                <div style="height: ${deleverageContribution}%; background: linear-gradient(to top, var(--green-500), var(--green-300));
                                            width: 100%; transition: height 0.5s;"></div>
                              </div>
                            </div>

                            <div style="background: var(--white); padding: 1.25rem; border-radius: 0.5rem; text-align: center;">
                              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Multiple ${
                                returns.multipleExpansion >= 0
                                  ? "Expansion"
                                  : "Compression"
                              }</div>
                              <div style="font-size: 2rem; font-weight: 800; color: ${
                                returns.multipleExpansion >= 0
                                  ? "var(--purple-600)"
                                  : "var(--red-600)"
                              };">
                                ${
                                  returns.multipleExpansion >= 0 ? "+" : ""
                                }${multipleContribution.toFixed(0)}%
                              </div>
                              <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--slate-600);">
                                $${Math.abs(returns.multipleExpansion).toFixed(
                                  1
                                )}M
                              </div>
                              <div style="margin-top: 0.75rem; height: 100px; background: var(--slate-100); border-radius: 0.375rem; overflow: hidden;">
                                <div style="height: ${Math.abs(
                                  multipleContribution
                                )}%; background: linear-gradient(to top, ${
                          returns.multipleExpansion >= 0
                            ? "var(--purple-500), var(--purple-300)"
                            : "var(--red-500), var(--red-300)"
                        });
                                            width: 100%; transition: height 0.5s;"></div>
                              </div>
                            </div>

                            ${
                              scenario.projections.recapDividend > 0
                                ? `
                              <div style="background: var(--white); padding: 1.25rem; border-radius: 0.5rem; text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Dividend Recap</div>
                                <div style="font-size: 2rem; font-weight: 800; color: var(--orange-600);">
                                  ${recapContribution.toFixed(0)}%
                                </div>
                                <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--slate-600);">
                                  $${scenario.projections.recapDividend.toFixed(
                                    1
                                  )}M
                                </div>
                                <div style="margin-top: 0.75rem; height: 100px; background: var(--slate-100); border-radius: 0.375rem; overflow: hidden;">
                                  <div style="height: ${recapContribution}%; background: linear-gradient(to top, var(--orange-500), var(--orange-300));
                                              width: 100%; transition: height 0.5s;"></div>
                                </div>
                              </div>
                            `
                                : ""
                            }
                          </div>
                        `;
                      })()}

                      <div style="margin-top: 1.5rem; padding: 1rem; background: var(--white); border-radius: 0.5rem;
                                  border-left: 4px solid var(--indigo-500); font-size: 0.875rem;">
                        <strong>Strategic Insight:</strong>
                        ${(() => {
                          const totalValueAdded = returns.sponsorProfit;
                          const ebitdaContribution =
                            (returns.ebitdaGrowthValue / totalValueAdded) * 100;
                          const deleverageContribution =
                            (returns.deleveraging / totalValueAdded) * 100;
                          const multipleContribution =
                            (returns.multipleExpansion / totalValueAdded) * 100;

                          if (ebitdaContribution > 50) {
                            return `This deal is driven primarily by <strong>operational value creation</strong> (${ebitdaContribution.toFixed(
                              0
                            )}% of returns),
                                    indicating strong execution on business plan and revenue/margin expansion. This is the most sustainable source of PE returns.`;
                          } else if (deleverageContribution > 40) {
                            return `This deal is heavily reliant on <strong>financial engineering</strong> (${deleverageContribution.toFixed(
                              0
                            )}% from deleveraging),
                                                  which is solid but requires strong cash flow generation. Focus on maintaining covenant compliance throughout the hold period.`;
                          } else if (multipleContribution > 30) {
                            return `<strong>Multiple expansion</strong> contributes ${Math.abs(
                              multipleContribution
                            ).toFixed(0)}% of value.
                                                  ${
                                                    multipleContribution > 0
                                                      ? "This assumes favorable exit market conditions. Stress test downside scenarios with multiple compression."
                                                      : "Despite multiple compression, operational improvements drive positive returns."
                                                  }`;
                          } else {
                            return `Balanced value creation across all three levers: EBITDA growth (${ebitdaContribution.toFixed(
                              0
                            )}%),
                                                  deleveraging (${deleverageContribution.toFixed(
                                                    0
                                                  )}%), and multiple dynamics (${multipleContribution.toFixed(
                              0
                            )}%).
                                                  This diversified approach reduces execution risk.`;
                          }
                        })()}
                                    </div>
                                  </div>
                                </div>
                              `;
      }


      // ==================== EXPORT INITIALIZATION ====================
      function initializeLBOModel() {
        const container = document.getElementById("lboModelContainer");
        if (!container) {
          console.error("LBO Model container not found");
          return;
        }

        container.innerHTML = renderLBOCalculator();
        setupLBOCalculator();

        console.log("‚úÖ Advanced LBO Model initialized successfully");
      }

      // Auto-initialize when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeLBOModel);
      } else {
        initializeLBOModel();
      }

      // ==================== CREDIT CARD PAYMENT OPTIMIZER ====================
      function renderCCPOCalculator() {
        return `
          <h2 class="calculator-title">Credit Card Payment Optimizer (CCPO)</h2>

          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Smart Debt Elimination Strategy
            </div>
            <p class="explanation-text">
              <strong>Don't just pay minimums.</strong> This optimizer helps you eliminate credit card debt strategically.
              Compare proven methods: <strong>Avalanche</strong> (highest interest first - saves most money) vs
              <strong>Snowball</strong> (smallest balance first - quick psychological wins).
            </p>
            <div class="explanation-note">
              <strong>Financial Insight:</strong> The difference between random payments and optimized strategy can save you
              thousands in interest and shave years off your debt-free date. Even $50 extra/month compounds dramatically.
            </div>
          </div>

          <!-- Card Input Section -->
          <div style="background: var(--slate-50); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--slate-700);">
                üí≥ Your Credit Cards
              </h3>
              <button class="btn btn-primary" id="addCardBtn" style="width: auto; padding: 0.5rem 1rem; font-size: 0.875rem;">
                + Add Card
              </button>
            </div>

            <div id="cardsContainer">
              <!-- Cards will be added here -->
            </div>
          </div>

          <!-- Payment Strategy Section -->
          <div class="form-grid" style="margin-bottom: 1.5rem;">
            <div class="form-group">
              <label class="form-label">üí∞ Total Monthly Payment Available</label>
              <input type="number" id="totalMonthlyPayment" class="form-input" placeholder="500" step="10">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                Must be ‚â• sum of all minimum payments
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">üìÖ Extra Payment (Optional)</label>
              <input type="number" id="extraPayment" class="form-input" placeholder="0" step="50">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                One-time injection (bonus, tax refund)
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">üéØ When to Apply Extra Payment?</label>
              <select id="extraPaymentMonth" class="form-select">
                <option value="0">Not applicable</option>
                <option value="1">Month 1</option>
                <option value="3">Month 3</option>
                <option value="6">Month 6</option>
                <option value="12">Month 12</option>
              </select>
            </div>
          </div>

          <button class="btn btn-success" id="optimizeBtn">
            üöÄ Optimize My Payment Strategy
          </button>

          <!-- Results Section -->
          <div id="ccpoResults" class="hidden" style="margin-top: 2rem;">
            <!-- Strategy comparison -->
            <div id="strategyComparison"></div>

            <!-- Detailed breakdown tabs -->
            <div id="detailedBreakdown" class="hidden" style="margin-top: 2rem;"></div>
          </div>
        `;
      }

      function setupCCPOCalculator() {
        let cards = [];
        let cardIdCounter = 1;

        // Add initial card
        addCard();

        // Event listeners
        document.getElementById("addCardBtn").addEventListener("click", () => {
          if (cards.length < 10) {
            addCard();
          } else {
            alert("Maximum 10 cards allowed");
          }
        });

        document
          .getElementById("optimizeBtn")
          .addEventListener("click", optimizePayments);

        function addCard() {
          const cardId = cardIdCounter++;
          const card = {
            id: cardId,
            balance: 0,
            apr: 0,
            minPaymentPercent: 2,
            name: `Card ${cardId}`,
          };
          cards.push(card);
          renderCards();
        }

        function removeCard(cardId) {
          cards = cards.filter((c) => c.id !== cardId);
          renderCards();
        }

        function renderCards() {
          const container = document.getElementById("cardsContainer");

          if (cards.length === 0) {
            container.innerHTML =
              '<p style="text-align: center; color: var(--slate-500);">No cards added yet</p>';
            return;
          }

          container.innerHTML = cards
            .map(
              (card) => `
            <div class="card-row" data-card-id="${card.id}" style="
              background: var(--white);
              padding: 1rem;
              border-radius: 0.5rem;
              margin-bottom: 0.75rem;
              border: 2px solid var(--slate-200);
            ">
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Card Name</label>
                  <input type="text" class="form-input card-name" value="${card.name}"
                         style="font-weight: 500; color: var(--indigo-700);">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Balance ($)</label>
                  <input type="number" class="form-input card-balance" value="${card.balance}"
                         placeholder="5000" step="100">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">APR (%)</label>
                  <input type="number" class="form-input card-apr" value="${card.apr}"
                         placeholder="18.99" step="0.01">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Min Payment (%)</label>
                  <input type="number" class="form-input card-minpayment" value="${card.minPaymentPercent}"
                         placeholder="2" step="0.1" min="1" max="10">
                </div>

                <button class="remove-card-btn" data-card-id="${card.id}" style="
                  background: var(--red-500);
                  color: white;
                  border: none;
                  border-radius: 0.375rem;
                  padding: 0.5rem 0.75rem;
                  cursor: pointer;
                  font-weight: 600;
                  transition: all 0.2s;
                ">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          `
            )
            .join("");

          // Attach event listeners
          document.querySelectorAll(".remove-card-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const cardId = parseInt(e.target.dataset.cardId);
              removeCard(cardId);
            });
          });

          // Update card data on input change
          document.querySelectorAll(".card-row").forEach((row) => {
            const cardId = parseInt(row.dataset.cardId);
            const card = cards.find((c) => c.id === cardId);

            row.querySelector(".card-name").addEventListener("input", (e) => {
              card.name = e.target.value;
            });

            row
              .querySelector(".card-balance")
              .addEventListener("input", (e) => {
                card.balance = parseFloat(e.target.value) || 0;
              });

            row.querySelector(".card-apr").addEventListener("input", (e) => {
              card.apr = parseFloat(e.target.value) || 0;
            });

            row
              .querySelector(".card-minpayment")
              .addEventListener("input", (e) => {
                card.minPaymentPercent = parseFloat(e.target.value) || 2;
              });
          });
        }

        function optimizePayments() {
          // Validate inputs
          const totalPayment = parseFloat(
            document.getElementById("totalMonthlyPayment").value
          );
          const extraPayment =
            parseFloat(document.getElementById("extraPayment").value) || 0;
          const extraPaymentMonth =
            parseInt(document.getElementById("extraPaymentMonth").value) || 0;

          if (cards.length === 0) {
            alert("Please add at least one credit card");
            return;
          }

          if (isNaN(totalPayment) || totalPayment <= 0) {
            alert("Please enter a valid total monthly payment");
            return;
          }

          // Validate all cards have data
          for (let card of cards) {
            if (card.balance <= 0 || card.apr <= 0) {
              alert(`Please fill in all fields for ${card.name}`);
              return;
            }
          }

          // Calculate minimum payments
          const totalMinPayment = cards.reduce((sum, card) => {
            const minPayment = Math.max(
              25,
              card.balance * (card.minPaymentPercent / 100)
            );
            return sum + minPayment;
          }, 0);

          if (totalPayment < totalMinPayment) {
            alert(
              `Total monthly payment ($${totalPayment.toFixed(
                2
              )}) must be at least the sum of minimum payments ($${totalMinPayment.toFixed(
                2
              )})`
            );
            return;
          }

          // Run optimizations
          const minPaymentOnly = simulateStrategy(
            "minimum",
            cards,
            totalMinPayment,
            extraPayment,
            extraPaymentMonth
          );
          const avalanche = simulateStrategy(
            "avalanche",
            cards,
            totalPayment,
            extraPayment,
            extraPaymentMonth
          );
          const snowball = simulateStrategy(
            "snowball",
            cards,
            totalPayment,
            extraPayment,
            extraPaymentMonth
          );

          // Display results
          displayResults({
            minPaymentOnly,
            avalanche,
            snowball,
            totalPayment,
            extraPayment,
            extraPaymentMonth,
          });
        }

        function simulateStrategy(
          strategyType,
          cards,
          monthlyPayment,
          extraPayment,
          extraPaymentMonth
        ) {
          // Clone cards to avoid mutation
          let remainingCards = cards.map((c) => ({
            ...c,
            remainingBalance: c.balance,
            totalInterestPaid: 0,
            monthsPaid: 0,
          }));

          const monthlyBreakdown = [];
          let month = 0;
          let totalInterestPaid = 0;

          while (
            remainingCards.some((c) => c.remainingBalance > 0) &&
            month < 600
          ) {
            // Max 50 years safety
            month++;

            // Apply interest to all cards
            remainingCards.forEach((card) => {
              if (card.remainingBalance > 0) {
                const monthlyInterest =
                  (card.remainingBalance * (card.apr / 100)) / 12;
                card.remainingBalance += monthlyInterest;
                card.totalInterestPaid += monthlyInterest;
                totalInterestPaid += monthlyInterest;
              }
            });

            // Determine payment allocation
            let availablePayment = monthlyPayment;

            // Add extra payment if applicable
            if (month === extraPaymentMonth && extraPayment > 0) {
              availablePayment += extraPayment;
            }

            // Sort cards based on strategy
            let sortedCards;
            if (strategyType === "avalanche") {
              sortedCards = [...remainingCards].sort((a, b) => b.apr - a.apr);
            } else if (strategyType === "snowball") {
              sortedCards = [...remainingCards].sort(
                (a, b) => a.remainingBalance - b.remainingBalance
              );
            } else {
              // minimum payment only
              sortedCards = [...remainingCards];
            }

            // Pay minimum on all cards first
            const cardPayments = [];
            sortedCards.forEach((card) => {
              if (card.remainingBalance > 0) {
                const minPayment = Math.max(
                  25,
                  card.remainingBalance * (card.minPaymentPercent / 100)
                );
                const payment = Math.min(
                  minPayment,
                  card.remainingBalance,
                  availablePayment
                );

                card.remainingBalance -= payment;
                availablePayment -= payment;

                cardPayments.push({
                  cardId: card.id,
                  cardName: card.name,
                  payment: payment,
                  remainingBalance: Math.max(0, card.remainingBalance),
                });

                if (card.remainingBalance <= 0) {
                  card.monthsPaid = month;
                }
              }
            });

            // Allocate remaining payment based on strategy
            if (strategyType !== "minimum" && availablePayment > 0.01) {
              for (let card of sortedCards) {
                if (card.remainingBalance > 0) {
                  const extraPaymentToCard = Math.min(
                    availablePayment,
                    card.remainingBalance
                  );
                  card.remainingBalance -= extraPaymentToCard;
                  availablePayment -= extraPaymentToCard;

                  // Update payment in breakdown
                  const cardPayment = cardPayments.find(
                    (p) => p.cardId === card.id
                  );
                  if (cardPayment) {
                    cardPayment.payment += extraPaymentToCard;
                    cardPayment.remainingBalance = Math.max(
                      0,
                      card.remainingBalance
                    );
                  }

                  if (card.remainingBalance <= 0) {
                    card.monthsPaid = month;
                  }

                  if (availablePayment < 0.01) break;
                }
              }
            }

            monthlyBreakdown.push({
              month,
              payments: cardPayments,
              totalPaid:
                monthlyPayment +
                (month === extraPaymentMonth ? extraPayment : 0),
              totalRemaining: remainingCards.reduce(
                (sum, c) => sum + Math.max(0, c.remainingBalance),
                0
              ),
            });

            // Check if all paid off
            if (remainingCards.every((c) => c.remainingBalance <= 0)) {
              break;
            }
          }

          return {
            strategyType,
            monthsToPayoff: month,
            totalInterestPaid,
            cardDetails: remainingCards.map((c) => ({
              id: c.id,
              name: c.name,
              originalBalance: c.balance,
              totalInterestPaid: c.totalInterestPaid,
              monthsPaid: c.monthsPaid,
            })),
            monthlyBreakdown,
          };
        }

        function displayResults(results) {
          const {
            minPaymentOnly,
            avalanche,
            snowball,
            totalPayment,
            extraPayment,
            extraPaymentMonth,
          } = results;

          const resultsDiv = document.getElementById("ccpoResults");
          const comparisonDiv = document.getElementById("strategyComparison");

          // Calculate savings
          const avalancheSavings =
            minPaymentOnly.totalInterestPaid - avalanche.totalInterestPaid;
          const snowballSavings =
            minPaymentOnly.totalInterestPaid - snowball.totalInterestPaid;
          const avalancheVsSnowball =
            snowball.totalInterestPaid - avalanche.totalInterestPaid;

          const bestStrategy =
            avalanche.totalInterestPaid <= snowball.totalInterestPaid
              ? "avalanche"
              : "snowball";

          comparisonDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
              üìä Payment Strategy Comparison
            </h3>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <!-- Minimum Payment Only -->
              <div style="background: linear-gradient(135deg, var(--red-50), var(--red-100));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--red-300);">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--red-900); margin-bottom: 1rem; text-align: center;">
                  ‚ö†Ô∏è MINIMUM ONLY
                </h4>

                <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Time to Payoff</div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--red-600);">
                      ${minPaymentOnly.monthsToPayoff} mo
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--red-600);">
                      ${(minPaymentOnly.monthsToPayoff / 12).toFixed(1)} years
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem; font-size: 0.875rem;">
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">Total Interest</div>
                    <div style="font-weight: 700; color: var(--red-700);">$${minPaymentOnly.totalInterestPaid.toFixed(
                      0
                    )}</div>
                  </div>
                </div>

                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--red-50);
                            border-radius: 0.375rem; font-size: 0.75rem; text-align: center; color: var(--red-800);">
                  ‚ö†Ô∏è Baseline - Not recommended!
                </div>
              </div>

              <!-- Avalanche Method -->
              <div style="background: linear-gradient(135deg, var(--green-50), var(--green-100));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                            bestStrategy === "avalanche"
                              ? "var(--green-600)"
                              : "var(--green-300)"
                          };
                          box-shadow: ${
                            bestStrategy === "avalanche"
                              ? "0 4px 12px rgba(16, 185, 129, 0.3)"
                              : "none"
                          };">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem; text-align: center;">
                  üéØ AVALANCHE
                  ${
                    bestStrategy === "avalanche"
                      ? '<div style="font-size: 0.75rem; color: var(--green-700); margin-top: 0.25rem;">‚≠ê RECOMMENDED</div>'
                      : ""
                  }
                </h4>

                <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Time to Payoff</div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--green-600);">
                      ${avalanche.monthsToPayoff} mo
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--green-600);">
                      ${(avalanche.monthsToPayoff / 12).toFixed(1)} years
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">Total Interest</div>
                    <div style="font-weight: 700; color: var(--green-700);">$${avalanche.totalInterestPaid.toFixed(
                      0
                    )}</div>
                  </div>
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">vs Minimum</div>
                    <div style="font-weight: 700; color: var(--green-700);">-$${avalancheSavings.toFixed(
                      0
                    )}</div>
                  </div>
                </div>

                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50);
                            border-radius: 0.375rem; font-size: 0.75rem;">
                  <strong>Strategy:</strong> Pay highest APR first<br>
                  <strong>Saves:</strong> ${
                    minPaymentOnly.monthsToPayoff - avalanche.monthsToPayoff
                  } months
                </div>
              </div>

              <!-- Snowball Method -->
              <div style="background: linear-gradient(135deg, var(--blue-50), var(--blue-100));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                            bestStrategy === "snowball"
                              ? "var(--blue-600)"
                              : "var(--blue-300)"
                          };
                          box-shadow: ${
                            bestStrategy === "snowball"
                              ? "0 4px 12px rgba(59, 130, 246, 0.3)"
                              : "none"
                          };">
                <h4 style="font-size: 1rem; font-weight: 700; color: var(--blue-900); margin-bottom: 1rem; text-align: center;">
                  ‚õÑ SNOWBALL
                  ${
                    bestStrategy === "snowball"
                      ? '<div style="font-size: 0.75rem; color: var(--blue-700); margin-top: 0.25rem;">‚≠ê RECOMMENDED</div>'
                      : ""
                  }
                </h4>

                <div style="background: var(--white); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">Time to Payoff</div>
                    <div style="font-size: 2rem; font-weight: 800; color: var(--blue-600);">
                      ${snowball.monthsToPayoff} mo
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--blue-600);">
                      ${(snowball.monthsToPayoff / 12).toFixed(1)} years
                    </div>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.875rem;">
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">Total Interest</div>
                    <div style="font-weight: 700; color: var(--blue-700);">$${snowball.totalInterestPaid.toFixed(
                      0
                    )}</div>
                  </div>
                  <div style="background: var(--white); padding: 0.75rem; border-radius: 0.375rem; text-align: center;">
                    <div style="color: var(--slate-600); font-size: 0.75rem;">vs Minimum</div>
                    <div style="font-weight: 700; color: var(--blue-700);">-$${snowballSavings.toFixed(
                      0
                    )}</div>
                  </div>
                </div>

                <div style="margin-top: 1rem; padding: 0.75rem; background: var(--blue-50);
                            border-radius: 0.375rem; font-size: 0.75rem;">
                  <strong>Strategy:</strong> Pay smallest balance first<br>
                  <strong>Saves:</strong> ${
                    minPaymentOnly.monthsToPayoff - snowball.monthsToPayoff
                  } months
                </div>
              </div>
            </div>

            <!-- Key Insights -->
            <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                        padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--indigo-200);">
              <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem; text-align: center;">
                üí° Key Insights & Recommendations
              </h4>

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Your Monthly Payment</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--indigo-700);">
                    $${totalPayment.toFixed(0)}/mo
                  </div>
                  ${
                    extraPayment > 0
                      ? `
                    <div style="font-size: 0.7rem; color: var(--purple-600); margin-top: 0.25rem;">
                      + $${extraPayment} in month ${extraPaymentMonth}
                    </div>
                  `
                      : ""
                  }
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Best Strategy</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: ${
                    bestStrategy === "avalanche"
                      ? "var(--green-700)"
                      : "var(--blue-700)"
                  };">
                    ${
                      bestStrategy === "avalanche"
                        ? "üéØ Avalanche"
                        : "‚õÑ Snowball"
                    }
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Interest Savings</div>
                  <div style="font-weight: 700; font-size: 1.1rem; color: var(--green-700);">
                    $${Math.max(avalancheSavings, snowballSavings).toFixed(0)}
                  </div>
                </div>
              </div>

              <div style="margin-top: 1rem; padding: 1rem; background: var(--white); border-radius: 0.5rem;
                          border-left: 4px solid var(--indigo-500); font-size: 0.875rem;">
                <strong>Why ${
                  bestStrategy === "avalanche" ? "Avalanche" : "Snowball"
                }?</strong>
                ${
                  bestStrategy === "avalanche"
                    ? `
                  Avalanche method saves you <strong>$${avalancheVsSnowball.toFixed(
                    0
                  )} more</strong> than Snowball by targeting high-interest debt first.
                  This is the mathematically optimal strategy for minimizing total interest paid.
                `
                    : `
                  While Snowball pays slightly more interest ($${avalancheVsSnowball.toFixed(
                    0
                  )} difference), it provides
                  <strong>psychological wins</strong> by eliminating cards faster, which helps maintain motivation.
                  ${
                    Math.abs(avalancheVsSnowball / avalancheSavings) < 0.05
                      ? "The difference is minimal (<5%), so choose what keeps you motivated!"
                      : ""
                  }
                `
                }
              </div>

              <button class="btn btn-primary" id="showDetailedBtn" style="margin-top: 1rem;">
                üìà Show Detailed Payment Schedule
              </button>
            </div>
          `;

          resultsDiv.classList.remove("hidden");
          
          // Add event listener for detailed view
          document
            .getElementById("showDetailedBtn")
            .addEventListener("click", () => {
              displayDetailedBreakdown(avalanche, snowball);
            });

          // Save state after calculation
          setTimeout(() => {
            StorageManager.saveCalculatorState('ccpo');
          }, 100);
        } 


        function displayDetailedBreakdown(avalanche, snowball) {
          const detailedDiv = document.getElementById("detailedBreakdown");

          detailedDiv.innerHTML = `
            <div style="background: var(--white); border-radius: 0.75rem; padding: 1.5rem;
                        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
              <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--slate-800);">
                üìÖ Month-by-Month Payment Schedule
              </h3>

              <div class="options-toggle" style="margin-bottom: 1.5rem;">
                <button class="option-btn active" id="avalancheDetailBtn">Avalanche Strategy</button>
                <button class="option-btn" id="snowballDetailBtn">Snowball Strategy</button>
              </div>

              <div id="avalancheDetail">
                ${renderPaymentSchedule(avalanche)}
              </div>

              <div id="snowballDetail" class="hidden">
                ${renderPaymentSchedule(snowball)}
              </div>
            </div>
          `;

          detailedDiv.classList.remove("hidden");

          // Toggle between strategies
          document
            .getElementById("avalancheDetailBtn")
            .addEventListener("click", (e) => {
              document
                .getElementById("avalancheDetailBtn")
                .classList.add("active");
              document
                .getElementById("snowballDetailBtn")
                .classList.remove("active");
              document
                .getElementById("avalancheDetail")
                .classList.remove("hidden");
              document.getElementById("snowballDetail").classList.add("hidden");
            });

          document
            .getElementById("snowballDetailBtn")
            .addEventListener("click", (e) => {
              document
                .getElementById("snowballDetailBtn")
                .classList.add("active");
              document
                .getElementById("avalancheDetailBtn")
                .classList.remove("active");
              document
                .getElementById("snowballDetail")
                .classList.remove("hidden");
              document
                .getElementById("avalancheDetail")
                .classList.add("hidden");
            });
        }

        function renderPaymentSchedule(strategy) {
          const { monthlyBreakdown, cardDetails } = strategy;

          // Group cards by payoff milestone
          const payoffMilestones = cardDetails
            .sort((a, b) => a.monthsPaid - b.monthsPaid)
            .map((card) => ({
              ...card,
              payoffMonth: card.monthsPaid,
            }));

          // Show first 12 months + every 6 months after
          const monthsToShow = [];
          for (let i = 1; i <= Math.min(12, monthlyBreakdown.length); i++) {
            monthsToShow.push(i);
          }
          for (let i = 18; i <= monthlyBreakdown.length; i += 6) {
            monthsToShow.push(i);
          }
          // Always include final month
          if (!monthsToShow.includes(monthlyBreakdown.length)) {
            monthsToShow.push(monthlyBreakdown.length);
          }

          return `
                  <!-- Payoff Timeline -->
                  <div style="background: var(--slate-50); padding: 1.25rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <h4 style="font-size: 1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
                      üéØ Debt Payoff Timeline
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                      ${payoffMilestones
                        .map(
                          (card, idx) => `
                        <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;
                                    border-left: 4px solid ${getCardColor(
                                      idx
                                    )};">
                          <div style="font-weight: 600; color: var(--slate-800); margin-bottom: 0.5rem;">
                            ${card.name}
                          </div>
                          <div style="font-size: 0.875rem; color: var(--slate-600);">
                            Paid off: <strong>Month ${card.payoffMonth}</strong>
                            <br>
                            Interest: <strong>$${card.totalInterestPaid.toFixed(
                              0
                            )}</strong>
                          </div>
                        </div>
                      `
                        )
                        .join("")}
                    </div>
                  </div>

                  <!-- Monthly Breakdown Table -->
                  <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                      <thead>
                        <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                          <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Month</th>
                          ${cardDetails
                            .map(
                              (card) => `
                            <th style="padding: 0.75rem; text-align: right; font-weight: 600;">${card.name}</th>
                          `
                            )
                            .join("")}
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Total Payment</th>
                          <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Remaining Debt</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${monthsToShow
                          .map((monthNum) => {
                            const month = monthlyBreakdown[monthNum - 1];

                            return `
                            <tr style="border-bottom: 1px solid var(--slate-200); ${
                              monthNum === monthlyBreakdown.length
                                ? "background: var(--green-50); font-weight: 600;"
                                : ""
                            }">
                              <td style="padding: 0.75rem; font-weight: 500;">
                                ${monthNum}
                                ${
                                  payoffMilestones.find(
                                    (c) => c.payoffMonth === monthNum
                                  )
                                    ? "üéâ"
                                    : ""
                                }
                              </td>
                              ${cardDetails
                                .map((card) => {
                                  const payment = month.payments.find(
                                    (p) => p.cardId === card.id
                                  );
                                  const isPaidOff =
                                    payment && payment.remainingBalance === 0;

                                  return `
                                  <td style="padding: 0.75rem; text-align: right; ${
                                    isPaidOff
                                      ? "color: var(--green-700); font-weight: 600;"
                                      : ""
                                  }">
                                    ${
                                      payment
                                        ? `$${payment.payment.toFixed(0)}`
                                        : "-"
                                    }
                                    ${isPaidOff ? " ‚úì" : ""}
                                  </td>
                                `;
                                })
                                .join("")}
                              <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                $${month.totalPaid.toFixed(0)}
                              </td>
                              <td style="padding: 0.75rem; text-align: right; font-weight: 600; ${
                                month.totalRemaining === 0
                                  ? "color: var(--green-700);"
                                  : ""
                              }">
                                $${month.totalRemaining.toFixed(0)}
                              </td>
                            </tr>
                          `;
                          })
                          .join("")}
                      </tbody>
                    </table>
                  </div>

                  <!-- Summary Stats -->
                  <div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                    <div style="background: var(--blue-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Debt Paid</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--blue-700);">
                        $${cardDetails
                          .reduce((sum, c) => sum + c.originalBalance, 0)
                          .toFixed(0)}
                      </div>
                    </div>

                    <div style="background: var(--red-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Interest</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--red-700);">
                        $${strategy.totalInterestPaid.toFixed(0)}
                      </div>
                    </div>

                    <div style="background: var(--green-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Time to Freedom</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--green-700);">
                        ${strategy.monthsToPayoff} months
                      </div>
                    </div>

                    <div style="background: var(--purple-50); padding: 1rem; border-radius: 0.5rem; text-align: center;">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">First Card Paid</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--purple-700);">
                        Month ${Math.min(
                          ...cardDetails.map((c) => c.monthsPaid)
                        )}
                      </div>
                    </div>
                  </div>

                  <!-- Action Items -->
                  <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, var(--indigo-50), var(--blue-50));
                              border-radius: 0.75rem; border-left: 4px solid var(--indigo-500);">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                      ‚úÖ Action Plan for Success
                    </h4>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.875rem; line-height: 1.8;">
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        üìå <strong>Set up automatic payments</strong> on all cards to avoid late fees
                      </li>
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        üéØ <strong>Focus extra payments</strong> on ${
                          strategy.strategyType === "avalanche"
                            ? "highest APR card"
                            : "smallest balance card"
                        } each month
                      </li>
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        üí∞ <strong>Allocate windfalls</strong> (tax refunds, bonuses) to accelerate payoff
                      </li>
                      <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--indigo-100);">
                        üîí <strong>Freeze new purchases</strong> on cards being paid down
                      </li>
                      <li style="padding: 0.5rem 0;">
                        üìä <strong>Review progress monthly</strong> and celebrate milestones (${
                          payoffMilestones.length
                        } cards to knock out!)
                      </li>
                    </ul>
                  </div>

                  <!-- Progress Visualization -->
                  <div style="margin-top: 1.5rem; padding: 1.25rem; background: var(--white); border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                      üìâ Debt Reduction Progress
                    </h4>
                    ${renderProgressChart(monthlyBreakdown, cardDetails)}
                  </div>
                `;
        }

        function renderProgressChart(monthlyBreakdown, cardDetails) {
          const maxDebt = monthlyBreakdown[0].totalRemaining;
          const milestones = [0, 25, 50, 75, 100];

          return `
                  <div style="position: relative; height: 300px; background: var(--slate-50); border-radius: 0.5rem; padding: 1rem;">
                    <!-- Y-axis labels -->
                    <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 60px; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem 0;">
                      ${milestones
                        .reverse()
                        .map(
                          (pct) => `
                        <div style="font-size: 0.75rem; color: var(--slate-600); text-align: right; padding-right: 0.5rem;">
                          $${((maxDebt * pct) / 100).toFixed(0)}
                        </div>
                      `
                        )
                        .join("")}
                    </div>

                    <!-- Chart area -->
                    <div style="position: absolute; left: 70px; right: 20px; top: 20px; bottom: 40px;">
                      ${renderDebtLine(monthlyBreakdown, maxDebt)}
                    </div>

                    <!-- X-axis -->
                    <div style="position: absolute; left: 70px; right: 20px; bottom: 10px; display: flex; justify-content: space-between;">
                      ${[0, 25, 50, 75, 100]
                        .map((pct) => {
                          const month = Math.floor(
                            (monthlyBreakdown.length * pct) / 100
                          );
                          return `<div style="font-size: 0.75rem; color: var(--slate-600);">Mo ${month}</div>`;
                        })
                        .join("")}
                    </div>
                  </div>

                  <div style="margin-top: 1rem; text-align: center; font-size: 0.875rem; color: var(--slate-600);">
                    üéØ Debt-free date: <strong>${new Date(
                      Date.now() +
                        monthlyBreakdown.length * 30 * 24 * 60 * 60 * 1000
                    ).toLocaleDateString("en-US", {
                      month: "short",
                      year: "numeric",
                    })}</strong>
                  </div>
                `;
        }

        function renderDebtLine(monthlyBreakdown, maxDebt) {
          const points = monthlyBreakdown
            .filter(
              (_, idx) =>
                idx % Math.ceil(monthlyBreakdown.length / 50) === 0 ||
                idx === monthlyBreakdown.length - 1
            )
            .map((month, idx, arr) => {
              const x = (idx / (arr.length - 1)) * 100;
              const y = 100 - (month.totalRemaining / maxDebt) * 100;
              return `${x},${y}`;
            })
            .join(" ");

          return `
                  <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" style="overflow: visible;">
                    <!-- Grid lines -->
                    ${[0, 25, 50, 75, 100]
                      .map(
                        (pct) => `
                      <line x1="0" y1="${pct}" x2="100" y2="${pct}" stroke="var(--slate-200)" stroke-width="0.2"/>
                    `
                      )
                      .join("")}

                    <!-- Debt line -->
                    <polyline
                      points="${points}"
                      fill="none"
                      stroke="var(--red-500)"
                      stroke-width="1"
                      vector-effect="non-scaling-stroke"
                    />

                    <!-- Fill area under line -->
                    <polygon
                      points="0,100 ${points} 100,100"
                      fill="var(--red-100)"
                      opacity="0.3"
                    />

                    <!-- End point marker -->
                    <circle
                      cx="${points.split(" ").pop().split(",")[0]}"
                      cy="${points.split(" ").pop().split(",")[1]}"
                      r="1.5"
                      fill="var(--green-600)"
                      vector-effect="non-scaling-stroke"
                    />
                  </svg>
                `;
        }

        function getCardColor(index) {
          const colors = [
            "var(--blue-500)",
            "var(--green-500)",
            "var(--purple-500)",
            "var(--orange-500)",
            "var(--cyan-500)",
            "var(--pink-500)",
            "var(--indigo-500)",
            "var(--red-500)",
            "var(--yellow-500)",
            "var(--teal-500)",
          ];
          return colors[index % colors.length];
        }
      }


      // --- TIME VS MONEY TRADE-OFF CALCULATOR ---
      function renderTimeMoneyCalculator() {
        return `
          <h2 class="calculator-title">‚è∞üí∞ Time vs Money Trade-Off Calculator</h2>

          <div class="explanation-box">
            <div class="explanation-title">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Stop Wasting Your Most Valuable Asset: TIME
            </div>
            <p class="explanation-text">
              <strong>Your time has different values in different contexts.</strong> This calculator helps you make rational decisions
              by comparing activities based on WHEN and HOW you can use your time.
            </p>
            <div class="explanation-note">
              <strong>Key Insight:</strong> Your "work hour" value is NOT always applicable. Weekend time, evening time, 
              and leisure time have different opportunity costs. We'll calculate the TRUE trade-off for each scenario.
            </div>
          </div>

          <!-- Your Time Profile -->
          <div style="background: linear-gradient(135deg, var(--indigo-50), var(--blue-50));
                      padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem; border: 2px solid var(--indigo-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
              üíº Your Time Profile
            </h3>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">üí∞ Work Hourly Rate ($/hr)</label>
                <input type="number" id="workHourlyRate" class="form-input" placeholder="30" step="1">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  What you actually earn per hour at work
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">‚è∞ Can You Work Extra Hours?</label>
                <select id="canWorkExtra" class="form-select">
                  <option value="yes">Yes - I can freelance/overtime</option>
                  <option value="limited">Limited - Sometimes possible</option>
                  <option value="no">No - Fixed salary/hours</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">üíµ Freelance/Side Hustle Rate ($/hr)</label>
                <input type="number" id="freelanceRate" class="form-input" placeholder="50" step="5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Leave blank if not applicable
                </div>
              </div>
            </div>

            <div id="profileSummary" class="hidden" style="margin-top: 1rem; padding: 1rem; background: var(--white);
                                                            border-radius: 0.5rem; border-left: 4px solid var(--indigo-500);">
              <!-- Will be populated by JS -->
            </div>
          </div>

          <!-- Scenario Selector -->
          <div style="background: var(--slate-50); padding: 1rem; border-radius: 0.75rem; margin-bottom: 2rem;">
            <h3 style="font-size: 1.1rem; font-weight: 600; color: var(--slate-700); margin-bottom: 1rem;">
              üéØ Choose Your Scenario
            </h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
              <button class="scenario-btn active" data-scenario="opportunity">
                üí∏ Opportunity Cost<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Is this deal worth my time?</span>
              </button>
              <button class="scenario-btn" data-scenario="sunk">
                üé¨ Sunk Cost Helper<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Should I quit or continue?</span>
              </button>
              <button class="scenario-btn" data-scenario="diy">
                üîß DIY vs Hire<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Do it myself or pay?</span>
              </button>
              <button class="scenario-btn" data-scenario="activity">
                üìä Activity Comparison<br>
                <span style="font-size: 0.75rem; font-weight: normal;">Compare multiple options</span>
              </button>
            </div>
          </div>

          <!-- Scenario Content -->
          <div id="scenarioContent"></div>

          <!-- Results -->
          <div id="timeMoneyResults" class="results-container hidden"
              style="border-color: var(--indigo-100); background-color: var(--indigo-50); margin-top: 2rem;">
          </div>
        `;
      }

      function setupTimeMoneyCalculator() {
        let activeScenario = "opportunity";
        let workRate = 0;
        let freelanceRate = 0;
        let canWorkExtra = "no";

        const workRateInput = document.getElementById("workHourlyRate");
        const freelanceRateInput = document.getElementById("freelanceRate");
        const canWorkExtraSelect = document.getElementById("canWorkExtra");
        const profileSummary = document.getElementById("profileSummary");

        function updateProfile() {
          workRate = parseFloat(workRateInput.value) || 0;
          freelanceRate = parseFloat(freelanceRateInput.value) || 0;
          canWorkExtra = canWorkExtraSelect.value;

          if (workRate > 0) {
            let opportunityCostText = "";

            if (canWorkExtra === "yes" && freelanceRate > 0) {
              opportunityCostText = `<strong>Your opportunity cost:</strong> $${freelanceRate.toFixed(
                2
              )}/hr (freelance rate)`;
            } else if (canWorkExtra === "yes") {
              opportunityCostText = `<strong>Your opportunity cost:</strong> $${workRate.toFixed(
                2
              )}/hr (work rate - you can work extra)`;
            } else if (canWorkExtra === "limited") {
              opportunityCostText = `<strong>Your opportunity cost:</strong> ~$${(
                workRate * 0.5
              ).toFixed(2)}/hr (limited extra work possible)`;
            } else {
              opportunityCostText = `<strong>Your opportunity cost:</strong> $0/hr for free time (fixed hours - can't work more)`;
            }

            profileSummary.innerHTML = `
              <div style="font-size: 0.875rem; line-height: 1.6;">
                <strong>Work Rate:</strong> $${workRate.toFixed(2)}/hr<br>
                ${
                  freelanceRate > 0
                    ? `<strong>Freelance Rate:</strong> $${freelanceRate.toFixed(
                        2
                      )}/hr<br>`
                    : ""
                }
                ${opportunityCostText}<br><br>
                <div style="background: var(--blue-50); padding: 0.75rem; border-radius: 0.375rem; margin-top: 0.5rem;">
                  <strong>üí° Important Context:</strong><br>
                  ${
                    canWorkExtra === "no"
                      ? '‚Ä¢ Your free time has NO monetary opportunity cost (you can\'t work more anyway)<br>‚Ä¢ Focus on ENJOYMENT and LONG-TERM VALUE instead<br>‚Ä¢ "Saving money" on free time is usually worth it'
                      : canWorkExtra === "limited"
                      ? "‚Ä¢ You can sometimes work extra, so time has PARTIAL monetary value<br>‚Ä¢ Weekend/evening activities: compare against 50% of work rate<br>‚Ä¢ High-value activities might be worth your limited extra work time"
                      : '‚Ä¢ You can freely trade time for money (freelance/overtime)<br>‚Ä¢ Any activity should beat your freelance rate to be "worth it"<br>‚Ä¢ Time spent on low-ROI activities = money left on the table'
                  }
                </div>
              </div>
            `;
            profileSummary.classList.remove("hidden");
          }
        }

        workRateInput.addEventListener("change", updateProfile);
        freelanceRateInput.addEventListener("change", updateProfile);
        canWorkExtraSelect.addEventListener("change", updateProfile);

        const scenarioBtns = document.querySelectorAll(".scenario-btn");
        scenarioBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            scenarioBtns.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            activeScenario = btn.dataset.scenario;
            loadScenario(activeScenario, {
              workRate,
              freelanceRate,
              canWorkExtra,
            });
          });
        });

        loadScenario("opportunity", { workRate, freelanceRate, canWorkExtra });

        function loadScenario(scenario, rates) {
          const content = document.getElementById("scenarioContent");

          switch (scenario) {
            case "opportunity":
              content.innerHTML = renderOpportunityCostNew();
              setupOpportunityCostNew(rates);
              break;
            case "sunk":
              content.innerHTML = renderSunkCost();
              setupSunkCost(rates.workRate);
              break;
            case "diy":
              content.innerHTML = renderDIYvsPay();
              setupDIYvsPay(rates.workRate);
              break;
            case "activity":
              content.innerHTML = renderActivityROI();
              setupActivityROI(rates.workRate);
              break;
          }

          // Save state after loading scenario
          setTimeout(() => {
            StorageManager.saveCalculatorState('time-money');
          }, 100);
        }
      }

      function renderOpportunityCostNew() {
        return `
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
              üí∏ Smart Opportunity Cost Calculator
            </h3>
            <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
              "Is this deal actually saving me money, or am I fooling myself?"
            </p>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">‚è∞ Time You'll Spend (hours)</label>
                <input type="number" id="oppTimeSpent" class="form-input" placeholder="1" step="0.25">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Total time including travel, waiting, etc.
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üí∞ Money You'll Save ($)</label>
                <input type="number" id="oppMoneySaved" class="form-input" placeholder="20" step="1">
              </div>

              <div class="form-group">
                <label class="form-label">üìÖ When Will You Do This?</label>
                <select id="oppTiming" class="form-select">
                  <option value="work">During Work Hours</option>
                  <option value="evening">Evening (after work)</option>
                  <option value="weekend">Weekend</option>
                  <option value="flexible">Flexible - anytime</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">üéØ Could You Work Instead?</label>
                <select id="oppCanWork" class="form-select">
                  <option value="yes">Yes - I could earn money in this time</option>
                  <option value="no">No - This is free/leisure time</option>
                </select>
              </div>
            </div>

            <button class="btn btn-primary" id="calculateOppNew">
              üßÆ Calculate TRUE Cost
            </button>
          </div>
        `;
      }

      function setupOpportunityCostNew(rates) {
        document
          .getElementById("calculateOppNew")
          .addEventListener("click", () => {
            if (rates.workRate === 0 || isNaN(rates.workRate)) {
              alert("Please set your work hourly rate first!");
              return;
            }

            const timeSpent = parseFloat(
              document.getElementById("oppTimeSpent").value
            );
            const moneySaved = parseFloat(
              document.getElementById("oppMoneySaved").value
            );
            const timing = document.getElementById("oppTiming").value;
            const canWork = document.getElementById("oppCanWork").value;

            if (isNaN(timeSpent) || isNaN(moneySaved) || timeSpent <= 0) {
              alert("Please enter valid time and money values");
              return;
            }

            let opportunityCost = 0;
            let reasoning = "";
            let context = "";

            if (canWork === "yes") {
              if (rates.canWorkExtra === "yes" && rates.freelanceRate > 0) {
                opportunityCost = rates.freelanceRate * timeSpent;
                reasoning = `You could earn $${rates.freelanceRate.toFixed(
                  2
                )}/hr freelancing`;
                context = "high";
              } else if (rates.canWorkExtra === "yes") {
                opportunityCost = rates.workRate * timeSpent;
                reasoning = `You could work overtime at $${rates.workRate.toFixed(
                  2
                )}/hr`;
                context = "high";
              } else if (timing === "work") {
                opportunityCost = rates.workRate * timeSpent;
                reasoning = `This takes away from paid work time`;
                context = "high";
              } else {
                opportunityCost = rates.workRate * 0.3 * timeSpent;
                reasoning = `Limited opportunity to work extra (30% of work rate)`;
                context = "medium";
              }
            } else {
              if (timing === "work") {
                opportunityCost = rates.workRate * timeSpent;
                reasoning = `This happens during work hours`;
                context = "high";
              } else {
                opportunityCost = 0;
                reasoning = `This is free time you can't monetize anyway`;
                context = "low";
              }
            }

            const netGain = moneySaved - opportunityCost;
            const effectiveRate = timeSpent > 0 ? moneySaved / timeSpent : 0;
            const isWorthIt = netGain > 0;

            displayOpportunityResults({
              timeSpent,
              moneySaved,
              opportunityCost,
              netGain,
              effectiveRate,
              isWorthIt,
              reasoning,
              context,
              timing,
              canWork,
              rates,
            });
          });
      }

      function displayOpportunityResults(data) {
        const resultsDiv = document.getElementById("timeMoneyResults");

        const contextColors = {
          high: {
            bg: "var(--red-50)",
            border: "var(--red-500)",
            text: "var(--red-800)",
          },
          medium: {
            bg: "var(--orange-50)",
            border: "var(--orange-500)",
            text: "var(--orange-800)",
          },
          low: {
            bg: "var(--blue-50)",
            border: "var(--blue-500)",
            text: "var(--blue-800)",
          },
        };

        const color = contextColors[data.context];

        resultsDiv.innerHTML = `
          <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
            ${
              data.isWorthIt
                ? "‚úÖ GOOD DEAL - Worth Your Time!"
                : "‚ùå BAD DEAL - Not Worth It!"
            }
          </h3>

          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
            <div style="background: var(--blue-100); padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Time Spent</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--blue-700);">
                ${data.timeSpent}h
              </div>
            </div>

            <div style="background: var(--green-100); padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Money Saved</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--green-700);">
                $${data.moneySaved.toFixed(2)}
              </div>
            </div>

            <div style="background: ${
              color.bg
            }; padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Opportunity Cost</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: ${
                color.text
              };">
                $${data.opportunityCost.toFixed(2)}
              </div>
              <div style="font-size: 0.7rem; margin-top: 0.25rem; color: ${
                color.text
              };">
                ${data.reasoning}
              </div>
            </div>

            <div style="background: ${
              data.isWorthIt ? "var(--green-100)" : "var(--red-100)"
            }; padding: 1rem; border-radius: 0.5rem; text-align: center;">
              <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Net Gain/Loss</div>
              <div style="font-weight: 700; font-size: 1.1rem; color: ${
                data.isWorthIt ? "var(--green-700)" : "var(--red-700)"
              };">
                ${data.netGain >= 0 ? "+" : ""}$${data.netGain.toFixed(2)}
              </div>
            </div>
          </div>

          <div style="background: linear-gradient(135deg, ${
            color.bg
          }, var(--indigo-50));
                      padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid ${
                        color.border
                      };">
            <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: ${
              color.text
            };">
              üí° Analysis:
            </h4>
            <div style="font-size: 0.875rem; line-height: 1.7; color: var(--slate-700);">
              <p style="margin-bottom: 1rem;">
                <strong>Your effective rate for this activity:</strong> $${data.effectiveRate.toFixed(
                  2
                )}/hr
              </p>
              
              <p style="margin-bottom: 1rem;">
                <strong>Context matters:</strong> ${data.reasoning}
                ${
                  data.context === "low"
                    ? " Since you can't work during this time anyway, the opportunity cost is effectively $0. Any money saved is pure gain!"
                    : data.context === "medium"
                    ? " You have limited ability to work extra, so we use a conservative 30% of your work rate as opportunity cost."
                    : " You could directly earn money during this time, so opportunity cost equals your earning potential."
                }
              </p>

              ${
                data.isWorthIt
                  ? `
                  <p style="background: var(--green-50); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--green-600);">
                    <strong style="color: var(--green-800);">‚úÖ This is worth it!</strong><br>
                    You're gaining $${data.netGain.toFixed(2)} net. ${
                      data.context === "low"
                        ? "Perfect use of free time that can't be monetized anyway."
                        : `You're earning $${data.effectiveRate.toFixed(
                            2
                          )}/hr, which beats your opportunity cost.`
                    }
                  </p>
                `
                  : `
                  <p style="background: var(--red-50); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--red-600);">
                    <strong style="color: var(--red-800);">‚ùå Not worth your time!</strong><br>
                    You're losing $${Math.abs(data.netGain).toFixed(2)} net. ${
                      data.canWork === "yes"
                        ? `You could earn $${data.opportunityCost.toFixed(
                            2
                          )} working instead.`
                        : "Your time during work hours is too valuable for this deal."
                    }
                  </p>
                `
              }

              <div style="margin-top: 1rem; padding: 1rem; background: var(--slate-50); border-radius: 0.5rem;">
                <strong>üéØ Rule of Thumb:</strong><br>
                ${
                  data.context === "low"
                    ? "‚Ä¢ Free time: Almost any money saved is good<br>‚Ä¢ Focus on enjoyment and learning value too"
                    : data.context === "medium"
                    ? "‚Ä¢ Limited work ability: Save at least $" +
                      (data.rates.workRate * 0.3 * data.timeSpent).toFixed(2) +
                      " for " +
                      data.timeSpent +
                      "h<br>‚Ä¢ Consider if it's worth giving up leisure time"
                    : "‚Ä¢ Can work freely: Must save more than $" +
                      data.opportunityCost.toFixed(2) +
                      "<br>‚Ä¢ Otherwise, work and pay full price instead"
                }
              </div>
            </div>
          </div>
        `;

        resultsDiv.classList.remove("hidden");
      }

      function renderSunkCost() {
        return `
                <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
                  <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                    üé¨ Sunk Cost Decision Helper
                  </h3>
                  <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
                    "Should I finish this movie/meeting/book, or cut my losses?"
                  </p>

                  <div class="form-grid">
                    <div class="form-group">
                      <label class="form-label">üíµ Money Already Spent ($)</label>
                      <input type="number" id="sunkMoney" class="form-input" placeholder="15" step="1">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                        Movie ticket, event fee, book price
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">‚è∞ Time Already Invested (min)</label>
                      <input type="number" id="sunkTime" class="form-input" placeholder="30" step="5">
                    </div>

                    <div class="form-group">
                      <label class="form-label">‚è±Ô∏è Remaining Time (min)</label>
                      <input type="number" id="remainingTime" class="form-input" placeholder="90" step="5">
                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                        How much longer if you stay
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form-label">üòê Current Satisfaction (1-10)</label>
                      <input type="range" id="satisfaction" class="form-input" min="1" max="10" value="5"
                            style="padding: 0.5rem 0;">
                      <div style="text-align: center; font-size: 1.5rem; margin-top: 0.5rem;" id="satisfactionEmoji">üòê</div>
                      <div style="text-align: center; font-size: 0.875rem; font-weight: 600; color: var(--slate-700);" id="satisfactionValue">5/10</div>
                    </div>
                  </div>

                  <button class="btn btn-danger" id="calculateSunk">
                    üö® Should I Quit or Continue?
                  </button>
                </div>
              `;
      }

      function setupSunkCost(hourlyRate) {
        // Satisfaction slider interactivity
        const satisfactionSlider = document.getElementById("satisfaction");
        const satisfactionEmoji = document.getElementById("satisfactionEmoji");
        const satisfactionValue = document.getElementById("satisfactionValue");

        const emojis = [
          "üò´",
          "üòû",
          "üòï",
          "üòê",
          "üôÇ",
          "üòä",
          "üòÉ",
          "üòÑ",
          "ü§©",
          "ü•≥",
        ];

        satisfactionSlider.addEventListener("input", (e) => {
          const value = parseInt(e.target.value);
          satisfactionValue.textContent = `${value}/10`;
          satisfactionEmoji.textContent = emojis[value - 1];
        });

        document
          .getElementById("calculateSunk")
          .addEventListener("click", () => {
            if (hourlyRate === 0) {
              alert("Please set your hourly rate first!");
              return;
            }

            const sunkMoney = parseFloat(
              document.getElementById("sunkMoney").value
            );
            const sunkTime = parseFloat(
              document.getElementById("sunkTime").value
            );
            const remainingTime = parseFloat(
              document.getElementById("remainingTime").value
            );
            const satisfaction = parseInt(
              document.getElementById("satisfaction").value
            );

            if (
              isNaN(sunkMoney) ||
              isNaN(sunkTime) ||
              isNaN(remainingTime) ||
              isNaN(satisfaction)
            ) {
              alert("Please fill in all fields");
              return;
            }

            // Calculations
            const sunkTimeValue = hourlyRate * (sunkTime / 60);
            const totalSunkCost = sunkMoney + sunkTimeValue;
            const futureCost = hourlyRate * (remainingTime / 60);

            // Suffering penalty: low satisfaction = higher cost
            const sufferingMultiplier = 1 + (10 - satisfaction) * 0.2; // 1.0 to 2.8x
            const adjustedFutureCost = futureCost * sufferingMultiplier;

            const totalLossIfContinue = totalSunkCost + adjustedFutureCost;
            const totalLossIfQuit = totalSunkCost;

            // N√™n quit n·∫øu future cost > 50% c·ªßa sunk cost (v√≠ d·ª•)
            const shouldQuit = adjustedFutureCost > totalSunkCost * 0.5;            
            const savingsFromQuitting = adjustedFutureCost;

            const resultsDiv = document.getElementById("timeMoneyResults");

            resultsDiv.innerHTML = `
                  <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center;
                              color: ${
                                shouldQuit
                                  ? "var(--red-700)"
                                  : "var(--green-700)"
                              };">
                    ${
                      shouldQuit
                        ? "üö® RECOMMENDATION: QUIT NOW"
                        : "‚úÖ FINISH IT - You're Almost Done"
                    }
                  </h3>

                  <!-- Sunk Cost Visualization -->
                  <div style="background: var(--slate-50); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
                    <h4 style="font-size: 1rem; font-weight: 600; color: var(--slate-800); margin-bottom: 1rem;">
                      üí∏ Cost Breakdown
                    </h4>

                    <div style="margin-bottom: 1.5rem;">
                      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; font-weight: 600;">Already Lost (SUNK COST)</span>
                        <span style="font-size: 0.875rem; font-weight: 700; color: var(--red-600);">
                          $${totalSunkCost.toFixed(2)}
                        </span>
                      </div>
                      <div style="background: var(--slate-200); height: 30px; border-radius: 0.5rem; overflow: hidden;">
                        <div style="background: linear-gradient(to right, var(--red-500), var(--red-600));
                                    height: 100%; width: 100%; display: flex; align-items: center; justify-content: center;
                                    color: white; font-weight: 700; font-size: 0.875rem;">
                          GONE FOREVER
                        </div>
                      </div>
                      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--slate-600);">
                        $${sunkMoney} (money) + $${sunkTimeValue.toFixed(
              2
            )} (${sunkTime} min)
                      </div>
                    </div>

                    <div>
                      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.875rem; font-weight: 600;">Additional Loss if You Stay</span>
                        <span style="font-size: 0.875rem; font-weight: 700; color: var(--orange-600);">
                          $${adjustedFutureCost.toFixed(2)}
                        </span>
                      </div>
                      <div style="background: var(--slate-200); height: 30px; border-radius: 0.5rem; overflow: hidden;">
                        <div style="background: linear-gradient(to right, var(--orange-400), var(--orange-600));
                                    height: 100%; width: ${
                                      (adjustedFutureCost /
                                        totalLossIfContinue) *
                                      100
                                    }%;
                                    display: flex; align-items: center; padding-left: 1rem;
                                    color: white; font-weight: 700; font-size: 0.875rem;">
                          ${
                            adjustedFutureCost > 10
                              ? "$" + adjustedFutureCost.toFixed(0)
                              : ""
                          }
                        </div>
                      </div>
                      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--slate-600);">
                        $${futureCost.toFixed(2)} base + ${(
              (sufferingMultiplier - 1) *
              100
            ).toFixed(0)}% suffering penalty
                      </div>
                    </div>
                  </div>

                  <!-- Comparison Cards -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Quit Option -->
                    <div style="background: linear-gradient(135deg, var(--green-50), var(--emerald-50));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                                  shouldQuit
                                    ? "var(--green-600)"
                                    : "var(--green-300)"
                                };
                                ${
                                  shouldQuit
                                    ? "box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
                                    : ""
                                }">
                      <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem; text-align: center;">
                        ‚úÖ OPTION A: QUIT NOW
                      </h4>

                      <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Loss</div>
                          <div style="font-size: 2rem; font-weight: 800; color: var(--green-600);">
                            $${totalLossIfQuit.toFixed(2)}
                          </div>
                        </div>
                      </div>

                      <div style="font-size: 0.875rem; line-height: 1.6;">
                        <strong style="color: var(--green-800);">‚úÖ You'll save:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                          <li>$${savingsFromQuitting.toFixed(
                            2
                          )} in opportunity cost</li>
                          <li>${remainingTime} minutes (${(
              remainingTime / 60
            ).toFixed(1)} hours)</li>
                          <li>Mental sanity (satisfaction: ${satisfaction}/10)</li>
                        </ul>
                      </div>

                      <div style="margin-top: 1rem; padding: 0.75rem; background: var(--green-50); border-radius: 0.375rem;
                                  font-size: 0.75rem; border-left: 3px solid var(--green-600);">
                        <strong>Better alternatives:</strong>
                        <br>‚Ä¢ Work ${remainingTime} min ‚Üí Earn $${futureCost.toFixed(
              2
            )}
                        <br>‚Ä¢ Learn a new skill
                        <br>‚Ä¢ Do something enjoyable
                      </div>
                    </div>

                    <!-- Continue Option -->
                    <div style="background: linear-gradient(135deg, var(--red-50), var(--orange-50));
                                padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                                  !shouldQuit
                                    ? "var(--blue-600)"
                                    : "var(--red-300)"
                                };">
                      <h4 style="font-size: 1rem; font-weight: 700; color: var(--red-900); margin-bottom: 1rem; text-align: center;">
                        ${shouldQuit ? "‚ùå" : "‚úÖ"} OPTION B: FINISH IT
                      </h4>

                      <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="text-align: center;">
                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Loss</div>
                          <div style="font-size: 2rem; font-weight: 800; color: ${
                            shouldQuit ? "var(--red-600)" : "var(--blue-600)"
                          };">
                            $${totalLossIfContinue.toFixed(2)}
                          </div>
                        </div>
                      </div>

                      <div style="font-size: 0.875rem; line-height: 1.6;">
                        <strong style="color: ${
                          shouldQuit ? "var(--red-800)" : "var(--blue-800)"
                        };">
                          ${
                            shouldQuit
                              ? "‚ùå Additional cost:"
                              : "‚úÖ Small additional cost:"
                          }
                        </strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                          <li>$${adjustedFutureCost.toFixed(
                            2
                          )} opportunity cost</li>
                          <li>${remainingTime} more minutes</li>
                          <li>${
                            satisfaction <= 3
                              ? "High suffering (low satisfaction)"
                              : satisfaction >= 7
                              ? "Minimal suffering (high satisfaction)"
                              : "Moderate suffering"
                          }</li>
                        </ul>
                      </div>

                      ${
                        shouldQuit
                          ? `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--red-50); border-radius: 0.375rem;
                                    font-size: 0.75rem; border-left: 3px solid var(--red-600);">
                          <strong>‚ö†Ô∏è Sunk Cost Fallacy Alert:</strong>
                          <br>Your brain says: "I paid $${sunkMoney}, I must finish!"
                          <br>Reality: That money is GONE. Staying = throwing $${adjustedFutureCost.toFixed(
                            2
                          )} after bad.
                        </div>
                      `
                          : `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--blue-50); border-radius: 0.375rem;
                                    font-size: 0.75rem; border-left: 3px solid var(--blue-600);">
                          <strong>üí° You're close to the end!</strong>
                          <br>Only ${remainingTime} min left, might as well finish.
                          <br>The additional cost is small relative to sunk cost.
                        </div>
                      `
                      }
                    </div>
                  </div>

                  <!-- Psychology Explanation -->
                  <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50));
                              padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--indigo-600);">
                    <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                      üß† Understanding the Sunk Cost Fallacy
                    </h4>

                    <div style="font-size: 0.875rem; line-height: 1.7; color: var(--slate-700);">
                      <p style="margin-bottom: 1rem;">
                        <strong>What is it?</strong> The sunk cost fallacy is the tendency to continue an endeavor
                        once an investment (money, time, effort) has been made, even when abandoning it would be more beneficial.
                      </p>

                      <p style="margin-bottom: 1rem;">
                        <strong>Why does your brain do this?</strong> Humans have loss aversion - we hate "wasting"
                        what we've already spent. But that cost is GONE regardless of your next decision.
                      </p>

                      <p style="margin-bottom: 1rem;">
                        <strong>The rational approach:</strong> Ignore sunk costs completely.
                        Only compare: <em>"What will I gain/lose from this point forward?"</em>
                      </p>

                      <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                        <strong style="color: var(--indigo-700);">Real-world examples:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                          <li>Finishing a terrible book you bought</li>
                          <li>Sitting through a boring movie</li>
                          <li>Continuing a failing business venture</li>
                          <li>Staying in a bad relationship</li>
                          <li>Eating food you don't like (already paid for buffet)</li>
                        </ul>
                      </div>

                      <div style="margin-top: 1rem; padding: 1rem; background: var(--indigo-100); border-radius: 0.5rem;">
                        <strong style="color: var(--indigo-900);">üéØ Your Decision:</strong>
                        <br><br>
                        Sunk cost (GONE): <strong>$${totalSunkCost.toFixed(
                          2
                        )}</strong>
                        <br>Future cost if stay: <strong>$${adjustedFutureCost.toFixed(
                          2
                        )}</strong>
                        <br>Savings if quit: <strong>$${savingsFromQuitting.toFixed(
                          2
                        )}</strong>
                        <br><br>
                        ${
                          shouldQuit
                            ? `<span style="color: var(--red-700); font-weight: 700;">
                            ‚ö†Ô∏è The sunk $${totalSunkCost.toFixed(
                              2
                            )} is already lost. Don't lose another $${adjustedFutureCost.toFixed(
                                2
                              )}!</span>`
                            : `<span style="color: var(--green-700); font-weight: 700;">
                            ‚úÖ You're almost done - the additional $${adjustedFutureCost.toFixed(
                              2
                            )} is worth completing.</span>`
                        }
                      </div>
                    </div>
                  </div>

                  <!-- Action Plan -->
                  ${
                    shouldQuit
                      ? `
                    <div style="margin-top: 1.5rem; padding: 1.5rem; background: var(--green-50); border-radius: 0.75rem;
                                border: 2px solid var(--green-400);">
                      <h4 style="font-size: 1rem; font-weight: 700; color: var(--green-900); margin-bottom: 1rem;">
                        üéØ Action Plan: What to Do Right Now
                      </h4>
                      <ol style="margin: 0; padding-left: 1.5rem; font-size: 0.875rem; line-height: 1.8;">
                        <li><strong>Stand up and leave</strong> (or close the tab/book)</li>
                        <li><strong>Don't feel guilty</strong> - you made the rational choice</li>
                        <li><strong>Use the saved ${remainingTime} min wisely:</strong>
                          <ul style="margin-top: 0.5rem;">
                            <li>Work on a side project (+$${futureCost.toFixed(
                              2
                            )})</li>
                            <li>Learn something valuable (future income boost)</li>
                            <li>Exercise (health = wealth)</li>
                            <li>Quality time with loved ones (priceless)</li>
                          </ul>
                        </li>
                        <li><strong>Learn for next time:</strong> Avoid similar situations (read reviews, leave earlier)</li>
                      </ol>
                    </div>
                  `
                      : ""
                  }
                `;

            resultsDiv.classList.remove("hidden");
          });
      }

      function renderDIYvsPay() {
        return `
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
              üîß DIY vs Pay Professional Calculator
            </h3>
            <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
              "Should I fix it myself or hire someone?"
            </p>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">‚è∞ DIY Work Time (hours)</label>
                <input type="number" id="diyWorkTime" class="form-input" placeholder="4" step="0.5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Actual hands-on work
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üìö Learning Time (hours)</label>
                <input type="number" id="diyLearningTime" class="form-input" placeholder="2" step="0.5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  YouTube tutorials, reading manuals
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üé≤ Failure Risk (%)</label>
                <input type="number" id="failureRisk" class="form-input" placeholder="30" step="5" min="0" max="100">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Chance you mess it up (0-100%)
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üîÅ Redo Time if Fail (hours)</label>
                <input type="number" id="redoTime" class="form-input" placeholder="2" step="0.5">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Time to fix your mistakes
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üí∞ Professional Cost ($)</label>
                <input type="number" id="professionalCost" class="form-input" placeholder="200" step="10">
              </div>

              <div class="form-group">
                <label class="form-label">üõ†Ô∏è Materials Cost ($)</label>
                <input type="number" id="materialsCost" class="form-input" placeholder="50" step="10">
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Same for both DIY and pro
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">üò∞ Stress Level (1-10)</label>
                <input type="range" id="stressLevel" class="form-input" min="1" max="10" value="7"
                       style="padding: 0.5rem 0;">
                <div style="text-align: center; font-size: 1.5rem; margin-top: 0.5rem;" id="stressEmoji">üò∞</div>
                <div style="text-align: center; font-size: 0.875rem; font-weight: 600; color: var(--slate-700);" id="stressValue">7/10</div>
              </div>

              <div class="form-group">
                <label class="form-label">üòä Do You Enjoy This?</label>
                <select id="enjoymentLevel" class="form-select">
                  <option value="0">üò´ Hate it (-$50 value)</option>
                  <option value="1">üòê Neutral ($0)</option>
                  <option value="2">üôÇ Mild enjoyment (+$25)</option>
                  <option value="3">üòÉ Love it (+$50)</option>
                </select>
                <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                  Leisure value of DIY
                </div>
              </div>
            </div>

            <button class="btn btn-warning" id="calculateDIY">
              üî® Calculate: DIY or Hire?
            </button>
          </div>
        `;
      }

      function setupDIYvsPay(hourlyRate) {
        // Stress slider interactivity
        const stressSlider = document.getElementById("stressLevel");
        const stressEmoji = document.getElementById("stressEmoji");
        const stressValue = document.getElementById("stressValue");

        const stressEmojis = [
          "üòä",
          "üôÇ",
          "üòê",
          "üòï",
          "üòü",
          "üò∞",
          "üò´",
          "üò±",
          "ü§Ø",
          "üíÄ",
        ];

        stressSlider.addEventListener("input", (e) => {
          const value = parseInt(e.target.value);
          stressValue.textContent = `${value}/10`;
          stressEmoji.textContent = stressEmojis[value - 1];
        });

        document
          .getElementById("calculateDIY")
          .addEventListener("click", () => {
            if (hourlyRate === 0) {
              alert("Please set your hourly rate first!");
              return;
            }

            const diyWorkTime = parseFloat(
              document.getElementById("diyWorkTime").value
            );
            const diyLearningTime = parseFloat(
              document.getElementById("diyLearningTime").value
            );
            const failureRisk =
              parseFloat(document.getElementById("failureRisk").value) / 100;
            const redoTime = parseFloat(
              document.getElementById("redoTime").value
            );
            const professionalCost = parseFloat(
              document.getElementById("professionalCost").value
            );
            const materialsCost = parseFloat(
              document.getElementById("materialsCost").value
            );
            const stressLevel = parseInt(
              document.getElementById("stressLevel").value
            );
            const enjoymentLevel = parseInt(
              document.getElementById("enjoymentLevel").value
            );

            if (
              isNaN(diyWorkTime) ||
              isNaN(diyLearningTime) ||
              isNaN(failureRisk) ||
              isNaN(redoTime) ||
              isNaN(professionalCost) ||
              isNaN(materialsCost)
            ) {
              alert("Please fill in all fields");
              return;
            }

            // DIY Calculations
            const totalDIYTime = diyWorkTime + diyLearningTime;
            const diyTimeCost = totalDIYTime * hourlyRate;
            const failureCost =
              failureRisk * (redoTime * hourlyRate + materialsCost); // Risk of wasting time + materials
            const stressCost = (stressLevel / 10) * 50; // High stress = up to $50 penalty

            const enjoymentValues = [-50, 0, 25, 50];
            const enjoymentValue = enjoymentValues[enjoymentLevel];

            const totalDIYCost =
              diyTimeCost +
              failureCost +
              stressCost +
              materialsCost -
              enjoymentValue;

            // Professional Calculations
            const professionalTimeSaved = totalDIYTime;
            const professionalOpportunityCost =
              professionalTimeSaved * hourlyRate - professionalCost; // Negative if pro is more expensive than your time saved
            const totalProfessionalCost =
              professionalCost + materialsCost - professionalOpportunityCost;

            const shouldHirePro = totalProfessionalCost < totalDIYCost;
            const savings = Math.abs(totalDIYCost - totalProfessionalCost);

            const resultsDiv = document.getElementById("timeMoneyResults");

            resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center;
                        color: ${
                          shouldHirePro ? "var(--blue-700)" : "var(--green-700)"
                        };">
              ${
                shouldHirePro
                  ? "üíº HIRE THE PROFESSIONAL"
                  : "üî® DO IT YOURSELF (DIY)"
              }
            </h3>

            <!-- Comparison Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
              <!-- DIY Option -->
              <div style="background: linear-gradient(135deg, var(--orange-50), var(--red-50));
                          padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                            !shouldHirePro
                              ? "var(--green-600)"
                              : "var(--orange-300)"
                          };
                          ${
                            !shouldHirePro
                              ? "box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);"
                              : ""
                          }">
                <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--orange-900); margin-bottom: 1rem; text-align: center;">
                  ${!shouldHirePro ? "‚úÖ" : "‚ùå"} DIY OPTION
                </h4>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                  <div style="text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Cost</div>
                    <div style="font-size: 2rem; font-weight: 800; color: ${
                      !shouldHirePro ? "var(--green-600)" : "var(--orange-600)"
                    };">
                      $${totalDIYCost.toFixed(2)}
                    </div>
                  </div>
                </div>

                <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                  <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-700); margin-bottom: 0.75rem;">
                    Cost Breakdown:
                                </h5>
                                <div style="font-size: 0.8rem; line-height: 1.8; color: var(--slate-600);">
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>‚è∞ Time cost (${totalDIYTime}h)</span>
                                    <span style="font-weight: 600;">$${diyTimeCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üé≤ Failure risk (${(
                                      failureRisk * 100
                                    ).toFixed(0)}%)</span>
                                    <span style="font-weight: 600;">$${failureCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üò∞ Stress penalty</span>
                                    <span style="font-weight: 600;">$${stressCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üõ†Ô∏è Materials</span>
                                    <span style="font-weight: 600;">$${materialsCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; ${
                                    enjoymentValue >= 0
                                      ? "color: var(--green-600);"
                                      : "color: var(--red-600);"
                                  }">
                                    <span>üòä Enjoyment value</span>
                                    <span style="font-weight: 600;">${
                                      enjoymentValue >= 0 ? "+" : ""
                                    }$${enjoymentValue.toFixed(2)}</span>
                                  </div>
                                </div>
                              </div>

                              <div style="font-size: 0.875rem; line-height: 1.6;">
                                <strong style="color: ${
                                  !shouldHirePro
                                    ? "var(--green-800)"
                                    : "var(--orange-800)"
                                };">
                                  ${!shouldHirePro ? "‚úÖ Pros:" : "‚ö†Ô∏è Risks:"}
                                </strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                  ${
                                    !shouldHirePro
                                      ? `
                                    <li>Save $${savings.toFixed(
                                      2
                                    )} vs hiring pro</li>
                                    <li>Learn a new skill (${diyLearningTime}h investment)</li>
                                    ${
                                      enjoymentValue > 0
                                        ? "<li>Enjoyable activity (+$" +
                                          enjoymentValue +
                                          ")</li>"
                                        : ""
                                    }
                                  `
                                      : `
                                    <li>Lose $${savings.toFixed(
                                      2
                                    )} vs hiring pro</li>
                                    <li>${(failureRisk * 100).toFixed(
                                      0
                                    )}% chance of failure</li>
                                    <li>High stress (${stressLevel}/10)</li>
                                    <li>${totalDIYTime}h of your valuable time</li>
                                  `
                                  }
                                </ul>
                              </div>

                              <div style="margin-top: 1rem; padding: 0.75rem; background: ${
                                !shouldHirePro
                                  ? "var(--green-50)"
                                  : "var(--orange-100)"
                              }; 
                                          border-radius: 0.375rem; font-size: 0.75rem; border-left: 3px solid ${
                                            !shouldHirePro
                                              ? "var(--green-600)"
                                              : "var(--orange-600)"
                                          };">
                                ${
                                  !shouldHirePro
                                    ? `
                                  <strong>üéØ When DIY makes sense:</strong>
                                  <br>‚úÖ You enjoy it (leisure value)
                                  <br>‚úÖ Skill has future value (recurring task)
                                  <br>‚úÖ Pro cost > 2√ó your time value
                                `
                                    : `
                                  <strong>‚ö†Ô∏è DIY Warning:</strong>
                                  <br>You're paying $${totalDIYCost.toFixed(
                                    2
                                  )} to do something
                                  <br>a pro would do for $${professionalCost.toFixed(
                                    2
                                  )}.
                                `
                                }
                              </div>
                            </div>

                            <!-- Professional Option -->
                            <div style="background: linear-gradient(135deg, var(--blue-50), var(--cyan-50)); 
                                        padding: 1.5rem; border-radius: 0.75rem; border: 2px solid ${
                                          shouldHirePro
                                            ? "var(--blue-600)"
                                            : "var(--blue-300)"
                                        };
                                        ${
                                          shouldHirePro
                                            ? "box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);"
                                            : ""
                                        }">
                              <h4 style="font-size: 1.1rem; font-weight: 700; color: var(--blue-900); margin-bottom: 1rem; text-align: center;">
                                ${shouldHirePro ? "‚úÖ" : "‚ùå"} HIRE PROFESSIONAL
                              </h4>

                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <div style="text-align: center;">
                                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.5rem;">Total Cost</div>
                                  <div style="font-size: 2rem; font-weight: 800; color: ${
                                    shouldHirePro
                                      ? "var(--blue-600)"
                                      : "var(--red-600)"
                                  };">
                                    $${totalProfessionalCost.toFixed(2)}
                                  </div>
                                </div>
                              </div>

                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--slate-700); margin-bottom: 0.75rem;">
                                  Cost Breakdown:
                                </h5>
                                <div style="font-size: 0.8rem; line-height: 1.8; color: var(--slate-600);">
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üíº Service fee</span>
                                    <span style="font-weight: 600;">$${professionalCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid var(--slate-200);">
                                    <span>üõ†Ô∏è Materials</span>
                                    <span style="font-weight: 600;">$${materialsCost.toFixed(
                                      2
                                    )}</span>
                                  </div>
                                  <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; color: var(--green-600);">
                                    <span>‚è∞ Time saved (${professionalTimeSaved}h)</span>
                                    <span style="font-weight: 600;">-$${Math.abs(
                                      professionalOpportunityCost
                                    ).toFixed(2)}</span>
                                  </div>
                                </div>
                              </div>

                              <div style="font-size: 0.875rem; line-height: 1.6;">
                                <strong style="color: ${
                                  shouldHirePro
                                    ? "var(--blue-800)"
                                    : "var(--red-800)"
                                };">
                                  ${
                                    shouldHirePro
                                      ? "‚úÖ Benefits:"
                                      : "‚ö†Ô∏è Downside:"
                                  }
                                </strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                  ${
                                    shouldHirePro
                                      ? `
                                    <li>Save $${savings.toFixed(2)} net</li>
                                    <li>Zero stress üòä</li>
                                    <li>Guaranteed quality</li>
                                    <li>Save ${professionalTimeSaved}h ($${(
                                          professionalTimeSaved * hourlyRate
                                        ).toFixed(2)} value)</li>
                                    <li>Use time for higher-value work</li>
                                  `
                                      : `
                                    <li>Pay $${savings.toFixed(
                                      2
                                    )} more than DIY</li>
                                    <li>No skill gained</li>
                                    <li>Less satisfying if you enjoy DIY</li>
                                  `
                                  }
                                </ul>
                              </div>

                              <div style="margin-top: 1rem; padding: 0.75rem; background: ${
                                shouldHirePro
                                  ? "var(--blue-50)"
                                  : "var(--slate-100)"
                              }; 
                                          border-radius: 0.375rem; font-size: 0.75rem; border-left: 3px solid ${
                                            shouldHirePro
                                              ? "var(--blue-600)"
                                              : "var(--slate-400)"
                                          };">
                                ${
                                  shouldHirePro
                                    ? `
                                  <strong>üí° Best use of saved ${professionalTimeSaved}h:</strong>
                                  <br>‚Ä¢ Work/freelance ‚Üí Earn $${(
                                    professionalTimeSaved * hourlyRate
                                  ).toFixed(2)}
                                  <br>‚Ä¢ Learn high-value skill
                                  <br>‚Ä¢ Quality time with family
                                  <br>‚Ä¢ Rest & recharge
                                `
                                    : `
                                  <strong>When to hire a pro:</strong>
                                  <br>‚Ä¢ Pro cost < Your time value
                                  <br>‚Ä¢ High failure risk
                                  <br>‚Ä¢ You hate the task
                                  <br>‚Ä¢ One-time job (no skill reuse)
                                `
                                }
                              </div>
                            </div>
                          </div>

                          <!-- Decision Matrix -->
                          <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50)); 
                                      padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--indigo-600); margin-bottom: 2rem;">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                              üéØ The Math Behind Your Decision
                            </h4>

                            <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; font-size: 0.875rem; margin-bottom: 1rem;">
                              <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: center;">
                                <span><strong>Your hourly rate:</strong></span>
                                <span style="font-weight: 700; color: var(--indigo-700);">$${hourlyRate.toFixed(
                                  2
                                )}/hr</span>
                                
                                <span>DIY time investment:</span>
                                <span>${totalDIYTime}h = $${diyTimeCost.toFixed(
              2
            )}</span>
                                
                                <span>Professional fee:</span>
                                <span>$${professionalCost.toFixed(2)}</span>
                                
                                <span style="padding-top: 0.5rem; border-top: 2px solid var(--slate-200);"><strong>Break-even analysis:</strong></span>
                                <span style="padding-top: 0.5rem; border-top: 2px solid var(--slate-200);"></span>
                                
                                <span>DIY makes sense if pro cost ></span>
                                <span style="font-weight: 700; color: var(--green-600);">$${(
                                  diyTimeCost * 2
                                ).toFixed(2)}</span>
                              </div>
                            </div>

                            <div style="font-size: 0.875rem; line-height: 1.7; color: var(--slate-700);">
                              <p style="margin-bottom: 0.5rem;">
                                <strong>Rule of thumb:</strong> Hire a pro if the cost is less than 2√ó your time value.
                              </p>
                              <p style="margin-bottom: 0.5rem;">
                                In your case: Pro costs $${professionalCost.toFixed(
                                  2
                                )}, your time is worth $${diyTimeCost.toFixed(
              2
            )}.
                              </p>
                              <p>
                                <strong>Verdict:</strong> 
                                ${
                                  shouldHirePro
                                    ? `Pro is ${(
                                        (1 -
                                          totalProfessionalCost /
                                            totalDIYCost) *
                                        100
                                      ).toFixed(0)}% cheaper than DIY. ‚úÖ`
                                    : `DIY is ${(
                                        (1 -
                                          totalDIYCost /
                                            totalProfessionalCost) *
                                        100
                                      ).toFixed(0)}% cheaper than pro. ${
                                        enjoymentValue > 0
                                          ? "(Plus you enjoy it!) üéâ"
                                          : ""
                                      }`
                                }
                              </p>
                            </div>
                          </div>

                          <!-- Special Cases -->
                          <div style="background: var(--slate-50); padding: 1.5rem; border-radius: 0.75rem;">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              ü§î When Should You Override This Recommendation?
                            </h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--green-600);">
                                <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--green-800); margin-bottom: 0.75rem;">
                                  ‚úÖ DIY Even If More Expensive:
                                </h5>
                                <ul style="font-size: 0.8rem; line-height: 1.6; margin: 0; padding-left: 1.5rem;">
                                  <li>You genuinely enjoy the work</li>
                                  <li>Skill has future value (recurring task)</li>
                                  <li>Learning experience worth the cost</li>
                                  <li>Emergency & can't wait for pro</li>
                                  <li>Simple task, low failure risk</li>
                                </ul>
                              </div>

                              <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--blue-600);">
                                <h5 style="font-size: 0.875rem; font-weight: 600; color: var(--blue-800); margin-bottom: 0.75rem;">
                                  üíº Hire Pro Even If DIY Cheaper:
                                </h5>
                                <ul style="font-size: 0.8rem; line-height: 1.6; margin: 0; padding-left: 1.5rem;">
                                  <li>Dangerous work (electrical, structural)</li>
                                  <li>Warranty/insurance required</li>
                                  <li>High stakes (can't afford failure)</li>
                                  <li>One-time job (no skill reuse)</li>
                                  <li>You're already overwhelmed</li>
                                </ul>
                              </div>
                            </div>
                          </div>

                          <!-- Real Examples -->
                          <div style="margin-top: 1.5rem; background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              üìä Real-World Examples (Based on $${hourlyRate.toFixed(
                                2
                              )}/hr rate)
                            </h4>
                            
                            <div style="overflow-x: auto;">
                              <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                <thead>
                                  <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Task</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">DIY Time</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Pro Cost</th>
                                    <th style="padding: 0.75rem; text-align: center; font-weight: 600;">Verdict</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  ${[
                                    {
                                      task: "Oil change",
                                      diyTime: 0.5,
                                      proCost: 40,
                                      verdict:
                                        hourlyRate * 0.5 < 40 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Lawn mowing",
                                      diyTime: 1,
                                      proCost: 50,
                                      verdict:
                                        hourlyRate * 1 < 50 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "House cleaning",
                                      diyTime: 3,
                                      proCost: 120,
                                      verdict:
                                        hourlyRate * 3 < 120 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Assemble IKEA furniture",
                                      diyTime: 2,
                                      proCost: 80,
                                      verdict:
                                        hourlyRate * 2 < 80 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Paint room",
                                      diyTime: 8,
                                      proCost: 400,
                                      verdict:
                                        hourlyRate * 8 < 400 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Fix leaky faucet",
                                      diyTime: 1.5,
                                      proCost: 150,
                                      verdict:
                                        hourlyRate * 1.5 < 150 ? "DIY" : "Pro",
                                    },
                                    {
                                      task: "Tax filing",
                                      diyTime: 4,
                                      proCost: 200,
                                      verdict:
                                        hourlyRate * 4 < 200 ? "DIY" : "Pro",
                                    },
                                  ]
                                    .map((item) => {
                                      const diyValue =
                                        hourlyRate * item.diyTime;
                                      const shouldDIY = diyValue < item.proCost;
                                      return `
                                      <tr style="border-bottom: 1px solid var(--slate-200);">
                                        <td style="padding: 0.75rem;">${
                                          item.task
                                        }</td>
                                        <td style="padding: 0.75rem; text-align: right;">${
                                          item.diyTime
                                        }h ($${diyValue.toFixed(0)})</td>
                                        <td style="padding: 0.75rem; text-align: right;">$${
                                          item.proCost
                                        }</td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                          <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: 600;
                                                      background: ${
                                                        shouldDIY
                                                          ? "var(--green-100)"
                                                          : "var(--blue-100)"
                                                      };
                                                      color: ${
                                                        shouldDIY
                                                          ? "var(--green-800)"
                                                          : "var(--blue-800)"
                                                      };">
                                            ${shouldDIY ? "üî® DIY" : "üíº Hire"}
                                          </span>
                                        </td>
                                      </tr>
                                    `;
                                    })
                                    .join("")}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        `;

            resultsDiv.classList.remove("hidden");
          });
      }

      function renderActivityROI() {
        return `
          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 2px solid var(--slate-200);">
            <h3 style="font-size: 1.1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
              üìä Activity ROI Comparator
            </h3>
            <p style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1.5rem;">
              "Compare multiple activities to find the best use of your time"
            </p>

            <div id="activitiesContainer">
              <!-- Activities will be added here -->
            </div>

            <button class="btn btn-secondary" id="addActivityBtn" style="margin-bottom: 1rem;">
              ‚ûï Add Activity to Compare
            </button>

            <button class="btn btn-success" id="compareActivitiesBtn">
              üìä Compare & Rank Activities
            </button>
          </div>
        `;
      }

      function setupActivityROI(hourlyRate) {
        let activities = [];
        let activityCounter = 1;

        // Add initial activities
        addActivity();
        addActivity();

        function addActivity() {
          const id = activityCounter++;
          activities.push({
            id,
            name: `Activity ${id}`,
            timeHours: 0,
            moneyImpact: 0,
            type: "cost", // cost or income
            futureValue: 0,
            enjoyment: 5,
          });
          renderActivities();
        }

        function removeActivity(id) {
          activities = activities.filter((a) => a.id !== id);
          renderActivities();
        }

        function renderActivities() {
          const container = document.getElementById("activitiesContainer");

          container.innerHTML = activities
            .map(
              (activity) => `
            <div class="activity-row" data-activity-id="${activity.id}" style="
              background: var(--slate-50); 
              padding: 1rem; 
              border-radius: 0.5rem; 
              margin-bottom: 1rem;
              border: 2px solid var(--slate-200);
            ">
              <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Activity Name</label>
                  <input type="text" class="form-input activity-name" value="${
                    activity.name
                  }" 
                        placeholder="e.g. Freelance work, Cook at home">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Time (hours)</label>
                  <input type="number" class="form-input activity-time" value="${
                    activity.timeHours
                  }" 
                        placeholder="2" step="0.25">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">Type</label>
                  <select class="form-select activity-type">
                    <option value="income" ${
                      activity.type === "income" ? "selected" : ""
                    }>üí∞ Earn Money</option>
                    <option value="cost" ${
                      activity.type === "cost" ? "selected" : ""
                    }>üí∏ Save Money</option>
                    <option value="expense" ${
                      activity.type === "expense" ? "selected" : ""
                    }>‚ùå Costs Money</option>
                    <option value="learning" ${
                      activity.type === "learning" ? "selected" : ""
                    }>üìö Learning</option>
                    <option value="leisure" ${
                      activity.type === "leisure" ? "selected" : ""
                    }>üòä Leisure</option>
                  </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                  <label class="form-label">$ Amount</label>
                  <input type="number" class="form-input activity-money" value="${
                    activity.moneyImpact
                  }" 
                        placeholder="50" step="10">
                </div>
                
                <button class="remove-activity-btn" data-activity-id="${
                  activity.id
                }" style="
                  background: var(--red-500);
                  color: white;
                  border: none;
                  border-radius: 0.375rem;
                  padding: 0.5rem 0.75rem;
                  cursor: pointer;
                  font-weight: 600;
                ">
                  üóëÔ∏è
                </button>
              </div>

              <!-- Additional fields for learning/leisure -->
              ${
                activity.type === "learning"
                  ? `
                <div style="margin-top: 1rem;">
                  <label class="form-label">Future Monthly Income Boost ($)</label>
                  <input type="number" class="form-input activity-future" value="${activity.futureValue}" 
                        placeholder="500" step="50">
                  <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                    Expected income increase from this skill
                  </div>
                </div>
              `
                  : activity.type === "leisure"
                  ? `
                <div style="margin-top: 1rem;">
                  <label class="form-label">Enjoyment Value (1-10)</label>
                  <input type="range" class="form-input activity-enjoyment" min="1" max="10" value="${
                    activity.enjoyment
                  }" 
                        style="padding: 0.5rem 0;">
                  <div style="text-align: center; font-size: 0.875rem; margin-top: 0.25rem;">
                    <strong>${activity.enjoyment}/10</strong> - Worth $${(
                      activity.enjoyment * 10
                    ).toFixed(0)} in mental health value
                  </div>
                </div>
              `
                  : ""
              }
            </div>
          `
            )
            .join("");

          // Attach event listeners
          document.querySelectorAll(".remove-activity-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const activityId = parseInt(e.target.dataset.activityId);
              if (activities.length > 1) {
                removeActivity(activityId);
              } else {
                alert("You must have at least one activity");
              }
            });
          });

          // Update activity data on input change
          document.querySelectorAll(".activity-row").forEach((row) => {
            const activityId = parseInt(row.dataset.activityId);
            const activity = activities.find((a) => a.id === activityId);

            row
              .querySelector(".activity-name")
              .addEventListener("input", (e) => {
                activity.name = e.target.value;
              });

            row
              .querySelector(".activity-time")
              .addEventListener("input", (e) => {
                activity.timeHours = parseFloat(e.target.value) || 0;
              });

            row
              .querySelector(".activity-type")
              .addEventListener("change", (e) => {
                activity.type = e.target.value;
                renderActivities(); // Re-render to show/hide additional fields
              });

            row
              .querySelector(".activity-money")
              .addEventListener("input", (e) => {
                activity.moneyImpact = parseFloat(e.target.value) || 0;
              });

            const futureInput = row.querySelector(".activity-future");
            if (futureInput) {
              futureInput.addEventListener("input", (e) => {
                activity.futureValue = parseFloat(e.target.value) || 0;
              });
            }

            const enjoymentInput = row.querySelector(".activity-enjoyment");
            if (enjoymentInput) {
              enjoymentInput.addEventListener("input", (e) => {
                activity.enjoyment = parseInt(e.target.value);
                renderActivities(); // Update enjoyment display
              });
            }
          });
        }

        document
          .getElementById("addActivityBtn")
          .addEventListener("click", () => {
            if (activities.length < 10) {
              addActivity();
            } else {
              alert("Maximum 10 activities allowed");
            }
          });

        document
          .getElementById("compareActivitiesBtn")
          .addEventListener("click", () => {
            if (hourlyRate === 0) {
              alert("Please set your hourly rate first!");
              return;
            }

            if (
              activities.some((a) => a.timeHours === 0 || a.name.trim() === "")
            ) {
              alert("Please fill in all activity names and time values");
              return;
            }

            // Calculate ROI for each activity
            const results = activities.map((activity) => {
              const timeCost = activity.timeHours * hourlyRate;
              let netValue = 0;
              let roi = 0;
              let description = "";

              switch (activity.type) {
                case "income":
                  netValue = activity.moneyImpact - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Earn $${activity.moneyImpact} in ${activity.timeHours}h`;
                  break;

                case "cost":
                  netValue = activity.moneyImpact - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Save $${activity.moneyImpact} in ${activity.timeHours}h`;
                  break;

                case "expense":
                  netValue = -(activity.moneyImpact + timeCost);
                  roi = (netValue / timeCost) * 100;
                  description = `Costs $${activity.moneyImpact} + ${activity.timeHours}h time`;
                  break;

                case "learning":
                  // Assume skill pays off over 12 months
                  const futureGainPV = activity.futureValue * 6; // 6 months of benefit (conservative)
                  netValue = futureGainPV - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Learn ‚Üí +$${activity.futureValue}/mo future income`;
                  break;

                case "leisure":
                  const leisureValue = activity.enjoyment * 10; // $10 per enjoyment point
                  netValue = leisureValue - timeCost;
                  roi = (netValue / timeCost) * 100;
                  description = `Leisure (${activity.enjoyment}/10 enjoyment)`;
                  break;
              }

              return {
                ...activity,
                timeCost,
                netValue,
                roi,
                description,
                hourlyRate: netValue / activity.timeHours,
              };
            });

            // Sort by ROI (highest first)
            results.sort((a, b) => b.roi - a.roi);

            displayActivityResults(results, hourlyRate);
          });

        function displayActivityResults(results, hourlyRate) {
          const resultsDiv = document.getElementById("timeMoneyResults");

          const medals = [
            "ü•á",
            "ü•à",
            "ü•â",
            "4Ô∏è‚É£",
            "5Ô∏è‚É£",
            "6Ô∏è‚É£",
            "7Ô∏è‚É£",
            "8Ô∏è‚É£",
            "9Ô∏è‚É£",
            "üîü",
          ];

          resultsDiv.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--slate-800);">
              üèÜ Activity Rankings (Best to Worst ROI)
            </h3>

            <!-- Top 3 Podium -->
            ${
              results.length >= 3
                ? `
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                ${[1, 0, 2]
                  .map((idx) => {
                    const activity = results[idx];
                    const colors = [
                      {
                        bg: "linear-gradient(135deg, var(--yellow-50), var(--yellow-100))",
                        border: "var(--yellow-500)",
                        text: "var(--yellow-800)",
                      },
                      {
                        bg: "linear-gradient(135deg, var(--slate-50), var(--slate-100))",
                        border: "var(--slate-400)",
                        text: "var(--slate-700)",
                      },
                      {
                        bg: "linear-gradient(135deg, var(--orange-50), var(--orange-100))",
                        border: "var(--orange-500)",
                        text: "var(--orange-800)",
                      },
                    ];
                    const rank = idx === 0 ? 1 : idx === 1 ? 0 : 2; // Gold=0, Silver=1, Bronze=2
                    const color = colors[rank];

                    return `
                                  <div style="background: ${
                                    color.bg
                                  }; padding: 1.5rem; border-radius: 0.75rem; 
                                              border: 3px solid ${
                                                color.border
                                              }; text-align: center;
                                              ${
                                                rank === 0
                                                  ? "transform: scale(1.05); box-shadow: 0 8px 16px rgba(234, 179, 8, 0.3);"
                                                  : ""
                                              }">
                                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">
                                      ${medals[idx]}
                                    </div>
                                    <h4 style="font-size: 1rem; font-weight: 700; color: ${
                                      color.text
                                    }; margin-bottom: 0.75rem;">
                                      ${activity.name}
                                    </h4>
                                    <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                      <div style="font-size: 0.75rem; color: var(--slate-600); margin-bottom: 0.25rem;">ROI</div>
                                      <div style="font-size: 1.75rem; font-weight: 800; color: ${
                                        activity.roi >= 0
                                          ? "var(--green-600)"
                                          : "var(--red-600)"
                                      };">
                                        ${
                                          activity.roi >= 0 ? "+" : ""
                                        }${activity.roi.toFixed(0)}%
                                      </div>
                                    </div>
                                    <div style="font-size: 0.8rem; line-height: 1.5; color: ${
                                      color.text
                                    };">
                                      <strong>Net Value:</strong> ${
                                        activity.netValue >= 0 ? "+" : ""
                                      }$${activity.netValue.toFixed(0)}<br>
                                      <strong>Effective Rate:</strong> $${activity.hourlyRate.toFixed(
                                        0
                                      )}/hr<br>
                                      <strong>Time:</strong> ${
                                        activity.timeHours
                                      }h
                                    </div>
                                  </div>
                                `;
                  })
                  .join("")}
                            </div>
                          `
                : ""
            }
                          
                          <!-- Detailed Table -->
                          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--slate-200);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              üìä Complete Analysis
                            </h4>
                            
                            <div style="overflow-x: auto;">
                              <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                  <tr style="background: var(--slate-100); border-bottom: 2px solid var(--slate-300);">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Rank</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Activity</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Time</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Time Cost</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">$ Impact</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Net Value</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Effective Rate</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600;">ROI</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  ${results
                                    .map((activity, idx) => {
                                      const isGood = activity.roi >= 0;
                                      const rowColor = isGood
                                        ? "background: var(--green-50);"
                                        : idx < 3
                                        ? "background: var(--yellow-50);"
                                        : "background: var(--red-50);";

                                      return `
                                      <tr style="border-bottom: 1px solid var(--slate-200); ${rowColor}">
                                        <td style="padding: 0.75rem; font-weight: 700; font-size: 1.2rem;">
                                          ${medals[idx]} #${idx + 1}
                                        </td>
                                        <td style="padding: 0.75rem;">
                                          <div style="font-weight: 600; color: var(--slate-800);">${
                                            activity.name
                                          }</div>
                                          <div style="font-size: 0.75rem; color: var(--slate-600); margin-top: 0.25rem;">
                                            ${activity.description}
                                          </div>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right;">${
                                          activity.timeHours
                                        }h</td>
                                        <td style="padding: 0.75rem; text-align: right; color: var(--red-600);">
                                          -$${activity.timeCost.toFixed(0)}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                          ${getMoneyImpactDisplay(activity)}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 700; color: ${
                                          isGood
                                            ? "var(--green-600)"
                                            : "var(--red-600)"
                                        };">
                                          ${
                                            activity.netValue >= 0 ? "+" : ""
                                          }$${activity.netValue.toFixed(0)}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600;">
                                          $${activity.hourlyRate.toFixed(0)}/hr
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 700; font-size: 1rem; color: ${
                                          isGood
                                            ? "var(--green-700)"
                                            : "var(--red-700)"
                                        };">
                                          ${
                                            activity.roi >= 0 ? "+" : ""
                                          }${activity.roi.toFixed(0)}%
                                        </td>
                                      </tr>
                                    `;
                                    })
                                    .join("")}
                                </tbody>
                              </table>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--slate-50); border-radius: 0.5rem; font-size: 0.875rem;">
                              <strong>üìå How to read this table:</strong><br>
                              ‚Ä¢ <strong>Time Cost:</strong> Opportunity cost of your time (${
                                activity.timeHours
                              }h √ó $${hourlyRate}/hr)<br>
                              ‚Ä¢ <strong>Net Value:</strong> Total gain/loss after accounting for your time<br>
                              ‚Ä¢ <strong>Effective Rate:</strong> What you're "paying yourself" for this activity<br>
                              ‚Ä¢ <strong>ROI:</strong> Return on investment of your time<br><br>
                              <span style="color: var(--green-700); font-weight: 600;">‚úÖ Positive ROI = Good use of time</span><br>
                              <span style="color: var(--red-700); font-weight: 600;">‚ùå Negative ROI = Losing money vs other options</span>
                            </div>
                          </div>
                          
                          <!-- Key Insights -->
                          <div style="background: linear-gradient(135deg, var(--indigo-50), var(--purple-50)); 
                                      padding: 1.5rem; border-radius: 0.75rem; margin-top: 2rem; border-left: 4px solid var(--indigo-600);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--indigo-900); margin-bottom: 1rem;">
                              üí° Key Insights & Recommendations
                            </h4>
                            
                            ${generateInsights(results, hourlyRate)}
                          </div>
                          
                          <!-- Visualization -->
                          <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; margin-top: 2rem; border: 1px solid var(--slate-200);">
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem;">
                              üìà ROI Comparison Chart
                            </h4>
                            ${renderROIChart(results)}
                          </div>
                        `;

          resultsDiv.classList.remove("hidden");
        }

        function getMoneyImpactDisplay(activity) {
          switch (activity.type) {
            case "income":
              return `<span style="color: var(--green-600);">+$${activity.moneyImpact.toFixed(
                0
              )}</span>`;
            case "cost":
              return `<span style="color: var(--green-600);">Save $${activity.moneyImpact.toFixed(
                0
              )}</span>`;
            case "expense":
              return `<span style="color: var(--red-600);">-$${activity.moneyImpact.toFixed(
                0
              )}</span>`;
            case "learning":
              return `<span style="color: var(--purple-600);">+$${activity.futureValue.toFixed(
                0
              )}/mo</span>`;
            case "leisure":
              return `<span style="color: var(--blue-600);">${activity.enjoyment}/10 üòä</span>`;
          }
        }

        function generateInsights(results, hourlyRate) {
          const bestActivity = results[0];
          const worstActivity = results[results.length - 1];
          const goodActivities = results.filter((a) => a.roi >= 0);
          const badActivities = results.filter((a) => a.roi < 0);

          let insights = "";

          // Best activity
          insights += `
                          <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid var(--green-600);">
                            <strong style="color: var(--green-800);">ü•á Best Activity: ${
                              bestActivity.name
                            }</strong><br>
                            <span style="font-size: 0.875rem;">
                              This is your highest ROI activity at ${bestActivity.roi.toFixed(
                                0
                              )}%. 
                              You're effectively earning $${bestActivity.hourlyRate.toFixed(
                                0
                              )}/hr, which is 
                              ${(
                                (bestActivity.hourlyRate / hourlyRate - 1) *
                                100
                              ).toFixed(0)}% better than your base rate.
                            </span>
                          </div>
                        `;

          // Worst activity warning
          if (worstActivity.roi < -50) {
            insights += `
                            <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid var(--red-600);">
                              <strong style="color: var(--red-800);">‚ö†Ô∏è Avoid: ${
                                worstActivity.name
                              }</strong><br>
                              <span style="font-size: 0.875rem;">
                                This activity has a ${worstActivity.roi.toFixed(
                                  0
                                )}% ROI, meaning you're losing 
                                $${Math.abs(worstActivity.netValue).toFixed(
                                  0
                                )}. Consider eliminating or outsourcing this.
                              </span>
                            </div>
                          `;
          }

          // Summary stats
          insights += `
                          <div style="background: var(--white); padding: 1rem; border-radius: 0.5rem;">
                            <strong style="color: var(--indigo-800);">üìä Summary Statistics:</strong><br>
                            <div style="font-size: 0.875rem; line-height: 1.8; margin-top: 0.5rem;">
                              ‚Ä¢ <span style="color: var(--green-700); font-weight: 600;">${
                                goodActivities.length
                              } positive ROI activities</span> 
                                (total value: +$${goodActivities
                                  .reduce((sum, a) => sum + a.netValue, 0)
                                  .toFixed(0)})<br>
                              ‚Ä¢ <span style="color: var(--red-700); font-weight: 600;">${
                                badActivities.length
                              } negative ROI activities</span> 
                                (total loss: -$${Math.abs(
                                  badActivities.reduce(
                                    (sum, a) => sum + a.netValue,
                                    0
                                  )
                                ).toFixed(0)})<br>
                              ‚Ä¢ Your time is worth <strong>$${hourlyRate.toFixed(
                                2
                              )}/hr</strong> - any activity below this rate is a net loss<br>
                              ‚Ä¢ Best use of time: <strong>${
                                bestActivity.name
                              }</strong> at $${bestActivity.hourlyRate.toFixed(
            0
          )}/hr
                            </div>
                          </div>
                        `;

          return insights;
        }

        function renderROIChart(results) {
          const maxROI = Math.max(...results.map((a) => Math.abs(a.roi)));

          return `
                          <div style="position: relative;">
                            ${results
                              .map((activity, idx) => {
                                const isPositive = activity.roi >= 0;
                                const barWidth =
                                  (Math.abs(activity.roi) / maxROI) * 100;

                                return `
                                <div style="margin-bottom: 1rem;">
                                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="font-size: 0.875rem; font-weight: 600; color: var(--slate-700);">
                                      ${medals[idx]} ${activity.name}
                                    </div>
                                    <div style="font-size: 0.875rem; font-weight: 700; color: ${
                                      isPositive
                                        ? "var(--green-600)"
                                        : "var(--red-600)"
                                    };">
                                      ${
                                        activity.roi >= 0 ? "+" : ""
                                      }${activity.roi.toFixed(0)}%
                                    </div>
                                  </div>
                                  <div style="background: var(--slate-200); height: 30px; border-radius: 0.375rem; overflow: hidden; position: relative;">
                                    <div style="background: ${
                                      isPositive
                                        ? "linear-gradient(to right, var(--green-400), var(--green-600))"
                                        : "linear-gradient(to right, var(--red-400), var(--red-600))"
                                    }; 
                                                height: 100%; width: ${barWidth}%; 
                                                display: flex; align-items: center; padding-left: ${
                                                  barWidth > 20 ? "1rem" : "0"
                                                }; 
                                                color: white; font-weight: 700; font-size: 0.875rem; transition: width 0.5s;">
                                      ${
                                        barWidth > 20
                                          ? `$${activity.hourlyRate.toFixed(
                                              0
                                            )}/hr`
                                          : ""
                                      }
                                    </div>
                                    ${
                                      barWidth <= 20
                                        ? `
                                      <div style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); 
                                                  font-weight: 700; font-size: 0.875rem; color: var(--slate-600);">
                                        $${activity.hourlyRate.toFixed(0)}/hr
                                      </div>
                                    `
                                        : ""
                                    }
                                  </div>
                                </div>
                              `;
                              })
                              .join("")}
                          </div>
                          
                          <div style="margin-top: 1.5rem; text-align: center; font-size: 0.875rem; color: var(--slate-600);">
                            üìè Baseline: Your time is worth <strong>$${hourlyRate.toFixed(
                              2
                            )}/hour</strong>
                          </div>
                        `;
        }
      }
    </script>

    <!-- Toast Notification -->
    <div class="toast" id="saveToast">
      <span id="toastMessage">üíæ Saved!</span>
    </div>

  </body>
</html>
